function SoonMap(){this.map=new Object}!function(){var undefined=void 0,defaultConfig={targetFrame:undefined,exportInstaller:!1,useNative:!0,useInnerText:!0},config;if(window.jsxpath)config=window.jsxpath;else{var scriptElms=document.getElementsByTagName("script"),scriptElm=scriptElms[scriptElms.length-1],scriptSrc=scriptElm.src;config={};var scriptSrcMatchResult=scriptSrc.match(/\?(.*)$/);if(scriptSrcMatchResult)for(var configStrings=scriptSrcMatchResult[1].split("&"),i=0,l=configStrings.length;i<l;i++){var configString=configStrings[i],configStringSplited=configString.split("="),configName=configStringSplited[0],configValue=configStringSplited[1];configValue==undefined||("false"==configValue||/^-?\d+$/.test(configValue))&&(configValue=eval(configValue)),config[configName]=configValue}}for(var n in defaultConfig)n in config||(config[n]=defaultConfig[n]);if(config.hasNative=!!(document.implementation&&document.implementation.hasFeature&&document.implementation.hasFeature("XPath",null)),!config.hasNative||!config.useNative||config.exportInstaller){var BinaryExpr,FilterExpr,FunctionCall,Literal,NameTest,NodeSet,NodeType,NodeUtil,Number,PathExpr,Step,UnaryExpr,UnionExpr,VariableReference,uai=new function(){var t=navigator.userAgent;if(RegExp==undefined)t.indexOf("Opera")>=0?this.opera=!0:t.indexOf("Netscape")>=0?this.netscape=!0:0==t.indexOf("Mozilla/")?this.mozilla=!0:this.unknown=!0,t.indexOf("Gecko/")>=0&&(this.gecko=!0),t.indexOf("Win")>=0?this.windows=!0:t.indexOf("Mac")>=0?this.mac=!0:t.indexOf("Linux")>=0?this.linux=!0:t.indexOf("BSD")>=0?this.bsd=!0:t.indexOf("SunOS")>=0&&(this.sunos=!0);else if(/AppleWebKit\/(\d+(?:\.\d+)*)/.test(t)?(this.applewebkit=RegExp.$1,4==RegExp.$1.charAt(0)?this.applewebkit2=!0:this.applewebkit3=!0):"object"==typeof Components&&(/Gecko\/(\d{8})/.test(t)||"Gecko"==navigator.product&&/^(\d{8})$/.test(navigator.productSub))&&(this.gecko=RegExp.$1),"object"==typeof opera&&"function"==typeof opera.version?(this.opera=opera.version(),this["opera"+this.opera[0]+this.opera[2]]=!0):"object"==typeof opera&&/Opera[\/ ](\d+\.\d+)/.test(t)?this.opera=RegExp.$1:this.ie||(/Safari\/(\d+(?:\.\d+)*)/.test(t)?this.safari=RegExp.$1:/NetFront\/(\d+(?:\.\d+)*)/.test(t)?this.netfront=RegExp.$1:/Konqueror\/(\d+(?:\.\d+)*)/.test(t)?this.konqueror=RegExp.$1:t.indexOf("(compatible;")<0&&/^Mozilla\/(\d+\.\d+)/.test(t)?(this.mozilla=RegExp.$1,/\([^(]*rv:(\d+(?:\.\d+)*).*?\)/.test(t)&&(this.mozillarv=RegExp.$1),/Firefox\/(\d+(?:\.\d+)*)/.test(t)?this.firefox=RegExp.$1:/Netscape\d?\/(\d+(?:\.\d+)*)/.test(t)&&(this.netscape=RegExp.$1)):this.unknown=!0),t.indexOf("Win 9x 4.90")>=0)this.windows="ME";else if(/Win(?:dows)? ?(NT ?(\d+\.\d+)?|\d+|ME|Vista|XP)/.test(t))if(this.windows=RegExp.$1,RegExp.$2)this.winnt=RegExp.$2;else switch(RegExp.$1){case"2000":this.winnt="5.0";break;case"XP":this.winnt="5.1";break;case"Vista":this.winnt="6.0"}else t.indexOf("Mac")>=0?this.mac=!0:t.indexOf("Linux")>=0?this.linux=!0:/(\w*BSD)/.test(t)?this.bsd=RegExp.$1:t.indexOf("SunOS")>=0&&(this.sunos=!0)},Lexer=function(t){for(var e=Lexer.prototype,i=t.match(e.regs.token),r=0,n=i.length;r<n;r++)e.regs.strip.test(i[r])&&i.splice(r,1);for(var o in e)i[o]=e[o];return i.index=0,i};Lexer.prototype.regs={token:/\$?(?:(?![0-9-])[\w-]+:)?(?![0-9-])[\w-]+|\/\/|\.\.|::|\d+(?:\.\d*)?|\.\d+|"[^"]*"|'[^']*'|[!<>]=|(?![0-9-])[\w-]+:\*|\s+|./g,strip:/^\s/},Lexer.prototype.peek=function(t){return this[this.index+(t||0)]},Lexer.prototype.next=function(){return this[this.index++]},Lexer.prototype.back=function(){this.index--},Lexer.prototype.empty=function(){return this.length<=this.index};var Ctx=function(t,e,i){this.node=t,this.position=e||1,this.last=i||1},BaseExpr=function(){};BaseExpr.prototype.number=function(t){var e=this.evaluate(t);return e.isNodeSet?e.number():+e},BaseExpr.prototype.string=function(t){var e=this.evaluate(t);return e.isNodeSet?e.string():""+e},BaseExpr.prototype.bool=function(t){var e=this.evaluate(t);return e.isNodeSet?e.bool():!!e};var BaseExprHasPredicates=function(){};BaseExprHasPredicates.parsePredicates=function(t,e){for(;"["==t.peek();){if(t.next(),t.empty())throw Error("missing predicate expr");var i=BinaryExpr.parse(t);if(e.predicate(i),t.empty())throw Error("unclosed predicate expr");if("]"!=t.next())throw t.back(),Error("bad token: "+t.next())}},BaseExprHasPredicates.prototype=new BaseExpr,BaseExprHasPredicates.prototype.evaluatePredicates=function(t,e){var i,r,n,o;o=this.reverse,i=this.predicates,t.sort();for(var a=e||0,s=i.length;a<s;a++){r=i[a];for(var h,l=[],c=0,u=(h=t.list()).length;c<u;c++){switch(n=o?u-c:c+1,exrs=r.evaluate(new Ctx(h[c],n,u)),typeof exrs){case"number":exrs=n==exrs;break;case"string":exrs=!!exrs;break;case"object":exrs=exrs.bool()}exrs||l.push(c)}for(c=l.length-1,u=0;c>=u;c--)t.del(l[c])}return t},!window.BinaryExpr&&window.defaultConfig&&(window.BinaryExpr=null),BinaryExpr=function(t,e,i,r){this.op=t,this.left=e,this.right=i,this.datatype=BinaryExpr.ops[t][2],this.needContextPosition=e.needContextPosition||i.needContextPosition,this.needContextNode=e.needContextNode||i.needContextNode,"="==this.op&&(i.needContextNode||i.needContextPosition||"nodeset"==i.datatype||"void"==i.datatype||!e.quickAttr?e.needContextNode||e.needContextPosition||"nodeset"==e.datatype||"void"==e.datatype||!i.quickAttr||(this.quickAttr=!0,this.attrName=i.attrName,this.attrValueExpr=e):(this.quickAttr=!0,this.attrName=e.attrName,this.attrValueExpr=i))},BinaryExpr.compare=function(t,e,i,r,n){var o,a,s,h,l,c;if(i=i.evaluate(n),r=r.evaluate(n),i.isNodeSet&&r.isNodeSet){a=i.list(),s=r.list();for(var u=0,p=a.length;u<p;u++)for(var d=0,f=s.length;d<f;d++)if(e(NodeUtil.to("string",a[u]),NodeUtil.to("string",s[d])))return!0;return!1}if(i.isNodeSet||r.isNodeSet){i.isNodeSet?(l=i,c=r):(l=r,c=i),o=typeof c;u=0;for(var m=(h=l.list()).length;u<m;u++)if(e(NodeUtil.to(o,h[u]),c))return!0;return!1}return"="==t||"!="==t?"boolean"==typeof i||"boolean"==typeof r?e(!!i,!!r):"number"==typeof i||"number"==typeof r?e(+i,+r):e(i,r):e(+i,+r)},BinaryExpr.ops={div:[6,function(t,e,i){return t.number(i)/e.number(i)},"number"],mod:[6,function(t,e,i){return t.number(i)%e.number(i)},"number"],"*":[6,function(t,e,i){return t.number(i)*e.number(i)},"number"],"+":[5,function(t,e,i){return t.number(i)+e.number(i)},"number"],"-":[5,function(t,e,i){return t.number(i)-e.number(i)},"number"],"<":[4,function(t,e,i){return BinaryExpr.compare("<",function(t,e){return t<e},t,e,i)},"boolean"],">":[4,function(t,e,i){return BinaryExpr.compare(">",function(t,e){return t>e},t,e,i)},"boolean"],"<=":[4,function(t,e,i){return BinaryExpr.compare("<=",function(t,e){return t<=e},t,e,i)},"boolean"],">=":[4,function(t,e,i){return BinaryExpr.compare(">=",function(t,e){return t>=e},t,e,i)},"boolean"],"=":[3,function(t,e,i){return BinaryExpr.compare("=",function(t,e){return t==e},t,e,i)},"boolean"],"!=":[3,function(t,e,i){return BinaryExpr.compare("!=",function(t,e){return t!=e},t,e,i)},"boolean"],and:[2,function(t,e,i){return t.bool(i)&&e.bool(i)},"boolean"],or:[1,function(t,e,i){return t.bool(i)||e.bool(i)},"boolean"]},BinaryExpr.parse=function(t){var e,i,r,n,o=[];for(t.index;;){if(t.empty())throw Error("missing right expression");if(n=UnaryExpr.parse(t),!(e=t.next()))break;if(!(i=(r=this.ops[e])&&r[0])){t.back();break}for(;o.length&&i<=this.ops[o[o.length-1]][0];)n=new BinaryExpr(o.pop(),o.pop(),n);o.push(n,e)}for(;o.length;)n=new BinaryExpr(o.pop(),o.pop(),n);return n},BinaryExpr.prototype=new BaseExpr,BinaryExpr.prototype.evaluate=function(t){return BinaryExpr.ops[this.op][1](this.left,this.right,t)},BinaryExpr.prototype.show=function(t){var e="";return e+=(t=t||"")+"binary: "+this.op+"\n",t+="    ",e+=this.left.show(t),e+=this.right.show(t)},!window.UnaryExpr&&window.defaultConfig&&(window.UnaryExpr=null),UnaryExpr=function(t,e){this.op=t,this.expr=e,this.needContextPosition=e.needContextPosition,this.needContextNode=e.needContextNode},UnaryExpr.ops={"-":1},UnaryExpr.parse=function(t){return this.ops[t.peek()]?new UnaryExpr(t.next(),UnaryExpr.parse(t)):UnionExpr.parse(t)},UnaryExpr.prototype=new BaseExpr,UnaryExpr.prototype.datatype="number",UnaryExpr.prototype.evaluate=function(t){return-this.expr.number(t)},UnaryExpr.prototype.show=function(t){var e="";return e+=(t=t||"")+"unary: "+this.op+"\n",t+="    ",e+=this.expr.show(t)},!window.UnionExpr&&window.defaultConfig&&(window.UnionExpr=null),UnionExpr=function(){this.paths=[]},UnionExpr.ops={"|":1},UnionExpr.parse=function(t){var e,i;if(i=PathExpr.parse(t),!this.ops[t.peek()])return i;for((e=new UnionExpr).path(i);this.ops[t.next()];){if(t.empty())throw Error("missing next union location path");e.path(PathExpr.parse(t))}return t.back(),e},UnionExpr.prototype=new BaseExpr,UnionExpr.prototype.datatype="nodeset",UnionExpr.prototype.evaluate=function(t){for(var e=this.paths,i=new NodeSet,r=0,n=e.length;r<n;r++){var o=e[r].evaluate(t);if(!o.isNodeSet)throw Error("PathExpr must be nodeset");i.merge(o)}return i},UnionExpr.prototype.path=function(t){this.paths.push(t),t.needContextPosition&&(this.needContextPosition=!0),t.needContextNode&&(this.needContextNode=!0)},UnionExpr.prototype.show=function(t){var e="";e+=(t=t||"")+"union:\n",t+="    ";for(var i=0;i<this.paths.length;i++)e+=this.paths[i].show(t);return e},!window.PathExpr&&window.defaultConfig&&(window.PathExpr=null),PathExpr=function(t){this.filter=t,this.steps=[],this.datatype=t.datatype,this.needContextPosition=t.needContextPosition,this.needContextNode=t.needContextNode},PathExpr.ops={"//":1,"/":1},PathExpr.parse=function(t){var e,i,r,n;if(this.ops[t.peek()]){if(e=t.next(),n=t.peek(),"/"==e&&(t.empty()||"."!=n&&".."!=n&&"@"!=n&&"*"!=n&&!/(?![0-9])[\w]/.test(n)))return FilterExpr.root();if(r=new PathExpr(FilterExpr.root()),t.empty())throw Error("missing next location step");i=Step.parse(t),r.step(e,i)}else if(i=FilterExpr.parse(t)){if(!this.ops[t.peek()])return i;r=new PathExpr(i)}else i=Step.parse(t),(r=new PathExpr(FilterExpr.context())).step("/",i);for(;this.ops[t.peek()];){if(e=t.next(),t.empty())throw Error("missing next location step");r.step(e,Step.parse(t))}return r},PathExpr.prototype=new BaseExpr,PathExpr.prototype.evaluate=function(t){var e=this.filter.evaluate(t);if(!e.isNodeSet)throw Exception("Filter nodeset must be nodeset type");for(var i=this.steps,r=0,n=i.length;r<n&&e.length;r++){var o,a,s=i[r][1],h=s.reverse,l=e.iterator(h),c=e;if(e=null,s.needContextPosition||"following"!=s.axis)if(s.needContextPosition||"preceding"!=s.axis){o=l();var u=0;for(e=s.evaluate(new Ctx(o),!1,c,u);o=l();)u++,e.merge(s.evaluate(new Ctx(o),!1,c,u))}else o=l(),e=s.evaluate(new Ctx(o));else{for(o=l();a=l();o=a)if(uai.applewebkit2){var p=!1,d=a;do{if(d==o){p=!0;break}}while(d=d.parentNode);if(!p)break}else try{if(!o.contains(a))break}catch(t){if(!(8&a.compareDocumentPosition(o)))break}e=s.evaluate(new Ctx(o))}}return e},PathExpr.prototype.step=function(t,e){if(e.op=t,this.steps.push([t,e]),this.quickAttr=!1,1==this.steps.length&&"/"==t&&"attribute"==e.axis){var i=e.test;i.notOnlyElement||"*"==i.name||(this.quickAttr=!0,this.attrName=i.name)}},PathExpr.prototype.show=function(t){var e="";if(e+=(t=t||"")+"path:\n",e+=(t+="    ")+"filter:\n",e+=this.filter.show(t+"    "),this.steps.length){e+=t+"steps:\n",t+="    ";for(var i=0;i<this.steps.length;i++){var r=this.steps[i];e+=t+"operator: "+r[0]+"\n",e+=r[1].show(t)}}return e},!window.FilterExpr&&window.defaultConfig&&(window.FilterExpr=null),FilterExpr=function(t){this.primary=t,this.predicates=[],this.datatype=t.datatype,this.needContextPosition=t.needContextPosition,this.needContextNode=t.needContextNode},FilterExpr.parse=function(t){var e,i,r,n;switch(n=(r=t.peek()).charAt(0)){case"$":e=VariableReference.parse(t);break;case"(":if(t.next(),e=BinaryExpr.parse(t),t.empty())throw Error('unclosed "("');if(")"!=t.next())throw t.back(),Error("bad token: "+t.next());break;case'"':case"'":e=Literal.parse(t);break;default:if(isNaN(+r)){if(NodeType.types[r])return null;if(!/(?![0-9])[\w]/.test(n)||"("!=t.peek(1))return null;e=FunctionCall.parse(t)}else e=Number.parse(t)}return"["!=t.peek()?e:(i=new FilterExpr(e),BaseExprHasPredicates.parsePredicates(t,i),i)},FilterExpr.root=function(){return new FunctionCall("root-node")},FilterExpr.context=function(){return new FunctionCall("context-node")},FilterExpr.prototype=new BaseExprHasPredicates,FilterExpr.prototype.evaluate=function(t){var e=this.primary.evaluate(t);if(!e.isNodeSet){if(this.predicates.length)throw Error("Primary result must be nodeset type if filter have predicate expression");return e}return this.evaluatePredicates(e)},FilterExpr.prototype.predicate=function(t){this.predicates.push(t)},FilterExpr.prototype.show=function(t){var e="";if(e+=(t=t||"")+"filter: \n",t+="    ",e+=this.primary.show(t),this.predicates.length){e+=t+"predicates: \n",t+="    ";for(var i=0;i<this.predicates.length;i++)e+=this.predicates[i].show(t)}return e},!window.NodeUtil&&window.defaultConfig&&(window.NodeUtil=null),NodeUtil={to:function(t,e){var r,n=e.nodeType;if(1==n&&config.useInnerText&&!uai.applewebkit2&&(r=(r=(r=e.textContent)==undefined||null==r?e.innerText:r)==undefined||null==r?"":r),"string"!=typeof r)if(9==n||1==n)for(e=9==n?e.documentElement:e.firstChild,r="",stack=[],i=0;e;){do{1!=e.nodeType&&(r+=e.nodeValue),stack[i++]=e}while(e=e.firstChild);for(;i&&!(e=stack[--i].nextSibling););}else r=e.nodeValue;switch(t){case"number":return+r;case"boolean":return!!r;default:return r}},attrPropMap:{name:"name",class:"className",dir:"dir",id:"id",name:"name",title:"title"},attrMatch:function(t,e,i){return!!(!e||null==i&&t.hasAttribute&&t.hasAttribute(e)||null!=i&&t.getAttribute&&t.getAttribute(e)==i)},getDescendantNodes:function(t,e,i,r,n,o,a){if(o&&o.delDescendant(e,a),n&&"id"==r&&e.getElementById)(e=e.getElementById(n))&&t.match(e)&&i.push(e);else if(n&&"name"==r&&e.getElementsByName)for(var s=0,h=(l=e.getElementsByName(n)).length;s<h;s++)e=l[s],(uai.opera?e.name==n&&t.match(e):t.match(e))&&i.push(e);else if(n&&"class"==r&&e.getElementsByClassName)for(s=0,h=(l=e.getElementsByClassName(n)).length;s<h;s++)(e=l[s]).className==n&&t.match(e)&&i.push(e);else if(t.notOnlyElement)!function(e){for(var o=arguments.callee,a=e.firstChild;a;a=a.nextSibling)NodeUtil.attrMatch(a,r,n)&&t.match(a.nodeType)&&i.push(a),o(a)}(e);else{var l,c=t.name;if(e.getElementsByTagName)if(l=e.getElementsByTagName(c))for(s=0;e=l[s++];)NodeUtil.attrMatch(e,r,n)&&i.push(e)}return i},getChildNodes:function(t,e,i,r,n){for(e=e.firstChild;e;e=e.nextSibling)NodeUtil.attrMatch(e,r,n)&&t.match(e)&&i.push(e);return i}},!window.Step&&window.defaultConfig&&(window.Step=null),Step=function(t,e){this.axis=t,this.reverse=Step.axises[t][0],this.func=Step.axises[t][1],this.test=e,this.predicates=[],this._quickAttr=Step.axises[t][2]},Step.axises={ancestor:[!0,function(t,e,i,r,n,o,a){for(;e=e.parentNode;)o&&1==e.nodeType&&o.reserveDelByNode(e,a,!0),t.match(e)&&i.unshift(e);return i}],"ancestor-or-self":[!0,function(t,e,i,r,n,o,a){do{o&&1==e.nodeType&&o.reserveDelByNode(e,a,!0),t.match(e)&&i.unshift(e)}while(e=e.parentNode);return i}],attribute:[!1,function(t,e,i){var r=e.attributes;if(r)if(t.notOnlyElement&&0==t.type||"*"==t.name)for(var n,o=0;n=r[o];o++)i.push(n);else(n=r.getNamedItem(t.name))&&i.push(n);return i}],child:[!1,NodeUtil.getChildNodes,!0],descendant:[!1,NodeUtil.getDescendantNodes,!0],"descendant-or-self":[!1,function(t,e,i,r,n,o,a){return NodeUtil.attrMatch(e,r,n)&&t.match(e)&&i.push(e),NodeUtil.getDescendantNodes(t,e,i,r,n,o,a)},!0],following:[!1,function(t,e,i,r,n){do{for(var o=e;o=o.nextSibling;)NodeUtil.attrMatch(o,r,n)&&t.match(o)&&i.push(o),i=NodeUtil.getDescendantNodes(t,o,i,r,n)}while(e=e.parentNode);return i},!0],"following-sibling":[!1,function(t,e,i,r,n,o,a){for(;e=e.nextSibling;)o&&1==e.nodeType&&o.reserveDelByNode(e,a),t.match(e)&&i.push(e);return i}],namespace:[!1,function(t,e,i){return i}],parent:[!1,function(t,e,i){if(9==e.nodeType)return i;if(2==e.nodeType)return i.push(e.ownerElement),i;e=e.parentNode;return t.match(e)&&i.push(e),i}],preceding:[!0,function(t,e,i,r,n){var o=[];do{o.unshift(e)}while(e=e.parentNode);for(var a=1,s=o.length;a<s;a++){var h=[];for(e=o[a];e=e.previousSibling;)h.unshift(e);for(var l=0,c=h.length;l<c;l++)e=h[l],NodeUtil.attrMatch(e,r,n)&&t.match(e)&&i.push(e),i=NodeUtil.getDescendantNodes(t,e,i,r,n)}return i},!0],"preceding-sibling":[!0,function(t,e,i,r,n,o,a){for(;e=e.previousSibling;)o&&1==e.nodeType&&o.reserveDelByNode(e,a,!0),t.match(e)&&i.unshift(e);return i}],self:[!1,function(t,e,i){return t.match(e)&&i.push(e),i}]},Step.parse=function(t){var e,i,r,n;if("."==t.peek())r=this.self(),t.next();else if(".."==t.peek())r=this.parent(),t.next();else{if("@"==t.peek()){if(e="attribute",t.next(),t.empty())throw Error("missing attribute name")}else if("::"==t.peek(1)){if(!/(?![0-9])[\w]/.test(t.peek().charAt(0)))throw Error("bad token: "+t.next());if(e=t.next(),t.next(),!this.axises[e])throw Error("invalid axis: "+e);if(t.empty())throw Error("missing node name")}else e="child";if(n=t.peek(),/(?![0-9])[\w]/.test(n.charAt(0)))if("("==t.peek(1)){if(!NodeType.types[n])throw Error("invalid node type: "+n);i=NodeType.parse(t)}else i=NameTest.parse(t);else{if("*"!=n)throw Error("bad token: "+t.next());i=NameTest.parse(t)}r=new Step(e,i)}return BaseExprHasPredicates.parsePredicates(t,r),r},Step.self=function(){return new Step("self",new NodeType("node"))},Step.parent=function(){return new Step("parent",new NodeType("node"))},Step.prototype=new BaseExprHasPredicates,Step.prototype.evaluate=function(t,e,i,r){var n=t.node;if(e||"//"!=this.op){if(this.needContextPosition&&(i=null,r=null),this.quickAttr){c=this.attrValueExpr?this.attrValueExpr.string(t):null,s=this.func(this.test,n,new NodeSet,this.attrName,c,i,r);s=this.evaluatePredicates(s,1)}else{s=this.func(this.test,n,new NodeSet,null,null,i,r);s=this.evaluatePredicates(s)}i&&i.doDel()}else if(this.needContextPosition||"child"!=this.axis){var o=new Step("descendant-or-self",new NodeType("node")),a=o.evaluate(t,!1,i,r).list(),s=null;o.op="/";for(var h=0,l=a.length;h<l;h++)s?s.merge(this.evaluate(new Ctx(a[h]),!0)):s=this.evaluate(new Ctx(a[h]),!0);s=s||new NodeSet}else if(this.quickAttr){var c=this.attrValueExpr?this.attrValueExpr.string(t):null,s=NodeUtil.getDescendantNodes(this.test,n,new NodeSet,this.attrName,c,i,r);s=this.evaluatePredicates(s,1)}else{var s=NodeUtil.getDescendantNodes(this.test,n,new NodeSet,null,null,i,r);s=this.evaluatePredicates(s)}return s},Step.prototype.predicate=function(t){if(this.predicates.push(t),(t.needContextPosition||"number"==t.datatype||"void"==t.datatype)&&(this.needContextPosition=!0),this._quickAttr&&1==this.predicates.length&&t.quickAttr){var e=t.attrName;this.attrName=e,this.attrValueExpr=t.attrValueExpr,this.quickAttr=!0}},Step.prototype.show=function(t){var e="";if(e+=(t=t||"")+"step: \n",t+="    ",this.axis&&(e+=t+"axis: "+this.axis+"\n"),e+=this.test.show(t),this.predicates.length){e+=t+"predicates: \n",t+="    ";for(var i=0;i<this.predicates.length;i++)e+=this.predicates[i].show(t)}return e},!window.NodeType&&window.defaultConfig&&(window.NodeType=null),NodeType=function(t,e){switch(this.name=t,this.literal=e,t){case"comment":this.type=8;break;case"text":this.type=3;break;case"processing-instruction":this.type=7;break;case"node":this.type=0}},NodeType.types={comment:1,text:1,"processing-instruction":1,node:1},NodeType.parse=function(t){var e,i,r;if(e=t.next(),t.next(),t.empty())throw Error("bad nodetype");if('"'!=(r=t.peek().charAt(0))&&"'"!=r||(i=Literal.parse(t)),t.empty())throw Error("bad nodetype");if(")"!=t.next())throw t.back(),Error("bad token "+t.next());return new NodeType(e,i)},NodeType.prototype=new BaseExpr,NodeType.prototype.notOnlyElement=!0,NodeType.prototype.match=function(t){return!this.type||this.type==t.nodeType},NodeType.prototype.show=function(t){var e="";return e+=(t=t||"")+"nodetype: "+this.type+"\n",this.literal&&(t+="    ",e+=this.literal.show(t)),e},!window.NameTest&&window.defaultConfig&&(window.NameTest=null),NameTest=function(t){this.name=t.toLowerCase()},NameTest.parse=function(t){return"*"!=t.peek()&&":"==t.peek(1)&&"*"==t.peek(2)?new NameTest(t.next()+t.next()+t.next()):new NameTest(t.next())},NameTest.prototype=new BaseExpr,NameTest.prototype.match=function(t){var e=t.nodeType;return!(1!=e&&2!=e||"*"!=this.name&&this.name!=t.nodeName.toLowerCase())},NameTest.prototype.show=function(t){var e="";return e+=(t=t||"")+"nametest: "+this.name+"\n"},!window.VariableReference&&window.defaultConfig&&(window.VariableReference=null),VariableReference=function(t){this.name=t.substring(1)},VariableReference.parse=function(t){var e=t.next();if(e.length<2)throw Error("unnamed variable reference");return new VariableReference(e)},VariableReference.prototype=new BaseExpr,VariableReference.prototype.datatype="void",VariableReference.prototype.show=function(t){var e="";return e+=(t=t||"")+"variable: "+this.name+"\n"},!window.Literal&&window.defaultConfig&&(window.Literal=null),Literal=function(t){this.text=t.substring(1,t.length-1)},Literal.parse=function(t){var e=t.next();if(e.length<2)throw Error("unclosed literal string");return new Literal(e)},Literal.prototype=new BaseExpr,Literal.prototype.datatype="string",Literal.prototype.evaluate=function(t){return this.text},Literal.prototype.show=function(t){var e="";return e+=(t=t||"")+"literal: "+this.text+"\n"},!window.Number&&window.defaultConfig&&(window.Number=null),Number=function(t){this.digit=+t},Number.parse=function(t){return new Number(t.next())},Number.prototype=new BaseExpr,Number.prototype.datatype="number",Number.prototype.evaluate=function(t){return this.digit},Number.prototype.show=function(t){var e="";return e+=(t=t||"")+"number: "+this.digit+"\n"},!window.FunctionCall&&window.defaultConfig&&(window.FunctionCall=null),FunctionCall=function(t){var e=FunctionCall.funcs[t];if(!e)throw Error(t+" is not a function");this.name=t,this.func=e[0],this.args=[],this.datatype=e[1],e[2]&&(this.needContextPosition=!0),this.needContextNodeInfo=e[3],this.needContextNode=this.needContextNodeInfo[0]},FunctionCall.funcs={"context-node":[function(){if(0!=arguments.length)throw Error("Function context-node expects ()");var t;return(t=new NodeSet).push(this.node),t},"nodeset",!1,[!0]],"root-node":[function(){if(0!=arguments.length)throw Error("Function root-node expects ()");var t,e;return t=new NodeSet,9==(e=this.node).nodeType?t.push(e):t.push(e.ownerDocument),t},"nodeset",!1,[]],last:[function(){if(0!=arguments.length)throw Error("Function last expects ()");return this.last},"number",!0,[]],position:[function(){if(0!=arguments.length)throw Error("Function position expects ()");return this.position},"number",!0,[]],count:[function(t){if(1!=arguments.length||!(t=t.evaluate(this)).isNodeSet)throw Error("Function count expects (nodeset)");return t.length},"number",!1,[]],id:[function(t){var e,i,r,n,o,a,s;if(1!=arguments.length)throw Error("Function id expects (object)");for(s=9==(a=this.node).nodeType?a:a.ownerDocument,e=(t=t.string(this)).split(/\s+/),i=new NodeSet,r=0,l=e.length;r<l;r++)if(n=e[r],o=s.getElementById(n),uai.opera&&o&&o.id!=n)for(var h=s.getElementsByName(n),c=0,u=h.length;c<u;c++)(o=h[c]).id==n&&i.push(o);else o&&i.push(o);return i.isSorted=!1,i},"nodeset",!1,[]],"local-name":[function(t){var e;switch(arguments.length){case 0:e=this.node;break;case 1:if((t=t.evaluate(this)).isNodeSet){e=t.first();break}default:throw Error("Function local-name expects (nodeset?)")}return""+e.nodeName.toLowerCase()},"string",!1,[!0,!1]],name:[function(t){return FunctionCall.funcs["local-name"][0].apply(this,arguments)},"string",!1,[!0,!1]],"namespace-uri":[function(t){return""},"string",!1,[!0,!1]],string:[function(t){switch(arguments.length){case 0:t=NodeUtil.to("string",this.node);break;case 1:t=t.string(this);break;default:throw Error("Function string expects (object?)")}return t},"string",!1,[!0,!1]],concat:[function(t,e){if(arguments.length<2)throw Error("Function concat expects (string, string[, ...])");for(var i="",r=0,n=arguments.length;r<n;r++)i+=arguments[r].string(this);return i},"string",!1,[]],"starts-with":[function(t,e){if(2!=arguments.length)throw Error("Function starts-with expects (string, string)");return t=t.string(this),e=e.string(this),0==t.indexOf(e)},"boolean",!1,[]],contains:[function(t,e){if(2!=arguments.length)throw Error("Function contains expects (string, string)");return t=t.string(this),e=e.string(this),-1!=t.indexOf(e)},"boolean",!1,[]],substring:[function(t,e,i){var r,n;switch(t=t.string(this),e=e.number(this),arguments.length){case 2:i=t.length-e+1;break;case 3:i=i.number(this);break;default:throw Error("Function substring expects (string, string)")}return r=(e=Math.round(e))-1,(n=e+(i=Math.round(i))-1)==1/0?t.substring(r<0?0:r):t.substring(r<0?0:r,n)},"string",!1,[]],"substring-before":[function(t,e){var i;if(2!=arguments.length)throw Error("Function substring-before expects (string, string)");return t=t.string(this),e=e.string(this),-1==(i=t.indexOf(e))?"":t.substring(0,i)},"string",!1,[]],"substring-after":[function(t,e){if(2!=arguments.length)throw Error("Function substring-after expects (string, string)");t=t.string(this),e=e.string(this);var i=t.indexOf(e);return-1==i?"":t.substring(i+e.length)},"string",!1,[]],"string-length":[function(t){switch(arguments.length){case 0:t=NodeUtil.to("string",this.node);break;case 1:t=t.string(this);break;default:throw Error("Function string-length expects (string?)")}return t.length},"number",!1,[!0,!1]],"normalize-space":[function(t){switch(arguments.length){case 0:t=NodeUtil.to("string",this.node);break;case 1:t=t.string(this);break;default:throw Error("Function normalize-space expects (string?)")}return t.replace(/\s+/g," ").replace(/^ /,"").replace(/ $/,"")},"string",!1,[!0,!1]],translate:[function(t,e,i){if(3!=arguments.length)throw Error("Function translate expects (string, string, string)");t=t.string(this),e=e.string(this),i=i.string(this);for(var r=[],n=0,o=e.length;n<o;n++){r[s=e.charAt(n)]||(r[s]=i.charAt(n)||"")}var a="";for(n=0,o=t.length;n<o;n++){var s,h=r[s=t.charAt(n)];a+=h!=undefined?h:s}return a},"string",!1,[]],boolean:[function(t){if(1!=arguments.length)throw Error("Function boolean expects (object)");return t.bool(this)},"boolean",!1,[]],not:[function(t){if(1!=arguments.length)throw Error("Function not expects (object)");return!t.bool(this)},"boolean",!1,[]],true:[function(){if(0!=arguments.length)throw Error("Function true expects ()");return!0},"boolean",!1,[]],false:[function(){if(0!=arguments.length)throw Error("Function false expects ()");return!1},"boolean",!1,[]],lang:[function(t){return!1},"boolean",!1,[]],number:[function(t){switch(arguments.length){case 0:t=NodeUtil.to("number",this.node);break;case 1:t=t.number(this);break;default:throw Error("Function number expects (object?)")}return t},"number",!1,[!0,!1]],sum:[function(t){var e,i,r,n;if(1!=arguments.length||!(t=t.evaluate(this)).isNodeSet)throw Error("Function sum expects (nodeset)");for(i=0,r=0,n=(e=t.list()).length;r<n;r++)i+=NodeUtil.to("number",e[r]);return i},"number",!1,[]],floor:[function(t){if(1!=arguments.length)throw Error("Function floor expects (number)");return t=t.number(this),Math.floor(t)},"number",!1,[]],ceiling:[function(t){if(1!=arguments.length)throw Error("Function ceiling expects (number)");return t=t.number(this),Math.ceil(t)},"number",!1,[]],round:[function(t){if(1!=arguments.length)throw Error("Function round expects (number)");return t=t.number(this),Math.round(t)},"number",!1,[]]},FunctionCall.parse=function(t){var e,i=new FunctionCall(t.next());for(t.next();")"!=t.peek();){if(t.empty())throw Error("missing function argument list");if(e=BinaryExpr.parse(t),i.arg(e),","!=t.peek())break;t.next()}if(t.empty())throw Error("unclosed function argument list");if(")"!=t.next())throw t.back(),Error("bad token: "+t.next());return i},FunctionCall.prototype=new BaseExpr,FunctionCall.prototype.evaluate=function(t){return this.func.apply(t,this.args)},FunctionCall.prototype.arg=function(t){this.args.push(t),t.needContextPosition&&(this.needContextPosition=!0);var e=this.args;t.needContextNode&&(e.needContexNode=!0),this.needContextNode=e.needContextNode||this.needContextNodeInfo[e.length]},FunctionCall.prototype.show=function(t){var e="";if(e+=(t=t||"")+"function: "+this.name+"\n",t+="    ",this.args.length){e+=t+"arguments: \n",t+="    ";for(var i=0;i<this.args.length;i++)e+=this.args[i].show(t)}return e};var NodeID={uuid:1,get:function(t){return t.__jsxpath_id__||(t.__jsxpath_id__=this.uuid++)}};!window.NodeSet&&window.defaultConfig&&(window.NodeSet=null),NodeSet=function(){this.length=0,this.nodes=[],this.seen={},this.idIndexMap=null,this.reserveDels=[]},NodeSet.prototype.isNodeSet=!0,NodeSet.prototype.isSorted=!0,NodeSet.prototype.merge=function(t){if(this.isSorted=!1,t.only)return this.push(t.only);if(this.only){var e=this.only;delete this.only,this.push(e),this.length--}for(var i=t.nodes,r=0,n=i.length;r<n;r++)this._add(i[r])},NodeSet.prototype.sort=function(){this.only||(this.sortOff||this.isSorted||(this.isSorted=!0,this.idIndexMap=null,this.nodes.sort(function(t,e){if(t==e)return 0;if(t.compareDocumentPosition){var i=t.compareDocumentPosition(e);return 2&i?1:4&i?-1:0}for(var r=t,n=e,o=t,a=e,s=0,h=0;o=o.parentNode;)s++;for(;a=a.parentNode;)h++;if(s>h){for(;s--!=h;)r=r.parentNode;if(r==n)return 1}else if(h>s){for(;h--!=s;)n=n.parentNode;if(r==n)return-1}for(;(o=r.parentNode)!=(a=n.parentNode);)r=o,n=a;for(;r=r.nextSibling;)if(r==n)return-1;return 1})))},NodeSet.prototype.reserveDelByNodeID=function(t,e,i){var r;if((r=this.createIdIndexMap()[t])&&(i&&this.length-e-1>r||!i&&e<r)){var n={value:r,order:String.fromCharCode(r),toString:function(){return this.order},valueOf:function(){return this.value}};this.reserveDels.push(n)}},NodeSet.prototype.reserveDelByNode=function(t,e,i){this.reserveDelByNodeID(NodeID.get(t),e,i)},NodeSet.prototype.doDel=function(){if(this.reserveDels.length){if(this.length<65536)var t=this.reserveDels.sort(function(t,e){return e-t});else t=this.reserveDels.sort(function(t,e){return e-t});for(var e=0,i=t.length;e<i;e++)this.del(t[e]);this.reserveDels=[],this.idIndexMap=null}},NodeSet.prototype.createIdIndexMap=function(){if(this.idIndexMap)return this.idIndexMap;for(var t=this.idIndexMap={},e=this.nodes,i=0,r=e.length;i<r;i++){var n=e[i];t[NodeID.get(n)]=i}return t},NodeSet.prototype.del=function(t){if(this.length--,this.only)delete this.only;else{var e=this.nodes.splice(t,1)[0];this._first==e&&(delete this._first,delete this._firstSourceIndex,delete this._firstSubIndex),delete this.seen[NodeID.get(e)]}},NodeSet.prototype.delDescendant=function(t,e){if(!this.only){var i=t.nodeType;if((1==i||9==i)&&!uai.applewebkit2){if(!t.contains)if(1==i){var r=t;t={contains:function(t){return 8&t.compareDocumentPosition(r)}}}else t={contains:function(){return!0}};for(var n=this.nodes,o=e+1;o<n.length;o++)t.contains(n[o])&&(this.del(o),o--)}}},NodeSet.prototype._add=function(t,e){var i=this.seen,r=NodeID.get(t);if(i[r])return!0;i[r]=!0,this.length++,e?this.nodes.unshift(t):this.nodes.push(t)},NodeSet.prototype.unshift=function(t){if(!this.length)return this.length++,void(this.only=t);if(this.only){var e=this.only;delete this.only,this.unshift(e),this.length--}return this._add(t,!0)},NodeSet.prototype.push=function(t){if(!this.length)return this.length++,void(this.only=t);if(this.only){var e=this.only;delete this.only,this.push(e),this.length--}return this._add(t)},NodeSet.prototype.first=function(){return this.only?this.only:(this.nodes.length>1&&this.sort(),this.nodes[0])},NodeSet.prototype.list=function(){return this.only?[this.only]:(this.sort(),this.nodes)},NodeSet.prototype.string=function(){var t=this.only||this.first();return t?NodeUtil.to("string",t):""},NodeSet.prototype.bool=function(){return!(!this.length&&!this.only)},NodeSet.prototype.number=function(){return+this.string()},NodeSet.prototype.iterator=function(t){this.sort();var e=this;if(t){i=0;return function(){var t=e.length-i++-1;return e.only&&0==t?e.only:e.nodes[t]}}var i=0;return function(){return e.only&&0==i++?e.only:e.nodes[i++]}};var install=function(t){var e=(t=t||this).document;t.undefined;t.XPathExpression=function(e){if(!e.length)throw t.Error("no expression");var i=this.lexer=Lexer(e);if(i.empty())throw t.Error("no expression");if(this.expr=BinaryExpr.parse(i),!i.empty())throw t.Error("bad token: "+i.next())},t.XPathExpression.prototype.evaluate=function(e,i){return new t.XPathResult(this.expr.evaluate(new Ctx(e)),i)},t.XPathResult=function(t,e){if(0==e)switch(typeof t){case"object":e++;case"boolean":e++;case"string":e++;case"number":e++}switch(this.resultType=e,e){case 1:return void(this.numberValue=t.isNodeSet?t.number():+t);case 2:return void(this.stringValue=t.isNodeSet?t.string():""+t);case 3:return void(this.booleanValue=t.isNodeSet?t.bool():!!t);case 4:case 5:case 6:case 7:this.nodes=t.list(),this.snapshotLength=t.length,this.index=0,this.invalidIteratorState=!1;break;case 8:case 9:return void(this.singleNodeValue=t.first())}},t.XPathResult.prototype.iterateNext=function(){return this.nodes[this.index++]},t.XPathResult.prototype.snapshotItem=function(t){return this.nodes[t]},t.XPathResult.ANY_TYPE=0,t.XPathResult.NUMBER_TYPE=1,t.XPathResult.STRING_TYPE=2,t.XPathResult.BOOLEAN_TYPE=3,t.XPathResult.UNORDERED_NODE_ITERATOR_TYPE=4,t.XPathResult.ORDERED_NODE_ITERATOR_TYPE=5,t.XPathResult.UNORDERED_NODE_SNAPSHOT_TYPE=6,t.XPathResult.ORDERED_NODE_SNAPSHOT_TYPE=7,t.XPathResult.ANY_UNORDERED_NODE_TYPE=8,t.XPathResult.FIRST_ORDERED_NODE_TYPE=9,e.createExpression=function(e){return new t.XPathExpression(e,null)},e.evaluate=function(t,i,r,n){return e.createExpression(t,null).evaluate(i,n)}},win;if(config.targetFrame){var frame=document.getElementById(config.targetFrame);frame&&(win=frame.contentWindow)}config.exportInstaller&&(window.install=install),config.hasNative&&config.useNative||install(win||window)}}(),SoonMap.prototype={put:function(t,e){this.map[t]=e},get:function(t){return this.map[t]},containsKey:function(t){return t in this.map},containsValue:function(t){for(var e in this.map)if(this.map[e]===t)return!0;return!1},isEmpty:function(t){return 0===this.size()},clear:function(){for(var t in this.map)delete this.map[t]},remove:function(t){delete this.map[t]},keys:function(){var t=new Array;for(var e in this.map)t.push(e);return t},values:function(){var t=new Array;for(var e in this.map)t.push(this.map[e]);return t},size:function(){var t=0;for(var e in this.map)t++;return t}},void 0===Date.now&&(Date.now=function(){return(new Date).valueOf()});var TWEEN=TWEEN||function(){var t=[];return{REVISION:"14",getAll:function(){return t},removeAll:function(){t=[]},add:function(e){t.push(e)},remove:function(e){var i=t.indexOf(e);-1!==i&&t.splice(i,1)},update:function(e){if(0===t.length)return!1;var i=0;for(e=void 0!==e?e:"undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now();i<t.length;)t[i].update(e)?i++:t.splice(i,1);return!0}}}();TWEEN.Tween=function(t){var e=t,i={},r={},n={},o=1e3,a=0,s=!1,h=!1,l=!1,c=0,u=null,p=TWEEN.Easing.Linear.None,d=TWEEN.Interpolation.Linear,f=[],m=null,g=!1,v=null,y=null,E=null;for(var x in t)i[x]=parseFloat(t[x],10);this.to=function(t,e){return void 0!==e&&(o=e),r=t,this},this.start=function(t){for(var o in TWEEN.add(this),h=!0,g=!1,u=void 0!==t?t:"undefined"!=typeof window&&void 0!==window.performance&&void 0!==window.performance.now?window.performance.now():Date.now(),u+=c,r){if(r[o]instanceof Array){if(0===r[o].length)continue;r[o]=[e[o]].concat(r[o])}i[o]=e[o],i[o]instanceof Array==!1&&(i[o]*=1),n[o]=i[o]||0}return this},this.stop=function(){return h?(TWEEN.remove(this),h=!1,null!==E&&E.call(e),this.stopChainedTweens(),this):this},this.stopChainedTweens=function(){for(var t=0,e=f.length;t<e;t++)f[t].stop()},this.delay=function(t){return c=t,this},this.repeat=function(t){return a=t,this},this.yoyo=function(t){return s=t,this},this.easing=function(t){return p=t,this},this.interpolation=function(t){return d=t,this},this.chain=function(){return f=arguments,this},this.onStart=function(t){return m=t,this},this.onUpdate=function(t){return v=t,this},this.onComplete=function(t){return y=t,this},this.onStop=function(t){return E=t,this},this.update=function(t){var h;if(t<u)return!0;!1===g&&(null!==m&&m.call(e),g=!0);var E=(t-u)/o,x=p(E=E>1?1:E);for(h in r){var _=i[h]||0,w=r[h];w instanceof Array?e[h]=d(w,x):("string"==typeof w&&(w=_+parseFloat(w,10)),"number"==typeof w&&(e[h]=_+(w-_)*x))}if(null!==v&&v.call(e,x),1==E){if(a>0){for(h in isFinite(a)&&a--,n){if("string"==typeof r[h]&&(n[h]=n[h]+parseFloat(r[h],10)),s){var b=n[h];n[h]=r[h],r[h]=b}i[h]=n[h]}return s&&(l=!l),u=t+c,!0}null!==y&&y.call(e);for(var S=0,T=f.length;S<T;S++)f[S].start(t);return!1}return!0}},TWEEN.Easing={Linear:{None:function(t){return t}},Quadratic:{In:function(t){return t*t},Out:function(t){return t*(2-t)},InOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}},Cubic:{In:function(t){return t*t*t},Out:function(t){return--t*t*t+1},InOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}},Quartic:{In:function(t){return t*t*t*t},Out:function(t){return 1- --t*t*t*t},InOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)}},Quintic:{In:function(t){return t*t*t*t*t},Out:function(t){return--t*t*t*t*t+1},InOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)}},Sinusoidal:{In:function(t){return 1-Math.cos(t*Math.PI/2)},Out:function(t){return Math.sin(t*Math.PI/2)},InOut:function(t){return.5*(1-Math.cos(Math.PI*t))}},Exponential:{In:function(t){return 0===t?0:Math.pow(1024,t-1)},Out:function(t){return 1===t?1:1-Math.pow(2,-10*t)},InOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))}},Circular:{In:function(t){return 1-Math.sqrt(1-t*t)},Out:function(t){return Math.sqrt(1- --t*t)},InOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}},Elastic:{In:function(t){var e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),-i*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/.4))},Out:function(t){var e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),i*Math.pow(2,-10*t)*Math.sin((t-e)*(2*Math.PI)/.4)+1)},InOut:function(t){var e,i=.1;return 0===t?0:1===t?1:(!i||i<1?(i=1,e=.1):e=.4*Math.asin(1/i)/(2*Math.PI),(t*=2)<1?i*Math.pow(2,10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/.4)*-.5:i*Math.pow(2,-10*(t-=1))*Math.sin((t-e)*(2*Math.PI)/.4)*.5+1)}},Back:{In:function(t){var e=1.70158;return t*t*((e+1)*t-e)},Out:function(t){var e=1.70158;return--t*t*((e+1)*t+e)+1},InOut:function(t){var e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)}},Bounce:{In:function(t){return 1-TWEEN.Easing.Bounce.Out(1-t)},Out:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},InOut:function(t){return t<.5?.5*TWEEN.Easing.Bounce.In(2*t):.5*TWEEN.Easing.Bounce.Out(2*t-1)+.5}}},TWEEN.Interpolation={Linear:function(t,e){var i=t.length-1,r=i*e,n=Math.floor(r),o=TWEEN.Interpolation.Utils.Linear;return e<0?o(t[0],t[1],r):e>1?o(t[i],t[i-1],i-r):o(t[n],t[n+1>i?i:n+1],r-n)},Bezier:function(t,e){var i,r=0,n=t.length-1,o=Math.pow,a=TWEEN.Interpolation.Utils.Bernstein;for(i=0;i<=n;i++)r+=o(1-e,n-i)*o(e,i)*t[i]*a(n,i);return r},CatmullRom:function(t,e){var i=t.length-1,r=i*e,n=Math.floor(r),o=TWEEN.Interpolation.Utils.CatmullRom;return t[0]===t[i]?(e<0&&(n=Math.floor(r=i*(1+e))),o(t[(n-1+i)%i],t[n],t[(n+1)%i],t[(n+2)%i],r-n)):e<0?t[0]-(o(t[0],t[0],t[1],t[1],-r)-t[0]):e>1?t[i]-(o(t[i],t[i],t[i-1],t[i-1],r-i)-t[i]):o(t[n?n-1:0],t[n],t[i<n+1?i:n+1],t[i<n+2?i:n+2],r-n)},Utils:{Linear:function(t,e,i){return(e-t)*i+t},Bernstein:function(t,e){var i=TWEEN.Interpolation.Utils.Factorial;return i(t)/i(e)/i(t-e)},Factorial:function(){var t=[1];return function(e){var i,r=1;if(t[e])return t[e];for(i=e;i>1;i--)r*=i;return t[e]=r}}(),CatmullRom:function(t,e,i,r,n){var o=.5*(i-t),a=.5*(r-e),s=n*n;return(2*e-2*i+o+a)*(n*s)+(-3*e+3*i-2*o-a)*s+o*n+e}}},"undefined"!=typeof module&&module.exports&&(module.exports=TWEEN),function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.THREE={})}(this,function(t){"use strict";function e(){}void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Number.isInteger&&(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&Math.floor(t)===t}),void 0===Math.sign&&(Math.sign=function(t){return t<0?-1:t>0?1:+t}),"name"in Function.prototype==!1&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&(Object.assign=function(t){if(void 0===t||null===t)throw new TypeError("Cannot convert undefined or null to object");for(var e=Object(t),i=1;i<arguments.length;i++){var r=arguments[i];if(void 0!==r&&null!==r)for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}),Object.assign(e.prototype,{addEventListener:function(t,e){void 0===this._listeners&&(this._listeners={});var i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)},hasEventListener:function(t,e){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)},removeEventListener:function(t,e){if(void 0!==this._listeners){var i=this._listeners[t];if(void 0!==i){var r=i.indexOf(e);-1!==r&&i.splice(r,1)}}},dispatchEvent:function(t){if(void 0!==this._listeners){var e=this._listeners[t.type];if(void 0!==e){t.target=this;for(var i=e.slice(0),r=0,n=i.length;r<n;r++)i[r].call(this,t)}}}});var i,r,n,o,a,s,h,l,c,u,p,d=0,f=1,m=2,g=1,v=2,y=0,E=1,x=2,_=0,w=1,b=2,S=0,T=1,M=2,R=3,A=4,C=5,P=100,D=101,L=102,O=103,H=104,I=200,B=201,z=202,N=203,k=204,j=205,V=206,F=207,U=208,G=209,W=210,X=0,Z=1,Y=2,q=3,J=4,Q=5,K=6,$=7,tt=0,et=1,it=2,rt=0,nt=1,ot=2,at=3,st=4,ht=301,lt=302,ct=303,ut=304,pt=305,dt=306,ft=307,mt=1e3,gt=1001,vt=1002,yt=1003,Et=1004,xt=1005,_t=1006,wt=1007,bt=1008,St=1009,Tt=1010,Mt=1011,Rt=1012,At=1013,Ct=1014,Pt=1015,Dt=1016,Lt=1017,Ot=1018,Ht=1019,It=1020,Bt=1021,zt=1022,Nt=1023,kt=1024,jt=1025,Vt=Nt,Ft=1026,Ut=1027,Gt=33776,Wt=33777,Xt=33778,Zt=33779,Yt=35840,qt=35841,Jt=35842,Qt=35843,Kt=36196,$t=37808,te=37809,ee=37810,ie=37811,re=37812,ne=37813,oe=37814,ae=37815,se=37816,he=37817,le=37818,ce=37819,ue=37820,pe=37821,de=2201,fe=2400,me=0,ge=1,ve=2,ye=3e3,Ee=3001,xe=3007,_e=3002,we=3004,be=3005,Se=3006,Te=3200,Me=3201,Re=0,Ae=1,Ce={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){for(var t=[],e=0;e<256;e++)t[e]=(e<16?"0":"")+e.toString(16);return function(){var e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,r=4294967295*Math.random()|0,n=4294967295*Math.random()|0;return(t[255&e]+t[e>>8&255]+t[e>>16&255]+t[e>>24&255]+"-"+t[255&i]+t[i>>8&255]+"-"+t[i>>16&15|64]+t[i>>24&255]+"-"+t[63&r|128]+t[r>>8&255]+"-"+t[r>>16&255]+t[r>>24&255]+t[255&n]+t[n>>8&255]+t[n>>16&255]+t[n>>24&255]).toUpperCase()}}(),clamp:function(t,e,i){return Math.max(e,Math.min(i,t))},euclideanModulo:function(t,e){return(t%e+e)%e},mapLinear:function(t,e,i,r,n){return r+(t-e)*(n-r)/(i-e)},lerp:function(t,e,i){return(1-i)*t+i*e},smoothstep:function(t,e,i){return t<=e?0:t>=i?1:(t=(t-e)/(i-e))*t*(3-2*t)},smootherstep:function(t,e,i){return t<=e?0:t>=i?1:(t=(t-e)/(i-e))*t*t*(t*(6*t-15)+10)},randInt:function(t,e){return t+Math.floor(Math.random()*(e-t+1))},randFloat:function(t,e){return t+Math.random()*(e-t)},randFloatSpread:function(t){return t*(.5-Math.random())},degToRad:function(t){return t*Ce.DEG2RAD},radToDeg:function(t){return t*Ce.RAD2DEG},isPowerOfTwo:function(t){return 0==(t&t-1)&&0!==t},ceilPowerOfTwo:function(t){return Math.pow(2,Math.ceil(Math.log(t)/Math.LN2))},floorPowerOfTwo:function(t){return Math.pow(2,Math.floor(Math.log(t)/Math.LN2))}};function Pe(t,e){this.x=t||0,this.y=e||0}function De(){this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length}function Le(t,e,i,r){this._x=t||0,this._y=e||0,this._z=i||0,this._w=void 0!==r?r:1}function Oe(t,e,i){this.x=t||0,this.y=e||0,this.z=i||0}function He(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length}Object.defineProperties(Pe.prototype,{width:{get:function(){return this.x},set:function(t){this.x=t}},height:{get:function(){return this.y},set:function(t){this.y=t}}}),Object.assign(Pe.prototype,{isVector2:!0,set:function(t,e){return this.x=t,this.y=e,this},setScalar:function(t){return this.x=t,this.y=t,this},setX:function(t){return this.x=t,this},setY:function(t){return this.y=t,this},setComponent:function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this},getComponent:function(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}},clone:function(){return new this.constructor(this.x,this.y)},copy:function(t){return this.x=t.x,this.y=t.y,this},add:function(t,e){return void 0!==e?this.addVectors(t,e):(this.x+=t.x,this.y+=t.y,this)},addScalar:function(t){return this.x+=t,this.y+=t,this},addVectors:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this},addScaledVector:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this},sub:function(t,e){return void 0!==e?this.subVectors(t,e):(this.x-=t.x,this.y-=t.y,this)},subScalar:function(t){return this.x-=t,this.y-=t,this},subVectors:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this},multiply:function(t){return this.x*=t.x,this.y*=t.y,this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this},divide:function(t){return this.x/=t.x,this.y/=t.y,this},divideScalar:function(t){return this.multiplyScalar(1/t)},applyMatrix3:function(t){var e=this.x,i=this.y,r=t.elements;return this.x=r[0]*e+r[3]*i+r[6],this.y=r[1]*e+r[4]*i+r[7],this},min:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this},max:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this},clamp:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this},clampScalar:(i=new Pe,r=new Pe,function(t,e){return i.set(t,t),r.set(e,e),this.clamp(i,r)}),clampLength:function(t,e){var i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},dot:function(t){return this.x*t.x+this.y*t.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)},normalize:function(){return this.divideScalar(this.length()||1)},angle:function(){var t=Math.atan2(this.y,this.x);return t<0&&(t+=2*Math.PI),t},distanceTo:function(t){return Math.sqrt(this.distanceToSquared(t))},distanceToSquared:function(t){var e=this.x-t.x,i=this.y-t.y;return e*e+i*i},manhattanDistanceTo:function(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)},setLength:function(t){return this.normalize().multiplyScalar(t)},lerp:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this},lerpVectors:function(t,e,i){return this.subVectors(e,t).multiplyScalar(i).add(t)},equals:function(t){return t.x===this.x&&t.y===this.y},fromArray:function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t},fromBufferAttribute:function(t,e,i){return this.x=t.getX(e),this.y=t.getY(e),this},rotateAround:function(t,e){var i=Math.cos(e),r=Math.sin(e),n=this.x-t.x,o=this.y-t.y;return this.x=n*i-o*r+t.x,this.y=n*r+o*i+t.y,this}}),Object.assign(De.prototype,{isMatrix4:!0,set:function(t,e,i,r,n,o,a,s,h,l,c,u,p,d,f,m){var g=this.elements;return g[0]=t,g[4]=e,g[8]=i,g[12]=r,g[1]=n,g[5]=o,g[9]=a,g[13]=s,g[2]=h,g[6]=l,g[10]=c,g[14]=u,g[3]=p,g[7]=d,g[11]=f,g[15]=m,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return(new De).fromArray(this.elements)},copy:function(t){var e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],this},copyPosition:function(t){var e=this.elements,i=t.elements;return e[12]=i[12],e[13]=i[13],e[14]=i[14],this},extractBasis:function(t,e,i){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this},makeBasis:function(t,e,i){return this.set(t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,0,0,0,1),this},extractRotation:(u=new Oe,function(t){var e=this.elements,i=t.elements,r=1/u.setFromMatrixColumn(t,0).length(),n=1/u.setFromMatrixColumn(t,1).length(),o=1/u.setFromMatrixColumn(t,2).length();return e[0]=i[0]*r,e[1]=i[1]*r,e[2]=i[2]*r,e[3]=0,e[4]=i[4]*n,e[5]=i[5]*n,e[6]=i[6]*n,e[7]=0,e[8]=i[8]*o,e[9]=i[9]*o,e[10]=i[10]*o,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}),makeRotationFromEuler:function(t){!t||t.isEuler;var e=this.elements,i=t.x,r=t.y,n=t.z,o=Math.cos(i),a=Math.sin(i),s=Math.cos(r),h=Math.sin(r),l=Math.cos(n),c=Math.sin(n);if("XYZ"===t.order){var u=o*l,p=o*c,d=a*l,f=a*c;e[0]=s*l,e[4]=-s*c,e[8]=h,e[1]=p+d*h,e[5]=u-f*h,e[9]=-a*s,e[2]=f-u*h,e[6]=d+p*h,e[10]=o*s}else if("YXZ"===t.order){var m=s*l,g=s*c,v=h*l,y=h*c;e[0]=m+y*a,e[4]=v*a-g,e[8]=o*h,e[1]=o*c,e[5]=o*l,e[9]=-a,e[2]=g*a-v,e[6]=y+m*a,e[10]=o*s}else if("ZXY"===t.order){m=s*l,g=s*c,v=h*l,y=h*c;e[0]=m-y*a,e[4]=-o*c,e[8]=v+g*a,e[1]=g+v*a,e[5]=o*l,e[9]=y-m*a,e[2]=-o*h,e[6]=a,e[10]=o*s}else if("ZYX"===t.order){u=o*l,p=o*c,d=a*l,f=a*c;e[0]=s*l,e[4]=d*h-p,e[8]=u*h+f,e[1]=s*c,e[5]=f*h+u,e[9]=p*h-d,e[2]=-h,e[6]=a*s,e[10]=o*s}else if("YZX"===t.order){var E=o*s,x=o*h,_=a*s,w=a*h;e[0]=s*l,e[4]=w-E*c,e[8]=_*c+x,e[1]=c,e[5]=o*l,e[9]=-a*l,e[2]=-h*l,e[6]=x*c+_,e[10]=E-w*c}else if("XZY"===t.order){E=o*s,x=o*h,_=a*s,w=a*h;e[0]=s*l,e[4]=-c,e[8]=h*l,e[1]=E*c+w,e[5]=o*l,e[9]=x*c-_,e[2]=_*c-x,e[6]=a*l,e[10]=w*c+E}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this},makeRotationFromQuaternion:(l=new Oe(0,0,0),c=new Oe(1,1,1),function(t){return this.compose(l,t,c)}),lookAt:(a=new Oe,s=new Oe,h=new Oe,function(t,e,i){var r=this.elements;return h.subVectors(t,e),0===h.lengthSq()&&(h.z=1),h.normalize(),a.crossVectors(i,h),0===a.lengthSq()&&(1===Math.abs(i.z)?h.x+=1e-4:h.z+=1e-4,h.normalize(),a.crossVectors(i,h)),a.normalize(),s.crossVectors(h,a),r[0]=a.x,r[4]=s.x,r[8]=h.x,r[1]=a.y,r[5]=s.y,r[9]=h.y,r[2]=a.z,r[6]=s.z,r[10]=h.z,this}),multiply:function(t,e){return void 0!==e?this.multiplyMatrices(t,e):this.multiplyMatrices(this,t)},premultiply:function(t){return this.multiplyMatrices(t,this)},multiplyMatrices:function(t,e){var i=t.elements,r=e.elements,n=this.elements,o=i[0],a=i[4],s=i[8],h=i[12],l=i[1],c=i[5],u=i[9],p=i[13],d=i[2],f=i[6],m=i[10],g=i[14],v=i[3],y=i[7],E=i[11],x=i[15],_=r[0],w=r[4],b=r[8],S=r[12],T=r[1],M=r[5],R=r[9],A=r[13],C=r[2],P=r[6],D=r[10],L=r[14],O=r[3],H=r[7],I=r[11],B=r[15];return n[0]=o*_+a*T+s*C+h*O,n[4]=o*w+a*M+s*P+h*H,n[8]=o*b+a*R+s*D+h*I,n[12]=o*S+a*A+s*L+h*B,n[1]=l*_+c*T+u*C+p*O,n[5]=l*w+c*M+u*P+p*H,n[9]=l*b+c*R+u*D+p*I,n[13]=l*S+c*A+u*L+p*B,n[2]=d*_+f*T+m*C+g*O,n[6]=d*w+f*M+m*P+g*H,n[10]=d*b+f*R+m*D+g*I,n[14]=d*S+f*A+m*L+g*B,n[3]=v*_+y*T+E*C+x*O,n[7]=v*w+y*M+E*P+x*H,n[11]=v*b+y*R+E*D+x*I,n[15]=v*S+y*A+E*L+x*B,this},multiplyScalar:function(t){var e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this},applyToBufferAttribute:function(){var t=new Oe;return function(e){for(var i=0,r=e.count;i<r;i++)t.x=e.getX(i),t.y=e.getY(i),t.z=e.getZ(i),t.applyMatrix4(this),e.setXYZ(i,t.x,t.y,t.z);return e}}(),determinant:function(){var t=this.elements,e=t[0],i=t[4],r=t[8],n=t[12],o=t[1],a=t[5],s=t[9],h=t[13],l=t[2],c=t[6],u=t[10],p=t[14];return t[3]*(+n*s*c-r*h*c-n*a*u+i*h*u+r*a*p-i*s*p)+t[7]*(+e*s*p-e*h*u+n*o*u-r*o*p+r*h*l-n*s*l)+t[11]*(+e*h*c-e*a*p-n*o*c+i*o*p+n*a*l-i*h*l)+t[15]*(-r*a*l-e*s*c+e*a*u+r*o*c-i*o*u+i*s*l)},transpose:function(){var t,e=this.elements;return t=e[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this},setPosition:function(t){var e=this.elements;return e[12]=t.x,e[13]=t.y,e[14]=t.z,this},getInverse:function(t,e){var i=this.elements,r=t.elements,n=r[0],o=r[1],a=r[2],s=r[3],h=r[4],l=r[5],c=r[6],u=r[7],p=r[8],d=r[9],f=r[10],m=r[11],g=r[12],v=r[13],y=r[14],E=r[15],x=d*y*u-v*f*u+v*c*m-l*y*m-d*c*E+l*f*E,_=g*f*u-p*y*u-g*c*m+h*y*m+p*c*E-h*f*E,w=p*v*u-g*d*u+g*l*m-h*v*m-p*l*E+h*d*E,b=g*d*c-p*v*c-g*l*f+h*v*f+p*l*y-h*d*y,S=n*x+o*_+a*w+s*b;if(0===S){if(!0===e)throw new Error("THREE.Matrix4: .getInverse() can't invert matrix, determinant is 0");return this.identity()}var T=1/S;return i[0]=x*T,i[1]=(v*f*s-d*y*s-v*a*m+o*y*m+d*a*E-o*f*E)*T,i[2]=(l*y*s-v*c*s+v*a*u-o*y*u-l*a*E+o*c*E)*T,i[3]=(d*c*s-l*f*s-d*a*u+o*f*u+l*a*m-o*c*m)*T,i[4]=_*T,i[5]=(p*y*s-g*f*s+g*a*m-n*y*m-p*a*E+n*f*E)*T,i[6]=(g*c*s-h*y*s-g*a*u+n*y*u+h*a*E-n*c*E)*T,i[7]=(h*f*s-p*c*s+p*a*u-n*f*u-h*a*m+n*c*m)*T,i[8]=w*T,i[9]=(g*d*s-p*v*s-g*o*m+n*v*m+p*o*E-n*d*E)*T,i[10]=(h*v*s-g*l*s+g*o*u-n*v*u-h*o*E+n*l*E)*T,i[11]=(p*l*s-h*d*s-p*o*u+n*d*u+h*o*m-n*l*m)*T,i[12]=b*T,i[13]=(p*v*a-g*d*a+g*o*f-n*v*f-p*o*y+n*d*y)*T,i[14]=(g*l*a-h*v*a-g*o*c+n*v*c+h*o*y-n*l*y)*T,i[15]=(h*d*a-p*l*a+p*o*c-n*d*c-h*o*f+n*l*f)*T,this},scale:function(t){var e=this.elements,i=t.x,r=t.y,n=t.z;return e[0]*=i,e[4]*=r,e[8]*=n,e[1]*=i,e[5]*=r,e[9]*=n,e[2]*=i,e[6]*=r,e[10]*=n,e[3]*=i,e[7]*=r,e[11]*=n,this},getMaxScaleOnAxis:function(){var t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],r=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,i,r))},makeTranslation:function(t,e,i){return this.set(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1),this},makeRotationX:function(t){var e=Math.cos(t),i=Math.sin(t);return this.set(1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1),this},makeRotationY:function(t){var e=Math.cos(t),i=Math.sin(t);return this.set(e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1),this},makeRotationZ:function(t){var e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(t,e){var i=Math.cos(e),r=Math.sin(e),n=1-i,o=t.x,a=t.y,s=t.z,h=n*o,l=n*a;return this.set(h*o+i,h*a-r*s,h*s+r*a,0,h*a+r*s,l*a+i,l*s-r*o,0,h*s-r*a,l*s+r*o,n*s*s+i,0,0,0,0,1),this},makeScale:function(t,e,i){return this.set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1),this},makeShear:function(t,e,i){return this.set(1,e,i,0,t,1,i,0,t,e,1,0,0,0,0,1),this},compose:function(t,e,i){var r=this.elements,n=e._x,o=e._y,a=e._z,s=e._w,h=n+n,l=o+o,c=a+a,u=n*h,p=n*l,d=n*c,f=o*l,m=o*c,g=a*c,v=s*h,y=s*l,E=s*c,x=i.x,_=i.y,w=i.z;return r[0]=(1-(f+g))*x,r[1]=(p+E)*x,r[2]=(d-y)*x,r[3]=0,r[4]=(p-E)*_,r[5]=(1-(u+g))*_,r[6]=(m+v)*_,r[7]=0,r[8]=(d+y)*w,r[9]=(m-v)*w,r[10]=(1-(u+f))*w,r[11]=0,r[12]=t.x,r[13]=t.y,r[14]=t.z,r[15]=1,this},decompose:(n=new Oe,o=new De,function(t,e,i){var r=this.elements,a=n.set(r[0],r[1],r[2]).length(),s=n.set(r[4],r[5],r[6]).length(),h=n.set(r[8],r[9],r[10]).length();this.determinant()<0&&(a=-a),t.x=r[12],t.y=r[13],t.z=r[14],o.copy(this);var l=1/a,c=1/s,u=1/h;return o.elements[0]*=l,o.elements[1]*=l,o.elements[2]*=l,o.elements[4]*=c,o.elements[5]*=c,o.elements[6]*=c,o.elements[8]*=u,o.elements[9]*=u,o.elements[10]*=u,e.setFromRotationMatrix(o),i.x=a,i.y=s,i.z=h,this}),makePerspective:function(t,e,i,r,n,o){var a=this.elements,s=2*n/(e-t),h=2*n/(i-r),l=(e+t)/(e-t),c=(i+r)/(i-r),u=-(o+n)/(o-n),p=-2*o*n/(o-n);return a[0]=s,a[4]=0,a[8]=l,a[12]=0,a[1]=0,a[5]=h,a[9]=c,a[13]=0,a[2]=0,a[6]=0,a[10]=u,a[14]=p,a[3]=0,a[7]=0,a[11]=-1,a[15]=0,this},makeOrthographic:function(t,e,i,r,n,o){var a=this.elements,s=1/(e-t),h=1/(i-r),l=1/(o-n),c=(e+t)*s,u=(i+r)*h,p=(o+n)*l;return a[0]=2*s,a[4]=0,a[8]=0,a[12]=-c,a[1]=0,a[5]=2*h,a[9]=0,a[13]=-u,a[2]=0,a[6]=0,a[10]=-2*l,a[14]=-p,a[3]=0,a[7]=0,a[11]=0,a[15]=1,this},equals:function(t){for(var e=this.elements,i=t.elements,r=0;r<16;r++)if(e[r]!==i[r])return!1;return!0},fromArray:function(t,e){void 0===e&&(e=0);for(var i=0;i<16;i++)this.elements[i]=t[i+e];return this},toArray:function(t,e){void 0===t&&(t=[]),void 0===e&&(e=0);var i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t[e+9]=i[9],t[e+10]=i[10],t[e+11]=i[11],t[e+12]=i[12],t[e+13]=i[13],t[e+14]=i[14],t[e+15]=i[15],t}}),Object.assign(Le,{slerp:function(t,e,i,r){return i.copy(t).slerp(e,r)},slerpFlat:function(t,e,i,r,n,o,a){var s=i[r+0],h=i[r+1],l=i[r+2],c=i[r+3],u=n[o+0],p=n[o+1],d=n[o+2],f=n[o+3];if(c!==f||s!==u||h!==p||l!==d){var m=1-a,g=s*u+h*p+l*d+c*f,v=g>=0?1:-1,y=1-g*g;if(y>Number.EPSILON){var E=Math.sqrt(y),x=Math.atan2(E,g*v);m=Math.sin(m*x)/E,a=Math.sin(a*x)/E}var _=a*v;if(s=s*m+u*_,h=h*m+p*_,l=l*m+d*_,c=c*m+f*_,m===1-a){var w=1/Math.sqrt(s*s+h*h+l*l+c*c);s*=w,h*=w,l*=w,c*=w}}t[e]=s,t[e+1]=h,t[e+2]=l,t[e+3]=c}}),Object.defineProperties(Le.prototype,{x:{get:function(){return this._x},set:function(t){this._x=t,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(t){this._y=t,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(t){this._z=t,this.onChangeCallback()}},w:{get:function(){return this._w},set:function(t){this._w=t,this.onChangeCallback()}}}),Object.assign(Le.prototype,{set:function(t,e,i,r){return this._x=t,this._y=e,this._z=i,this._w=r,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this.onChangeCallback(),this},setFromEuler:function(t,e){if(!t||!t.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var i=t._x,r=t._y,n=t._z,o=t.order,a=Math.cos,s=Math.sin,h=a(i/2),l=a(r/2),c=a(n/2),u=s(i/2),p=s(r/2),d=s(n/2);return"XYZ"===o?(this._x=u*l*c+h*p*d,this._y=h*p*c-u*l*d,this._z=h*l*d+u*p*c,this._w=h*l*c-u*p*d):"YXZ"===o?(this._x=u*l*c+h*p*d,this._y=h*p*c-u*l*d,this._z=h*l*d-u*p*c,this._w=h*l*c+u*p*d):"ZXY"===o?(this._x=u*l*c-h*p*d,this._y=h*p*c+u*l*d,this._z=h*l*d+u*p*c,this._w=h*l*c-u*p*d):"ZYX"===o?(this._x=u*l*c-h*p*d,this._y=h*p*c+u*l*d,this._z=h*l*d-u*p*c,this._w=h*l*c+u*p*d):"YZX"===o?(this._x=u*l*c+h*p*d,this._y=h*p*c+u*l*d,this._z=h*l*d-u*p*c,this._w=h*l*c-u*p*d):"XZY"===o&&(this._x=u*l*c-h*p*d,this._y=h*p*c-u*l*d,this._z=h*l*d+u*p*c,this._w=h*l*c+u*p*d),!1!==e&&this.onChangeCallback(),this},setFromAxisAngle:function(t,e){var i=e/2,r=Math.sin(i);return this._x=t.x*r,this._y=t.y*r,this._z=t.z*r,this._w=Math.cos(i),this.onChangeCallback(),this},setFromRotationMatrix:function(t){var e,i=t.elements,r=i[0],n=i[4],o=i[8],a=i[1],s=i[5],h=i[9],l=i[2],c=i[6],u=i[10],p=r+s+u;return p>0?(e=.5/Math.sqrt(p+1),this._w=.25/e,this._x=(c-h)*e,this._y=(o-l)*e,this._z=(a-n)*e):r>s&&r>u?(e=2*Math.sqrt(1+r-s-u),this._w=(c-h)/e,this._x=.25*e,this._y=(n+a)/e,this._z=(o+l)/e):s>u?(e=2*Math.sqrt(1+s-r-u),this._w=(o-l)/e,this._x=(n+a)/e,this._y=.25*e,this._z=(h+c)/e):(e=2*Math.sqrt(1+u-r-s),this._w=(a-n)/e,this._x=(o+l)/e,this._y=(h+c)/e,this._z=.25*e),this.onChangeCallback(),this},setFromUnitVectors:function(){var t,e=new Oe;return function(i,r){return void 0===e&&(e=new Oe),(t=i.dot(r)+1)<1e-6?(t=0,Math.abs(i.x)>Math.abs(i.z)?e.set(-i.y,i.x,0):e.set(0,-i.z,i.y)):e.crossVectors(i,r),this._x=e.x,this._y=e.y,this._z=e.z,this._w=t,this.normalize()}}(),inverse:function(){return this.conjugate()},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this},dot:function(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this.onChangeCallback(),this},multiply:function(t,e){return void 0!==e?this.multiplyQuaternions(t,e):this.multiplyQuaternions(this,t)},premultiply:function(t){return this.multiplyQuaternions(t,this)},multiplyQuaternions:function(t,e){var i=t._x,r=t._y,n=t._z,o=t._w,a=e._x,s=e._y,h=e._z,l=e._w;return this._x=i*l+o*a+r*h-n*s,this._y=r*l+o*s+n*a-i*h,this._z=n*l+o*h+i*s-r*a,this._w=o*l-i*a-r*s-n*h,this.onChangeCallback(),this},slerp:function(t,e){if(0===e)return this;if(1===e)return this.copy(t);var i=this._x,r=this._y,n=this._z,o=this._w,a=o*t._w+i*t._x+r*t._y+n*t._z;if(a<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,a=-a):this.copy(t),a>=1)return this._w=o,this._x=i,this._y=r,this._z=n,this;var s=1-a*a;if(s<=Number.EPSILON){var h=1-e;return this._w=h*o+e*this._w,this._x=h*i+e*this._x,this._y=h*r+e*this._y,this._z=h*n+e*this._z,this.normalize()}var l=Math.sqrt(s),c=Math.atan2(l,a),u=Math.sin((1-e)*c)/l,p=Math.sin(e*c)/l;return this._w=o*u+this._w*p,this._x=i*u+this._x*p,this._y=r*u+this._y*p,this._z=n*u+this._z*p,this.onChangeCallback(),this},equals:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w},fromArray:function(t,e){return void 0===e&&(e=0),this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this.onChangeCallback(),this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t},onChange:function(t){return this.onChangeCallback=t,this},onChangeCallback:function(){}}),Object.assign(Oe.prototype,{isVector3:!0,set:function(t,e,i){return this.x=t,this.y=e,this.z=i,this},setScalar:function(t){return this.x=t,this.y=t,this.z=t,this},setX:function(t){return this.x=t,this},setY:function(t){return this.y=t,this},setZ:function(t){return this.z=t,this},setComponent:function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this},getComponent:function(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},add:function(t,e){return void 0!==e?this.addVectors(t,e):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)},addScalar:function(t){return this.x+=t,this.y+=t,this.z+=t,this},addVectors:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},addScaledVector:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this},sub:function(t,e){return void 0!==e?this.subVectors(t,e):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)},subScalar:function(t){return this.x-=t,this.y-=t,this.z-=t,this},subVectors:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},multiply:function(t,e){return void 0!==e?this.multiplyVectors(t,e):(this.x*=t.x,this.y*=t.y,this.z*=t.z,this)},multiplyScalar:function(t){return this.x*=t,this.y*=t,this.z*=t,this},multiplyVectors:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this},applyEuler:(p=new Le,function(t){return!t||t.isEuler,this.applyQuaternion(p.setFromEuler(t))}),applyAxisAngle:function(){var t=new Le;return function(e,i){return this.applyQuaternion(t.setFromAxisAngle(e,i))}}(),applyMatrix3:function(t){var e=this.x,i=this.y,r=this.z,n=t.elements;return this.x=n[0]*e+n[3]*i+n[6]*r,this.y=n[1]*e+n[4]*i+n[7]*r,this.z=n[2]*e+n[5]*i+n[8]*r,this},applyMatrix4:function(t){var e=this.x,i=this.y,r=this.z,n=t.elements,o=1/(n[3]*e+n[7]*i+n[11]*r+n[15]);return this.x=(n[0]*e+n[4]*i+n[8]*r+n[12])*o,this.y=(n[1]*e+n[5]*i+n[9]*r+n[13])*o,this.z=(n[2]*e+n[6]*i+n[10]*r+n[14])*o,this},applyQuaternion:function(t){var e=this.x,i=this.y,r=this.z,n=t.x,o=t.y,a=t.z,s=t.w,h=s*e+o*r-a*i,l=s*i+a*e-n*r,c=s*r+n*i-o*e,u=-n*e-o*i-a*r;return this.x=h*s+u*-n+l*-a-c*-o,this.y=l*s+u*-o+c*-n-h*-a,this.z=c*s+u*-a+h*-o-l*-n,this},project:function(){var t=new De;return function(e){return t.multiplyMatrices(e.projectionMatrix,t.getInverse(e.matrixWorld)),this.applyMatrix4(t)}}(),unproject:function(){var t=new De;return function(e){return t.multiplyMatrices(e.matrixWorld,t.getInverse(e.projectionMatrix)),this.applyMatrix4(t)}}(),transformDirection:function(t){var e=this.x,i=this.y,r=this.z,n=t.elements;return this.x=n[0]*e+n[4]*i+n[8]*r,this.y=n[1]*e+n[5]*i+n[9]*r,this.z=n[2]*e+n[6]*i+n[10]*r,this.normalize()},divide:function(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this},divideScalar:function(t){return this.multiplyScalar(1/t)},min:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this},max:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this},clamp:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this},clampScalar:function(){var t=new Oe,e=new Oe;return function(i,r){return t.set(i,i,i),e.set(r,r,r),this.clamp(t,e)}}(),clampLength:function(t,e){var i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length()||1)},setLength:function(t){return this.normalize().multiplyScalar(t)},lerp:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this},lerpVectors:function(t,e,i){return this.subVectors(e,t).multiplyScalar(i).add(t)},cross:function(t,e){return void 0!==e?this.crossVectors(t,e):this.crossVectors(this,t)},crossVectors:function(t,e){var i=t.x,r=t.y,n=t.z,o=e.x,a=e.y,s=e.z;return this.x=r*s-n*a,this.y=n*o-i*s,this.z=i*a-r*o,this},projectOnVector:function(t){var e=t.dot(this)/t.lengthSq();return this.copy(t).multiplyScalar(e)},projectOnPlane:function(){var t=new Oe;return function(e){return t.copy(this).projectOnVector(e),this.sub(t)}}(),reflect:function(){var t=new Oe;return function(e){return this.sub(t.copy(e).multiplyScalar(2*this.dot(e)))}}(),angleTo:function(t){var e=this.dot(t)/Math.sqrt(this.lengthSq()*t.lengthSq());return Math.acos(Ce.clamp(e,-1,1))},distanceTo:function(t){return Math.sqrt(this.distanceToSquared(t))},distanceToSquared:function(t){var e=this.x-t.x,i=this.y-t.y,r=this.z-t.z;return e*e+i*i+r*r},manhattanDistanceTo:function(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)},setFromSpherical:function(t){var e=Math.sin(t.phi)*t.radius;return this.x=e*Math.sin(t.theta),this.y=Math.cos(t.phi)*t.radius,this.z=e*Math.cos(t.theta),this},setFromCylindrical:function(t){return this.x=t.radius*Math.sin(t.theta),this.y=t.y,this.z=t.radius*Math.cos(t.theta),this},setFromMatrixPosition:function(t){var e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this},setFromMatrixScale:function(t){var e=this.setFromMatrixColumn(t,0).length(),i=this.setFromMatrixColumn(t,1).length(),r=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=i,this.z=r,this},setFromMatrixColumn:function(t,e){return this.fromArray(t.elements,4*e)},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z},fromArray:function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t},fromBufferAttribute:function(t,e,i){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}}),Object.assign(He.prototype,{isMatrix3:!0,set:function(t,e,i,r,n,o,a,s,h){var l=this.elements;return l[0]=t,l[1]=r,l[2]=a,l[3]=e,l[4]=n,l[5]=s,l[6]=i,l[7]=o,l[8]=h,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(t){var e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],this},setFromMatrix4:function(t){var e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this},applyToBufferAttribute:function(){var t=new Oe;return function(e){for(var i=0,r=e.count;i<r;i++)t.x=e.getX(i),t.y=e.getY(i),t.z=e.getZ(i),t.applyMatrix3(this),e.setXYZ(i,t.x,t.y,t.z);return e}}(),multiply:function(t){return this.multiplyMatrices(this,t)},premultiply:function(t){return this.multiplyMatrices(t,this)},multiplyMatrices:function(t,e){var i=t.elements,r=e.elements,n=this.elements,o=i[0],a=i[3],s=i[6],h=i[1],l=i[4],c=i[7],u=i[2],p=i[5],d=i[8],f=r[0],m=r[3],g=r[6],v=r[1],y=r[4],E=r[7],x=r[2],_=r[5],w=r[8];return n[0]=o*f+a*v+s*x,n[3]=o*m+a*y+s*_,n[6]=o*g+a*E+s*w,n[1]=h*f+l*v+c*x,n[4]=h*m+l*y+c*_,n[7]=h*g+l*E+c*w,n[2]=u*f+p*v+d*x,n[5]=u*m+p*y+d*_,n[8]=u*g+p*E+d*w,this},multiplyScalar:function(t){var e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this},determinant:function(){var t=this.elements,e=t[0],i=t[1],r=t[2],n=t[3],o=t[4],a=t[5],s=t[6],h=t[7],l=t[8];return e*o*l-e*a*h-i*n*l+i*a*s+r*n*h-r*o*s},getInverse:function(t,e){t&&t.isMatrix4;var i=t.elements,r=this.elements,n=i[0],o=i[1],a=i[2],s=i[3],h=i[4],l=i[5],c=i[6],u=i[7],p=i[8],d=p*h-l*u,f=l*c-p*s,m=u*s-h*c,g=n*d+o*f+a*m;if(0===g){if(!0===e)throw new Error("THREE.Matrix3: .getInverse() can't invert matrix, determinant is 0");return this.identity()}var v=1/g;return r[0]=d*v,r[1]=(a*u-p*o)*v,r[2]=(l*o-a*h)*v,r[3]=f*v,r[4]=(p*n-a*c)*v,r[5]=(a*s-l*n)*v,r[6]=m*v,r[7]=(o*c-u*n)*v,r[8]=(h*n-o*s)*v,this},transpose:function(){var t,e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this},getNormalMatrix:function(t){return this.setFromMatrix4(t).getInverse(this).transpose()},transposeIntoArray:function(t){var e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this},setUvTransform:function(t,e,i,r,n,o,a){var s=Math.cos(n),h=Math.sin(n);this.set(i*s,i*h,-i*(s*o+h*a)+o+t,-r*h,r*s,-r*(-h*o+s*a)+a+e,0,0,1)},scale:function(t,e){var i=this.elements;return i[0]*=t,i[3]*=t,i[6]*=t,i[1]*=e,i[4]*=e,i[7]*=e,this},rotate:function(t){var e=Math.cos(t),i=Math.sin(t),r=this.elements,n=r[0],o=r[3],a=r[6],s=r[1],h=r[4],l=r[7];return r[0]=e*n+i*s,r[3]=e*o+i*h,r[6]=e*a+i*l,r[1]=-i*n+e*s,r[4]=-i*o+e*h,r[7]=-i*a+e*l,this},translate:function(t,e){var i=this.elements;return i[0]+=t*i[2],i[3]+=t*i[5],i[6]+=t*i[8],i[1]+=e*i[2],i[4]+=e*i[5],i[7]+=e*i[8],this},equals:function(t){for(var e=this.elements,i=t.elements,r=0;r<9;r++)if(e[r]!==i[r])return!1;return!0},fromArray:function(t,e){void 0===e&&(e=0);for(var i=0;i<9;i++)this.elements[i]=t[i+e];return this},toArray:function(t,e){void 0===t&&(t=[]),void 0===e&&(e=0);var i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t}});var Ie,Be,ze,Ne,ke,je=0;function Ve(t,e,i,r,n,o,a,s,h,l){Object.defineProperty(this,"id",{value:je++}),this.uuid=Ce.generateUUID(),this.name="",this.image=void 0!==t?t:Ve.DEFAULT_IMAGE,this.mipmaps=[],this.mapping=void 0!==e?e:Ve.DEFAULT_MAPPING,this.wrapS=void 0!==i?i:gt,this.wrapT=void 0!==r?r:gt,this.magFilter=void 0!==n?n:_t,this.minFilter=void 0!==o?o:bt,this.anisotropy=void 0!==h?h:1,this.format=void 0!==a?a:Nt,this.type=void 0!==s?s:St,this.offset=new Pe(0,0),this.repeat=new Pe(1,1),this.center=new Pe(0,0),this.rotation=0,this.matrixAutoUpdate=!0,this.matrix=new He,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=void 0!==l?l:ye,this.version=0,this.onUpdate=null}function Fe(t,e,i,r){this.x=t||0,this.y=e||0,this.z=i||0,this.w=void 0!==r?r:1}function Ue(t,e,i){this.width=t,this.height=e,this.scissor=new Fe(0,0,t,e),this.scissorTest=!1,this.viewport=new Fe(0,0,t,e),void 0===(i=i||{}).minFilter&&(i.minFilter=_t),this.texture=new Ve(void 0,void 0,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.encoding),this.texture.generateMipmaps=void 0===i.generateMipmaps||i.generateMipmaps,this.depthBuffer=void 0===i.depthBuffer||i.depthBuffer,this.stencilBuffer=void 0===i.stencilBuffer||i.stencilBuffer,this.depthTexture=void 0!==i.depthTexture?i.depthTexture:null}function Ge(t,e,i){Ue.call(this,t,e,i),this.activeCubeFace=0,this.activeMipMapLevel=0}function We(t,e,i,r,n,o,a,s,h,l,c,u){Ve.call(this,null,o,a,s,h,l,r,n,c,u),this.image={data:t,width:e,height:i},this.magFilter=void 0!==h?h:yt,this.minFilter=void 0!==l?l:yt,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}function Xe(t,e){this.min=void 0!==t?t:new Oe(1/0,1/0,1/0),this.max=void 0!==e?e:new Oe(-1/0,-1/0,-1/0)}function Ze(t,e){this.center=void 0!==t?t:new Oe,this.radius=void 0!==e?e:0}function Ye(t,e){this.normal=void 0!==t?t:new Oe(1,0,0),this.constant=void 0!==e?e:0}function qe(t,e,i,r,n,o){this.planes=[void 0!==t?t:new Ye,void 0!==e?e:new Ye,void 0!==i?i:new Ye,void 0!==r?r:new Ye,void 0!==n?n:new Ye,void 0!==o?o:new Ye]}Ve.DEFAULT_IMAGE=void 0,Ve.DEFAULT_MAPPING=300,Ve.prototype=Object.assign(Object.create(e.prototype),{constructor:Ve,isTexture:!0,updateMatrix:function(){this.matrix.setUvTransform(this.offset.x,this.offset.y,this.repeat.x,this.repeat.y,this.rotation,this.center.x,this.center.y)},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.name=t.name,this.image=t.image,this.mipmaps=t.mipmaps.slice(0),this.mapping=t.mapping,this.wrapS=t.wrapS,this.wrapT=t.wrapT,this.magFilter=t.magFilter,this.minFilter=t.minFilter,this.anisotropy=t.anisotropy,this.format=t.format,this.type=t.type,this.offset.copy(t.offset),this.repeat.copy(t.repeat),this.center.copy(t.center),this.rotation=t.rotation,this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrix.copy(t.matrix),this.generateMipmaps=t.generateMipmaps,this.premultiplyAlpha=t.premultiplyAlpha,this.flipY=t.flipY,this.unpackAlignment=t.unpackAlignment,this.encoding=t.encoding,this},toJSON:function(t){var e=void 0===t||"string"==typeof t;if(!e&&void 0!==t.textures[this.uuid])return t.textures[this.uuid];function i(t){var e;if(t instanceof HTMLCanvasElement)e=t;else{(e=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")).width=t.width,e.height=t.height;var i=e.getContext("2d");t instanceof ImageData?i.putImageData(t,0,0):i.drawImage(t,0,0,t.width,t.height)}return e.width>2048||e.height>2048?e.toDataURL("image/jpeg",.6):e.toDataURL("image/png")}var r={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],center:[this.center.x,this.center.y],rotation:this.rotation,wrap:[this.wrapS,this.wrapT],format:this.format,minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY};if(void 0!==this.image){var n=this.image;if(void 0===n.uuid&&(n.uuid=Ce.generateUUID()),!e&&void 0===t.images[n.uuid]){var o;if(Array.isArray(n)){o=[];for(var a=0,s=n.length;a<s;a++)o.push(i(n[a]))}else o=i(n);t.images[n.uuid]={uuid:n.uuid,url:o}}r.image=n.uuid}return e||(t.textures[this.uuid]=r),r},dispose:function(){this.dispatchEvent({type:"dispose"})},transformUv:function(t){if(300===this.mapping){if(t.applyMatrix3(this.matrix),t.x<0||t.x>1)switch(this.wrapS){case mt:t.x=t.x-Math.floor(t.x);break;case gt:t.x=t.x<0?0:1;break;case vt:1===Math.abs(Math.floor(t.x)%2)?t.x=Math.ceil(t.x)-t.x:t.x=t.x-Math.floor(t.x)}if(t.y<0||t.y>1)switch(this.wrapT){case mt:t.y=t.y-Math.floor(t.y);break;case gt:t.y=t.y<0?0:1;break;case vt:1===Math.abs(Math.floor(t.y)%2)?t.y=Math.ceil(t.y)-t.y:t.y=t.y-Math.floor(t.y)}this.flipY&&(t.y=1-t.y)}}}),Object.defineProperty(Ve.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}}),Object.assign(Fe.prototype,{isVector4:!0,set:function(t,e,i,r){return this.x=t,this.y=e,this.z=i,this.w=r,this},setScalar:function(t){return this.x=t,this.y=t,this.z=t,this.w=t,this},setX:function(t){return this.x=t,this},setY:function(t){return this.y=t,this},setZ:function(t){return this.z=t,this},setW:function(t){return this.w=t,this},setComponent:function(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;case 3:this.w=e;break;default:throw new Error("index is out of range: "+t)}return this},getComponent:function(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+t)}},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=void 0!==t.w?t.w:1,this},add:function(t,e){return void 0!==e?this.addVectors(t,e):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this)},addScalar:function(t){return this.x+=t,this.y+=t,this.z+=t,this.w+=t,this},addVectors:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this},addScaledVector:function(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this.w+=t.w*e,this},sub:function(t,e){return void 0!==e?this.subVectors(t,e):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this)},subScalar:function(t){return this.x-=t,this.y-=t,this.z-=t,this.w-=t,this},subVectors:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this},multiplyScalar:function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},applyMatrix4:function(t){var e=this.x,i=this.y,r=this.z,n=this.w,o=t.elements;return this.x=o[0]*e+o[4]*i+o[8]*r+o[12]*n,this.y=o[1]*e+o[5]*i+o[9]*r+o[13]*n,this.z=o[2]*e+o[6]*i+o[10]*r+o[14]*n,this.w=o[3]*e+o[7]*i+o[11]*r+o[15]*n,this},divideScalar:function(t){return this.multiplyScalar(1/t)},setAxisAngleFromQuaternion:function(t){this.w=2*Math.acos(t.w);var e=Math.sqrt(1-t.w*t.w);return e<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=t.x/e,this.y=t.y/e,this.z=t.z/e),this},setAxisAngleFromRotationMatrix:function(t){var e,i,r,n,o=t.elements,a=o[0],s=o[4],h=o[8],l=o[1],c=o[5],u=o[9],p=o[2],d=o[6],f=o[10];if(Math.abs(s-l)<.01&&Math.abs(h-p)<.01&&Math.abs(u-d)<.01){if(Math.abs(s+l)<.1&&Math.abs(h+p)<.1&&Math.abs(u+d)<.1&&Math.abs(a+c+f-3)<.1)return this.set(1,0,0,0),this;e=Math.PI;var m=(a+1)/2,g=(c+1)/2,v=(f+1)/2,y=(s+l)/4,E=(h+p)/4,x=(u+d)/4;return m>g&&m>v?m<.01?(i=0,r=.707106781,n=.707106781):(r=y/(i=Math.sqrt(m)),n=E/i):g>v?g<.01?(i=.707106781,r=0,n=.707106781):(i=y/(r=Math.sqrt(g)),n=x/r):v<.01?(i=.707106781,r=.707106781,n=0):(i=E/(n=Math.sqrt(v)),r=x/n),this.set(i,r,n,e),this}var _=Math.sqrt((d-u)*(d-u)+(h-p)*(h-p)+(l-s)*(l-s));return Math.abs(_)<.001&&(_=1),this.x=(d-u)/_,this.y=(h-p)/_,this.z=(l-s)/_,this.w=Math.acos((a+c+f-1)/2),this},min:function(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this.w=Math.min(this.w,t.w),this},max:function(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this.w=Math.max(this.w,t.w),this},clamp:function(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this.w=Math.max(t.w,Math.min(e.w,this.w)),this},clampScalar:function(){var t,e;return function(i,r){return void 0===t&&(t=new Fe,e=new Fe),t.set(i,i,i,i),e.set(r,r,r,r),this.clamp(t,e)}}(),clampLength:function(t,e){var i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},manhattanLength:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length()||1)},setLength:function(t){return this.normalize().multiplyScalar(t)},lerp:function(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this.w+=(t.w-this.w)*e,this},lerpVectors:function(t,e,i){return this.subVectors(e,t).multiplyScalar(i).add(t)},equals:function(t){return t.x===this.x&&t.y===this.y&&t.z===this.z&&t.w===this.w},fromArray:function(t,e){return void 0===e&&(e=0),this.x=t[e],this.y=t[e+1],this.z=t[e+2],this.w=t[e+3],this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t[e+3]=this.w,t},fromBufferAttribute:function(t,e,i){return this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this.w=t.getW(e),this}}),Ue.prototype=Object.assign(Object.create(e.prototype),{constructor:Ue,isWebGLRenderTarget:!0,setSize:function(t,e){this.width===t&&this.height===e||(this.width=t,this.height=e,this.dispose()),this.viewport.set(0,0,t,e),this.scissor.set(0,0,t,e)},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.width=t.width,this.height=t.height,this.viewport.copy(t.viewport),this.texture=t.texture.clone(),this.depthBuffer=t.depthBuffer,this.stencilBuffer=t.stencilBuffer,this.depthTexture=t.depthTexture,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Ge.prototype=Object.create(Ue.prototype),Ge.prototype.constructor=Ge,Ge.prototype.isWebGLRenderTargetCube=!0,We.prototype=Object.create(Ve.prototype),We.prototype.constructor=We,We.prototype.isDataTexture=!0,Object.assign(Xe.prototype,{isBox3:!0,set:function(t,e){return this.min.copy(t),this.max.copy(e),this},setFromArray:function(t){for(var e=1/0,i=1/0,r=1/0,n=-1/0,o=-1/0,a=-1/0,s=0,h=t.length;s<h;s+=3){var l=t[s],c=t[s+1],u=t[s+2];l<e&&(e=l),c<i&&(i=c),u<r&&(r=u),l>n&&(n=l),c>o&&(o=c),u>a&&(a=u)}return this.min.set(e,i,r),this.max.set(n,o,a),this},setFromBufferAttribute:function(t){for(var e=1/0,i=1/0,r=1/0,n=-1/0,o=-1/0,a=-1/0,s=0,h=t.count;s<h;s++){var l=t.getX(s),c=t.getY(s),u=t.getZ(s);l<e&&(e=l),c<i&&(i=c),u<r&&(r=u),l>n&&(n=l),c>o&&(o=c),u>a&&(a=u)}return this.min.set(e,i,r),this.max.set(n,o,a),this},setFromPoints:function(t){this.makeEmpty();for(var e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this},setFromCenterAndSize:function(){var t=new Oe;return function(e,i){var r=t.copy(i).multiplyScalar(.5);return this.min.copy(e).sub(r),this.max.copy(e).add(r),this}}(),setFromObject:function(t){return this.makeEmpty(),this.expandByObject(t)},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.min.copy(t.min),this.max.copy(t.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},getCenter:function(t){return void 0===t&&(t=new Oe),this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(t){return void 0===t&&(t=new Oe),this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)},expandByPoint:function(t){return this.min.min(t),this.max.max(t),this},expandByVector:function(t){return this.min.sub(t),this.max.add(t),this},expandByScalar:function(t){return this.min.addScalar(-t),this.max.addScalar(t),this},expandByObject:function(){var t,e,i,r=new Oe;function n(n){var o=n.geometry;if(void 0!==o)if(o.isGeometry){var a=o.vertices;for(e=0,i=a.length;e<i;e++)r.copy(a[e]),r.applyMatrix4(n.matrixWorld),t.expandByPoint(r)}else if(o.isBufferGeometry){var s=o.attributes.position;if(void 0!==s)for(e=0,i=s.count;e<i;e++)r.fromBufferAttribute(s,e).applyMatrix4(n.matrixWorld),t.expandByPoint(r)}}return function(e){return t=this,e.updateMatrixWorld(!0),e.traverse(n),this}}(),containsPoint:function(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y||t.z<this.min.z||t.z>this.max.z)},containsBox:function(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y&&this.min.z<=t.min.z&&t.max.z<=this.max.z},getParameter:function(t,e){return void 0===e&&(e=new Oe),e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y),(t.z-this.min.z)/(this.max.z-this.min.z))},intersectsBox:function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y||t.max.z<this.min.z||t.min.z>this.max.z)},intersectsSphere:(Ie=new Oe,function(t){return this.clampPoint(t.center,Ie),Ie.distanceToSquared(t.center)<=t.radius*t.radius}),intersectsPlane:function(t){var e,i;return t.normal.x>0?(e=t.normal.x*this.min.x,i=t.normal.x*this.max.x):(e=t.normal.x*this.max.x,i=t.normal.x*this.min.x),t.normal.y>0?(e+=t.normal.y*this.min.y,i+=t.normal.y*this.max.y):(e+=t.normal.y*this.max.y,i+=t.normal.y*this.min.y),t.normal.z>0?(e+=t.normal.z*this.min.z,i+=t.normal.z*this.max.z):(e+=t.normal.z*this.max.z,i+=t.normal.z*this.min.z),e<=t.constant&&i>=t.constant},intersectsTriangle:function(){var t=new Oe,e=new Oe,i=new Oe,r=new Oe,n=new Oe,o=new Oe,a=new Oe,s=new Oe,h=new Oe,l=new Oe;function c(r){var n,o;for(n=0,o=r.length-3;n<=o;n+=3){a.fromArray(r,n);var s=h.x*Math.abs(a.x)+h.y*Math.abs(a.y)+h.z*Math.abs(a.z),l=t.dot(a),c=e.dot(a),u=i.dot(a);if(Math.max(-Math.max(l,c,u),Math.min(l,c,u))>s)return!1}return!0}return function(a){if(this.isEmpty())return!1;this.getCenter(s),h.subVectors(this.max,s),t.subVectors(a.a,s),e.subVectors(a.b,s),i.subVectors(a.c,s),r.subVectors(e,t),n.subVectors(i,e),o.subVectors(t,i);var u=[0,-r.z,r.y,0,-n.z,n.y,0,-o.z,o.y,r.z,0,-r.x,n.z,0,-n.x,o.z,0,-o.x,-r.y,r.x,0,-n.y,n.x,0,-o.y,o.x,0];return!!c(u)&&(!!c(u=[1,0,0,0,1,0,0,0,1])&&(l.crossVectors(r,n),c(u=[l.x,l.y,l.z])))}}(),clampPoint:function(t,e){return void 0===e&&(e=new Oe),e.copy(t).clamp(this.min,this.max)},distanceToPoint:function(){var t=new Oe;return function(e){return t.copy(e).clamp(this.min,this.max).sub(e).length()}}(),getBoundingSphere:function(){var t=new Oe;return function(e){return void 0===e&&(e=new Ze),this.getCenter(e.center),e.radius=.5*this.getSize(t).length(),e}}(),intersect:function(t){return this.min.max(t.min),this.max.min(t.max),this.isEmpty()&&this.makeEmpty(),this},union:function(t){return this.min.min(t.min),this.max.max(t.max),this},applyMatrix4:function(t){if(this.isEmpty())return this;var e=t.elements,i=e[0]*this.min.x,r=e[1]*this.min.x,n=e[2]*this.min.x,o=e[0]*this.max.x,a=e[1]*this.max.x,s=e[2]*this.max.x,h=e[4]*this.min.y,l=e[5]*this.min.y,c=e[6]*this.min.y,u=e[4]*this.max.y,p=e[5]*this.max.y,d=e[6]*this.max.y,f=e[8]*this.min.z,m=e[9]*this.min.z,g=e[10]*this.min.z,v=e[8]*this.max.z,y=e[9]*this.max.z,E=e[10]*this.max.z;return this.min.x=Math.min(i,o)+Math.min(h,u)+Math.min(f,v)+e[12],this.min.y=Math.min(r,a)+Math.min(l,p)+Math.min(m,y)+e[13],this.min.z=Math.min(n,s)+Math.min(c,d)+Math.min(g,E)+e[14],this.max.x=Math.max(i,o)+Math.max(h,u)+Math.max(f,v)+e[12],this.max.y=Math.max(r,a)+Math.max(l,p)+Math.max(m,y)+e[13],this.max.z=Math.max(n,s)+Math.max(c,d)+Math.max(g,E)+e[14],this},translate:function(t){return this.min.add(t),this.max.add(t),this},equals:function(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}),Object.assign(Ze.prototype,{set:function(t,e){return this.center.copy(t),this.radius=e,this},setFromPoints:(Be=new Xe,function(t,e){var i=this.center;void 0!==e?i.copy(e):Be.setFromPoints(t).getCenter(i);for(var r=0,n=0,o=t.length;n<o;n++)r=Math.max(r,i.distanceToSquared(t[n]));return this.radius=Math.sqrt(r),this}),clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.center.copy(t.center),this.radius=t.radius,this},empty:function(){return this.radius<=0},containsPoint:function(t){return t.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(t){return t.distanceTo(this.center)-this.radius},intersectsSphere:function(t){var e=this.radius+t.radius;return t.center.distanceToSquared(this.center)<=e*e},intersectsBox:function(t){return t.intersectsSphere(this)},intersectsPlane:function(t){return Math.abs(t.distanceToPoint(this.center))<=this.radius},clampPoint:function(t,e){var i=this.center.distanceToSquared(t);return void 0===e&&(e=new Oe),e.copy(t),i>this.radius*this.radius&&(e.sub(this.center).normalize(),e.multiplyScalar(this.radius).add(this.center)),e},getBoundingBox:function(t){return void 0===t&&(t=new Xe),t.set(this.center,this.center),t.expandByScalar(this.radius),t},applyMatrix4:function(t){return this.center.applyMatrix4(t),this.radius=this.radius*t.getMaxScaleOnAxis(),this},translate:function(t){return this.center.add(t),this},equals:function(t){return t.center.equals(this.center)&&t.radius===this.radius}}),Object.assign(Ye.prototype,{set:function(t,e){return this.normal.copy(t),this.constant=e,this},setComponents:function(t,e,i,r){return this.normal.set(t,e,i),this.constant=r,this},setFromNormalAndCoplanarPoint:function(t,e){return this.normal.copy(t),this.constant=-e.dot(this.normal),this},setFromCoplanarPoints:function(){var t=new Oe,e=new Oe;return function(i,r,n){var o=t.subVectors(n,r).cross(e.subVectors(i,r)).normalize();return this.setFromNormalAndCoplanarPoint(o,i),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.normal.copy(t.normal),this.constant=t.constant,this},normalize:function(){var t=1/this.normal.length();return this.normal.multiplyScalar(t),this.constant*=t,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(t){return this.normal.dot(t)+this.constant},distanceToSphere:function(t){return this.distanceToPoint(t.center)-t.radius},projectPoint:function(t,e){return void 0===e&&(e=new Oe),e.copy(this.normal).multiplyScalar(-this.distanceToPoint(t)).add(t)},intersectLine:function(){var t=new Oe;return function(e,i){void 0===i&&(i=new Oe);var r=e.delta(t),n=this.normal.dot(r);if(0===n)return 0===this.distanceToPoint(e.start)?i.copy(e.start):void 0;var o=-(e.start.dot(this.normal)+this.constant)/n;return o<0||o>1?void 0:i.copy(r).multiplyScalar(o).add(e.start)}}(),intersectsLine:function(t){var e=this.distanceToPoint(t.start),i=this.distanceToPoint(t.end);return e<0&&i>0||i<0&&e>0},intersectsBox:function(t){return t.intersectsPlane(this)},intersectsSphere:function(t){return t.intersectsPlane(this)},coplanarPoint:function(t){return void 0===t&&(t=new Oe),t.copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var t=new Oe,e=new He;return function(i,r){var n=r||e.getNormalMatrix(i),o=this.coplanarPoint(t).applyMatrix4(i),a=this.normal.applyMatrix3(n).normalize();return this.constant=-o.dot(a),this}}(),translate:function(t){return this.constant-=t.dot(this.normal),this},equals:function(t){return t.normal.equals(this.normal)&&t.constant===this.constant}}),Object.assign(qe.prototype,{set:function(t,e,i,r,n,o){var a=this.planes;return a[0].copy(t),a[1].copy(e),a[2].copy(i),a[3].copy(r),a[4].copy(n),a[5].copy(o),this},clone:function(){return(new this.constructor).copy(this)},copy:function(t){for(var e=this.planes,i=0;i<6;i++)e[i].copy(t.planes[i]);return this},setFromMatrix:function(t){var e=this.planes,i=t.elements,r=i[0],n=i[1],o=i[2],a=i[3],s=i[4],h=i[5],l=i[6],c=i[7],u=i[8],p=i[9],d=i[10],f=i[11],m=i[12],g=i[13],v=i[14],y=i[15];return e[0].setComponents(a-r,c-s,f-u,y-m).normalize(),e[1].setComponents(a+r,c+s,f+u,y+m).normalize(),e[2].setComponents(a+n,c+h,f+p,y+g).normalize(),e[3].setComponents(a-n,c-h,f-p,y-g).normalize(),e[4].setComponents(a-o,c-l,f-d,y-v).normalize(),e[5].setComponents(a+o,c+l,f+d,y+v).normalize(),this},intersectsObject:(ke=new Ze,function(t){var e=t.geometry;return null===e.boundingSphere&&e.computeBoundingSphere(),ke.copy(e.boundingSphere).applyMatrix4(t.matrixWorld),this.intersectsSphere(ke)}),intersectsSprite:function(){var t=new Ze;return function(e){return t.center.set(0,0,0),t.radius=.7071067811865476,t.applyMatrix4(e.matrixWorld),this.intersectsSphere(t)}}(),intersectsSphere:function(t){for(var e=this.planes,i=t.center,r=-t.radius,n=0;n<6;n++){if(e[n].distanceToPoint(i)<r)return!1}return!0},intersectsBox:(ze=new Oe,Ne=new Oe,function(t){for(var e=this.planes,i=0;i<6;i++){var r=e[i];ze.x=r.normal.x>0?t.min.x:t.max.x,Ne.x=r.normal.x>0?t.max.x:t.min.x,ze.y=r.normal.y>0?t.min.y:t.max.y,Ne.y=r.normal.y>0?t.max.y:t.min.y,ze.z=r.normal.z>0?t.min.z:t.max.z,Ne.z=r.normal.z>0?t.max.z:t.min.z;var n=r.distanceToPoint(ze),o=r.distanceToPoint(Ne);if(n<0&&o<0)return!1}return!0}),containsPoint:function(t){for(var e=this.planes,i=0;i<6;i++)if(e[i].distanceToPoint(t)<0)return!1;return!0}});var Je,Qe={alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).g;\n#endif\n",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif\n",alphatest_fragment:"#ifdef ALPHATEST\n\tif ( diffuseColor.a < ALPHATEST ) discard;\n#endif\n",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n\t#endif\n#endif\n",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex:"\nvec3 transformed = vec3( position );\n",beginnormal_vertex:"\nvec3 objectNormal = vec3( normal );\n",bsdfs:"float punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\tif( decayExponent > 0.0 ) {\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\t\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\t\tfloat maxDistanceCutoffFactor = pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t\treturn distanceFalloff * maxDistanceCutoffFactor;\n#else\n\t\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n#endif\n\t}\n\treturn 1.0;\n}\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n}\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\treturn 1.0 / ( gl * gv );\n}\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\tfloat D = D_GGX( alpha, dotNH );\n\treturn F * ( G * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE  = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS  = 0.5 / LUT_SIZE;\n\tfloat dotNV = saturate( dot( N, V ) );\n\tvec2 uv = vec2( roughness, sqrt( 1.0 - dotNV ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.8543985 + ( 0.4965155 + 0.0145206 * y ) * y;\n\tfloat b = 3.4175940 + ( 4.1616724 + y ) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = ( x > 0.0 ) ? v : 0.5 * inversesqrt( max( 1.0 - x * x, 1e-7 ) ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transposeMat3( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tfloat result = LTC_ClippedSphereFormFactor( vectorFormFactor );\n\treturn vec3( result );\n}\nvec3 BRDF_Specular_GGX_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n\treturn specularColor * AB.x + AB.y;\n}\nfloat G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n}\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\n}\n",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\n\t\tvec3 vSigmaX = vec3( dFdx( surf_pos.x ), dFdx( surf_pos.y ), dFdx( surf_pos.z ) );\n\t\tvec3 vSigmaY = vec3( dFdy( surf_pos.x ), dFdy( surf_pos.y ), dFdy( surf_pos.z ) );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 );\n\t\tfDet *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif\n",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tvec4 plane;\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; i ++ ) {\n\t\tplane = clippingPlanes[ i ];\n\t\tif ( dot( vViewPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\t#pragma unroll_loop\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; i ++ ) {\n\t\t\tplane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\tif ( clipped ) discard;\n\t#endif\n#endif\n",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\t#if ! defined( PHYSICAL ) && ! defined( PHONG )\n\t\tvarying vec3 vViewPosition;\n\t#endif\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif\n",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\n\tvarying vec3 vViewPosition;\n#endif\n",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n",color_fragment:"#ifdef USE_COLOR\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif\n",color_pars_vertex:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif",color_vertex:"#ifdef USE_COLOR\n\tvColor.xyz = color.xyz;\n#endif",common:"#define PI 3.14159265359\n#define PI2 6.28318530718\n#define PI_HALF 1.5707963267949\n#define RECIPROCAL_PI 0.31830988618\n#define RECIPROCAL_PI2 0.15915494\n#define LOG2 1.442695\n#define EPSILON 1e-6\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract(sin(sn) * c);\n}\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n};\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\tfloat distance = dot( planeNormal, point - pointOnPlane );\n\treturn - distance * planeNormal + point;\n}\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn sign( dot( point - pointOnPlane, planeNormal ) );\n}\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n}\nmat3 transposeMat3( const in mat3 m ) {\n\tmat3 tmp;\n\ttmp[ 0 ] = vec3( m[ 0 ].x, m[ 1 ].x, m[ 2 ].x );\n\ttmp[ 1 ] = vec3( m[ 0 ].y, m[ 1 ].y, m[ 2 ].y );\n\ttmp[ 2 ] = vec3( m[ 0 ].z, m[ 1 ].z, m[ 2 ].z );\n\treturn tmp;\n}\nfloat linearToRelativeLuminance( const in vec3 color ) {\n\tvec3 weights = vec3( 0.2126, 0.7152, 0.0722 );\n\treturn dot( weights, color.rgb );\n}\n",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n#define cubeUV_textureSize (1024.0)\nint getFaceFromDirection(vec3 direction) {\n\tvec3 absDirection = abs(direction);\n\tint face = -1;\n\tif( absDirection.x > absDirection.z ) {\n\t\tif(absDirection.x > absDirection.y )\n\t\t\tface = direction.x > 0.0 ? 0 : 3;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\telse {\n\t\tif(absDirection.z > absDirection.y )\n\t\t\tface = direction.z > 0.0 ? 2 : 5;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\treturn face;\n}\n#define cubeUV_maxLods1  (log2(cubeUV_textureSize*0.25) - 1.0)\n#define cubeUV_rangeClamp (exp2((6.0 - 1.0) * 2.0))\nvec2 MipLevelInfo( vec3 vec, float roughnessLevel, float roughness ) {\n\tfloat scale = exp2(cubeUV_maxLods1 - roughnessLevel);\n\tfloat dxRoughness = dFdx(roughness);\n\tfloat dyRoughness = dFdy(roughness);\n\tvec3 dx = dFdx( vec * scale * dxRoughness );\n\tvec3 dy = dFdy( vec * scale * dyRoughness );\n\tfloat d = max( dot( dx, dx ), dot( dy, dy ) );\n\td = clamp(d, 1.0, cubeUV_rangeClamp);\n\tfloat mipLevel = 0.5 * log2(d);\n\treturn vec2(floor(mipLevel), fract(mipLevel));\n}\n#define cubeUV_maxLods2 (log2(cubeUV_textureSize*0.25) - 2.0)\n#define cubeUV_rcpTextureSize (1.0 / cubeUV_textureSize)\nvec2 getCubeUV(vec3 direction, float roughnessLevel, float mipLevel) {\n\tmipLevel = roughnessLevel > cubeUV_maxLods2 - 3.0 ? 0.0 : mipLevel;\n\tfloat a = 16.0 * cubeUV_rcpTextureSize;\n\tvec2 exp2_packed = exp2( vec2( roughnessLevel, mipLevel ) );\n\tvec2 rcp_exp2_packed = vec2( 1.0 ) / exp2_packed;\n\tfloat powScale = exp2_packed.x * exp2_packed.y;\n\tfloat scale = rcp_exp2_packed.x * rcp_exp2_packed.y * 0.25;\n\tfloat mipOffset = 0.75*(1.0 - rcp_exp2_packed.y) * rcp_exp2_packed.x;\n\tbool bRes = mipLevel == 0.0;\n\tscale =  bRes && (scale < a) ? a : scale;\n\tvec3 r;\n\tvec2 offset;\n\tint face = getFaceFromDirection(direction);\n\tfloat rcpPowScale = 1.0 / powScale;\n\tif( face == 0) {\n\t\tr = vec3(direction.x, -direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 1) {\n\t\tr = vec3(direction.y, direction.x, direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 2) {\n\t\tr = vec3(direction.z, direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 3) {\n\t\tr = vec3(direction.x, direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse if( face == 4) {\n\t\tr = vec3(direction.y, direction.x, -direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse {\n\t\tr = vec3(direction.z, -direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\tr = normalize(r);\n\tfloat texelOffset = 0.5 * cubeUV_rcpTextureSize;\n\tvec2 s = ( r.yz / abs( r.x ) + vec2( 1.0 ) ) * 0.5;\n\tvec2 base = offset + vec2( texelOffset );\n\treturn base + s * ( scale - 2.0 * texelOffset );\n}\n#define cubeUV_maxLods3 (log2(cubeUV_textureSize*0.25) - 3.0)\nvec4 textureCubeUV(vec3 reflectedDirection, float roughness ) {\n\tfloat roughnessVal = roughness* cubeUV_maxLods3;\n\tfloat r1 = floor(roughnessVal);\n\tfloat r2 = r1 + 1.0;\n\tfloat t = fract(roughnessVal);\n\tvec2 mipInfo = MipLevelInfo(reflectedDirection, r1, roughness);\n\tfloat s = mipInfo.y;\n\tfloat level0 = mipInfo.x;\n\tfloat level1 = level0 + 1.0;\n\tlevel1 = level1 > 5.0 ? 5.0 : level1;\n\tlevel0 += min( floor( s + 0.5 ), 5.0 );\n\tvec2 uv_10 = getCubeUV(reflectedDirection, r1, level0);\n\tvec4 color10 = envMapTexelToLinear(texture2D(envMap, uv_10));\n\tvec2 uv_20 = getCubeUV(reflectedDirection, r2, level0);\n\tvec4 color20 = envMapTexelToLinear(texture2D(envMap, uv_20));\n\tvec4 result = mix(color10, color20, t);\n\treturn vec4(result.rgb, 1.0);\n}\n#endif\n",defaultnormal_vertex:"vec3 transformedNormal = normalMatrix * objectNormal;\n#ifdef FLIP_SIDED\n\ttransformedNormal = - transformedNormal;\n#endif\n",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif\n",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normalize( objectNormal ) * ( texture2D( displacementMap, uv ).x * displacementScale + displacementBias );\n#endif\n",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif\n",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif\n",encodings_fragment:"  gl_FragColor = linearToOutputTexel( gl_FragColor );\n",encodings_pars_fragment:"\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );\n}\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );\n}\nvec4 sRGBToLinear( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.w );\n}\nvec4 RGBEToLinear( in vec4 value ) {\n\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\nvec4 LinearToRGBE( in vec4 value ) {\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n}\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.xyz * value.w * maxRange, 1.0 );\n}\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\n\tfloat M      = clamp( maxRGB / maxRange, 0.0, 1.0 );\n\tM            = ceil( M * 255.0 ) / 255.0;\n\treturn vec4( value.rgb / ( M * maxRange ), M );\n}\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\n}\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\n\tfloat D      = max( maxRange / maxRGB, 1.0 );\n\tD            = min( floor( D ) / 255.0, 1.0 );\n\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\n}\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\nvec4 LinearToLogLuv( in vec4 value )  {\n\tvec3 Xp_Y_XYZp = value.rgb * cLogLuvM;\n\tXp_Y_XYZp = max(Xp_Y_XYZp, vec3(1e-6, 1e-6, 1e-6));\n\tvec4 vResult;\n\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\n\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\n\tvResult.w = fract(Le);\n\tvResult.z = (Le - (floor(vResult.w*255.0))/255.0)/255.0;\n\treturn vResult;\n}\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\nvec4 LogLuvToLinear( in vec4 value ) {\n\tfloat Le = value.z * 255.0 + value.w;\n\tvec3 Xp_Y_XYZp;\n\tXp_Y_XYZp.y = exp2((Le - 127.0) / 2.0);\n\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\n\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\n\tvec3 vRGB = Xp_Y_XYZp.rgb * cLogLuvInverseM;\n\treturn vec4( max(vRGB, 0.0), 1.0 );\n}\n",envmap_fragment:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\tvec2 sampleUV;\n\t\treflectVec = normalize( reflectVec );\n\t\tsampleUV.y = asin( clamp( reflectVec.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\t\tsampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\tvec4 envColor = texture2D( envMap, sampleUV );\n\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\treflectVec = normalize( reflectVec );\n\t\tvec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0, 0.0, 1.0 ) );\n\t\tvec4 envColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5 );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\tenvColor = envMapTexelToLinear( envColor );\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif\n",envmap_pars_fragment:"#if defined( USE_ENVMAP ) || defined( PHYSICAL )\n\tuniform float reflectivity;\n\tuniform float envMapIntensity;\n#endif\n#ifdef USE_ENVMAP\n\t#if ! defined( PHYSICAL ) && ( defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) )\n\t\tvarying vec3 vWorldPosition;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\tuniform float flipEnvMap;\n\tuniform int maxMipLevel;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( PHYSICAL )\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif\n",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif\n",envmap_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif\n",fog_vertex:"\n#ifdef USE_FOG\nfogDepth = -mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n  varying float fogDepth;\n#endif\n",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif\n",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float fogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif\n",gradientmap_pars_fragment:"#ifdef TOON\n\tuniform sampler2D gradientMap;\n\tvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\t\tfloat dotNL = dot( normal, lightDirection );\n\t\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t\t#ifdef USE_GRADIENTMAP\n\t\t\treturn texture2D( gradientMap, coord ).rgb;\n\t\t#else\n\t\t\treturn ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );\n\t\t#endif\n\t}\n#endif\n",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\treflectedLight.indirectDiffuse += PI * texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n#endif\n",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_vertex:"vec3 diffuse = vec3( 1.0 );\nGeometricContext geometry;\ngeometry.position = mvPosition.xyz;\ngeometry.normal = normalize( transformedNormal );\ngeometry.viewDir = normalize( -mvPosition.xyz );\nGeometricContext backGeometry;\nbackGeometry.position = geometry.position;\nbackGeometry.normal = -geometry.normal;\nbackGeometry.viewDir = geometry.viewDir;\nvLightFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\n\tvLightBack = vec3( 0.0 );\n#endif\nIncidentLight directLight;\nfloat dotNL;\nvec3 directLightColor_Diffuse;\n#if NUM_POINT_LIGHTS > 0\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tgetPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tgetSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_DIR_LIGHTS > 0\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tgetDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\tvLightFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\n\t\t#endif\n\t}\n#endif\n",lights_pars_begin:"uniform vec3 ambientLightColor;\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treturn irradiance;\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tdirectLight.color = directionalLight.color;\n\t\tdirectLight.direction = directionalLight.direction;\n\t\tdirectLight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t\tfloat shadowCameraNear;\n\t\tfloat shadowCameraFar;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tdirectLight.color = pointLight.color;\n\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight  ) {\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\t\tif ( angleCos > spotLight.coneCos ) {\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\t\tdirectLight.color = spotLight.color;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\t\t} else {\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltc_1;\tuniform sampler2D ltc_2;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {\n\t\tfloat dotNL = dot( geometry.normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tirradiance *= PI;\n\t\t#endif\n\t\treturn irradiance;\n\t}\n#endif\n",lights_pars_maps:"#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\tvec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {\n\t\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\tvec4 envMapColor = textureCubeUV( queryVec, 1.0 );\n\t\t#else\n\t\t\tvec4 envMapColor = vec4( 0.0 );\n\t\t#endif\n\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t}\n\tfloat getSpecularMIPLevel( const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\tfloat maxMIPLevelScalar = float( maxMIPLevel );\n\t\tfloat desiredMIPLevel = maxMIPLevelScalar + 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\n\t\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\t}\n\tvec3 getLightProbeIndirectRadiance( const in GeometricContext geometry, const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( -geometry.viewDir, geometry.normal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( -geometry.viewDir, geometry.normal, refractionRatio );\n\t\t#endif\n\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\tfloat specularMIPLevel = getSpecularMIPLevel( blinnShininessExponent, maxMIPLevel );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\tvec4 envMapColor = textureCubeUV(queryReflectVec, BlinnExponentToGGXRoughness(blinnShininessExponent));\n\t\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\t\tvec2 sampleUV;\n\t\t\tsampleUV.y = asin( clamp( reflectVec.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\t\t\tsampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, sampleUV, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, sampleUV, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\t\tvec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0,0.0,1.0 ) );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#endif\n\t\treturn envMapColor.rgb * envMapIntensity;\n\t}\n#endif\n",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;\n",lights_phong_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct BlinnPhongMaterial {\n\tvec3\tdiffuseColor;\n\tvec3\tspecularColor;\n\tfloat\tspecularShininess;\n\tfloat\tspecularStrength;\n};\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\t#ifdef TOON\n\t\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\t#else\n\t\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\t\tvec3 irradiance = dotNL * directLight.color;\n\t#endif\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong\n#define Material_LightProbeLOD( material )\t(0)\n",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nmaterial.specularRoughness = clamp( roughnessFactor, 0.04, 1.0 );\n#ifdef STANDARD\n\tmaterial.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.clearCoat = saturate( clearCoat );\tmaterial.clearCoatRoughness = clamp( clearCoatRoughness, 0.04, 1.0 );\n#endif\n",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3\tdiffuseColor;\n\tfloat\tspecularRoughness;\n\tvec3\tspecularColor;\n\t#ifndef STANDARD\n\t\tfloat clearCoat;\n\t\tfloat clearCoatRoughness;\n\t#endif\n};\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\nfloat clearCoatDHRApprox( const in float roughness, const in float dotNL ) {\n\treturn DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.specularRoughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos - halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos + halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos + halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos - halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tvec4 t1 = texture2D( ltc_1, uv );\n\t\tvec4 t2 = texture2D( ltc_2, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3( t1.x, 0, t1.y ),\n\t\t\tvec3(    0, 1,    0 ),\n\t\t\tvec3( t1.z, 0, t1.w )\n\t\t);\n\t\tvec3 fresnel = ( material.specularColor * t2.x + ( vec3( 1.0 ) - material.specularColor ) * t2.y );\n\t\treflectedLight.directSpecular += lightColor * fresnel * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1.0 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\t#ifndef STANDARD\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\treflectedLight.directSpecular += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry, material.specularColor, material.specularRoughness );\n\treflectedLight.directDiffuse += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\t#ifndef STANDARD\n\t\treflectedLight.directSpecular += irradiance * material.clearCoat * BRDF_Specular_GGX( directLight, geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 clearCoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t#ifndef STANDARD\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\tfloat dotNL = dotNV;\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\treflectedLight.indirectSpecular += ( 1.0 - clearCoatDHR ) * radiance * BRDF_Specular_GGX_Environment( geometry, material.specularColor, material.specularRoughness );\n\t#ifndef STANDARD\n\t\treflectedLight.indirectSpecular += clearCoatRadiance * material.clearCoat * BRDF_Specular_GGX_Environment( geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\n#define Material_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.specularRoughness )\n#define Material_ClearCoat_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.clearCoatRoughness )\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}\n",lights_fragment_begin:"\nGeometricContext geometry;\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = normalize( vViewPosition );\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( pointLight.shadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( spotLight.shadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( directionalLight.shadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\t#pragma unroll_loop\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t}\n\t#endif\n#endif\n#if defined( RE_IndirectSpecular )\n\tvec3 radiance = vec3( 0.0 );\n\tvec3 clearCoatRadiance = vec3( 0.0 );\n#endif\n",lights_fragment_maps:"#if defined( RE_IndirectDiffuse )\n\t#ifdef USE_LIGHTMAP\n\t\tvec3 lightMapIrradiance = texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tlightMapIrradiance *= PI;\n\t\t#endif\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tirradiance += getLightProbeIndirectIrradiance( geometry, maxMipLevel );\n\t#endif\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\tradiance += getLightProbeIndirectRadiance( geometry, Material_BlinnShininessExponent( material ), maxMipLevel );\n\t#ifndef STANDARD\n\t\tclearCoatRadiance += getLightProbeIndirectRadiance( geometry, Material_ClearCoat_BlinnShininessExponent( material ), maxMipLevel );\n\t#endif\n#endif\n",lights_fragment_end:"#if defined( RE_IndirectDiffuse )\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n#endif\n#if defined( RE_IndirectSpecular )\n\tRE_IndirectSpecular( radiance, clearCoatRadiance, geometry, material, reflectedLight );\n#endif\n",logdepthbuf_fragment:"#if defined( USE_LOGDEPTHBUF ) && defined( USE_LOGDEPTHBUF_EXT )\n\tgl_FragDepthEXT = log2( vFragDepth ) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#ifdef USE_LOGDEPTHBUF\n\tuniform float logDepthBufFC;\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t#endif\n#endif\n",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t#endif\n\tuniform float logDepthBufFC;\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t#else\n\t\tgl_Position.z = log2( max( EPSILON, gl_Position.w + 1.0 ) ) * logDepthBufFC - 1.0;\n\t\tgl_Position.z *= gl_Position.w;\n\t#endif\n#endif\n",map_fragment:"#ifdef USE_MAP\n\tvec4 texelColor = texture2D( map, vUv );\n\ttexelColor = mapTexelToLinear( texelColor );\n\tdiffuseColor *= texelColor;\n#endif\n",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n",map_particle_fragment:"#ifdef USE_MAP\n\tvec2 uv = ( uvTransform * vec3( gl_PointCoord.x, 1.0 - gl_PointCoord.y, 1 ) ).xy;\n\tvec4 mapTexel = texture2D( map, uv );\n\tdiffuseColor *= mapTexelToLinear( mapTexel );\n#endif\n",map_particle_pars_fragment:"#ifdef USE_MAP\n\tuniform mat3 uvTransform;\n\tuniform sampler2D map;\n#endif\n",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif\n",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal += ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];\n\tobjectNormal += ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];\n\tobjectNormal += ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];\n\tobjectNormal += ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];\n#endif\n",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\t#ifndef USE_MORPHNORMALS\n\tuniform float morphTargetInfluences[ 8 ];\n\t#else\n\tuniform float morphTargetInfluences[ 4 ];\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];\n\ttransformed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];\n\ttransformed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];\n\ttransformed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];\n\t#ifndef USE_MORPHNORMALS\n\ttransformed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];\n\ttransformed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];\n\ttransformed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];\n\ttransformed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];\n\t#endif\n#endif\n",normal_fragment_begin:"#ifdef FLAT_SHADED\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal );\n\t#ifdef DOUBLE_SIDED\n\t\tnormal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t#endif\n#endif\n",normal_fragment_maps:"#ifdef USE_NORMALMAP\n\t#ifdef OBJECTSPACE_NORMALMAP\n\t\tnormal = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t\t#ifdef FLIP_SIDED\n\t\t\tnormal = - normal;\n\t\t#endif\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tnormal = normal * ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\t#endif\n\t\tnormal = normalize( normalMatrix * normal );\n\t#else\n\t\tnormal = perturbNormal2Arb( -vViewPosition, normal );\n\t#endif\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n#endif\n",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n\t#ifdef OBJECTSPACE_NORMALMAP\n\t\tuniform mat3 normalMatrix;\n\t#else\n\t\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {\n\t\t\tvec3 q0 = vec3( dFdx( eye_pos.x ), dFdx( eye_pos.y ), dFdx( eye_pos.z ) );\n\t\t\tvec3 q1 = vec3( dFdy( eye_pos.x ), dFdy( eye_pos.y ), dFdy( eye_pos.z ) );\n\t\t\tvec2 st0 = dFdx( vUv.st );\n\t\t\tvec2 st1 = dFdy( vUv.st );\n\t\t\tfloat scale = sign( st1.t * st0.s - st0.t * st1.s );\n\t\t\tvec3 S = normalize( ( q0 * st1.t - q1 * st0.t ) * scale );\n\t\t\tvec3 T = normalize( ( - q0 * st1.s + q1 * st0.s ) * scale );\n\t\t\tvec3 N = normalize( surf_norm );\n\t\t\tmat3 tsn = mat3( S, T, N );\n\t\t\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t\t\tmapN.xy *= normalScale;\n\t\t\tmapN.xy *= ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n\t\t\treturn normalize( tsn * mapN );\n\t\t}\n\t#endif\n#endif\n",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 2.0 * rgb.xyz - 1.0;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n\treturn linearClipZ * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn (( near + viewZ ) * far ) / (( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\n}\n",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif\n",project_vertex:"vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\ngl_Position = projectionMatrix * mvPosition;\n",dithering_fragment:"#if defined( DITHERING )\n  gl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif\n",dithering_pars_fragment:"#if defined( DITHERING )\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif\n",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\troughnessFactor *= texelRoughness.g;\n#endif\n",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tfloat texture2DShadowLerp( sampler2D depths, vec2 size, vec2 uv, float compare ) {\n\t\tconst vec2 offset = vec2( 0.0, 1.0 );\n\t\tvec2 texelSize = vec2( 1.0 ) / size;\n\t\tvec2 centroidUV = floor( uv * size + 0.5 ) / size;\n\t\tfloat lb = texture2DCompare( depths, centroidUV + texelSize * offset.xx, compare );\n\t\tfloat lt = texture2DCompare( depths, centroidUV + texelSize * offset.xy, compare );\n\t\tfloat rb = texture2DCompare( depths, centroidUV + texelSize * offset.yx, compare );\n\t\tfloat rt = texture2DCompare( depths, centroidUV + texelSize * offset.yy, compare );\n\t\tvec2 f = fract( uv * size + 0.5 );\n\t\tfloat a = mix( lb, lt, f.y );\n\t\tfloat b = mix( rb, rt, f.y );\n\t\tfloat c = mix( a, b, f.x );\n\t\treturn c;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tfloat shadow = 1.0;\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\t\tbool frustumTest = all( frustumTestVec );\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tshadow = (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\tshadow = (\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\tshadow = texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn shadow;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord, float shadowCameraNear, float shadowCameraFar ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tfloat dp = ( length( lightToPosition ) - shadowCameraNear ) / ( shadowCameraFar - shadowCameraNear );\t\tdp += shadowBias;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif\n",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n#endif\n",shadowmap_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n#endif\n",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\tDirectionalLight directionalLight;\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tshadow *= bool( directionalLight.shadow ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\tSpotLight spotLight;\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tshadow *= bool( spotLight.shadow ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\tPointLight pointLight;\n\t#pragma unroll_loop\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tshadow *= bool( pointLight.shadow ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ], pointLight.shadowCameraNear, pointLight.shadowCameraFar ) : 1.0;\n\t}\n\t#endif\n\t#endif\n\treturn shadow;\n}\n",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\t#ifdef BONE_TEXTURE\n\t\tuniform sampler2D boneTexture;\n\t\tuniform int boneTextureSize;\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tfloat j = i * 4.0;\n\t\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\t\ty = dy * ( y + 0.5 );\n\t\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\t\treturn bone;\n\t\t}\n\t#else\n\t\tuniform mat4 boneMatrices[ MAX_BONES ];\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tmat4 bone = boneMatrices[ int(i) ];\n\t\t\treturn bone;\n\t\t}\n\t#endif\n#endif\n",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\ttransformed = ( bindMatrixInverse * skinned ).xyz;\n#endif\n",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix  = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n#endif\n",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n  gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif\n",tonemapping_pars_fragment:"#ifndef saturate\n\t#define saturate(a) clamp( a, 0.0, 1.0 )\n#endif\nuniform float toneMappingExposure;\nuniform float toneMappingWhitePoint;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn toneMappingExposure * color;\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\n#define Uncharted2Helper( x ) max( ( ( x * ( 0.15 * x + 0.10 * 0.50 ) + 0.20 * 0.02 ) / ( x * ( 0.15 * x + 0.50 ) + 0.20 * 0.30 ) ) - 0.02 / 0.30, vec3( 0.0 ) )\nvec3 Uncharted2ToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( Uncharted2Helper( color ) / Uncharted2Helper( vec3( toneMappingWhitePoint ) ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\n",uv_pars_fragment:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n#endif",uv_pars_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n\tuniform mat3 uvTransform;\n#endif\n",uv_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvUv = ( uvTransform * vec3( uv, 1 ) ).xy;\n#endif",uv2_pars_fragment:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvarying vec2 vUv2;\n#endif",uv2_pars_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n#endif",uv2_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvUv2 = uv2;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )\n\tvec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );\n#endif\n",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldPosition;\nvoid main() {\n\tgl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );\n\tgl_FragColor.a *= opacity;\n}\n",cube_vert:"varying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvWorldPosition = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\tgl_Position.z = gl_Position.w;\n}\n",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <logdepthbuf_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( 1.0 - gl_FragCoord.z ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( gl_FragCoord.z );\n\t#endif\n}\n",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n}\n",distanceRGBA_frag:"#define DISTANCE\nuniform vec3 referencePosition;\nuniform float nearDistance;\nuniform float farDistance;\nvarying vec3 vWorldPosition;\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\tfloat dist = length( vWorldPosition - referencePosition );\n\tdist = ( dist - nearDistance ) / ( farDistance - nearDistance );\n\tdist = saturate( dist );\n\tgl_FragColor = packDepthToRGBA( dist );\n}\n",distanceRGBA_vert:"#define DISTANCE\nvarying vec3 vWorldPosition;\n#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_DISPLACEMENTMAP\n\t\t#include <beginnormal_vertex>\n\t\t#include <morphnormal_vertex>\n\t\t#include <skinnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition.xyz;\n}\n",equirect_frag:"uniform sampler2D tEquirect;\nvarying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldPosition );\n\tvec2 sampleUV;\n\tsampleUV.y = asin( clamp( direction.y, - 1.0, 1.0 ) ) * RECIPROCAL_PI + 0.5;\n\tsampleUV.x = atan( direction.z, direction.x ) * RECIPROCAL_PI2 + 0.5;\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n}\n",equirect_vert:"varying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvWorldPosition = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}\n",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\tvLineDistance = scale * lineDistance;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}\n",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\treflectedLight.indirectDiffuse += texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_ENVMAP\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}\n",meshlambert_frag:"uniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <emissivemap_fragment>\n\treflectedLight.indirectDiffuse = getAmbientLightIrradiance( ambientLightColor );\n\t#include <lightmap_fragment>\n\treflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\t#else\n\t\treflectedLight.directDiffuse = vLightFront;\n\t#endif\n\treflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshlambert_vert:"#define LAMBERT\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <lights_lambert_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",meshphysical_frag:"#define PHYSICAL\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifndef STANDARD\n\tuniform float clearCoat;\n\tuniform float clearCoatRoughness;\n#endif\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <lights_pars_begin>\n#include <lights_pars_maps>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_fragment_begin>\n\t#include <lights_fragment_maps>\n\t#include <lights_fragment_end>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshphysical_vert:"#define PHYSICAL\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",normal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || ( defined( USE_NORMALMAP ) && ! defined( OBJECTSPACE_NORMALMAP ) )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\t#include <normal_fragment_begin>\n\t#include <normal_fragment_maps>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n}\n",normal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || ( defined( USE_NORMALMAP ) && ! defined( OBJECTSPACE_NORMALMAP ) )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || ( defined( USE_NORMALMAP ) && ! defined( OBJECTSPACE_NORMALMAP ) )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}\n",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",points_vert:"uniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <project_vertex>\n\t#ifdef USE_SIZEATTENUATION\n\t\tgl_PointSize = size * ( scale / - mvPosition.z );\n\t#else\n\t\tgl_PointSize = size;\n\t#endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <fog_vertex>\n}\n",shadow_frag:"uniform vec3 color;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\tgl_FragColor = vec4( color, opacity * ( 1.0 - getShadowMask() ) );\n\t#include <fog_fragment>\n}\n",shadow_vert:"#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n"},Ke={merge:function(t){for(var e={},i=0;i<t.length;i++){var r=this.clone(t[i]);for(var n in r)e[n]=r[n]}return e},clone:function(t){var e={};for(var i in t)for(var r in e[i]={},t[i]){var n=t[i][r];n&&(n.isColor||n.isMatrix3||n.isMatrix4||n.isVector2||n.isVector3||n.isVector4||n.isTexture)?e[i][r]=n.clone():Array.isArray(n)?e[i][r]=n.slice():e[i][r]=n}return e}},$e={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};function ti(t,e,i){return void 0===e&&void 0===i?this.set(t):this.setRGB(t,e,i)}Object.assign(ti.prototype,{isColor:!0,r:1,g:1,b:1,set:function(t){return t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t),this},setScalar:function(t){return this.r=t,this.g=t,this.b=t,this},setHex:function(t){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,this},setRGB:function(t,e,i){return this.r=t,this.g=e,this.b=i,this},setHSL:function(){function t(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+6*(e-t)*(2/3-i):t}return function(e,i,r){if(e=Ce.euclideanModulo(e,1),i=Ce.clamp(i,0,1),r=Ce.clamp(r,0,1),0===i)this.r=this.g=this.b=r;else{var n=r<=.5?r*(1+i):r+i-r*i,o=2*r-n;this.r=t(o,n,e+1/3),this.g=t(o,n,e),this.b=t(o,n,e-1/3)}return this}}(),setStyle:function(t){function e(t){void 0!==t&&parseFloat(t)}var i;if(i=/^((?:rgb|hsl)a?)\(\s*([^\)]*)\)/.exec(t)){var r,n=i[1],o=i[2];switch(n){case"rgb":case"rgba":if(r=/^(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(o))return this.r=Math.min(255,parseInt(r[1],10))/255,this.g=Math.min(255,parseInt(r[2],10))/255,this.b=Math.min(255,parseInt(r[3],10))/255,e(r[5]),this;if(r=/^(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(o))return this.r=Math.min(100,parseInt(r[1],10))/100,this.g=Math.min(100,parseInt(r[2],10))/100,this.b=Math.min(100,parseInt(r[3],10))/100,e(r[5]),this;break;case"hsl":case"hsla":if(r=/^([0-9]*\.?[0-9]+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(o)){var a=parseFloat(r[1])/360,s=parseInt(r[2],10)/100,h=parseInt(r[3],10)/100;return e(r[5]),this.setHSL(a,s,h)}}}else if(i=/^\#([A-Fa-f0-9]+)$/.exec(t)){var l,c=(l=i[1]).length;if(3===c)return this.r=parseInt(l.charAt(0)+l.charAt(0),16)/255,this.g=parseInt(l.charAt(1)+l.charAt(1),16)/255,this.b=parseInt(l.charAt(2)+l.charAt(2),16)/255,this;if(6===c)return this.r=parseInt(l.charAt(0)+l.charAt(1),16)/255,this.g=parseInt(l.charAt(2)+l.charAt(3),16)/255,this.b=parseInt(l.charAt(4)+l.charAt(5),16)/255,this}t&&t.length>0&&(void 0!==(l=$e[t])&&this.setHex(l));return this},clone:function(){return new this.constructor(this.r,this.g,this.b)},copy:function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this},copyGammaToLinear:function(t,e){return void 0===e&&(e=2),this.r=Math.pow(t.r,e),this.g=Math.pow(t.g,e),this.b=Math.pow(t.b,e),this},copyLinearToGamma:function(t,e){void 0===e&&(e=2);var i=e>0?1/e:1;return this.r=Math.pow(t.r,i),this.g=Math.pow(t.g,i),this.b=Math.pow(t.b,i),this},convertGammaToLinear:function(t){return this.copyGammaToLinear(this,t),this},convertLinearToGamma:function(t){return this.copyLinearToGamma(this,t),this},copySRGBToLinear:function(){function t(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}return function(e){return this.r=t(e.r),this.g=t(e.g),this.b=t(e.b),this}}(),copyLinearToSRGB:function(){function t(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}return function(e){return this.r=t(e.r),this.g=t(e.g),this.b=t(e.b),this}}(),convertSRGBToLinear:function(){return this.copySRGBToLinear(this),this},convertLinearToSRGB:function(){return this.copyLinearToSRGB(this),this},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(t){void 0===t&&(t={h:0,s:0,l:0});var e,i,r=this.r,n=this.g,o=this.b,a=Math.max(r,n,o),s=Math.min(r,n,o),h=(s+a)/2;if(s===a)e=0,i=0;else{var l=a-s;switch(i=h<=.5?l/(a+s):l/(2-a-s),a){case r:e=(n-o)/l+(n<o?6:0);break;case n:e=(o-r)/l+2;break;case o:e=(r-n)/l+4}e/=6}return t.h=e,t.s=i,t.l=h,t},getStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},offsetHSL:(Je={},function(t,e,i){return this.getHSL(Je),Je.h+=t,Je.s+=e,Je.l+=i,this.setHSL(Je.h,Je.s,Je.l),this}),add:function(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this},addColors:function(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this},addScalar:function(t){return this.r+=t,this.g+=t,this.b+=t,this},sub:function(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this},multiply:function(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this},multiplyScalar:function(t){return this.r*=t,this.g*=t,this.b*=t,this},lerp:function(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this},equals:function(t){return t.r===this.r&&t.g===this.g&&t.b===this.b},fromArray:function(t,e){return void 0===e&&(e=0),this.r=t[e],this.g=t[e+1],this.b=t[e+2],this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t},toJSON:function(){return this.getHex()}});var ei,ii={common:{diffuse:{value:new ti(15658734)},opacity:{value:1},map:{value:null},uvTransform:{value:new He},alphaMap:{value:null}},specularmap:{specularMap:{value:null}},envmap:{envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98},maxMipLevel:{value:0}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new Pe(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new ti(16777215)}},lights:{ambientLightColor:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{},shadowCameraNear:{},shadowCameraFar:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}}},points:{diffuse:{value:new ti(15658734)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},uvTransform:{value:new He}}},ri={basic:{uniforms:Ke.merge([ii.common,ii.specularmap,ii.envmap,ii.aomap,ii.lightmap,ii.fog]),vertexShader:Qe.meshbasic_vert,fragmentShader:Qe.meshbasic_frag},lambert:{uniforms:Ke.merge([ii.common,ii.specularmap,ii.envmap,ii.aomap,ii.lightmap,ii.emissivemap,ii.fog,ii.lights,{emissive:{value:new ti(0)}}]),vertexShader:Qe.meshlambert_vert,fragmentShader:Qe.meshlambert_frag},phong:{uniforms:Ke.merge([ii.common,ii.specularmap,ii.envmap,ii.aomap,ii.lightmap,ii.emissivemap,ii.bumpmap,ii.normalmap,ii.displacementmap,ii.gradientmap,ii.fog,ii.lights,{emissive:{value:new ti(0)},specular:{value:new ti(1118481)},shininess:{value:30}}]),vertexShader:Qe.meshphong_vert,fragmentShader:Qe.meshphong_frag},standard:{uniforms:Ke.merge([ii.common,ii.envmap,ii.aomap,ii.lightmap,ii.emissivemap,ii.bumpmap,ii.normalmap,ii.displacementmap,ii.roughnessmap,ii.metalnessmap,ii.fog,ii.lights,{emissive:{value:new ti(0)},roughness:{value:.5},metalness:{value:.5},envMapIntensity:{value:1}}]),vertexShader:Qe.meshphysical_vert,fragmentShader:Qe.meshphysical_frag},points:{uniforms:Ke.merge([ii.points,ii.fog]),vertexShader:Qe.points_vert,fragmentShader:Qe.points_frag},dashed:{uniforms:Ke.merge([ii.common,ii.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:Qe.linedashed_vert,fragmentShader:Qe.linedashed_frag},depth:{uniforms:Ke.merge([ii.common,ii.displacementmap]),vertexShader:Qe.depth_vert,fragmentShader:Qe.depth_frag},normal:{uniforms:Ke.merge([ii.common,ii.bumpmap,ii.normalmap,ii.displacementmap,{opacity:{value:1}}]),vertexShader:Qe.normal_vert,fragmentShader:Qe.normal_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:Qe.cube_vert,fragmentShader:Qe.cube_frag},equirect:{uniforms:{tEquirect:{value:null}},vertexShader:Qe.equirect_vert,fragmentShader:Qe.equirect_frag},distanceRGBA:{uniforms:Ke.merge([ii.common,ii.displacementmap,{referencePosition:{value:new Oe},nearDistance:{value:1},farDistance:{value:1e3}}]),vertexShader:Qe.distanceRGBA_vert,fragmentShader:Qe.distanceRGBA_frag},shadow:{uniforms:Ke.merge([ii.lights,ii.fog,{color:{value:new ti(0)},opacity:{value:1}}]),vertexShader:Qe.shadow_vert,fragmentShader:Qe.shadow_frag}};function ni(){var t=null,e=!1,i=null;function r(n,o){!1!==e&&(i(n,o),t.requestAnimationFrame(r))}return{start:function(){!0!==e&&null!==i&&(t.requestAnimationFrame(r),e=!0)},stop:function(){e=!1},setAnimationLoop:function(t){i=t},setContext:function(e){t=e}}}function oi(t){var e=new WeakMap;return{get:function(t){return t.isInterleavedBufferAttribute&&(t=t.data),e.get(t)},remove:function(i){i.isInterleavedBufferAttribute&&(i=i.data);var r=e.get(i);r&&(t.deleteBuffer(r.buffer),e.delete(i))},update:function(i,r){i.isInterleavedBufferAttribute&&(i=i.data);var n=e.get(i);void 0===n?e.set(i,function(e,i){var r=e.array,n=e.dynamic?t.DYNAMIC_DRAW:t.STATIC_DRAW,o=t.createBuffer();t.bindBuffer(i,o),t.bufferData(i,r,n),e.onUploadCallback();var a=t.FLOAT;return r instanceof Float32Array?a=t.FLOAT:r instanceof Float64Array||(r instanceof Uint16Array?a=t.UNSIGNED_SHORT:r instanceof Int16Array?a=t.SHORT:r instanceof Uint32Array?a=t.UNSIGNED_INT:r instanceof Int32Array?a=t.INT:r instanceof Int8Array?a=t.BYTE:r instanceof Uint8Array&&(a=t.UNSIGNED_BYTE)),{buffer:o,type:a,bytesPerElement:r.BYTES_PER_ELEMENT,version:e.version}}(i,r)):n.version<i.version&&(function(e,i,r){var n=i.array,o=i.updateRange;t.bindBuffer(r,e),!1===i.dynamic?t.bufferData(r,n,t.STATIC_DRAW):-1===o.count?t.bufferSubData(r,0,n):0===o.count||(t.bufferSubData(r,o.offset*n.BYTES_PER_ELEMENT,n.subarray(o.offset,o.offset+o.count)),o.count=-1)}(n.buffer,i,r),n.version=i.version)}}}function ai(t,e,i,r){this._x=t||0,this._y=e||0,this._z=i||0,this._order=r||ai.DefaultOrder}function si(){this.mask=1}ri.physical={uniforms:Ke.merge([ri.standard.uniforms,{clearCoat:{value:0},clearCoatRoughness:{value:0}}]),vertexShader:Qe.meshphysical_vert,fragmentShader:Qe.meshphysical_frag},ai.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],ai.DefaultOrder="XYZ",Object.defineProperties(ai.prototype,{x:{get:function(){return this._x},set:function(t){this._x=t,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(t){this._y=t,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(t){this._z=t,this.onChangeCallback()}},order:{get:function(){return this._order},set:function(t){this._order=t,this.onChangeCallback()}}}),Object.assign(ai.prototype,{isEuler:!0,set:function(t,e,i,r){return this._x=t,this._y=e,this._z=i,this._order=r||this._order,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._order)},copy:function(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this.onChangeCallback(),this},setFromRotationMatrix:function(t,e,i){var r=Ce.clamp,n=t.elements,o=n[0],a=n[4],s=n[8],h=n[1],l=n[5],c=n[9],u=n[2],p=n[6],d=n[10];return"XYZ"===(e=e||this._order)?(this._y=Math.asin(r(s,-1,1)),Math.abs(s)<.99999?(this._x=Math.atan2(-c,d),this._z=Math.atan2(-a,o)):(this._x=Math.atan2(p,l),this._z=0)):"YXZ"===e?(this._x=Math.asin(-r(c,-1,1)),Math.abs(c)<.99999?(this._y=Math.atan2(s,d),this._z=Math.atan2(h,l)):(this._y=Math.atan2(-u,o),this._z=0)):"ZXY"===e?(this._x=Math.asin(r(p,-1,1)),Math.abs(p)<.99999?(this._y=Math.atan2(-u,d),this._z=Math.atan2(-a,l)):(this._y=0,this._z=Math.atan2(h,o))):"ZYX"===e?(this._y=Math.asin(-r(u,-1,1)),Math.abs(u)<.99999?(this._x=Math.atan2(p,d),this._z=Math.atan2(h,o)):(this._x=0,this._z=Math.atan2(-a,l))):"YZX"===e?(this._z=Math.asin(r(h,-1,1)),Math.abs(h)<.99999?(this._x=Math.atan2(-c,l),this._y=Math.atan2(-u,o)):(this._x=0,this._y=Math.atan2(s,d))):"XZY"===e&&(this._z=Math.asin(-r(a,-1,1)),Math.abs(a)<.99999?(this._x=Math.atan2(p,l),this._y=Math.atan2(s,o)):(this._x=Math.atan2(-c,d),this._y=0)),this._order=e,!1!==i&&this.onChangeCallback(),this},setFromQuaternion:function(){var t=new De;return function(e,i,r){return t.makeRotationFromQuaternion(e),this.setFromRotationMatrix(t,i,r)}}(),setFromVector3:function(t,e){return this.set(t.x,t.y,t.z,e||this._order)},reorder:(ei=new Le,function(t){return ei.setFromEuler(this),this.setFromQuaternion(ei,t)}),equals:function(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order},fromArray:function(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this.onChangeCallback(),this},toArray:function(t,e){return void 0===t&&(t=[]),void 0===e&&(e=0),t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t},toVector3:function(t){return t?t.set(this._x,this._y,this._z):new Oe(this._x,this._y,this._z)},onChange:function(t){return this.onChangeCallback=t,this},onChangeCallback:function(){}}),Object.assign(si.prototype,{set:function(t){this.mask=1<<t|0},enable:function(t){this.mask|=1<<t|0},toggle:function(t){this.mask^=1<<t|0},disable:function(t){this.mask&=~(1<<t|0)},test:function(t){return 0!=(this.mask&t.mask)}});var hi,li,ci,ui,pi=0;function di(){Object.defineProperty(this,"id",{value:pi++}),this.uuid=Ce.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=di.DefaultUp.clone();var t=new Oe,e=new ai,i=new Le,r=new Oe(1,1,1);e.onChange(function(){i.setFromEuler(e,!1)}),i.onChange(function(){e.setFromQuaternion(i,void 0,!1)}),Object.defineProperties(this,{position:{enumerable:!0,value:t},rotation:{enumerable:!0,value:e},quaternion:{enumerable:!0,value:i},scale:{enumerable:!0,value:r},modelViewMatrix:{value:new De},normalMatrix:{value:new He}}),this.matrix=new De,this.matrixWorld=new De,this.matrixAutoUpdate=di.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new si,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.userData={}}function fi(){di.call(this),this.type="Camera",this.matrixWorldInverse=new De,this.projectionMatrix=new De}function mi(t,e,i,r,n,o){fi.call(this),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=t,this.right=e,this.top=i,this.bottom=r,this.near=void 0!==n?n:.1,this.far=void 0!==o?o:2e3,this.updateProjectionMatrix()}function gi(t,e,i,r,n,o){this.a=t,this.b=e,this.c=i,this.normal=r&&r.isVector3?r:new Oe,this.vertexNormals=Array.isArray(r)?r:[],this.color=n&&n.isColor?n:new ti,this.vertexColors=Array.isArray(n)?n:[],this.materialIndex=void 0!==o?o:0}di.DefaultUp=new Oe(0,1,0),di.DefaultMatrixAutoUpdate=!0,di.prototype=Object.assign(Object.create(e.prototype),{constructor:di,isObject3D:!0,onBeforeRender:function(){},onAfterRender:function(){},applyMatrix:function(t){this.matrix.multiplyMatrices(t,this.matrix),this.matrix.decompose(this.position,this.quaternion,this.scale)},applyQuaternion:function(t){return this.quaternion.premultiply(t),this},setRotationFromAxisAngle:function(t,e){this.quaternion.setFromAxisAngle(t,e)},setRotationFromEuler:function(t){this.quaternion.setFromEuler(t,!0)},setRotationFromMatrix:function(t){this.quaternion.setFromRotationMatrix(t)},setRotationFromQuaternion:function(t){this.quaternion.copy(t)},rotateOnAxis:(ui=new Le,function(t,e){return ui.setFromAxisAngle(t,e),this.quaternion.multiply(ui),this}),rotateOnWorldAxis:function(){var t=new Le;return function(e,i){return t.setFromAxisAngle(e,i),this.quaternion.premultiply(t),this}}(),rotateX:function(){var t=new Oe(1,0,0);return function(e){return this.rotateOnAxis(t,e)}}(),rotateY:function(){var t=new Oe(0,1,0);return function(e){return this.rotateOnAxis(t,e)}}(),rotateZ:function(){var t=new Oe(0,0,1);return function(e){return this.rotateOnAxis(t,e)}}(),translateOnAxis:function(){var t=new Oe;return function(e,i){return t.copy(e).applyQuaternion(this.quaternion),this.position.add(t.multiplyScalar(i)),this}}(),translateX:function(){var t=new Oe(1,0,0);return function(e){return this.translateOnAxis(t,e)}}(),translateY:function(){var t=new Oe(0,1,0);return function(e){return this.translateOnAxis(t,e)}}(),translateZ:function(){var t=new Oe(0,0,1);return function(e){return this.translateOnAxis(t,e)}}(),localToWorld:function(t){return t.applyMatrix4(this.matrixWorld)},worldToLocal:(ci=new De,function(t){return t.applyMatrix4(ci.getInverse(this.matrixWorld))}),lookAt:function(){var t=new De,e=new Oe;return function(i,r,n){i.isVector3?e.copy(i):e.set(i,r,n),this.isCamera?t.lookAt(this.position,e,this.up):t.lookAt(e,this.position,this.up),this.quaternion.setFromRotationMatrix(t)}}(),add:function(t){if(arguments.length>1){for(var e=0;e<arguments.length;e++)this.add(arguments[e]);return this}return t===this?this:(t&&t.isObject3D&&(null!==t.parent&&t.parent.remove(t),t.parent=this,t.dispatchEvent({type:"added"}),this.children.push(t)),this)},remove:function(t){if(arguments.length>1){for(var e=0;e<arguments.length;e++)this.remove(arguments[e]);return this}var i=this.children.indexOf(t);return-1!==i&&(t.parent=null,t.dispatchEvent({type:"removed"}),this.children.splice(i,1)),this},getObjectById:function(t){return this.getObjectByProperty("id",t)},getObjectByName:function(t){return this.getObjectByProperty("name",t)},getObjectByProperty:function(t,e){if(this[t]===e)return this;for(var i=0,r=this.children.length;i<r;i++){var n=this.children[i].getObjectByProperty(t,e);if(void 0!==n)return n}},getWorldPosition:function(t){return void 0===t&&(t=new Oe),this.updateMatrixWorld(!0),t.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:(hi=new Oe,li=new Oe,function(t){return void 0===t&&(t=new Le),this.updateMatrixWorld(!0),this.matrixWorld.decompose(hi,t,li),t}),getWorldScale:function(){var t=new Oe,e=new Le;return function(i){return void 0===i&&(i=new Oe),this.updateMatrixWorld(!0),this.matrixWorld.decompose(t,e,i),i}}(),getWorldDirection:function(){var t=new Le;return function(e){return void 0===e&&(e=new Oe),this.getWorldQuaternion(t),e.set(0,0,1).applyQuaternion(t)}}(),raycast:function(){},traverse:function(t){t(this);for(var e=this.children,i=0,r=e.length;i<r;i++)e[i].traverse(t)},traverseVisible:function(t){if(!1!==this.visible){t(this);for(var e=this.children,i=0,r=e.length;i<r;i++)e[i].traverseVisible(t)}},traverseAncestors:function(t){var e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);for(var e=this.children,i=0,r=e.length;i<r;i++)e[i].updateMatrixWorld(t)},toJSON:function(t){var e=void 0===t||"string"==typeof t,i={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{}},i.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var r={};function n(e,i){return void 0===e[i.uuid]&&(e[i.uuid]=i.toJSON(t)),i.uuid}if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),!0===this.castShadow&&(r.castShadow=!0),!0===this.receiveShadow&&(r.receiveShadow=!0),!1===this.visible&&(r.visible=!1),!1===this.frustumCulled&&(r.frustumCulled=!1),0!==this.renderOrder&&(r.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(r.userData=this.userData),r.layers=this.layers.mask,r.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(r.matrixAutoUpdate=!1),void 0!==this.geometry){r.geometry=n(t.geometries,this.geometry);var o=this.geometry.parameters;if(void 0!==o&&void 0!==o.shapes){var a=o.shapes;if(Array.isArray(a))for(var s=0,h=a.length;s<h;s++){var l=a[s];n(t.shapes,l)}else n(t.shapes,a)}}if(void 0!==this.material)if(Array.isArray(this.material)){var c=[];for(s=0,h=this.material.length;s<h;s++)c.push(n(t.materials,this.material[s]));r.material=c}else r.material=n(t.materials,this.material);if(this.children.length>0){r.children=[];for(s=0;s<this.children.length;s++)r.children.push(this.children[s].toJSON(t).object)}if(e){var u=m(t.geometries),p=m(t.materials),d=m(t.textures),f=m(t.images);a=m(t.shapes);u.length>0&&(i.geometries=u),p.length>0&&(i.materials=p),d.length>0&&(i.textures=d),f.length>0&&(i.images=f),a.length>0&&(i.shapes=a)}return i.object=r,i;function m(t){var e=[];for(var i in t){var r=t[i];delete r.metadata,e.push(r)}return e}},clone:function(t){return(new this.constructor).copy(this,t)},copy:function(t,e){if(void 0===e&&(e=!0),this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(var i=0;i<t.children.length;i++){var r=t.children[i];this.add(r.clone())}return this}}),fi.prototype=Object.assign(Object.create(di.prototype),{constructor:fi,isCamera:!0,copy:function(t,e){return di.prototype.copy.call(this,t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this},getWorldDirection:function(){var t=new Le;return function(e){return void 0===e&&(e=new Oe),this.getWorldQuaternion(t),e.set(0,0,-1).applyQuaternion(t)}}(),updateMatrixWorld:function(t){di.prototype.updateMatrixWorld.call(this,t),this.matrixWorldInverse.getInverse(this.matrixWorld)},clone:function(){return(new this.constructor).copy(this)}}),mi.prototype=Object.assign(Object.create(fi.prototype),{constructor:mi,isOrthographicCamera:!0,copy:function(t,e){return fi.prototype.copy.call(this,t,e),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.near=t.near,this.far=t.far,this.zoom=t.zoom,this.view=null===t.view?null:Object.assign({},t.view),this},setViewOffset:function(t,e,i,r,n,o){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=r,this.view.width=n,this.view.height=o,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){var t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,r=(this.top+this.bottom)/2,n=i-t,o=i+t,a=r+e,s=r-e;if(null!==this.view&&this.view.enabled){var h=this.zoom/(this.view.width/this.view.fullWidth),l=this.zoom/(this.view.height/this.view.fullHeight),c=(this.right-this.left)/this.view.width,u=(this.top-this.bottom)/this.view.height;o=(n+=c*(this.view.offsetX/h))+c*(this.view.width/h),s=(a-=u*(this.view.offsetY/l))-u*(this.view.height/l)}this.projectionMatrix.makeOrthographic(n,o,a,s,this.near,this.far)},toJSON:function(t){var e=di.prototype.toJSON.call(this,t);return e.object.zoom=this.zoom,e.object.left=this.left,e.object.right=this.right,e.object.top=this.top,e.object.bottom=this.bottom,e.object.near=this.near,e.object.far=this.far,null!==this.view&&(e.object.view=Object.assign({},this.view)),e}}),Object.assign(gi.prototype,{clone:function(){return(new this.constructor).copy(this)},copy:function(t){this.a=t.a,this.b=t.b,this.c=t.c,this.normal.copy(t.normal),this.color.copy(t.color),this.materialIndex=t.materialIndex;for(var e=0,i=t.vertexNormals.length;e<i;e++)this.vertexNormals[e]=t.vertexNormals[e].clone();for(e=0,i=t.vertexColors.length;e<i;e++)this.vertexColors[e]=t.vertexColors[e].clone();return this}});var vi,yi,Ei=0;function xi(){Object.defineProperty(this,"id",{value:Ei+=2}),this.uuid=Ce.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}function _i(t,e,i){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.name="",this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=!0===i,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.version=0}function wi(t,e,i){_i.call(this,new Int8Array(t),e,i)}function bi(t,e,i){_i.call(this,new Uint8Array(t),e,i)}function Si(t,e,i){_i.call(this,new Uint8ClampedArray(t),e,i)}function Ti(t,e,i){_i.call(this,new Int16Array(t),e,i)}function Mi(t,e,i){_i.call(this,new Uint16Array(t),e,i)}function Ri(t,e,i){_i.call(this,new Int32Array(t),e,i)}function Ai(t,e,i){_i.call(this,new Uint32Array(t),e,i)}function Ci(t,e,i){_i.call(this,new Float32Array(t),e,i)}function Pi(t,e,i){_i.call(this,new Float64Array(t),e,i)}function Di(){this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}function Li(t){if(0===t.length)return-1/0;for(var e=t[0],i=1,r=t.length;i<r;++i)t[i]>e&&(e=t[i]);return e}xi.prototype=Object.assign(Object.create(e.prototype),{constructor:xi,isGeometry:!0,applyMatrix:function(t){for(var e=(new He).getNormalMatrix(t),i=0,r=this.vertices.length;i<r;i++){this.vertices[i].applyMatrix4(t)}for(i=0,r=this.faces.length;i<r;i++){var n=this.faces[i];n.normal.applyMatrix3(e).normalize();for(var o=0,a=n.vertexNormals.length;o<a;o++)n.vertexNormals[o].applyMatrix3(e).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this},rotateX:function(){var t=new De;return function(e){return t.makeRotationX(e),this.applyMatrix(t),this}}(),rotateY:function(){var t=new De;return function(e){return t.makeRotationY(e),this.applyMatrix(t),this}}(),rotateZ:function(){var t=new De;return function(e){return t.makeRotationZ(e),this.applyMatrix(t),this}}(),translate:function(){var t=new De;return function(e,i,r){return t.makeTranslation(e,i,r),this.applyMatrix(t),this}}(),scale:function(){var t=new De;return function(e,i,r){return t.makeScale(e,i,r),this.applyMatrix(t),this}}(),lookAt:(yi=new di,function(t){yi.lookAt(t),yi.updateMatrix(),this.applyMatrix(yi.matrix)}),fromBufferGeometry:function(t){var e=this,i=null!==t.index?t.index.array:void 0,r=t.attributes,n=r.position.array,o=void 0!==r.normal?r.normal.array:void 0,a=void 0!==r.color?r.color.array:void 0,s=void 0!==r.uv?r.uv.array:void 0,h=void 0!==r.uv2?r.uv2.array:void 0;void 0!==h&&(this.faceVertexUvs[1]=[]);for(var l=[],c=[],u=[],p=0,d=0;p<n.length;p+=3,d+=2)e.vertices.push(new Oe(n[p],n[p+1],n[p+2])),void 0!==o&&l.push(new Oe(o[p],o[p+1],o[p+2])),void 0!==a&&e.colors.push(new ti(a[p],a[p+1],a[p+2])),void 0!==s&&c.push(new Pe(s[d],s[d+1])),void 0!==h&&u.push(new Pe(h[d],h[d+1]));function f(t,i,r,n){var p=new gi(t,i,r,void 0!==o?[l[t].clone(),l[i].clone(),l[r].clone()]:[],void 0!==a?[e.colors[t].clone(),e.colors[i].clone(),e.colors[r].clone()]:[],n);e.faces.push(p),void 0!==s&&e.faceVertexUvs[0].push([c[t].clone(),c[i].clone(),c[r].clone()]),void 0!==h&&e.faceVertexUvs[1].push([u[t].clone(),u[i].clone(),u[r].clone()])}var m=t.groups;if(m.length>0)for(p=0;p<m.length;p++)for(var g=m[p],v=g.start,y=(d=v,v+g.count);d<y;d+=3)void 0!==i?f(i[d],i[d+1],i[d+2],g.materialIndex):f(d,d+1,d+2,g.materialIndex);else if(void 0!==i)for(p=0;p<i.length;p+=3)f(i[p],i[p+1],i[p+2]);else for(p=0;p<n.length/3;p+=3)f(p,p+1,p+2);return this.computeFaceNormals(),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),this},center:(vi=new Oe,function(){return this.computeBoundingBox(),this.boundingBox.getCenter(vi).negate(),this.translate(vi.x,vi.y,vi.z),this}),normalize:function(){this.computeBoundingSphere();var t=this.boundingSphere.center,e=this.boundingSphere.radius,i=0===e?1:1/e,r=new De;return r.set(i,0,0,-i*t.x,0,i,0,-i*t.y,0,0,i,-i*t.z,0,0,0,1),this.applyMatrix(r),this},computeFaceNormals:function(){for(var t=new Oe,e=new Oe,i=0,r=this.faces.length;i<r;i++){var n=this.faces[i],o=this.vertices[n.a],a=this.vertices[n.b],s=this.vertices[n.c];t.subVectors(s,a),e.subVectors(o,a),t.cross(e),t.normalize(),n.normal.copy(t)}},computeVertexNormals:function(t){var e,i,r,n,o,a;for(void 0===t&&(t=!0),a=new Array(this.vertices.length),e=0,i=this.vertices.length;e<i;e++)a[e]=new Oe;if(t){var s,h,l,c=new Oe,u=new Oe;for(r=0,n=this.faces.length;r<n;r++)o=this.faces[r],s=this.vertices[o.a],h=this.vertices[o.b],l=this.vertices[o.c],c.subVectors(l,h),u.subVectors(s,h),c.cross(u),a[o.a].add(c),a[o.b].add(c),a[o.c].add(c)}else for(this.computeFaceNormals(),r=0,n=this.faces.length;r<n;r++)a[(o=this.faces[r]).a].add(o.normal),a[o.b].add(o.normal),a[o.c].add(o.normal);for(e=0,i=this.vertices.length;e<i;e++)a[e].normalize();for(r=0,n=this.faces.length;r<n;r++){var p=(o=this.faces[r]).vertexNormals;3===p.length?(p[0].copy(a[o.a]),p[1].copy(a[o.b]),p[2].copy(a[o.c])):(p[0]=a[o.a].clone(),p[1]=a[o.b].clone(),p[2]=a[o.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeFlatVertexNormals:function(){var t,e,i;for(this.computeFaceNormals(),t=0,e=this.faces.length;t<e;t++){var r=(i=this.faces[t]).vertexNormals;3===r.length?(r[0].copy(i.normal),r[1].copy(i.normal),r[2].copy(i.normal)):(r[0]=i.normal.clone(),r[1]=i.normal.clone(),r[2]=i.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeMorphNormals:function(){var t,e,i,r,n;for(i=0,r=this.faces.length;i<r;i++)for((n=this.faces[i]).__originalFaceNormal?n.__originalFaceNormal.copy(n.normal):n.__originalFaceNormal=n.normal.clone(),n.__originalVertexNormals||(n.__originalVertexNormals=[]),t=0,e=n.vertexNormals.length;t<e;t++)n.__originalVertexNormals[t]?n.__originalVertexNormals[t].copy(n.vertexNormals[t]):n.__originalVertexNormals[t]=n.vertexNormals[t].clone();var o=new xi;for(o.faces=this.faces,t=0,e=this.morphTargets.length;t<e;t++){if(!this.morphNormals[t]){this.morphNormals[t]={},this.morphNormals[t].faceNormals=[],this.morphNormals[t].vertexNormals=[];var a=this.morphNormals[t].faceNormals,s=this.morphNormals[t].vertexNormals;for(i=0,r=this.faces.length;i<r;i++)h=new Oe,l={a:new Oe,b:new Oe,c:new Oe},a.push(h),s.push(l)}var h,l,c=this.morphNormals[t];for(o.vertices=this.morphTargets[t].vertices,o.computeFaceNormals(),o.computeVertexNormals(),i=0,r=this.faces.length;i<r;i++)n=this.faces[i],h=c.faceNormals[i],l=c.vertexNormals[i],h.copy(n.normal),l.a.copy(n.vertexNormals[0]),l.b.copy(n.vertexNormals[1]),l.c.copy(n.vertexNormals[2])}for(i=0,r=this.faces.length;i<r;i++)(n=this.faces[i]).normal=n.__originalFaceNormal,n.vertexNormals=n.__originalVertexNormals},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new Xe),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new Ze),this.boundingSphere.setFromPoints(this.vertices)},merge:function(t,e,i){if(t&&t.isGeometry){var r,n=this.vertices.length,o=this.vertices,a=t.vertices,s=this.faces,h=t.faces,l=this.faceVertexUvs[0],c=t.faceVertexUvs[0],u=this.colors,p=t.colors;void 0===i&&(i=0),void 0!==e&&(r=(new He).getNormalMatrix(e));for(var d=0,f=a.length;d<f;d++){var m=a[d].clone();void 0!==e&&m.applyMatrix4(e),o.push(m)}for(d=0,f=p.length;d<f;d++)u.push(p[d].clone());for(d=0,f=h.length;d<f;d++){var g,v,y,E=h[d],x=E.vertexNormals,_=E.vertexColors;(g=new gi(E.a+n,E.b+n,E.c+n)).normal.copy(E.normal),void 0!==r&&g.normal.applyMatrix3(r).normalize();for(var w=0,b=x.length;w<b;w++)v=x[w].clone(),void 0!==r&&v.applyMatrix3(r).normalize(),g.vertexNormals.push(v);g.color.copy(E.color);for(w=0,b=_.length;w<b;w++)y=_[w],g.vertexColors.push(y.clone());g.materialIndex=E.materialIndex+i,s.push(g)}for(d=0,f=c.length;d<f;d++){var S=c[d],T=[];if(void 0!==S){for(w=0,b=S.length;w<b;w++)T.push(S[w].clone());l.push(T)}}}},mergeMesh:function(t){t&&t.isMesh&&(t.matrixAutoUpdate&&t.updateMatrix(),this.merge(t.geometry,t.matrix))},mergeVertices:function(){var t,e,i,r,n,o,a,s,h={},l=[],c=[],u=Math.pow(10,4);for(i=0,r=this.vertices.length;i<r;i++)t=this.vertices[i],void 0===h[e=Math.round(t.x*u)+"_"+Math.round(t.y*u)+"_"+Math.round(t.z*u)]?(h[e]=i,l.push(this.vertices[i]),c[i]=l.length-1):c[i]=c[h[e]];var p=[];for(i=0,r=this.faces.length;i<r;i++){(n=this.faces[i]).a=c[n.a],n.b=c[n.b],n.c=c[n.c],o=[n.a,n.b,n.c];for(var d=0;d<3;d++)if(o[d]===o[(d+1)%3]){p.push(i);break}}for(i=p.length-1;i>=0;i--){var f=p[i];for(this.faces.splice(f,1),a=0,s=this.faceVertexUvs.length;a<s;a++)this.faceVertexUvs[a].splice(f,1)}var m=this.vertices.length-l.length;return this.vertices=l,m},setFromPoints:function(t){this.vertices=[];for(var e=0,i=t.length;e<i;e++){var r=t[e];this.vertices.push(new Oe(r.x,r.y,r.z||0))}return this},sortFacesByMaterialIndex:function(){for(var t=this.faces,e=t.length,i=0;i<e;i++)t[i]._id=i;t.sort(function(t,e){return t.materialIndex-e.materialIndex});var r,n,o=this.faceVertexUvs[0],a=this.faceVertexUvs[1];o&&o.length===e&&(r=[]),a&&a.length===e&&(n=[]);for(i=0;i<e;i++){var s=t[i]._id;r&&r.push(o[s]),n&&n.push(a[s])}r&&(this.faceVertexUvs[0]=r),n&&(this.faceVertexUvs[1]=n)},toJSON:function(){var t={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),void 0!==this.parameters){var e=this.parameters;for(var i in e)void 0!==e[i]&&(t[i]=e[i]);return t}for(var r=[],n=0;n<this.vertices.length;n++){var o=this.vertices[n];r.push(o.x,o.y,o.z)}var a=[],s=[],h={},l=[],c={},u=[],p={};for(n=0;n<this.faces.length;n++){var d=this.faces[n],f=void 0!==this.faceVertexUvs[0][n],m=d.normal.length()>0,g=d.vertexNormals.length>0,v=1!==d.color.r||1!==d.color.g||1!==d.color.b,y=d.vertexColors.length>0,E=0;if(E=b(E=b(E=b(E=b(E=b(E=b(E=b(E=b(E,0,0),1,!0),2,!1),3,f),4,m),5,g),6,v),7,y),a.push(E),a.push(d.a,d.b,d.c),a.push(d.materialIndex),f){var x=this.faceVertexUvs[0][n];a.push(M(x[0]),M(x[1]),M(x[2]))}if(m&&a.push(S(d.normal)),g){var _=d.vertexNormals;a.push(S(_[0]),S(_[1]),S(_[2]))}if(v&&a.push(T(d.color)),y){var w=d.vertexColors;a.push(T(w[0]),T(w[1]),T(w[2]))}}function b(t,e,i){return i?t|1<<e:t&~(1<<e)}function S(t){var e=t.x.toString()+t.y.toString()+t.z.toString();return void 0!==h[e]?h[e]:(h[e]=s.length/3,s.push(t.x,t.y,t.z),h[e])}function T(t){var e=t.r.toString()+t.g.toString()+t.b.toString();return void 0!==c[e]?c[e]:(c[e]=l.length,l.push(t.getHex()),c[e])}function M(t){var e=t.x.toString()+t.y.toString();return void 0!==p[e]?p[e]:(p[e]=u.length/2,u.push(t.x,t.y),p[e])}return t.data={},t.data.vertices=r,t.data.normals=s,l.length>0&&(t.data.colors=l),u.length>0&&(t.data.uvs=[u]),t.data.faces=a,t},clone:function(){return(new xi).copy(this)},copy:function(t){var e,i,r,n,o,a;this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=t.name;var s=t.vertices;for(e=0,i=s.length;e<i;e++)this.vertices.push(s[e].clone());var h=t.colors;for(e=0,i=h.length;e<i;e++)this.colors.push(h[e].clone());var l=t.faces;for(e=0,i=l.length;e<i;e++)this.faces.push(l[e].clone());for(e=0,i=t.faceVertexUvs.length;e<i;e++){var c=t.faceVertexUvs[e];for(void 0===this.faceVertexUvs[e]&&(this.faceVertexUvs[e]=[]),r=0,n=c.length;r<n;r++){var u=c[r],p=[];for(o=0,a=u.length;o<a;o++){var d=u[o];p.push(d.clone())}this.faceVertexUvs[e].push(p)}}var f=t.morphTargets;for(e=0,i=f.length;e<i;e++){var m={};if(m.name=f[e].name,void 0!==f[e].vertices)for(m.vertices=[],r=0,n=f[e].vertices.length;r<n;r++)m.vertices.push(f[e].vertices[r].clone());if(void 0!==f[e].normals)for(m.normals=[],r=0,n=f[e].normals.length;r<n;r++)m.normals.push(f[e].normals[r].clone());this.morphTargets.push(m)}var g=t.morphNormals;for(e=0,i=g.length;e<i;e++){var v={};if(void 0!==g[e].vertexNormals)for(v.vertexNormals=[],r=0,n=g[e].vertexNormals.length;r<n;r++){var y=g[e].vertexNormals[r],E={};E.a=y.a.clone(),E.b=y.b.clone(),E.c=y.c.clone(),v.vertexNormals.push(E)}if(void 0!==g[e].faceNormals)for(v.faceNormals=[],r=0,n=g[e].faceNormals.length;r<n;r++)v.faceNormals.push(g[e].faceNormals[r].clone());this.morphNormals.push(v)}var x=t.skinWeights;for(e=0,i=x.length;e<i;e++)this.skinWeights.push(x[e].clone());var _=t.skinIndices;for(e=0,i=_.length;e<i;e++)this.skinIndices.push(_[e].clone());var w=t.lineDistances;for(e=0,i=w.length;e<i;e++)this.lineDistances.push(w[e]);var b=t.boundingBox;null!==b&&(this.boundingBox=b.clone());var S=t.boundingSphere;return null!==S&&(this.boundingSphere=S.clone()),this.elementsNeedUpdate=t.elementsNeedUpdate,this.verticesNeedUpdate=t.verticesNeedUpdate,this.uvsNeedUpdate=t.uvsNeedUpdate,this.normalsNeedUpdate=t.normalsNeedUpdate,this.colorsNeedUpdate=t.colorsNeedUpdate,this.lineDistancesNeedUpdate=t.lineDistancesNeedUpdate,this.groupsNeedUpdate=t.groupsNeedUpdate,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Object.defineProperty(_i.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}}),Object.assign(_i.prototype,{isBufferAttribute:!0,onUploadCallback:function(){},setArray:function(t){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");return this.count=void 0!==t?t.length/this.itemSize:0,this.array=t,this},setDynamic:function(t){return this.dynamic=t,this},copy:function(t){return this.name=t.name,this.array=new t.array.constructor(t.array),this.itemSize=t.itemSize,this.count=t.count,this.normalized=t.normalized,this.dynamic=t.dynamic,this},copyAt:function(t,e,i){t*=this.itemSize,i*=e.itemSize;for(var r=0,n=this.itemSize;r<n;r++)this.array[t+r]=e.array[i+r];return this},copyArray:function(t){return this.array.set(t),this},copyColorsArray:function(t){for(var e=this.array,i=0,r=0,n=t.length;r<n;r++){var o=t[r];void 0===o&&(o=new ti),e[i++]=o.r,e[i++]=o.g,e[i++]=o.b}return this},copyVector2sArray:function(t){for(var e=this.array,i=0,r=0,n=t.length;r<n;r++){var o=t[r];void 0===o&&(o=new Pe),e[i++]=o.x,e[i++]=o.y}return this},copyVector3sArray:function(t){for(var e=this.array,i=0,r=0,n=t.length;r<n;r++){var o=t[r];void 0===o&&(o=new Oe),e[i++]=o.x,e[i++]=o.y,e[i++]=o.z}return this},copyVector4sArray:function(t){for(var e=this.array,i=0,r=0,n=t.length;r<n;r++){var o=t[r];void 0===o&&(o=new Fe),e[i++]=o.x,e[i++]=o.y,e[i++]=o.z,e[i++]=o.w}return this},set:function(t,e){return void 0===e&&(e=0),this.array.set(t,e),this},getX:function(t){return this.array[t*this.itemSize]},setX:function(t,e){return this.array[t*this.itemSize]=e,this},getY:function(t){return this.array[t*this.itemSize+1]},setY:function(t,e){return this.array[t*this.itemSize+1]=e,this},getZ:function(t){return this.array[t*this.itemSize+2]},setZ:function(t,e){return this.array[t*this.itemSize+2]=e,this},getW:function(t){return this.array[t*this.itemSize+3]},setW:function(t,e){return this.array[t*this.itemSize+3]=e,this},setXY:function(t,e,i){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this},setXYZ:function(t,e,i,r){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=r,this},setXYZW:function(t,e,i,r,n){return t*=this.itemSize,this.array[t+0]=e,this.array[t+1]=i,this.array[t+2]=r,this.array[t+3]=n,this},onUpload:function(t){return this.onUploadCallback=t,this},clone:function(){return new this.constructor(this.array,this.itemSize).copy(this)}}),wi.prototype=Object.create(_i.prototype),wi.prototype.constructor=wi,bi.prototype=Object.create(_i.prototype),bi.prototype.constructor=bi,Si.prototype=Object.create(_i.prototype),Si.prototype.constructor=Si,Ti.prototype=Object.create(_i.prototype),Ti.prototype.constructor=Ti,Mi.prototype=Object.create(_i.prototype),Mi.prototype.constructor=Mi,Ri.prototype=Object.create(_i.prototype),Ri.prototype.constructor=Ri,Ai.prototype=Object.create(_i.prototype),Ai.prototype.constructor=Ai,Ci.prototype=Object.create(_i.prototype),Ci.prototype.constructor=Ci,Pi.prototype=Object.create(_i.prototype),Pi.prototype.constructor=Pi,Object.assign(Di.prototype,{computeGroups:function(t){for(var e,i=[],r=void 0,n=t.faces,o=0;o<n.length;o++){var a=n[o];a.materialIndex!==r&&(r=a.materialIndex,void 0!==e&&(e.count=3*o-e.start,i.push(e)),e={start:3*o,materialIndex:r})}void 0!==e&&(e.count=3*o-e.start,i.push(e)),this.groups=i},fromGeometry:function(t){var e,i=t.faces,r=t.vertices,n=t.faceVertexUvs,o=n[0]&&n[0].length>0,a=n[1]&&n[1].length>0,s=t.morphTargets,h=s.length;if(h>0){e=[];for(var l=0;l<h;l++)e[l]=[];this.morphTargets.position=e}var c,u=t.morphNormals,p=u.length;if(p>0){c=[];for(l=0;l<p;l++)c[l]=[];this.morphTargets.normal=c}var d=t.skinIndices,f=t.skinWeights,m=d.length===r.length,g=f.length===r.length;r.length>0&&i.length;for(l=0;l<i.length;l++){var v=i[l];this.vertices.push(r[v.a],r[v.b],r[v.c]);var y=v.vertexNormals;if(3===y.length)this.normals.push(y[0],y[1],y[2]);else{var E=v.normal;this.normals.push(E,E,E)}var x,_=v.vertexColors;if(3===_.length)this.colors.push(_[0],_[1],_[2]);else{var w=v.color;this.colors.push(w,w,w)}if(!0===o)void 0!==(x=n[0][l])?this.uvs.push(x[0],x[1],x[2]):this.uvs.push(new Pe,new Pe,new Pe);if(!0===a)void 0!==(x=n[1][l])?this.uvs2.push(x[0],x[1],x[2]):this.uvs2.push(new Pe,new Pe,new Pe);for(var b=0;b<h;b++){var S=s[b].vertices;e[b].push(S[v.a],S[v.b],S[v.c])}for(b=0;b<p;b++){var T=u[b].vertexNormals[l];c[b].push(T.a,T.b,T.c)}m&&this.skinIndices.push(d[v.a],d[v.b],d[v.c]),g&&this.skinWeights.push(f[v.a],f[v.b],f[v.c])}return this.computeGroups(t),this.verticesNeedUpdate=t.verticesNeedUpdate,this.normalsNeedUpdate=t.normalsNeedUpdate,this.colorsNeedUpdate=t.colorsNeedUpdate,this.uvsNeedUpdate=t.uvsNeedUpdate,this.groupsNeedUpdate=t.groupsNeedUpdate,this}});var Oi=1;function Hi(){Object.defineProperty(this,"id",{value:Oi+=2}),this.uuid=Ce.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}}function Ii(t,e,i,r,n,o){xi.call(this),this.type="BoxGeometry",this.parameters={width:t,height:e,depth:i,widthSegments:r,heightSegments:n,depthSegments:o},this.fromBufferGeometry(new Bi(t,e,i,r,n,o)),this.mergeVertices()}function Bi(t,e,i,r,n,o){Hi.call(this),this.type="BoxBufferGeometry",this.parameters={width:t,height:e,depth:i,widthSegments:r,heightSegments:n,depthSegments:o};var a=this;t=t||1,e=e||1,i=i||1,r=Math.floor(r)||1,n=Math.floor(n)||1;var s=[],h=[],l=[],c=[],u=0,p=0;function d(t,e,i,r,n,o,d,f,m,g,v){var y,E,x=o/m,_=d/g,w=o/2,b=d/2,S=f/2,T=m+1,M=g+1,R=0,A=0,C=new Oe;for(E=0;E<M;E++){var P=E*_-b;for(y=0;y<T;y++){var D=y*x-w;C[t]=D*r,C[e]=P*n,C[i]=S,h.push(C.x,C.y,C.z),C[t]=0,C[e]=0,C[i]=f>0?1:-1,l.push(C.x,C.y,C.z),c.push(y/m),c.push(1-E/g),R+=1}}for(E=0;E<g;E++)for(y=0;y<m;y++){var L=u+y+T*E,O=u+y+T*(E+1),H=u+(y+1)+T*(E+1),I=u+(y+1)+T*E;s.push(L,O,I),s.push(O,H,I),A+=6}a.addGroup(p,A,v),p+=A,u+=R}d("z","y","x",-1,-1,i,e,t,o=Math.floor(o)||1,n,0),d("z","y","x",1,-1,i,e,-t,o,n,1),d("x","z","y",1,1,t,i,e,r,o,2),d("x","z","y",1,-1,t,i,-e,r,o,3),d("x","y","z",1,-1,t,e,i,r,n,4),d("x","y","z",-1,-1,t,e,-i,r,n,5),this.setIndex(s),this.addAttribute("position",new Ci(h,3)),this.addAttribute("normal",new Ci(l,3)),this.addAttribute("uv",new Ci(c,2))}function zi(t,e,i,r){xi.call(this),this.type="PlaneGeometry",this.parameters={width:t,height:e,widthSegments:i,heightSegments:r},this.fromBufferGeometry(new Ni(t,e,i,r)),this.mergeVertices()}function Ni(t,e,i,r){Hi.call(this),this.type="PlaneBufferGeometry",this.parameters={width:t,height:e,widthSegments:i,heightSegments:r};var n,o,a=(t=t||1)/2,s=(e=e||1)/2,h=Math.floor(i)||1,l=Math.floor(r)||1,c=h+1,u=l+1,p=t/h,d=e/l,f=[],m=[],g=[],v=[];for(o=0;o<u;o++){var y=o*d-s;for(n=0;n<c;n++){var E=n*p-a;m.push(E,-y,0),g.push(0,0,1),v.push(n/h),v.push(1-o/l)}}for(o=0;o<l;o++)for(n=0;n<h;n++){var x=n+c*o,_=n+c*(o+1),w=n+1+c*(o+1),b=n+1+c*o;f.push(x,_,b),f.push(_,w,b)}this.setIndex(f),this.addAttribute("position",new Ci(m,3)),this.addAttribute("normal",new Ci(g,3)),this.addAttribute("uv",new Ci(v,2))}Hi.prototype=Object.assign(Object.create(e.prototype),{constructor:Hi,isBufferGeometry:!0,getIndex:function(){return this.index},setIndex:function(t){Array.isArray(t)?this.index=new(Li(t)>65535?Ai:Mi)(t,1):this.index=t},addAttribute:function(t,e){return e&&e.isBufferAttribute||e&&e.isInterleavedBufferAttribute?"index"===t?(this.setIndex(e),this):(this.attributes[t]=e,this):this.addAttribute(t,new _i(arguments[1],arguments[2]))},getAttribute:function(t){return this.attributes[t]},removeAttribute:function(t){return delete this.attributes[t],this},addGroup:function(t,e,i){this.groups.push({start:t,count:e,materialIndex:void 0!==i?i:0})},clearGroups:function(){this.groups=[]},setDrawRange:function(t,e){this.drawRange.start=t,this.drawRange.count=e},applyMatrix:function(t){var e=this.attributes.position;void 0!==e&&(t.applyToBufferAttribute(e),e.needsUpdate=!0);var i=this.attributes.normal;void 0!==i&&((new He).getNormalMatrix(t).applyToBufferAttribute(i),i.needsUpdate=!0);return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},rotateX:function(){var t=new De;return function(e){return t.makeRotationX(e),this.applyMatrix(t),this}}(),rotateY:function(){var t=new De;return function(e){return t.makeRotationY(e),this.applyMatrix(t),this}}(),rotateZ:function(){var t=new De;return function(e){return t.makeRotationZ(e),this.applyMatrix(t),this}}(),translate:function(){var t=new De;return function(e,i,r){return t.makeTranslation(e,i,r),this.applyMatrix(t),this}}(),scale:function(){var t=new De;return function(e,i,r){return t.makeScale(e,i,r),this.applyMatrix(t),this}}(),lookAt:function(){var t=new di;return function(e){t.lookAt(e),t.updateMatrix(),this.applyMatrix(t.matrix)}}(),center:function(){var t=new Oe;return function(){return this.computeBoundingBox(),this.boundingBox.getCenter(t).negate(),this.translate(t.x,t.y,t.z),this}}(),setFromObject:function(t){var e=t.geometry;if(t.isPoints||t.isLine){var i=new Ci(3*e.vertices.length,3),r=new Ci(3*e.colors.length,3);if(this.addAttribute("position",i.copyVector3sArray(e.vertices)),this.addAttribute("color",r.copyColorsArray(e.colors)),e.lineDistances&&e.lineDistances.length===e.vertices.length){var n=new Ci(e.lineDistances.length,1);this.addAttribute("lineDistance",n.copyArray(e.lineDistances))}null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone())}else t.isMesh&&e&&e.isGeometry&&this.fromGeometry(e);return this},setFromPoints:function(t){for(var e=[],i=0,r=t.length;i<r;i++){var n=t[i];e.push(n.x,n.y,n.z||0)}return this.addAttribute("position",new Ci(e,3)),this},updateFromObject:function(t){var e,i=t.geometry;if(t.isMesh){var r=i.__directGeometry;if(!0===i.elementsNeedUpdate&&(r=void 0,i.elementsNeedUpdate=!1),void 0===r)return this.fromGeometry(i);r.verticesNeedUpdate=i.verticesNeedUpdate,r.normalsNeedUpdate=i.normalsNeedUpdate,r.colorsNeedUpdate=i.colorsNeedUpdate,r.uvsNeedUpdate=i.uvsNeedUpdate,r.groupsNeedUpdate=i.groupsNeedUpdate,i.verticesNeedUpdate=!1,i.normalsNeedUpdate=!1,i.colorsNeedUpdate=!1,i.uvsNeedUpdate=!1,i.groupsNeedUpdate=!1,i=r}return!0===i.verticesNeedUpdate&&(void 0!==(e=this.attributes.position)&&(e.copyVector3sArray(i.vertices),e.needsUpdate=!0),i.verticesNeedUpdate=!1),!0===i.normalsNeedUpdate&&(void 0!==(e=this.attributes.normal)&&(e.copyVector3sArray(i.normals),e.needsUpdate=!0),i.normalsNeedUpdate=!1),!0===i.colorsNeedUpdate&&(void 0!==(e=this.attributes.color)&&(e.copyColorsArray(i.colors),e.needsUpdate=!0),i.colorsNeedUpdate=!1),i.uvsNeedUpdate&&(void 0!==(e=this.attributes.uv)&&(e.copyVector2sArray(i.uvs),e.needsUpdate=!0),i.uvsNeedUpdate=!1),i.lineDistancesNeedUpdate&&(void 0!==(e=this.attributes.lineDistance)&&(e.copyArray(i.lineDistances),e.needsUpdate=!0),i.lineDistancesNeedUpdate=!1),i.groupsNeedUpdate&&(i.computeGroups(t.geometry),this.groups=i.groups,i.groupsNeedUpdate=!1),this},fromGeometry:function(t){return t.__directGeometry=(new Di).fromGeometry(t),this.fromDirectGeometry(t.__directGeometry)},fromDirectGeometry:function(t){var e=new Float32Array(3*t.vertices.length);if(this.addAttribute("position",new _i(e,3).copyVector3sArray(t.vertices)),t.normals.length>0){var i=new Float32Array(3*t.normals.length);this.addAttribute("normal",new _i(i,3).copyVector3sArray(t.normals))}if(t.colors.length>0){var r=new Float32Array(3*t.colors.length);this.addAttribute("color",new _i(r,3).copyColorsArray(t.colors))}if(t.uvs.length>0){var n=new Float32Array(2*t.uvs.length);this.addAttribute("uv",new _i(n,2).copyVector2sArray(t.uvs))}if(t.uvs2.length>0){var o=new Float32Array(2*t.uvs2.length);this.addAttribute("uv2",new _i(o,2).copyVector2sArray(t.uvs2))}for(var a in this.groups=t.groups,t.morphTargets){for(var s=[],h=t.morphTargets[a],l=0,c=h.length;l<c;l++){var u=h[l],p=new Ci(3*u.length,3);s.push(p.copyVector3sArray(u))}this.morphAttributes[a]=s}if(t.skinIndices.length>0){var d=new Ci(4*t.skinIndices.length,4);this.addAttribute("skinIndex",d.copyVector4sArray(t.skinIndices))}if(t.skinWeights.length>0){var f=new Ci(4*t.skinWeights.length,4);this.addAttribute("skinWeight",f.copyVector4sArray(t.skinWeights))}return null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone()),this},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new Xe);var t=this.attributes.position;void 0!==t?this.boundingBox.setFromBufferAttribute(t):this.boundingBox.makeEmpty(),isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z)},computeBoundingSphere:function(){var t=new Xe,e=new Oe;return function(){null===this.boundingSphere&&(this.boundingSphere=new Ze);var i=this.attributes.position;if(i){var r=this.boundingSphere.center;t.setFromBufferAttribute(i),t.getCenter(r);for(var n=0,o=0,a=i.count;o<a;o++)e.x=i.getX(o),e.y=i.getY(o),e.z=i.getZ(o),n=Math.max(n,r.distanceToSquared(e));this.boundingSphere.radius=Math.sqrt(n),isNaN(this.boundingSphere.radius)}}}(),computeFaceNormals:function(){},computeVertexNormals:function(){var t=this.index,e=this.attributes,i=this.groups;if(e.position){var r=e.position.array;if(void 0===e.normal)this.addAttribute("normal",new _i(new Float32Array(r.length),3));else for(var n=e.normal.array,o=0,a=n.length;o<a;o++)n[o]=0;var s,h,l,c=e.normal.array,u=new Oe,p=new Oe,d=new Oe,f=new Oe,m=new Oe;if(t){var g=t.array;0===i.length&&this.addGroup(0,g.length);for(var v=0,y=i.length;v<y;++v){var E=i[v],x=E.start;for(o=x,a=x+E.count;o<a;o+=3)s=3*g[o+0],h=3*g[o+1],l=3*g[o+2],u.fromArray(r,s),p.fromArray(r,h),d.fromArray(r,l),f.subVectors(d,p),m.subVectors(u,p),f.cross(m),c[s]+=f.x,c[s+1]+=f.y,c[s+2]+=f.z,c[h]+=f.x,c[h+1]+=f.y,c[h+2]+=f.z,c[l]+=f.x,c[l+1]+=f.y,c[l+2]+=f.z}}else for(o=0,a=r.length;o<a;o+=9)u.fromArray(r,o),p.fromArray(r,o+3),d.fromArray(r,o+6),f.subVectors(d,p),m.subVectors(u,p),f.cross(m),c[o]=f.x,c[o+1]=f.y,c[o+2]=f.z,c[o+3]=f.x,c[o+4]=f.y,c[o+5]=f.z,c[o+6]=f.x,c[o+7]=f.y,c[o+8]=f.z;this.normalizeNormals(),e.normal.needsUpdate=!0}},merge:function(t,e){if(t&&t.isBufferGeometry){void 0===e&&(e=0);var i=this.attributes;for(var r in i)if(void 0!==t.attributes[r])for(var n=i[r].array,o=t.attributes[r],a=o.array,s=0,h=o.itemSize*e;s<a.length;s++,h++)n[h]=a[s];return this}},normalizeNormals:function(){var t=new Oe;return function(){for(var e=this.attributes.normal,i=0,r=e.count;i<r;i++)t.x=e.getX(i),t.y=e.getY(i),t.z=e.getZ(i),t.normalize(),e.setXYZ(i,t.x,t.y,t.z)}}(),toNonIndexed:function(){if(null===this.index)return this;var t=new Hi,e=this.index.array,i=this.attributes;for(var r in i){for(var n=i[r],o=n.array,a=n.itemSize,s=new o.constructor(e.length*a),h=0,l=0,c=0,u=e.length;c<u;c++){h=e[c]*a;for(var p=0;p<a;p++)s[l++]=o[h++]}t.addAttribute(r,new _i(s,a))}var d=this.groups;for(c=0,u=d.length;c<u;c++){var f=d[c];t.addGroup(f.start,f.count,f.materialIndex)}return t},toJSON:function(){var t={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(t.uuid=this.uuid,t.type=this.type,""!==this.name&&(t.name=this.name),Object.keys(this.userData).length>0&&(t.userData=this.userData),void 0!==this.parameters){var e=this.parameters;for(var i in e)void 0!==e[i]&&(t[i]=e[i]);return t}t.data={attributes:{}};var r=this.index;if(null!==r){var n=Array.prototype.slice.call(r.array);t.data.index={type:r.array.constructor.name,array:n}}var o=this.attributes;for(var i in o){var a=o[i];n=Array.prototype.slice.call(a.array);t.data.attributes[i]={itemSize:a.itemSize,type:a.array.constructor.name,array:n,normalized:a.normalized}}var s=this.groups;s.length>0&&(t.data.groups=JSON.parse(JSON.stringify(s)));var h=this.boundingSphere;return null!==h&&(t.data.boundingSphere={center:h.center.toArray(),radius:h.radius}),t},clone:function(){return(new Hi).copy(this)},copy:function(t){var e,i,r;this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.name=t.name;var n=t.index;null!==n&&this.setIndex(n.clone());var o=t.attributes;for(e in o){var a=o[e];this.addAttribute(e,a.clone())}var s=t.morphAttributes;for(e in s){var h=[],l=s[e];for(i=0,r=l.length;i<r;i++)h.push(l[i].clone());this.morphAttributes[e]=h}var c=t.groups;for(i=0,r=c.length;i<r;i++){var u=c[i];this.addGroup(u.start,u.count,u.materialIndex)}var p=t.boundingBox;null!==p&&(this.boundingBox=p.clone());var d=t.boundingSphere;return null!==d&&(this.boundingSphere=d.clone()),this.drawRange.start=t.drawRange.start,this.drawRange.count=t.drawRange.count,this.userData=t.userData,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Ii.prototype=Object.create(xi.prototype),Ii.prototype.constructor=Ii,Bi.prototype=Object.create(Hi.prototype),Bi.prototype.constructor=Bi,zi.prototype=Object.create(xi.prototype),zi.prototype.constructor=zi,Ni.prototype=Object.create(Hi.prototype),Ni.prototype.constructor=Ni;var ki,ji,Vi,Fi,Ui,Gi,Wi,Xi=0;function Zi(){Object.defineProperty(this,"id",{value:Xi++}),this.uuid=Ce.generateUUID(),this.name="",this.type="Material",this.fog=!0,this.lights=!0,this.blending=T,this.side=y,this.flatShading=!1,this.vertexColors=_,this.opacity=1,this.transparent=!1,this.blendSrc=k,this.blendDst=j,this.blendEquation=P,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=q,this.depthTest=!0,this.depthWrite=!0,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.shadowSide=null,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaTest=0,this.premultipliedAlpha=!1,this.overdraw=0,this.visible=!0,this.userData={},this.needsUpdate=!0}function Yi(t){Zi.call(this),this.type="MeshBasicMaterial",this.color=new ti(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=tt,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.lights=!1,this.setValues(t)}function qi(t){Zi.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,this.uniformsNeedUpdate=!1,void 0!==t&&(t.attributes,this.setValues(t))}function Ji(t,e){this.origin=void 0!==t?t:new Oe,this.direction=void 0!==e?e:new Oe}function Qi(t,e){this.start=void 0!==t?t:new Oe,this.end=void 0!==e?e:new Oe}function Ki(t,e,i){this.a=void 0!==t?t:new Oe,this.b=void 0!==e?e:new Oe,this.c=void 0!==i?i:new Oe}function $i(t,e){di.call(this),this.type="Mesh",this.geometry=void 0!==t?t:new Hi,this.material=void 0!==e?e:new Yi({color:16777215*Math.random()}),this.drawMode=me,this.updateMorphTargets()}function tr(t,e){return Math.abs(e[1])-Math.abs(t[1])}function er(t,e,i,r,n,o,a,s,h,l){t=void 0!==t?t:[],e=void 0!==e?e:ht,Ve.call(this,t,e,i,r,n,o,a,s,h,l),this.flipY=!1}Zi.prototype=Object.assign(Object.create(e.prototype),{constructor:Zi,isMaterial:!0,onBeforeCompile:function(){},setValues:function(t){if(void 0!==t)for(var e in t){var i=t[e];if(void 0!==i)if("shading"!==e){var r=this[e];void 0!==r&&(r&&r.isColor?r.set(i):r&&r.isVector3&&i&&i.isVector3?r.copy(i):this[e]="overdraw"===e?Number(i):i)}else this.flatShading=1===i}},toJSON:function(t){var e=void 0===t||"string"==typeof t;e&&(t={textures:{},images:{}});var i={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};function r(t){var e=[];for(var i in t){var r=t[i];delete r.metadata,e.push(r)}return e}if(i.uuid=this.uuid,i.type=this.type,""!==this.name&&(i.name=this.name),this.color&&this.color.isColor&&(i.color=this.color.getHex()),void 0!==this.roughness&&(i.roughness=this.roughness),void 0!==this.metalness&&(i.metalness=this.metalness),this.emissive&&this.emissive.isColor&&(i.emissive=this.emissive.getHex()),1!==this.emissiveIntensity&&(i.emissiveIntensity=this.emissiveIntensity),this.specular&&this.specular.isColor&&(i.specular=this.specular.getHex()),void 0!==this.shininess&&(i.shininess=this.shininess),void 0!==this.clearCoat&&(i.clearCoat=this.clearCoat),void 0!==this.clearCoatRoughness&&(i.clearCoatRoughness=this.clearCoatRoughness),this.map&&this.map.isTexture&&(i.map=this.map.toJSON(t).uuid),this.alphaMap&&this.alphaMap.isTexture&&(i.alphaMap=this.alphaMap.toJSON(t).uuid),this.lightMap&&this.lightMap.isTexture&&(i.lightMap=this.lightMap.toJSON(t).uuid),this.aoMap&&this.aoMap.isTexture&&(i.aoMap=this.aoMap.toJSON(t).uuid,i.aoMapIntensity=this.aoMapIntensity),this.bumpMap&&this.bumpMap.isTexture&&(i.bumpMap=this.bumpMap.toJSON(t).uuid,i.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(i.normalMap=this.normalMap.toJSON(t).uuid,i.normalMapType=this.normalMapType,i.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(i.displacementMap=this.displacementMap.toJSON(t).uuid,i.displacementScale=this.displacementScale,i.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(i.roughnessMap=this.roughnessMap.toJSON(t).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(i.metalnessMap=this.metalnessMap.toJSON(t).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(i.emissiveMap=this.emissiveMap.toJSON(t).uuid),this.specularMap&&this.specularMap.isTexture&&(i.specularMap=this.specularMap.toJSON(t).uuid),this.envMap&&this.envMap.isTexture&&(i.envMap=this.envMap.toJSON(t).uuid,i.reflectivity=this.reflectivity),this.gradientMap&&this.gradientMap.isTexture&&(i.gradientMap=this.gradientMap.toJSON(t).uuid),void 0!==this.size&&(i.size=this.size),void 0!==this.sizeAttenuation&&(i.sizeAttenuation=this.sizeAttenuation),this.blending!==T&&(i.blending=this.blending),!0===this.flatShading&&(i.flatShading=this.flatShading),this.side!==y&&(i.side=this.side),this.vertexColors!==_&&(i.vertexColors=this.vertexColors),this.opacity<1&&(i.opacity=this.opacity),!0===this.transparent&&(i.transparent=this.transparent),i.depthFunc=this.depthFunc,i.depthTest=this.depthTest,i.depthWrite=this.depthWrite,0!==this.rotation&&(i.rotation=this.rotation),1!==this.linewidth&&(i.linewidth=this.linewidth),void 0!==this.dashSize&&(i.dashSize=this.dashSize),void 0!==this.gapSize&&(i.gapSize=this.gapSize),void 0!==this.scale&&(i.scale=this.scale),!0===this.dithering&&(i.dithering=!0),this.alphaTest>0&&(i.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(i.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(i.wireframe=this.wireframe),this.wireframeLinewidth>1&&(i.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(i.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(i.wireframeLinejoin=this.wireframeLinejoin),!0===this.morphTargets&&(i.morphTargets=!0),!0===this.skinning&&(i.skinning=!0),!1===this.visible&&(i.visible=!1),"{}"!==JSON.stringify(this.userData)&&(i.userData=this.userData),e){var n=r(t.textures),o=r(t.images);n.length>0&&(i.textures=n),o.length>0&&(i.images=o)}return i},clone:function(){return(new this.constructor).copy(this)},copy:function(t){this.name=t.name,this.fog=t.fog,this.lights=t.lights,this.blending=t.blending,this.side=t.side,this.flatShading=t.flatShading,this.vertexColors=t.vertexColors,this.opacity=t.opacity,this.transparent=t.transparent,this.blendSrc=t.blendSrc,this.blendDst=t.blendDst,this.blendEquation=t.blendEquation,this.blendSrcAlpha=t.blendSrcAlpha,this.blendDstAlpha=t.blendDstAlpha,this.blendEquationAlpha=t.blendEquationAlpha,this.depthFunc=t.depthFunc,this.depthTest=t.depthTest,this.depthWrite=t.depthWrite,this.colorWrite=t.colorWrite,this.precision=t.precision,this.polygonOffset=t.polygonOffset,this.polygonOffsetFactor=t.polygonOffsetFactor,this.polygonOffsetUnits=t.polygonOffsetUnits,this.dithering=t.dithering,this.alphaTest=t.alphaTest,this.premultipliedAlpha=t.premultipliedAlpha,this.overdraw=t.overdraw,this.visible=t.visible,this.userData=JSON.parse(JSON.stringify(t.userData)),this.clipShadows=t.clipShadows,this.clipIntersection=t.clipIntersection;var e=t.clippingPlanes,i=null;if(null!==e){var r=e.length;i=new Array(r);for(var n=0;n!==r;++n)i[n]=e[n].clone()}return this.clippingPlanes=i,this.shadowSide=t.shadowSide,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Yi.prototype=Object.create(Zi.prototype),Yi.prototype.constructor=Yi,Yi.prototype.isMeshBasicMaterial=!0,Yi.prototype.copy=function(t){return Zi.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this},qi.prototype=Object.create(Zi.prototype),qi.prototype.constructor=qi,qi.prototype.isShaderMaterial=!0,qi.prototype.copy=function(t){return Zi.prototype.copy.call(this,t),this.fragmentShader=t.fragmentShader,this.vertexShader=t.vertexShader,this.uniforms=Ke.clone(t.uniforms),this.defines=Object.assign({},t.defines),this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.lights=t.lights,this.clipping=t.clipping,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this.extensions=t.extensions,this},qi.prototype.toJSON=function(t){var e=Zi.prototype.toJSON.call(this,t);return e.uniforms=this.uniforms,e.vertexShader=this.vertexShader,e.fragmentShader=this.fragmentShader,e},Object.assign(Ji.prototype,{set:function(t,e){return this.origin.copy(t),this.direction.copy(e),this},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.origin.copy(t.origin),this.direction.copy(t.direction),this},at:function(t,e){return void 0===e&&(e=new Oe),e.copy(this.direction).multiplyScalar(t).add(this.origin)},lookAt:function(t){return this.direction.copy(t).sub(this.origin).normalize(),this},recast:function(){var t=new Oe;return function(e){return this.origin.copy(this.at(e,t)),this}}(),closestPointToPoint:function(t,e){void 0===e&&(e=new Oe),e.subVectors(t,this.origin);var i=e.dot(this.direction);return i<0?e.copy(this.origin):e.copy(this.direction).multiplyScalar(i).add(this.origin)},distanceToPoint:function(t){return Math.sqrt(this.distanceSqToPoint(t))},distanceSqToPoint:function(){var t=new Oe;return function(e){var i=t.subVectors(e,this.origin).dot(this.direction);return i<0?this.origin.distanceToSquared(e):(t.copy(this.direction).multiplyScalar(i).add(this.origin),t.distanceToSquared(e))}}(),distanceSqToSegment:(ji=new Oe,Vi=new Oe,Fi=new Oe,function(t,e,i,r){ji.copy(t).add(e).multiplyScalar(.5),Vi.copy(e).sub(t).normalize(),Fi.copy(this.origin).sub(ji);var n,o,a,s,h=.5*t.distanceTo(e),l=-this.direction.dot(Vi),c=Fi.dot(this.direction),u=-Fi.dot(Vi),p=Fi.lengthSq(),d=Math.abs(1-l*l);if(d>0)if(o=l*c-u,s=h*d,(n=l*u-c)>=0)if(o>=-s)if(o<=s){var f=1/d;a=(n*=f)*(n+l*(o*=f)+2*c)+o*(l*n+o+2*u)+p}else o=h,a=-(n=Math.max(0,-(l*o+c)))*n+o*(o+2*u)+p;else o=-h,a=-(n=Math.max(0,-(l*o+c)))*n+o*(o+2*u)+p;else o<=-s?a=-(n=Math.max(0,-(-l*h+c)))*n+(o=n>0?-h:Math.min(Math.max(-h,-u),h))*(o+2*u)+p:o<=s?(n=0,a=(o=Math.min(Math.max(-h,-u),h))*(o+2*u)+p):a=-(n=Math.max(0,-(l*h+c)))*n+(o=n>0?h:Math.min(Math.max(-h,-u),h))*(o+2*u)+p;else o=l>0?-h:h,a=-(n=Math.max(0,-(l*o+c)))*n+o*(o+2*u)+p;return i&&i.copy(this.direction).multiplyScalar(n).add(this.origin),r&&r.copy(Vi).multiplyScalar(o).add(ji),a}),intersectSphere:function(){var t=new Oe;return function(e,i){t.subVectors(e.center,this.origin);var r=t.dot(this.direction),n=t.dot(t)-r*r,o=e.radius*e.radius;if(n>o)return null;var a=Math.sqrt(o-n),s=r-a,h=r+a;return s<0&&h<0?null:s<0?this.at(h,i):this.at(s,i)}}(),intersectsSphere:function(t){return this.distanceToPoint(t.center)<=t.radius},distanceToPlane:function(t){var e=t.normal.dot(this.direction);if(0===e)return 0===t.distanceToPoint(this.origin)?0:null;var i=-(this.origin.dot(t.normal)+t.constant)/e;return i>=0?i:null},intersectPlane:function(t,e){var i=this.distanceToPlane(t);return null===i?null:this.at(i,e)},intersectsPlane:function(t){var e=t.distanceToPoint(this.origin);return 0===e||t.normal.dot(this.direction)*e<0},intersectBox:function(t,e){var i,r,n,o,a,s,h=1/this.direction.x,l=1/this.direction.y,c=1/this.direction.z,u=this.origin;return h>=0?(i=(t.min.x-u.x)*h,r=(t.max.x-u.x)*h):(i=(t.max.x-u.x)*h,r=(t.min.x-u.x)*h),l>=0?(n=(t.min.y-u.y)*l,o=(t.max.y-u.y)*l):(n=(t.max.y-u.y)*l,o=(t.min.y-u.y)*l),i>o||n>r?null:((n>i||i!=i)&&(i=n),(o<r||r!=r)&&(r=o),c>=0?(a=(t.min.z-u.z)*c,s=(t.max.z-u.z)*c):(a=(t.max.z-u.z)*c,s=(t.min.z-u.z)*c),i>s||a>r?null:((a>i||i!=i)&&(i=a),(s<r||r!=r)&&(r=s),r<0?null:this.at(i>=0?i:r,e)))},intersectsBox:(ki=new Oe,function(t){return null!==this.intersectBox(t,ki)}),intersectTriangle:function(){var t=new Oe,e=new Oe,i=new Oe,r=new Oe;return function(n,o,a,s,h){e.subVectors(o,n),i.subVectors(a,n),r.crossVectors(e,i);var l,c=this.direction.dot(r);if(c>0){if(s)return null;l=1}else{if(!(c<0))return null;l=-1,c=-c}t.subVectors(this.origin,n);var u=l*this.direction.dot(i.crossVectors(t,i));if(u<0)return null;var p=l*this.direction.dot(e.cross(t));if(p<0)return null;if(u+p>c)return null;var d=-l*t.dot(r);return d<0?null:this.at(d/c,h)}}(),applyMatrix4:function(t){return this.origin.applyMatrix4(t),this.direction.transformDirection(t),this},equals:function(t){return t.origin.equals(this.origin)&&t.direction.equals(this.direction)}}),Object.assign(Qi.prototype,{set:function(t,e){return this.start.copy(t),this.end.copy(e),this},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.start.copy(t.start),this.end.copy(t.end),this},getCenter:function(t){return void 0===t&&(t=new Oe),t.addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(t){return void 0===t&&(t=new Oe),t.subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(t,e){return void 0===e&&(e=new Oe),this.delta(e).multiplyScalar(t).add(this.start)},closestPointToPointParameter:(Ui=new Oe,Gi=new Oe,function(t,e){Ui.subVectors(t,this.start),Gi.subVectors(this.end,this.start);var i=Gi.dot(Gi),r=Gi.dot(Ui)/i;return e&&(r=Ce.clamp(r,0,1)),r}),closestPointToPoint:function(t,e,i){var r=this.closestPointToPointParameter(t,e);return void 0===i&&(i=new Oe),this.delta(i).multiplyScalar(r).add(this.start)},applyMatrix4:function(t){return this.start.applyMatrix4(t),this.end.applyMatrix4(t),this},equals:function(t){return t.start.equals(this.start)&&t.end.equals(this.end)}}),Object.assign(Ki,{getNormal:(Wi=new Oe,function(t,e,i,r){void 0===r&&(r=new Oe),r.subVectors(i,e),Wi.subVectors(t,e),r.cross(Wi);var n=r.lengthSq();return n>0?r.multiplyScalar(1/Math.sqrt(n)):r.set(0,0,0)}),getBarycoord:function(){var t=new Oe,e=new Oe,i=new Oe;return function(r,n,o,a,s){t.subVectors(a,n),e.subVectors(o,n),i.subVectors(r,n);var h=t.dot(t),l=t.dot(e),c=t.dot(i),u=e.dot(e),p=e.dot(i),d=h*u-l*l;if(void 0===s&&(s=new Oe),0===d)return s.set(-2,-1,-1);var f=1/d,m=(u*c-l*p)*f,g=(h*p-l*c)*f;return s.set(1-m-g,g,m)}}(),containsPoint:function(){var t=new Oe;return function(e,i,r,n){return Ki.getBarycoord(e,i,r,n,t),t.x>=0&&t.y>=0&&t.x+t.y<=1}}()}),Object.assign(Ki.prototype,{set:function(t,e,i){return this.a.copy(t),this.b.copy(e),this.c.copy(i),this},setFromPointsAndIndices:function(t,e,i,r){return this.a.copy(t[e]),this.b.copy(t[i]),this.c.copy(t[r]),this},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.a.copy(t.a),this.b.copy(t.b),this.c.copy(t.c),this},getArea:function(){var t=new Oe,e=new Oe;return function(){return t.subVectors(this.c,this.b),e.subVectors(this.a,this.b),.5*t.cross(e).length()}}(),getMidpoint:function(t){return void 0===t&&(t=new Oe),t.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},getNormal:function(t){return Ki.getNormal(this.a,this.b,this.c,t)},getPlane:function(t){return void 0===t&&(t=new Oe),t.setFromCoplanarPoints(this.a,this.b,this.c)},getBarycoord:function(t,e){return Ki.getBarycoord(t,this.a,this.b,this.c,e)},containsPoint:function(t){return Ki.containsPoint(t,this.a,this.b,this.c)},intersectsBox:function(t){return t.intersectsTriangle(this)},closestPointToPoint:function(){var t=new Ye,e=[new Qi,new Qi,new Qi],i=new Oe,r=new Oe;return function(n,o){void 0===o&&(o=new Oe);var a=1/0;if(t.setFromCoplanarPoints(this.a,this.b,this.c),t.projectPoint(n,i),!0===this.containsPoint(i))o.copy(i);else{e[0].set(this.a,this.b),e[1].set(this.b,this.c),e[2].set(this.c,this.a);for(var s=0;s<e.length;s++){e[s].closestPointToPoint(i,!0,r);var h=i.distanceToSquared(r);h<a&&(a=h,o.copy(r))}}return o}}(),equals:function(t){return t.a.equals(this.a)&&t.b.equals(this.b)&&t.c.equals(this.c)}}),$i.prototype=Object.assign(Object.create(di.prototype),{constructor:$i,isMesh:!0,setDrawMode:function(t){this.drawMode=t},copy:function(t){return di.prototype.copy.call(this,t),this.drawMode=t.drawMode,void 0!==t.morphTargetInfluences&&(this.morphTargetInfluences=t.morphTargetInfluences.slice()),void 0!==t.morphTargetDictionary&&(this.morphTargetDictionary=Object.assign({},t.morphTargetDictionary)),this},updateMorphTargets:function(){var t,e,i,r=this.geometry;if(r.isBufferGeometry){var n=r.morphAttributes,o=Object.keys(n);if(o.length>0){var a=n[o[0]];if(void 0!==a)for(this.morphTargetInfluences=[],this.morphTargetDictionary={},t=0,e=a.length;t<e;t++)i=a[t].name||String(t),this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=t}}else{var s=r.morphTargets;if(void 0!==s&&s.length>0)for(this.morphTargetInfluences=[],this.morphTargetDictionary={},t=0,e=s.length;t<e;t++)i=s[t].name||String(t),this.morphTargetInfluences.push(0),this.morphTargetDictionary[i]=t}},raycast:function(){var t=new De,e=new Ji,i=new Ze,r=new Oe,n=new Oe,o=new Oe,a=new Oe,s=new Oe,h=new Oe,l=new Pe,c=new Pe,u=new Pe,p=new Oe,d=new Oe,f=new Oe;function m(t,e,i,r,n,o,a){return Ki.getBarycoord(t,e,i,r,p),n.multiplyScalar(p.x),o.multiplyScalar(p.y),a.multiplyScalar(p.z),n.add(o).add(a),n.clone()}function g(t,e,i,r,n,o,a,s){if(null===(e.side===E?r.intersectTriangle(a,o,n,!0,s):r.intersectTriangle(n,o,a,e.side!==x,s)))return null;f.copy(s),f.applyMatrix4(t.matrixWorld);var h=i.ray.origin.distanceTo(f);return h<i.near||h>i.far?null:{distance:h,point:f.clone(),object:t}}function v(t,e,i,a,s,h,p,f,v){r.fromBufferAttribute(s,p),n.fromBufferAttribute(s,f),o.fromBufferAttribute(s,v);var y=g(t,e,i,a,r,n,o,d);if(y){h&&(l.fromBufferAttribute(h,p),c.fromBufferAttribute(h,f),u.fromBufferAttribute(h,v),y.uv=m(d,r,n,o,l,c,u));var E=new gi(p,f,v);Ki.getNormal(r,n,o,E.normal),y.face=E}return y}return function(p,f){var y,E=this.geometry,x=this.material,_=this.matrixWorld;if(void 0!==x&&(null===E.boundingSphere&&E.computeBoundingSphere(),i.copy(E.boundingSphere),i.applyMatrix4(_),!1!==p.ray.intersectsSphere(i)&&(t.getInverse(_),e.copy(p.ray).applyMatrix4(t),null===E.boundingBox||!1!==e.intersectsBox(E.boundingBox))))if(E.isBufferGeometry){var w,b,S,T,M,R,A,C,P,D=E.index,L=E.attributes.position,O=E.attributes.uv,H=E.groups,I=E.drawRange;if(null!==D)if(Array.isArray(x))for(T=0,R=H.length;T<R;T++)for(P=x[(C=H[T]).materialIndex],M=Math.max(C.start,I.start),A=Math.min(C.start+C.count,I.start+I.count);M<A;M+=3)w=D.getX(T),b=D.getX(T+1),S=D.getX(T+2),(y=v(this,P,p,e,L,O,w,b,S))&&(y.faceIndex=Math.floor(T/3),f.push(y));else for(T=Math.max(0,I.start),R=Math.min(D.count,I.start+I.count);T<R;T+=3)w=D.getX(T),b=D.getX(T+1),S=D.getX(T+2),(y=v(this,x,p,e,L,O,w,b,S))&&(y.faceIndex=Math.floor(T/3),f.push(y));else if(void 0!==L)if(Array.isArray(x))for(T=0,R=H.length;T<R;T++)for(P=x[(C=H[T]).materialIndex],M=Math.max(C.start,I.start),A=Math.min(C.start+C.count,I.start+I.count);M<A;M+=3)(y=v(this,P,p,e,L,O,w=M,b=M+1,S=M+2))&&(y.faceIndex=Math.floor(T/3),f.push(y));else for(T=Math.max(0,I.start),R=Math.min(L.count,I.start+I.count);T<R;T+=3)(y=v(this,x,p,e,L,O,w=T,b=T+1,S=T+2))&&(y.faceIndex=Math.floor(T/3),f.push(y))}else if(E.isGeometry){var B,z,N,k,j=Array.isArray(x),V=E.vertices,F=E.faces,U=E.faceVertexUvs[0];U.length>0&&(k=U);for(var G=0,W=F.length;G<W;G++){var X=F[G],Z=j?x[X.materialIndex]:x;if(void 0!==Z){if(B=V[X.a],z=V[X.b],N=V[X.c],!0===Z.morphTargets){var Y=E.morphTargets,q=this.morphTargetInfluences;r.set(0,0,0),n.set(0,0,0),o.set(0,0,0);for(var J=0,Q=Y.length;J<Q;J++){var K=q[J];if(0!==K){var $=Y[J].vertices;r.addScaledVector(a.subVectors($[X.a],B),K),n.addScaledVector(s.subVectors($[X.b],z),K),o.addScaledVector(h.subVectors($[X.c],N),K)}}r.add(B),n.add(z),o.add(N),B=r,z=n,N=o}if(y=g(this,Z,p,e,B,z,N,d)){if(k&&k[G]){var tt=k[G];l.copy(tt[0]),c.copy(tt[1]),u.copy(tt[2]),y.uv=m(d,B,z,N,l,c,u)}y.face=X,y.faceIndex=G,f.push(y)}}}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),er.prototype=Object.create(Ve.prototype),er.prototype.constructor=er,er.prototype.isCubeTexture=!0,Object.defineProperty(er.prototype,"images",{get:function(){return this.image},set:function(t){this.image=t}});var ir=new Ve,rr=new er;function nr(){this.seq=[],this.map={}}var or=[],ar=[],sr=new Float32Array(16),hr=new Float32Array(9),lr=new Float32Array(4);function cr(t,e,i){var r=t[0];if(r<=0||r>0)return t;var n=e*i,o=or[n];if(void 0===o&&(o=new Float32Array(n),or[n]=o),0!==e){r.toArray(o,0);for(var a=1,s=0;a!==e;++a)s+=i,t[a].toArray(o,s)}return o}function ur(t,e){if(t.length!==e.length)return!1;for(var i=0,r=t.length;i<r;i++)if(t[i]!==e[i])return!1;return!0}function pr(t,e){for(var i=0,r=e.length;i<r;i++)t[i]=e[i]}function dr(t,e){var i=ar[e];void 0===i&&(i=new Int32Array(e),ar[e]=i);for(var r=0;r!==e;++r)i[r]=t.allocTextureUnit();return i}function fr(t,e){var i=this.cache;i[0]!==e&&(t.uniform1f(this.addr,e),i[0]=e)}function mr(t,e){var i=this.cache;i[0]!==e&&(t.uniform1i(this.addr,e),i[0]=e)}function gr(t,e){var i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y||(t.uniform2f(this.addr,e.x,e.y),i[0]=e.x,i[1]=e.y);else{if(ur(i,e))return;t.uniform2fv(this.addr,e),pr(i,e)}}function vr(t,e){var i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z||(t.uniform3f(this.addr,e.x,e.y,e.z),i[0]=e.x,i[1]=e.y,i[2]=e.z);else if(void 0!==e.r)i[0]===e.r&&i[1]===e.g&&i[2]===e.b||(t.uniform3f(this.addr,e.r,e.g,e.b),i[0]=e.r,i[1]=e.g,i[2]=e.b);else{if(ur(i,e))return;t.uniform3fv(this.addr,e),pr(i,e)}}function yr(t,e){var i=this.cache;if(void 0!==e.x)i[0]===e.x&&i[1]===e.y&&i[2]===e.z&&i[3]===e.w||(t.uniform4f(this.addr,e.x,e.y,e.z,e.w),i[0]=e.x,i[1]=e.y,i[2]=e.z,i[3]=e.w);else{if(ur(i,e))return;t.uniform4fv(this.addr,e),pr(i,e)}}function Er(t,e){var i=this.cache,r=e.elements;if(void 0===r){if(ur(i,e))return;t.uniformMatrix2fv(this.addr,!1,e),pr(i,e)}else{if(ur(i,r))return;lr.set(r),t.uniformMatrix2fv(this.addr,!1,lr),pr(i,r)}}function xr(t,e){var i=this.cache,r=e.elements;if(void 0===r){if(ur(i,e))return;t.uniformMatrix3fv(this.addr,!1,e),pr(i,e)}else{if(ur(i,r))return;hr.set(r),t.uniformMatrix3fv(this.addr,!1,hr),pr(i,r)}}function _r(t,e){var i=this.cache,r=e.elements;if(void 0===r){if(ur(i,e))return;t.uniformMatrix4fv(this.addr,!1,e),pr(i,e)}else{if(ur(i,r))return;sr.set(r),t.uniformMatrix4fv(this.addr,!1,sr),pr(i,r)}}function wr(t,e,i){var r=this.cache,n=i.allocTextureUnit();r[0]!==n&&(t.uniform1i(this.addr,n),r[0]=n),i.setTexture2D(e||ir,n)}function br(t,e,i){var r=this.cache,n=i.allocTextureUnit();r[0]!==n&&(t.uniform1i(this.addr,n),r[0]=n),i.setTextureCube(e||rr,n)}function Sr(t,e){var i=this.cache;ur(i,e)||(t.uniform2iv(this.addr,e),pr(i,e))}function Tr(t,e){var i=this.cache;ur(i,e)||(t.uniform3iv(this.addr,e),pr(i,e))}function Mr(t,e){var i=this.cache;ur(i,e)||(t.uniform4iv(this.addr,e),pr(i,e))}function Rr(t,e){var i=this.cache;ur(i,e)||(t.uniform1fv(this.addr,e),pr(i,e))}function Ar(t,e){var i=this.cache;ur(i,e)||(t.uniform1iv(this.addr,e),pr(i,e))}function Cr(t,e){var i=this.cache,r=cr(e,this.size,2);ur(i,r)||(t.uniform2fv(this.addr,r),this.updateCache(r))}function Pr(t,e){var i=this.cache,r=cr(e,this.size,3);ur(i,r)||(t.uniform3fv(this.addr,r),this.updateCache(r))}function Dr(t,e){var i=this.cache,r=cr(e,this.size,4);ur(i,r)||(t.uniform4fv(this.addr,r),this.updateCache(r))}function Lr(t,e){var i=this.cache,r=cr(e,this.size,4);ur(i,r)||(t.uniformMatrix2fv(this.addr,!1,r),this.updateCache(r))}function Or(t,e){var i=this.cache,r=cr(e,this.size,9);ur(i,r)||(t.uniformMatrix3fv(this.addr,!1,r),this.updateCache(r))}function Hr(t,e){var i=this.cache,r=cr(e,this.size,16);ur(i,r)||(t.uniformMatrix4fv(this.addr,!1,r),this.updateCache(r))}function Ir(t,e,i){var r=this.cache,n=e.length,o=dr(i,n);!1===ur(r,o)&&(t.uniform1iv(this.addr,o),pr(r,o));for(var a=0;a!==n;++a)i.setTexture2D(e[a]||ir,o[a])}function Br(t,e,i){var r=this.cache,n=e.length,o=dr(i,n);!1===ur(r,o)&&(t.uniform1iv(this.addr,o),pr(r,o));for(var a=0;a!==n;++a)i.setTextureCube(e[a]||rr,o[a])}function zr(t,e,i){this.id=t,this.addr=i,this.cache=[],this.setValue=function(t){switch(t){case 5126:return fr;case 35664:return gr;case 35665:return vr;case 35666:return yr;case 35674:return Er;case 35675:return xr;case 35676:return _r;case 35678:case 36198:return wr;case 35680:return br;case 5124:case 35670:return mr;case 35667:case 35671:return Sr;case 35668:case 35672:return Tr;case 35669:case 35673:return Mr}}(e.type)}function Nr(t,e,i){this.id=t,this.addr=i,this.cache=[],this.size=e.size,this.setValue=function(t){switch(t){case 5126:return Rr;case 35664:return Cr;case 35665:return Pr;case 35666:return Dr;case 35674:return Lr;case 35675:return Or;case 35676:return Hr;case 35678:return Ir;case 35680:return Br;case 5124:case 35670:return Ar;case 35667:case 35671:return Sr;case 35668:case 35672:return Tr;case 35669:case 35673:return Mr}}(e.type)}function kr(t){this.id=t,nr.call(this)}Nr.prototype.updateCache=function(t){var e=this.cache;t instanceof Float32Array&&e.length!==t.length&&(this.cache=new Float32Array(t.length)),pr(e,t)},kr.prototype.setValue=function(t,e){for(var i=this.seq,r=0,n=i.length;r!==n;++r){var o=i[r];o.setValue(t,e[o.id])}};var jr=/([\w\d_]+)(\])?(\[|\.)?/g;function Vr(t,e){t.seq.push(e),t.map[e.id]=e}function Fr(t,e,i){var r=t.name,n=r.length;for(jr.lastIndex=0;;){var o=jr.exec(r),a=jr.lastIndex,s=o[1],h="]"===o[2],l=o[3];if(h&&(s|=0),void 0===l||"["===l&&a+2===n){Vr(i,void 0===l?new zr(s,t,e):new Nr(s,t,e));break}var c=i.map[s];void 0===c&&Vr(i,c=new kr(s)),i=c}}function Ur(t,e,i){nr.call(this),this.renderer=i;for(var r=t.getProgramParameter(e,t.ACTIVE_UNIFORMS),n=0;n<r;++n){var o=t.getActiveUniform(e,n);Fr(o,t.getUniformLocation(e,o.name),this)}}function Gr(t,e,i){var r=t.createShader(e);return t.shaderSource(r,i),t.compileShader(r),t.getShaderParameter(r,t.COMPILE_STATUS),t.getShaderInfoLog(r),r}Ur.prototype.setValue=function(t,e,i){var r=this.map[e];void 0!==r&&r.setValue(t,i,this.renderer)},Ur.prototype.setOptional=function(t,e,i){var r=e[i];void 0!==r&&this.setValue(t,i,r)},Ur.upload=function(t,e,i,r){for(var n=0,o=e.length;n!==o;++n){var a=e[n],s=i[a.id];!1!==s.needsUpdate&&a.setValue(t,s.value,r)}},Ur.seqWithValue=function(t,e){for(var i=[],r=0,n=t.length;r!==n;++r){var o=t[r];o.id in e&&i.push(o)}return i};var Wr=0;function Xr(t){switch(t){case ye:return["Linear","( value )"];case Ee:return["sRGB","( value )"];case _e:return["RGBE","( value )"];case we:return["RGBM","( value, 7.0 )"];case be:return["RGBM","( value, 16.0 )"];case Se:return["RGBD","( value, 256.0 )"];case xe:return["Gamma","( value, float( GAMMA_FACTOR ) )"];default:throw new Error("unsupported encoding: "+t)}}function Zr(t,e){var i=Xr(e);return"vec4 "+t+"( vec4 value ) { return "+i[0]+"ToLinear"+i[1]+"; }"}function Yr(t){return""!==t}function qr(t,e){return t.replace(/NUM_DIR_LIGHTS/g,e.numDirLights).replace(/NUM_SPOT_LIGHTS/g,e.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,e.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,e.numPointLights).replace(/NUM_HEMI_LIGHTS/g,e.numHemiLights)}function Jr(t,e){return t.replace(/NUM_CLIPPING_PLANES/g,e.numClippingPlanes).replace(/UNION_CLIPPING_PLANES/g,e.numClippingPlanes-e.numClipIntersection)}function Qr(t){return t.replace(/^[ \t]*#include +<([\w\d.]+)>/gm,function(t,e){var i=Qe[e];if(void 0===i)throw new Error("Can not resolve #include <"+e+">");return Qr(i)})}function Kr(t){return t.replace(/#pragma unroll_loop[\s]+?for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g,function(t,e,i,r){for(var n="",o=parseInt(e);o<parseInt(i);o++)n+=r.replace(/\[ i \]/g,"[ "+o+" ]");return n})}function $r(t,e,i,r,n,o){var a=t.context,s=r.defines,h=n.vertexShader,l=n.fragmentShader,c="SHADOWMAP_TYPE_BASIC";o.shadowMapType===g?c="SHADOWMAP_TYPE_PCF":o.shadowMapType===v&&(c="SHADOWMAP_TYPE_PCF_SOFT");var u="ENVMAP_TYPE_CUBE",p="ENVMAP_MODE_REFLECTION",d="ENVMAP_BLENDING_MULTIPLY";if(o.envMap){switch(r.envMap.mapping){case ht:case lt:u="ENVMAP_TYPE_CUBE";break;case dt:case ft:u="ENVMAP_TYPE_CUBE_UV";break;case ct:case ut:u="ENVMAP_TYPE_EQUIREC";break;case pt:u="ENVMAP_TYPE_SPHERE"}switch(r.envMap.mapping){case lt:case ut:p="ENVMAP_MODE_REFRACTION"}switch(r.combine){case tt:d="ENVMAP_BLENDING_MULTIPLY";break;case et:d="ENVMAP_BLENDING_MIX";break;case it:d="ENVMAP_BLENDING_ADD"}}var f,m,y,E,x,_=t.gammaFactor>0?t.gammaFactor:1,w=function(t,e,i){return[(t=t||{}).derivatives||e.envMapCubeUV||e.bumpMap||e.normalMap&&!e.objectSpaceNormalMap||e.flatShading?"#extension GL_OES_standard_derivatives : enable":"",(t.fragDepth||e.logarithmicDepthBuffer)&&i.get("EXT_frag_depth")?"#extension GL_EXT_frag_depth : enable":"",t.drawBuffers&&i.get("WEBGL_draw_buffers")?"#extension GL_EXT_draw_buffers : require":"",(t.shaderTextureLOD||e.envMap)&&i.get("EXT_shader_texture_lod")?"#extension GL_EXT_shader_texture_lod : enable":""].filter(Yr).join("\n")}(r.extensions,o,e),b=function(t){var e=[];for(var i in t){var r=t[i];!1!==r&&e.push("#define "+i+" "+r)}return e.join("\n")}(s),S=a.createProgram();r.isRawShaderMaterial?((f=[b].filter(Yr).join("\n")).length>0&&(f+="\n"),(m=[w,b].filter(Yr).join("\n")).length>0&&(m+="\n")):(f=["precision "+o.precision+" float;","precision "+o.precision+" int;","#define SHADER_NAME "+n.name,b,o.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+_,"#define MAX_BONES "+o.maxBones,o.useFog&&o.fog?"#define USE_FOG":"",o.useFog&&o.fogExp?"#define FOG_EXP2":"",o.map?"#define USE_MAP":"",o.envMap?"#define USE_ENVMAP":"",o.envMap?"#define "+p:"",o.lightMap?"#define USE_LIGHTMAP":"",o.aoMap?"#define USE_AOMAP":"",o.emissiveMap?"#define USE_EMISSIVEMAP":"",o.bumpMap?"#define USE_BUMPMAP":"",o.normalMap?"#define USE_NORMALMAP":"",o.normalMap&&o.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",o.displacementMap&&o.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",o.specularMap?"#define USE_SPECULARMAP":"",o.roughnessMap?"#define USE_ROUGHNESSMAP":"",o.metalnessMap?"#define USE_METALNESSMAP":"",o.alphaMap?"#define USE_ALPHAMAP":"",o.vertexColors?"#define USE_COLOR":"",o.flatShading?"#define FLAT_SHADED":"",o.skinning?"#define USE_SKINNING":"",o.useVertexTexture?"#define BONE_TEXTURE":"",o.morphTargets?"#define USE_MORPHTARGETS":"",o.morphNormals&&!1===o.flatShading?"#define USE_MORPHNORMALS":"",o.doubleSided?"#define DOUBLE_SIDED":"",o.flipSided?"#define FLIP_SIDED":"",o.shadowMapEnabled?"#define USE_SHADOWMAP":"",o.shadowMapEnabled?"#define "+c:"",o.sizeAttenuation?"#define USE_SIZEATTENUATION":"",o.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",o.logarithmicDepthBuffer&&e.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_COLOR","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif","\n"].filter(Yr).join("\n"),m=[w,"precision "+o.precision+" float;","precision "+o.precision+" int;","#define SHADER_NAME "+n.name,b,o.alphaTest?"#define ALPHATEST "+o.alphaTest+(o.alphaTest%1?"":".0"):"","#define GAMMA_FACTOR "+_,o.useFog&&o.fog?"#define USE_FOG":"",o.useFog&&o.fogExp?"#define FOG_EXP2":"",o.map?"#define USE_MAP":"",o.envMap?"#define USE_ENVMAP":"",o.envMap?"#define "+u:"",o.envMap?"#define "+p:"",o.envMap?"#define "+d:"",o.lightMap?"#define USE_LIGHTMAP":"",o.aoMap?"#define USE_AOMAP":"",o.emissiveMap?"#define USE_EMISSIVEMAP":"",o.bumpMap?"#define USE_BUMPMAP":"",o.normalMap?"#define USE_NORMALMAP":"",o.normalMap&&o.objectSpaceNormalMap?"#define OBJECTSPACE_NORMALMAP":"",o.specularMap?"#define USE_SPECULARMAP":"",o.roughnessMap?"#define USE_ROUGHNESSMAP":"",o.metalnessMap?"#define USE_METALNESSMAP":"",o.alphaMap?"#define USE_ALPHAMAP":"",o.vertexColors?"#define USE_COLOR":"",o.gradientMap?"#define USE_GRADIENTMAP":"",o.flatShading?"#define FLAT_SHADED":"",o.doubleSided?"#define DOUBLE_SIDED":"",o.flipSided?"#define FLIP_SIDED":"",o.shadowMapEnabled?"#define USE_SHADOWMAP":"",o.shadowMapEnabled?"#define "+c:"",o.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",o.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",o.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",o.logarithmicDepthBuffer&&e.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"",o.envMap&&e.get("EXT_shader_texture_lod")?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",o.toneMapping!==rt?"#define TONE_MAPPING":"",o.toneMapping!==rt?Qe.tonemapping_pars_fragment:"",o.toneMapping!==rt?function(t,e){var i;switch(e){case nt:i="Linear";break;case ot:i="Reinhard";break;case at:i="Uncharted2";break;case st:i="OptimizedCineon";break;default:throw new Error("unsupported toneMapping: "+e)}return"vec3 "+t+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}("toneMapping",o.toneMapping):"",o.dithering?"#define DITHERING":"",o.outputEncoding||o.mapEncoding||o.envMapEncoding||o.emissiveMapEncoding?Qe.encodings_pars_fragment:"",o.mapEncoding?Zr("mapTexelToLinear",o.mapEncoding):"",o.envMapEncoding?Zr("envMapTexelToLinear",o.envMapEncoding):"",o.emissiveMapEncoding?Zr("emissiveMapTexelToLinear",o.emissiveMapEncoding):"",o.outputEncoding?(y="linearToOutputTexel",E=o.outputEncoding,x=Xr(E),"vec4 "+y+"( vec4 value ) { return LinearTo"+x[0]+x[1]+"; }"):"",o.depthPacking?"#define DEPTH_PACKING "+r.depthPacking:"","\n"].filter(Yr).join("\n")),h=Jr(h=qr(h=Qr(h),o),o),l=Jr(l=qr(l=Qr(l),o),o);var T=f+(h=Kr(h)),M=m+(l=Kr(l)),R=Gr(a,a.VERTEX_SHADER,T),A=Gr(a,a.FRAGMENT_SHADER,M);a.attachShader(S,R),a.attachShader(S,A),void 0!==r.index0AttributeName?a.bindAttribLocation(S,0,r.index0AttributeName):!0===o.morphTargets&&a.bindAttribLocation(S,0,"position"),a.linkProgram(S);var C,P,D=a.getProgramInfoLog(S).trim(),L=a.getShaderInfoLog(R).trim(),O=a.getShaderInfoLog(A).trim(),H=!0,I=!0;return!1===a.getProgramParameter(S,a.LINK_STATUS)?H=!1:""!==D||""!==L&&""!==O||(I=!1),I&&(this.diagnostics={runnable:H,material:r,programLog:D,vertexShader:{log:L,prefix:f},fragmentShader:{log:O,prefix:m}}),a.deleteShader(R),a.deleteShader(A),this.getUniforms=function(){return void 0===C&&(C=new Ur(a,S,t)),C},this.getAttributes=function(){return void 0===P&&(P=function(t,e){for(var i={},r=t.getProgramParameter(e,t.ACTIVE_ATTRIBUTES),n=0;n<r;n++){var o=t.getActiveAttrib(e,n).name;i[o]=t.getAttribLocation(e,o)}return i}(a,S)),P},this.destroy=function(){a.deleteProgram(S),this.program=void 0},Object.defineProperties(this,{uniforms:{get:function(){return this.getUniforms()}},attributes:{get:function(){return this.getAttributes()}}}),this.name=n.name,this.id=Wr++,this.code=i,this.usedTimes=1,this.program=S,this.vertexShader=R,this.fragmentShader=A,this}function tn(t,e,i){var r=[],n={MeshDepthMaterial:"depth",MeshDistanceMaterial:"distanceRGBA",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"phong",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points",ShadowMaterial:"shadow"},o=["precision","supportsVertexTextures","map","mapEncoding","envMap","envMapMode","envMapEncoding","lightMap","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","objectSpaceNormalMap","displacementMap","specularMap","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","fog","useFog","fogExp","flatShading","sizeAttenuation","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering"];function a(t,e){var i;return t?t.isTexture?i=t.encoding:t.isWebGLRenderTarget&&(i=t.texture.encoding):i=ye,i===ye&&e&&(i=xe),i}this.getParameters=function(e,r,o,s,h,l,c){var u=n[e.type],p=c.isSkinnedMesh?function(t){var e=t.skeleton.bones;if(i.floatVertexTextures)return 1024;var r=i.maxVertexUniforms,n=Math.floor((r-20)/4),o=Math.min(n,e.length);return o<e.length?0:o}(c):0,d=i.precision;null!==e.precision&&(d=i.getMaxPrecision(e.precision),e.precision);var f=t.getRenderTarget();return{shaderID:u,precision:d,supportsVertexTextures:i.vertexTextures,outputEncoding:a(f?f.texture:null,t.gammaOutput),map:!!e.map,mapEncoding:a(e.map,t.gammaInput),envMap:!!e.envMap,envMapMode:e.envMap&&e.envMap.mapping,envMapEncoding:a(e.envMap,t.gammaInput),envMapCubeUV:!!e.envMap&&(e.envMap.mapping===dt||e.envMap.mapping===ft),lightMap:!!e.lightMap,aoMap:!!e.aoMap,emissiveMap:!!e.emissiveMap,emissiveMapEncoding:a(e.emissiveMap,t.gammaInput),bumpMap:!!e.bumpMap,normalMap:!!e.normalMap,objectSpaceNormalMap:e.normalMapType===Ae,displacementMap:!!e.displacementMap,roughnessMap:!!e.roughnessMap,metalnessMap:!!e.metalnessMap,specularMap:!!e.specularMap,alphaMap:!!e.alphaMap,gradientMap:!!e.gradientMap,combine:e.combine,vertexColors:e.vertexColors,fog:!!s,useFog:e.fog,fogExp:s&&s.isFogExp2,flatShading:e.flatShading,sizeAttenuation:e.sizeAttenuation,logarithmicDepthBuffer:i.logarithmicDepthBuffer,skinning:e.skinning&&p>0,maxBones:p,useVertexTexture:i.floatVertexTextures,morphTargets:e.morphTargets,morphNormals:e.morphNormals,maxMorphTargets:t.maxMorphTargets,maxMorphNormals:t.maxMorphNormals,numDirLights:r.directional.length,numPointLights:r.point.length,numSpotLights:r.spot.length,numRectAreaLights:r.rectArea.length,numHemiLights:r.hemi.length,numClippingPlanes:h,numClipIntersection:l,dithering:e.dithering,shadowMapEnabled:t.shadowMap.enabled&&c.receiveShadow&&o.length>0,shadowMapType:t.shadowMap.type,toneMapping:t.toneMapping,physicallyCorrectLights:t.physicallyCorrectLights,premultipliedAlpha:e.premultipliedAlpha,alphaTest:e.alphaTest,doubleSided:e.side===x,flipSided:e.side===E,depthPacking:void 0!==e.depthPacking&&e.depthPacking}},this.getProgramCode=function(e,i){var r=[];if(i.shaderID?r.push(i.shaderID):(r.push(e.fragmentShader),r.push(e.vertexShader)),void 0!==e.defines)for(var n in e.defines)r.push(n),r.push(e.defines[n]);for(var a=0;a<o.length;a++)r.push(i[o[a]]);return r.push(e.onBeforeCompile.toString()),r.push(t.gammaOutput),r.join()},this.acquireProgram=function(i,n,o,a){for(var s,h=0,l=r.length;h<l;h++){var c=r[h];if(c.code===a){++(s=c).usedTimes;break}}return void 0===s&&(s=new $r(t,e,a,i,n,o),r.push(s)),s},this.releaseProgram=function(t){if(0==--t.usedTimes){var e=r.indexOf(t);r[e]=r[r.length-1],r.pop(),t.destroy()}},this.programs=r}function en(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.program&&e.program&&t.program!==e.program?t.program.id-e.program.id:t.material.id!==e.material.id?t.material.id-e.material.id:t.z!==e.z?t.z-e.z:t.id-e.id}function rn(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.z!==e.z?e.z-t.z:t.id-e.id}function nn(){var t={};return{get:function(e,i){var r=e.id+","+i.id,n=t[r];return void 0===n&&(n=new function(){var t=[],e=0,i=[],r=[];return{opaque:i,transparent:r,init:function(){e=0,i.length=0,r.length=0},push:function(n,o,a,s,h){var l=t[e];void 0===l?(l={id:n.id,object:n,geometry:o,material:a,program:a.program,renderOrder:n.renderOrder,z:s,group:h},t[e]=l):(l.id=n.id,l.object=n,l.geometry=o,l.material=a,l.program=a.program,l.renderOrder=n.renderOrder,l.z=s,l.group=h),(!0===a.transparent?r:i).push(l),e++},sort:function(){i.length>1&&i.sort(en),r.length>1&&r.sort(rn)}}},t[r]=n),n},dispose:function(){t={}}}}var on,an,sn,hn,ln,cn=0;function un(){var t=new function(){var t={};return{get:function(e){if(void 0!==t[e.id])return t[e.id];var i;switch(e.type){case"DirectionalLight":i={direction:new Oe,color:new ti,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new Pe};break;case"SpotLight":i={position:new Oe,direction:new Oe,color:new ti,distance:0,coneCos:0,penumbraCos:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new Pe};break;case"PointLight":i={position:new Oe,color:new ti,distance:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new Pe,shadowCameraNear:1,shadowCameraFar:1e3};break;case"HemisphereLight":i={direction:new Oe,skyColor:new ti,groundColor:new ti};break;case"RectAreaLight":i={color:new ti,position:new Oe,halfWidth:new Oe,halfHeight:new Oe}}return t[e.id]=i,i}}},e={id:cn++,hash:"",ambient:[0,0,0],directional:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],point:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[]},i=new Oe,r=new De,n=new De;return{setup:function(o,a,s){for(var h=0,l=0,c=0,u=0,p=0,d=0,f=0,m=0,g=s.matrixWorldInverse,v=0,y=o.length;v<y;v++){var E=o[v],x=E.color,_=E.intensity,w=E.distance,b=E.shadow&&E.shadow.map?E.shadow.map.texture:null;if(E.isAmbientLight)h+=x.r*_,l+=x.g*_,c+=x.b*_;else if(E.isDirectionalLight){if((T=t.get(E)).color.copy(E.color).multiplyScalar(E.intensity),T.direction.setFromMatrixPosition(E.matrixWorld),i.setFromMatrixPosition(E.target.matrixWorld),T.direction.sub(i),T.direction.transformDirection(g),T.shadow=E.castShadow,E.castShadow){var S=E.shadow;T.shadowBias=S.bias,T.shadowRadius=S.radius,T.shadowMapSize=S.mapSize}e.directionalShadowMap[u]=b,e.directionalShadowMatrix[u]=E.shadow.matrix,e.directional[u]=T,u++}else if(E.isSpotLight)(T=t.get(E)).position.setFromMatrixPosition(E.matrixWorld),T.position.applyMatrix4(g),T.color.copy(x).multiplyScalar(_),T.distance=w,T.direction.setFromMatrixPosition(E.matrixWorld),i.setFromMatrixPosition(E.target.matrixWorld),T.direction.sub(i),T.direction.transformDirection(g),T.coneCos=Math.cos(E.angle),T.penumbraCos=Math.cos(E.angle*(1-E.penumbra)),T.decay=0===E.distance?0:E.decay,T.shadow=E.castShadow,E.castShadow&&(S=E.shadow,T.shadowBias=S.bias,T.shadowRadius=S.radius,T.shadowMapSize=S.mapSize),e.spotShadowMap[d]=b,e.spotShadowMatrix[d]=E.shadow.matrix,e.spot[d]=T,d++;else if(E.isRectAreaLight)(T=t.get(E)).color.copy(x).multiplyScalar(_),T.position.setFromMatrixPosition(E.matrixWorld),T.position.applyMatrix4(g),n.identity(),r.copy(E.matrixWorld),r.premultiply(g),n.extractRotation(r),T.halfWidth.set(.5*E.width,0,0),T.halfHeight.set(0,.5*E.height,0),T.halfWidth.applyMatrix4(n),T.halfHeight.applyMatrix4(n),e.rectArea[f]=T,f++;else if(E.isPointLight)(T=t.get(E)).position.setFromMatrixPosition(E.matrixWorld),T.position.applyMatrix4(g),T.color.copy(E.color).multiplyScalar(E.intensity),T.distance=E.distance,T.decay=0===E.distance?0:E.decay,T.shadow=E.castShadow,E.castShadow&&(S=E.shadow,T.shadowBias=S.bias,T.shadowRadius=S.radius,T.shadowMapSize=S.mapSize,T.shadowCameraNear=S.camera.near,T.shadowCameraFar=S.camera.far),e.pointShadowMap[p]=b,e.pointShadowMatrix[p]=E.shadow.matrix,e.point[p]=T,p++;else if(E.isHemisphereLight){var T;(T=t.get(E)).direction.setFromMatrixPosition(E.matrixWorld),T.direction.transformDirection(g),T.direction.normalize(),T.skyColor.copy(E.color).multiplyScalar(_),T.groundColor.copy(E.groundColor).multiplyScalar(_),e.hemi[m]=T,m++}}e.ambient[0]=h,e.ambient[1]=l,e.ambient[2]=c,e.directional.length=u,e.spot.length=d,e.rectArea.length=f,e.point.length=p,e.hemi.length=m,e.hash=e.id+","+u+","+p+","+d+","+f+","+m+","+a.length},state:e}}function pn(){var t={};return{get:function(e,i){var r=e.id+","+i.id,n=t[r];return void 0===n&&(n=new function(){var t=new un,e=[],i=[],r=[];return{init:function(){e.length=0,i.length=0,r.length=0},state:{lightsArray:e,shadowsArray:i,spritesArray:r,lights:t},setupLights:function(r){t.setup(e,i,r)},pushLight:function(t){e.push(t)},pushShadow:function(t){i.push(t)},pushSprite:function(t){r.push(t)}}},t[r]=n),n},dispose:function(){t={}}}}function dn(t){Zi.call(this),this.type="MeshDepthMaterial",this.depthPacking=Te,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.setValues(t)}function fn(t){Zi.call(this),this.type="MeshDistanceMaterial",this.referencePosition=new Oe,this.nearDistance=1,this.farDistance=1e3,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.fog=!1,this.lights=!1,this.setValues(t)}function mn(t,e,i){for(var r=new qe,n=new De,o=new Pe,a=new Pe(i,i),s=new Oe,h=new Oe,l=1,c=2,u=1+(l|c),p=new Array(u),d=new Array(u),f={},m={0:E,1:y,2:x},v=[new Oe(1,0,0),new Oe(-1,0,0),new Oe(0,0,1),new Oe(0,0,-1),new Oe(0,1,0),new Oe(0,-1,0)],_=[new Oe(0,1,0),new Oe(0,1,0),new Oe(0,1,0),new Oe(0,1,0),new Oe(0,0,1),new Oe(0,0,-1)],w=[new Fe,new Fe,new Fe,new Fe,new Fe,new Fe],b=0;b!==u;++b){var S=0!=(b&l),T=0!=(b&c),M=new dn({depthPacking:Me,morphTargets:S,skinning:T});p[b]=M;var R=new fn({morphTargets:S,skinning:T});d[b]=R}var A=this;function C(e,i,r,n,o,a){var s=e.geometry,h=null,u=p,g=e.customDepthMaterial;if(r&&(u=d,g=e.customDistanceMaterial),g)h=g;else{var v=!1;i.morphTargets&&(s&&s.isBufferGeometry?v=s.morphAttributes&&s.morphAttributes.position&&s.morphAttributes.position.length>0:s&&s.isGeometry&&(v=s.morphTargets&&s.morphTargets.length>0)),e.isSkinnedMesh&&i.skinning;var y=e.isSkinnedMesh&&i.skinning,E=0;v&&(E|=l),y&&(E|=c),h=u[E]}if(t.localClippingEnabled&&!0===i.clipShadows&&0!==i.clippingPlanes.length){var x=h.uuid,_=i.uuid,w=f[x];void 0===w&&(w={},f[x]=w);var b=w[_];void 0===b&&(b=h.clone(),w[_]=b),h=b}return h.visible=i.visible,h.wireframe=i.wireframe,h.side=null!=i.shadowSide?i.shadowSide:m[i.side],h.clipShadows=i.clipShadows,h.clippingPlanes=i.clippingPlanes,h.clipIntersection=i.clipIntersection,h.wireframeLinewidth=i.wireframeLinewidth,h.linewidth=i.linewidth,r&&h.isMeshDistanceMaterial&&(h.referencePosition.copy(n),h.nearDistance=o,h.farDistance=a),h}function P(i,n,o,a){if(!1!==i.visible){if(i.layers.test(n.layers)&&(i.isMesh||i.isLine||i.isPoints)&&i.castShadow&&(!i.frustumCulled||r.intersectsObject(i))){i.modelViewMatrix.multiplyMatrices(o.matrixWorldInverse,i.matrixWorld);var s=e.update(i),l=i.material;if(Array.isArray(l))for(var c=s.groups,u=0,p=c.length;u<p;u++){var d=c[u],f=l[d.materialIndex];if(f&&f.visible){var m=C(i,f,a,h,o.near,o.far);t.renderBufferDirect(o,null,s,m,i,d)}}else if(l.visible){m=C(i,l,a,h,o.near,o.far);t.renderBufferDirect(o,null,s,m,i,null)}}for(var g=i.children,v=0,y=g.length;v<y;v++)P(g[v],n,o,a)}}this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=g,this.render=function(e,i,l){if(!1!==A.enabled&&(!1!==A.autoUpdate||!1!==A.needsUpdate)&&0!==e.length){var c,u=t.context,p=t.state;p.disable(u.BLEND),p.buffers.color.setClear(1,1,1,1),p.buffers.depth.setTest(!0),p.setScissorTest(!1);for(var d=0,f=e.length;d<f;d++){var m=e[d],g=m.shadow,y=m&&m.isPointLight;if(void 0!==g){var E=g.camera;if(o.copy(g.mapSize),o.min(a),y){var x=o.x,b=o.y;w[0].set(2*x,b,x,b),w[1].set(0,b,x,b),w[2].set(3*x,b,x,b),w[3].set(x,b,x,b),w[4].set(3*x,0,x,b),w[5].set(x,0,x,b),o.x*=4,o.y*=2}if(null===g.map){var S={minFilter:yt,magFilter:yt,format:Nt};g.map=new Ue(o.x,o.y,S),g.map.texture.name=m.name+".shadowMap",E.updateProjectionMatrix()}g.isSpotLightShadow&&g.update(m);var T=g.map,M=g.matrix;h.setFromMatrixPosition(m.matrixWorld),E.position.copy(h),y?(c=6,M.makeTranslation(-h.x,-h.y,-h.z)):(c=1,s.setFromMatrixPosition(m.target.matrixWorld),E.lookAt(s),E.updateMatrixWorld(),M.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),M.multiply(E.projectionMatrix),M.multiply(E.matrixWorldInverse)),t.setRenderTarget(T),t.clear();for(var R=0;R<c;R++){if(y){s.copy(E.position),s.add(v[R]),E.up.copy(_[R]),E.lookAt(s),E.updateMatrixWorld();var C=w[R];p.viewport(C)}n.multiplyMatrices(E.projectionMatrix,E.matrixWorldInverse),r.setFromMatrix(n),P(i,l,E,y)}}}A.needsUpdate=!1}}}function gn(t,e,i,r,n,o,a,s,h){Ve.call(this,t,e,i,r,n,o,a,s,h),this.needsUpdate=!0}function vn(t,e,i,r,n){var o,a,s,h,l,c,u=new Oe,p=new Le,d=new Oe;function f(){var t=new Float32Array([-.5,-.5,0,0,.5,-.5,1,0,.5,.5,1,1,-.5,.5,0,1]),i=new Uint16Array([0,1,2,0,2,3]);o=e.createBuffer(),a=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,o),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a),e.bufferData(e.ELEMENT_ARRAY_BUFFER,i,e.STATIC_DRAW),s=function(){var t=e.createProgram(),i=e.createShader(e.VERTEX_SHADER),r=e.createShader(e.FRAGMENT_SHADER);return e.shaderSource(i,["precision "+n.precision+" float;","#define SHADER_NAME SpriteMaterial","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float rotation;","uniform vec2 center;","uniform vec2 scale;","uniform vec2 uvOffset;","uniform vec2 uvScale;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float fogDepth;","void main() {","\tvUV = uvOffset + uv * uvScale;","\tvec2 alignedPosition = ( position - center ) * scale;","\tvec2 rotatedPosition;","\trotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;","\trotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;","\tvec4 mvPosition;","\tmvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );","\tmvPosition.xy += rotatedPosition;","\tgl_Position = projectionMatrix * mvPosition;","\tfogDepth = - mvPosition.z;","}"].join("\n")),e.shaderSource(r,["precision "+n.precision+" float;","#define SHADER_NAME SpriteMaterial","uniform vec3 color;","uniform sampler2D map;","uniform float opacity;","uniform int fogType;","uniform vec3 fogColor;","uniform float fogDensity;","uniform float fogNear;","uniform float fogFar;","uniform float alphaTest;","varying vec2 vUV;","varying float fogDepth;","void main() {","\tvec4 texture = texture2D( map, vUV );","\tgl_FragColor = vec4( color * texture.xyz, texture.a * opacity );","\tif ( gl_FragColor.a < alphaTest ) discard;","\tif ( fogType > 0 ) {","\t\tfloat fogFactor = 0.0;","\t\tif ( fogType == 1 ) {","\t\t\tfogFactor = smoothstep( fogNear, fogFar, fogDepth );","\t\t} else {","\t\t\tconst float LOG2 = 1.442695;","\t\t\tfogFactor = exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 );","\t\t\tfogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","\t\t}","\t\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );","\t}","}"].join("\n")),e.compileShader(i),e.compileShader(r),e.attachShader(t,i),e.attachShader(t,r),e.linkProgram(t),t}(),h={position:e.getAttribLocation(s,"position"),uv:e.getAttribLocation(s,"uv")},l={uvOffset:e.getUniformLocation(s,"uvOffset"),uvScale:e.getUniformLocation(s,"uvScale"),rotation:e.getUniformLocation(s,"rotation"),center:e.getUniformLocation(s,"center"),scale:e.getUniformLocation(s,"scale"),color:e.getUniformLocation(s,"color"),map:e.getUniformLocation(s,"map"),opacity:e.getUniformLocation(s,"opacity"),modelViewMatrix:e.getUniformLocation(s,"modelViewMatrix"),projectionMatrix:e.getUniformLocation(s,"projectionMatrix"),fogType:e.getUniformLocation(s,"fogType"),fogDensity:e.getUniformLocation(s,"fogDensity"),fogNear:e.getUniformLocation(s,"fogNear"),fogFar:e.getUniformLocation(s,"fogFar"),fogColor:e.getUniformLocation(s,"fogColor"),fogDepth:e.getUniformLocation(s,"fogDepth"),alphaTest:e.getUniformLocation(s,"alphaTest")};var r=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");r.width=8,r.height=8;var u=r.getContext("2d");u.fillStyle="white",u.fillRect(0,0,8,8),c=new gn(r)}function m(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.z!==e.z?e.z-t.z:e.id-t.id}this.render=function(n,g,v){if(0!==n.length){void 0===s&&f(),i.useProgram(s),i.initAttributes(),i.enableAttribute(h.position),i.enableAttribute(h.uv),i.disableUnusedAttributes(),i.disable(e.CULL_FACE),i.enable(e.BLEND),e.bindBuffer(e.ARRAY_BUFFER,o),e.vertexAttribPointer(h.position,2,e.FLOAT,!1,16,0),e.vertexAttribPointer(h.uv,2,e.FLOAT,!1,16,8),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,a),e.uniformMatrix4fv(l.projectionMatrix,!1,v.projectionMatrix.elements),i.activeTexture(e.TEXTURE0),e.uniform1i(l.map,0);var y=0,E=0,x=g.fog;x?(e.uniform3f(l.fogColor,x.color.r,x.color.g,x.color.b),x.isFog?(e.uniform1f(l.fogNear,x.near),e.uniform1f(l.fogFar,x.far),e.uniform1i(l.fogType,1),y=1,E=1):x.isFogExp2&&(e.uniform1f(l.fogDensity,x.density),e.uniform1i(l.fogType,2),y=2,E=2)):(e.uniform1i(l.fogType,0),y=0,E=0);for(var _=0,w=n.length;_<w;_++){(T=n[_]).modelViewMatrix.multiplyMatrices(v.matrixWorldInverse,T.matrixWorld),T.z=-T.modelViewMatrix.elements[14]}n.sort(m);var b=[],S=[];for(_=0,w=n.length;_<w;_++){var T,M=(T=n[_]).material;if(!1!==M.visible){T.onBeforeRender(t,g,v,void 0,M,void 0),e.uniform1f(l.alphaTest,M.alphaTest),e.uniformMatrix4fv(l.modelViewMatrix,!1,T.modelViewMatrix.elements),T.matrixWorld.decompose(u,p,d),b[0]=d.x,b[1]=d.y,S[0]=T.center.x-.5,S[1]=T.center.y-.5;var R=0;g.fog&&M.fog&&(R=E),y!==R&&(e.uniform1i(l.fogType,R),y=R),null!==M.map?(e.uniform2f(l.uvOffset,M.map.offset.x,M.map.offset.y),e.uniform2f(l.uvScale,M.map.repeat.x,M.map.repeat.y)):(e.uniform2f(l.uvOffset,0,0),e.uniform2f(l.uvScale,1,1)),e.uniform1f(l.opacity,M.opacity),e.uniform3f(l.color,M.color.r,M.color.g,M.color.b),e.uniform1f(l.rotation,M.rotation),e.uniform2fv(l.center,S),e.uniform2fv(l.scale,b),i.setBlending(M.blending,M.blendEquation,M.blendSrc,M.blendDst,M.blendEquationAlpha,M.blendSrcAlpha,M.blendDstAlpha,M.premultipliedAlpha),i.buffers.depth.setTest(M.depthTest),i.buffers.depth.setMask(M.depthWrite),i.buffers.color.setMask(M.colorWrite),r.setTexture2D(M.map||c,0),e.drawElements(e.TRIANGLES,6,e.UNSIGNED_SHORT,0),T.onAfterRender(t,g,v,void 0,M,void 0)}}i.enable(e.CULL_FACE),i.reset()}}}function yn(t,e,i,r,n,o,a){var s,h="undefined"!=typeof WebGL2RenderingContext&&t instanceof WebGL2RenderingContext,l={};function c(t,e){if(t.width>e||t.height>e){if("data"in t)return;var i=e/Math.max(t.width,t.height),r=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");return r.width=Math.floor(t.width*i),r.height=Math.floor(t.height*i),r.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,r.width,r.height),r}return t}function u(t){return Ce.isPowerOfTwo(t.width)&&Ce.isPowerOfTwo(t.height)}function p(t,e){return t.generateMipmaps&&e&&t.minFilter!==yt&&t.minFilter!==_t}function d(e,i,n,o){t.generateMipmap(e),r.get(i).__maxMipLevel=Math.log(Math.max(n,o))*Math.LOG2E}function f(e){return e===yt||e===Et||e===xt?t.NEAREST:t.LINEAR}function m(e){var i=e.target;i.removeEventListener("dispose",m),function(e){var i=r.get(e);if(e.image&&i.__image__webglTextureCube)t.deleteTexture(i.__image__webglTextureCube);else{if(void 0===i.__webglInit)return;t.deleteTexture(i.__webglTexture)}r.remove(e)}(i),i.isVideoTexture&&delete l[i.id],a.memory.textures--}function g(e){var i=e.target;i.removeEventListener("dispose",g),function(e){var i=r.get(e),n=r.get(e.texture);if(!e)return;void 0!==n.__webglTexture&&t.deleteTexture(n.__webglTexture);e.depthTexture&&e.depthTexture.dispose();if(e.isWebGLRenderTargetCube)for(var o=0;o<6;o++)t.deleteFramebuffer(i.__webglFramebuffer[o]),i.__webglDepthbuffer&&t.deleteRenderbuffer(i.__webglDepthbuffer[o]);else t.deleteFramebuffer(i.__webglFramebuffer),i.__webglDepthbuffer&&t.deleteRenderbuffer(i.__webglDepthbuffer);r.remove(e.texture),r.remove(e)}(i),a.memory.textures--}function v(e,f){var g=r.get(e);if(e.isVideoTexture&&function(t){var e=t.id,i=a.render.frame;l[e]!==i&&(l[e]=i,t.update())}(e),e.version>0&&g.__version!==e.version){var v=e.image;if(void 0===v);else if(!1!==v.complete)return void function(e,r,l){void 0===e.__webglInit&&(e.__webglInit=!0,r.addEventListener("dispose",m),e.__webglTexture=t.createTexture(),a.memory.textures++);i.activeTexture(t.TEXTURE0+l),i.bindTexture(t.TEXTURE_2D,e.__webglTexture),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,r.flipY),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,r.premultiplyAlpha),t.pixelStorei(t.UNPACK_ALIGNMENT,r.unpackAlignment);var f=c(r.image,n.maxTextureSize);(function(t){return t.wrapS!==gt||t.wrapT!==gt||t.minFilter!==yt&&t.minFilter!==_t})(r)&&!1===u(f)&&(f=function(t){return t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageBitmap?(void 0===s&&(s=document.createElementNS("http://www.w3.org/1999/xhtml","canvas")),s.width=Ce.floorPowerOfTwo(t.width),s.height=Ce.floorPowerOfTwo(t.height),s.getContext("2d").drawImage(t,0,0,s.width,s.height),s):t}(f));var g=u(f),v=o.convert(r.format),E=o.convert(r.type);y(t.TEXTURE_2D,r,g);var x,_=r.mipmaps;if(r.isDepthTexture){var w=t.DEPTH_COMPONENT;if(r.type===Pt){if(!h)throw new Error("Float Depth Texture only supported in WebGL2.0");w=t.DEPTH_COMPONENT32F}else h&&(w=t.DEPTH_COMPONENT16);r.format===Ft&&w===t.DEPTH_COMPONENT&&r.type!==Rt&&r.type!==Ct&&(r.type=Rt,E=o.convert(r.type)),r.format===Ut&&(w=t.DEPTH_STENCIL,r.type!==It&&(r.type=It,E=o.convert(r.type))),i.texImage2D(t.TEXTURE_2D,0,w,f.width,f.height,0,v,E,null)}else if(r.isDataTexture)if(_.length>0&&g){for(var b=0,S=_.length;b<S;b++)x=_[b],i.texImage2D(t.TEXTURE_2D,b,v,x.width,x.height,0,v,E,x.data);r.generateMipmaps=!1,e.__maxMipLevel=_.length-1}else i.texImage2D(t.TEXTURE_2D,0,v,f.width,f.height,0,v,E,f.data),e.__maxMipLevel=0;else if(r.isCompressedTexture){for(var b=0,S=_.length;b<S;b++)x=_[b],r.format!==Nt&&r.format!==zt?i.getCompressedTextureFormats().indexOf(v)>-1&&i.compressedTexImage2D(t.TEXTURE_2D,b,v,x.width,x.height,0,x.data):i.texImage2D(t.TEXTURE_2D,b,v,x.width,x.height,0,v,E,x.data);e.__maxMipLevel=_.length-1}else if(_.length>0&&g){for(var b=0,S=_.length;b<S;b++)x=_[b],i.texImage2D(t.TEXTURE_2D,b,v,v,E,x);r.generateMipmaps=!1,e.__maxMipLevel=_.length-1}else i.texImage2D(t.TEXTURE_2D,0,v,v,E,f),e.__maxMipLevel=0;p(r,g)&&d(t.TEXTURE_2D,r,f.width,f.height);e.__version=r.version,r.onUpdate&&r.onUpdate(r)}(g,e,f)}i.activeTexture(t.TEXTURE0+f),i.bindTexture(t.TEXTURE_2D,g.__webglTexture)}function y(i,a,s){var h;if(s?(t.texParameteri(i,t.TEXTURE_WRAP_S,o.convert(a.wrapS)),t.texParameteri(i,t.TEXTURE_WRAP_T,o.convert(a.wrapT)),t.texParameteri(i,t.TEXTURE_MAG_FILTER,o.convert(a.magFilter)),t.texParameteri(i,t.TEXTURE_MIN_FILTER,o.convert(a.minFilter))):(t.texParameteri(i,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(i,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),a.wrapS!==gt||a.wrapT,t.texParameteri(i,t.TEXTURE_MAG_FILTER,f(a.magFilter)),t.texParameteri(i,t.TEXTURE_MIN_FILTER,f(a.minFilter)),a.minFilter!==yt&&a.minFilter),h=e.get("EXT_texture_filter_anisotropic")){if(a.type===Pt&&null===e.get("OES_texture_float_linear"))return;if(a.type===Dt&&null===e.get("OES_texture_half_float_linear"))return;(a.anisotropy>1||r.get(a).__currentAnisotropy)&&(t.texParameterf(i,h.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(a.anisotropy,n.getMaxAnisotropy())),r.get(a).__currentAnisotropy=a.anisotropy)}}function E(e,n,a,s){var h=o.convert(n.texture.format),l=o.convert(n.texture.type);i.texImage2D(s,0,h,n.width,n.height,0,h,l,null),t.bindFramebuffer(t.FRAMEBUFFER,e),t.framebufferTexture2D(t.FRAMEBUFFER,a,s,r.get(n.texture).__webglTexture,0),t.bindFramebuffer(t.FRAMEBUFFER,null)}function x(e,i){t.bindRenderbuffer(t.RENDERBUFFER,e),i.depthBuffer&&!i.stencilBuffer?(t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_COMPONENT16,i.width,i.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.RENDERBUFFER,e)):i.depthBuffer&&i.stencilBuffer?(t.renderbufferStorage(t.RENDERBUFFER,t.DEPTH_STENCIL,i.width,i.height),t.framebufferRenderbuffer(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.RENDERBUFFER,e)):t.renderbufferStorage(t.RENDERBUFFER,t.RGBA4,i.width,i.height),t.bindRenderbuffer(t.RENDERBUFFER,null)}function _(e){var i=r.get(e),n=!0===e.isWebGLRenderTargetCube;if(e.depthTexture){if(n)throw new Error("target.depthTexture not supported in Cube render targets");!function(e,i){if(i&&i.isWebGLRenderTargetCube)throw new Error("Depth Texture with cube render targets is not supported");if(t.bindFramebuffer(t.FRAMEBUFFER,e),!i.depthTexture||!i.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");r.get(i.depthTexture).__webglTexture&&i.depthTexture.image.width===i.width&&i.depthTexture.image.height===i.height||(i.depthTexture.image.width=i.width,i.depthTexture.image.height=i.height,i.depthTexture.needsUpdate=!0),v(i.depthTexture,0);var n=r.get(i.depthTexture).__webglTexture;if(i.depthTexture.format===Ft)t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_ATTACHMENT,t.TEXTURE_2D,n,0);else{if(i.depthTexture.format!==Ut)throw new Error("Unknown depthTexture format");t.framebufferTexture2D(t.FRAMEBUFFER,t.DEPTH_STENCIL_ATTACHMENT,t.TEXTURE_2D,n,0)}}(i.__webglFramebuffer,e)}else if(n){i.__webglDepthbuffer=[];for(var o=0;o<6;o++)t.bindFramebuffer(t.FRAMEBUFFER,i.__webglFramebuffer[o]),i.__webglDepthbuffer[o]=t.createRenderbuffer(),x(i.__webglDepthbuffer[o],e)}else t.bindFramebuffer(t.FRAMEBUFFER,i.__webglFramebuffer),i.__webglDepthbuffer=t.createRenderbuffer(),x(i.__webglDepthbuffer,e);t.bindFramebuffer(t.FRAMEBUFFER,null)}this.setTexture2D=v,this.setTextureCube=function(e,s){var h=r.get(e);if(6===e.image.length)if(e.version>0&&h.__version!==e.version){h.__image__webglTextureCube||(e.addEventListener("dispose",m),h.__image__webglTextureCube=t.createTexture(),a.memory.textures++),i.activeTexture(t.TEXTURE0+s),i.bindTexture(t.TEXTURE_CUBE_MAP,h.__image__webglTextureCube),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e.flipY);for(var l=e&&e.isCompressedTexture,f=e.image[0]&&e.image[0].isDataTexture,g=[],v=0;v<6;v++)g[v]=l||f?f?e.image[v].image:e.image[v]:c(e.image[v],n.maxCubemapSize);var E=g[0],x=u(E),_=o.convert(e.format),w=o.convert(e.type);for(y(t.TEXTURE_CUBE_MAP,e,x),v=0;v<6;v++)if(l)for(var b,S=g[v].mipmaps,T=0,M=S.length;T<M;T++)b=S[T],e.format!==Nt&&e.format!==zt?i.getCompressedTextureFormats().indexOf(_)>-1&&i.compressedTexImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+v,T,_,b.width,b.height,0,b.data):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+v,T,_,b.width,b.height,0,_,w,b.data);else f?i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+v,0,_,g[v].width,g[v].height,0,_,w,g[v].data):i.texImage2D(t.TEXTURE_CUBE_MAP_POSITIVE_X+v,0,_,_,w,g[v]);h.__maxMipLevel=l?S.length-1:0,p(e,x)&&d(t.TEXTURE_CUBE_MAP,e,E.width,E.height),h.__version=e.version,e.onUpdate&&e.onUpdate(e)}else i.activeTexture(t.TEXTURE0+s),i.bindTexture(t.TEXTURE_CUBE_MAP,h.__image__webglTextureCube)},this.setTextureCubeDynamic=function(e,n){i.activeTexture(t.TEXTURE0+n),i.bindTexture(t.TEXTURE_CUBE_MAP,r.get(e).__webglTexture)},this.setupRenderTarget=function(e){var n=r.get(e),o=r.get(e.texture);e.addEventListener("dispose",g),o.__webglTexture=t.createTexture(),a.memory.textures++;var s=!0===e.isWebGLRenderTargetCube,h=u(e);if(s){n.__webglFramebuffer=[];for(var l=0;l<6;l++)n.__webglFramebuffer[l]=t.createFramebuffer()}else n.__webglFramebuffer=t.createFramebuffer();if(s){for(i.bindTexture(t.TEXTURE_CUBE_MAP,o.__webglTexture),y(t.TEXTURE_CUBE_MAP,e.texture,h),l=0;l<6;l++)E(n.__webglFramebuffer[l],e,t.COLOR_ATTACHMENT0,t.TEXTURE_CUBE_MAP_POSITIVE_X+l);p(e.texture,h)&&d(t.TEXTURE_CUBE_MAP,e.texture,e.width,e.height),i.bindTexture(t.TEXTURE_CUBE_MAP,null)}else i.bindTexture(t.TEXTURE_2D,o.__webglTexture),y(t.TEXTURE_2D,e.texture,h),E(n.__webglFramebuffer,e,t.COLOR_ATTACHMENT0,t.TEXTURE_2D),p(e.texture,h)&&d(t.TEXTURE_2D,e.texture,e.width,e.height),i.bindTexture(t.TEXTURE_2D,null);e.depthBuffer&&_(e)},this.updateRenderTargetMipmap=function(e){var n=e.texture;if(p(n,u(e))){var o=e.isWebGLRenderTargetCube?t.TEXTURE_CUBE_MAP:t.TEXTURE_2D,a=r.get(n).__webglTexture;i.bindTexture(o,a),d(o,n,e.width,e.height),i.bindTexture(o,null)}}}function En(t,e){return{convert:function(i){var r;if(i===mt)return t.REPEAT;if(i===gt)return t.CLAMP_TO_EDGE;if(i===vt)return t.MIRRORED_REPEAT;if(i===yt)return t.NEAREST;if(i===Et)return t.NEAREST_MIPMAP_NEAREST;if(i===xt)return t.NEAREST_MIPMAP_LINEAR;if(i===_t)return t.LINEAR;if(i===wt)return t.LINEAR_MIPMAP_NEAREST;if(i===bt)return t.LINEAR_MIPMAP_LINEAR;if(i===St)return t.UNSIGNED_BYTE;if(i===Lt)return t.UNSIGNED_SHORT_4_4_4_4;if(i===Ot)return t.UNSIGNED_SHORT_5_5_5_1;if(i===Ht)return t.UNSIGNED_SHORT_5_6_5;if(i===Tt)return t.BYTE;if(i===Mt)return t.SHORT;if(i===Rt)return t.UNSIGNED_SHORT;if(i===At)return t.INT;if(i===Ct)return t.UNSIGNED_INT;if(i===Pt)return t.FLOAT;if(i===Dt&&null!==(r=e.get("OES_texture_half_float")))return r.HALF_FLOAT_OES;if(i===Bt)return t.ALPHA;if(i===zt)return t.RGB;if(i===Nt)return t.RGBA;if(i===kt)return t.LUMINANCE;if(i===jt)return t.LUMINANCE_ALPHA;if(i===Ft)return t.DEPTH_COMPONENT;if(i===Ut)return t.DEPTH_STENCIL;if(i===P)return t.FUNC_ADD;if(i===D)return t.FUNC_SUBTRACT;if(i===L)return t.FUNC_REVERSE_SUBTRACT;if(i===I)return t.ZERO;if(i===B)return t.ONE;if(i===z)return t.SRC_COLOR;if(i===N)return t.ONE_MINUS_SRC_COLOR;if(i===k)return t.SRC_ALPHA;if(i===j)return t.ONE_MINUS_SRC_ALPHA;if(i===V)return t.DST_ALPHA;if(i===F)return t.ONE_MINUS_DST_ALPHA;if(i===U)return t.DST_COLOR;if(i===G)return t.ONE_MINUS_DST_COLOR;if(i===W)return t.SRC_ALPHA_SATURATE;if((i===Gt||i===Wt||i===Xt||i===Zt)&&null!==(r=e.get("WEBGL_compressed_texture_s3tc"))){if(i===Gt)return r.COMPRESSED_RGB_S3TC_DXT1_EXT;if(i===Wt)return r.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(i===Xt)return r.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(i===Zt)return r.COMPRESSED_RGBA_S3TC_DXT5_EXT}if((i===Yt||i===qt||i===Jt||i===Qt)&&null!==(r=e.get("WEBGL_compressed_texture_pvrtc"))){if(i===Yt)return r.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(i===qt)return r.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(i===Jt)return r.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(i===Qt)return r.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(i===Kt&&null!==(r=e.get("WEBGL_compressed_texture_etc1")))return r.COMPRESSED_RGB_ETC1_WEBGL;if((i===$t||i===te||i===ee||i===ie||i===re||i===ne||i===oe||i===ae||i===se||i===he||i===le||i===ce||i===ue||i===pe)&&null!==(r=e.get("WEBGL_compressed_texture_astc")))return i;if((i===O||i===H)&&null!==(r=e.get("EXT_blend_minmax"))){if(i===O)return r.MIN_EXT;if(i===H)return r.MAX_EXT}return i===It&&null!==(r=e.get("WEBGL_depth_texture"))?r.UNSIGNED_INT_24_8_WEBGL:0}}}function xn(){di.call(this),this.type="Group"}function _n(t,e,i,r){fi.call(this),this.type="PerspectiveCamera",this.fov=void 0!==t?t:50,this.zoom=1,this.near=void 0!==i?i:.1,this.far=void 0!==r?r:2e3,this.focus=10,this.aspect=void 0!==e?e:1,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}function wn(t){_n.call(this),this.cameras=t||[]}function bn(t){var e=this,i=null,r=null,n=null,o=[],a=new De,s=new De;"undefined"!=typeof window&&"VRFrameData"in window&&(r=new window.VRFrameData,window.addEventListener("vrdisplaypresentchange",v,!1));var h=new De,l=new Le,c=new Oe,u=new _n;u.bounds=new Fe(0,0,.5,1),u.layers.enable(1);var p=new _n;p.bounds=new Fe(.5,0,.5,1),p.layers.enable(2);var d,f,m=new wn([u,p]);function g(){return null!==i&&!0===i.isPresenting}function v(){if(g()){var r=i.getEyeParameters("left"),n=r.renderWidth,o=r.renderHeight;f=t.getPixelRatio(),d=t.getSize(),t.setDrawingBufferSize(2*n,o,1),x.start()}else e.enabled&&(t.setDrawingBufferSize(d.width,d.height,f),x.stop())}m.layers.enable(1),m.layers.enable(2);var y=!1;function E(t){for(var e=navigator.getGamepads&&navigator.getGamepads(),i=0,r=0,n=e.length;i<n;i++){var o=e[i];if(o&&("Daydream Controller"===o.id||"Gear VR Controller"===o.id||"Oculus Go Controller"===o.id||"OpenVR Gamepad"===o.id||o.id.startsWith("Oculus Touch")||o.id.startsWith("Spatial Controller"))){if(r===t)return o;r++}}}this.enabled=!1,this.userHeight=1.6,this.getController=function(t){var e=o[t];return void 0===e&&((e=new xn).matrixAutoUpdate=!1,e.visible=!1,o[t]=e),e},this.getDevice=function(){return i},this.setDevice=function(t){void 0!==t&&(i=t),x.setContext(t)},this.setPoseTarget=function(t){void 0!==t&&(n=t)},this.getCamera=function(t){if(null===i)return t.position.set(0,e.userHeight,0),t;i.depthNear=t.near,i.depthFar=t.far,i.getFrameData(r);var d=i.stageParameters;d?a.fromArray(d.sittingToStandingTransform):a.makeTranslation(0,e.userHeight,0);var f=r.pose,g=null!==n?n:t;if(g.matrix.copy(a),g.matrix.decompose(g.position,g.quaternion,g.scale),null!==f.orientation&&(l.fromArray(f.orientation),g.quaternion.multiply(l)),null!==f.position&&(l.setFromRotationMatrix(a),c.fromArray(f.position),c.applyQuaternion(l),g.position.add(c)),g.updateMatrixWorld(),!1===i.isPresenting)return t;u.near=t.near,p.near=t.near,u.far=t.far,p.far=t.far,m.matrixWorld.copy(t.matrixWorld),m.matrixWorldInverse.copy(t.matrixWorldInverse),u.matrixWorldInverse.fromArray(r.leftViewMatrix),p.matrixWorldInverse.fromArray(r.rightViewMatrix),s.getInverse(a),u.matrixWorldInverse.multiply(s),p.matrixWorldInverse.multiply(s);var v=g.parent;null!==v&&(h.getInverse(v.matrixWorld),u.matrixWorldInverse.multiply(h),p.matrixWorldInverse.multiply(h)),u.matrixWorld.getInverse(u.matrixWorldInverse),p.matrixWorld.getInverse(p.matrixWorldInverse),u.projectionMatrix.fromArray(r.leftProjectionMatrix),p.projectionMatrix.fromArray(r.rightProjectionMatrix),m.projectionMatrix.copy(u.projectionMatrix);var x=i.getLayers();if(x.length){var _=x[0];null!==_.leftBounds&&4===_.leftBounds.length&&u.bounds.fromArray(_.leftBounds),null!==_.rightBounds&&4===_.rightBounds.length&&p.bounds.fromArray(_.rightBounds)}return function(){for(var t=0;t<o.length;t++){var e=o[t],i=E(t);if(void 0!==i&&void 0!==i.pose){if(null===i.pose)return;var r=i.pose;!1===r.hasPosition&&e.position.set(.2,-.6,-.05),null!==r.position&&e.position.fromArray(r.position),null!==r.orientation&&e.quaternion.fromArray(r.orientation),e.matrix.compose(e.position,e.quaternion,e.scale),e.matrix.premultiply(a),e.matrix.decompose(e.position,e.quaternion,e.scale),e.matrixWorldNeedsUpdate=!0,e.visible=!0;var n="Daydream Controller"===i.id?0:1;y!==i.buttons[n].pressed&&((y=i.buttons[n].pressed)?e.dispatchEvent({type:"selectstart"}):(e.dispatchEvent({type:"selectend"}),e.dispatchEvent({type:"select"})))}else e.visible=!1}}(),m},this.getStandingMatrix=function(){return a},this.isPresenting=g;var x=new ni;this.setAnimationLoop=function(t){x.setAnimationLoop(t)},this.submitFrame=function(){g()&&i.submitFrame()},this.dispose=function(){"undefined"!=typeof window&&window.removeEventListener("vrdisplaypresentchange",v)}}function Sn(t){var e=void 0!==(t=t||{}).canvas?t.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),i=void 0!==t.context?t.context:null,r=void 0!==t.alpha&&t.alpha,n=void 0===t.depth||t.depth,o=void 0===t.stencil||t.stencil,a=void 0!==t.antialias&&t.antialias,s=void 0===t.premultipliedAlpha||t.premultipliedAlpha,h=void 0!==t.preserveDrawingBuffer&&t.preserveDrawingBuffer,l=void 0!==t.powerPreference?t.powerPreference:"default",c=null,u=null;this.domElement=e,this.context=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.gammaInput=!1,this.gammaOutput=!1,this.physicallyCorrectLights=!1,this.toneMapping=nt,this.toneMappingExposure=1,this.toneMappingWhitePoint=1,this.maxMorphTargets=8,this.maxMorphNormals=4;var p,g,v,y,w,b,P,D,L,O,H,I,B,z,N,k,j,V,F,U=this,G=!1,W=null,tt=null,et=null,it=-1,rt="",ot=null,at=null,st=new Fe,ht=new Fe,lt=null,ct=0,ut=e.width,pt=e.height,dt=1,ft=new Fe(0,0,ut,pt),mt=new Fe(0,0,ut,pt),gt=!1,vt=new qe,yt=new function(){var t=this,e=null,i=0,r=!1,n=!1,o=new Ye,a=new He,s={value:null,needsUpdate:!1};function h(){s.value!==e&&(s.value=e,s.needsUpdate=i>0),t.numPlanes=i,t.numIntersection=0}function l(e,i,r,n){var h=null!==e?e.length:0,l=null;if(0!==h){if(l=s.value,!0!==n||null===l){var c=r+4*h,u=i.matrixWorldInverse;a.getNormalMatrix(u),(null===l||l.length<c)&&(l=new Float32Array(c));for(var p=0,d=r;p!==h;++p,d+=4)o.copy(e[p]).applyMatrix4(u,a),o.normal.toArray(l,d),l[d+3]=o.constant}s.value=l,s.needsUpdate=!0}return t.numPlanes=h,l}this.uniform=s,this.numPlanes=0,this.numIntersection=0,this.init=function(t,n,o){var a=0!==t.length||n||0!==i||r;return r=n,e=l(t,o,0),i=t.length,a},this.beginShadows=function(){n=!0,l(null)},this.endShadows=function(){n=!1,h()},this.setState=function(t,o,a,c,u,p){if(!r||null===t||0===t.length||n&&!a)n?l(null):h();else{var d=n?0:i,f=4*d,m=u.clippingState||null;s.value=m,m=l(t,c,f,p);for(var g=0;g!==f;++g)m[g]=e[g];u.clippingState=m,this.numIntersection=o?this.numPlanes:0,this.numPlanes+=d}}},Et=!1,xt=!1,_t=new De,wt=new Oe;function bt(){return null===tt?dt:1}try{var Tt={alpha:r,depth:n,stencil:o,antialias:a,premultipliedAlpha:s,preserveDrawingBuffer:h,powerPreference:l};if(e.addEventListener("webglcontextlost",Ct,!1),e.addEventListener("webglcontextrestored",Lt,!1),null===(p=i||e.getContext("webgl",Tt)||e.getContext("experimental-webgl",Tt)))throw null!==e.getContext("webgl")?new Error("Error creating WebGL context with your selected attributes."):new Error("Error creating WebGL context.");void 0===p.getShaderPrecisionFormat&&(p.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}})}catch(t){}function Mt(){(g=new function(t){var e={};return{get:function(i){if(void 0!==e[i])return e[i];var r;switch(i){case"WEBGL_depth_texture":r=t.getExtension("WEBGL_depth_texture")||t.getExtension("MOZ_WEBGL_depth_texture")||t.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":r=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":r=t.getExtension("WEBGL_compressed_texture_s3tc")||t.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":r=t.getExtension("WEBGL_compressed_texture_pvrtc")||t.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;default:r=t.getExtension(i)}return e[i]=r,r}}}(p)).get("WEBGL_depth_texture"),g.get("OES_texture_float"),g.get("OES_texture_float_linear"),g.get("OES_texture_half_float"),g.get("OES_texture_half_float_linear"),g.get("OES_standard_derivatives"),g.get("OES_element_index_uint"),g.get("ANGLE_instanced_arrays"),F=new En(p,g),v=new function(t,e,i){var r;function n(e){if("highp"===e){if(t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT).precision>0)return"highp";e="mediump"}return"mediump"===e&&t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT).precision>0&&t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}var o=void 0!==i.precision?i.precision:"highp",a=n(o);a!==o&&(o=a);var s=!0===i.logarithmicDepthBuffer,h=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),l=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),c=t.getParameter(t.MAX_TEXTURE_SIZE),u=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),p=t.getParameter(t.MAX_VERTEX_ATTRIBS),d=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),f=t.getParameter(t.MAX_VARYING_VECTORS),m=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),g=l>0,v=!!e.get("OES_texture_float");return{getMaxAnisotropy:function(){if(void 0!==r)return r;var i=e.get("EXT_texture_filter_anisotropic");return r=null!==i?t.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0},getMaxPrecision:n,precision:o,logarithmicDepthBuffer:s,maxTextures:h,maxVertexTextures:l,maxTextureSize:c,maxCubemapSize:u,maxAttributes:p,maxVertexUniforms:d,maxVaryings:f,maxFragmentUniforms:m,vertexTextures:g,floatFragmentTextures:v,floatVertexTextures:g&&v}}(p,g,t),(y=new function(t,e,i){var r=new function(){var e=!1,i=new Fe,r=null,n=new Fe(0,0,0,0);return{setMask:function(i){r===i||e||(t.colorMask(i,i,i,i),r=i)},setLocked:function(t){e=t},setClear:function(e,r,o,a,s){!0===s&&(e*=a,r*=a,o*=a),i.set(e,r,o,a),!1===n.equals(i)&&(t.clearColor(e,r,o,a),n.copy(i))},reset:function(){e=!1,r=null,n.set(-1,0,0,0)}}},n=new function(){var e=!1,i=null,r=null,n=null;return{setTest:function(e){e?it(t.DEPTH_TEST):rt(t.DEPTH_TEST)},setMask:function(r){i===r||e||(t.depthMask(r),i=r)},setFunc:function(e){if(r!==e){if(e)switch(e){case X:t.depthFunc(t.NEVER);break;case Z:t.depthFunc(t.ALWAYS);break;case Y:t.depthFunc(t.LESS);break;case q:t.depthFunc(t.LEQUAL);break;case J:t.depthFunc(t.EQUAL);break;case Q:t.depthFunc(t.GEQUAL);break;case K:t.depthFunc(t.GREATER);break;case $:t.depthFunc(t.NOTEQUAL);break;default:t.depthFunc(t.LEQUAL)}else t.depthFunc(t.LEQUAL);r=e}},setLocked:function(t){e=t},setClear:function(e){n!==e&&(t.clearDepth(e),n=e)},reset:function(){e=!1,i=null,r=null,n=null}}},o=new function(){var e=!1,i=null,r=null,n=null,o=null,a=null,s=null,h=null,l=null;return{setTest:function(e){e?it(t.STENCIL_TEST):rt(t.STENCIL_TEST)},setMask:function(r){i===r||e||(t.stencilMask(r),i=r)},setFunc:function(e,i,a){r===e&&n===i&&o===a||(t.stencilFunc(e,i,a),r=e,n=i,o=a)},setOp:function(e,i,r){a===e&&s===i&&h===r||(t.stencilOp(e,i,r),a=e,s=i,h=r)},setLocked:function(t){e=t},setClear:function(e){l!==e&&(t.clearStencil(e),l=e)},reset:function(){e=!1,i=null,r=null,n=null,o=null,a=null,s=null,h=null,l=null}}},a=t.getParameter(t.MAX_VERTEX_ATTRIBS),s=new Uint8Array(a),h=new Uint8Array(a),l=new Uint8Array(a),c={},u=null,p=null,g=null,v=null,y=null,_=null,w=null,b=null,P=null,D=!1,L=null,O=null,H=null,I=null,B=null,z=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),N=!1,k=0,j=t.getParameter(t.VERSION);-1!==j.indexOf("WebGL")?(k=parseFloat(/^WebGL\ ([0-9])/.exec(j)[1]),N=k>=1):-1!==j.indexOf("OpenGL ES")&&(k=parseFloat(/^OpenGL\ ES\ ([0-9])/.exec(j)[1]),N=k>=2);var V=null,F={},U=new Fe,G=new Fe;function W(e,i,r){var n=new Uint8Array(4),o=t.createTexture();t.bindTexture(e,o),t.texParameteri(e,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(e,t.TEXTURE_MAG_FILTER,t.NEAREST);for(var a=0;a<r;a++)t.texImage2D(i+a,0,t.RGBA,1,1,0,t.RGBA,t.UNSIGNED_BYTE,n);return o}var tt={};function et(i,r){s[i]=1,0===h[i]&&(t.enableVertexAttribArray(i),h[i]=1),l[i]!==r&&(e.get("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(i,r),l[i]=r)}function it(e){!0!==c[e]&&(t.enable(e),c[e]=!0)}function rt(e){!1!==c[e]&&(t.disable(e),c[e]=!1)}function nt(e,r,n,o,a,s,h,l){if(e!==S?it(t.BLEND):rt(t.BLEND),e!==C){if(e!==g||l!==D)switch(e){case M:l?(t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ONE,t.ONE,t.ONE)):(t.blendEquation(t.FUNC_ADD),t.blendFunc(t.SRC_ALPHA,t.ONE));break;case R:l?(t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ZERO,t.ZERO,t.ONE_MINUS_SRC_COLOR,t.ONE_MINUS_SRC_ALPHA)):(t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ZERO,t.ONE_MINUS_SRC_COLOR));break;case A:l?(t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ZERO,t.SRC_COLOR,t.ZERO,t.SRC_ALPHA)):(t.blendEquation(t.FUNC_ADD),t.blendFunc(t.ZERO,t.SRC_COLOR));break;default:l?(t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.ONE,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA)):(t.blendEquationSeparate(t.FUNC_ADD,t.FUNC_ADD),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA))}v=null,y=null,_=null,w=null,b=null,P=null}else a=a||r,s=s||n,h=h||o,r===v&&a===w||(t.blendEquationSeparate(i.convert(r),i.convert(a)),v=r,w=a),n===y&&o===_&&s===b&&h===P||(t.blendFuncSeparate(i.convert(n),i.convert(o),i.convert(s),i.convert(h)),y=n,_=o,b=s,P=h);g=e,D=l}function ot(e){L!==e&&(e?t.frontFace(t.CW):t.frontFace(t.CCW),L=e)}function at(e){e!==d?(it(t.CULL_FACE),e!==O&&(e===f?t.cullFace(t.BACK):e===m?t.cullFace(t.FRONT):t.cullFace(t.FRONT_AND_BACK))):rt(t.CULL_FACE),O=e}function st(e,i,r){e?(it(t.POLYGON_OFFSET_FILL),I===i&&B===r||(t.polygonOffset(i,r),I=i,B=r)):rt(t.POLYGON_OFFSET_FILL)}function ht(e){void 0===e&&(e=t.TEXTURE0+z-1),V!==e&&(t.activeTexture(e),V=e)}return tt[t.TEXTURE_2D]=W(t.TEXTURE_2D,t.TEXTURE_2D,1),tt[t.TEXTURE_CUBE_MAP]=W(t.TEXTURE_CUBE_MAP,t.TEXTURE_CUBE_MAP_POSITIVE_X,6),r.setClear(0,0,0,1),n.setClear(1),o.setClear(0),it(t.DEPTH_TEST),n.setFunc(q),ot(!1),at(f),it(t.CULL_FACE),it(t.BLEND),nt(T),{buffers:{color:r,depth:n,stencil:o},initAttributes:function(){for(var t=0,e=s.length;t<e;t++)s[t]=0},enableAttribute:function(t){et(t,0)},enableAttributeAndDivisor:et,disableUnusedAttributes:function(){for(var e=0,i=h.length;e!==i;++e)h[e]!==s[e]&&(t.disableVertexAttribArray(e),h[e]=0)},enable:it,disable:rt,getCompressedTextureFormats:function(){if(null===u&&(u=[],e.get("WEBGL_compressed_texture_pvrtc")||e.get("WEBGL_compressed_texture_s3tc")||e.get("WEBGL_compressed_texture_etc1")||e.get("WEBGL_compressed_texture_astc")))for(var i=t.getParameter(t.COMPRESSED_TEXTURE_FORMATS),r=0;r<i.length;r++)u.push(i[r]);return u},useProgram:function(e){return p!==e&&(t.useProgram(e),p=e,!0)},setBlending:nt,setMaterial:function(e,i){e.side===x?rt(t.CULL_FACE):it(t.CULL_FACE);var o=e.side===E;i&&(o=!o),ot(o),e.blending===T&&!1===e.transparent?nt(S):nt(e.blending,e.blendEquation,e.blendSrc,e.blendDst,e.blendEquationAlpha,e.blendSrcAlpha,e.blendDstAlpha,e.premultipliedAlpha),n.setFunc(e.depthFunc),n.setTest(e.depthTest),n.setMask(e.depthWrite),r.setMask(e.colorWrite),st(e.polygonOffset,e.polygonOffsetFactor,e.polygonOffsetUnits)},setFlipSided:ot,setCullFace:at,setLineWidth:function(e){e!==H&&(N&&t.lineWidth(e),H=e)},setPolygonOffset:st,setScissorTest:function(e){e?it(t.SCISSOR_TEST):rt(t.SCISSOR_TEST)},activeTexture:ht,bindTexture:function(e,i){null===V&&ht();var r=F[V];void 0===r&&(r={type:void 0,texture:void 0},F[V]=r),r.type===e&&r.texture===i||(t.bindTexture(e,i||tt[e]),r.type=e,r.texture=i)},compressedTexImage2D:function(){try{t.compressedTexImage2D.apply(t,arguments)}catch(t){}},texImage2D:function(){try{t.texImage2D.apply(t,arguments)}catch(t){}},scissor:function(e){!1===U.equals(e)&&(t.scissor(e.x,e.y,e.z,e.w),U.copy(e))},viewport:function(e){!1===G.equals(e)&&(t.viewport(e.x,e.y,e.z,e.w),G.copy(e))},reset:function(){for(var e=0;e<h.length;e++)1===h[e]&&(t.disableVertexAttribArray(e),h[e]=0);c={},u=null,V=null,F={},p=null,g=null,L=null,O=null,r.reset(),n.reset(),o.reset()}}}(p,g,F)).scissor(ht.copy(mt).multiplyScalar(dt)),y.viewport(st.copy(ft).multiplyScalar(dt)),w=new function(t){var e={frame:0,calls:0,triangles:0,points:0,lines:0};return{memory:{geometries:0,textures:0},render:e,programs:null,autoReset:!0,reset:function(){e.frame++,e.calls=0,e.triangles=0,e.points=0,e.lines=0},update:function(i,r,n){switch(n=n||1,e.calls++,r){case t.TRIANGLES:e.triangles+=n*(i/3);break;case t.TRIANGLE_STRIP:case t.TRIANGLE_FAN:e.triangles+=n*(i-2);break;case t.LINES:e.lines+=n*(i/2);break;case t.LINE_STRIP:e.lines+=n*(i-1);break;case t.LINE_LOOP:e.lines+=n*i;break;case t.POINTS:e.points+=n*i}}}}(p),b=new function(){var t=new WeakMap;return{get:function(e){var i=t.get(e);return void 0===i&&(i={},t.set(e,i)),i},remove:function(e){t.delete(e)},update:function(e,i,r){t.get(e)[i]=r},dispose:function(){t=new WeakMap}}},P=new yn(p,g,y,b,v,F,w),D=new oi(p),L=new function(t,e,i){var r={},n={};function o(t){var a=t.target,s=r[a.id];for(var h in null!==s.index&&e.remove(s.index),s.attributes)e.remove(s.attributes[h]);a.removeEventListener("dispose",o),delete r[a.id];var l=n[a.id];l&&(e.remove(l),delete n[a.id]),(l=n[s.id])&&(e.remove(l),delete n[s.id]),i.memory.geometries--}return{get:function(t,e){var n=r[e.id];return n||(e.addEventListener("dispose",o),e.isBufferGeometry?n=e:e.isGeometry&&(void 0===e._bufferGeometry&&(e._bufferGeometry=(new Hi).setFromObject(t)),n=e._bufferGeometry),r[e.id]=n,i.memory.geometries++,n)},update:function(i){var r=i.index,n=i.attributes;for(var o in null!==r&&e.update(r,t.ELEMENT_ARRAY_BUFFER),n)e.update(n[o],t.ARRAY_BUFFER);var a=i.morphAttributes;for(var o in a)for(var s=a[o],h=0,l=s.length;h<l;h++)e.update(s[h],t.ARRAY_BUFFER)},getWireframeAttribute:function(i){var r=n[i.id];if(r)return r;var o,a=[],s=i.index,h=i.attributes;if(null!==s)for(var l=0,c=(o=s.array).length;l<c;l+=3){var u=o[l+0],p=o[l+1],d=o[l+2];a.push(u,p,p,d,d,u)}else for(l=0,c=(o=h.position.array).length/3-1;l<c;l+=3)u=l+0,p=l+1,d=l+2,a.push(u,p,p,d,d,u);return r=new(Li(a)>65535?Ai:Mi)(a,1),e.update(r,t.ELEMENT_ARRAY_BUFFER),n[i.id]=r,r}}}(p,D,w),O=new function(t,e){var i={};return{update:function(r){var n=e.render.frame,o=r.geometry,a=t.get(r,o);return i[a.id]!==n&&(o.isGeometry&&a.updateFromObject(r),t.update(a),i[a.id]=n),a},dispose:function(){i={}}}}(L,w),N=new function(t){var e={},i=new Float32Array(8);return{update:function(r,n,o,a){var s=r.morphTargetInfluences,h=s.length,l=e[n.id];if(void 0===l){l=[];for(var c=0;c<h;c++)l[c]=[c,0];e[n.id]=l}var u=o.morphTargets&&n.morphAttributes.position,p=o.morphNormals&&n.morphAttributes.normal;for(c=0;c<h;c++)0!==(d=l[c])[1]&&(u&&n.removeAttribute("morphTarget"+c),p&&n.removeAttribute("morphNormal"+c));for(c=0;c<h;c++)(d=l[c])[0]=c,d[1]=s[c];for(l.sort(tr),c=0;c<8;c++){var d;if(d=l[c]){var f=d[0],m=d[1];if(m){u&&n.addAttribute("morphTarget"+c,u[f]),p&&n.addAttribute("morphNormal"+c,p[f]),i[c]=m;continue}}i[c]=0}a.getUniforms().setValue(t,"morphTargetInfluences",i)}}}(p),H=new tn(U,g,v),I=new nn,B=new pn,z=new function(t,e,i,r){var n,o,a,s=new ti(0),h=0;function l(t,i){e.buffers.color.setClear(t.r,t.g,t.b,i,r)}return{getClearColor:function(){return s},setClearColor:function(t,e){s.set(t),l(s,h=void 0!==e?e:1)},getClearAlpha:function(){return h},setClearAlpha:function(t){l(s,h=t)},render:function(e,r,c,u){var p=r.background;null===p?l(s,h):p&&p.isColor&&(l(p,1),u=!0),(t.autoClear||u)&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),p&&p.isCubeTexture?(void 0===a&&((a=new $i(new Bi(1,1,1),new qi({uniforms:ri.cube.uniforms,vertexShader:ri.cube.vertexShader,fragmentShader:ri.cube.fragmentShader,side:E,depthTest:!0,depthWrite:!1,fog:!1}))).geometry.removeAttribute("normal"),a.geometry.removeAttribute("uv"),a.onBeforeRender=function(t,e,i){this.matrixWorld.copyPosition(i.matrixWorld)},i.update(a)),a.material.uniforms.tCube.value=p,e.push(a,a.geometry,a.material,0,null)):p&&p.isTexture&&(void 0===n&&(n=new mi(-1,1,1,-1,0,1),o=new $i(new Ni(2,2),new Yi({depthTest:!1,depthWrite:!1,fog:!1})),i.update(o)),o.material.map=p,t.renderBufferDirect(n,null,o.geometry,o.material,o,null))}}}(U,y,O,s),k=new function(t,e,i){var r;this.setMode=function(t){r=t},this.render=function(e,n){t.drawArrays(r,e,n),i.update(n,r)},this.renderInstances=function(t,n,o){var a=e.get("ANGLE_instanced_arrays");null!==a&&(a.drawArraysInstancedANGLE(r,n,o,t.maxInstancedCount),i.update(o,r,t.maxInstancedCount))}}(p,g,w),j=new function(t,e,i){var r,n,o;this.setMode=function(t){r=t},this.setIndex=function(t){n=t.type,o=t.bytesPerElement},this.render=function(e,a){t.drawElements(r,a,n,e*o),i.update(a,r)},this.renderInstances=function(t,a,s){var h=e.get("ANGLE_instanced_arrays");null!==h&&(h.drawElementsInstancedANGLE(r,s,n,a*o,t.maxInstancedCount),i.update(s,r,t.maxInstancedCount))}}(p,g,w),V=new vn(U,p,y,P,v),w.programs=H.programs,U.context=p,U.capabilities=v,U.extensions=g,U.properties=b,U.renderLists=I,U.state=y,U.info=w}Mt();var Rt="xr"in navigator?new function(t){var e=t.context,i=null,r=null,n=null,o=null,a=[],s=[];function h(){return null!==r&&null!==n}var l=new _n;l.layers.enable(1),l.viewport=new Fe;var c=new _n;c.layers.enable(2),c.viewport=new Fe;var u=new wn([l,c]);function p(t){var e=a[s.indexOf(t.inputSource)];e&&e.dispatchEvent({type:t.type})}function d(){t.setFramebuffer(null),g.stop()}function f(t,e){null===e?t.matrixWorld.copy(t.matrix):t.matrixWorld.multiplyMatrices(e.matrixWorld,t.matrix),t.matrixWorldInverse.getInverse(t.matrixWorld)}u.layers.enable(1),u.layers.enable(2),this.enabled=!1,this.getController=function(t){var e=a[t];return void 0===e&&((e=new xn).matrixAutoUpdate=!1,e.visible=!1,a[t]=e),e},this.getDevice=function(){return i},this.setDevice=function(t){void 0!==t&&(i=t),e.setCompatibleXRDevice(t)},this.setSession=function(i,o){null!==(r=i)&&(r.addEventListener("select",p),r.addEventListener("selectstart",p),r.addEventListener("selectend",p),r.addEventListener("end",d),r.baseLayer=new XRWebGLLayer(r,e),r.requestFrameOfReference(o.frameOfReferenceType).then(function(e){n=e,t.setFramebuffer(r.baseLayer.framebuffer),g.setContext(r),g.start()}),s=r.getInputSources(),r.addEventListener("inputsourceschange",function(){s=r.getInputSources()}))},this.getCamera=function(t){if(h()){var e=t.parent,i=u.cameras;f(u,e);for(var r=0;r<i.length;r++)f(i[r],e);t.matrixWorld.copy(u.matrixWorld);for(var n=t.children,o=(r=0,n.length);r<o;r++)n[r].updateMatrixWorld(!0);return u}return t},this.isPresenting=h;var m=null,g=new ni;g.setAnimationLoop(function(t,e){if(null!==(o=e.getDevicePose(n)))for(var i=r.baseLayer,h=e.views,l=0;l<h.length;l++){var c=h[l],p=i.getViewport(c),d=o.getViewMatrix(c),f=u.cameras[l];f.matrix.fromArray(d).getInverse(f.matrix),f.projectionMatrix.fromArray(c.projectionMatrix),f.viewport.set(p.x,p.y,p.width,p.height),0===l&&(u.matrix.copy(f.matrix),u.projectionMatrix.copy(f.projectionMatrix))}for(l=0;l<a.length;l++){var g=a[l],v=s[l];if(v){var y=e.getInputPose(v,n);if(null!==y){g.matrix.elements=y.pointerMatrix,g.matrix.decompose(g.position,g.rotation,g.scale),g.visible=!0;continue}}g.visible=!1}m&&m(t)}),this.setAnimationLoop=function(t){m=t},this.dispose=function(){},this.getStandingMatrix=function(){return new THREE.Matrix4},this.submitFrame=function(){}}(U):new bn(U);this.vr=Rt;var At=new mn(U,O,v.maxTextureSize);function Ct(t){t.preventDefault(),G=!0}function Lt(){G=!1,Mt()}function Ot(t){var e=t.target;e.removeEventListener("dispose",Ot),function(t){Ht(t),b.remove(t)}(e)}function Ht(t){var e=b.get(t).program;t.program=void 0,void 0!==e&&H.releaseProgram(e)}this.shadowMap=At,this.getContext=function(){return p},this.getContextAttributes=function(){return p.getContextAttributes()},this.forceContextLoss=function(){var t=g.get("WEBGL_lose_context");t&&t.loseContext()},this.forceContextRestore=function(){var t=g.get("WEBGL_lose_context");t&&t.restoreContext()},this.getPixelRatio=function(){return dt},this.setPixelRatio=function(t){void 0!==t&&(dt=t,this.setSize(ut,pt,!1))},this.getSize=function(){return{width:ut,height:pt}},this.setSize=function(t,i,r){Rt.isPresenting()||(ut=t,pt=i,e.width=t*dt,e.height=i*dt,!1!==r&&(e.style.width=t+"px",e.style.height=i+"px"),this.setViewport(0,0,t,i))},this.getDrawingBufferSize=function(){return{width:ut*dt,height:pt*dt}},this.setDrawingBufferSize=function(t,i,r){ut=t,pt=i,dt=r,e.width=t*r,e.height=i*r,this.setViewport(0,0,t,i)},this.getCurrentViewport=function(){return st},this.setViewport=function(t,e,i,r){ft.set(t,pt-e-r,i,r),y.viewport(st.copy(ft).multiplyScalar(dt))},this.setScissor=function(t,e,i,r){mt.set(t,pt-e-r,i,r),y.scissor(ht.copy(mt).multiplyScalar(dt))},this.setScissorTest=function(t){y.setScissorTest(gt=t)},this.getClearColor=function(){return z.getClearColor()},this.setClearColor=function(){z.setClearColor.apply(z,arguments)},this.getClearAlpha=function(){return z.getClearAlpha()},this.setClearAlpha=function(){z.setClearAlpha.apply(z,arguments)},this.clear=function(t,e,i){var r=0;(void 0===t||t)&&(r|=p.COLOR_BUFFER_BIT),(void 0===e||e)&&(r|=p.DEPTH_BUFFER_BIT),(void 0===i||i)&&(r|=p.STENCIL_BUFFER_BIT),p.clear(r)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.clearTarget=function(t,e,i,r){this.setRenderTarget(t),this.clear(e,i,r)},this.dispose=function(){e.removeEventListener("webglcontextlost",Ct,!1),e.removeEventListener("webglcontextrestored",Lt,!1),I.dispose(),B.dispose(),b.dispose(),O.dispose(),Rt.dispose(),zt.stop()},this.renderBufferImmediate=function(t,e,i){y.initAttributes();var r=b.get(t);t.hasPositions&&!r.position&&(r.position=p.createBuffer()),t.hasNormals&&!r.normal&&(r.normal=p.createBuffer()),t.hasUvs&&!r.uv&&(r.uv=p.createBuffer()),t.hasColors&&!r.color&&(r.color=p.createBuffer());var n=e.getAttributes();if(t.hasPositions&&(p.bindBuffer(p.ARRAY_BUFFER,r.position),p.bufferData(p.ARRAY_BUFFER,t.positionArray,p.DYNAMIC_DRAW),y.enableAttribute(n.position),p.vertexAttribPointer(n.position,3,p.FLOAT,!1,0,0)),t.hasNormals){if(p.bindBuffer(p.ARRAY_BUFFER,r.normal),!i.isMeshPhongMaterial&&!i.isMeshStandardMaterial&&!i.isMeshNormalMaterial&&!0===i.flatShading)for(var o=0,a=3*t.count;o<a;o+=9){var s=t.normalArray,h=(s[o+0]+s[o+3]+s[o+6])/3,l=(s[o+1]+s[o+4]+s[o+7])/3,c=(s[o+2]+s[o+5]+s[o+8])/3;s[o+0]=h,s[o+1]=l,s[o+2]=c,s[o+3]=h,s[o+4]=l,s[o+5]=c,s[o+6]=h,s[o+7]=l,s[o+8]=c}p.bufferData(p.ARRAY_BUFFER,t.normalArray,p.DYNAMIC_DRAW),y.enableAttribute(n.normal),p.vertexAttribPointer(n.normal,3,p.FLOAT,!1,0,0)}t.hasUvs&&i.map&&(p.bindBuffer(p.ARRAY_BUFFER,r.uv),p.bufferData(p.ARRAY_BUFFER,t.uvArray,p.DYNAMIC_DRAW),y.enableAttribute(n.uv),p.vertexAttribPointer(n.uv,2,p.FLOAT,!1,0,0)),t.hasColors&&i.vertexColors!==_&&(p.bindBuffer(p.ARRAY_BUFFER,r.color),p.bufferData(p.ARRAY_BUFFER,t.colorArray,p.DYNAMIC_DRAW),y.enableAttribute(n.color),p.vertexAttribPointer(n.color,3,p.FLOAT,!1,0,0)),y.disableUnusedAttributes(),p.drawArrays(p.TRIANGLES,0,t.count),t.count=0},this.renderBufferDirect=function(t,e,i,r,n,o){var a=n.isMesh&&n.matrixWorld.determinant()<0;y.setMaterial(r,a);var s=Ft(t,e,r,n),h=i.id+"_"+s.id+"_"+(!0===r.wireframe),l=!1;h!==rt&&(rt=h,l=!0),n.morphTargetInfluences&&(N.update(n,i,r,s),l=!0);var c,u=i.index,d=i.attributes.position,f=1;!0===r.wireframe&&(u=L.getWireframeAttribute(i),f=2);var m=k;null!==u&&(c=D.get(u),(m=j).setIndex(c)),l&&(!function(t,e,i){if(i&&i.isInstancedBufferGeometry&&null===g.get("ANGLE_instanced_arrays"))return;y.initAttributes();var r=i.attributes,n=e.getAttributes(),o=t.defaultAttributeValues;for(var a in n){var s=n[a];if(s>=0){var h=r[a];if(void 0!==h){var l=h.normalized,c=h.itemSize,u=D.get(h);if(void 0===u)continue;var d=u.buffer,f=u.type,m=u.bytesPerElement;if(h.isInterleavedBufferAttribute){var v=h.data,E=v.stride,x=h.offset;v&&v.isInstancedInterleavedBuffer?(y.enableAttributeAndDivisor(s,v.meshPerAttribute),void 0===i.maxInstancedCount&&(i.maxInstancedCount=v.meshPerAttribute*v.count)):y.enableAttribute(s),p.bindBuffer(p.ARRAY_BUFFER,d),p.vertexAttribPointer(s,c,f,l,E*m,x*m)}else h.isInstancedBufferAttribute?(y.enableAttributeAndDivisor(s,h.meshPerAttribute),void 0===i.maxInstancedCount&&(i.maxInstancedCount=h.meshPerAttribute*h.count)):y.enableAttribute(s),p.bindBuffer(p.ARRAY_BUFFER,d),p.vertexAttribPointer(s,c,f,l,0,0)}else if(void 0!==o){var _=o[a];if(void 0!==_)switch(_.length){case 2:p.vertexAttrib2fv(s,_);break;case 3:p.vertexAttrib3fv(s,_);break;case 4:p.vertexAttrib4fv(s,_);break;default:p.vertexAttrib1fv(s,_)}}}}y.disableUnusedAttributes()}(r,s,i),null!==u&&p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,c.buffer));var v=1/0;null!==u?v=u.count:void 0!==d&&(v=d.count);var E=i.drawRange.start*f,x=i.drawRange.count*f,_=null!==o?o.start*f:0,w=null!==o?o.count*f:1/0,b=Math.max(E,_),S=Math.min(v,E+x,_+w)-1,T=Math.max(0,S-b+1);if(0!==T){if(n.isMesh)if(!0===r.wireframe)y.setLineWidth(r.wireframeLinewidth*bt()),m.setMode(p.LINES);else switch(n.drawMode){case me:m.setMode(p.TRIANGLES);break;case ge:m.setMode(p.TRIANGLE_STRIP);break;case ve:m.setMode(p.TRIANGLE_FAN)}else if(n.isLine){var M=r.linewidth;void 0===M&&(M=1),y.setLineWidth(M*bt()),n.isLineSegments?m.setMode(p.LINES):n.isLineLoop?m.setMode(p.LINE_LOOP):m.setMode(p.LINE_STRIP)}else n.isPoints&&m.setMode(p.POINTS);i&&i.isInstancedBufferGeometry?i.maxInstancedCount>0&&m.renderInstances(i,b,T):m.render(b,T)}},this.compile=function(t,e){(u=B.get(t,e)).init(),t.traverse(function(t){t.isLight&&(u.pushLight(t),t.castShadow&&u.pushShadow(t))}),u.setupLights(e),t.traverse(function(e){if(e.material)if(Array.isArray(e.material))for(var i=0;i<e.material.length;i++)Vt(e.material[i],t.fog,e);else Vt(e.material,t.fog,e)})};var It=null;var Bt,zt=new ni;function kt(t,e,i,r){for(var n=0,o=t.length;n<o;n++){var a=t[n],s=a.object,h=a.geometry,l=void 0===r?a.material:r,c=a.group;if(i.isArrayCamera){at=i;for(var u=i.cameras,p=0,d=u.length;p<d;p++){var f=u[p];if(s.layers.test(f.layers)){if("viewport"in f)y.viewport(st.copy(f.viewport));else{var m=f.bounds,g=m.x*ut,v=m.y*pt,E=m.z*ut,x=m.w*pt;y.viewport(st.set(g,v,E,x).multiplyScalar(dt))}jt(s,e,f,h,l,c)}}}else at=null,jt(s,e,i,h,l,c)}}function jt(t,e,i,r,n,o){if(t.onBeforeRender(U,e,i,r,n,o),u=B.get(e,at||i),t.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,t.matrixWorld),t.normalMatrix.getNormalMatrix(t.modelViewMatrix),t.isImmediateRenderObject){var a=t.isMesh&&t.matrixWorld.determinant()<0;y.setMaterial(n,a);var s=Ft(i,e.fog,n,t);rt="",function(t,e,i){t.render(function(t){U.renderBufferImmediate(t,e,i)})}(t,s,n)}else U.renderBufferDirect(i,e.fog,r,n,t,o);t.onAfterRender(U,e,i,r,n,o),u=B.get(e,at||i)}function Vt(t,e,i){var r=b.get(t),n=u.state.lights,o=u.state.shadowsArray,a=H.getParameters(t,n.state,o,e,yt.numPlanes,yt.numIntersection,i),s=H.getProgramCode(t,a),h=r.program,l=!0;if(void 0===h)t.addEventListener("dispose",Ot);else if(h.code!==s)Ht(t);else if(r.lightsHash!==n.state.hash)b.update(t,"lightsHash",n.state.hash),l=!1;else{if(void 0!==a.shaderID)return;l=!1}if(l){if(a.shaderID){var c=ri[a.shaderID];r.shader={name:t.type,uniforms:Ke.clone(c.uniforms),vertexShader:c.vertexShader,fragmentShader:c.fragmentShader}}else r.shader={name:t.type,uniforms:t.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader};t.onBeforeCompile(r.shader,U),h=H.acquireProgram(t,r.shader,a,s),r.program=h,t.program=h}var p=h.getAttributes();if(t.morphTargets){t.numSupportedMorphTargets=0;for(var d=0;d<U.maxMorphTargets;d++)p["morphTarget"+d]>=0&&t.numSupportedMorphTargets++}if(t.morphNormals){t.numSupportedMorphNormals=0;for(d=0;d<U.maxMorphNormals;d++)p["morphNormal"+d]>=0&&t.numSupportedMorphNormals++}var f=r.shader.uniforms;(t.isShaderMaterial||t.isRawShaderMaterial)&&!0!==t.clipping||(r.numClippingPlanes=yt.numPlanes,r.numIntersection=yt.numIntersection,f.clippingPlanes=yt.uniform),r.fog=e,r.lightsHash=n.state.hash,t.lights&&(f.ambientLightColor.value=n.state.ambient,f.directionalLights.value=n.state.directional,f.spotLights.value=n.state.spot,f.rectAreaLights.value=n.state.rectArea,f.pointLights.value=n.state.point,f.hemisphereLights.value=n.state.hemi,f.directionalShadowMap.value=n.state.directionalShadowMap,f.directionalShadowMatrix.value=n.state.directionalShadowMatrix,f.spotShadowMap.value=n.state.spotShadowMap,f.spotShadowMatrix.value=n.state.spotShadowMatrix,f.pointShadowMap.value=n.state.pointShadowMap,f.pointShadowMatrix.value=n.state.pointShadowMatrix);var m=r.program.getUniforms(),g=Ur.seqWithValue(m.seq,f);r.uniformsList=g}function Ft(t,e,i,r){ct=0;var n=b.get(i),o=u.state.lights;if(Et&&(xt||t!==ot)){var a=t===ot&&i.id===it;yt.setState(i.clippingPlanes,i.clipIntersection,i.clipShadows,t,n,a)}!1===i.needsUpdate&&(void 0===n.program?i.needsUpdate=!0:i.fog&&n.fog!==e?i.needsUpdate=!0:i.lights&&n.lightsHash!==o.state.hash?i.needsUpdate=!0:void 0===n.numClippingPlanes||n.numClippingPlanes===yt.numPlanes&&n.numIntersection===yt.numIntersection||(i.needsUpdate=!0)),i.needsUpdate&&(Vt(i,e,r),i.needsUpdate=!1);var s,h,l=!1,c=!1,d=!1,f=n.program,m=f.getUniforms(),g=n.shader.uniforms;if(y.useProgram(f.program)&&(l=!0,c=!0,d=!0),i.id!==it&&(it=i.id,c=!0),l||t!==ot){if(m.setValue(p,"projectionMatrix",t.projectionMatrix),v.logarithmicDepthBuffer&&m.setValue(p,"logDepthBufFC",2/(Math.log(t.far+1)/Math.LN2)),ot!==(at||t)&&(ot=at||t,c=!0,d=!0),i.isShaderMaterial||i.isMeshPhongMaterial||i.isMeshStandardMaterial||i.envMap){var x=m.map.cameraPosition;void 0!==x&&x.setValue(p,wt.setFromMatrixPosition(t.matrixWorld))}(i.isMeshPhongMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial||i.skinning)&&m.setValue(p,"viewMatrix",t.matrixWorldInverse)}if(i.skinning){m.setOptional(p,r,"bindMatrix"),m.setOptional(p,r,"bindMatrixInverse");var _=r.skeleton;if(_){var w=_.bones;if(v.floatVertexTextures){if(void 0===_.boneTexture){var S=Math.sqrt(4*w.length);S=Ce.ceilPowerOfTwo(S),S=Math.max(S,4);var T=new Float32Array(S*S*4);T.set(_.boneMatrices);var M=new We(T,S,S,Nt,Pt);M.needsUpdate=!0,_.boneMatrices=T,_.boneTexture=M,_.boneTextureSize=S}m.setValue(p,"boneTexture",_.boneTexture),m.setValue(p,"boneTextureSize",_.boneTextureSize)}else m.setOptional(p,_,"boneMatrices")}}return c&&(m.setValue(p,"toneMappingExposure",U.toneMappingExposure),m.setValue(p,"toneMappingWhitePoint",U.toneMappingWhitePoint),i.lights&&(h=d,(s=g).ambientLightColor.needsUpdate=h,s.directionalLights.needsUpdate=h,s.pointLights.needsUpdate=h,s.spotLights.needsUpdate=h,s.rectAreaLights.needsUpdate=h,s.hemisphereLights.needsUpdate=h),e&&i.fog&&function(t,e){t.fogColor.value=e.color,e.isFog?(t.fogNear.value=e.near,t.fogFar.value=e.far):e.isFogExp2&&(t.fogDensity.value=e.density)}(g,e),i.isMeshBasicMaterial?Ut(g,i):i.isMeshLambertMaterial?(Ut(g,i),function(t,e){e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap)}(g,i)):i.isMeshPhongMaterial?(Ut(g,i),i.isMeshToonMaterial?function(t,e){Gt(t,e),e.gradientMap&&(t.gradientMap.value=e.gradientMap)}(g,i):Gt(g,i)):i.isMeshStandardMaterial?(Ut(g,i),i.isMeshPhysicalMaterial?function(t,e){Wt(t,e),t.reflectivity.value=e.reflectivity,t.clearCoat.value=e.clearCoat,t.clearCoatRoughness.value=e.clearCoatRoughness}(g,i):Wt(g,i)):i.isMeshDepthMaterial?(Ut(g,i),function(t,e){e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(g,i)):i.isMeshDistanceMaterial?(Ut(g,i),function(t,e){e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias);t.referencePosition.value.copy(e.referencePosition),t.nearDistance.value=e.nearDistance,t.farDistance.value=e.farDistance}(g,i)):i.isMeshNormalMaterial?(Ut(g,i),function(t,e){e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,e.side===E&&(t.bumpScale.value*=-1));e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),e.side===E&&t.normalScale.value.negate());e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}(g,i)):i.isLineBasicMaterial?(function(t,e){t.diffuse.value=e.color,t.opacity.value=e.opacity}(g,i),i.isLineDashedMaterial&&function(t,e){t.dashSize.value=e.dashSize,t.totalSize.value=e.dashSize+e.gapSize,t.scale.value=e.scale}(g,i)):i.isPointsMaterial?function(t,e){t.diffuse.value=e.color,t.opacity.value=e.opacity,t.size.value=e.size*dt,t.scale.value=.5*pt,t.map.value=e.map,null!==e.map&&(!0===e.map.matrixAutoUpdate&&e.map.updateMatrix(),t.uvTransform.value.copy(e.map.matrix))}(g,i):i.isShadowMaterial&&(g.color.value=i.color,g.opacity.value=i.opacity),void 0!==g.ltc_1&&(g.ltc_1.value=ii.LTC_1),void 0!==g.ltc_2&&(g.ltc_2.value=ii.LTC_2),Ur.upload(p,n.uniformsList,g,U)),i.isShaderMaterial&&!0===i.uniformsNeedUpdate&&(Ur.upload(p,n.uniformsList,g,U),i.uniformsNeedUpdate=!1),m.setValue(p,"modelViewMatrix",r.modelViewMatrix),m.setValue(p,"normalMatrix",r.normalMatrix),m.setValue(p,"modelMatrix",r.matrixWorld),f}function Ut(t,e){var i;t.opacity.value=e.opacity,e.color&&(t.diffuse.value=e.color),e.emissive&&t.emissive.value.copy(e.emissive).multiplyScalar(e.emissiveIntensity),e.map&&(t.map.value=e.map),e.alphaMap&&(t.alphaMap.value=e.alphaMap),e.specularMap&&(t.specularMap.value=e.specularMap),e.envMap&&(t.envMap.value=e.envMap,t.flipEnvMap.value=e.envMap&&e.envMap.isCubeTexture?-1:1,t.reflectivity.value=e.reflectivity,t.refractionRatio.value=e.refractionRatio,t.maxMipLevel.value=b.get(e.envMap).__maxMipLevel),e.lightMap&&(t.lightMap.value=e.lightMap,t.lightMapIntensity.value=e.lightMapIntensity),e.aoMap&&(t.aoMap.value=e.aoMap,t.aoMapIntensity.value=e.aoMapIntensity),e.map?i=e.map:e.specularMap?i=e.specularMap:e.displacementMap?i=e.displacementMap:e.normalMap?i=e.normalMap:e.bumpMap?i=e.bumpMap:e.roughnessMap?i=e.roughnessMap:e.metalnessMap?i=e.metalnessMap:e.alphaMap?i=e.alphaMap:e.emissiveMap&&(i=e.emissiveMap),void 0!==i&&(i.isWebGLRenderTarget&&(i=i.texture),!0===i.matrixAutoUpdate&&i.updateMatrix(),t.uvTransform.value.copy(i.matrix))}function Gt(t,e){t.specular.value=e.specular,t.shininess.value=Math.max(e.shininess,1e-4),e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap),e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,e.side===E&&(t.bumpScale.value*=-1)),e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),e.side===E&&t.normalScale.value.negate()),e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias)}function Wt(t,e){t.roughness.value=e.roughness,t.metalness.value=e.metalness,e.roughnessMap&&(t.roughnessMap.value=e.roughnessMap),e.metalnessMap&&(t.metalnessMap.value=e.metalnessMap),e.emissiveMap&&(t.emissiveMap.value=e.emissiveMap),e.bumpMap&&(t.bumpMap.value=e.bumpMap,t.bumpScale.value=e.bumpScale,e.side===E&&(t.bumpScale.value*=-1)),e.normalMap&&(t.normalMap.value=e.normalMap,t.normalScale.value.copy(e.normalScale),e.side===E&&t.normalScale.value.negate()),e.displacementMap&&(t.displacementMap.value=e.displacementMap,t.displacementScale.value=e.displacementScale,t.displacementBias.value=e.displacementBias),e.envMap&&(t.envMapIntensity.value=e.envMapIntensity)}zt.setAnimationLoop(function(t){Rt.isPresenting()||It&&It(t)}),"undefined"!=typeof window&&zt.setContext(window),this.setAnimationLoop=function(t){It=t,Rt.setAnimationLoop(t),zt.start()},this.render=function(t,e,i,r){if(e&&e.isCamera&&!G){rt="",it=-1,ot=null,!0===t.autoUpdate&&t.updateMatrixWorld(),null===e.parent&&e.updateMatrixWorld(),Rt.enabled&&(e=Rt.getCamera(e)),(u=B.get(t,e)).init(),t.onBeforeRender(U,t,e,i),_t.multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse),vt.setFromMatrix(_t),xt=this.localClippingEnabled,Et=yt.init(this.clippingPlanes,xt,e),(c=I.get(t,e)).init(),function t(e,i,r){if(!1===e.visible)return;var n=e.layers.test(i.layers);if(n)if(e.isLight)u.pushLight(e),e.castShadow&&u.pushShadow(e);else if(e.isSprite)e.frustumCulled&&!vt.intersectsSprite(e)||u.pushSprite(e);else if(e.isImmediateRenderObject)r&&wt.setFromMatrixPosition(e.matrixWorld).applyMatrix4(_t),c.push(e,null,e.material,wt.z,null);else if((e.isMesh||e.isLine||e.isPoints)&&(e.isSkinnedMesh&&e.skeleton.update(),!e.frustumCulled||vt.intersectsObject(e))){r&&wt.setFromMatrixPosition(e.matrixWorld).applyMatrix4(_t);var o=O.update(e),a=e.material;if(Array.isArray(a))for(var s=o.groups,h=0,l=s.length;h<l;h++){var p=s[h],d=a[p.materialIndex];d&&d.visible&&c.push(e,o,d,wt.z,p)}else a.visible&&c.push(e,o,a,wt.z,null)}var f=e.children;for(var h=0,l=f.length;h<l;h++)t(f[h],i,r)}(t,e,U.sortObjects),!0===U.sortObjects&&c.sort(),Et&&yt.beginShadows();var n=u.state.shadowsArray;At.render(n,t,e),u.setupLights(e),Et&&yt.endShadows(),this.info.autoReset&&this.info.reset(),void 0===i&&(i=null),this.setRenderTarget(i),z.render(c,t,e,r);var o=c.opaque,a=c.transparent;if(t.overrideMaterial){var s=t.overrideMaterial;o.length&&kt(o,t,e,s),a.length&&kt(a,t,e,s)}else o.length&&kt(o,t,e),a.length&&kt(a,t,e);var h=u.state.spritesArray;V.render(h,t,e),i&&P.updateRenderTargetMipmap(i),y.buffers.depth.setTest(!0),y.buffers.depth.setMask(!0),y.buffers.color.setMask(!0),y.setPolygonOffset(!1),t.onAfterRender(U,t,e),Rt.enabled&&Rt.submitFrame(),c=null,u=null}},this.allocTextureUnit=function(){var t=ct;return v.maxTextures,ct+=1,t},this.setTexture2D=(Bt=!1,function(t,e){t&&t.isWebGLRenderTarget&&(Bt||(Bt=!0),t=t.texture),P.setTexture2D(t,e)}),this.setTexture=function(){var t=!1;return function(e,i){t||(t=!0),P.setTexture2D(e,i)}}(),this.setTextureCube=function(){var t=!1;return function(e,i){e&&e.isWebGLRenderTargetCube&&(t||(t=!0),e=e.texture),e&&e.isCubeTexture||Array.isArray(e.image)&&6===e.image.length?P.setTextureCube(e,i):P.setTextureCubeDynamic(e,i)}}(),this.setFramebuffer=function(t){W=t},this.getRenderTarget=function(){return tt},this.setRenderTarget=function(t){tt=t,t&&void 0===b.get(t).__webglFramebuffer&&P.setupRenderTarget(t);var e=W,i=!1;if(t){var r=b.get(t).__webglFramebuffer;t.isWebGLRenderTargetCube?(e=r[t.activeCubeFace],i=!0):e=r,st.copy(t.viewport),ht.copy(t.scissor),lt=t.scissorTest}else st.copy(ft).multiplyScalar(dt),ht.copy(mt).multiplyScalar(dt),lt=gt;if(et!==e&&(p.bindFramebuffer(p.FRAMEBUFFER,e),et=e),y.viewport(st),y.scissor(ht),y.setScissorTest(lt),i){var n=b.get(t.texture);p.framebufferTexture2D(p.FRAMEBUFFER,p.COLOR_ATTACHMENT0,p.TEXTURE_CUBE_MAP_POSITIVE_X+t.activeCubeFace,n.__webglTexture,t.activeMipMapLevel)}},this.readRenderTargetPixels=function(t,e,i,r,n,o){if(t&&t.isWebGLRenderTarget){var a=b.get(t).__webglFramebuffer;if(a){var s=!1;a!==et&&(p.bindFramebuffer(p.FRAMEBUFFER,a),s=!0);try{var h=t.texture,l=h.format,c=h.type;if(l!==Nt&&F.convert(l)!==p.getParameter(p.IMPLEMENTATION_COLOR_READ_FORMAT))return;if(!(c===St||F.convert(c)===p.getParameter(p.IMPLEMENTATION_COLOR_READ_TYPE)||c===Pt&&(g.get("OES_texture_float")||g.get("WEBGL_color_buffer_float"))||c===Dt&&g.get("EXT_color_buffer_half_float")))return;p.checkFramebufferStatus(p.FRAMEBUFFER)===p.FRAMEBUFFER_COMPLETE&&e>=0&&e<=t.width-r&&i>=0&&i<=t.height-n&&p.readPixels(e,i,r,n,F.convert(l),F.convert(c),o)}finally{s&&p.bindFramebuffer(p.FRAMEBUFFER,et)}}}},this.copyFramebufferToTexture=function(t,e,i){var r=e.image.width,n=e.image.height,o=F.convert(e.format);this.setTexture2D(e,0),p.copyTexImage2D(p.TEXTURE_2D,i||0,o,t.x,t.y,r,n,0)},this.copyTextureToTexture=function(t,e,i,r){var n=e.image.width,o=e.image.height,a=F.convert(i.format),s=F.convert(i.type);this.setTexture2D(i,0),e.isDataTexture?p.texSubImage2D(p.TEXTURE_2D,r||0,t.x,t.y,n,o,a,s,e.image.data):p.texSubImage2D(p.TEXTURE_2D,r||0,t.x,t.y,a,s,e.image)}}function Tn(t,e){this.name="",this.color=new ti(t),this.density=void 0!==e?e:25e-5}function Mn(t,e,i){this.name="",this.color=new ti(t),this.near=void 0!==e?e:1,this.far=void 0!==i?i:1e3}function Rn(){di.call(this),this.type="Scene",this.background=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0}function An(t){Zi.call(this),this.type="SpriteMaterial",this.color=new ti(16777215),this.map=null,this.rotation=0,this.fog=!1,this.lights=!1,this.setValues(t)}function Cn(t){di.call(this),this.type="Sprite",this.material=void 0!==t?t:new An,this.center=new Pe(.5,.5)}function Pn(){di.call(this),this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]}})}function Dn(t,e){if(t=t||[],this.bones=t.slice(0),this.boneMatrices=new Float32Array(16*this.bones.length),void 0===e)this.calculateInverses();else if(this.bones.length===e.length)this.boneInverses=e.slice(0);else{this.boneInverses=[];for(var i=0,r=this.bones.length;i<r;i++)this.boneInverses.push(new De)}}function Ln(){di.call(this),this.type="Bone"}function On(t,e){$i.call(this,t,e),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new De,this.bindMatrixInverse=new De;var i=new Dn(this.initBones());this.bind(i,this.matrixWorld),this.normalizeSkinWeights()}function Hn(t){Zi.call(this),this.type="LineBasicMaterial",this.color=new ti(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.lights=!1,this.setValues(t)}function In(t,e,i){if(1===i)return new Bn(t,e);di.call(this),this.type="Line",this.geometry=void 0!==t?t:new Hi,this.material=void 0!==e?e:new Hn({color:16777215*Math.random()})}function Bn(t,e){In.call(this,t,e),this.type="LineSegments"}function zn(t,e){In.call(this,t,e),this.type="LineLoop"}function Nn(t){Zi.call(this),this.type="PointsMaterial",this.color=new ti(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.morphTargets=!1,this.lights=!1,this.setValues(t)}function kn(t,e){di.call(this),this.type="Points",this.geometry=void 0!==t?t:new Hi,this.material=void 0!==e?e:new Nn({color:16777215*Math.random()})}function jn(t,e,i,r,n,o,a,s,h){Ve.call(this,t,e,i,r,n,o,a,s,h),this.generateMipmaps=!1}function Vn(t,e,i,r,n,o,a,s,h,l,c,u){Ve.call(this,null,o,a,s,h,l,r,n,c,u),this.image={width:e,height:i},this.mipmaps=t,this.flipY=!1,this.generateMipmaps=!1}function Fn(t,e,i,r,n,o,a,s,h,l){if((l=void 0!==l?l:Ft)!==Ft&&l!==Ut)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===i&&l===Ft&&(i=Rt),void 0===i&&l===Ut&&(i=It),Ve.call(this,null,r,n,o,a,s,l,i,h),this.image={width:t,height:e},this.magFilter=void 0!==a?a:yt,this.minFilter=void 0!==s?s:yt,this.flipY=!1,this.generateMipmaps=!1}function Un(t){Hi.call(this),this.type="WireframeGeometry";var e,i,r,n,o,a,s,h,l,c,u=[],p=[0,0],d={},f=["a","b","c"];if(t&&t.isGeometry){var m=t.faces;for(e=0,r=m.length;e<r;e++){var g=m[e];for(i=0;i<3;i++)s=g[f[i]],h=g[f[(i+1)%3]],p[0]=Math.min(s,h),p[1]=Math.max(s,h),void 0===d[l=p[0]+","+p[1]]&&(d[l]={index1:p[0],index2:p[1]})}for(l in d)a=d[l],c=t.vertices[a.index1],u.push(c.x,c.y,c.z),c=t.vertices[a.index2],u.push(c.x,c.y,c.z)}else if(t&&t.isBufferGeometry){var v,y,E,x,_,w,b;if(c=new Oe,null!==t.index){for(v=t.attributes.position,y=t.index,0===(E=t.groups).length&&(E=[{start:0,count:y.count,materialIndex:0}]),n=0,o=E.length;n<o;++n)for(e=_=(x=E[n]).start,r=_+x.count;e<r;e+=3)for(i=0;i<3;i++)s=y.getX(e+i),h=y.getX(e+(i+1)%3),p[0]=Math.min(s,h),p[1]=Math.max(s,h),void 0===d[l=p[0]+","+p[1]]&&(d[l]={index1:p[0],index2:p[1]});for(l in d)a=d[l],c.fromBufferAttribute(v,a.index1),u.push(c.x,c.y,c.z),c.fromBufferAttribute(v,a.index2),u.push(c.x,c.y,c.z)}else for(e=0,r=(v=t.attributes.position).count/3;e<r;e++)for(i=0;i<3;i++)w=3*e+i,c.fromBufferAttribute(v,w),u.push(c.x,c.y,c.z),b=3*e+(i+1)%3,c.fromBufferAttribute(v,b),u.push(c.x,c.y,c.z)}this.addAttribute("position",new Ci(u,3))}function Gn(t,e,i){xi.call(this),this.type="ParametricGeometry",this.parameters={func:t,slices:e,stacks:i},this.fromBufferGeometry(new Wn(t,e,i)),this.mergeVertices()}function Wn(t,e,i){Hi.call(this),this.type="ParametricBufferGeometry",this.parameters={func:t,slices:e,stacks:i};var r,n,o=[],a=[],s=[],h=[],l=new Oe,c=new Oe,u=new Oe,p=new Oe,d=new Oe;t.length;var f=e+1;for(r=0;r<=i;r++){var m=r/i;for(n=0;n<=e;n++){var g=n/e;t(g,m,c),a.push(c.x,c.y,c.z),g-1e-5>=0?(t(g-1e-5,m,u),p.subVectors(c,u)):(t(g+1e-5,m,u),p.subVectors(u,c)),m-1e-5>=0?(t(g,m-1e-5,u),d.subVectors(c,u)):(t(g,m+1e-5,u),d.subVectors(u,c)),l.crossVectors(p,d).normalize(),s.push(l.x,l.y,l.z),h.push(g,m)}}for(r=0;r<i;r++)for(n=0;n<e;n++){var v=r*f+n,y=r*f+n+1,E=(r+1)*f+n+1,x=(r+1)*f+n;o.push(v,y,x),o.push(y,E,x)}this.setIndex(o),this.addAttribute("position",new Ci(a,3)),this.addAttribute("normal",new Ci(s,3)),this.addAttribute("uv",new Ci(h,2))}function Xn(t,e,i,r){xi.call(this),this.type="PolyhedronGeometry",this.parameters={vertices:t,indices:e,radius:i,detail:r},this.fromBufferGeometry(new Zn(t,e,i,r)),this.mergeVertices()}function Zn(t,e,i,r){Hi.call(this),this.type="PolyhedronBufferGeometry",this.parameters={vertices:t,indices:e,radius:i,detail:r},i=i||1;var n=[],o=[];function a(t,e,i,r){var n,o,a=Math.pow(2,r),h=[];for(n=0;n<=a;n++){h[n]=[];var l=t.clone().lerp(i,n/a),c=e.clone().lerp(i,n/a),u=a-n;for(o=0;o<=u;o++)h[n][o]=0===o&&n===a?l:l.clone().lerp(c,o/u)}for(n=0;n<a;n++)for(o=0;o<2*(a-n)-1;o++){var p=Math.floor(o/2);o%2==0?(s(h[n][p+1]),s(h[n+1][p]),s(h[n][p])):(s(h[n][p+1]),s(h[n+1][p+1]),s(h[n+1][p]))}}function s(t){n.push(t.x,t.y,t.z)}function h(e,i){var r=3*e;i.x=t[r+0],i.y=t[r+1],i.z=t[r+2]}function l(t,e,i,r){r<0&&1===t.x&&(o[e]=t.x-1),0===i.x&&0===i.z&&(o[e]=r/2/Math.PI+.5)}function c(t){return Math.atan2(t.z,-t.x)}!function(t){for(var i=new Oe,r=new Oe,n=new Oe,o=0;o<e.length;o+=3)h(e[o+0],i),h(e[o+1],r),h(e[o+2],n),a(i,r,n,t)}(r=r||0),function(t){for(var e=new Oe,i=0;i<n.length;i+=3)e.x=n[i+0],e.y=n[i+1],e.z=n[i+2],e.normalize().multiplyScalar(t),n[i+0]=e.x,n[i+1]=e.y,n[i+2]=e.z}(i),function(){for(var t=new Oe,e=0;e<n.length;e+=3){t.x=n[e+0],t.y=n[e+1],t.z=n[e+2];var i=c(t)/2/Math.PI+.5,r=(a=t,Math.atan2(-a.y,Math.sqrt(a.x*a.x+a.z*a.z))/Math.PI+.5);o.push(i,1-r)}var a;(function(){for(var t=new Oe,e=new Oe,i=new Oe,r=new Oe,a=new Pe,s=new Pe,h=new Pe,u=0,p=0;u<n.length;u+=9,p+=6){t.set(n[u+0],n[u+1],n[u+2]),e.set(n[u+3],n[u+4],n[u+5]),i.set(n[u+6],n[u+7],n[u+8]),a.set(o[p+0],o[p+1]),s.set(o[p+2],o[p+3]),h.set(o[p+4],o[p+5]),r.copy(t).add(e).add(i).divideScalar(3);var d=c(r);l(a,p+0,t,d),l(s,p+2,e,d),l(h,p+4,i,d)}})(),function(){for(var t=0;t<o.length;t+=6){var e=o[t+0],i=o[t+2],r=o[t+4],n=Math.max(e,i,r),a=Math.min(e,i,r);n>.9&&a<.1&&(e<.2&&(o[t+0]+=1),i<.2&&(o[t+2]+=1),r<.2&&(o[t+4]+=1))}}()}(),this.addAttribute("position",new Ci(n,3)),this.addAttribute("normal",new Ci(n.slice(),3)),this.addAttribute("uv",new Ci(o,2)),0===r?this.computeVertexNormals():this.normalizeNormals()}function Yn(t,e){xi.call(this),this.type="TetrahedronGeometry",this.parameters={radius:t,detail:e},this.fromBufferGeometry(new qn(t,e)),this.mergeVertices()}function qn(t,e){Zn.call(this,[1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],[2,1,0,0,3,2,1,3,0,2,3,1],t,e),this.type="TetrahedronBufferGeometry",this.parameters={radius:t,detail:e}}function Jn(t,e){xi.call(this),this.type="OctahedronGeometry",this.parameters={radius:t,detail:e},this.fromBufferGeometry(new Qn(t,e)),this.mergeVertices()}function Qn(t,e){Zn.call(this,[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2],t,e),this.type="OctahedronBufferGeometry",this.parameters={radius:t,detail:e}}function Kn(t,e){xi.call(this),this.type="IcosahedronGeometry",this.parameters={radius:t,detail:e},this.fromBufferGeometry(new $n(t,e)),this.mergeVertices()}function $n(t,e){var i=(1+Math.sqrt(5))/2,r=[-1,i,0,1,i,0,-1,-i,0,1,-i,0,0,-1,i,0,1,i,0,-1,-i,0,1,-i,i,0,-1,i,0,1,-i,0,-1,-i,0,1];Zn.call(this,r,[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],t,e),this.type="IcosahedronBufferGeometry",this.parameters={radius:t,detail:e}}function to(t,e){xi.call(this),this.type="DodecahedronGeometry",this.parameters={radius:t,detail:e},this.fromBufferGeometry(new eo(t,e)),this.mergeVertices()}function eo(t,e){var i=(1+Math.sqrt(5))/2,r=1/i,n=[-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-r,-i,0,-r,i,0,r,-i,0,r,i,-r,-i,0,-r,i,0,r,-i,0,r,i,0,-i,0,-r,i,0,-r,-i,0,r,i,0,r];Zn.call(this,n,[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9],t,e),this.type="DodecahedronBufferGeometry",this.parameters={radius:t,detail:e}}function io(t,e,i,r,n,o){xi.call(this),this.type="TubeGeometry",this.parameters={path:t,tubularSegments:e,radius:i,radialSegments:r,closed:n};var a=new ro(t,e,i,r,n);this.tangents=a.tangents,this.normals=a.normals,this.binormals=a.binormals,this.fromBufferGeometry(a),this.mergeVertices()}function ro(t,e,i,r,n){Hi.call(this),this.type="TubeBufferGeometry",this.parameters={path:t,tubularSegments:e,radius:i,radialSegments:r,closed:n},e=e||64,i=i||1,r=r||8,n=n||!1;var o=t.computeFrenetFrames(e,n);this.tangents=o.tangents,this.normals=o.normals,this.binormals=o.binormals;var a,s,h=new Oe,l=new Oe,c=new Pe,u=new Oe,p=[],d=[],f=[],m=[];function g(n){u=t.getPointAt(n/e,u);var a=o.normals[n],c=o.binormals[n];for(s=0;s<=r;s++){var f=s/r*Math.PI*2,m=Math.sin(f),g=-Math.cos(f);l.x=g*a.x+m*c.x,l.y=g*a.y+m*c.y,l.z=g*a.z+m*c.z,l.normalize(),d.push(l.x,l.y,l.z),h.x=u.x+i*l.x,h.y=u.y+i*l.y,h.z=u.z+i*l.z,p.push(h.x,h.y,h.z)}}!function(){for(a=0;a<e;a++)g(a);g(!1===n?e:0),function(){for(a=0;a<=e;a++)for(s=0;s<=r;s++)c.x=a/e,c.y=s/r,f.push(c.x,c.y)}(),function(){for(s=1;s<=e;s++)for(a=1;a<=r;a++){var t=(r+1)*(s-1)+(a-1),i=(r+1)*s+(a-1),n=(r+1)*s+a,o=(r+1)*(s-1)+a;m.push(t,i,o),m.push(i,n,o)}}()}(),this.setIndex(m),this.addAttribute("position",new Ci(p,3)),this.addAttribute("normal",new Ci(d,3)),this.addAttribute("uv",new Ci(f,2))}function no(t,e,i,r,n,o,a){xi.call(this),this.type="TorusKnotGeometry",this.parameters={radius:t,tube:e,tubularSegments:i,radialSegments:r,p:n,q:o},this.fromBufferGeometry(new oo(t,e,i,r,n,o)),this.mergeVertices()}function oo(t,e,i,r,n,o){Hi.call(this),this.type="TorusKnotBufferGeometry",this.parameters={radius:t,tube:e,tubularSegments:i,radialSegments:r,p:n,q:o},t=t||1,e=e||.4,i=Math.floor(i)||64,r=Math.floor(r)||8,n=n||2,o=o||3;var a,s,h=[],l=[],c=[],u=[],p=new Oe,d=new Oe,f=new Oe,m=new Oe,g=new Oe,v=new Oe,y=new Oe;for(a=0;a<=i;++a){var E=a/i*n*Math.PI*2;for(R(E,n,o,t,f),R(E+.01,n,o,t,m),v.subVectors(m,f),y.addVectors(m,f),g.crossVectors(v,y),y.crossVectors(g,v),g.normalize(),y.normalize(),s=0;s<=r;++s){var x=s/r*Math.PI*2,_=-e*Math.cos(x),w=e*Math.sin(x);p.x=f.x+(_*y.x+w*g.x),p.y=f.y+(_*y.y+w*g.y),p.z=f.z+(_*y.z+w*g.z),l.push(p.x,p.y,p.z),d.subVectors(p,f).normalize(),c.push(d.x,d.y,d.z),u.push(a/i),u.push(s/r)}}for(s=1;s<=i;s++)for(a=1;a<=r;a++){var b=(r+1)*(s-1)+(a-1),S=(r+1)*s+(a-1),T=(r+1)*s+a,M=(r+1)*(s-1)+a;h.push(b,S,M),h.push(S,T,M)}function R(t,e,i,r,n){var o=Math.cos(t),a=Math.sin(t),s=i/e*t,h=Math.cos(s);n.x=r*(2+h)*.5*o,n.y=r*(2+h)*a*.5,n.z=r*Math.sin(s)*.5}this.setIndex(h),this.addAttribute("position",new Ci(l,3)),this.addAttribute("normal",new Ci(c,3)),this.addAttribute("uv",new Ci(u,2))}function ao(t,e,i,r,n){xi.call(this),this.type="TorusGeometry",this.parameters={radius:t,tube:e,radialSegments:i,tubularSegments:r,arc:n},this.fromBufferGeometry(new so(t,e,i,r,n)),this.mergeVertices()}function so(t,e,i,r,n){Hi.call(this),this.type="TorusBufferGeometry",this.parameters={radius:t,tube:e,radialSegments:i,tubularSegments:r,arc:n},t=t||1,e=e||.4,i=Math.floor(i)||8,r=Math.floor(r)||6,n=n||2*Math.PI;var o,a,s=[],h=[],l=[],c=[],u=new Oe,p=new Oe,d=new Oe;for(o=0;o<=i;o++)for(a=0;a<=r;a++){var f=a/r*n,m=o/i*Math.PI*2;p.x=(t+e*Math.cos(m))*Math.cos(f),p.y=(t+e*Math.cos(m))*Math.sin(f),p.z=e*Math.sin(m),h.push(p.x,p.y,p.z),u.x=t*Math.cos(f),u.y=t*Math.sin(f),d.subVectors(p,u).normalize(),l.push(d.x,d.y,d.z),c.push(a/r),c.push(o/i)}for(o=1;o<=i;o++)for(a=1;a<=r;a++){var g=(r+1)*o+a-1,v=(r+1)*(o-1)+a-1,y=(r+1)*(o-1)+a,E=(r+1)*o+a;s.push(g,v,E),s.push(v,y,E)}this.setIndex(s),this.addAttribute("position",new Ci(h,3)),this.addAttribute("normal",new Ci(l,3)),this.addAttribute("uv",new Ci(c,2))}dn.prototype=Object.create(Zi.prototype),dn.prototype.constructor=dn,dn.prototype.isMeshDepthMaterial=!0,dn.prototype.copy=function(t){return Zi.prototype.copy.call(this,t),this.depthPacking=t.depthPacking,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this},fn.prototype=Object.create(Zi.prototype),fn.prototype.constructor=fn,fn.prototype.isMeshDistanceMaterial=!0,fn.prototype.copy=function(t){return Zi.prototype.copy.call(this,t),this.referencePosition.copy(t.referencePosition),this.nearDistance=t.nearDistance,this.farDistance=t.farDistance,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.map=t.map,this.alphaMap=t.alphaMap,this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this},gn.prototype=Object.create(Ve.prototype),gn.prototype.constructor=gn,gn.prototype.isCanvasTexture=!0,xn.prototype=Object.assign(Object.create(di.prototype),{constructor:xn,isGroup:!0}),_n.prototype=Object.assign(Object.create(fi.prototype),{constructor:_n,isPerspectiveCamera:!0,copy:function(t,e){return fi.prototype.copy.call(this,t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=null===t.view?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this},setFocalLength:function(t){var e=.5*this.getFilmHeight()/t;this.fov=2*Ce.RAD2DEG*Math.atan(e),this.updateProjectionMatrix()},getFocalLength:function(){var t=Math.tan(.5*Ce.DEG2RAD*this.fov);return.5*this.getFilmHeight()/t},getEffectiveFOV:function(){return 2*Ce.RAD2DEG*Math.atan(Math.tan(.5*Ce.DEG2RAD*this.fov)/this.zoom)},getFilmWidth:function(){return this.filmGauge*Math.min(this.aspect,1)},getFilmHeight:function(){return this.filmGauge/Math.max(this.aspect,1)},setViewOffset:function(t,e,i,r,n,o){this.aspect=t/e,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=r,this.view.width=n,this.view.height=o,this.updateProjectionMatrix()},clearViewOffset:function(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()},updateProjectionMatrix:function(){var t=this.near,e=t*Math.tan(.5*Ce.DEG2RAD*this.fov)/this.zoom,i=2*e,r=this.aspect*i,n=-.5*r,o=this.view;if(null!==this.view&&this.view.enabled){var a=o.fullWidth,s=o.fullHeight;n+=o.offsetX*r/a,e-=o.offsetY*i/s,r*=o.width/a,i*=o.height/s}var h=this.filmOffset;0!==h&&(n+=t*h/this.getFilmWidth()),this.projectionMatrix.makePerspective(n,n+r,e,e-i,t,this.far)},toJSON:function(t){var e=di.prototype.toJSON.call(this,t);return e.object.fov=this.fov,e.object.zoom=this.zoom,e.object.near=this.near,e.object.far=this.far,e.object.focus=this.focus,e.object.aspect=this.aspect,null!==this.view&&(e.object.view=Object.assign({},this.view)),e.object.filmGauge=this.filmGauge,e.object.filmOffset=this.filmOffset,e}}),wn.prototype=Object.assign(Object.create(_n.prototype),{constructor:wn,isArrayCamera:!0}),Tn.prototype.isFogExp2=!0,Tn.prototype.clone=function(){return new Tn(this.color,this.density)},Tn.prototype.toJSON=function(){return{type:"FogExp2",color:this.color.getHex(),density:this.density}},Mn.prototype.isFog=!0,Mn.prototype.clone=function(){return new Mn(this.color,this.near,this.far)},Mn.prototype.toJSON=function(){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}},Rn.prototype=Object.assign(Object.create(di.prototype),{constructor:Rn,copy:function(t,e){return di.prototype.copy.call(this,t,e),null!==t.background&&(this.background=t.background.clone()),null!==t.fog&&(this.fog=t.fog.clone()),null!==t.overrideMaterial&&(this.overrideMaterial=t.overrideMaterial.clone()),this.autoUpdate=t.autoUpdate,this.matrixAutoUpdate=t.matrixAutoUpdate,this},toJSON:function(t){var e=di.prototype.toJSON.call(this,t);return null!==this.background&&(e.object.background=this.background.toJSON(t)),null!==this.fog&&(e.object.fog=this.fog.toJSON()),e}}),An.prototype=Object.create(Zi.prototype),An.prototype.constructor=An,An.prototype.isSpriteMaterial=!0,An.prototype.copy=function(t){return Zi.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.rotation=t.rotation,this},Cn.prototype=Object.assign(Object.create(di.prototype),{constructor:Cn,isSprite:!0,raycast:function(){var t=new Oe,e=new Oe,i=new Oe,r=new Pe,n=new Pe,o=new De,a=new Oe,s=new Oe,h=new Oe;function l(t,e,i,a,s,h){r.subVectors(t,i).addScalar(.5).multiply(a),void 0!==s?(n.x=h*r.x-s*r.y,n.y=s*r.x+h*r.y):n.copy(r),t.copy(e),t.x+=n.x,t.y+=n.y,t.applyMatrix4(o)}return function(r,n){e.setFromMatrixScale(this.matrixWorld),o.getInverse(this.modelViewMatrix).premultiply(this.matrixWorld),i.setFromMatrixPosition(this.modelViewMatrix);var c,u,p=this.material.rotation;0!==p&&(u=Math.cos(p),c=Math.sin(p));var d=this.center;l(a.set(-.5,-.5,0),i,d,e,c,u),l(s.set(.5,-.5,0),i,d,e,c,u),l(h.set(.5,.5,0),i,d,e,c,u);var f=r.ray.intersectTriangle(a,s,h,!1,t);if(null!==f||(l(s.set(-.5,.5,0),i,d,e,c,u),null!==(f=r.ray.intersectTriangle(a,h,s,!1,t)))){var m=r.ray.origin.distanceTo(t);m<r.near||m>r.far||n.push({distance:m,point:t.clone(),face:null,object:this})}}}(),clone:function(){return new this.constructor(this.material).copy(this)},copy:function(t){return di.prototype.copy.call(this,t),void 0!==t.center&&this.center.copy(t.center),this}}),Pn.prototype=Object.assign(Object.create(di.prototype),{constructor:Pn,copy:function(t){di.prototype.copy.call(this,t,!1);for(var e=t.levels,i=0,r=e.length;i<r;i++){var n=e[i];this.addLevel(n.object.clone(),n.distance)}return this},addLevel:function(t,e){void 0===e&&(e=0),e=Math.abs(e);for(var i=this.levels,r=0;r<i.length&&!(e<i[r].distance);r++);i.splice(r,0,{distance:e,object:t}),this.add(t)},getObjectForDistance:function(t){for(var e=this.levels,i=1,r=e.length;i<r&&!(t<e[i].distance);i++);return e[i-1].object},raycast:(on=new Oe,function(t,e){on.setFromMatrixPosition(this.matrixWorld);var i=t.ray.origin.distanceTo(on);this.getObjectForDistance(i).raycast(t,e)}),update:function(){var t=new Oe,e=new Oe;return function(i){var r=this.levels;if(r.length>1){t.setFromMatrixPosition(i.matrixWorld),e.setFromMatrixPosition(this.matrixWorld);var n=t.distanceTo(e);r[0].object.visible=!0;for(var o=1,a=r.length;o<a&&n>=r[o].distance;o++)r[o-1].object.visible=!1,r[o].object.visible=!0;for(;o<a;o++)r[o].object.visible=!1}}}(),toJSON:function(t){var e=di.prototype.toJSON.call(this,t);e.object.levels=[];for(var i=this.levels,r=0,n=i.length;r<n;r++){var o=i[r];e.object.levels.push({object:o.object.uuid,distance:o.distance})}return e}}),Object.assign(Dn.prototype,{calculateInverses:function(){this.boneInverses=[];for(var t=0,e=this.bones.length;t<e;t++){var i=new De;this.bones[t]&&i.getInverse(this.bones[t].matrixWorld),this.boneInverses.push(i)}},pose:function(){var t,e,i;for(e=0,i=this.bones.length;e<i;e++)(t=this.bones[e])&&t.matrixWorld.getInverse(this.boneInverses[e]);for(e=0,i=this.bones.length;e<i;e++)(t=this.bones[e])&&(t.parent&&t.parent.isBone?(t.matrix.getInverse(t.parent.matrixWorld),t.matrix.multiply(t.matrixWorld)):t.matrix.copy(t.matrixWorld),t.matrix.decompose(t.position,t.quaternion,t.scale))},update:(an=new De,sn=new De,function(){for(var t=this.bones,e=this.boneInverses,i=this.boneMatrices,r=this.boneTexture,n=0,o=t.length;n<o;n++){var a=t[n]?t[n].matrixWorld:sn;an.multiplyMatrices(a,e[n]),an.toArray(i,16*n)}void 0!==r&&(r.needsUpdate=!0)}),clone:function(){return new Dn(this.bones,this.boneInverses)},getBoneByName:function(t){for(var e=0,i=this.bones.length;e<i;e++){var r=this.bones[e];if(r.name===t)return r}}}),Ln.prototype=Object.assign(Object.create(di.prototype),{constructor:Ln,isBone:!0}),On.prototype=Object.assign(Object.create($i.prototype),{constructor:On,isSkinnedMesh:!0,initBones:function(){var t,e,i,r,n=[];if(this.geometry&&void 0!==this.geometry.bones){for(i=0,r=this.geometry.bones.length;i<r;i++)e=this.geometry.bones[i],t=new Ln,n.push(t),t.name=e.name,t.position.fromArray(e.pos),t.quaternion.fromArray(e.rotq),void 0!==e.scl&&t.scale.fromArray(e.scl);for(i=0,r=this.geometry.bones.length;i<r;i++)-1!==(e=this.geometry.bones[i]).parent&&null!==e.parent&&void 0!==n[e.parent]?n[e.parent].add(n[i]):this.add(n[i])}return this.updateMatrixWorld(!0),n},bind:function(t,e){this.skeleton=t,void 0===e&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),e=this.matrixWorld),this.bindMatrix.copy(e),this.bindMatrixInverse.getInverse(e)},pose:function(){this.skeleton.pose()},normalizeSkinWeights:function(){var t,e;if(this.geometry&&this.geometry.isGeometry)for(e=0;e<this.geometry.skinWeights.length;e++){var i=this.geometry.skinWeights[e];(t=1/i.manhattanLength())!==1/0?i.multiplyScalar(t):i.set(1,0,0,0)}else if(this.geometry&&this.geometry.isBufferGeometry){var r=new Fe,n=this.geometry.attributes.skinWeight;for(e=0;e<n.count;e++)r.x=n.getX(e),r.y=n.getY(e),r.z=n.getZ(e),r.w=n.getW(e),(t=1/r.manhattanLength())!==1/0?r.multiplyScalar(t):r.set(1,0,0,0),n.setXYZW(e,r.x,r.y,r.z,r.w)}},updateMatrixWorld:function(t){$i.prototype.updateMatrixWorld.call(this,t),"attached"===this.bindMode?this.bindMatrixInverse.getInverse(this.matrixWorld):"detached"===this.bindMode&&this.bindMatrixInverse.getInverse(this.bindMatrix)},clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Hn.prototype=Object.create(Zi.prototype),Hn.prototype.constructor=Hn,Hn.prototype.isLineBasicMaterial=!0,Hn.prototype.copy=function(t){return Zi.prototype.copy.call(this,t),this.color.copy(t.color),this.linewidth=t.linewidth,this.linecap=t.linecap,this.linejoin=t.linejoin,this},In.prototype=Object.assign(Object.create(di.prototype),{constructor:In,isLine:!0,computeLineDistances:(hn=new Oe,ln=new Oe,function(){var t=this.geometry;if(t.isBufferGeometry){if(null===t.index){for(var e=t.attributes.position,i=[0],r=1,n=e.count;r<n;r++)hn.fromBufferAttribute(e,r-1),ln.fromBufferAttribute(e,r),i[r]=i[r-1],i[r]+=hn.distanceTo(ln);t.addAttribute("lineDistance",new Ci(i,1))}}else if(t.isGeometry){var o=t.vertices;for((i=t.lineDistances)[0]=0,r=1,n=o.length;r<n;r++)i[r]=i[r-1],i[r]+=o[r-1].distanceTo(o[r])}return this}),raycast:function(){var t=new De,e=new Ji,i=new Ze;return function(r,n){var o=r.linePrecision,a=o*o,s=this.geometry,h=this.matrixWorld;if(null===s.boundingSphere&&s.computeBoundingSphere(),i.copy(s.boundingSphere),i.applyMatrix4(h),!1!==r.ray.intersectsSphere(i)){t.getInverse(h),e.copy(r.ray).applyMatrix4(t);var l=new Oe,c=new Oe,u=new Oe,p=new Oe,d=this&&this.isLineSegments?2:1;if(s.isBufferGeometry){var f=s.index,m=s.attributes.position.array;if(null!==f)for(var g=f.array,v=0,y=g.length-1;v<y;v+=d){var E=g[v],x=g[v+1];if(l.fromArray(m,3*E),c.fromArray(m,3*x),!(e.distanceSqToSegment(l,c,p,u)>a))p.applyMatrix4(this.matrixWorld),(b=r.ray.origin.distanceTo(p))<r.near||b>r.far||n.push({distance:b,point:u.clone().applyMatrix4(this.matrixWorld),index:v,face:null,faceIndex:null,object:this})}else for(v=0,y=m.length/3-1;v<y;v+=d){if(l.fromArray(m,3*v),c.fromArray(m,3*v+3),!(e.distanceSqToSegment(l,c,p,u)>a))p.applyMatrix4(this.matrixWorld),(b=r.ray.origin.distanceTo(p))<r.near||b>r.far||n.push({distance:b,point:u.clone().applyMatrix4(this.matrixWorld),index:v,face:null,faceIndex:null,object:this})}}else if(s.isGeometry){var _=s.vertices,w=_.length;for(v=0;v<w-1;v+=d){var b;if(!(e.distanceSqToSegment(_[v],_[v+1],p,u)>a))p.applyMatrix4(this.matrixWorld),(b=r.ray.origin.distanceTo(p))<r.near||b>r.far||n.push({distance:b,point:u.clone().applyMatrix4(this.matrixWorld),index:v,face:null,faceIndex:null,object:this})}}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Bn.prototype=Object.assign(Object.create(In.prototype),{constructor:Bn,isLineSegments:!0,computeLineDistances:function(){var t=new Oe,e=new Oe;return function(){var i=this.geometry;if(i.isBufferGeometry){if(null===i.index){for(var r=i.attributes.position,n=[],o=0,a=r.count;o<a;o+=2)t.fromBufferAttribute(r,o),e.fromBufferAttribute(r,o+1),n[o]=0===o?0:n[o-1],n[o+1]=n[o]+t.distanceTo(e);i.addAttribute("lineDistance",new Ci(n,1))}}else if(i.isGeometry){var s=i.vertices;for(n=i.lineDistances,o=0,a=s.length;o<a;o+=2)t.copy(s[o]),e.copy(s[o+1]),n[o]=0===o?0:n[o-1],n[o+1]=n[o]+t.distanceTo(e)}return this}}()}),zn.prototype=Object.assign(Object.create(In.prototype),{constructor:zn,isLineLoop:!0}),Nn.prototype=Object.create(Zi.prototype),Nn.prototype.constructor=Nn,Nn.prototype.isPointsMaterial=!0,Nn.prototype.copy=function(t){return Zi.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.size=t.size,this.sizeAttenuation=t.sizeAttenuation,this.morphTargets=t.morphTargets,this},kn.prototype=Object.assign(Object.create(di.prototype),{constructor:kn,isPoints:!0,raycast:function(){var t=new De,e=new Ji,i=new Ze;return function(r,n){var o=this,a=this.geometry,s=this.matrixWorld,h=r.params.Points.threshold;if(null===a.boundingSphere&&a.computeBoundingSphere(),i.copy(a.boundingSphere),i.applyMatrix4(s),i.radius+=h,!1!==r.ray.intersectsSphere(i)){t.getInverse(s),e.copy(r.ray).applyMatrix4(t);var l=h/((this.scale.x+this.scale.y+this.scale.z)/3),c=l*l,u=new Oe,p=new Oe;if(a.isBufferGeometry){var d=a.index,f=a.attributes.position.array;if(null!==d)for(var m=d.array,g=0,v=m.length;g<v;g++){var y=m[g];u.fromArray(f,3*y),_(u,y)}else{g=0;for(var E=f.length/3;g<E;g++)u.fromArray(f,3*g),_(u,g)}}else{var x=a.vertices;for(g=0,E=x.length;g<E;g++)_(x[g],g)}}function _(t,i){var a=e.distanceSqToPoint(t);if(a<c){e.closestPointToPoint(t,p),p.applyMatrix4(s);var h=r.ray.origin.distanceTo(p);if(h<r.near||h>r.far)return;n.push({distance:h,distanceToRay:Math.sqrt(a),point:p.clone(),index:i,face:null,object:o})}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),jn.prototype=Object.assign(Object.create(Ve.prototype),{constructor:jn,isVideoTexture:!0,update:function(){var t=this.image;t.readyState>=t.HAVE_CURRENT_DATA&&(this.needsUpdate=!0)}}),Vn.prototype=Object.create(Ve.prototype),Vn.prototype.constructor=Vn,Vn.prototype.isCompressedTexture=!0,Fn.prototype=Object.create(Ve.prototype),Fn.prototype.constructor=Fn,Fn.prototype.isDepthTexture=!0,Un.prototype=Object.create(Hi.prototype),Un.prototype.constructor=Un,Gn.prototype=Object.create(xi.prototype),Gn.prototype.constructor=Gn,Wn.prototype=Object.create(Hi.prototype),Wn.prototype.constructor=Wn,Xn.prototype=Object.create(xi.prototype),Xn.prototype.constructor=Xn,Zn.prototype=Object.create(Hi.prototype),Zn.prototype.constructor=Zn,Yn.prototype=Object.create(xi.prototype),Yn.prototype.constructor=Yn,qn.prototype=Object.create(Zn.prototype),qn.prototype.constructor=qn,Jn.prototype=Object.create(xi.prototype),Jn.prototype.constructor=Jn,Qn.prototype=Object.create(Zn.prototype),Qn.prototype.constructor=Qn,Kn.prototype=Object.create(xi.prototype),Kn.prototype.constructor=Kn,$n.prototype=Object.create(Zn.prototype),$n.prototype.constructor=$n,to.prototype=Object.create(xi.prototype),to.prototype.constructor=to,eo.prototype=Object.create(Zn.prototype),eo.prototype.constructor=eo,io.prototype=Object.create(xi.prototype),io.prototype.constructor=io,ro.prototype=Object.create(Hi.prototype),ro.prototype.constructor=ro,no.prototype=Object.create(xi.prototype),no.prototype.constructor=no,oo.prototype=Object.create(Hi.prototype),oo.prototype.constructor=oo,ao.prototype=Object.create(xi.prototype),ao.prototype.constructor=ao,so.prototype=Object.create(Hi.prototype),so.prototype.constructor=so;var ho=function(t,e,i){i=i||2;var r,n,o,a,s,h,l,c=e&&e.length,u=c?e[0]*i:t.length,p=lo(t,0,u,i,!0),d=[];if(!p)return d;if(c&&(p=function(t,e,i,r){var n,o,a,s,h,l=[];for(n=0,o=e.length;n<o;n++)a=e[n]*r,s=n<o-1?e[n+1]*r:t.length,(h=lo(t,a,s,r,!1))===h.next&&(h.steiner=!0),l.push(xo(h));for(l.sort(vo),n=0;n<l.length;n++)yo(l[n],i),i=co(i,i.next);return i}(t,e,p,i)),t.length>80*i){r=o=t[0],n=a=t[1];for(var f=i;f<u;f+=i)s=t[f],h=t[f+1],s<r&&(r=s),h<n&&(n=h),s>o&&(o=s),h>a&&(a=h);l=0!==(l=Math.max(o-r,a-n))?1/l:0}return uo(p,d,i,r,n,l),d};function lo(t,e,i,r,n){var o,a;if(n===function(t,e,i,r){for(var n=0,o=e,a=i-r;o<i;o+=r)n+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return n}(t,e,i,r)>0)for(o=e;o<i;o+=r)a=Ao(o,t[o],t[o+1],a);else for(o=i-r;o>=e;o-=r)a=Ao(o,t[o],t[o+1],a);return a&&So(a,a.next)&&(Co(a),a=a.next),a}function co(t,e){if(!t)return t;e||(e=t);var i,r=t;do{if(i=!1,r.steiner||!So(r,r.next)&&0!==bo(r.prev,r,r.next))r=r.next;else{if(Co(r),(r=e=r.prev)===r.next)break;i=!0}}while(i||r!==e);return e}function uo(t,e,i,r,n,o,a){if(t){!a&&o&&function(t,e,i,r){var n=t;do{null===n.z&&(n.z=Eo(n.x,n.y,e,i,r)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==t);n.prevZ.nextZ=null,n.prevZ=null,function(t){var e,i,r,n,o,a,s,h,l=1;do{for(i=t,t=null,o=null,a=0;i;){for(a++,r=i,s=0,e=0;e<l&&(s++,r=r.nextZ);e++);for(h=l;s>0||h>0&&r;)0!==s&&(0===h||!r||i.z<=r.z)?(n=i,i=i.nextZ,s--):(n=r,r=r.nextZ,h--),o?o.nextZ=n:t=n,n.prevZ=o,o=n;i=r}o.nextZ=null,l*=2}while(a>1)}(n)}(t,r,n,o);for(var s,h,l=t;t.prev!==t.next;)if(s=t.prev,h=t.next,o?fo(t,r,n,o):po(t))e.push(s.i/i),e.push(t.i/i),e.push(h.i/i),Co(t),t=h.next,l=h.next;else if((t=h)===l){a?1===a?uo(t=mo(t,e,i),e,i,r,n,o,2):2===a&&go(t,e,i,r,n,o):uo(co(t),e,i,r,n,o,1);break}}}function po(t){var e=t.prev,i=t,r=t.next;if(bo(e,i,r)>=0)return!1;for(var n=t.next.next;n!==t.prev;){if(_o(e.x,e.y,i.x,i.y,r.x,r.y,n.x,n.y)&&bo(n.prev,n,n.next)>=0)return!1;n=n.next}return!0}function fo(t,e,i,r){var n=t.prev,o=t,a=t.next;if(bo(n,o,a)>=0)return!1;for(var s=n.x<o.x?n.x<a.x?n.x:a.x:o.x<a.x?o.x:a.x,h=n.y<o.y?n.y<a.y?n.y:a.y:o.y<a.y?o.y:a.y,l=n.x>o.x?n.x>a.x?n.x:a.x:o.x>a.x?o.x:a.x,c=n.y>o.y?n.y>a.y?n.y:a.y:o.y>a.y?o.y:a.y,u=Eo(s,h,e,i,r),p=Eo(l,c,e,i,r),d=t.nextZ;d&&d.z<=p;){if(d!==t.prev&&d!==t.next&&_o(n.x,n.y,o.x,o.y,a.x,a.y,d.x,d.y)&&bo(d.prev,d,d.next)>=0)return!1;d=d.nextZ}for(d=t.prevZ;d&&d.z>=u;){if(d!==t.prev&&d!==t.next&&_o(n.x,n.y,o.x,o.y,a.x,a.y,d.x,d.y)&&bo(d.prev,d,d.next)>=0)return!1;d=d.prevZ}return!0}function mo(t,e,i){var r=t;do{var n=r.prev,o=r.next.next;!So(n,o)&&To(n,r,r.next,o)&&Mo(n,o)&&Mo(o,n)&&(e.push(n.i/i),e.push(r.i/i),e.push(o.i/i),Co(r),Co(r.next),r=t=o),r=r.next}while(r!==t);return r}function go(t,e,i,r,n,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&wo(a,s)){var h=Ro(a,s);return a=co(a,a.next),h=co(h,h.next),uo(a,e,i,r,n,o),void uo(h,e,i,r,n,o)}s=s.next}a=a.next}while(a!==t)}function vo(t,e){return t.x-e.x}function yo(t,e){if(e=function(t,e){var i,r=e,n=t.x,o=t.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var s=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=n&&s>a){if(a=s,s===n){if(o===r.y)return r;if(o===r.next.y)return r.next}i=r.x<r.next.x?r:r.next}}r=r.next}while(r!==e);if(!i)return null;if(n===a)return i.prev;var h,l=i,c=i.x,u=i.y,p=1/0;r=i.next;for(;r!==l;)n>=r.x&&r.x>=c&&n!==r.x&&_o(o<u?n:a,o,c,u,o<u?a:n,o,r.x,r.y)&&((h=Math.abs(o-r.y)/(n-r.x))<p||h===p&&r.x>i.x)&&Mo(r,t)&&(i=r,p=h),r=r.next;return i}(t,e)){var i=Ro(e,t);co(i,i.next)}}function Eo(t,e,i,r,n){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)*n)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*n)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function xo(t){var e=t,i=t;do{e.x<i.x&&(i=e),e=e.next}while(e!==t);return i}function _o(t,e,i,r,n,o,a,s){return(n-a)*(e-s)-(t-a)*(o-s)>=0&&(t-a)*(r-s)-(i-a)*(e-s)>=0&&(i-a)*(o-s)-(n-a)*(r-s)>=0}function wo(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var i=t;do{if(i.i!==t.i&&i.next.i!==t.i&&i.i!==e.i&&i.next.i!==e.i&&To(i,i.next,t,e))return!0;i=i.next}while(i!==t);return!1}(t,e)&&Mo(t,e)&&Mo(e,t)&&function(t,e){var i=t,r=!1,n=(t.x+e.x)/2,o=(t.y+e.y)/2;do{i.y>o!=i.next.y>o&&i.next.y!==i.y&&n<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next}while(i!==t);return r}(t,e)}function bo(t,e,i){return(e.y-t.y)*(i.x-e.x)-(e.x-t.x)*(i.y-e.y)}function So(t,e){return t.x===e.x&&t.y===e.y}function To(t,e,i,r){return!!(So(t,e)&&So(i,r)||So(t,r)&&So(i,e))||bo(t,e,i)>0!=bo(t,e,r)>0&&bo(i,r,t)>0!=bo(i,r,e)>0}function Mo(t,e){return bo(t.prev,t,t.next)<0?bo(t,e,t.next)>=0&&bo(t,t.prev,e)>=0:bo(t,e,t.prev)<0||bo(t,t.next,e)<0}function Ro(t,e){var i=new Po(t.i,t.x,t.y),r=new Po(e.i,e.x,e.y),n=t.next,o=e.prev;return t.next=e,e.prev=t,i.next=n,n.prev=i,r.next=i,i.prev=r,o.next=r,r.prev=o,r}function Ao(t,e,i,r){var n=new Po(t,e,i);return r?(n.next=r.next,n.prev=r,r.next.prev=n,r.next=n):(n.prev=n,n.next=n),n}function Co(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function Po(t,e,i){this.i=t,this.x=e,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}var Do={area:function(t){for(var e=t.length,i=0,r=e-1,n=0;n<e;r=n++)i+=t[r].x*t[n].y-t[n].x*t[r].y;return.5*i},isClockWise:function(t){return Do.area(t)<0},triangulateShape:function(t,e){var i=[],r=[],n=[];Lo(t),Oo(i,t);var o=t.length;e.forEach(Lo);for(var a=0;a<e.length;a++)r.push(o),o+=e[a].length,Oo(i,e[a]);var s=ho(i,r);for(a=0;a<s.length;a+=3)n.push(s.slice(a,a+3));return n}};function Lo(t){var e=t.length;e>2&&t[e-1].equals(t[0])&&t.pop()}function Oo(t,e){for(var i=0;i<e.length;i++)t.push(e[i].x),t.push(e[i].y)}function Ho(t,e){xi.call(this),this.type="ExtrudeGeometry",this.parameters={shapes:t,options:e},this.fromBufferGeometry(new Io(t,e)),this.mergeVertices()}function Io(t,e){Hi.call(this),this.type="ExtrudeBufferGeometry",this.parameters={shapes:t,options:e};for(var i=this,r=[],n=[],o=0,a=(t=Array.isArray(t)?t:[t]).length;o<a;o++){s(t[o])}function s(t){var o=[],a=void 0!==e.curveSegments?e.curveSegments:12,s=void 0!==e.steps?e.steps:1,h=void 0!==e.depth?e.depth:100,l=void 0===e.bevelEnabled||e.bevelEnabled,c=void 0!==e.bevelThickness?e.bevelThickness:6,u=void 0!==e.bevelSize?e.bevelSize:c-2,p=void 0!==e.bevelSegments?e.bevelSegments:3,d=e.extrudePath,f=void 0!==e.UVGenerator?e.UVGenerator:Bo;void 0!==e.amount&&(h=e.amount);var m,g,v,y,E,x,_,w,b=!1;d&&(m=d.getSpacedPoints(s),b=!0,l=!1,g=d.computeFrenetFrames(s,!1),v=new Oe,y=new Oe,E=new Oe),l||(p=0,c=0,u=0);var S=t.extractPoints(a),T=S.shape,M=S.holes;if(!Do.isClockWise(T))for(T=T.reverse(),_=0,w=M.length;_<w;_++)x=M[_],Do.isClockWise(x)&&(M[_]=x.reverse());var R=Do.triangulateShape(T,M),A=T;for(_=0,w=M.length;_<w;_++)x=M[_],T=T.concat(x);function C(t,e,i){return e.clone().multiplyScalar(i).add(t)}var P,D,L,O,H,I,B=T.length,z=R.length;function N(t,e,i){var r,n,o,a=t.x-e.x,s=t.y-e.y,h=i.x-t.x,l=i.y-t.y,c=a*a+s*s,u=a*l-s*h;if(Math.abs(u)>Number.EPSILON){var p=Math.sqrt(c),d=Math.sqrt(h*h+l*l),f=e.x-s/p,m=e.y+a/p,g=((i.x-l/d-f)*l-(i.y+h/d-m)*h)/(a*l-s*h),v=(r=f+a*g-t.x)*r+(n=m+s*g-t.y)*n;if(v<=2)return new Pe(r,n);o=Math.sqrt(v/2)}else{var y=!1;a>Number.EPSILON?h>Number.EPSILON&&(y=!0):a<-Number.EPSILON?h<-Number.EPSILON&&(y=!0):Math.sign(s)===Math.sign(l)&&(y=!0),y?(r=-s,n=a,o=Math.sqrt(c)):(r=a,n=s,o=Math.sqrt(c/2))}return new Pe(r/o,n/o)}for(var k=[],j=0,V=A.length,F=V-1,U=j+1;j<V;j++,F++,U++)F===V&&(F=0),U===V&&(U=0),k[j]=N(A[j],A[F],A[U]);var G,W,X=[],Z=k.concat();for(_=0,w=M.length;_<w;_++){for(x=M[_],G=[],j=0,F=(V=x.length)-1,U=j+1;j<V;j++,F++,U++)F===V&&(F=0),U===V&&(U=0),G[j]=N(x[j],x[F],x[U]);X.push(G),Z=Z.concat(G)}for(P=0;P<p;P++){for(L=P/p,O=c*Math.cos(L*Math.PI/2),D=u*Math.sin(L*Math.PI/2),j=0,V=A.length;j<V;j++)q((H=C(A[j],k[j],D)).x,H.y,-O);for(_=0,w=M.length;_<w;_++)for(x=M[_],G=X[_],j=0,V=x.length;j<V;j++)q((H=C(x[j],G[j],D)).x,H.y,-O)}for(D=u,j=0;j<B;j++)H=l?C(T[j],Z[j],D):T[j],b?(y.copy(g.normals[0]).multiplyScalar(H.x),v.copy(g.binormals[0]).multiplyScalar(H.y),E.copy(m[0]).add(y).add(v),q(E.x,E.y,E.z)):q(H.x,H.y,0);for(W=1;W<=s;W++)for(j=0;j<B;j++)H=l?C(T[j],Z[j],D):T[j],b?(y.copy(g.normals[W]).multiplyScalar(H.x),v.copy(g.binormals[W]).multiplyScalar(H.y),E.copy(m[W]).add(y).add(v),q(E.x,E.y,E.z)):q(H.x,H.y,h/s*W);for(P=p-1;P>=0;P--){for(L=P/p,O=c*Math.cos(L*Math.PI/2),D=u*Math.sin(L*Math.PI/2),j=0,V=A.length;j<V;j++)q((H=C(A[j],k[j],D)).x,H.y,h+O);for(_=0,w=M.length;_<w;_++)for(x=M[_],G=X[_],j=0,V=x.length;j<V;j++)H=C(x[j],G[j],D),b?q(H.x,H.y+m[s-1].y,m[s-1].x+O):q(H.x,H.y,h+O)}function Y(t,e){var i,r;for(j=t.length;--j>=0;){i=j,(r=j-1)<0&&(r=t.length-1);var n=0,o=s+2*p;for(n=0;n<o;n++){var a=B*n,h=B*(n+1);Q(e+i+a,e+r+a,e+r+h,e+i+h)}}}function q(t,e,i){o.push(t),o.push(e),o.push(i)}function J(t,e,n){K(t),K(e),K(n);var o=r.length/3,a=f.generateTopUV(i,r,o-3,o-2,o-1);$(a[0]),$(a[1]),$(a[2])}function Q(t,e,n,o){K(t),K(e),K(o),K(e),K(n),K(o);var a=r.length/3,s=f.generateSideWallUV(i,r,a-6,a-3,a-2,a-1);$(s[0]),$(s[1]),$(s[3]),$(s[1]),$(s[2]),$(s[3])}function K(t){r.push(o[3*t+0]),r.push(o[3*t+1]),r.push(o[3*t+2])}function $(t){n.push(t.x),n.push(t.y)}!function(){var t=r.length/3;if(l){var e=0,n=B*e;for(j=0;j<z;j++)J((I=R[j])[2]+n,I[1]+n,I[0]+n);for(n=B*(e=s+2*p),j=0;j<z;j++)J((I=R[j])[0]+n,I[1]+n,I[2]+n)}else{for(j=0;j<z;j++)J((I=R[j])[2],I[1],I[0]);for(j=0;j<z;j++)J((I=R[j])[0]+B*s,I[1]+B*s,I[2]+B*s)}i.addGroup(t,r.length/3-t,0)}(),function(){var t=r.length/3,e=0;for(Y(A,e),e+=A.length,_=0,w=M.length;_<w;_++)Y(x=M[_],e),e+=x.length;i.addGroup(t,r.length/3-t,1)}()}this.addAttribute("position",new Ci(r,3)),this.addAttribute("uv",new Ci(n,2)),this.computeVertexNormals()}Ho.prototype=Object.create(xi.prototype),Ho.prototype.constructor=Ho,Ho.prototype.toJSON=function(){var t=xi.prototype.toJSON.call(this);return zo(this.parameters.shapes,this.parameters.options,t)},Io.prototype=Object.create(Hi.prototype),Io.prototype.constructor=Io,Io.prototype.toJSON=function(){var t=Hi.prototype.toJSON.call(this);return zo(this.parameters.shapes,this.parameters.options,t)};var Bo={generateTopUV:function(t,e,i,r,n){var o=e[3*i],a=e[3*i+1],s=e[3*r],h=e[3*r+1],l=e[3*n],c=e[3*n+1];return[new Pe(o,a),new Pe(s,h),new Pe(l,c)]},generateSideWallUV:function(t,e,i,r,n,o){var a=e[3*i],s=e[3*i+1],h=e[3*i+2],l=e[3*r],c=e[3*r+1],u=e[3*r+2],p=e[3*n],d=e[3*n+1],f=e[3*n+2],m=e[3*o],g=e[3*o+1],v=e[3*o+2];return Math.abs(s-c)<.01?[new Pe(a,1-h),new Pe(l,1-u),new Pe(p,1-f),new Pe(m,1-v)]:[new Pe(s,1-h),new Pe(c,1-u),new Pe(d,1-f),new Pe(g,1-v)]}};function zo(t,e,i){if(i.shapes=[],Array.isArray(t))for(var r=0,n=t.length;r<n;r++){var o=t[r];i.shapes.push(o.uuid)}else i.shapes.push(t.uuid);return void 0!==e.extrudePath&&(i.options.extrudePath=e.extrudePath.toJSON()),i}function No(t,e){xi.call(this),this.type="TextGeometry",this.parameters={text:t,parameters:e},this.fromBufferGeometry(new ko(t,e)),this.mergeVertices()}function ko(t,e){var i=(e=e||{}).font;if(!i||!i.isFont)return new xi;var r=i.generateShapes(t,e.size);e.depth=void 0!==e.height?e.height:50,void 0===e.bevelThickness&&(e.bevelThickness=10),void 0===e.bevelSize&&(e.bevelSize=8),void 0===e.bevelEnabled&&(e.bevelEnabled=!1),Io.call(this,r,e),this.type="TextBufferGeometry"}function jo(t,e,i,r,n,o,a){xi.call(this),this.type="SphereGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:i,phiStart:r,phiLength:n,thetaStart:o,thetaLength:a},this.fromBufferGeometry(new Vo(t,e,i,r,n,o,a)),this.mergeVertices()}function Vo(t,e,i,r,n,o,a){Hi.call(this),this.type="SphereBufferGeometry",this.parameters={radius:t,widthSegments:e,heightSegments:i,phiStart:r,phiLength:n,thetaStart:o,thetaLength:a},t=t||1,e=Math.max(3,Math.floor(e)||8),i=Math.max(2,Math.floor(i)||6),r=void 0!==r?r:0,n=void 0!==n?n:2*Math.PI;var s,h,l=(o=void 0!==o?o:0)+(a=void 0!==a?a:Math.PI),c=0,u=[],p=new Oe,d=new Oe,f=[],m=[],g=[],v=[];for(h=0;h<=i;h++){var y=[],E=h/i;for(s=0;s<=e;s++){var x=s/e;p.x=-t*Math.cos(r+x*n)*Math.sin(o+E*a),p.y=t*Math.cos(o+E*a),p.z=t*Math.sin(r+x*n)*Math.sin(o+E*a),m.push(p.x,p.y,p.z),d.set(p.x,p.y,p.z).normalize(),g.push(d.x,d.y,d.z),v.push(x,1-E),y.push(c++)}u.push(y)}for(h=0;h<i;h++)for(s=0;s<e;s++){var _=u[h][s+1],w=u[h][s],b=u[h+1][s],S=u[h+1][s+1];(0!==h||o>0)&&f.push(_,w,S),(h!==i-1||l<Math.PI)&&f.push(w,b,S)}this.setIndex(f),this.addAttribute("position",new Ci(m,3)),this.addAttribute("normal",new Ci(g,3)),this.addAttribute("uv",new Ci(v,2))}function Fo(t,e,i,r,n,o){xi.call(this),this.type="RingGeometry",this.parameters={innerRadius:t,outerRadius:e,thetaSegments:i,phiSegments:r,thetaStart:n,thetaLength:o},this.fromBufferGeometry(new Uo(t,e,i,r,n,o)),this.mergeVertices()}function Uo(t,e,i,r,n,o){Hi.call(this),this.type="RingBufferGeometry",this.parameters={innerRadius:t,outerRadius:e,thetaSegments:i,phiSegments:r,thetaStart:n,thetaLength:o},t=t||.5,e=e||1,n=void 0!==n?n:0,o=void 0!==o?o:2*Math.PI,i=void 0!==i?Math.max(3,i):8;var a,s,h,l=[],c=[],u=[],p=[],d=t,f=(e-t)/(r=void 0!==r?Math.max(1,r):1),m=new Oe,g=new Pe;for(s=0;s<=r;s++){for(h=0;h<=i;h++)a=n+h/i*o,m.x=d*Math.cos(a),m.y=d*Math.sin(a),c.push(m.x,m.y,m.z),u.push(0,0,1),g.x=(m.x/e+1)/2,g.y=(m.y/e+1)/2,p.push(g.x,g.y);d+=f}for(s=0;s<r;s++){var v=s*(i+1);for(h=0;h<i;h++){var y=a=h+v,E=a+i+1,x=a+i+2,_=a+1;l.push(y,E,_),l.push(E,x,_)}}this.setIndex(l),this.addAttribute("position",new Ci(c,3)),this.addAttribute("normal",new Ci(u,3)),this.addAttribute("uv",new Ci(p,2))}function Go(t,e,i,r){xi.call(this),this.type="LatheGeometry",this.parameters={points:t,segments:e,phiStart:i,phiLength:r},this.fromBufferGeometry(new Wo(t,e,i,r)),this.mergeVertices()}function Wo(t,e,i,r){Hi.call(this),this.type="LatheBufferGeometry",this.parameters={points:t,segments:e,phiStart:i,phiLength:r},e=Math.floor(e)||12,i=i||0,r=r||2*Math.PI,r=Ce.clamp(r,0,2*Math.PI);var n,o,a,s=[],h=[],l=[],c=1/e,u=new Oe,p=new Pe;for(o=0;o<=e;o++){var d=i+o*c*r,f=Math.sin(d),m=Math.cos(d);for(a=0;a<=t.length-1;a++)u.x=t[a].x*f,u.y=t[a].y,u.z=t[a].x*m,h.push(u.x,u.y,u.z),p.x=o/e,p.y=a/(t.length-1),l.push(p.x,p.y)}for(o=0;o<e;o++)for(a=0;a<t.length-1;a++){var g=n=a+o*t.length,v=n+t.length,y=n+t.length+1,E=n+1;s.push(g,v,E),s.push(v,y,E)}if(this.setIndex(s),this.addAttribute("position",new Ci(h,3)),this.addAttribute("uv",new Ci(l,2)),this.computeVertexNormals(),r===2*Math.PI){var x=this.attributes.normal.array,_=new Oe,w=new Oe,b=new Oe;for(n=e*t.length*3,o=0,a=0;o<t.length;o++,a+=3)_.x=x[a+0],_.y=x[a+1],_.z=x[a+2],w.x=x[n+a+0],w.y=x[n+a+1],w.z=x[n+a+2],b.addVectors(_,w).normalize(),x[a+0]=x[n+a+0]=b.x,x[a+1]=x[n+a+1]=b.y,x[a+2]=x[n+a+2]=b.z}}function Xo(t,e){xi.call(this),this.type="ShapeGeometry","object"==typeof e&&(e=e.curveSegments),this.parameters={shapes:t,curveSegments:e},this.fromBufferGeometry(new Zo(t,e)),this.mergeVertices()}function Zo(t,e){Hi.call(this),this.type="ShapeBufferGeometry",this.parameters={shapes:t,curveSegments:e},e=e||12;var i=[],r=[],n=[],o=[],a=0,s=0;if(!1===Array.isArray(t))l(t);else for(var h=0;h<t.length;h++)l(t[h]),this.addGroup(a,s,h),a+=s,s=0;function l(t){var a,h,l,c=r.length/3,u=t.extractPoints(e),p=u.shape,d=u.holes;if(!1===Do.isClockWise(p))for(p=p.reverse(),a=0,h=d.length;a<h;a++)l=d[a],!0===Do.isClockWise(l)&&(d[a]=l.reverse());var f=Do.triangulateShape(p,d);for(a=0,h=d.length;a<h;a++)l=d[a],p=p.concat(l);for(a=0,h=p.length;a<h;a++){var m=p[a];r.push(m.x,m.y,0),n.push(0,0,1),o.push(m.x,m.y)}for(a=0,h=f.length;a<h;a++){var g=f[a],v=g[0]+c,y=g[1]+c,E=g[2]+c;i.push(v,y,E),s+=3}}this.setIndex(i),this.addAttribute("position",new Ci(r,3)),this.addAttribute("normal",new Ci(n,3)),this.addAttribute("uv",new Ci(o,2))}function Yo(t,e){if(e.shapes=[],Array.isArray(t))for(var i=0,r=t.length;i<r;i++){var n=t[i];e.shapes.push(n.uuid)}else e.shapes.push(t.uuid);return e}function qo(t,e){Hi.call(this),this.type="EdgesGeometry",this.parameters={thresholdAngle:e},e=void 0!==e?e:1;var i,r,n,o,a=[],s=Math.cos(Ce.DEG2RAD*e),h=[0,0],l={},c=["a","b","c"];t.isBufferGeometry?(o=new xi).fromBufferGeometry(t):o=t.clone(),o.mergeVertices(),o.computeFaceNormals();for(var u=o.vertices,p=o.faces,d=0,f=p.length;d<f;d++)for(var m=p[d],g=0;g<3;g++)i=m[c[g]],r=m[c[(g+1)%3]],h[0]=Math.min(i,r),h[1]=Math.max(i,r),void 0===l[n=h[0]+","+h[1]]?l[n]={index1:h[0],index2:h[1],face1:d,face2:void 0}:l[n].face2=d;for(n in l){var v=l[n];if(void 0===v.face2||p[v.face1].normal.dot(p[v.face2].normal)<=s){var y=u[v.index1];a.push(y.x,y.y,y.z),y=u[v.index2],a.push(y.x,y.y,y.z)}}this.addAttribute("position",new Ci(a,3))}function Jo(t,e,i,r,n,o,a,s){xi.call(this),this.type="CylinderGeometry",this.parameters={radiusTop:t,radiusBottom:e,height:i,radialSegments:r,heightSegments:n,openEnded:o,thetaStart:a,thetaLength:s},this.fromBufferGeometry(new Qo(t,e,i,r,n,o,a,s)),this.mergeVertices()}function Qo(t,e,i,r,n,o,a,s){Hi.call(this),this.type="CylinderBufferGeometry",this.parameters={radiusTop:t,radiusBottom:e,height:i,radialSegments:r,heightSegments:n,openEnded:o,thetaStart:a,thetaLength:s};var h=this;t=void 0!==t?t:1,e=void 0!==e?e:1,i=i||1,r=Math.floor(r)||8,n=Math.floor(n)||1,o=void 0!==o&&o,a=void 0!==a?a:0,s=void 0!==s?s:2*Math.PI;var l=[],c=[],u=[],p=[],d=0,f=[],m=i/2,g=0;function v(i){var n,o,f,v=new Pe,y=new Oe,E=0,x=!0===i?t:e,_=!0===i?1:-1;for(o=d,n=1;n<=r;n++)c.push(0,m*_,0),u.push(0,_,0),p.push(.5,.5),d++;for(f=d,n=0;n<=r;n++){var w=n/r*s+a,b=Math.cos(w),S=Math.sin(w);y.x=x*S,y.y=m*_,y.z=x*b,c.push(y.x,y.y,y.z),u.push(0,_,0),v.x=.5*b+.5,v.y=.5*S*_+.5,p.push(v.x,v.y),d++}for(n=0;n<r;n++){var T=o+n,M=f+n;!0===i?l.push(M,M+1,T):l.push(M+1,M,T),E+=3}h.addGroup(g,E,!0===i?1:2),g+=E}!function(){var o,v,y=new Oe,E=new Oe,x=0,_=(e-t)/i;for(v=0;v<=n;v++){var w=[],b=v/n,S=b*(e-t)+t;for(o=0;o<=r;o++){var T=o/r,M=T*s+a,R=Math.sin(M),A=Math.cos(M);E.x=S*R,E.y=-b*i+m,E.z=S*A,c.push(E.x,E.y,E.z),y.set(R,_,A).normalize(),u.push(y.x,y.y,y.z),p.push(T,1-b),w.push(d++)}f.push(w)}for(o=0;o<r;o++)for(v=0;v<n;v++){var C=f[v][o],P=f[v+1][o],D=f[v+1][o+1],L=f[v][o+1];l.push(C,P,L),l.push(P,D,L),x+=6}h.addGroup(g,x,0),g+=x}(),!1===o&&(t>0&&v(!0),e>0&&v(!1)),this.setIndex(l),this.addAttribute("position",new Ci(c,3)),this.addAttribute("normal",new Ci(u,3)),this.addAttribute("uv",new Ci(p,2))}function Ko(t,e,i,r,n,o,a){Jo.call(this,0,t,e,i,r,n,o,a),this.type="ConeGeometry",this.parameters={radius:t,height:e,radialSegments:i,heightSegments:r,openEnded:n,thetaStart:o,thetaLength:a}}function $o(t,e,i,r,n,o,a){Qo.call(this,0,t,e,i,r,n,o,a),this.type="ConeBufferGeometry",this.parameters={radius:t,height:e,radialSegments:i,heightSegments:r,openEnded:n,thetaStart:o,thetaLength:a}}function ta(t,e,i,r){xi.call(this),this.type="CircleGeometry",this.parameters={radius:t,segments:e,thetaStart:i,thetaLength:r},this.fromBufferGeometry(new ea(t,e,i,r)),this.mergeVertices()}function ea(t,e,i,r){Hi.call(this),this.type="CircleBufferGeometry",this.parameters={radius:t,segments:e,thetaStart:i,thetaLength:r},t=t||1,e=void 0!==e?Math.max(3,e):8,i=void 0!==i?i:0,r=void 0!==r?r:2*Math.PI;var n,o,a=[],s=[],h=[],l=[],c=new Oe,u=new Pe;for(s.push(0,0,0),h.push(0,0,1),l.push(.5,.5),o=0,n=3;o<=e;o++,n+=3){var p=i+o/e*r;c.x=t*Math.cos(p),c.y=t*Math.sin(p),s.push(c.x,c.y,c.z),h.push(0,0,1),u.x=(s[n]/t+1)/2,u.y=(s[n+1]/t+1)/2,l.push(u.x,u.y)}for(n=1;n<=e;n++)a.push(n,n+1,0);this.setIndex(a),this.addAttribute("position",new Ci(s,3)),this.addAttribute("normal",new Ci(h,3)),this.addAttribute("uv",new Ci(l,2))}No.prototype=Object.create(xi.prototype),No.prototype.constructor=No,ko.prototype=Object.create(Io.prototype),ko.prototype.constructor=ko,jo.prototype=Object.create(xi.prototype),jo.prototype.constructor=jo,Vo.prototype=Object.create(Hi.prototype),Vo.prototype.constructor=Vo,Fo.prototype=Object.create(xi.prototype),Fo.prototype.constructor=Fo,Uo.prototype=Object.create(Hi.prototype),Uo.prototype.constructor=Uo,Go.prototype=Object.create(xi.prototype),Go.prototype.constructor=Go,Wo.prototype=Object.create(Hi.prototype),Wo.prototype.constructor=Wo,Xo.prototype=Object.create(xi.prototype),Xo.prototype.constructor=Xo,Xo.prototype.toJSON=function(){var t=xi.prototype.toJSON.call(this);return Yo(this.parameters.shapes,t)},Zo.prototype=Object.create(Hi.prototype),Zo.prototype.constructor=Zo,Zo.prototype.toJSON=function(){var t=Hi.prototype.toJSON.call(this);return Yo(this.parameters.shapes,t)},qo.prototype=Object.create(Hi.prototype),qo.prototype.constructor=qo,Jo.prototype=Object.create(xi.prototype),Jo.prototype.constructor=Jo,Qo.prototype=Object.create(Hi.prototype),Qo.prototype.constructor=Qo,Ko.prototype=Object.create(Jo.prototype),Ko.prototype.constructor=Ko,$o.prototype=Object.create(Qo.prototype),$o.prototype.constructor=$o,ta.prototype=Object.create(xi.prototype),ta.prototype.constructor=ta,ea.prototype=Object.create(Hi.prototype),ea.prototype.constructor=ea;var ia=Object.freeze({WireframeGeometry:Un,ParametricGeometry:Gn,ParametricBufferGeometry:Wn,TetrahedronGeometry:Yn,TetrahedronBufferGeometry:qn,OctahedronGeometry:Jn,OctahedronBufferGeometry:Qn,IcosahedronGeometry:Kn,IcosahedronBufferGeometry:$n,DodecahedronGeometry:to,DodecahedronBufferGeometry:eo,PolyhedronGeometry:Xn,PolyhedronBufferGeometry:Zn,TubeGeometry:io,TubeBufferGeometry:ro,TorusKnotGeometry:no,TorusKnotBufferGeometry:oo,TorusGeometry:ao,TorusBufferGeometry:so,TextGeometry:No,TextBufferGeometry:ko,SphereGeometry:jo,SphereBufferGeometry:Vo,RingGeometry:Fo,RingBufferGeometry:Uo,PlaneGeometry:zi,PlaneBufferGeometry:Ni,LatheGeometry:Go,LatheBufferGeometry:Wo,ShapeGeometry:Xo,ShapeBufferGeometry:Zo,ExtrudeGeometry:Ho,ExtrudeBufferGeometry:Io,EdgesGeometry:qo,ConeGeometry:Ko,ConeBufferGeometry:$o,CylinderGeometry:Jo,CylinderBufferGeometry:Qo,CircleGeometry:ta,CircleBufferGeometry:ea,BoxGeometry:Ii,BoxBufferGeometry:Bi});function ra(t){Zi.call(this),this.type="ShadowMaterial",this.color=new ti(0),this.transparent=!0,this.setValues(t)}function na(t){qi.call(this,t),this.type="RawShaderMaterial"}function oa(t){Zi.call(this),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new ti(16777215),this.roughness=.5,this.metalness=.5,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ti(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=Re,this.normalScale=new Pe(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}function aa(t){oa.call(this),this.defines={PHYSICAL:""},this.type="MeshPhysicalMaterial",this.reflectivity=.5,this.clearCoat=0,this.clearCoatRoughness=0,this.setValues(t)}function sa(t){Zi.call(this),this.type="MeshPhongMaterial",this.color=new ti(16777215),this.specular=new ti(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ti(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=Re,this.normalScale=new Pe(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=tt,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}function ha(t){sa.call(this),this.defines={TOON:""},this.type="MeshToonMaterial",this.gradientMap=null,this.setValues(t)}function la(t){Zi.call(this),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalMapType=Re,this.normalScale=new Pe(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}function ca(t){Zi.call(this),this.type="MeshLambertMaterial",this.color=new ti(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new ti(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=tt,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(t)}function ua(t){Hn.call(this),this.type="LineDashedMaterial",this.scale=1,this.dashSize=3,this.gapSize=1,this.setValues(t)}ra.prototype=Object.create(Zi.prototype),ra.prototype.constructor=ra,ra.prototype.isShadowMaterial=!0,ra.prototype.copy=function(t){return Zi.prototype.copy.call(this,t),this.color.copy(t.color),this},na.prototype=Object.create(qi.prototype),na.prototype.constructor=na,na.prototype.isRawShaderMaterial=!0,oa.prototype=Object.create(Zi.prototype),oa.prototype.constructor=oa,oa.prototype.isMeshStandardMaterial=!0,oa.prototype.copy=function(t){return Zi.prototype.copy.call(this,t),this.defines={STANDARD:""},this.color.copy(t.color),this.roughness=t.roughness,this.metalness=t.metalness,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.roughnessMap=t.roughnessMap,this.metalnessMap=t.metalnessMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.envMapIntensity=t.envMapIntensity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},aa.prototype=Object.create(oa.prototype),aa.prototype.constructor=aa,aa.prototype.isMeshPhysicalMaterial=!0,aa.prototype.copy=function(t){return oa.prototype.copy.call(this,t),this.defines={PHYSICAL:""},this.reflectivity=t.reflectivity,this.clearCoat=t.clearCoat,this.clearCoatRoughness=t.clearCoatRoughness,this},sa.prototype=Object.create(Zi.prototype),sa.prototype.constructor=sa,sa.prototype.isMeshPhongMaterial=!0,sa.prototype.copy=function(t){return Zi.prototype.copy.call(this,t),this.color.copy(t.color),this.specular.copy(t.specular),this.shininess=t.shininess,this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},ha.prototype=Object.create(sa.prototype),ha.prototype.constructor=ha,ha.prototype.isMeshToonMaterial=!0,ha.prototype.copy=function(t){return sa.prototype.copy.call(this,t),this.gradientMap=t.gradientMap,this},la.prototype=Object.create(Zi.prototype),la.prototype.constructor=la,la.prototype.isMeshNormalMaterial=!0,la.prototype.copy=function(t){return Zi.prototype.copy.call(this,t),this.bumpMap=t.bumpMap,this.bumpScale=t.bumpScale,this.normalMap=t.normalMap,this.normalMapType=t.normalMapType,this.normalScale.copy(t.normalScale),this.displacementMap=t.displacementMap,this.displacementScale=t.displacementScale,this.displacementBias=t.displacementBias,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},ca.prototype=Object.create(Zi.prototype),ca.prototype.constructor=ca,ca.prototype.isMeshLambertMaterial=!0,ca.prototype.copy=function(t){return Zi.prototype.copy.call(this,t),this.color.copy(t.color),this.map=t.map,this.lightMap=t.lightMap,this.lightMapIntensity=t.lightMapIntensity,this.aoMap=t.aoMap,this.aoMapIntensity=t.aoMapIntensity,this.emissive.copy(t.emissive),this.emissiveMap=t.emissiveMap,this.emissiveIntensity=t.emissiveIntensity,this.specularMap=t.specularMap,this.alphaMap=t.alphaMap,this.envMap=t.envMap,this.combine=t.combine,this.reflectivity=t.reflectivity,this.refractionRatio=t.refractionRatio,this.wireframe=t.wireframe,this.wireframeLinewidth=t.wireframeLinewidth,this.wireframeLinecap=t.wireframeLinecap,this.wireframeLinejoin=t.wireframeLinejoin,this.skinning=t.skinning,this.morphTargets=t.morphTargets,this.morphNormals=t.morphNormals,this},ua.prototype=Object.create(Hn.prototype),ua.prototype.constructor=ua,ua.prototype.isLineDashedMaterial=!0,ua.prototype.copy=function(t){return Hn.prototype.copy.call(this,t),this.scale=t.scale,this.dashSize=t.dashSize,this.gapSize=t.gapSize,this};var pa=Object.freeze({ShadowMaterial:ra,SpriteMaterial:An,RawShaderMaterial:na,ShaderMaterial:qi,PointsMaterial:Nn,MeshPhysicalMaterial:aa,MeshStandardMaterial:oa,MeshPhongMaterial:sa,MeshToonMaterial:ha,MeshNormalMaterial:la,MeshLambertMaterial:ca,MeshDepthMaterial:dn,MeshDistanceMaterial:fn,MeshBasicMaterial:Yi,LineDashedMaterial:ua,LineBasicMaterial:Hn,Material:Zi}),da={enabled:!1,files:{},add:function(t,e){!1!==this.enabled&&(this.files[t]=e)},get:function(t){if(!1!==this.enabled)return this.files[t]},remove:function(t){delete this.files[t]},clear:function(){this.files={}}};function fa(t,e,i){var r=this,n=!1,o=0,a=0,s=void 0;this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=i,this.itemStart=function(t){a++,!1===n&&void 0!==r.onStart&&r.onStart(t,o,a),n=!0},this.itemEnd=function(t){o++,void 0!==r.onProgress&&r.onProgress(t,o,a),o===a&&(n=!1,void 0!==r.onLoad&&r.onLoad())},this.itemError=function(t){void 0!==r.onError&&r.onError(t)},this.resolveURL=function(t){return s?s(t):t},this.setURLModifier=function(t){return s=t,this}}var ma=new fa,ga={};function va(t){this.manager=void 0!==t?t:ma}function ya(t){this.manager=void 0!==t?t:ma,this._parser=null}function Ea(t){this.manager=void 0!==t?t:ma,this._parser=null}function xa(t){this.manager=void 0!==t?t:ma}function _a(t){this.manager=void 0!==t?t:ma}function wa(t){this.manager=void 0!==t?t:ma}function ba(){this.type="Curve",this.arcLengthDivisions=200}function Sa(t,e,i,r,n,o,a,s){ba.call(this),this.type="EllipseCurve",this.aX=t||0,this.aY=e||0,this.xRadius=i||1,this.yRadius=r||1,this.aStartAngle=n||0,this.aEndAngle=o||2*Math.PI,this.aClockwise=a||!1,this.aRotation=s||0}function Ta(t,e,i,r,n,o){Sa.call(this,t,e,i,i,r,n,o),this.type="ArcCurve"}function Ma(){var t=0,e=0,i=0,r=0;function n(n,o,a,s){t=n,e=a,i=-3*n+3*o-2*a-s,r=2*n-2*o+a+s}return{initCatmullRom:function(t,e,i,r,o){n(e,i,o*(i-t),o*(r-e))},initNonuniformCatmullRom:function(t,e,i,r,o,a,s){var h=(e-t)/o-(i-t)/(o+a)+(i-e)/a,l=(i-e)/a-(r-e)/(a+s)+(r-i)/s;n(e,i,h*=a,l*=a)},calc:function(n){var o=n*n;return t+e*n+i*o+r*(o*n)}}}Object.assign(va.prototype,{load:function(t,e,i,r){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);var n=this,o=da.get(t);if(void 0!==o)return n.manager.itemStart(t),setTimeout(function(){e&&e(o),n.manager.itemEnd(t)},0),o;if(void 0===ga[t]){var a=t.match(/^data:(.*?)(;base64)?,(.*)$/);if(a){var s=a[1],h=!!a[2],l=a[3];l=window.decodeURIComponent(l),h&&(l=window.atob(l));try{var c,u=(this.responseType||"").toLowerCase();switch(u){case"arraybuffer":case"blob":for(var p=new Uint8Array(l.length),d=0;d<l.length;d++)p[d]=l.charCodeAt(d);c="blob"===u?new Blob([p.buffer],{type:s}):p.buffer;break;case"document":var f=new DOMParser;c=f.parseFromString(l,s);break;case"json":c=JSON.parse(l);break;default:c=l}window.setTimeout(function(){e&&e(c),n.manager.itemEnd(t)},0)}catch(e){window.setTimeout(function(){r&&r(e),n.manager.itemEnd(t),n.manager.itemError(t)},0)}}else{ga[t]=[],ga[t].push({onLoad:e,onProgress:i,onError:r});var m=new XMLHttpRequest;for(var g in m.open("GET",t,!0),m.addEventListener("load",function(e){var i=this.response;da.add(t,i);var r=ga[t];if(delete ga[t],200===this.status||0===this.status){this.status;for(var o=0,a=r.length;o<a;o++){(s=r[o]).onLoad&&s.onLoad(i)}n.manager.itemEnd(t)}else{for(o=0,a=r.length;o<a;o++){var s;(s=r[o]).onError&&s.onError(e)}n.manager.itemEnd(t),n.manager.itemError(t)}},!1),m.addEventListener("progress",function(e){for(var i=ga[t],r=0,n=i.length;r<n;r++){var o=i[r];o.onProgress&&o.onProgress(e)}},!1),m.addEventListener("error",function(e){var i=ga[t];delete ga[t];for(var r=0,o=i.length;r<o;r++){var a=i[r];a.onError&&a.onError(e)}n.manager.itemEnd(t),n.manager.itemError(t)},!1),void 0!==this.responseType&&(m.responseType=this.responseType),void 0!==this.withCredentials&&(m.withCredentials=this.withCredentials),m.overrideMimeType&&m.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain"),this.requestHeader)m.setRequestHeader(g,this.requestHeader[g]);m.send(null)}return n.manager.itemStart(t),m}ga[t].push({onLoad:e,onProgress:i,onError:r})},setPath:function(t){return this.path=t,this},setResponseType:function(t){return this.responseType=t,this},setWithCredentials:function(t){return this.withCredentials=t,this},setMimeType:function(t){return this.mimeType=t,this},setRequestHeader:function(t){return this.requestHeader=t,this}}),Object.assign(ya.prototype,{load:function(t,e,i,r){var n=this,o=[],a=new Vn;a.image=o;var s=new va(this.manager);function h(h){s.load(t[h],function(t){var i=n._parser(t,!0);o[h]={width:i.width,height:i.height,format:i.format,mipmaps:i.mipmaps},6===(l+=1)&&(1===i.mipmapCount&&(a.minFilter=_t),a.format=i.format,a.needsUpdate=!0,e&&e(a))},i,r)}if(s.setPath(this.path),s.setResponseType("arraybuffer"),Array.isArray(t))for(var l=0,c=0,u=t.length;c<u;++c)h(c);else s.load(t,function(t){var i=n._parser(t,!0);if(i.isCubemap)for(var r=i.mipmaps.length/i.mipmapCount,s=0;s<r;s++){o[s]={mipmaps:[]};for(var h=0;h<i.mipmapCount;h++)o[s].mipmaps.push(i.mipmaps[s*i.mipmapCount+h]),o[s].format=i.format,o[s].width=i.width,o[s].height=i.height}else a.image.width=i.width,a.image.height=i.height,a.mipmaps=i.mipmaps;1===i.mipmapCount&&(a.minFilter=_t),a.format=i.format,a.needsUpdate=!0,e&&e(a)},i,r);return a},setPath:function(t){return this.path=t,this}}),Object.assign(Ea.prototype,{load:function(t,e,i,r){var n=this,o=new We,a=new va(this.manager);return a.setResponseType("arraybuffer"),a.load(t,function(t){var i=n._parser(t);i&&(void 0!==i.image?o.image=i.image:void 0!==i.data&&(o.image.width=i.width,o.image.height=i.height,o.image.data=i.data),o.wrapS=void 0!==i.wrapS?i.wrapS:gt,o.wrapT=void 0!==i.wrapT?i.wrapT:gt,o.magFilter=void 0!==i.magFilter?i.magFilter:_t,o.minFilter=void 0!==i.minFilter?i.minFilter:bt,o.anisotropy=void 0!==i.anisotropy?i.anisotropy:1,void 0!==i.format&&(o.format=i.format),void 0!==i.type&&(o.type=i.type),void 0!==i.mipmaps&&(o.mipmaps=i.mipmaps),1===i.mipmapCount&&(o.minFilter=_t),o.needsUpdate=!0,e&&e(o,i))},i,r),o}}),Object.assign(xa.prototype,{crossOrigin:"anonymous",load:function(t,e,i,r){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);var n=this,o=da.get(t);if(void 0!==o)return n.manager.itemStart(t),setTimeout(function(){e&&e(o),n.manager.itemEnd(t)},0),o;var a=document.createElementNS("http://www.w3.org/1999/xhtml","img");function s(){a.removeEventListener("load",s,!1),a.removeEventListener("error",h,!1),da.add(t,this),e&&e(this),n.manager.itemEnd(t)}function h(e){a.removeEventListener("load",s,!1),a.removeEventListener("error",h,!1),r&&r(e),n.manager.itemEnd(t),n.manager.itemError(t)}return a.addEventListener("load",s,!1),a.addEventListener("error",h,!1),"data:"!==t.substr(0,5)&&void 0!==this.crossOrigin&&(a.crossOrigin=this.crossOrigin),n.manager.itemStart(t),a.src=t,a},setCrossOrigin:function(t){return this.crossOrigin=t,this},setPath:function(t){return this.path=t,this}}),Object.assign(_a.prototype,{crossOrigin:"anonymous",load:function(t,e,i,r){var n=new er,o=new xa(this.manager);o.setCrossOrigin(this.crossOrigin),o.setPath(this.path);var a=0;function s(i){o.load(t[i],function(t){n.images[i]=t,6===++a&&(n.needsUpdate=!0,e&&e(n))},void 0,r)}for(var h=0;h<t.length;++h)s(h);return n},setCrossOrigin:function(t){return this.crossOrigin=t,this},setPath:function(t){return this.path=t,this}}),Object.assign(wa.prototype,{crossOrigin:"anonymous",load:function(t,e,i,r){var n=new Ve,o=new xa(this.manager);return o.setCrossOrigin(this.crossOrigin),o.setPath(this.path),o.load(t,function(i){n.image=i;var r=t.search(/\.(jpg|jpeg)$/)>0||0===t.search(/^data\:image\/jpeg/);n.format=r?zt:Nt,n.needsUpdate=!0,void 0!==e&&e(n)},i,r),n},setCrossOrigin:function(t){return this.crossOrigin=t,this},setPath:function(t){return this.path=t,this}}),Object.assign(ba.prototype,{getPoint:function(){return null},getPointAt:function(t,e){var i=this.getUtoTmapping(t);return this.getPoint(i,e)},getPoints:function(t){void 0===t&&(t=5);for(var e=[],i=0;i<=t;i++)e.push(this.getPoint(i/t));return e},getSpacedPoints:function(t){void 0===t&&(t=5);for(var e=[],i=0;i<=t;i++)e.push(this.getPointAt(i/t));return e},getLength:function(){var t=this.getLengths();return t[t.length-1]},getLengths:function(t){if(void 0===t&&(t=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var e,i,r=[],n=this.getPoint(0),o=0;for(r.push(0),i=1;i<=t;i++)o+=(e=this.getPoint(i/t)).distanceTo(n),r.push(o),n=e;return this.cacheArcLengths=r,r},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(t,e){var i,r=this.getLengths(),n=0,o=r.length;i=e||t*r[o-1];for(var a,s=0,h=o-1;s<=h;)if((a=r[n=Math.floor(s+(h-s)/2)]-i)<0)s=n+1;else{if(!(a>0)){h=n;break}h=n-1}if(r[n=h]===i)return n/(o-1);var l=r[n];return(n+(i-l)/(r[n+1]-l))/(o-1)},getTangent:function(t){var e=t-1e-4,i=t+1e-4;e<0&&(e=0),i>1&&(i=1);var r=this.getPoint(e);return this.getPoint(i).clone().sub(r).normalize()},getTangentAt:function(t){var e=this.getUtoTmapping(t);return this.getTangent(e)},computeFrenetFrames:function(t,e){var i,r,n,o=new Oe,a=[],s=[],h=[],l=new Oe,c=new De;for(i=0;i<=t;i++)r=i/t,a[i]=this.getTangentAt(r),a[i].normalize();s[0]=new Oe,h[0]=new Oe;var u=Number.MAX_VALUE,p=Math.abs(a[0].x),d=Math.abs(a[0].y),f=Math.abs(a[0].z);for(p<=u&&(u=p,o.set(1,0,0)),d<=u&&(u=d,o.set(0,1,0)),f<=u&&o.set(0,0,1),l.crossVectors(a[0],o).normalize(),s[0].crossVectors(a[0],l),h[0].crossVectors(a[0],s[0]),i=1;i<=t;i++)s[i]=s[i-1].clone(),h[i]=h[i-1].clone(),l.crossVectors(a[i-1],a[i]),l.length()>Number.EPSILON&&(l.normalize(),n=Math.acos(Ce.clamp(a[i-1].dot(a[i]),-1,1)),s[i].applyMatrix4(c.makeRotationAxis(l,n))),h[i].crossVectors(a[i],s[i]);if(!0===e)for(n=Math.acos(Ce.clamp(s[0].dot(s[t]),-1,1)),n/=t,a[0].dot(l.crossVectors(s[0],s[t]))>0&&(n=-n),i=1;i<=t;i++)s[i].applyMatrix4(c.makeRotationAxis(a[i],n*i)),h[i].crossVectors(a[i],s[i]);return{tangents:a,normals:s,binormals:h}},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.arcLengthDivisions=t.arcLengthDivisions,this},toJSON:function(){var t={metadata:{version:4.5,type:"Curve",generator:"Curve.toJSON"}};return t.arcLengthDivisions=this.arcLengthDivisions,t.type=this.type,t},fromJSON:function(t){return this.arcLengthDivisions=t.arcLengthDivisions,this}}),Sa.prototype=Object.create(ba.prototype),Sa.prototype.constructor=Sa,Sa.prototype.isEllipseCurve=!0,Sa.prototype.getPoint=function(t,e){for(var i=e||new Pe,r=2*Math.PI,n=this.aEndAngle-this.aStartAngle,o=Math.abs(n)<Number.EPSILON;n<0;)n+=r;for(;n>r;)n-=r;n<Number.EPSILON&&(n=o?0:r),!0!==this.aClockwise||o||(n===r?n=-r:n-=r);var a=this.aStartAngle+t*n,s=this.aX+this.xRadius*Math.cos(a),h=this.aY+this.yRadius*Math.sin(a);if(0!==this.aRotation){var l=Math.cos(this.aRotation),c=Math.sin(this.aRotation),u=s-this.aX,p=h-this.aY;s=u*l-p*c+this.aX,h=u*c+p*l+this.aY}return i.set(s,h)},Sa.prototype.copy=function(t){return ba.prototype.copy.call(this,t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this},Sa.prototype.toJSON=function(){var t=ba.prototype.toJSON.call(this);return t.aX=this.aX,t.aY=this.aY,t.xRadius=this.xRadius,t.yRadius=this.yRadius,t.aStartAngle=this.aStartAngle,t.aEndAngle=this.aEndAngle,t.aClockwise=this.aClockwise,t.aRotation=this.aRotation,t},Sa.prototype.fromJSON=function(t){return ba.prototype.fromJSON.call(this,t),this.aX=t.aX,this.aY=t.aY,this.xRadius=t.xRadius,this.yRadius=t.yRadius,this.aStartAngle=t.aStartAngle,this.aEndAngle=t.aEndAngle,this.aClockwise=t.aClockwise,this.aRotation=t.aRotation,this},Ta.prototype=Object.create(Sa.prototype),Ta.prototype.constructor=Ta,Ta.prototype.isArcCurve=!0;var Ra=new Oe,Aa=new Ma,Ca=new Ma,Pa=new Ma;function Da(t,e,i,r){ba.call(this),this.type="CatmullRomCurve3",this.points=t||[],this.closed=e||!1,this.curveType=i||"centripetal",this.tension=r||.5}function La(t,e,i,r,n){var o=.5*(r-e),a=.5*(n-i),s=t*t;return(2*i-2*r+o+a)*(t*s)+(-3*i+3*r-2*o-a)*s+o*t+i}function Oa(t,e,i,r){return function(t,e){var i=1-t;return i*i*e}(t,e)+function(t,e){return 2*(1-t)*t*e}(t,i)+function(t,e){return t*t*e}(t,r)}function Ha(t,e,i,r,n){return function(t,e){var i=1-t;return i*i*i*e}(t,e)+function(t,e){var i=1-t;return 3*i*i*t*e}(t,i)+function(t,e){return 3*(1-t)*t*t*e}(t,r)+function(t,e){return t*t*t*e}(t,n)}function Ia(t,e,i,r){ba.call(this),this.type="CubicBezierCurve",this.v0=t||new Pe,this.v1=e||new Pe,this.v2=i||new Pe,this.v3=r||new Pe}function Ba(t,e,i,r){ba.call(this),this.type="CubicBezierCurve3",this.v0=t||new Oe,this.v1=e||new Oe,this.v2=i||new Oe,this.v3=r||new Oe}function za(t,e){ba.call(this),this.type="LineCurve",this.v1=t||new Pe,this.v2=e||new Pe}function Na(t,e){ba.call(this),this.type="LineCurve3",this.v1=t||new Oe,this.v2=e||new Oe}function ka(t,e,i){ba.call(this),this.type="QuadraticBezierCurve",this.v0=t||new Pe,this.v1=e||new Pe,this.v2=i||new Pe}function ja(t,e,i){ba.call(this),this.type="QuadraticBezierCurve3",this.v0=t||new Oe,this.v1=e||new Oe,this.v2=i||new Oe}function Va(t){ba.call(this),this.type="SplineCurve",this.points=t||[]}Da.prototype=Object.create(ba.prototype),Da.prototype.constructor=Da,Da.prototype.isCatmullRomCurve3=!0,Da.prototype.getPoint=function(t,e){var i,r,n,o,a=e||new Oe,s=this.points,h=s.length,l=(h-(this.closed?0:1))*t,c=Math.floor(l),u=l-c;if(this.closed?c+=c>0?0:(Math.floor(Math.abs(c)/h)+1)*h:0===u&&c===h-1&&(c=h-2,u=1),this.closed||c>0?i=s[(c-1)%h]:(Ra.subVectors(s[0],s[1]).add(s[0]),i=Ra),r=s[c%h],n=s[(c+1)%h],this.closed||c+2<h?o=s[(c+2)%h]:(Ra.subVectors(s[h-1],s[h-2]).add(s[h-1]),o=Ra),"centripetal"===this.curveType||"chordal"===this.curveType){var p="chordal"===this.curveType?.5:.25,d=Math.pow(i.distanceToSquared(r),p),f=Math.pow(r.distanceToSquared(n),p),m=Math.pow(n.distanceToSquared(o),p);f<1e-4&&(f=1),d<1e-4&&(d=f),m<1e-4&&(m=f),Aa.initNonuniformCatmullRom(i.x,r.x,n.x,o.x,d,f,m),Ca.initNonuniformCatmullRom(i.y,r.y,n.y,o.y,d,f,m),Pa.initNonuniformCatmullRom(i.z,r.z,n.z,o.z,d,f,m)}else"catmullrom"===this.curveType&&(Aa.initCatmullRom(i.x,r.x,n.x,o.x,this.tension),Ca.initCatmullRom(i.y,r.y,n.y,o.y,this.tension),Pa.initCatmullRom(i.z,r.z,n.z,o.z,this.tension));return a.set(Aa.calc(u),Ca.calc(u),Pa.calc(u)),a},Da.prototype.copy=function(t){ba.prototype.copy.call(this,t),this.points=[];for(var e=0,i=t.points.length;e<i;e++){var r=t.points[e];this.points.push(r.clone())}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this},Da.prototype.toJSON=function(){var t=ba.prototype.toJSON.call(this);t.points=[];for(var e=0,i=this.points.length;e<i;e++){var r=this.points[e];t.points.push(r.toArray())}return t.closed=this.closed,t.curveType=this.curveType,t.tension=this.tension,t},Da.prototype.fromJSON=function(t){ba.prototype.fromJSON.call(this,t),this.points=[];for(var e=0,i=t.points.length;e<i;e++){var r=t.points[e];this.points.push((new Oe).fromArray(r))}return this.closed=t.closed,this.curveType=t.curveType,this.tension=t.tension,this},Ia.prototype=Object.create(ba.prototype),Ia.prototype.constructor=Ia,Ia.prototype.isCubicBezierCurve=!0,Ia.prototype.getPoint=function(t,e){var i=e||new Pe,r=this.v0,n=this.v1,o=this.v2,a=this.v3;return i.set(Ha(t,r.x,n.x,o.x,a.x),Ha(t,r.y,n.y,o.y,a.y)),i},Ia.prototype.copy=function(t){return ba.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this},Ia.prototype.toJSON=function(){var t=ba.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t},Ia.prototype.fromJSON=function(t){return ba.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this},Ba.prototype=Object.create(ba.prototype),Ba.prototype.constructor=Ba,Ba.prototype.isCubicBezierCurve3=!0,Ba.prototype.getPoint=function(t,e){var i=e||new Oe,r=this.v0,n=this.v1,o=this.v2,a=this.v3;return i.set(Ha(t,r.x,n.x,o.x,a.x),Ha(t,r.y,n.y,o.y,a.y),Ha(t,r.z,n.z,o.z,a.z)),i},Ba.prototype.copy=function(t){return ba.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this.v3.copy(t.v3),this},Ba.prototype.toJSON=function(){var t=ba.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t.v3=this.v3.toArray(),t},Ba.prototype.fromJSON=function(t){return ba.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this.v3.fromArray(t.v3),this},za.prototype=Object.create(ba.prototype),za.prototype.constructor=za,za.prototype.isLineCurve=!0,za.prototype.getPoint=function(t,e){var i=e||new Pe;return 1===t?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(t).add(this.v1)),i},za.prototype.getPointAt=function(t,e){return this.getPoint(t,e)},za.prototype.getTangent=function(){return this.v2.clone().sub(this.v1).normalize()},za.prototype.copy=function(t){return ba.prototype.copy.call(this,t),this.v1.copy(t.v1),this.v2.copy(t.v2),this},za.prototype.toJSON=function(){var t=ba.prototype.toJSON.call(this);return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t},za.prototype.fromJSON=function(t){return ba.prototype.fromJSON.call(this,t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this},Na.prototype=Object.create(ba.prototype),Na.prototype.constructor=Na,Na.prototype.isLineCurve3=!0,Na.prototype.getPoint=function(t,e){var i=e||new Oe;return 1===t?i.copy(this.v2):(i.copy(this.v2).sub(this.v1),i.multiplyScalar(t).add(this.v1)),i},Na.prototype.getPointAt=function(t,e){return this.getPoint(t,e)},Na.prototype.copy=function(t){return ba.prototype.copy.call(this,t),this.v1.copy(t.v1),this.v2.copy(t.v2),this},Na.prototype.toJSON=function(){var t=ba.prototype.toJSON.call(this);return t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t},Na.prototype.fromJSON=function(t){return ba.prototype.fromJSON.call(this,t),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this},ka.prototype=Object.create(ba.prototype),ka.prototype.constructor=ka,ka.prototype.isQuadraticBezierCurve=!0,ka.prototype.getPoint=function(t,e){var i=e||new Pe,r=this.v0,n=this.v1,o=this.v2;return i.set(Oa(t,r.x,n.x,o.x),Oa(t,r.y,n.y,o.y)),i},ka.prototype.copy=function(t){return ba.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this},ka.prototype.toJSON=function(){var t=ba.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t},ka.prototype.fromJSON=function(t){return ba.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this},ja.prototype=Object.create(ba.prototype),ja.prototype.constructor=ja,ja.prototype.isQuadraticBezierCurve3=!0,ja.prototype.getPoint=function(t,e){var i=e||new Oe,r=this.v0,n=this.v1,o=this.v2;return i.set(Oa(t,r.x,n.x,o.x),Oa(t,r.y,n.y,o.y),Oa(t,r.z,n.z,o.z)),i},ja.prototype.copy=function(t){return ba.prototype.copy.call(this,t),this.v0.copy(t.v0),this.v1.copy(t.v1),this.v2.copy(t.v2),this},ja.prototype.toJSON=function(){var t=ba.prototype.toJSON.call(this);return t.v0=this.v0.toArray(),t.v1=this.v1.toArray(),t.v2=this.v2.toArray(),t},ja.prototype.fromJSON=function(t){return ba.prototype.fromJSON.call(this,t),this.v0.fromArray(t.v0),this.v1.fromArray(t.v1),this.v2.fromArray(t.v2),this},Va.prototype=Object.create(ba.prototype),Va.prototype.constructor=Va,Va.prototype.isSplineCurve=!0,Va.prototype.getPoint=function(t,e){var i=e||new Pe,r=this.points,n=(r.length-1)*t,o=Math.floor(n),a=n-o,s=r[0===o?o:o-1],h=r[o],l=r[o>r.length-2?r.length-1:o+1],c=r[o>r.length-3?r.length-1:o+2];return i.set(La(a,s.x,h.x,l.x,c.x),La(a,s.y,h.y,l.y,c.y)),i},Va.prototype.copy=function(t){ba.prototype.copy.call(this,t),this.points=[];for(var e=0,i=t.points.length;e<i;e++){var r=t.points[e];this.points.push(r.clone())}return this},Va.prototype.toJSON=function(){var t=ba.prototype.toJSON.call(this);t.points=[];for(var e=0,i=this.points.length;e<i;e++){var r=this.points[e];t.points.push(r.toArray())}return t},Va.prototype.fromJSON=function(t){ba.prototype.fromJSON.call(this,t),this.points=[];for(var e=0,i=t.points.length;e<i;e++){var r=t.points[e];this.points.push((new Pe).fromArray(r))}return this};var Fa=Object.freeze({ArcCurve:Ta,CatmullRomCurve3:Da,CubicBezierCurve:Ia,CubicBezierCurve3:Ba,EllipseCurve:Sa,LineCurve:za,LineCurve3:Na,QuadraticBezierCurve:ka,QuadraticBezierCurve3:ja,SplineCurve:Va});function Ua(){ba.call(this),this.type="CurvePath",this.curves=[],this.autoClose=!1}function Ga(t){Ua.call(this),this.type="Path",this.currentPoint=new Pe,t&&this.setFromPoints(t)}function Wa(t){Ga.call(this,t),this.uuid=Ce.generateUUID(),this.type="Shape",this.holes=[]}function Xa(t,e){di.call(this),this.type="Light",this.color=new ti(t),this.intensity=void 0!==e?e:1,this.receiveShadow=void 0}function Za(t,e,i){Xa.call(this,t,i),this.type="HemisphereLight",this.castShadow=void 0,this.position.copy(di.DefaultUp),this.updateMatrix(),this.groundColor=new ti(e)}function Ya(t){this.camera=t,this.bias=0,this.radius=1,this.mapSize=new Pe(512,512),this.map=null,this.matrix=new De}function qa(){Ya.call(this,new _n(50,1,.5,500))}function Ja(t,e,i,r,n,o){Xa.call(this,t,e),this.type="SpotLight",this.position.copy(di.DefaultUp),this.updateMatrix(),this.target=new di,Object.defineProperty(this,"power",{get:function(){return this.intensity*Math.PI},set:function(t){this.intensity=t/Math.PI}}),this.distance=void 0!==i?i:0,this.angle=void 0!==r?r:Math.PI/3,this.penumbra=void 0!==n?n:0,this.decay=void 0!==o?o:1,this.shadow=new qa}function Qa(t,e,i,r){Xa.call(this,t,e),this.type="PointLight",Object.defineProperty(this,"power",{get:function(){return 4*this.intensity*Math.PI},set:function(t){this.intensity=t/(4*Math.PI)}}),this.distance=void 0!==i?i:0,this.decay=void 0!==r?r:1,this.shadow=new Ya(new _n(90,1,.5,500))}function Ka(){Ya.call(this,new mi(-5,5,5,-5,.5,500))}function $a(t,e){Xa.call(this,t,e),this.type="DirectionalLight",this.position.copy(di.DefaultUp),this.updateMatrix(),this.target=new di,this.shadow=new Ka}function ts(t,e){Xa.call(this,t,e),this.type="AmbientLight",this.castShadow=void 0}function es(t,e,i,r){Xa.call(this,t,e),this.type="RectAreaLight",this.width=void 0!==i?i:10,this.height=void 0!==r?r:10}function is(t,e,i,r){ds.call(this,t,e,i,r)}function rs(t,e,i){ds.call(this,t,e,i)}function ns(t,e,i,r){this.parameterPositions=t,this._cachedIndex=0,this.resultBuffer=void 0!==r?r:new e.constructor(i),this.sampleValues=e,this.valueSize=i}function os(t,e,i,r){ns.call(this,t,e,i,r)}function as(t,e,i,r){ds.call(this,t,e,i,r)}function ss(t,e,i,r){ds.call(this,t,e,i,r)}function hs(t,e,i,r){ds.call(this,t,e,i,r)}function ls(t,e,i,r){ns.call(this,t,e,i,r),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0}function cs(t,e,i,r){ns.call(this,t,e,i,r)}function us(t,e,i,r){ns.call(this,t,e,i,r)}Ua.prototype=Object.assign(Object.create(ba.prototype),{constructor:Ua,add:function(t){this.curves.push(t)},closePath:function(){var t=this.curves[0].getPoint(0),e=this.curves[this.curves.length-1].getPoint(1);t.equals(e)||this.curves.push(new za(e,t))},getPoint:function(t){for(var e=t*this.getLength(),i=this.getCurveLengths(),r=0;r<i.length;){if(i[r]>=e){var n=i[r]-e,o=this.curves[r],a=o.getLength(),s=0===a?0:1-n/a;return o.getPointAt(s)}r++}return null},getLength:function(){var t=this.getCurveLengths();return t[t.length-1]},updateArcLengths:function(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()},getCurveLengths:function(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;for(var t=[],e=0,i=0,r=this.curves.length;i<r;i++)e+=this.curves[i].getLength(),t.push(e);return this.cacheLengths=t,t},getSpacedPoints:function(t){void 0===t&&(t=40);for(var e=[],i=0;i<=t;i++)e.push(this.getPoint(i/t));return this.autoClose&&e.push(e[0]),e},getPoints:function(t){t=t||12;for(var e,i=[],r=0,n=this.curves;r<n.length;r++)for(var o=n[r],a=o&&o.isEllipseCurve?2*t:o&&(o.isLineCurve||o.isLineCurve3)?1:o&&o.isSplineCurve?t*o.points.length:t,s=o.getPoints(a),h=0;h<s.length;h++){var l=s[h];e&&e.equals(l)||(i.push(l),e=l)}return this.autoClose&&i.length>1&&!i[i.length-1].equals(i[0])&&i.push(i[0]),i},copy:function(t){ba.prototype.copy.call(this,t),this.curves=[];for(var e=0,i=t.curves.length;e<i;e++){var r=t.curves[e];this.curves.push(r.clone())}return this.autoClose=t.autoClose,this},toJSON:function(){var t=ba.prototype.toJSON.call(this);t.autoClose=this.autoClose,t.curves=[];for(var e=0,i=this.curves.length;e<i;e++){var r=this.curves[e];t.curves.push(r.toJSON())}return t},fromJSON:function(t){ba.prototype.fromJSON.call(this,t),this.autoClose=t.autoClose,this.curves=[];for(var e=0,i=t.curves.length;e<i;e++){var r=t.curves[e];this.curves.push((new Fa[r.type]).fromJSON(r))}return this}}),Ga.prototype=Object.assign(Object.create(Ua.prototype),{constructor:Ga,setFromPoints:function(t){this.moveTo(t[0].x,t[0].y);for(var e=1,i=t.length;e<i;e++)this.lineTo(t[e].x,t[e].y)},moveTo:function(t,e){this.currentPoint.set(t,e)},lineTo:function(t,e){var i=new za(this.currentPoint.clone(),new Pe(t,e));this.curves.push(i),this.currentPoint.set(t,e)},quadraticCurveTo:function(t,e,i,r){var n=new ka(this.currentPoint.clone(),new Pe(t,e),new Pe(i,r));this.curves.push(n),this.currentPoint.set(i,r)},bezierCurveTo:function(t,e,i,r,n,o){var a=new Ia(this.currentPoint.clone(),new Pe(t,e),new Pe(i,r),new Pe(n,o));this.curves.push(a),this.currentPoint.set(n,o)},splineThru:function(t){var e=new Va([this.currentPoint.clone()].concat(t));this.curves.push(e),this.currentPoint.copy(t[t.length-1])},arc:function(t,e,i,r,n,o){var a=this.currentPoint.x,s=this.currentPoint.y;this.absarc(t+a,e+s,i,r,n,o)},absarc:function(t,e,i,r,n,o){this.absellipse(t,e,i,i,r,n,o)},ellipse:function(t,e,i,r,n,o,a,s){var h=this.currentPoint.x,l=this.currentPoint.y;this.absellipse(t+h,e+l,i,r,n,o,a,s)},absellipse:function(t,e,i,r,n,o,a,s){var h=new Sa(t,e,i,r,n,o,a,s);if(this.curves.length>0){var l=h.getPoint(0);l.equals(this.currentPoint)||this.lineTo(l.x,l.y)}this.curves.push(h);var c=h.getPoint(1);this.currentPoint.copy(c)},copy:function(t){return Ua.prototype.copy.call(this,t),this.currentPoint.copy(t.currentPoint),this},toJSON:function(){var t=Ua.prototype.toJSON.call(this);return t.currentPoint=this.currentPoint.toArray(),t},fromJSON:function(t){return Ua.prototype.fromJSON.call(this,t),this.currentPoint.fromArray(t.currentPoint),this}}),Wa.prototype=Object.assign(Object.create(Ga.prototype),{constructor:Wa,getPointsHoles:function(t){for(var e=[],i=0,r=this.holes.length;i<r;i++)e[i]=this.holes[i].getPoints(t);return e},extractPoints:function(t){return{shape:this.getPoints(t),holes:this.getPointsHoles(t)}},copy:function(t){Ga.prototype.copy.call(this,t),this.holes=[];for(var e=0,i=t.holes.length;e<i;e++){var r=t.holes[e];this.holes.push(r.clone())}return this},toJSON:function(){var t=Ga.prototype.toJSON.call(this);t.uuid=this.uuid,t.holes=[];for(var e=0,i=this.holes.length;e<i;e++){var r=this.holes[e];t.holes.push(r.toJSON())}return t},fromJSON:function(t){Ga.prototype.fromJSON.call(this,t),this.uuid=t.uuid,this.holes=[];for(var e=0,i=t.holes.length;e<i;e++){var r=t.holes[e];this.holes.push((new Ga).fromJSON(r))}return this}}),Xa.prototype=Object.assign(Object.create(di.prototype),{constructor:Xa,isLight:!0,copy:function(t){return di.prototype.copy.call(this,t),this.color.copy(t.color),this.intensity=t.intensity,this},toJSON:function(t){var e=di.prototype.toJSON.call(this,t);return e.object.color=this.color.getHex(),e.object.intensity=this.intensity,void 0!==this.groundColor&&(e.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(e.object.distance=this.distance),void 0!==this.angle&&(e.object.angle=this.angle),void 0!==this.decay&&(e.object.decay=this.decay),void 0!==this.penumbra&&(e.object.penumbra=this.penumbra),void 0!==this.shadow&&(e.object.shadow=this.shadow.toJSON()),e}}),Za.prototype=Object.assign(Object.create(Xa.prototype),{constructor:Za,isHemisphereLight:!0,copy:function(t){return Xa.prototype.copy.call(this,t),this.groundColor.copy(t.groundColor),this}}),Object.assign(Ya.prototype,{copy:function(t){return this.camera=t.camera.clone(),this.bias=t.bias,this.radius=t.radius,this.mapSize.copy(t.mapSize),this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){var t={};return 0!==this.bias&&(t.bias=this.bias),1!==this.radius&&(t.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(t.mapSize=this.mapSize.toArray()),t.camera=this.camera.toJSON(!1).object,delete t.camera.matrix,t}}),qa.prototype=Object.assign(Object.create(Ya.prototype),{constructor:qa,isSpotLightShadow:!0,update:function(t){var e=this.camera,i=2*Ce.RAD2DEG*t.angle,r=this.mapSize.width/this.mapSize.height,n=t.distance||e.far;i===e.fov&&r===e.aspect&&n===e.far||(e.fov=i,e.aspect=r,e.far=n,e.updateProjectionMatrix())}}),Ja.prototype=Object.assign(Object.create(Xa.prototype),{constructor:Ja,isSpotLight:!0,copy:function(t){return Xa.prototype.copy.call(this,t),this.distance=t.distance,this.angle=t.angle,this.penumbra=t.penumbra,this.decay=t.decay,this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}),Qa.prototype=Object.assign(Object.create(Xa.prototype),{constructor:Qa,isPointLight:!0,copy:function(t){return Xa.prototype.copy.call(this,t),this.distance=t.distance,this.decay=t.decay,this.shadow=t.shadow.clone(),this}}),Ka.prototype=Object.assign(Object.create(Ya.prototype),{constructor:Ka}),$a.prototype=Object.assign(Object.create(Xa.prototype),{constructor:$a,isDirectionalLight:!0,copy:function(t){return Xa.prototype.copy.call(this,t),this.target=t.target.clone(),this.shadow=t.shadow.clone(),this}}),ts.prototype=Object.assign(Object.create(Xa.prototype),{constructor:ts,isAmbientLight:!0}),es.prototype=Object.assign(Object.create(Xa.prototype),{constructor:es,isRectAreaLight:!0,copy:function(t){return Xa.prototype.copy.call(this,t),this.width=t.width,this.height=t.height,this},toJSON:function(t){var e=Xa.prototype.toJSON.call(this,t);return e.object.width=this.width,e.object.height=this.height,e}}),is.prototype=Object.assign(Object.create(ds.prototype),{constructor:is,ValueTypeName:"string",ValueBufferType:Array,DefaultInterpolation:2300,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),rs.prototype=Object.assign(Object.create(ds.prototype),{constructor:rs,ValueTypeName:"bool",ValueBufferType:Array,DefaultInterpolation:2300,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),Object.assign(ns.prototype,{evaluate:function(t){var e=this.parameterPositions,i=this._cachedIndex,r=e[i],n=e[i-1];t:{e:{var o;i:{r:if(!(t<r)){for(var a=i+2;;){if(void 0===r){if(t<n)break r;return i=e.length,this._cachedIndex=i,this.afterEnd_(i-1,t,n)}if(i===a)break;if(n=r,t<(r=e[++i]))break e}o=e.length;break i}if(t>=n)break t;var s=e[1];t<s&&(i=2,n=s);for(a=i-2;;){if(void 0===n)return this._cachedIndex=0,this.beforeStart_(0,t,r);if(i===a)break;if(r=n,t>=(n=e[--i-1]))break e}o=i,i=0}for(;i<o;){var h=i+o>>>1;t<e[h]?o=h:i=h+1}if(r=e[i],void 0===(n=e[i-1]))return this._cachedIndex=0,this.beforeStart_(0,t,r);if(void 0===r)return i=e.length,this._cachedIndex=i,this.afterEnd_(i-1,n,t)}this._cachedIndex=i,this.intervalChanged_(i,n,r)}return this.interpolate_(i,n,t,r)},settings:null,DefaultSettings_:{},getSettings_:function(){return this.settings||this.DefaultSettings_},copySampleValue_:function(t){for(var e=this.resultBuffer,i=this.sampleValues,r=this.valueSize,n=t*r,o=0;o!==r;++o)e[o]=i[n+o];return e},interpolate_:function(){throw new Error("call to abstract method")},intervalChanged_:function(){}}),Object.assign(ns.prototype,{beforeStart_:ns.prototype.copySampleValue_,afterEnd_:ns.prototype.copySampleValue_}),os.prototype=Object.assign(Object.create(ns.prototype),{constructor:os,interpolate_:function(t,e,i,r){for(var n=this.resultBuffer,o=this.sampleValues,a=this.valueSize,s=t*a,h=(i-e)/(r-e),l=s+a;s!==l;s+=4)Le.slerpFlat(n,0,o,s-a,o,s,h);return n}}),as.prototype=Object.assign(Object.create(ds.prototype),{constructor:as,ValueTypeName:"quaternion",DefaultInterpolation:2301,InterpolantFactoryMethodLinear:function(t){return new os(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodSmooth:void 0}),ss.prototype=Object.assign(Object.create(ds.prototype),{constructor:ss,ValueTypeName:"color"}),hs.prototype=Object.assign(Object.create(ds.prototype),{constructor:hs,ValueTypeName:"number"}),ls.prototype=Object.assign(Object.create(ns.prototype),{constructor:ls,DefaultSettings_:{endingStart:fe,endingEnd:fe},intervalChanged_:function(t,e,i){var r=this.parameterPositions,n=t-2,o=t+1,a=r[n],s=r[o];if(void 0===a)switch(this.getSettings_().endingStart){case 2401:n=t,a=2*e-i;break;case 2402:a=e+r[n=r.length-2]-r[n+1];break;default:n=t,a=i}if(void 0===s)switch(this.getSettings_().endingEnd){case 2401:o=t,s=2*i-e;break;case 2402:o=1,s=i+r[1]-r[0];break;default:o=t-1,s=e}var h=.5*(i-e),l=this.valueSize;this._weightPrev=h/(e-a),this._weightNext=h/(s-i),this._offsetPrev=n*l,this._offsetNext=o*l},interpolate_:function(t,e,i,r){for(var n=this.resultBuffer,o=this.sampleValues,a=this.valueSize,s=t*a,h=s-a,l=this._offsetPrev,c=this._offsetNext,u=this._weightPrev,p=this._weightNext,d=(i-e)/(r-e),f=d*d,m=f*d,g=-u*m+2*u*f-u*d,v=(1+u)*m+(-1.5-2*u)*f+(-.5+u)*d+1,y=(-1-p)*m+(1.5+p)*f+.5*d,E=p*m-p*f,x=0;x!==a;++x)n[x]=g*o[l+x]+v*o[h+x]+y*o[s+x]+E*o[c+x];return n}}),cs.prototype=Object.assign(Object.create(ns.prototype),{constructor:cs,interpolate_:function(t,e,i,r){for(var n=this.resultBuffer,o=this.sampleValues,a=this.valueSize,s=t*a,h=s-a,l=(i-e)/(r-e),c=1-l,u=0;u!==a;++u)n[u]=o[h+u]*c+o[s+u]*l;return n}}),us.prototype=Object.assign(Object.create(ns.prototype),{constructor:us,interpolate_:function(t){return this.copySampleValue_(t-1)}});var ps={arraySlice:function(t,e,i){return ps.isTypedArray(t)?new t.constructor(t.subarray(e,void 0!==i?i:t.length)):t.slice(e,i)},convertArray:function(t,e,i){return!t||!i&&t.constructor===e?t:"number"==typeof e.BYTES_PER_ELEMENT?new e(t):Array.prototype.slice.call(t)},isTypedArray:function(t){return ArrayBuffer.isView(t)&&!(t instanceof DataView)},getKeyframeOrder:function(t){for(var e=t.length,i=new Array(e),r=0;r!==e;++r)i[r]=r;return i.sort(function(e,i){return t[e]-t[i]}),i},sortedArray:function(t,e,i){for(var r=t.length,n=new t.constructor(r),o=0,a=0;a!==r;++o)for(var s=i[o]*e,h=0;h!==e;++h)n[a++]=t[s+h];return n},flattenJSON:function(t,e,i,r){for(var n=1,o=t[0];void 0!==o&&void 0===o[r];)o=t[n++];if(void 0!==o){var a=o[r];if(void 0!==a)if(Array.isArray(a))do{void 0!==(a=o[r])&&(e.push(o.time),i.push.apply(i,a)),o=t[n++]}while(void 0!==o);else if(void 0!==a.toArray)do{void 0!==(a=o[r])&&(e.push(o.time),a.toArray(i,i.length)),o=t[n++]}while(void 0!==o);else do{void 0!==(a=o[r])&&(e.push(o.time),i.push(a)),o=t[n++]}while(void 0!==o)}}};function ds(t,e,i,r){if(void 0===t)throw new Error("THREE.KeyframeTrack: track name is undefined");if(void 0===e||0===e.length)throw new Error("THREE.KeyframeTrack: no keyframes in track named "+t);this.name=t,this.times=ps.convertArray(e,this.TimeBufferType),this.values=ps.convertArray(i,this.ValueBufferType),this.setInterpolation(r||this.DefaultInterpolation),this.validate(),this.optimize()}function fs(t,e,i,r){ds.call(this,t,e,i,r)}function ms(t,e,i){this.name=t,this.tracks=i,this.duration=void 0!==e?e:-1,this.uuid=Ce.generateUUID(),this.duration<0&&this.resetDuration(),this.optimize()}function gs(t){this.manager=void 0!==t?t:ma,this.textures={}}function vs(t){this.manager=void 0!==t?t:ma}Object.assign(ds,{parse:function(t){if(void 0===t.type)throw new Error("THREE.KeyframeTrack: track type undefined, can not parse");var e=ds._getTrackTypeForValueTypeName(t.type);if(void 0===t.times){var i=[],r=[];ps.flattenJSON(t.keys,i,r,"value"),t.times=i,t.values=r}return void 0!==e.parse?e.parse(t):new e(t.name,t.times,t.values,t.interpolation)},toJSON:function(t){var e,i=t.constructor;if(void 0!==i.toJSON)e=i.toJSON(t);else{e={name:t.name,times:ps.convertArray(t.times,Array),values:ps.convertArray(t.values,Array)};var r=t.getInterpolation();r!==t.DefaultInterpolation&&(e.interpolation=r)}return e.type=t.ValueTypeName,e},_getTrackTypeForValueTypeName:function(t){switch(t.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return hs;case"vector":case"vector2":case"vector3":case"vector4":return fs;case"color":return ss;case"quaternion":return as;case"bool":case"boolean":return rs;case"string":return is}throw new Error("THREE.KeyframeTrack: Unsupported typeName: "+t)}}),Object.assign(ds.prototype,{constructor:ds,TimeBufferType:Float32Array,ValueBufferType:Float32Array,DefaultInterpolation:2301,InterpolantFactoryMethodDiscrete:function(t){return new us(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodLinear:function(t){return new cs(this.times,this.values,this.getValueSize(),t)},InterpolantFactoryMethodSmooth:function(t){return new ls(this.times,this.values,this.getValueSize(),t)},setInterpolation:function(t){var e;switch(t){case 2300:e=this.InterpolantFactoryMethodDiscrete;break;case 2301:e=this.InterpolantFactoryMethodLinear;break;case 2302:e=this.InterpolantFactoryMethodSmooth}if(void 0!==e)this.createInterpolant=e;else{var i="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(t===this.DefaultInterpolation)throw new Error(i);this.setInterpolation(this.DefaultInterpolation)}}},getInterpolation:function(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return 2300;case this.InterpolantFactoryMethodLinear:return 2301;case this.InterpolantFactoryMethodSmooth:return 2302}},getValueSize:function(){return this.values.length/this.times.length},shift:function(t){if(0!==t)for(var e=this.times,i=0,r=e.length;i!==r;++i)e[i]+=t;return this},scale:function(t){if(1!==t)for(var e=this.times,i=0,r=e.length;i!==r;++i)e[i]*=t;return this},trim:function(t,e){for(var i=this.times,r=i.length,n=0,o=r-1;n!==r&&i[n]<t;)++n;for(;-1!==o&&i[o]>e;)--o;if(++o,0!==n||o!==r){n>=o&&(n=(o=Math.max(o,1))-1);var a=this.getValueSize();this.times=ps.arraySlice(i,n,o),this.values=ps.arraySlice(this.values,n*a,o*a)}return this},validate:function(){var t=!0,e=this.getValueSize();e-Math.floor(e)!=0&&(t=!1);var i=this.times,r=this.values,n=i.length;0===n&&(t=!1);for(var o=null,a=0;a!==n;a++){var s=i[a];if("number"==typeof s&&isNaN(s)){t=!1;break}if(null!==o&&o>s){t=!1;break}o=s}if(void 0!==r&&ps.isTypedArray(r)){a=0;for(var h=r.length;a!==h;++a){var l=r[a];if(isNaN(l)){t=!1;break}}}return t},optimize:function(){for(var t=this.times,e=this.values,i=this.getValueSize(),r=2302===this.getInterpolation(),n=1,o=t.length-1,a=1;a<o;++a){var s=!1,h=t[a];if(h!==t[a+1]&&(1!==a||h!==h[0]))if(r)s=!0;else for(var l=a*i,c=l-i,u=l+i,p=0;p!==i;++p){var d=e[l+p];if(d!==e[c+p]||d!==e[u+p]){s=!0;break}}if(s){if(a!==n){t[n]=t[a];var f=a*i,m=n*i;for(p=0;p!==i;++p)e[m+p]=e[f+p]}++n}}if(o>0){t[n]=t[o];for(f=o*i,m=n*i,p=0;p!==i;++p)e[m+p]=e[f+p];++n}return n!==t.length&&(this.times=ps.arraySlice(t,0,n),this.values=ps.arraySlice(e,0,n*i)),this}}),fs.prototype=Object.assign(Object.create(ds.prototype),{constructor:fs,ValueTypeName:"vector"}),Object.assign(ms,{parse:function(t){for(var e=[],i=t.tracks,r=1/(t.fps||1),n=0,o=i.length;n!==o;++n)e.push(ds.parse(i[n]).scale(r));return new ms(t.name,t.duration,e)},toJSON:function(t){for(var e=[],i=t.tracks,r={name:t.name,duration:t.duration,tracks:e,uuid:t.uuid},n=0,o=i.length;n!==o;++n)e.push(ds.toJSON(i[n]));return r},CreateFromMorphTargetSequence:function(t,e,i,r){for(var n=e.length,o=[],a=0;a<n;a++){var s=[],h=[];s.push((a+n-1)%n,a,(a+1)%n),h.push(0,1,0);var l=ps.getKeyframeOrder(s);s=ps.sortedArray(s,1,l),h=ps.sortedArray(h,1,l),r||0!==s[0]||(s.push(n),h.push(h[0])),o.push(new hs(".morphTargetInfluences["+e[a].name+"]",s,h).scale(1/i))}return new ms(t,-1,o)},findByName:function(t,e){var i=t;if(!Array.isArray(t)){var r=t;i=r.geometry&&r.geometry.animations||r.animations}for(var n=0;n<i.length;n++)if(i[n].name===e)return i[n];return null},CreateClipsFromMorphTargetSequences:function(t,e,i){for(var r={},n=/^([\w-]*?)([\d]+)$/,o=0,a=t.length;o<a;o++){var s=t[o],h=s.name.match(n);if(h&&h.length>1){var l=r[u=h[1]];l||(r[u]=l=[]),l.push(s)}}var c=[];for(var u in r)c.push(ms.CreateFromMorphTargetSequence(u,r[u],e,i));return c},parseAnimation:function(t,e){if(!t)return null;for(var i=function(t,e,i,r,n){if(0!==i.length){var o=[],a=[];ps.flattenJSON(i,o,a,r),0!==o.length&&n.push(new t(e,o,a))}},r=[],n=t.name||"default",o=t.length||-1,a=t.fps||30,s=t.hierarchy||[],h=0;h<s.length;h++){var l=s[h].keys;if(l&&0!==l.length)if(l[0].morphTargets){for(var c={},u=0;u<l.length;u++)if(l[u].morphTargets)for(var p=0;p<l[u].morphTargets.length;p++)c[l[u].morphTargets[p]]=-1;for(var d in c){var f=[],m=[];for(p=0;p!==l[u].morphTargets.length;++p){var g=l[u];f.push(g.time),m.push(g.morphTarget===d?1:0)}r.push(new hs(".morphTargetInfluence["+d+"]",f,m))}o=c.length*(a||1)}else{var v=".bones["+e[h].name+"]";i(fs,v+".position",l,"pos",r),i(as,v+".quaternion",l,"rot",r),i(fs,v+".scale",l,"scl",r)}}return 0===r.length?null:new ms(n,o,r)}}),Object.assign(ms.prototype,{resetDuration:function(){for(var t=0,e=0,i=this.tracks.length;e!==i;++e){var r=this.tracks[e];t=Math.max(t,r.times[r.times.length-1])}this.duration=t},trim:function(){for(var t=0;t<this.tracks.length;t++)this.tracks[t].trim(0,this.duration);return this},optimize:function(){for(var t=0;t<this.tracks.length;t++)this.tracks[t].optimize();return this}}),Object.assign(gs.prototype,{load:function(t,e,i,r){var n=this;new va(n.manager).load(t,function(t){e(n.parse(JSON.parse(t)))},i,r)},setTextures:function(t){this.textures=t},parse:function(t){var e=this.textures;function i(t){return e[t],e[t]}var r=new pa[t.type];if(void 0!==t.uuid&&(r.uuid=t.uuid),void 0!==t.name&&(r.name=t.name),void 0!==t.color&&r.color.setHex(t.color),void 0!==t.roughness&&(r.roughness=t.roughness),void 0!==t.metalness&&(r.metalness=t.metalness),void 0!==t.emissive&&r.emissive.setHex(t.emissive),void 0!==t.specular&&r.specular.setHex(t.specular),void 0!==t.shininess&&(r.shininess=t.shininess),void 0!==t.clearCoat&&(r.clearCoat=t.clearCoat),void 0!==t.clearCoatRoughness&&(r.clearCoatRoughness=t.clearCoatRoughness),void 0!==t.uniforms&&(r.uniforms=t.uniforms),void 0!==t.vertexShader&&(r.vertexShader=t.vertexShader),void 0!==t.fragmentShader&&(r.fragmentShader=t.fragmentShader),void 0!==t.vertexColors&&(r.vertexColors=t.vertexColors),void 0!==t.fog&&(r.fog=t.fog),void 0!==t.flatShading&&(r.flatShading=t.flatShading),void 0!==t.blending&&(r.blending=t.blending),void 0!==t.side&&(r.side=t.side),void 0!==t.opacity&&(r.opacity=t.opacity),void 0!==t.transparent&&(r.transparent=t.transparent),void 0!==t.alphaTest&&(r.alphaTest=t.alphaTest),void 0!==t.depthTest&&(r.depthTest=t.depthTest),void 0!==t.depthWrite&&(r.depthWrite=t.depthWrite),void 0!==t.colorWrite&&(r.colorWrite=t.colorWrite),void 0!==t.wireframe&&(r.wireframe=t.wireframe),void 0!==t.wireframeLinewidth&&(r.wireframeLinewidth=t.wireframeLinewidth),void 0!==t.wireframeLinecap&&(r.wireframeLinecap=t.wireframeLinecap),void 0!==t.wireframeLinejoin&&(r.wireframeLinejoin=t.wireframeLinejoin),void 0!==t.rotation&&(r.rotation=t.rotation),1!==t.linewidth&&(r.linewidth=t.linewidth),void 0!==t.dashSize&&(r.dashSize=t.dashSize),void 0!==t.gapSize&&(r.gapSize=t.gapSize),void 0!==t.scale&&(r.scale=t.scale),void 0!==t.polygonOffset&&(r.polygonOffset=t.polygonOffset),void 0!==t.polygonOffsetFactor&&(r.polygonOffsetFactor=t.polygonOffsetFactor),void 0!==t.polygonOffsetUnits&&(r.polygonOffsetUnits=t.polygonOffsetUnits),void 0!==t.skinning&&(r.skinning=t.skinning),void 0!==t.morphTargets&&(r.morphTargets=t.morphTargets),void 0!==t.dithering&&(r.dithering=t.dithering),void 0!==t.visible&&(r.visible=t.visible),void 0!==t.userData&&(r.userData=t.userData),void 0!==t.shading&&(r.flatShading=1===t.shading),void 0!==t.size&&(r.size=t.size),void 0!==t.sizeAttenuation&&(r.sizeAttenuation=t.sizeAttenuation),void 0!==t.map&&(r.map=i(t.map)),void 0!==t.alphaMap&&(r.alphaMap=i(t.alphaMap),r.transparent=!0),void 0!==t.bumpMap&&(r.bumpMap=i(t.bumpMap)),void 0!==t.bumpScale&&(r.bumpScale=t.bumpScale),void 0!==t.normalMap&&(r.normalMap=i(t.normalMap)),void 0!==t.normalMapType&&(r.normalMapType=t.normalMapType),void 0!==t.normalScale){var n=t.normalScale;!1===Array.isArray(n)&&(n=[n,n]),r.normalScale=(new Pe).fromArray(n)}return void 0!==t.displacementMap&&(r.displacementMap=i(t.displacementMap)),void 0!==t.displacementScale&&(r.displacementScale=t.displacementScale),void 0!==t.displacementBias&&(r.displacementBias=t.displacementBias),void 0!==t.roughnessMap&&(r.roughnessMap=i(t.roughnessMap)),void 0!==t.metalnessMap&&(r.metalnessMap=i(t.metalnessMap)),void 0!==t.emissiveMap&&(r.emissiveMap=i(t.emissiveMap)),void 0!==t.emissiveIntensity&&(r.emissiveIntensity=t.emissiveIntensity),void 0!==t.specularMap&&(r.specularMap=i(t.specularMap)),void 0!==t.envMap&&(r.envMap=i(t.envMap)),void 0!==t.reflectivity&&(r.reflectivity=t.reflectivity),void 0!==t.lightMap&&(r.lightMap=i(t.lightMap)),void 0!==t.lightMapIntensity&&(r.lightMapIntensity=t.lightMapIntensity),void 0!==t.aoMap&&(r.aoMap=i(t.aoMap)),void 0!==t.aoMapIntensity&&(r.aoMapIntensity=t.aoMapIntensity),void 0!==t.gradientMap&&(r.gradientMap=i(t.gradientMap)),r}}),Object.assign(vs.prototype,{load:function(t,e,i,r){var n=this;new va(n.manager).load(t,function(t){e(n.parse(JSON.parse(t)))},i,r)},parse:function(t){var e=new Hi,i=t.data.index;if(void 0!==i){var r=new ws[i.type](i.array);e.setIndex(new _i(r,1))}var n=t.data.attributes;for(var o in n){var a=n[o];r=new ws[a.type](a.array);e.addAttribute(o,new _i(r,a.itemSize,a.normalized))}var s=t.data.groups||t.data.drawcalls||t.data.offsets;if(void 0!==s)for(var h=0,l=s.length;h!==l;++h){var c=s[h];e.addGroup(c.start,c.count,c.materialIndex)}var u=t.data.boundingSphere;if(void 0!==u){var p=new Oe;void 0!==u.center&&p.fromArray(u.center),e.boundingSphere=new Ze(p,u.radius)}return e}});var ys,Es,xs,_s,ws={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:"undefined"!=typeof Uint8ClampedArray?Uint8ClampedArray:Uint8Array,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};function bs(){}bs.Handlers={handlers:[],add:function(t,e){this.handlers.push(t,e)},get:function(t){for(var e=this.handlers,i=0,r=e.length;i<r;i+=2){var n=e[i],o=e[i+1];if(n.test(t))return o}return null}},Object.assign(bs.prototype,{crossOrigin:"anonymous",onLoadStart:function(){},onLoadProgress:function(){},onLoadComplete:function(){},initMaterials:function(t,e,i){for(var r=[],n=0;n<t.length;++n)r[n]=this.createMaterial(t[n],e,i);return r},createMaterial:(ys={NoBlending:S,NormalBlending:T,AdditiveBlending:M,SubtractiveBlending:R,MultiplyBlending:A,CustomBlending:C},Es=new ti,xs=new wa,_s=new gs,function(t,e,i){var r={};function n(t,n,o,a,s){var h,l=e+t,c=bs.Handlers.get(l);null!==c?h=c.load(l):(xs.setCrossOrigin(i),h=xs.load(l)),void 0!==n&&(h.repeat.fromArray(n),1!==n[0]&&(h.wrapS=mt),1!==n[1]&&(h.wrapT=mt)),void 0!==o&&h.offset.fromArray(o),void 0!==a&&("repeat"===a[0]&&(h.wrapS=mt),"mirror"===a[0]&&(h.wrapS=vt),"repeat"===a[1]&&(h.wrapT=mt),"mirror"===a[1]&&(h.wrapT=vt)),void 0!==s&&(h.anisotropy=s);var u=Ce.generateUUID();return r[u]=h,u}var o={uuid:Ce.generateUUID(),type:"MeshLambertMaterial"};for(var a in t){var s=t[a];switch(a){case"DbgColor":case"DbgIndex":case"opticalDensity":case"illumination":break;case"DbgName":o.name=s;break;case"blending":o.blending=ys[s];break;case"colorAmbient":case"mapAmbient":break;case"colorDiffuse":o.color=Es.fromArray(s).getHex();break;case"colorSpecular":o.specular=Es.fromArray(s).getHex();break;case"colorEmissive":o.emissive=Es.fromArray(s).getHex();break;case"specularCoef":o.shininess=s;break;case"shading":"basic"===s.toLowerCase()&&(o.type="MeshBasicMaterial"),"phong"===s.toLowerCase()&&(o.type="MeshPhongMaterial"),"standard"===s.toLowerCase()&&(o.type="MeshStandardMaterial");break;case"mapDiffuse":o.map=n(s,t.mapDiffuseRepeat,t.mapDiffuseOffset,t.mapDiffuseWrap,t.mapDiffuseAnisotropy);break;case"mapDiffuseRepeat":case"mapDiffuseOffset":case"mapDiffuseWrap":case"mapDiffuseAnisotropy":break;case"mapEmissive":o.emissiveMap=n(s,t.mapEmissiveRepeat,t.mapEmissiveOffset,t.mapEmissiveWrap,t.mapEmissiveAnisotropy);break;case"mapEmissiveRepeat":case"mapEmissiveOffset":case"mapEmissiveWrap":case"mapEmissiveAnisotropy":break;case"mapLight":o.lightMap=n(s,t.mapLightRepeat,t.mapLightOffset,t.mapLightWrap,t.mapLightAnisotropy);break;case"mapLightRepeat":case"mapLightOffset":case"mapLightWrap":case"mapLightAnisotropy":break;case"mapAO":o.aoMap=n(s,t.mapAORepeat,t.mapAOOffset,t.mapAOWrap,t.mapAOAnisotropy);break;case"mapAORepeat":case"mapAOOffset":case"mapAOWrap":case"mapAOAnisotropy":break;case"mapBump":o.bumpMap=n(s,t.mapBumpRepeat,t.mapBumpOffset,t.mapBumpWrap,t.mapBumpAnisotropy);break;case"mapBumpScale":o.bumpScale=s;break;case"mapBumpRepeat":case"mapBumpOffset":case"mapBumpWrap":case"mapBumpAnisotropy":break;case"mapNormal":o.normalMap=n(s,t.mapNormalRepeat,t.mapNormalOffset,t.mapNormalWrap,t.mapNormalAnisotropy);break;case"mapNormalFactor":o.normalScale=s;break;case"mapNormalRepeat":case"mapNormalOffset":case"mapNormalWrap":case"mapNormalAnisotropy":break;case"mapSpecular":o.specularMap=n(s,t.mapSpecularRepeat,t.mapSpecularOffset,t.mapSpecularWrap,t.mapSpecularAnisotropy);break;case"mapSpecularRepeat":case"mapSpecularOffset":case"mapSpecularWrap":case"mapSpecularAnisotropy":break;case"mapMetalness":o.metalnessMap=n(s,t.mapMetalnessRepeat,t.mapMetalnessOffset,t.mapMetalnessWrap,t.mapMetalnessAnisotropy);break;case"mapMetalnessRepeat":case"mapMetalnessOffset":case"mapMetalnessWrap":case"mapMetalnessAnisotropy":break;case"mapRoughness":o.roughnessMap=n(s,t.mapRoughnessRepeat,t.mapRoughnessOffset,t.mapRoughnessWrap,t.mapRoughnessAnisotropy);break;case"mapRoughnessRepeat":case"mapRoughnessOffset":case"mapRoughnessWrap":case"mapRoughnessAnisotropy":break;case"mapAlpha":o.alphaMap=n(s,t.mapAlphaRepeat,t.mapAlphaOffset,t.mapAlphaWrap,t.mapAlphaAnisotropy);break;case"mapAlphaRepeat":case"mapAlphaOffset":case"mapAlphaWrap":case"mapAlphaAnisotropy":break;case"flipSided":o.side=E;break;case"doubleSided":o.side=x;break;case"transparency":o.opacity=s;break;case"depthTest":case"depthWrite":case"colorWrite":case"opacity":case"reflectivity":case"transparent":case"visible":case"wireframe":o[a]=s;break;case"vertexColors":!0===s&&(o.vertexColors=b),"face"===s&&(o.vertexColors=w)}}return"MeshBasicMaterial"===o.type&&delete o.emissive,"MeshPhongMaterial"!==o.type&&delete o.specular,o.opacity<1&&(o.transparent=!0),_s.setTextures(r),_s.parse(o)})});var Ss={decodeText:function(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);for(var e="",i=0,r=t.length;i<r;i++)e+=String.fromCharCode(t[i]);return decodeURIComponent(escape(e))},extractUrlBase:function(t){var e=t.lastIndexOf("/");return-1===e?"./":t.substr(0,e+1)}};function Ts(t){"boolean"==typeof t&&(t=void 0),this.manager=void 0!==t?t:ma,this.withCredentials=!1}function Ms(t){this.manager=void 0!==t?t:ma,this.texturePath=""}Object.assign(Ts.prototype,{crossOrigin:"anonymous",load:function(t,e,i,r){var n=this,o=this.texturePath&&"string"==typeof this.texturePath?this.texturePath:Ss.extractUrlBase(t),a=new va(this.manager);a.setWithCredentials(this.withCredentials),a.load(t,function(t){var i=JSON.parse(t),r=i.metadata;if(void 0!==r){var a=r.type;if(void 0!==a&&"object"===a.toLowerCase())return}var s=n.parse(i,o);e(s.geometry,s.materials)},i,r)},setCrossOrigin:function(t){return this.crossOrigin=t,this},setTexturePath:function(t){return this.texturePath=t,this},parse:function(){return function(t,e){void 0!==t.data&&(t=t.data),void 0!==t.scale?t.scale=1/t.scale:t.scale=1;var i=new xi;return function(t,e){function i(t,e){return t&1<<e}var r,n,o,a,s,h,l,c,u,p,d,f,m,g,v,y,E,x,_,w,b,S,T,M,R,A=t.faces,C=t.vertices,P=t.normals,D=t.colors,L=t.scale,O=0;if(void 0!==t.uvs){for(r=0;r<t.uvs.length;r++)t.uvs[r].length&&O++;for(r=0;r<O;r++)e.faceVertexUvs[r]=[]}for(a=0,s=C.length;a<s;)(x=new Oe).x=C[a++]*L,x.y=C[a++]*L,x.z=C[a++]*L,e.vertices.push(x);for(a=0,s=A.length;a<s;)if(d=i(p=A[a++],0),f=i(p,1),m=i(p,3),g=i(p,4),v=i(p,5),y=i(p,6),E=i(p,7),d){if((w=new gi).a=A[a],w.b=A[a+1],w.c=A[a+3],(b=new gi).a=A[a+1],b.b=A[a+2],b.c=A[a+3],a+=4,f&&(u=A[a++],w.materialIndex=u,b.materialIndex=u),o=e.faces.length,m)for(r=0;r<O;r++)for(M=t.uvs[r],e.faceVertexUvs[r][o]=[],e.faceVertexUvs[r][o+1]=[],n=0;n<4;n++)R=new Pe(M[2*(c=A[a++])],M[2*c+1]),2!==n&&e.faceVertexUvs[r][o].push(R),0!==n&&e.faceVertexUvs[r][o+1].push(R);if(g&&(l=3*A[a++],w.normal.set(P[l++],P[l++],P[l]),b.normal.copy(w.normal)),v)for(r=0;r<4;r++)l=3*A[a++],T=new Oe(P[l++],P[l++],P[l]),2!==r&&w.vertexNormals.push(T),0!==r&&b.vertexNormals.push(T);if(y&&(S=D[h=A[a++]],w.color.setHex(S),b.color.setHex(S)),E)for(r=0;r<4;r++)S=D[h=A[a++]],2!==r&&w.vertexColors.push(new ti(S)),0!==r&&b.vertexColors.push(new ti(S));e.faces.push(w),e.faces.push(b)}else{if((_=new gi).a=A[a++],_.b=A[a++],_.c=A[a++],f&&(u=A[a++],_.materialIndex=u),o=e.faces.length,m)for(r=0;r<O;r++)for(M=t.uvs[r],e.faceVertexUvs[r][o]=[],n=0;n<3;n++)R=new Pe(M[2*(c=A[a++])],M[2*c+1]),e.faceVertexUvs[r][o].push(R);if(g&&(l=3*A[a++],_.normal.set(P[l++],P[l++],P[l])),v)for(r=0;r<3;r++)l=3*A[a++],T=new Oe(P[l++],P[l++],P[l]),_.vertexNormals.push(T);if(y&&(h=A[a++],_.color.setHex(D[h])),E)for(r=0;r<3;r++)h=A[a++],_.vertexColors.push(new ti(D[h]));e.faces.push(_)}}(t,i),function(t,e){var i=void 0!==t.influencesPerVertex?t.influencesPerVertex:2;if(t.skinWeights)for(var r=0,n=t.skinWeights.length;r<n;r+=i){var o=t.skinWeights[r],a=i>1?t.skinWeights[r+1]:0,s=i>2?t.skinWeights[r+2]:0,h=i>3?t.skinWeights[r+3]:0;e.skinWeights.push(new Fe(o,a,s,h))}if(t.skinIndices)for(r=0,n=t.skinIndices.length;r<n;r+=i){var l=t.skinIndices[r],c=i>1?t.skinIndices[r+1]:0,u=i>2?t.skinIndices[r+2]:0,p=i>3?t.skinIndices[r+3]:0;e.skinIndices.push(new Fe(l,c,u,p))}e.bones=t.bones,e.bones&&e.bones.length>0&&(e.skinWeights.length!==e.skinIndices.length||(e.skinIndices.length,e.vertices.length))}(t,i),function(t,e){var i=t.scale;if(void 0!==t.morphTargets)for(var r=0,n=t.morphTargets.length;r<n;r++){e.morphTargets[r]={},e.morphTargets[r].name=t.morphTargets[r].name,e.morphTargets[r].vertices=[];for(var o=e.morphTargets[r].vertices,a=t.morphTargets[r].vertices,s=0,h=a.length;s<h;s+=3){var l=new Oe;l.x=a[s]*i,l.y=a[s+1]*i,l.z=a[s+2]*i,o.push(l)}}if(void 0!==t.morphColors&&t.morphColors.length>0){var c=e.faces,u=t.morphColors[0].colors;for(r=0,n=c.length;r<n;r++)c[r].color.fromArray(u,3*r)}}(t,i),function(t,e){var i=[],r=[];void 0!==t.animation&&r.push(t.animation),void 0!==t.animations&&(t.animations.length?r=r.concat(t.animations):r.push(t.animations));for(var n=0;n<r.length;n++){var o=ms.parseAnimation(r[n],e.bones);o&&i.push(o)}if(e.morphTargets){var a=ms.CreateClipsFromMorphTargetSequences(e.morphTargets,10);i=i.concat(a)}i.length>0&&(e.animations=i)}(t,i),i.computeFaceNormals(),i.computeBoundingSphere(),void 0===t.materials||0===t.materials.length?{geometry:i}:{geometry:i,materials:bs.prototype.initMaterials(t.materials,e,this.crossOrigin)}}}()}),Object.assign(Ms.prototype,{crossOrigin:"anonymous",load:function(t,e,i,r){""===this.texturePath&&(this.texturePath=t.substring(0,t.lastIndexOf("/")+1));var n=this;new va(n.manager).load(t,function(t){var i=null;try{i=JSON.parse(t)}catch(t){return void(void 0!==r&&r(t))}var o=i.metadata;void 0!==o&&void 0!==o.type&&"geometry"!==o.type.toLowerCase()&&n.parse(i,e)},i,r)},setTexturePath:function(t){return this.texturePath=t,this},setCrossOrigin:function(t){return this.crossOrigin=t,this},parse:function(t,e){var i=this.parseShape(t.shapes),r=this.parseGeometries(t.geometries,i),n=this.parseImages(t.images,function(){void 0!==e&&e(s)}),o=this.parseTextures(t.textures,n),a=this.parseMaterials(t.materials,o),s=this.parseObject(t.object,r,a);return t.animations&&(s.animations=this.parseAnimations(t.animations)),void 0!==t.images&&0!==t.images.length||void 0!==e&&e(s),s},parseShape:function(t){var e={};if(void 0!==t)for(var i=0,r=t.length;i<r;i++){var n=(new Wa).fromJSON(t[i]);e[n.uuid]=n}return e},parseGeometries:function(t,e){var i={};if(void 0!==t)for(var r=new Ts,n=new vs,o=0,a=t.length;o<a;o++){var s,h=t[o];switch(h.type){case"PlaneGeometry":case"PlaneBufferGeometry":s=new ia[h.type](h.width,h.height,h.widthSegments,h.heightSegments);break;case"BoxGeometry":case"BoxBufferGeometry":case"CubeGeometry":s=new ia[h.type](h.width,h.height,h.depth,h.widthSegments,h.heightSegments,h.depthSegments);break;case"CircleGeometry":case"CircleBufferGeometry":s=new ia[h.type](h.radius,h.segments,h.thetaStart,h.thetaLength);break;case"CylinderGeometry":case"CylinderBufferGeometry":s=new ia[h.type](h.radiusTop,h.radiusBottom,h.height,h.radialSegments,h.heightSegments,h.openEnded,h.thetaStart,h.thetaLength);break;case"ConeGeometry":case"ConeBufferGeometry":s=new ia[h.type](h.radius,h.height,h.radialSegments,h.heightSegments,h.openEnded,h.thetaStart,h.thetaLength);break;case"SphereGeometry":case"SphereBufferGeometry":s=new ia[h.type](h.radius,h.widthSegments,h.heightSegments,h.phiStart,h.phiLength,h.thetaStart,h.thetaLength);break;case"DodecahedronGeometry":case"DodecahedronBufferGeometry":case"IcosahedronGeometry":case"IcosahedronBufferGeometry":case"OctahedronGeometry":case"OctahedronBufferGeometry":case"TetrahedronGeometry":case"TetrahedronBufferGeometry":s=new ia[h.type](h.radius,h.detail);break;case"RingGeometry":case"RingBufferGeometry":s=new ia[h.type](h.innerRadius,h.outerRadius,h.thetaSegments,h.phiSegments,h.thetaStart,h.thetaLength);break;case"TorusGeometry":case"TorusBufferGeometry":s=new ia[h.type](h.radius,h.tube,h.radialSegments,h.tubularSegments,h.arc);break;case"TorusKnotGeometry":case"TorusKnotBufferGeometry":s=new ia[h.type](h.radius,h.tube,h.tubularSegments,h.radialSegments,h.p,h.q);break;case"LatheGeometry":case"LatheBufferGeometry":s=new ia[h.type](h.points,h.segments,h.phiStart,h.phiLength);break;case"PolyhedronGeometry":case"PolyhedronBufferGeometry":s=new ia[h.type](h.vertices,h.indices,h.radius,h.details);break;case"ShapeGeometry":case"ShapeBufferGeometry":for(var l=[],c=0,u=h.shapes.length;c<u;c++){var p=e[h.shapes[c]];l.push(p)}s=new ia[h.type](l,h.curveSegments);break;case"ExtrudeGeometry":case"ExtrudeBufferGeometry":for(l=[],c=0,u=h.shapes.length;c<u;c++){p=e[h.shapes[c]];l.push(p)}var d=h.options.extrudePath;void 0!==d&&(h.options.extrudePath=(new Fa[d.type]).fromJSON(d)),s=new ia[h.type](l,h.options);break;case"BufferGeometry":s=n.parse(h);break;case"Geometry":s=r.parse(h,this.texturePath).geometry;break;default:continue}s.uuid=h.uuid,void 0!==h.name&&(s.name=h.name),!0===s.isBufferGeometry&&void 0!==h.userData&&(s.userData=h.userData),i[h.uuid]=s}return i},parseMaterials:function(t,e){var i={};if(void 0!==t){var r=new gs;r.setTextures(e);for(var n=0,o=t.length;n<o;n++){var a=t[n];if("MultiMaterial"===a.type){for(var s=[],h=0;h<a.materials.length;h++)s.push(r.parse(a.materials[h]));i[a.uuid]=s}else i[a.uuid]=r.parse(a)}}return i},parseAnimations:function(t){for(var e=[],i=0;i<t.length;i++){var r=t[i],n=ms.parse(r);void 0!==r.uuid&&(n.uuid=r.uuid),e.push(n)}return e},parseImages:function(t,e){var i=this,r={};function n(t){return i.manager.itemStart(t),o.load(t,function(){i.manager.itemEnd(t)},void 0,function(){i.manager.itemEnd(t),i.manager.itemError(t)})}if(void 0!==t&&t.length>0){var o=new xa(new fa(e));o.setCrossOrigin(this.crossOrigin);for(var a=0,s=t.length;a<s;a++){var h=t[a],l=h.url;if(Array.isArray(l)){r[h.uuid]=[];for(var c=0,u=l.length;c<u;c++){var p=l[c],d=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(p)?p:i.texturePath+p;r[h.uuid].push(n(d))}}else{d=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(h.url)?h.url:i.texturePath+h.url;r[h.uuid]=n(d)}}}return r},parseTextures:function(t,e){function i(t,e){return"number"==typeof t?t:e[t]}var r={};if(void 0!==t)for(var n=0,o=t.length;n<o;n++){var a,s=t[n];s.image,e[s.image],(a=Array.isArray(e[s.image])?new er(e[s.image]):new Ve(e[s.image])).needsUpdate=!0,a.uuid=s.uuid,void 0!==s.name&&(a.name=s.name),void 0!==s.mapping&&(a.mapping=i(s.mapping,As)),void 0!==s.offset&&a.offset.fromArray(s.offset),void 0!==s.repeat&&a.repeat.fromArray(s.repeat),void 0!==s.center&&a.center.fromArray(s.center),void 0!==s.rotation&&(a.rotation=s.rotation),void 0!==s.wrap&&(a.wrapS=i(s.wrap[0],Cs),a.wrapT=i(s.wrap[1],Cs)),void 0!==s.format&&(a.format=s.format),void 0!==s.minFilter&&(a.minFilter=i(s.minFilter,Ps)),void 0!==s.magFilter&&(a.magFilter=i(s.magFilter,Ps)),void 0!==s.anisotropy&&(a.anisotropy=s.anisotropy),void 0!==s.flipY&&(a.flipY=s.flipY),r[s.uuid]=a}return r},parseObject:function(t,e,i){var r;function n(t){return e[t],e[t]}function o(t){if(void 0!==t){if(Array.isArray(t)){for(var e=[],r=0,n=t.length;r<n;r++){var o=t[r];i[o],e.push(i[o])}return e}return i[t],i[t]}}switch(t.type){case"Scene":r=new Rn,void 0!==t.background&&Number.isInteger(t.background)&&(r.background=new ti(t.background)),void 0!==t.fog&&("Fog"===t.fog.type?r.fog=new Mn(t.fog.color,t.fog.near,t.fog.far):"FogExp2"===t.fog.type&&(r.fog=new Tn(t.fog.color,t.fog.density)));break;case"PerspectiveCamera":r=new _n(t.fov,t.aspect,t.near,t.far),void 0!==t.focus&&(r.focus=t.focus),void 0!==t.zoom&&(r.zoom=t.zoom),void 0!==t.filmGauge&&(r.filmGauge=t.filmGauge),void 0!==t.filmOffset&&(r.filmOffset=t.filmOffset),void 0!==t.view&&(r.view=Object.assign({},t.view));break;case"OrthographicCamera":r=new mi(t.left,t.right,t.top,t.bottom,t.near,t.far),void 0!==t.zoom&&(r.zoom=t.zoom),void 0!==t.view&&(r.view=Object.assign({},t.view));break;case"AmbientLight":r=new ts(t.color,t.intensity);break;case"DirectionalLight":r=new $a(t.color,t.intensity);break;case"PointLight":r=new Qa(t.color,t.intensity,t.distance,t.decay);break;case"RectAreaLight":r=new es(t.color,t.intensity,t.width,t.height);break;case"SpotLight":r=new Ja(t.color,t.intensity,t.distance,t.angle,t.penumbra,t.decay);break;case"HemisphereLight":r=new Za(t.color,t.groundColor,t.intensity);break;case"SkinnedMesh":case"Mesh":var a=n(t.geometry),s=o(t.material);r=a.bones&&a.bones.length>0?new On(a,s):new $i(a,s);break;case"LOD":r=new Pn;break;case"Line":r=new In(n(t.geometry),o(t.material),t.mode);break;case"LineLoop":r=new zn(n(t.geometry),o(t.material));break;case"LineSegments":r=new Bn(n(t.geometry),o(t.material));break;case"PointCloud":case"Points":r=new kn(n(t.geometry),o(t.material));break;case"Sprite":r=new Cn(o(t.material));break;case"Group":r=new xn;break;default:r=new di}if(r.uuid=t.uuid,void 0!==t.name&&(r.name=t.name),void 0!==t.matrix?(r.matrix.fromArray(t.matrix),void 0!==t.matrixAutoUpdate&&(r.matrixAutoUpdate=t.matrixAutoUpdate),r.matrixAutoUpdate&&r.matrix.decompose(r.position,r.quaternion,r.scale)):(void 0!==t.position&&r.position.fromArray(t.position),void 0!==t.rotation&&r.rotation.fromArray(t.rotation),void 0!==t.quaternion&&r.quaternion.fromArray(t.quaternion),void 0!==t.scale&&r.scale.fromArray(t.scale)),void 0!==t.castShadow&&(r.castShadow=t.castShadow),void 0!==t.receiveShadow&&(r.receiveShadow=t.receiveShadow),t.shadow&&(void 0!==t.shadow.bias&&(r.shadow.bias=t.shadow.bias),void 0!==t.shadow.radius&&(r.shadow.radius=t.shadow.radius),void 0!==t.shadow.mapSize&&r.shadow.mapSize.fromArray(t.shadow.mapSize),void 0!==t.shadow.camera&&(r.shadow.camera=this.parseObject(t.shadow.camera))),void 0!==t.visible&&(r.visible=t.visible),void 0!==t.frustumCulled&&(r.frustumCulled=t.frustumCulled),void 0!==t.renderOrder&&(r.renderOrder=t.renderOrder),void 0!==t.userData&&(r.userData=t.userData),void 0!==t.layers&&(r.layers.mask=t.layers),void 0!==t.children)for(var h=t.children,l=0;l<h.length;l++)r.add(this.parseObject(h[l],e,i));if("LOD"===t.type)for(var c=t.levels,u=0;u<c.length;u++){var p=c[u],d=r.getObjectByProperty("uuid",p.object);void 0!==d&&r.addLevel(d,p.distance)}return r}});var Rs,As={UVMapping:300,CubeReflectionMapping:ht,CubeRefractionMapping:lt,EquirectangularReflectionMapping:ct,EquirectangularRefractionMapping:ut,SphericalReflectionMapping:pt,CubeUVReflectionMapping:dt,CubeUVRefractionMapping:ft},Cs={RepeatWrapping:mt,ClampToEdgeWrapping:gt,MirroredRepeatWrapping:vt},Ps={NearestFilter:yt,NearestMipMapNearestFilter:Et,NearestMipMapLinearFilter:xt,LinearFilter:_t,LinearMipMapNearestFilter:wt,LinearMipMapLinearFilter:bt};function Ds(t){this.manager=void 0!==t?t:ma,this.options=void 0}function Ls(){this.type="ShapePath",this.color=new ti,this.subPaths=[],this.currentPath=null}function Os(t){this.type="Font",this.data=t}function Hs(t,e,i,r,n){var o=n.glyphs[t]||n.glyphs["?"];if(o){var a,s,h,l,c,u,p,d,f=new Ls;if(o.o)for(var m=o._cachedOutline||(o._cachedOutline=o.o.split(" ")),g=0,v=m.length;g<v;){switch(m[g++]){case"m":a=m[g++]*e+i,s=m[g++]*e+r,f.moveTo(a,s);break;case"l":a=m[g++]*e+i,s=m[g++]*e+r,f.lineTo(a,s);break;case"q":h=m[g++]*e+i,l=m[g++]*e+r,c=m[g++]*e+i,u=m[g++]*e+r,f.quadraticCurveTo(c,u,h,l);break;case"b":h=m[g++]*e+i,l=m[g++]*e+r,c=m[g++]*e+i,u=m[g++]*e+r,p=m[g++]*e+i,d=m[g++]*e+r,f.bezierCurveTo(c,u,p,d,h,l)}}return{offsetX:o.ha*e,path:f}}}function Is(t){this.manager=void 0!==t?t:ma}Ds.prototype={constructor:Ds,setOptions:function(t){return this.options=t,this},load:function(t,e,i,r){void 0===t&&(t=""),void 0!==this.path&&(t=this.path+t),t=this.manager.resolveURL(t);var n=this,o=da.get(t);if(void 0!==o)return n.manager.itemStart(t),setTimeout(function(){e&&e(o),n.manager.itemEnd(t)},0),o;fetch(t).then(function(t){return t.blob()}).then(function(t){return createImageBitmap(t,n.options)}).then(function(i){da.add(t,i),e&&e(i),n.manager.itemEnd(t)}).catch(function(e){r&&r(e),n.manager.itemEnd(t),n.manager.itemError(t)})},setCrossOrigin:function(){return this},setPath:function(t){return this.path=t,this}},Object.assign(Ls.prototype,{moveTo:function(t,e){this.currentPath=new Ga,this.subPaths.push(this.currentPath),this.currentPath.moveTo(t,e)},lineTo:function(t,e){this.currentPath.lineTo(t,e)},quadraticCurveTo:function(t,e,i,r){this.currentPath.quadraticCurveTo(t,e,i,r)},bezierCurveTo:function(t,e,i,r,n,o){this.currentPath.bezierCurveTo(t,e,i,r,n,o)},splineThru:function(t){this.currentPath.splineThru(t)},toShapes:function(t,e){function i(t){for(var e=[],i=0,r=t.length;i<r;i++){var n=t[i],o=new Wa;o.curves=n.curves,e.push(o)}return e}function r(t,e){for(var i=e.length,r=!1,n=i-1,o=0;o<i;n=o++){var a=e[n],s=e[o],h=s.x-a.x,l=s.y-a.y;if(Math.abs(l)>Number.EPSILON){if(l<0&&(a=e[o],h=-h,s=e[n],l=-l),t.y<a.y||t.y>s.y)continue;if(t.y===a.y){if(t.x===a.x)return!0}else{var c=l*(t.x-a.x)-h*(t.y-a.y);if(0===c)return!0;if(c<0)continue;r=!r}}else{if(t.y!==a.y)continue;if(s.x<=t.x&&t.x<=a.x||a.x<=t.x&&t.x<=s.x)return!0}}return r}var n=Do.isClockWise,o=this.subPaths;if(0===o.length)return[];if(!0===e)return i(o);var a,s,h,l=[];if(1===o.length)return s=o[0],(h=new Wa).curves=s.curves,l.push(h),l;var c=!n(o[0].getPoints());c=t?!c:c;var u,p,d=[],f=[],m=[],g=0;f[g]=void 0,m[g]=[];for(var v=0,y=o.length;v<y;v++)a=n(u=(s=o[v]).getPoints()),(a=t?!a:a)?(!c&&f[g]&&g++,f[g]={s:new Wa,p:u},f[g].s.curves=s.curves,c&&g++,m[g]=[]):m[g].push({h:s,p:u[0]});if(!f[0])return i(o);if(f.length>1){for(var E=!1,x=[],_=0,w=f.length;_<w;_++)d[_]=[];for(_=0,w=f.length;_<w;_++)for(var b=m[_],S=0;S<b.length;S++){for(var T=b[S],M=!0,R=0;R<f.length;R++)r(T.p,f[R].p)&&(_!==R&&x.push({froms:_,tos:R,hole:S}),M?(M=!1,d[R].push(T)):E=!0);M&&d[_].push(T)}x.length>0&&(E||(m=d))}v=0;for(var A=f.length;v<A;v++){h=f[v].s,l.push(h);for(var C=0,P=(p=m[v]).length;C<P;C++)h.holes.push(p[C].h)}return l}}),Object.assign(Os.prototype,{isFont:!0,generateShapes:function(t,e){void 0===e&&(e=100);for(var i=[],r=function(t,e,i){for(var r=Array.from?Array.from(t):String(t).split(""),n=e/i.resolution,o=(i.boundingBox.yMax-i.boundingBox.yMin+i.underlineThickness)*n,a=[],s=0,h=0,l=0;l<r.length;l++){var c=r[l];if("\n"===c)s=0,h-=o;else{var u=Hs(c,n,s,h,i);s+=u.offsetX,a.push(u.path)}}return a}(t,e,this.data),n=0,o=r.length;n<o;n++)Array.prototype.push.apply(i,r[n].toShapes());return i}}),Object.assign(Is.prototype,{load:function(t,e,i,r){var n=this,o=new va(this.manager);o.setPath(this.path),o.load(t,function(t){var i;try{i=JSON.parse(t)}catch(e){i=JSON.parse(t.substring(65,t.length-2))}var r=n.parse(i);e&&e(r)},i,r)},parse:function(t){return new Os(t)},setPath:function(t){return this.path=t,this}});var Bs,zs,Ns,ks,js,Vs,Fs,Us,Gs,Ws,Xs={getContext:function(){return void 0===Rs&&(Rs=new(window.AudioContext||window.webkitAudioContext)),Rs},setContext:function(t){Rs=t}};function Zs(t){this.manager=void 0!==t?t:ma}function Ys(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new _n,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new _n,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1}function qs(t,e,i){di.call(this),this.type="CubeCamera";var r=new _n(90,1,t,e);r.up.set(0,-1,0),r.lookAt(new Oe(1,0,0)),this.add(r);var n=new _n(90,1,t,e);n.up.set(0,-1,0),n.lookAt(new Oe(-1,0,0)),this.add(n);var o=new _n(90,1,t,e);o.up.set(0,0,1),o.lookAt(new Oe(0,1,0)),this.add(o);var a=new _n(90,1,t,e);a.up.set(0,0,-1),a.lookAt(new Oe(0,-1,0)),this.add(a);var s=new _n(90,1,t,e);s.up.set(0,-1,0),s.lookAt(new Oe(0,0,1)),this.add(s);var h=new _n(90,1,t,e);h.up.set(0,-1,0),h.lookAt(new Oe(0,0,-1)),this.add(h);var l={format:zt,magFilter:_t,minFilter:_t};this.renderTarget=new Ge(i,i,l),this.renderTarget.texture.name="CubeCamera",this.update=function(t,e){null===this.parent&&this.updateMatrixWorld();var i=this.renderTarget,l=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,i.activeCubeFace=0,t.render(e,r,i),i.activeCubeFace=1,t.render(e,n,i),i.activeCubeFace=2,t.render(e,o,i),i.activeCubeFace=3,t.render(e,a,i),i.activeCubeFace=4,t.render(e,s,i),i.texture.generateMipmaps=l,i.activeCubeFace=5,t.render(e,h,i),t.setRenderTarget(null)},this.clear=function(t,e,i,r){for(var n=this.renderTarget,o=0;o<6;o++)n.activeCubeFace=o,t.setRenderTarget(n),t.clear(e,i,r);t.setRenderTarget(null)}}function Js(){di.call(this),this.type="AudioListener",this.context=Xs.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null}function Qs(t){di.call(this),this.type="Audio",this.context=t.context,this.gain=this.context.createGain(),this.gain.connect(t.getInput()),this.autoplay=!1,this.buffer=null,this.loop=!1,this.startTime=0,this.offset=0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.sourceType="empty",this.filters=[]}function Ks(t){Qs.call(this,t),this.panner=this.context.createPanner(),this.panner.connect(this.gain)}function $s(t,e){this.analyser=t.context.createAnalyser(),this.analyser.fftSize=void 0!==e?e:2048,this.data=new Uint8Array(this.analyser.frequencyBinCount),t.getOutput().connect(this.analyser)}function th(t,e,i){this.binding=t,this.valueSize=i;var r,n=Float64Array;switch(e){case"quaternion":r=this._slerp;break;case"string":case"bool":n=Array,r=this._select;break;default:r=this._lerp}this.buffer=new n(4*i),this._mixBufferRegion=r,this.cumulativeWeight=0,this.useCount=0,this.referenceCount=0}Object.assign(Zs.prototype,{load:function(t,e,i,r){var n=new va(this.manager);n.setResponseType("arraybuffer"),n.load(t,function(t){var i=t.slice(0);Xs.getContext().decodeAudioData(i,function(t){e(t)})},i,r)}}),Object.assign(Ys.prototype,{update:(Gs=new De,Ws=new De,function(t){if(Bs!==this||zs!==t.focus||Ns!==t.fov||ks!==t.aspect*this.aspect||js!==t.near||Vs!==t.far||Fs!==t.zoom||Us!==this.eyeSep){Bs=this,zs=t.focus,Ns=t.fov,ks=t.aspect*this.aspect,js=t.near,Vs=t.far,Fs=t.zoom;var e,i,r=t.projectionMatrix.clone(),n=(Us=this.eyeSep/2)*js/zs,o=js*Math.tan(Ce.DEG2RAD*Ns*.5)/Fs;Ws.elements[12]=-Us,Gs.elements[12]=Us,e=-o*ks+n,i=o*ks+n,r.elements[0]=2*js/(i-e),r.elements[8]=(i+e)/(i-e),this.cameraL.projectionMatrix.copy(r),e=-o*ks-n,i=o*ks-n,r.elements[0]=2*js/(i-e),r.elements[8]=(i+e)/(i-e),this.cameraR.projectionMatrix.copy(r)}this.cameraL.matrixWorld.copy(t.matrixWorld).multiply(Ws),this.cameraR.matrixWorld.copy(t.matrixWorld).multiply(Gs)})}),qs.prototype=Object.create(di.prototype),qs.prototype.constructor=qs,Js.prototype=Object.assign(Object.create(di.prototype),{constructor:Js,getInput:function(){return this.gain},removeFilter:function(){return null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null),this},getFilter:function(){return this.filter},setFilter:function(t){return null!==this.filter?(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=t,this.gain.connect(this.filter),this.filter.connect(this.context.destination),this},getMasterVolume:function(){return this.gain.gain.value},setMasterVolume:function(t){return this.gain.gain.setTargetAtTime(t,this.context.currentTime,.01),this},updateMatrixWorld:function(){var t=new Oe,e=new Le,i=new Oe,r=new Oe;return function(n){di.prototype.updateMatrixWorld.call(this,n);var o=this.context.listener,a=this.up;this.matrixWorld.decompose(t,e,i),r.set(0,0,-1).applyQuaternion(e),o.positionX?(o.positionX.setValueAtTime(t.x,this.context.currentTime),o.positionY.setValueAtTime(t.y,this.context.currentTime),o.positionZ.setValueAtTime(t.z,this.context.currentTime),o.forwardX.setValueAtTime(r.x,this.context.currentTime),o.forwardY.setValueAtTime(r.y,this.context.currentTime),o.forwardZ.setValueAtTime(r.z,this.context.currentTime),o.upX.setValueAtTime(a.x,this.context.currentTime),o.upY.setValueAtTime(a.y,this.context.currentTime),o.upZ.setValueAtTime(a.z,this.context.currentTime)):(o.setPosition(t.x,t.y,t.z),o.setOrientation(r.x,r.y,r.z,a.x,a.y,a.z))}}()}),Qs.prototype=Object.assign(Object.create(di.prototype),{constructor:Qs,getOutput:function(){return this.gain},setNodeSource:function(t){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=t,this.connect(),this},setMediaElementSource:function(t){return this.hasPlaybackControl=!1,this.sourceType="mediaNode",this.source=this.context.createMediaElementSource(t),this.connect(),this},setBuffer:function(t){return this.buffer=t,this.sourceType="buffer",this.autoplay&&this.play(),this},play:function(){if(!0!==this.isPlaying&&!1!==this.hasPlaybackControl){var t=this.context.createBufferSource();return t.buffer=this.buffer,t.loop=this.loop,t.onended=this.onEnded.bind(this),t.playbackRate.setValueAtTime(this.playbackRate,this.startTime),this.startTime=this.context.currentTime,t.start(this.startTime,this.offset),this.isPlaying=!0,this.source=t,this.connect()}},pause:function(){if(!1!==this.hasPlaybackControl)return!0===this.isPlaying&&(this.source.stop(),this.offset+=(this.context.currentTime-this.startTime)*this.playbackRate,this.isPlaying=!1),this},stop:function(){if(!1!==this.hasPlaybackControl)return this.source.stop(),this.offset=0,this.isPlaying=!1,this},connect:function(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(var t=1,e=this.filters.length;t<e;t++)this.filters[t-1].connect(this.filters[t]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this},disconnect:function(){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(var t=1,e=this.filters.length;t<e;t++)this.filters[t-1].disconnect(this.filters[t]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this},getFilters:function(){return this.filters},setFilters:function(t){return t||(t=[]),!0===this.isPlaying?(this.disconnect(),this.filters=t,this.connect()):this.filters=t,this},getFilter:function(){return this.getFilters()[0]},setFilter:function(t){return this.setFilters(t?[t]:[])},setPlaybackRate:function(t){if(!1!==this.hasPlaybackControl)return this.playbackRate=t,!0===this.isPlaying&&this.source.playbackRate.setValueAtTime(this.playbackRate,this.context.currentTime),this},getPlaybackRate:function(){return this.playbackRate},onEnded:function(){this.isPlaying=!1},getLoop:function(){return!1!==this.hasPlaybackControl&&this.loop},setLoop:function(t){if(!1!==this.hasPlaybackControl)return this.loop=t,!0===this.isPlaying&&(this.source.loop=this.loop),this},getVolume:function(){return this.gain.gain.value},setVolume:function(t){return this.gain.gain.setTargetAtTime(t,this.context.currentTime,.01),this}}),Ks.prototype=Object.assign(Object.create(Qs.prototype),{constructor:Ks,getOutput:function(){return this.panner},getRefDistance:function(){return this.panner.refDistance},setRefDistance:function(t){return this.panner.refDistance=t,this},getRolloffFactor:function(){return this.panner.rolloffFactor},setRolloffFactor:function(t){return this.panner.rolloffFactor=t,this},getDistanceModel:function(){return this.panner.distanceModel},setDistanceModel:function(t){return this.panner.distanceModel=t,this},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(t){return this.panner.maxDistance=t,this},setDirectionalCone:function(t,e,i){return this.panner.coneInnerAngle=t,this.panner.coneOuterAngle=e,this.panner.coneOuterGain=i,this},updateMatrixWorld:function(){var t=new Oe,e=new Le,i=new Oe,r=new Oe;return function(n){di.prototype.updateMatrixWorld.call(this,n);var o=this.panner;this.matrixWorld.decompose(t,e,i),r.set(0,0,1).applyQuaternion(e),o.setPosition(t.x,t.y,t.z),o.setOrientation(r.x,r.y,r.z)}}()}),Object.assign($s.prototype,{getFrequencyData:function(){return this.analyser.getByteFrequencyData(this.data),this.data},getAverageFrequency:function(){for(var t=0,e=this.getFrequencyData(),i=0;i<e.length;i++)t+=e[i];return t/e.length}}),Object.assign(th.prototype,{accumulate:function(t,e){var i=this.buffer,r=this.valueSize,n=t*r+r,o=this.cumulativeWeight;if(0===o){for(var a=0;a!==r;++a)i[n+a]=i[a];o=e}else{var s=e/(o+=e);this._mixBufferRegion(i,n,0,s,r)}this.cumulativeWeight=o},apply:function(t){var e=this.valueSize,i=this.buffer,r=t*e+e,n=this.cumulativeWeight,o=this.binding;if(this.cumulativeWeight=0,n<1){var a=3*e;this._mixBufferRegion(i,r,a,1-n,e)}for(var s=e,h=e+e;s!==h;++s)if(i[s]!==i[s+e]){o.setValue(i,r);break}},saveOriginalState:function(){var t=this.binding,e=this.buffer,i=this.valueSize,r=3*i;t.getValue(e,r);for(var n=i,o=r;n!==o;++n)e[n]=e[r+n%i];this.cumulativeWeight=0},restoreOriginalState:function(){var t=3*this.valueSize;this.binding.setValue(this.buffer,t)},_select:function(t,e,i,r,n){if(r>=.5)for(var o=0;o!==n;++o)t[e+o]=t[i+o]},_slerp:function(t,e,i,r){Le.slerpFlat(t,e,t,e,t,i,r)},_lerp:function(t,e,i,r,n){for(var o=1-r,a=0;a!==n;++a){var s=e+a;t[s]=t[s]*o+t[i+a]*r}}});var eh,ih,rh,nh,oh,ah,sh,hh,lh,ch,uh,ph,dh;function fh(t,e,i){var r=i||mh.parseTrackName(e);this._targetGroup=t,this._bindings=t.subscribe_(e,r)}function mh(t,e,i){this.path=e,this.parsedPath=i||mh.parseTrackName(e),this.node=mh.findNode(t,this.parsedPath.nodeName)||t,this.rootNode=t}function gh(){this.uuid=Ce.generateUUID(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;var t={};this._indicesByUUID=t;for(var e=0,i=arguments.length;e!==i;++e)t[arguments[e].uuid]=e;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};var r=this;this.stats={objects:{get total(){return r._objects.length},get inUse(){return this.total-r.nCachedObjects_}},get bindingsPerObject(){return r._bindings.length}}}function vh(t,e,i){this._mixer=t,this._clip=e,this._localRoot=i||null;for(var r=e.tracks,n=r.length,o=new Array(n),a={endingStart:fe,endingEnd:fe},s=0;s!==n;++s){var h=r[s].createInterpolant(null);o[s]=h,h.settings=a}this._interpolantSettings=a,this._interpolants=o,this._propertyBindings=new Array(n),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=de,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}function yh(t){this._root=t,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}function Eh(t){"string"==typeof t&&(t=arguments[1]),this.value=t}function xh(){Hi.call(this),this.type="InstancedBufferGeometry",this.maxInstancedCount=void 0}function _h(t,e,i,r){this.data=t,this.itemSize=e,this.offset=i,this.normalized=!0===r}function wh(t,e){this.array=t,this.stride=e,this.count=void 0!==t?t.length/e:0,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.version=0}function bh(t,e,i){wh.call(this,t,e),this.meshPerAttribute=i||1}function Sh(t,e,i){_i.call(this,t,e),this.meshPerAttribute=i||1}function Th(t,e,i,r){this.ray=new Ji(t,e),this.near=i||0,this.far=r||1/0,this.params={Mesh:{},Line:{},LOD:{},Points:{threshold:1},Sprite:{}},Object.defineProperties(this.params,{PointCloud:{get:function(){return this.Points}}})}function Mh(t,e){return t.distance-e.distance}function Rh(t,e,i,r){if(!1!==t.visible&&(t.raycast(e,i),!0===r))for(var n=t.children,o=0,a=n.length;o<a;o++)Rh(n[o],e,i,!0)}function Ah(t){this.autoStart=void 0===t||t,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}function Ch(t,e,i){return this.radius=void 0!==t?t:1,this.phi=void 0!==e?e:0,this.theta=void 0!==i?i:0,this}function Ph(t,e,i){return this.radius=void 0!==t?t:1,this.theta=void 0!==e?e:0,this.y=void 0!==i?i:0,this}function Dh(t,e){this.min=void 0!==t?t:new Pe(1/0,1/0),this.max=void 0!==e?e:new Pe(-1/0,-1/0)}function Lh(t){di.call(this),this.material=t,this.render=function(){}}function Oh(t,e,i,r){this.object=t,this.size=void 0!==e?e:1;var n=void 0!==i?i:16711680,o=void 0!==r?r:1,a=0,s=this.object.geometry;s&&s.isGeometry?a=3*s.faces.length:s&&s.isBufferGeometry&&(a=s.attributes.normal.count);var h=new Hi,l=new Ci(2*a*3,3);h.addAttribute("position",l),Bn.call(this,h,new Hn({color:n,linewidth:o})),this.matrixAutoUpdate=!1,this.update()}function Hh(t,e){di.call(this),this.light=t,this.light.updateMatrixWorld(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=e;for(var i=new Hi,r=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1],n=0,o=1;n<32;n++,o++){var a=n/32*Math.PI*2,s=o/32*Math.PI*2;r.push(Math.cos(a),Math.sin(a),1,Math.cos(s),Math.sin(s),1)}i.addAttribute("position",new Ci(r,3));var h=new Hn({fog:!1});this.cone=new Bn(i,h),this.add(this.cone),this.update()}function Ih(t){for(var e=function t(e){var i=[];e&&e.isBone&&i.push(e);for(var r=0;r<e.children.length;r++)i.push.apply(i,t(e.children[r]));return i}(t),i=new Hi,r=[],n=[],o=new ti(0,0,1),a=new ti(0,1,0),s=0;s<e.length;s++){var h=e[s];h.parent&&h.parent.isBone&&(r.push(0,0,0),r.push(0,0,0),n.push(o.r,o.g,o.b),n.push(a.r,a.g,a.b))}i.addAttribute("position",new Ci(r,3)),i.addAttribute("color",new Ci(n,3));var l=new Hn({vertexColors:b,depthTest:!1,depthWrite:!1,transparent:!0});Bn.call(this,i,l),this.root=t,this.bones=e,this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1}function Bh(t,e,i){this.light=t,this.light.updateMatrixWorld(),this.color=i;var r=new Vo(e,4,2),n=new Yi({wireframe:!0,fog:!1});$i.call(this,r,n),this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1,this.update()}function zh(t,e){di.call(this),this.light=t,this.light.updateMatrixWorld(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=e;var i=new Hn({fog:!1}),r=new Hi;r.addAttribute("position",new _i(new Float32Array(15),3)),this.line=new In(r,i),this.add(this.line),this.update()}function Nh(t,e,i){di.call(this),this.light=t,this.light.updateMatrixWorld(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=i;var r=new Qn(e);r.rotateY(.5*Math.PI),this.material=new Yi({wireframe:!0,fog:!1}),void 0===this.color&&(this.material.vertexColors=b);var n=r.getAttribute("position"),o=new Float32Array(3*n.count);r.addAttribute("color",new _i(o,3)),this.add(new $i(r,this.material)),this.update()}function kh(t,e,i,r){t=t||10,e=e||10,i=new ti(void 0!==i?i:4473924),r=new ti(void 0!==r?r:8947848);for(var n=e/2,o=t/e,a=t/2,s=[],h=[],l=0,c=0,u=-a;l<=e;l++,u+=o){s.push(-a,0,u,a,0,u),s.push(u,0,-a,u,0,a);var p=l===n?i:r;p.toArray(h,c),c+=3,p.toArray(h,c),c+=3,p.toArray(h,c),c+=3,p.toArray(h,c),c+=3}var d=new Hi;d.addAttribute("position",new Ci(s,3)),d.addAttribute("color",new Ci(h,3));var f=new Hn({vertexColors:b});Bn.call(this,d,f)}function jh(t,e,i,r,n,o){t=t||10,e=e||16,i=i||8,r=r||64,n=new ti(void 0!==n?n:4473924),o=new ti(void 0!==o?o:8947848);var a,s,h,l,c,u,p,d=[],f=[];for(l=0;l<=e;l++)h=l/e*(2*Math.PI),a=Math.sin(h)*t,s=Math.cos(h)*t,d.push(0,0,0),d.push(a,0,s),p=1&l?n:o,f.push(p.r,p.g,p.b),f.push(p.r,p.g,p.b);for(l=0;l<=i;l++)for(p=1&l?n:o,u=t-t/i*l,c=0;c<r;c++)h=c/r*(2*Math.PI),a=Math.sin(h)*u,s=Math.cos(h)*u,d.push(a,0,s),f.push(p.r,p.g,p.b),h=(c+1)/r*(2*Math.PI),a=Math.sin(h)*u,s=Math.cos(h)*u,d.push(a,0,s),f.push(p.r,p.g,p.b);var m=new Hi;m.addAttribute("position",new Ci(d,3)),m.addAttribute("color",new Ci(f,3));var g=new Hn({vertexColors:b});Bn.call(this,m,g)}function Vh(t,e,i,r){this.object=t,this.size=void 0!==e?e:1;var n=void 0!==i?i:16776960,o=void 0!==r?r:1,a=0,s=this.object.geometry;s&&s.isGeometry&&(a=s.faces.length);var h=new Hi,l=new Ci(2*a*3,3);h.addAttribute("position",l),Bn.call(this,h,new Hn({color:n,linewidth:o})),this.matrixAutoUpdate=!1,this.update()}function Fh(t,e,i){di.call(this),this.light=t,this.light.updateMatrixWorld(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.color=i,void 0===e&&(e=1);var r=new Hi;r.addAttribute("position",new Ci([-e,e,0,e,e,0,e,-e,0,-e,-e,0,-e,e,0],3));var n=new Hn({fog:!1});this.lightPlane=new In(r,n),this.add(this.lightPlane),(r=new Hi).addAttribute("position",new Ci([0,0,0,0,0,1],3)),this.targetLine=new In(r,n),this.add(this.targetLine),this.update()}function Uh(t){var e=new Hi,i=new Hn({color:16777215,vertexColors:w}),r=[],n=[],o={},a=new ti(16755200),s=new ti(16711680),h=new ti(43775),l=new ti(16777215),c=new ti(3355443);function u(t,e,i){p(t,i),p(e,i)}function p(t,e){r.push(0,0,0),n.push(e.r,e.g,e.b),void 0===o[t]&&(o[t]=[]),o[t].push(r.length/3-1)}u("n1","n2",a),u("n2","n4",a),u("n4","n3",a),u("n3","n1",a),u("f1","f2",a),u("f2","f4",a),u("f4","f3",a),u("f3","f1",a),u("n1","f1",a),u("n2","f2",a),u("n3","f3",a),u("n4","f4",a),u("p","n1",s),u("p","n2",s),u("p","n3",s),u("p","n4",s),u("u1","u2",h),u("u2","u3",h),u("u3","u1",h),u("c","t",l),u("p","c",c),u("cn1","cn2",c),u("cn3","cn4",c),u("cf1","cf2",c),u("cf3","cf4",c),e.addAttribute("position",new Ci(r,3)),e.addAttribute("color",new Ci(n,3)),Bn.call(this,e,i),this.camera=t,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=o,this.update()}function Gh(t,e){this.object=t,void 0===e&&(e=16776960);var i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),r=new Float32Array(24),n=new Hi;n.setIndex(new _i(i,1)),n.addAttribute("position",new _i(r,3)),Bn.call(this,n,new Hn({color:e})),this.matrixAutoUpdate=!1,this.update()}function Wh(t,e){this.type="Box3Helper",this.box=t;var i=void 0!==e?e:16776960,r=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new Hi;n.setIndex(new _i(r,1)),n.addAttribute("position",new Ci([1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,-1,-1,1,-1,-1,-1,-1,1,-1,-1],3)),Bn.call(this,n,new Hn({color:i})),this.geometry.computeBoundingSphere()}function Xh(t,e,i){this.type="PlaneHelper",this.plane=t,this.size=void 0===e?1:e;var r=void 0!==i?i:16776960,n=new Hi;n.addAttribute("position",new Ci([1,-1,1,-1,1,1,-1,-1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,0,0,1,0,0,0],3)),n.computeBoundingSphere(),In.call(this,n,new Hn({color:r}));var o=new Hi;o.addAttribute("position",new Ci([1,1,1,-1,1,1,-1,-1,1,1,1,1,-1,-1,1,1,-1,1],3)),o.computeBoundingSphere(),this.add(new $i(o,new Yi({color:r,opacity:.2,transparent:!0,depthWrite:!1})))}function Zh(t,e,i,r,n,o){di.call(this),void 0===r&&(r=16776960),void 0===i&&(i=1),void 0===n&&(n=.2*i),void 0===o&&(o=.2*n),void 0===ch&&((ch=new Hi).addAttribute("position",new Ci([0,0,0,0,1,0],3)),(uh=new Qo(0,.5,1,5,1)).translate(0,-.5,0)),this.position.copy(e),this.line=new In(ch,new Hn({color:r})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new $i(uh,new Yi({color:r})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(t),this.setLength(i,n,o)}function Yh(t){var e=[0,0,0,t=t||1,0,0,0,0,0,0,t,0,0,0,0,0,0,t],i=new Hi;i.addAttribute("position",new Ci(e,3)),i.addAttribute("color",new Ci([1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],3));var r=new Hn({vertexColors:b});Bn.call(this,i,r)}Object.assign(fh.prototype,{getValue:function(t,e){this.bind();var i=this._targetGroup.nCachedObjects_,r=this._bindings[i];void 0!==r&&r.getValue(t,e)},setValue:function(t,e){for(var i=this._bindings,r=this._targetGroup.nCachedObjects_,n=i.length;r!==n;++r)i[r].setValue(t,e)},bind:function(){for(var t=this._bindings,e=this._targetGroup.nCachedObjects_,i=t.length;e!==i;++e)t[e].bind()},unbind:function(){for(var t=this._bindings,e=this._targetGroup.nCachedObjects_,i=t.length;e!==i;++e)t[e].unbind()}}),Object.assign(mh,{Composite:fh,create:function(t,e,i){return t&&t.isAnimationObjectGroup?new mh.Composite(t,e,i):new mh(t,e,i)},sanitizeNodeName:(lh=new RegExp("[\\[\\]\\.:\\/]","g"),function(t){return t.replace(/\s/g,"_").replace(lh,"")}),parseTrackName:(eh="[^\\[\\]\\.:\\/]",ih="[^"+"\\[\\]\\.:\\/".replace("\\.","")+"]",rh=/((?:WC+[\/:])*)/.source.replace("WC",eh),nh=/(WCOD+)?/.source.replace("WCOD",ih),oh=/(?:\.(WC+)(?:\[(.+)\])?)?/.source.replace("WC",eh),ah=/\.(WC+)(?:\[(.+)\])?/.source.replace("WC",eh),sh=new RegExp("^"+rh+nh+oh+ah+"$"),hh=["material","materials","bones"],function(t){var e=sh.exec(t);if(!e)throw new Error("PropertyBinding: Cannot parse trackName: "+t);var i={nodeName:e[2],objectName:e[3],objectIndex:e[4],propertyName:e[5],propertyIndex:e[6]},r=i.nodeName&&i.nodeName.lastIndexOf(".");if(void 0!==r&&-1!==r){var n=i.nodeName.substring(r+1);-1!==hh.indexOf(n)&&(i.nodeName=i.nodeName.substring(0,r),i.objectName=n)}if(null===i.propertyName||0===i.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+t);return i}),findNode:function(t,e){if(!e||""===e||"root"===e||"."===e||-1===e||e===t.name||e===t.uuid)return t;if(t.skeleton){var i=t.skeleton.getBoneByName(e);if(void 0!==i)return i}if(t.children){var r=function(t){for(var i=0;i<t.length;i++){var n=t[i];if(n.name===e||n.uuid===e)return n;var o=r(n.children);if(o)return o}return null},n=r(t.children);if(n)return n}return null}}),Object.assign(mh.prototype,{_getValue_unavailable:function(){},_setValue_unavailable:function(){},BindingType:{Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Versioning:{None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},GetterByBindingType:[function(t,e){t[e]=this.node[this.propertyName]},function(t,e){for(var i=this.resolvedProperty,r=0,n=i.length;r!==n;++r)t[e++]=i[r]},function(t,e){t[e]=this.resolvedProperty[this.propertyIndex]},function(t,e){this.resolvedProperty.toArray(t,e)}],SetterByBindingTypeAndVersioning:[[function(t,e){this.targetObject[this.propertyName]=t[e]},function(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.needsUpdate=!0},function(t,e){this.targetObject[this.propertyName]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(t,e){for(var i=this.resolvedProperty,r=0,n=i.length;r!==n;++r)i[r]=t[e++]},function(t,e){for(var i=this.resolvedProperty,r=0,n=i.length;r!==n;++r)i[r]=t[e++];this.targetObject.needsUpdate=!0},function(t,e){for(var i=this.resolvedProperty,r=0,n=i.length;r!==n;++r)i[r]=t[e++];this.targetObject.matrixWorldNeedsUpdate=!0}],[function(t,e){this.resolvedProperty[this.propertyIndex]=t[e]},function(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.needsUpdate=!0},function(t,e){this.resolvedProperty[this.propertyIndex]=t[e],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(t,e){this.resolvedProperty.fromArray(t,e)},function(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.needsUpdate=!0},function(t,e){this.resolvedProperty.fromArray(t,e),this.targetObject.matrixWorldNeedsUpdate=!0}]],getValue:function(t,e){this.bind(),this.getValue(t,e)},setValue:function(t,e){this.bind(),this.setValue(t,e)},bind:function(){var t=this.node,e=this.parsedPath,i=e.objectName,r=e.propertyName,n=e.propertyIndex;if(t||(t=mh.findNode(this.rootNode,e.nodeName)||this.rootNode,this.node=t),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,t){if(i){var o=e.objectIndex;switch(i){case"materials":if(!t.material)return;if(!t.material.materials)return;t=t.material.materials;break;case"bones":if(!t.skeleton)return;t=t.skeleton.bones;for(var a=0;a<t.length;a++)if(t[a].name===o){o=a;break}break;default:if(void 0===t[i])return;t=t[i]}if(void 0!==o){if(void 0===t[o])return;t=t[o]}}var s=t[r];if(void 0!==s){var h=this.Versioning.None;void 0!==t.needsUpdate?(h=this.Versioning.NeedsUpdate,this.targetObject=t):void 0!==t.matrixWorldNeedsUpdate&&(h=this.Versioning.MatrixWorldNeedsUpdate,this.targetObject=t);var l=this.BindingType.Direct;if(void 0!==n){if("morphTargetInfluences"===r){if(!t.geometry)return;if(t.geometry.isBufferGeometry){if(!t.geometry.morphAttributes)return;for(a=0;a<this.node.geometry.morphAttributes.position.length;a++)if(t.geometry.morphAttributes.position[a].name===n){n=a;break}}else{if(!t.geometry.morphTargets)return;for(a=0;a<this.node.geometry.morphTargets.length;a++)if(t.geometry.morphTargets[a].name===n){n=a;break}}}l=this.BindingType.ArrayElement,this.resolvedProperty=s,this.propertyIndex=n}else void 0!==s.fromArray&&void 0!==s.toArray?(l=this.BindingType.HasFromToArray,this.resolvedProperty=s):Array.isArray(s)?(l=this.BindingType.EntireArray,this.resolvedProperty=s):this.propertyName=r;this.getValue=this.GetterByBindingType[l],this.setValue=this.SetterByBindingTypeAndVersioning[l][h]}else e.nodeName}},unbind:function(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}),Object.assign(mh.prototype,{_getValue_unbound:mh.prototype.getValue,_setValue_unbound:mh.prototype.setValue}),Object.assign(gh.prototype,{isAnimationObjectGroup:!0,add:function(){for(var t=this._objects,e=t.length,i=this.nCachedObjects_,r=this._indicesByUUID,n=this._paths,o=this._parsedPaths,a=this._bindings,s=a.length,h=0,l=arguments.length;h!==l;++h){var c=arguments[h],u=c.uuid,p=r[u];if(void 0===p){p=e++,r[u]=p,t.push(c);for(var d=0,f=s;d!==f;++d)a[d].push(new mh(c,n[d],o[d]))}else if(p<i){t[p];var m=--i,g=t[m];r[g.uuid]=p,t[p]=g,r[u]=m,t[m]=c;for(d=0,f=s;d!==f;++d){var v=a[d],y=v[m],E=v[p];v[p]=y,void 0===E&&(E=new mh(c,n[d],o[d])),v[m]=E}}else t[p]}this.nCachedObjects_=i},remove:function(){for(var t=this._objects,e=this.nCachedObjects_,i=this._indicesByUUID,r=this._bindings,n=r.length,o=0,a=arguments.length;o!==a;++o){var s=arguments[o],h=s.uuid,l=i[h];if(void 0!==l&&l>=e){var c=e++,u=t[c];i[u.uuid]=l,t[l]=u,i[h]=c,t[c]=s;for(var p=0,d=n;p!==d;++p){var f=r[p],m=f[c],g=f[l];f[l]=m,f[c]=g}}}this.nCachedObjects_=e},uncache:function(){for(var t=this._objects,e=t.length,i=this.nCachedObjects_,r=this._indicesByUUID,n=this._bindings,o=n.length,a=0,s=arguments.length;a!==s;++a){var h=arguments[a].uuid,l=r[h];if(void 0!==l)if(delete r[h],l<i){var c=--i,u=t[c],p=t[v=--e];r[u.uuid]=l,t[l]=u,r[p.uuid]=c,t[c]=p,t.pop();for(var d=0,f=o;d!==f;++d){var m=(y=n[d])[c],g=y[v];y[l]=m,y[c]=g,y.pop()}}else{var v;r[(p=t[v=--e]).uuid]=l,t[l]=p,t.pop();for(d=0,f=o;d!==f;++d){var y;(y=n[d])[l]=y[v],y.pop()}}}this.nCachedObjects_=i},subscribe_:function(t,e){var i=this._bindingsIndicesByPath,r=i[t],n=this._bindings;if(void 0!==r)return n[r];var o=this._paths,a=this._parsedPaths,s=this._objects,h=s.length,l=this.nCachedObjects_,c=new Array(h);r=n.length,i[t]=r,o.push(t),a.push(e),n.push(c);for(var u=l,p=s.length;u!==p;++u){var d=s[u];c[u]=new mh(d,t,e)}return c},unsubscribe_:function(t){var e=this._bindingsIndicesByPath,i=e[t];if(void 0!==i){var r=this._paths,n=this._parsedPaths,o=this._bindings,a=o.length-1,s=o[a];e[t[a]]=i,o[i]=s,o.pop(),n[i]=n[a],n.pop(),r[i]=r[a],r.pop()}}}),Object.assign(vh.prototype,{play:function(){return this._mixer._activateAction(this),this},stop:function(){return this._mixer._deactivateAction(this),this.reset()},reset:function(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()},isRunning:function(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)},isScheduled:function(){return this._mixer._isActiveAction(this)},startAt:function(t){return this._startTime=t,this},setLoop:function(t,e){return this.loop=t,this.repetitions=e,this},setEffectiveWeight:function(t){return this.weight=t,this._effectiveWeight=this.enabled?t:0,this.stopFading()},getEffectiveWeight:function(){return this._effectiveWeight},fadeIn:function(t){return this._scheduleFading(t,0,1)},fadeOut:function(t){return this._scheduleFading(t,1,0)},crossFadeFrom:function(t,e,i){if(t.fadeOut(e),this.fadeIn(e),i){var r=this._clip.duration,n=t._clip.duration,o=n/r,a=r/n;t.warp(1,o,e),this.warp(a,1,e)}return this},crossFadeTo:function(t,e,i){return t.crossFadeFrom(this,e,i)},stopFading:function(){var t=this._weightInterpolant;return null!==t&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(t)),this},setEffectiveTimeScale:function(t){return this.timeScale=t,this._effectiveTimeScale=this.paused?0:t,this.stopWarping()},getEffectiveTimeScale:function(){return this._effectiveTimeScale},setDuration:function(t){return this.timeScale=this._clip.duration/t,this.stopWarping()},syncWith:function(t){return this.time=t.time,this.timeScale=t.timeScale,this.stopWarping()},halt:function(t){return this.warp(this._effectiveTimeScale,0,t)},warp:function(t,e,i){var r=this._mixer,n=r.time,o=this._timeScaleInterpolant,a=this.timeScale;null===o&&(o=r._lendControlInterpolant(),this._timeScaleInterpolant=o);var s=o.parameterPositions,h=o.sampleValues;return s[0]=n,s[1]=n+i,h[0]=t/a,h[1]=e/a,this},stopWarping:function(){var t=this._timeScaleInterpolant;return null!==t&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(t)),this},getMixer:function(){return this._mixer},getClip:function(){return this._clip},getRoot:function(){return this._localRoot||this._mixer._root},_update:function(t,e,i,r){if(this.enabled){var n=this._startTime;if(null!==n){var o=(t-n)*i;if(o<0||0===i)return;this._startTime=null,e=i*o}e*=this._updateTimeScale(t);var a=this._updateTime(e),s=this._updateWeight(t);if(s>0)for(var h=this._interpolants,l=this._propertyBindings,c=0,u=h.length;c!==u;++c)h[c].evaluate(a),l[c].accumulate(r,s)}else this._updateWeight(t)},_updateWeight:function(t){var e=0;if(this.enabled){e=this.weight;var i=this._weightInterpolant;if(null!==i){var r=i.evaluate(t)[0];e*=r,t>i.parameterPositions[1]&&(this.stopFading(),0===r&&(this.enabled=!1))}}return this._effectiveWeight=e,e},_updateTimeScale:function(t){var e=0;if(!this.paused){e=this.timeScale;var i=this._timeScaleInterpolant;if(null!==i)e*=i.evaluate(t)[0],t>i.parameterPositions[1]&&(this.stopWarping(),0===e?this.paused=!0:this.timeScale=e)}return this._effectiveTimeScale=e,e},_updateTime:function(t){var e=this.time+t;if(0===t)return e;var i=this._clip.duration,r=this.loop,n=this._loopCount;if(2200===r){-1===n&&(this._loopCount=0,this._setEndings(!0,!0,!1));t:{if(e>=i)e=i;else{if(!(e<0))break t;e=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this._mixer.dispatchEvent({type:"finished",action:this,direction:t<0?-1:1})}}else{var o=2202===r;if(-1===n&&(t>=0?(n=0,this._setEndings(!0,0===this.repetitions,o)):this._setEndings(0===this.repetitions,!0,o)),e>=i||e<0){var a=Math.floor(e/i);e-=i*a,n+=Math.abs(a);var s=this.repetitions-n;if(s<=0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,e=t>0?i:0,this._mixer.dispatchEvent({type:"finished",action:this,direction:t>0?1:-1});else{if(1===s){var h=t<0;this._setEndings(h,!h,o)}else this._setEndings(!1,!1,o);this._loopCount=n,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:a})}}if(o&&1==(1&n))return this.time=e,i-e}return this.time=e,e},_setEndings:function(t,e,i){var r=this._interpolantSettings;i?(r.endingStart=2401,r.endingEnd=2401):(r.endingStart=t?this.zeroSlopeAtStart?2401:fe:2402,r.endingEnd=e?this.zeroSlopeAtEnd?2401:fe:2402)},_scheduleFading:function(t,e,i){var r=this._mixer,n=r.time,o=this._weightInterpolant;null===o&&(o=r._lendControlInterpolant(),this._weightInterpolant=o);var a=o.parameterPositions,s=o.sampleValues;return a[0]=n,s[0]=e,a[1]=n+t,s[1]=i,this}}),yh.prototype=Object.assign(Object.create(e.prototype),{constructor:yh,_bindAction:function(t,e){var i=t._localRoot||this._root,r=t._clip.tracks,n=r.length,o=t._propertyBindings,a=t._interpolants,s=i.uuid,h=this._bindingsByRootAndName,l=h[s];void 0===l&&(l={},h[s]=l);for(var c=0;c!==n;++c){var u=r[c],p=u.name,d=l[p];if(void 0!==d)o[c]=d;else{if(void 0!==(d=o[c])){null===d._cacheIndex&&(++d.referenceCount,this._addInactiveBinding(d,s,p));continue}var f=e&&e._propertyBindings[c].binding.parsedPath;++(d=new th(mh.create(i,p,f),u.ValueTypeName,u.getValueSize())).referenceCount,this._addInactiveBinding(d,s,p),o[c]=d}a[c].resultBuffer=d.buffer}},_activateAction:function(t){if(!this._isActiveAction(t)){if(null===t._cacheIndex){var e=(t._localRoot||this._root).uuid,i=t._clip.uuid,r=this._actionsByClip[i];this._bindAction(t,r&&r.knownActions[0]),this._addInactiveAction(t,i,e)}for(var n=t._propertyBindings,o=0,a=n.length;o!==a;++o){var s=n[o];0==s.useCount++&&(this._lendBinding(s),s.saveOriginalState())}this._lendAction(t)}},_deactivateAction:function(t){if(this._isActiveAction(t)){for(var e=t._propertyBindings,i=0,r=e.length;i!==r;++i){var n=e[i];0==--n.useCount&&(n.restoreOriginalState(),this._takeBackBinding(n))}this._takeBackAction(t)}},_initMemoryManager:function(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;var t=this;this.stats={actions:{get total(){return t._actions.length},get inUse(){return t._nActiveActions}},bindings:{get total(){return t._bindings.length},get inUse(){return t._nActiveBindings}},controlInterpolants:{get total(){return t._controlInterpolants.length},get inUse(){return t._nActiveControlInterpolants}}}},_isActiveAction:function(t){var e=t._cacheIndex;return null!==e&&e<this._nActiveActions},_addInactiveAction:function(t,e,i){var r=this._actions,n=this._actionsByClip,o=n[e];if(void 0===o)o={knownActions:[t],actionByRoot:{}},t._byClipCacheIndex=0,n[e]=o;else{var a=o.knownActions;t._byClipCacheIndex=a.length,a.push(t)}t._cacheIndex=r.length,r.push(t),o.actionByRoot[i]=t},_removeInactiveAction:function(t){var e=this._actions,i=e[e.length-1],r=t._cacheIndex;i._cacheIndex=r,e[r]=i,e.pop(),t._cacheIndex=null;var n=t._clip.uuid,o=this._actionsByClip,a=o[n],s=a.knownActions,h=s[s.length-1],l=t._byClipCacheIndex;h._byClipCacheIndex=l,s[l]=h,s.pop(),t._byClipCacheIndex=null,delete a.actionByRoot[(t._localRoot||this._root).uuid],0===s.length&&delete o[n],this._removeInactiveBindingsForAction(t)},_removeInactiveBindingsForAction:function(t){for(var e=t._propertyBindings,i=0,r=e.length;i!==r;++i){var n=e[i];0==--n.referenceCount&&this._removeInactiveBinding(n)}},_lendAction:function(t){var e=this._actions,i=t._cacheIndex,r=this._nActiveActions++,n=e[r];t._cacheIndex=r,e[r]=t,n._cacheIndex=i,e[i]=n},_takeBackAction:function(t){var e=this._actions,i=t._cacheIndex,r=--this._nActiveActions,n=e[r];t._cacheIndex=r,e[r]=t,n._cacheIndex=i,e[i]=n},_addInactiveBinding:function(t,e,i){var r=this._bindingsByRootAndName,n=r[e],o=this._bindings;void 0===n&&(n={},r[e]=n),n[i]=t,t._cacheIndex=o.length,o.push(t)},_removeInactiveBinding:function(t){var e=this._bindings,i=t.binding,r=i.rootNode.uuid,n=i.path,o=this._bindingsByRootAndName,a=o[r],s=e[e.length-1],h=t._cacheIndex;s._cacheIndex=h,e[h]=s,e.pop(),delete a[n];t:{for(var l in a)break t;delete o[r]}},_lendBinding:function(t){var e=this._bindings,i=t._cacheIndex,r=this._nActiveBindings++,n=e[r];t._cacheIndex=r,e[r]=t,n._cacheIndex=i,e[i]=n},_takeBackBinding:function(t){var e=this._bindings,i=t._cacheIndex,r=--this._nActiveBindings,n=e[r];t._cacheIndex=r,e[r]=t,n._cacheIndex=i,e[i]=n},_lendControlInterpolant:function(){var t=this._controlInterpolants,e=this._nActiveControlInterpolants++,i=t[e];return void 0===i&&((i=new cs(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer)).__cacheIndex=e,t[e]=i),i},_takeBackControlInterpolant:function(t){var e=this._controlInterpolants,i=t.__cacheIndex,r=--this._nActiveControlInterpolants,n=e[r];t.__cacheIndex=r,e[r]=t,n.__cacheIndex=i,e[i]=n},_controlInterpolantsResultBuffer:new Float32Array(1),clipAction:function(t,e){var i=e||this._root,r=i.uuid,n="string"==typeof t?ms.findByName(i,t):t,o=null!==n?n.uuid:t,a=this._actionsByClip[o],s=null;if(void 0!==a){var h=a.actionByRoot[r];if(void 0!==h)return h;s=a.knownActions[0],null===n&&(n=s._clip)}if(null===n)return null;var l=new vh(this,n,e);return this._bindAction(l,s),this._addInactiveAction(l,o,r),l},existingAction:function(t,e){var i=e||this._root,r=i.uuid,n="string"==typeof t?ms.findByName(i,t):t,o=n?n.uuid:t,a=this._actionsByClip[o];return void 0!==a&&a.actionByRoot[r]||null},stopAllAction:function(){var t=this._actions,e=this._nActiveActions,i=this._bindings,r=this._nActiveBindings;this._nActiveActions=0,this._nActiveBindings=0;for(var n=0;n!==e;++n)t[n].reset();for(n=0;n!==r;++n)i[n].useCount=0;return this},update:function(t){t*=this.timeScale;for(var e=this._actions,i=this._nActiveActions,r=this.time+=t,n=Math.sign(t),o=this._accuIndex^=1,a=0;a!==i;++a){e[a]._update(r,t,n,o)}var s=this._bindings,h=this._nActiveBindings;for(a=0;a!==h;++a)s[a].apply(o);return this},getRoot:function(){return this._root},uncacheClip:function(t){var e=this._actions,i=t.uuid,r=this._actionsByClip,n=r[i];if(void 0!==n){for(var o=n.knownActions,a=0,s=o.length;a!==s;++a){var h=o[a];this._deactivateAction(h);var l=h._cacheIndex,c=e[e.length-1];h._cacheIndex=null,h._byClipCacheIndex=null,c._cacheIndex=l,e[l]=c,e.pop(),this._removeInactiveBindingsForAction(h)}delete r[i]}},uncacheRoot:function(t){var e=t.uuid,i=this._actionsByClip;for(var r in i){var n=i[r].actionByRoot[e];void 0!==n&&(this._deactivateAction(n),this._removeInactiveAction(n))}var o=this._bindingsByRootAndName[e];if(void 0!==o)for(var a in o){var s=o[a];s.restoreOriginalState(),this._removeInactiveBinding(s)}},uncacheAction:function(t,e){var i=this.existingAction(t,e);null!==i&&(this._deactivateAction(i),this._removeInactiveAction(i))}}),Eh.prototype.clone=function(){return new Eh(void 0===this.value.clone?this.value:this.value.clone())},xh.prototype=Object.assign(Object.create(Hi.prototype),{constructor:xh,isInstancedBufferGeometry:!0,copy:function(t){return Hi.prototype.copy.call(this,t),this.maxInstancedCount=t.maxInstancedCount,this},clone:function(){return(new this.constructor).copy(this)}}),Object.defineProperties(_h.prototype,{count:{get:function(){return this.data.count}},array:{get:function(){return this.data.array}}}),Object.assign(_h.prototype,{isInterleavedBufferAttribute:!0,setX:function(t,e){return this.data.array[t*this.data.stride+this.offset]=e,this},setY:function(t,e){return this.data.array[t*this.data.stride+this.offset+1]=e,this},setZ:function(t,e){return this.data.array[t*this.data.stride+this.offset+2]=e,this},setW:function(t,e){return this.data.array[t*this.data.stride+this.offset+3]=e,this},getX:function(t){return this.data.array[t*this.data.stride+this.offset]},getY:function(t){return this.data.array[t*this.data.stride+this.offset+1]},getZ:function(t){return this.data.array[t*this.data.stride+this.offset+2]},getW:function(t){return this.data.array[t*this.data.stride+this.offset+3]},setXY:function(t,e,i){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this},setXYZ:function(t,e,i,r){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=r,this},setXYZW:function(t,e,i,r,n){return t=t*this.data.stride+this.offset,this.data.array[t+0]=e,this.data.array[t+1]=i,this.data.array[t+2]=r,this.data.array[t+3]=n,this}}),Object.defineProperty(wh.prototype,"needsUpdate",{set:function(t){!0===t&&this.version++}}),Object.assign(wh.prototype,{isInterleavedBuffer:!0,onUploadCallback:function(){},setArray:function(t){if(Array.isArray(t))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");return this.count=void 0!==t?t.length/this.stride:0,this.array=t,this},setDynamic:function(t){return this.dynamic=t,this},copy:function(t){return this.array=new t.array.constructor(t.array),this.count=t.count,this.stride=t.stride,this.dynamic=t.dynamic,this},copyAt:function(t,e,i){t*=this.stride,i*=e.stride;for(var r=0,n=this.stride;r<n;r++)this.array[t+r]=e.array[i+r];return this},set:function(t,e){return void 0===e&&(e=0),this.array.set(t,e),this},clone:function(){return(new this.constructor).copy(this)},onUpload:function(t){return this.onUploadCallback=t,this}}),bh.prototype=Object.assign(Object.create(wh.prototype),{constructor:bh,isInstancedInterleavedBuffer:!0,copy:function(t){return wh.prototype.copy.call(this,t),this.meshPerAttribute=t.meshPerAttribute,this}}),Sh.prototype=Object.assign(Object.create(_i.prototype),{constructor:Sh,isInstancedBufferAttribute:!0,copy:function(t){return _i.prototype.copy.call(this,t),this.meshPerAttribute=t.meshPerAttribute,this}}),Object.assign(Th.prototype,{linePrecision:1,set:function(t,e){this.ray.set(t,e)},setFromCamera:function(t,e){e&&e.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(e.matrixWorld),this.ray.direction.set(t.x,t.y,.5).unproject(e).sub(this.ray.origin).normalize()):e&&e.isOrthographicCamera&&(this.ray.origin.set(t.x,t.y,(e.near+e.far)/(e.near-e.far)).unproject(e),this.ray.direction.set(0,0,-1).transformDirection(e.matrixWorld))},intersectObject:function(t,e,i){var r=i||[];return Rh(t,this,r,e),r.sort(Mh),r},intersectObjects:function(t,e,i){var r=i||[];if(!1===Array.isArray(t))return r;for(var n=0,o=t.length;n<o;n++)Rh(t[n],this,r,e);return r.sort(Mh),r}}),Object.assign(Ah.prototype,{start:function(){this.startTime=("undefined"==typeof performance?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1,this.autoStart=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var t=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){var e=("undefined"==typeof performance?Date:performance).now();t=(e-this.oldTime)/1e3,this.oldTime=e,this.elapsedTime+=t}return t}}),Object.assign(Ch.prototype,{set:function(t,e,i){return this.radius=t,this.phi=e,this.theta=i,this},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.radius=t.radius,this.phi=t.phi,this.theta=t.theta,this},makeSafe:function(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this},setFromVector3:function(t){return this.radius=t.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(t.x,t.z),this.phi=Math.acos(Ce.clamp(t.y/this.radius,-1,1))),this}}),Object.assign(Ph.prototype,{set:function(t,e,i){return this.radius=t,this.theta=e,this.y=i,this},clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.radius=t.radius,this.theta=t.theta,this.y=t.y,this},setFromVector3:function(t){return this.radius=Math.sqrt(t.x*t.x+t.z*t.z),this.theta=Math.atan2(t.x,t.z),this.y=t.y,this}}),Object.assign(Dh.prototype,{set:function(t,e){return this.min.copy(t),this.max.copy(e),this},setFromPoints:function(t){this.makeEmpty();for(var e=0,i=t.length;e<i;e++)this.expandByPoint(t[e]);return this},setFromCenterAndSize:function(){var t=new Pe;return function(e,i){var r=t.copy(i).multiplyScalar(.5);return this.min.copy(e).sub(r),this.max.copy(e).add(r),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(t){return this.min.copy(t.min),this.max.copy(t.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},getCenter:function(t){return void 0===t&&(t=new Pe),this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(t){return void 0===t&&(t=new Pe),this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)},expandByPoint:function(t){return this.min.min(t),this.max.max(t),this},expandByVector:function(t){return this.min.sub(t),this.max.add(t),this},expandByScalar:function(t){return this.min.addScalar(-t),this.max.addScalar(t),this},containsPoint:function(t){return!(t.x<this.min.x||t.x>this.max.x||t.y<this.min.y||t.y>this.max.y)},containsBox:function(t){return this.min.x<=t.min.x&&t.max.x<=this.max.x&&this.min.y<=t.min.y&&t.max.y<=this.max.y},getParameter:function(t,e){return void 0===e&&(e=new Pe),e.set((t.x-this.min.x)/(this.max.x-this.min.x),(t.y-this.min.y)/(this.max.y-this.min.y))},intersectsBox:function(t){return!(t.max.x<this.min.x||t.min.x>this.max.x||t.max.y<this.min.y||t.min.y>this.max.y)},clampPoint:function(t,e){return void 0===e&&(e=new Pe),e.copy(t).clamp(this.min,this.max)},distanceToPoint:function(){var t=new Pe;return function(e){return t.copy(e).clamp(this.min,this.max).sub(e).length()}}(),intersect:function(t){return this.min.max(t.min),this.max.min(t.max),this},union:function(t){return this.min.min(t.min),this.max.max(t.max),this},translate:function(t){return this.min.add(t),this.max.add(t),this},equals:function(t){return t.min.equals(this.min)&&t.max.equals(this.max)}}),Lh.prototype=Object.create(di.prototype),Lh.prototype.constructor=Lh,Lh.prototype.isImmediateRenderObject=!0,Oh.prototype=Object.create(Bn.prototype),Oh.prototype.constructor=Oh,Oh.prototype.update=function(){var t=new Oe,e=new Oe,i=new He;return function(){var r=["a","b","c"];this.object.updateMatrixWorld(!0),i.getNormalMatrix(this.object.matrixWorld);var n=this.object.matrixWorld,o=this.geometry.attributes.position,a=this.object.geometry;if(a&&a.isGeometry)for(var s=a.vertices,h=a.faces,l=0,c=0,u=h.length;c<u;c++)for(var p=h[c],d=0,f=p.vertexNormals.length;d<f;d++){var m=s[p[r[d]]],g=p.vertexNormals[d];t.copy(m).applyMatrix4(n),e.copy(g).applyMatrix3(i).normalize().multiplyScalar(this.size).add(t),o.setXYZ(l,t.x,t.y,t.z),l+=1,o.setXYZ(l,e.x,e.y,e.z),l+=1}else if(a&&a.isBufferGeometry){var v=a.attributes.position,y=a.attributes.normal;for(l=0,d=0,f=v.count;d<f;d++)t.set(v.getX(d),v.getY(d),v.getZ(d)).applyMatrix4(n),e.set(y.getX(d),y.getY(d),y.getZ(d)),e.applyMatrix3(i).normalize().multiplyScalar(this.size).add(t),o.setXYZ(l,t.x,t.y,t.z),l+=1,o.setXYZ(l,e.x,e.y,e.z),l+=1}o.needsUpdate=!0}}(),Hh.prototype=Object.create(di.prototype),Hh.prototype.constructor=Hh,Hh.prototype.dispose=function(){this.cone.geometry.dispose(),this.cone.material.dispose()},Hh.prototype.update=function(){var t=new Oe,e=new Oe;return function(){this.light.updateMatrixWorld();var i=this.light.distance?this.light.distance:1e3,r=i*Math.tan(this.light.angle);this.cone.scale.set(r,r,i),t.setFromMatrixPosition(this.light.matrixWorld),e.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(e.sub(t)),void 0!==this.color?this.cone.material.color.set(this.color):this.cone.material.color.copy(this.light.color)}}(),Ih.prototype=Object.create(Bn.prototype),Ih.prototype.constructor=Ih,Ih.prototype.updateMatrixWorld=function(){var t=new Oe,e=new De,i=new De;return function(r){var n=this.bones,o=this.geometry,a=o.getAttribute("position");i.getInverse(this.root.matrixWorld);for(var s=0,h=0;s<n.length;s++){var l=n[s];l.parent&&l.parent.isBone&&(e.multiplyMatrices(i,l.matrixWorld),t.setFromMatrixPosition(e),a.setXYZ(h,t.x,t.y,t.z),e.multiplyMatrices(i,l.parent.matrixWorld),t.setFromMatrixPosition(e),a.setXYZ(h+1,t.x,t.y,t.z),h+=2)}o.getAttribute("position").needsUpdate=!0,di.prototype.updateMatrixWorld.call(this,r)}}(),Bh.prototype=Object.create($i.prototype),Bh.prototype.constructor=Bh,Bh.prototype.dispose=function(){this.geometry.dispose(),this.material.dispose()},Bh.prototype.update=function(){void 0!==this.color?this.material.color.set(this.color):this.material.color.copy(this.light.color)},zh.prototype=Object.create(di.prototype),zh.prototype.constructor=zh,zh.prototype.dispose=function(){this.children[0].geometry.dispose(),this.children[0].material.dispose()},zh.prototype.update=function(){var t=.5*this.light.width,e=.5*this.light.height,i=this.line.geometry.attributes.position,r=i.array;r[0]=t,r[1]=-e,r[2]=0,r[3]=t,r[4]=e,r[5]=0,r[6]=-t,r[7]=e,r[8]=0,r[9]=-t,r[10]=-e,r[11]=0,r[12]=t,r[13]=-e,r[14]=0,i.needsUpdate=!0,void 0!==this.color?this.line.material.color.set(this.color):this.line.material.color.copy(this.light.color)},Nh.prototype=Object.create(di.prototype),Nh.prototype.constructor=Nh,Nh.prototype.dispose=function(){this.children[0].geometry.dispose(),this.children[0].material.dispose()},Nh.prototype.update=function(){var t=new Oe,e=new ti,i=new ti;return function(){var r=this.children[0];if(void 0!==this.color)this.material.color.set(this.color);else{var n=r.geometry.getAttribute("color");e.copy(this.light.color),i.copy(this.light.groundColor);for(var o=0,a=n.count;o<a;o++){var s=o<a/2?e:i;n.setXYZ(o,s.r,s.g,s.b)}n.needsUpdate=!0}r.lookAt(t.setFromMatrixPosition(this.light.matrixWorld).negate())}}(),kh.prototype=Object.create(Bn.prototype),kh.prototype.constructor=kh,jh.prototype=Object.create(Bn.prototype),jh.prototype.constructor=jh,Vh.prototype=Object.create(Bn.prototype),Vh.prototype.constructor=Vh,Vh.prototype.update=function(){var t=new Oe,e=new Oe,i=new He;return function(){this.object.updateMatrixWorld(!0),i.getNormalMatrix(this.object.matrixWorld);for(var r=this.object.matrixWorld,n=this.geometry.attributes.position,o=this.object.geometry,a=o.vertices,s=o.faces,h=0,l=0,c=s.length;l<c;l++){var u=s[l],p=u.normal;t.copy(a[u.a]).add(a[u.b]).add(a[u.c]).divideScalar(3).applyMatrix4(r),e.copy(p).applyMatrix3(i).normalize().multiplyScalar(this.size).add(t),n.setXYZ(h,t.x,t.y,t.z),h+=1,n.setXYZ(h,e.x,e.y,e.z),h+=1}n.needsUpdate=!0}}(),Fh.prototype=Object.create(di.prototype),Fh.prototype.constructor=Fh,Fh.prototype.dispose=function(){this.lightPlane.geometry.dispose(),this.lightPlane.material.dispose(),this.targetLine.geometry.dispose(),this.targetLine.material.dispose()},Fh.prototype.update=function(){var t=new Oe,e=new Oe,i=new Oe;return function(){t.setFromMatrixPosition(this.light.matrixWorld),e.setFromMatrixPosition(this.light.target.matrixWorld),i.subVectors(e,t),this.lightPlane.lookAt(i),void 0!==this.color?(this.lightPlane.material.color.set(this.color),this.targetLine.material.color.set(this.color)):(this.lightPlane.material.color.copy(this.light.color),this.targetLine.material.color.copy(this.light.color)),this.targetLine.lookAt(i),this.targetLine.scale.z=i.length()}}(),Uh.prototype=Object.create(Bn.prototype),Uh.prototype.constructor=Uh,Uh.prototype.update=function(){var t,e,i=new Oe,r=new fi;function n(n,o,a,s){i.set(o,a,s).unproject(r);var h=e[n];if(void 0!==h)for(var l=t.getAttribute("position"),c=0,u=h.length;c<u;c++)l.setXYZ(h[c],i.x,i.y,i.z)}return function(){t=this.geometry,e=this.pointMap;r.projectionMatrix.copy(this.camera.projectionMatrix),n("c",0,0,-1),n("t",0,0,1),n("n1",-1,-1,-1),n("n2",1,-1,-1),n("n3",-1,1,-1),n("n4",1,1,-1),n("f1",-1,-1,1),n("f2",1,-1,1),n("f3",-1,1,1),n("f4",1,1,1),n("u1",.7,1.1,-1),n("u2",-.7,1.1,-1),n("u3",0,2,-1),n("cf1",-1,0,1),n("cf2",1,0,1),n("cf3",0,-1,1),n("cf4",0,1,1),n("cn1",-1,0,-1),n("cn2",1,0,-1),n("cn3",0,-1,-1),n("cn4",0,1,-1),t.getAttribute("position").needsUpdate=!0}}(),Gh.prototype=Object.create(Bn.prototype),Gh.prototype.constructor=Gh,Gh.prototype.update=function(){var t=new Xe;return function(e){if(void 0!==this.object&&t.setFromObject(this.object),!t.isEmpty()){var i=t.min,r=t.max,n=this.geometry.attributes.position,o=n.array;o[0]=r.x,o[1]=r.y,o[2]=r.z,o[3]=i.x,o[4]=r.y,o[5]=r.z,o[6]=i.x,o[7]=i.y,o[8]=r.z,o[9]=r.x,o[10]=i.y,o[11]=r.z,o[12]=r.x,o[13]=r.y,o[14]=i.z,o[15]=i.x,o[16]=r.y,o[17]=i.z,o[18]=i.x,o[19]=i.y,o[20]=i.z,o[21]=r.x,o[22]=i.y,o[23]=i.z,n.needsUpdate=!0,this.geometry.computeBoundingSphere()}}}(),Gh.prototype.setFromObject=function(t){return this.object=t,this.update(),this},Wh.prototype=Object.create(Bn.prototype),Wh.prototype.constructor=Wh,Wh.prototype.updateMatrixWorld=function(t){var e=this.box;e.isEmpty()||(e.getCenter(this.position),e.getSize(this.scale),this.scale.multiplyScalar(.5),di.prototype.updateMatrixWorld.call(this,t))},Xh.prototype=Object.create(In.prototype),Xh.prototype.constructor=Xh,Xh.prototype.updateMatrixWorld=function(t){var e=-this.plane.constant;Math.abs(e)<1e-8&&(e=1e-8),this.scale.set(.5*this.size,.5*this.size,e),this.children[0].material.side=e<0?E:y,this.lookAt(this.plane.normal),di.prototype.updateMatrixWorld.call(this,t)},Zh.prototype=Object.create(di.prototype),Zh.prototype.constructor=Zh,Zh.prototype.setDirection=(dh=new Oe,function(t){t.y>.99999?this.quaternion.set(0,0,0,1):t.y<-.99999?this.quaternion.set(1,0,0,0):(dh.set(t.z,0,-t.x).normalize(),ph=Math.acos(t.y),this.quaternion.setFromAxisAngle(dh,ph))}),Zh.prototype.setLength=function(t,e,i){void 0===e&&(e=.2*t),void 0===i&&(i=.2*e),this.line.scale.set(1,Math.max(0,t-e),1),this.line.updateMatrix(),this.cone.scale.set(i,e,i),this.cone.position.y=t,this.cone.updateMatrix()},Zh.prototype.setColor=function(t){this.line.material.color.copy(t),this.cone.material.color.copy(t)},Yh.prototype=Object.create(Bn.prototype),Yh.prototype.constructor=Yh;function qh(t){Da.call(this,t),this.type="catmullrom",this.closed=!0}function Jh(t){Da.call(this,t),this.type="catmullrom"}function Qh(t){Da.call(this,t),this.type="catmullrom"}ba.create=function(t,e){return t.prototype=Object.create(ba.prototype),t.prototype.constructor=t,t.prototype.getPoint=e,t},Object.assign(Ua.prototype,{createPointsGeometry:function(t){var e=this.getPoints(t);return this.createGeometry(e)},createSpacedPointsGeometry:function(t){var e=this.getSpacedPoints(t);return this.createGeometry(e)},createGeometry:function(t){for(var e=new xi,i=0,r=t.length;i<r;i++){var n=t[i];e.vertices.push(new Oe(n.x,n.y,n.z||0))}return e}}),Object.assign(Ga.prototype,{fromPoints:function(t){this.setFromPoints(t)}}),qh.prototype=Object.create(Da.prototype),Jh.prototype=Object.create(Da.prototype),Qh.prototype=Object.create(Da.prototype),Object.assign(Qh.prototype,{initFromArray:function(){},getControlPointsArray:function(){},reparametrizeByArcLength:function(){}}),kh.prototype.setColors=function(){},Ih.prototype.update=function(){},Object.assign(bs.prototype,{extractUrlBase:function(t){return Ss.extractUrlBase(t)}}),Object.assign(Dh.prototype,{center:function(t){return this.getCenter(t)},empty:function(){return this.isEmpty()},isIntersectionBox:function(t){return this.intersectsBox(t)},size:function(t){return this.getSize(t)}}),Object.assign(Xe.prototype,{center:function(t){return this.getCenter(t)},empty:function(){return this.isEmpty()},isIntersectionBox:function(t){return this.intersectsBox(t)},isIntersectionSphere:function(t){return this.intersectsSphere(t)},size:function(t){return this.getSize(t)}}),Qi.prototype.center=function(t){return this.getCenter(t)},Object.assign(Ce,{random16:function(){return Math.random()},nearestPowerOfTwo:function(t){return Ce.floorPowerOfTwo(t)},nextPowerOfTwo:function(t){return Ce.ceilPowerOfTwo(t)}}),Object.assign(He.prototype,{flattenToArrayOffset:function(t,e){return this.toArray(t,e)},multiplyVector3:function(t){return t.applyMatrix3(this)},multiplyVector3Array:function(){},applyToBuffer:function(t){return this.applyToBufferAttribute(t)},applyToVector3Array:function(){}}),Object.assign(De.prototype,{extractPosition:function(t){return this.copyPosition(t)},flattenToArrayOffset:function(t,e){return this.toArray(t,e)},getPosition:function(){var t;return function(){return void 0===t&&(t=new Oe),t.setFromMatrixColumn(this,3)}}(),setRotationFromQuaternion:function(t){return this.makeRotationFromQuaternion(t)},multiplyToArray:function(){},multiplyVector3:function(t){return t.applyMatrix4(this)},multiplyVector4:function(t){return t.applyMatrix4(this)},multiplyVector3Array:function(){},rotateAxis:function(t){t.transformDirection(this)},crossVector:function(t){return t.applyMatrix4(this)},translate:function(){},rotateX:function(){},rotateY:function(){},rotateZ:function(){},rotateByAxis:function(){},applyToBuffer:function(t){return this.applyToBufferAttribute(t)},applyToVector3Array:function(){},makeFrustum:function(t,e,i,r,n,o){return this.makePerspective(t,e,r,i,n,o)}}),Ye.prototype.isIntersectionLine=function(t){return this.intersectsLine(t)},Le.prototype.multiplyVector3=function(t){return t.applyQuaternion(this)},Object.assign(Ji.prototype,{isIntersectionBox:function(t){return this.intersectsBox(t)},isIntersectionPlane:function(t){return this.intersectsPlane(t)},isIntersectionSphere:function(t){return this.intersectsSphere(t)}}),Object.assign(Ki.prototype,{area:function(){return this.getArea()},barycoordFromPoint:function(t,e){return this.getBarycoord(t,e)},midpoint:function(t){return this.getMidpoint(t)},normal:function(t){return this.getNormal(t)},plane:function(t){return this.getPlane(t)}}),Object.assign(Ki,{barycoordFromPoint:function(t,e,i,r,n){return Ki.getBarycoord(t,e,i,r,n)},normal:function(t,e,i,r){return Ki.getNormal(t,e,i,r)}}),Object.assign(Wa.prototype,{extractAllPoints:function(t){return this.extractPoints(t)},extrude:function(t){return new Ho(this,t)},makeGeometry:function(t){return new Xo(this,t)}}),Object.assign(Pe.prototype,{fromAttribute:function(t,e,i){return this.fromBufferAttribute(t,e,i)},distanceToManhattan:function(t){return this.manhattanDistanceTo(t)},lengthManhattan:function(){return this.manhattanLength()}}),Object.assign(Oe.prototype,{setEulerFromRotationMatrix:function(){},setEulerFromQuaternion:function(){},getPositionFromMatrix:function(t){return this.setFromMatrixPosition(t)},getScaleFromMatrix:function(t){return this.setFromMatrixScale(t)},getColumnFromMatrix:function(t,e){return this.setFromMatrixColumn(e,t)},applyProjection:function(t){return this.applyMatrix4(t)},fromAttribute:function(t,e,i){return this.fromBufferAttribute(t,e,i)},distanceToManhattan:function(t){return this.manhattanDistanceTo(t)},lengthManhattan:function(){return this.manhattanLength()}}),Object.assign(Fe.prototype,{fromAttribute:function(t,e,i){return this.fromBufferAttribute(t,e,i)},lengthManhattan:function(){return this.manhattanLength()}}),Object.assign(xi.prototype,{computeTangents:function(){},computeLineDistances:function(){}}),Object.assign(di.prototype,{getChildByName:function(t){return this.getObjectByName(t)},renderDepth:function(){},translate:function(t,e){return this.translateOnAxis(e,t)},getWorldRotation:function(){}}),Object.defineProperties(di.prototype,{eulerOrder:{get:function(){return this.rotation.order},set:function(t){this.rotation.order=t}},useQuaternion:{get:function(){},set:function(){}}}),Object.defineProperties(Pn.prototype,{objects:{get:function(){return this.levels}}}),Object.defineProperty(Dn.prototype,"useVertexTexture",{get:function(){},set:function(){}}),Object.defineProperty(ba.prototype,"__arcLengthDivisions",{get:function(){return this.arcLengthDivisions},set:function(t){this.arcLengthDivisions=t}}),_n.prototype.setLens=function(t,e){void 0!==e&&(this.filmGauge=e),this.setFocalLength(t)},Object.defineProperties(Xa.prototype,{onlyShadow:{set:function(){}},shadowCameraFov:{set:function(t){this.shadow.camera.fov=t}},shadowCameraLeft:{set:function(t){this.shadow.camera.left=t}},shadowCameraRight:{set:function(t){this.shadow.camera.right=t}},shadowCameraTop:{set:function(t){this.shadow.camera.top=t}},shadowCameraBottom:{set:function(t){this.shadow.camera.bottom=t}},shadowCameraNear:{set:function(t){this.shadow.camera.near=t}},shadowCameraFar:{set:function(t){this.shadow.camera.far=t}},shadowCameraVisible:{set:function(){}},shadowBias:{set:function(t){this.shadow.bias=t}},shadowDarkness:{set:function(){}},shadowMapWidth:{set:function(t){this.shadow.mapSize.width=t}},shadowMapHeight:{set:function(t){this.shadow.mapSize.height=t}}}),Object.defineProperties(_i.prototype,{length:{get:function(){return this.array.length}},copyIndicesArray:function(){}}),Object.assign(Hi.prototype,{addIndex:function(t){this.setIndex(t)},addDrawCall:function(t,e,i){this.addGroup(t,e)},clearDrawCalls:function(){this.clearGroups()},computeTangents:function(){},computeOffsets:function(){}}),Object.defineProperties(Hi.prototype,{drawcalls:{get:function(){return this.groups}},offsets:{get:function(){return this.groups}}}),Object.assign(Io.prototype,{getArrays:function(){},addShapeList:function(){},addShape:function(){}}),Object.defineProperties(Eh.prototype,{dynamic:{set:function(){}},onUpdate:{value:function(){return this}}}),Object.defineProperties(Zi.prototype,{wrapAround:{get:function(){},set:function(){}},wrapRGB:{get:function(){return new ti}},shading:{get:function(){},set:function(t){this.flatShading=1===t}}}),Object.defineProperties(sa.prototype,{metal:{get:function(){return!1},set:function(){}}}),Object.defineProperties(qi.prototype,{derivatives:{get:function(){return this.extensions.derivatives},set:function(t){this.extensions.derivatives=t}}}),Object.assign(Sn.prototype,{animate:function(t){this.setAnimationLoop(t)},getCurrentRenderTarget:function(){return this.getRenderTarget()},getMaxAnisotropy:function(){return this.capabilities.getMaxAnisotropy()},getPrecision:function(){return this.capabilities.precision},resetGLState:function(){return this.state.reset()},supportsFloatTextures:function(){return this.extensions.get("OES_texture_float")},supportsHalfFloatTextures:function(){return this.extensions.get("OES_texture_half_float")},supportsStandardDerivatives:function(){return this.extensions.get("OES_standard_derivatives")},supportsCompressedTextureS3TC:function(){return this.extensions.get("WEBGL_compressed_texture_s3tc")},supportsCompressedTexturePVRTC:function(){return this.extensions.get("WEBGL_compressed_texture_pvrtc")},supportsBlendMinMax:function(){return this.extensions.get("EXT_blend_minmax")},supportsVertexTextures:function(){return this.capabilities.vertexTextures},supportsInstancedArrays:function(){return this.extensions.get("ANGLE_instanced_arrays")},enableScissorTest:function(t){this.setScissorTest(t)},initMaterial:function(){},addPrePlugin:function(){},addPostPlugin:function(){},updateShadowMap:function(){},setFaceCulling:function(){}}),Object.defineProperties(Sn.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(t){this.shadowMap.enabled=t}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(t){this.shadowMap.type=t}},shadowMapCullFace:{get:function(){},set:function(){}}}),Object.defineProperties(mn.prototype,{cullFace:{get:function(){},set:function(){}},renderReverseSided:{get:function(){},set:function(){}},renderSingleSided:{get:function(){},set:function(){}}}),Object.defineProperties(Ue.prototype,{wrapS:{get:function(){return this.texture.wrapS},set:function(t){this.texture.wrapS=t}},wrapT:{get:function(){return this.texture.wrapT},set:function(t){this.texture.wrapT=t}},magFilter:{get:function(){return this.texture.magFilter},set:function(t){this.texture.magFilter=t}},minFilter:{get:function(){return this.texture.minFilter},set:function(t){this.texture.minFilter=t}},anisotropy:{get:function(){return this.texture.anisotropy},set:function(t){this.texture.anisotropy=t}},offset:{get:function(){return this.texture.offset},set:function(t){this.texture.offset=t}},repeat:{get:function(){return this.texture.repeat},set:function(t){this.texture.repeat=t}},format:{get:function(){return this.texture.format},set:function(t){this.texture.format=t}},type:{get:function(){return this.texture.type},set:function(t){this.texture.type=t}},generateMipmaps:{get:function(){return this.texture.generateMipmaps},set:function(t){this.texture.generateMipmaps=t}}}),Object.defineProperties(bn.prototype,{standing:{set:function(){}}}),Qs.prototype.load=function(t){var e=this;return(new Zs).load(t,function(t){e.setBuffer(t)}),this},$s.prototype.getData=function(){return this.getFrequencyData()},qs.prototype.updateCubeMap=function(t,e){return this.update(t,e)};var Kh={crossOrigin:void 0,loadTexture:function(t,e,i,r){var n=new wa;n.setCrossOrigin(this.crossOrigin);var o=n.load(t,i,void 0,r);return e&&(o.mapping=e),o},loadTextureCube:function(t,e,i,r){var n=new _a;n.setCrossOrigin(this.crossOrigin);var o=n.load(t,i,void 0,r);return e&&(o.mapping=e),o},loadCompressedTexture:function(){},loadCompressedTextureCube:function(){}};t.WebGLRenderTargetCube=Ge,t.WebGLRenderTarget=Ue,t.WebGLRenderer=Sn,t.ShaderLib=ri,t.UniformsLib=ii,t.UniformsUtils=Ke,t.ShaderChunk=Qe,t.FogExp2=Tn,t.Fog=Mn,t.Scene=Rn,t.Sprite=Cn,t.LOD=Pn,t.SkinnedMesh=On,t.Skeleton=Dn,t.Bone=Ln,t.Mesh=$i,t.LineSegments=Bn,t.LineLoop=zn,t.Line=In,t.Points=kn,t.Group=xn,t.VideoTexture=jn,t.DataTexture=We,t.CompressedTexture=Vn,t.CubeTexture=er,t.CanvasTexture=gn,t.DepthTexture=Fn,t.Texture=Ve,t.CompressedTextureLoader=ya,t.DataTextureLoader=Ea,t.CubeTextureLoader=_a,t.TextureLoader=wa,t.ObjectLoader=Ms,t.MaterialLoader=gs,t.BufferGeometryLoader=vs,t.DefaultLoadingManager=ma,t.LoadingManager=fa,t.JSONLoader=Ts,t.ImageLoader=xa,t.ImageBitmapLoader=Ds,t.FontLoader=Is,t.FileLoader=va,t.Loader=bs,t.LoaderUtils=Ss,t.Cache=da,t.AudioLoader=Zs,t.SpotLightShadow=qa,t.SpotLight=Ja,t.PointLight=Qa,t.RectAreaLight=es,t.HemisphereLight=Za,t.DirectionalLightShadow=Ka,t.DirectionalLight=$a,t.AmbientLight=ts,t.LightShadow=Ya,t.Light=Xa,t.StereoCamera=Ys,t.PerspectiveCamera=_n,t.OrthographicCamera=mi,t.CubeCamera=qs,t.ArrayCamera=wn,t.Camera=fi,t.AudioListener=Js,t.PositionalAudio=Ks,t.AudioContext=Xs,t.AudioAnalyser=$s,t.Audio=Qs,t.VectorKeyframeTrack=fs,t.StringKeyframeTrack=is,t.QuaternionKeyframeTrack=as,t.NumberKeyframeTrack=hs,t.ColorKeyframeTrack=ss,t.BooleanKeyframeTrack=rs,t.PropertyMixer=th,t.PropertyBinding=mh,t.KeyframeTrack=ds,t.AnimationUtils=ps,t.AnimationObjectGroup=gh,t.AnimationMixer=yh,t.AnimationClip=ms,t.Uniform=Eh,t.InstancedBufferGeometry=xh,t.BufferGeometry=Hi,t.Geometry=xi,t.InterleavedBufferAttribute=_h,t.InstancedInterleavedBuffer=bh,t.InterleavedBuffer=wh,t.InstancedBufferAttribute=Sh,t.Face3=gi,t.Object3D=di,t.Raycaster=Th,t.Layers=si,t.EventDispatcher=e,t.Clock=Ah,t.QuaternionLinearInterpolant=os,t.LinearInterpolant=cs,t.DiscreteInterpolant=us,t.CubicInterpolant=ls,t.Interpolant=ns,t.Triangle=Ki,t.Math=Ce,t.Spherical=Ch,t.Cylindrical=Ph,t.Plane=Ye,t.Frustum=qe,t.Sphere=Ze,t.Ray=Ji,t.Matrix4=De,t.Matrix3=He,t.Box3=Xe,t.Box2=Dh,t.Line3=Qi,t.Euler=ai,t.Vector4=Fe,t.Vector3=Oe,t.Vector2=Pe,t.Quaternion=Le,t.Color=ti,t.ImmediateRenderObject=Lh,t.VertexNormalsHelper=Oh,t.SpotLightHelper=Hh,t.SkeletonHelper=Ih,t.PointLightHelper=Bh,t.RectAreaLightHelper=zh,t.HemisphereLightHelper=Nh,t.GridHelper=kh,t.PolarGridHelper=jh,t.FaceNormalsHelper=Vh,t.DirectionalLightHelper=Fh,t.CameraHelper=Uh,t.BoxHelper=Gh,t.Box3Helper=Wh,t.PlaneHelper=Xh,t.ArrowHelper=Zh,t.AxesHelper=Yh,t.Shape=Wa,t.Path=Ga,t.ShapePath=Ls,t.Font=Os,t.CurvePath=Ua,t.Curve=ba,t.ShapeUtils=Do,t.WebGLUtils=En,t.WireframeGeometry=Un,t.ParametricGeometry=Gn,t.ParametricBufferGeometry=Wn,t.TetrahedronGeometry=Yn,t.TetrahedronBufferGeometry=qn,t.OctahedronGeometry=Jn,t.OctahedronBufferGeometry=Qn,t.IcosahedronGeometry=Kn,t.IcosahedronBufferGeometry=$n,t.DodecahedronGeometry=to,t.DodecahedronBufferGeometry=eo,t.PolyhedronGeometry=Xn,t.PolyhedronBufferGeometry=Zn,t.TubeGeometry=io,t.TubeBufferGeometry=ro,t.TorusKnotGeometry=no,t.TorusKnotBufferGeometry=oo,t.TorusGeometry=ao,t.TorusBufferGeometry=so,t.TextGeometry=No,t.TextBufferGeometry=ko,t.SphereGeometry=jo,t.SphereBufferGeometry=Vo,t.RingGeometry=Fo,t.RingBufferGeometry=Uo,t.PlaneGeometry=zi,t.PlaneBufferGeometry=Ni,t.LatheGeometry=Go,t.LatheBufferGeometry=Wo,t.ShapeGeometry=Xo,t.ShapeBufferGeometry=Zo,t.ExtrudeGeometry=Ho,t.ExtrudeBufferGeometry=Io,t.EdgesGeometry=qo,t.ConeGeometry=Ko,t.ConeBufferGeometry=$o,t.CylinderGeometry=Jo,t.CylinderBufferGeometry=Qo,t.CircleGeometry=ta,t.CircleBufferGeometry=ea,t.BoxGeometry=Ii,t.BoxBufferGeometry=Bi,t.ShadowMaterial=ra,t.SpriteMaterial=An,t.RawShaderMaterial=na,t.ShaderMaterial=qi,t.PointsMaterial=Nn,t.MeshPhysicalMaterial=aa,t.MeshStandardMaterial=oa,t.MeshPhongMaterial=sa,t.MeshToonMaterial=ha,t.MeshNormalMaterial=la,t.MeshLambertMaterial=ca,t.MeshDepthMaterial=dn,t.MeshDistanceMaterial=fn,t.MeshBasicMaterial=Yi,t.LineDashedMaterial=ua,t.LineBasicMaterial=Hn,t.Material=Zi,t.Float64BufferAttribute=Pi,t.Float32BufferAttribute=Ci,t.Uint32BufferAttribute=Ai,t.Int32BufferAttribute=Ri,t.Uint16BufferAttribute=Mi,t.Int16BufferAttribute=Ti,t.Uint8ClampedBufferAttribute=Si,t.Uint8BufferAttribute=bi,t.Int8BufferAttribute=wi,t.BufferAttribute=_i,t.ArcCurve=Ta,t.CatmullRomCurve3=Da,t.CubicBezierCurve=Ia,t.CubicBezierCurve3=Ba,t.EllipseCurve=Sa,t.LineCurve=za,t.LineCurve3=Na,t.QuadraticBezierCurve=ka,t.QuadraticBezierCurve3=ja,t.SplineCurve=Va,t.REVISION="94",t.MOUSE={LEFT:0,MIDDLE:1,RIGHT:2},t.CullFaceNone=d,t.CullFaceBack=f,t.CullFaceFront=m,t.CullFaceFrontBack=3,t.FrontFaceDirectionCW=0,t.FrontFaceDirectionCCW=1,t.BasicShadowMap=0,t.PCFShadowMap=g,t.PCFSoftShadowMap=v,t.FrontSide=y,t.BackSide=E,t.DoubleSide=x,t.FlatShading=1,t.SmoothShading=2,t.NoColors=_,t.FaceColors=w,t.VertexColors=b,t.NoBlending=S,t.NormalBlending=T,t.AdditiveBlending=M,t.SubtractiveBlending=R,t.MultiplyBlending=A,t.CustomBlending=C,t.AddEquation=P,t.SubtractEquation=D,t.ReverseSubtractEquation=L,t.MinEquation=O,t.MaxEquation=H,t.ZeroFactor=I,t.OneFactor=B,t.SrcColorFactor=z,t.OneMinusSrcColorFactor=N,t.SrcAlphaFactor=k,t.OneMinusSrcAlphaFactor=j,t.DstAlphaFactor=V,t.OneMinusDstAlphaFactor=F,t.DstColorFactor=U,t.OneMinusDstColorFactor=G,t.SrcAlphaSaturateFactor=W,t.NeverDepth=X,t.AlwaysDepth=Z,t.LessDepth=Y,t.LessEqualDepth=q,t.EqualDepth=J,t.GreaterEqualDepth=Q,t.GreaterDepth=K,t.NotEqualDepth=$,t.MultiplyOperation=tt,t.MixOperation=et,t.AddOperation=it,t.NoToneMapping=rt,t.LinearToneMapping=nt,t.ReinhardToneMapping=ot,t.Uncharted2ToneMapping=at,t.CineonToneMapping=st,t.UVMapping=300,t.CubeReflectionMapping=ht,t.CubeRefractionMapping=lt,t.EquirectangularReflectionMapping=ct,t.EquirectangularRefractionMapping=ut,t.SphericalReflectionMapping=pt,t.CubeUVReflectionMapping=dt,t.CubeUVRefractionMapping=ft,t.RepeatWrapping=mt,t.ClampToEdgeWrapping=gt,t.MirroredRepeatWrapping=vt,t.NearestFilter=yt,t.NearestMipMapNearestFilter=Et,t.NearestMipMapLinearFilter=xt,t.LinearFilter=_t,t.LinearMipMapNearestFilter=wt,t.LinearMipMapLinearFilter=bt,t.UnsignedByteType=St,t.ByteType=Tt,t.ShortType=Mt,t.UnsignedShortType=Rt,t.IntType=At,t.UnsignedIntType=Ct,t.FloatType=Pt,t.HalfFloatType=Dt,t.UnsignedShort4444Type=Lt,t.UnsignedShort5551Type=Ot,t.UnsignedShort565Type=Ht,t.UnsignedInt248Type=It,t.AlphaFormat=Bt,t.RGBFormat=zt,t.RGBAFormat=Nt,t.LuminanceFormat=kt,t.LuminanceAlphaFormat=jt,t.RGBEFormat=Vt,t.DepthFormat=Ft,t.DepthStencilFormat=Ut,t.RGB_S3TC_DXT1_Format=Gt,t.RGBA_S3TC_DXT1_Format=Wt,t.RGBA_S3TC_DXT3_Format=Xt,t.RGBA_S3TC_DXT5_Format=Zt,t.RGB_PVRTC_4BPPV1_Format=Yt,t.RGB_PVRTC_2BPPV1_Format=qt,t.RGBA_PVRTC_4BPPV1_Format=Jt,t.RGBA_PVRTC_2BPPV1_Format=Qt,t.RGB_ETC1_Format=Kt,t.RGBA_ASTC_4x4_Format=$t,t.RGBA_ASTC_5x4_Format=te,t.RGBA_ASTC_5x5_Format=ee,t.RGBA_ASTC_6x5_Format=ie,t.RGBA_ASTC_6x6_Format=re,t.RGBA_ASTC_8x5_Format=ne,t.RGBA_ASTC_8x6_Format=oe,t.RGBA_ASTC_8x8_Format=ae,t.RGBA_ASTC_10x5_Format=se,t.RGBA_ASTC_10x6_Format=he,t.RGBA_ASTC_10x8_Format=le,t.RGBA_ASTC_10x10_Format=ce,t.RGBA_ASTC_12x10_Format=ue,t.RGBA_ASTC_12x12_Format=pe,t.LoopOnce=2200,t.LoopRepeat=de,t.LoopPingPong=2202,t.InterpolateDiscrete=2300,t.InterpolateLinear=2301,t.InterpolateSmooth=2302,t.ZeroCurvatureEnding=fe,t.ZeroSlopeEnding=2401,t.WrapAroundEnding=2402,t.TrianglesDrawMode=me,t.TriangleStripDrawMode=ge,t.TriangleFanDrawMode=ve,t.LinearEncoding=ye,t.sRGBEncoding=Ee,t.GammaEncoding=xe,t.RGBEEncoding=_e,t.LogLuvEncoding=3003,t.RGBM7Encoding=we,t.RGBM16Encoding=be,t.RGBDEncoding=Se,t.BasicDepthPacking=Te,t.RGBADepthPacking=Me,t.TangentSpaceNormalMap=Re,t.ObjectSpaceNormalMap=Ae,t.CubeGeometry=Ii,t.Face4=function(t,e,i,r,n,o,a){return new gi(t,e,i,n,o,a)},t.LineStrip=0,t.LinePieces=1,t.MeshFaceMaterial=function(t){return t},t.MultiMaterial=function(t){return void 0===t&&(t=[]),t.isMultiMaterial=!0,t.materials=t,t.clone=function(){return t.slice()},t},t.PointCloud=function(t,e){return new kn(t,e)},t.Particle=function(t){return new Cn(t)},t.ParticleSystem=function(t,e){return new kn(t,e)},t.PointCloudMaterial=function(t){return new Nn(t)},t.ParticleBasicMaterial=function(t){return new Nn(t)},t.ParticleSystemMaterial=function(t){return new Nn(t)},t.Vertex=function(t,e,i){return new Oe(t,e,i)},t.DynamicBufferAttribute=function(t,e){return new _i(t,e).setDynamic(!0)},t.Int8Attribute=function(t,e){return new wi(t,e)},t.Uint8Attribute=function(t,e){return new bi(t,e)},t.Uint8ClampedAttribute=function(t,e){return new Si(t,e)},t.Int16Attribute=function(t,e){return new Ti(t,e)},t.Uint16Attribute=function(t,e){return new Mi(t,e)},t.Int32Attribute=function(t,e){return new Ri(t,e)},t.Uint32Attribute=function(t,e){return new Ai(t,e)},t.Float32Attribute=function(t,e){return new Ci(t,e)},t.Float64Attribute=function(t,e){return new Pi(t,e)},t.ClosedSplineCurve3=qh,t.SplineCurve3=Jh,t.Spline=Qh,t.AxisHelper=function(t){return new Yh(t)},t.BoundingBoxHelper=function(t,e){return new Gh(t,e)},t.EdgesHelper=function(t,e){return new Bn(new qo(t.geometry),new Hn({color:void 0!==e?e:16777215}))},t.WireframeHelper=function(t,e){return new Bn(new Un(t.geometry),new Hn({color:void 0!==e?e:16777215}))},t.XHRLoader=function(t){return new va(t)},t.BinaryTextureLoader=function(t){return new Ea(t)},t.GeometryUtils={merge:function(t,e,i){var r;e.isMesh&&(e.matrixAutoUpdate&&e.updateMatrix(),r=e.matrix,e=e.geometry),t.merge(e,r,i)},center:function(t){return t.center()}},t.ImageUtils=Kh,t.Projector=function(){this.projectVector=function(t,e){t.project(e)},this.unprojectVector=function(t,e){t.unproject(e)},this.pickingRay=function(){}},t.CanvasRenderer=function(){this.domElement=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),this.clear=function(){},this.render=function(){},this.setClearColor=function(){},this.setSize=function(){}},t.SceneUtils={createMultiMaterialObject:function(){},detach:function(){},attach:function(){}},t.LensFlare=function(){},Object.defineProperty(t,"__esModule",{value:!0})});var System={browser:function(){var t=navigator.userAgent;return/Arora/i.test(t)?"Arora":/Chrome/i.test(t)?"Chrome":/Epiphany/i.test(t)?"Epiphany":/Firefox/i.test(t)?"Firefox":/Mobile(\/.*)? Safari/i.test(t)?"Mobile Safari":/MSIE/i.test(t)?"Internet Explorer":/Midori/i.test(t)?"Midori":/Opera/.test(t)?"Opera":!!/Safari/i.test(t)&&"Safari"}(),os:function(){var t=navigator.userAgent;return/Android/i.test(t)?"Android":/CrOS/i.test(t)?"Chrome OS":/iP[ao]d|iPhone/i.test(t)?"iOS":/Linux/i.test(t)?"Linux":/Mac OS/i.test(t)?"Mac OS":!!/windows/i.test(t)&&"Windows"}(),support:{canvas:!!window.CanvasRenderingContext2D,localStorage:function(){try{return!!window.localStorage.getItem}catch(t){return!1}}(),file:!!(window.File&&window.FileReader&&window.FileList&&window.Blob),fileSystem:!!window.requestFileSystem||!!window.webkitRequestFileSystem,getUserMedia:!!(window.navigator.getUserMedia||window.navigator.webkitGetUserMedia||window.navigator.mozGetUserMedia||window.navigator.msGetUserMedia),requestAnimationFrame:!!(window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame),sessionStorage:function(){try{return!!window.sessionStorage.getItem}catch(t){return!1}}(),webgl:function(){try{return!!window.WebGLRenderingContext&&!!document.createElement("canvas").getContext("experimental-webgl")}catch(t){return!1}}(),worker:!!window.Worker}};THREE.TransformControls=function(t,e){THREE.Object3D.call(this),e=void 0!==e?e:document,this.visible=!1;var i=new THREE.TransformControlsGizmo;this.add(i);var r=new THREE.TransformControlsPlane;this.add(r);var n=this;k("camera",t),k("object",void 0),k("enabled",!0),k("axis",null),k("mode","translate"),k("translationSnap",null),k("rotationSnap",null),k("space","world"),k("size",1),k("dragging",!1),k("showX",!0),k("showY",!0),k("showZ",!0);var o={type:"change"},a={type:"mouseDown"},s={type:"mouseUp",mode:n.mode},h={type:"objectChange"},l=new THREE.Raycaster,c=new THREE.Vector3,u=new THREE.Vector3,p=new THREE.Quaternion,d={X:new THREE.Vector3(1,0,0),Y:new THREE.Vector3(0,1,0),Z:new THREE.Vector3(0,0,1)},f=new THREE.Vector3,m=new THREE.Vector3,g=new THREE.Vector3,v=new THREE.Vector3,y=new THREE.Vector3,E=new THREE.Vector3,x=0,_=new THREE.Vector3,w=new THREE.Quaternion,b=new THREE.Vector3,S=new THREE.Vector3,T=new THREE.Quaternion,M=new THREE.Quaternion,R=new THREE.Vector3,A=new THREE.Vector3,C=new THREE.Quaternion,P=new THREE.Vector3,D=new THREE.Vector3,L=new THREE.Quaternion,O=new THREE.Quaternion,H=new THREE.Vector3,I=new THREE.Vector3,B=new THREE.Vector3,z=new THREE.Quaternion,N=new THREE.Vector3;function k(t,e){var a=e;Object.defineProperty(n,t,{get:function(){return void 0!==a?a:e},set:function(e){a!==e&&(a=e,r[t]=e,i[t]=e,n.dispatchEvent({type:t+"-changed",value:e}),n.dispatchEvent(o))}}),n[t]=e,r[t]=e,i[t]=e}function j(t){var i=t.changedTouches?t.changedTouches[0]:t,r=e.getBoundingClientRect();return{x:(i.clientX-r.left)/r.width*2-1,y:-(i.clientY-r.top)/r.height*2+1,button:t.button}}function V(t){n.enabled&&n.pointerHover(j(t))}function F(t){n.enabled&&(document.addEventListener("mousemove",U,!1),n.pointerHover(j(t)),n.pointerDown(j(t)))}function U(t){n.enabled&&n.pointerMove(j(t))}function G(t){n.enabled&&(document.removeEventListener("mousemove",U,!1),n.pointerUp(j(t)))}k("worldPosition",D),k("worldPositionStart",A),k("worldQuaternion",L),k("worldQuaternionStart",C),k("cameraPosition",_),k("cameraQuaternion",w),k("pointStart",f),k("pointEnd",m),k("rotationAxis",v),k("rotationAngle",x),k("eye",I),e.addEventListener("mousedown",F,!1),e.addEventListener("touchstart",F,!1),e.addEventListener("mousemove",V,!1),e.addEventListener("touchmove",V,!1),e.addEventListener("touchmove",U,!1),document.addEventListener("mouseup",G,!1),e.addEventListener("touchend",G,!1),e.addEventListener("touchcancel",G,!1),e.addEventListener("touchleave",G,!1),this.dispose=function(){e.removeEventListener("mousedown",F),e.removeEventListener("touchstart",F),e.removeEventListener("mousemove",V),document.removeEventListener("mousemove",U),e.removeEventListener("touchmove",V),e.removeEventListener("touchmove",U),document.removeEventListener("mouseup",G),e.removeEventListener("touchend",G),e.removeEventListener("touchcancel",G),e.removeEventListener("touchleave",G),this.traverse(function(t){t.geometry&&t.geometry.dispose(),t.material&&t.material.dispose()})},this.attach=function(t){return this.object=t,this.visible=!0,this},this.detach=function(){return this.object=void 0,this.visible=!1,this.axis=null,this},this.updateMatrixWorld=function(){void 0!==this.object&&(this.object.updateMatrixWorld(),this.object.parent.matrixWorld.decompose(S,T,R),this.object.matrixWorld.decompose(D,L,H),M.copy(T).inverse(),O.copy(L).inverse()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(_,w,b),I.copy(_).sub(D).normalize(),THREE.Object3D.prototype.updateMatrixWorld.call(this)},this.pointerHover=function(t){if(void 0!==this.object&&!0!==this.dragging&&(void 0===t.button||0===t.button)){l.setFromCamera(t,this.camera);var e=l.intersectObjects(i.picker[this.mode].children,!0)[0]||!1;this.axis=e?e.object.name:null}},this.pointerDown=function(t){if(!(void 0===this.object||!0===this.dragging||void 0!==t.button&&0!==t.button||0!==t.button&&void 0!==t.button||null===this.axis)){l.setFromCamera(t,this.camera);var e=l.intersectObjects([r],!0)[0]||!1;if(e){var i=this.space;if("scale"===this.mode?i="local":"E"!==this.axis&&"XYZE"!==this.axis&&"XYZ"!==this.axis||(i="world"),"local"===i&&"rotate"===this.mode){var n=this.rotationSnap;"X"===this.axis&&n&&(this.object.rotation.x=Math.round(this.object.rotation.x/n)*n),"Y"===this.axis&&n&&(this.object.rotation.y=Math.round(this.object.rotation.y/n)*n),"Z"===this.axis&&n&&(this.object.rotation.z=Math.round(this.object.rotation.z/n)*n)}this.object.updateMatrixWorld(),this.object.parent.updateMatrixWorld(),B.copy(this.object.position),z.copy(this.object.quaternion),N.copy(this.object.scale),this.object.matrixWorld.decompose(A,C,P),f.copy(e.point).sub(A)}this.dragging=!0,a.mode=this.mode,this.dispatchEvent(a)}},this.pointerMove=function(t){var e=this.axis,i=this.mode,n=this.object,a=this.space;if("scale"===i?a="local":"E"!==e&&"XYZE"!==e&&"XYZ"!==e||(a="world"),void 0!==n&&null!==e&&!1!==this.dragging&&(void 0===t.button||0===t.button)){l.setFromCamera(t,this.camera);var s=l.intersectObjects([r],!0)[0]||!1;if(!1!==s){if(m.copy(s.point).sub(A),"translate"===i)g.copy(m).sub(f),"local"===a&&"XYZ"!==e&&g.applyQuaternion(O),-1===e.indexOf("X")&&(g.x=0),-1===e.indexOf("Y")&&(g.y=0),-1===e.indexOf("Z")&&(g.z=0),"local"===a&&"XYZ"!==e?g.applyQuaternion(z).divide(R):g.applyQuaternion(M).divide(R),n.position.copy(g).add(B),this.translationSnap&&("local"===a&&(n.position.applyQuaternion(p.copy(z).inverse()),-1!==e.search("X")&&(n.position.x=Math.round(n.position.x/this.translationSnap)*this.translationSnap),-1!==e.search("Y")&&(n.position.y=Math.round(n.position.y/this.translationSnap)*this.translationSnap),-1!==e.search("Z")&&(n.position.z=Math.round(n.position.z/this.translationSnap)*this.translationSnap),n.position.applyQuaternion(z)),"world"===a&&(n.parent&&n.position.add(c.setFromMatrixPosition(n.parent.matrixWorld)),-1!==e.search("X")&&(n.position.x=Math.round(n.position.x/this.translationSnap)*this.translationSnap),-1!==e.search("Y")&&(n.position.y=Math.round(n.position.y/this.translationSnap)*this.translationSnap),-1!==e.search("Z")&&(n.position.z=Math.round(n.position.z/this.translationSnap)*this.translationSnap),n.parent&&n.position.sub(c.setFromMatrixPosition(n.parent.matrixWorld))));else if("scale"===i){if(-1!==e.search("XYZ")){var _=m.length()/f.length();m.dot(f)<0&&(_*=-1),u.set(_,_,_)}else c.copy(f),u.copy(m),c.applyQuaternion(O),u.applyQuaternion(O),u.divide(c),-1===e.search("X")&&(u.x=1),-1===e.search("Y")&&(u.y=1),-1===e.search("Z")&&(u.z=1);n.scale.copy(N).multiply(u)}else if("rotate"===i){g.copy(m).sub(f);var w=20/D.distanceTo(c.setFromMatrixPosition(this.camera.matrixWorld));"E"===e?(v.copy(I),x=m.angleTo(f),y.copy(f).normalize(),E.copy(m).normalize(),x*=E.cross(y).dot(I)<0?1:-1):"XYZE"===e?(v.copy(g).cross(I).normalize(),x=g.dot(c.copy(v).cross(this.eye))*w):"X"!==e&&"Y"!==e&&"Z"!==e||(v.copy(d[e]),c.copy(d[e]),"local"===a&&c.applyQuaternion(L),x=g.dot(c.cross(I).normalize())*w),this.rotationSnap&&(x=Math.round(x/this.rotationSnap)*this.rotationSnap),this.rotationAngle=x,"local"===a&&"E"!==e&&"XYZE"!==e?(n.quaternion.copy(z),n.quaternion.multiply(p.setFromAxisAngle(v,x)).normalize()):(v.applyQuaternion(M),n.quaternion.copy(p.setFromAxisAngle(v,x)),n.quaternion.multiply(z).normalize())}this.dispatchEvent(o),this.dispatchEvent(h)}}},this.pointerUp=function(t){void 0!==t.button&&0!==t.button||(this.dragging&&null!==this.axis&&(s.mode=this.mode,this.dispatchEvent(s)),this.dragging=!1,void 0===t.button&&(this.axis=null))},this.getMode=function(){return n.mode},this.setMode=function(t){n.mode=t},this.setTranslationSnap=function(t){n.translationSnap=t},this.setRotationSnap=function(t){n.rotationSnap=t},this.setSize=function(t){n.size=t},this.setSpace=function(t){n.space=t},this.update=function(){}},THREE.TransformControls.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:THREE.TransformControls,isTransformControls:!0}),THREE.TransformControlsGizmo=function(){"use strict";THREE.Object3D.call(this),this.type="TransformControlsGizmo";var t=new THREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,side:THREE.DoubleSide,fog:!1}),e=new THREE.LineBasicMaterial({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1}),i=t.clone();i.opacity=.15;var r=t.clone();r.opacity=.33;var n=t.clone();n.color.set(16711680);var o=t.clone();o.color.set(65280);var a=t.clone();a.color.set(255);var s=t.clone();s.opacity=.25;var h=s.clone();h.color.set(16776960);var l=s.clone();l.color.set(65535);var c=s.clone();c.color.set(16711935),t.clone().color.set(16776960);var u=e.clone();u.color.set(16711680);var p=e.clone();p.color.set(65280);var d=e.clone();d.color.set(255);var f=e.clone();f.color.set(65535);var m=e.clone();m.color.set(16711935);var g=e.clone();g.color.set(16776960);var v=e.clone();v.color.set(7895160);var y=g.clone();y.opacity=.25;var E=new THREE.CylinderBufferGeometry(0,.05,.2,12,1,!1),x=new THREE.BoxBufferGeometry(.125,.125,.125),_=new THREE.BufferGeometry;_.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,0,0],3));var w,b=function(t,e){for(var i=new THREE.BufferGeometry,r=[],n=0;n<=64*e;++n)r.push(0,Math.cos(n/32*Math.PI)*t,Math.sin(n/32*Math.PI)*t);return i.addAttribute("position",new THREE.Float32BufferAttribute(r,3)),i},S={X:[[new THREE.Mesh(E,n),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new THREE.Mesh(E,n),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new THREE.Line(_,u)]],Y:[[new THREE.Mesh(E,o),[0,1,0],null,null,"fwd"],[new THREE.Mesh(E,o),[0,1,0],[Math.PI,0,0],null,"bwd"],[new THREE.Line(_,p),null,[0,0,Math.PI/2]]],Z:[[new THREE.Mesh(E,a),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new THREE.Mesh(E,a),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new THREE.Line(_,d),null,[0,-Math.PI/2,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.1,0),s.clone()),[0,0,0],[0,0,0]]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.295,.295),h.clone()),[.15,.15,0]],[new THREE.Line(_,g),[.18,.3,0],null,[.125,1,1]],[new THREE.Line(_,g),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.295,.295),l.clone()),[0,.15,.15],[0,Math.PI/2,0]],[new THREE.Line(_,f),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new THREE.Line(_,f),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.295,.295),c.clone()),[.15,0,.15],[-Math.PI/2,0,0]],[new THREE.Line(_,m),[.18,0,.3],null,[.125,1,1]],[new THREE.Line(_,m),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},T={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.2,0),i)]],XY:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),i),[.2,.2,0]]],YZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),i),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new THREE.Mesh(new THREE.PlaneBufferGeometry(.4,.4),i),[.2,0,.2],[-Math.PI/2,0,0]]]},M={START:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.01,2),r),null,null,null,"helper"]],END:[[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.01,2),r),null,null,null,"helper"]],DELTA:[[new THREE.Line((w=new THREE.BufferGeometry,w.addAttribute("position",new THREE.Float32BufferAttribute([0,0,0,1,1,1],3)),w),r),null,null,null,"helper"]],X:[[new THREE.Line(_,r.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new THREE.Line(_,r.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new THREE.Line(_,r.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},R={X:[[new THREE.Line(b(1,.5),u)],[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.04,0),n),[0,0,.99],null,[1,3,1]]],Y:[[new THREE.Line(b(1,.5),p),null,[0,0,-Math.PI/2]],[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.04,0),o),[0,0,.99],null,[3,1,1]]],Z:[[new THREE.Line(b(1,.5),d),null,[0,Math.PI/2,0]],[new THREE.Mesh(new THREE.OctahedronBufferGeometry(.04,0),a),[.99,0,0],null,[1,3,1]]],E:[[new THREE.Line(b(1.25,1),y),null,[0,Math.PI/2,0]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(.03,0,.15,4,1,!1),y),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(.03,0,.15,4,1,!1),y),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(.03,0,.15,4,1,!1),y),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new THREE.Mesh(new THREE.CylinderBufferGeometry(.03,0,.15,4,1,!1),y),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new THREE.Line(b(1,1),v),null,[0,Math.PI/2,0]]]},A={AXIS:[[new THREE.Line(_,r.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},C={X:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new THREE.Mesh(new THREE.TorusBufferGeometry(1.25,.1,2,24),i)]],XYZE:[[new THREE.Mesh(new THREE.SphereBufferGeometry(.7,10,8),i)]]},P={X:[[new THREE.Mesh(x,n),[.8,0,0],[0,0,-Math.PI/2]],[new THREE.Line(_,u),null,null,[.8,1,1]]],Y:[[new THREE.Mesh(x,o),[0,.8,0]],[new THREE.Line(_,p),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new THREE.Mesh(x,a),[0,0,.8],[Math.PI/2,0,0]],[new THREE.Line(_,d),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new THREE.Mesh(x,h),[.85,.85,0],null,[2,2,.2]],[new THREE.Line(_,g),[.855,.98,0],null,[.125,1,1]],[new THREE.Line(_,g),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new THREE.Mesh(x,l),[0,.85,.85],null,[.2,2,2]],[new THREE.Line(_,f),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new THREE.Line(_,f),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new THREE.Mesh(x,c),[.85,0,.85],null,[2,.2,2]],[new THREE.Line(_,m),[.855,0,.98],null,[.125,1,1]],[new THREE.Line(_,m),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),s.clone()),[1.1,0,0]]],XYZY:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),s.clone()),[0,1.1,0]]],XYZZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.125,.125,.125),s.clone()),[0,0,1.1]]]},D={X:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,.8,4,1,!1),i),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,.8,4,1,!1),i),[0,.5,0]]],Z:[[new THREE.Mesh(new THREE.CylinderBufferGeometry(.2,0,.8,4,1,!1),i),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new THREE.Mesh(x,i),[.85,.85,0],null,[3,3,.2]]],YZ:[[new THREE.Mesh(x,i),[0,.85,.85],null,[.2,3,3]]],XZ:[[new THREE.Mesh(x,i),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.2,.2,.2),i),[1.1,0,0]]],XYZY:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.2,.2,.2),i),[0,1.1,0]]],XYZZ:[[new THREE.Mesh(new THREE.BoxBufferGeometry(.2,.2,.2),i),[0,0,1.1]]]},L={X:[[new THREE.Line(_,r.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new THREE.Line(_,r.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new THREE.Line(_,r.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},O=function(t){var e=new THREE.Object3D;for(var i in t)for(var r=t[i].length;r--;){var n=t[i][r][0].clone(),o=t[i][r][1],a=t[i][r][2],s=t[i][r][3],h=t[i][r][4];n.name=i,n.tag=h,o&&n.position.set(o[0],o[1],o[2]),a&&n.rotation.set(a[0],a[1],a[2]),s&&n.scale.set(s[0],s[1],s[2]),n.updateMatrix();var l=n.geometry.clone();l.applyMatrix(n.matrix),n.geometry=l,n.renderOrder=1/0,n.position.set(0,0,0),n.rotation.set(0,0,0),n.scale.set(1,1,1),e.add(n)}return e},H=new THREE.Vector3(0,0,0),I=new THREE.Euler,B=new THREE.Vector3(0,1,0),z=new THREE.Vector3(0,0,0),N=new THREE.Matrix4,k=new THREE.Quaternion,j=new THREE.Quaternion,V=new THREE.Quaternion,F=new THREE.Vector3(1,0,0),U=new THREE.Vector3(0,1,0),G=new THREE.Vector3(0,0,1);this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=O(S)),this.add(this.gizmo.rotate=O(R)),this.add(this.gizmo.scale=O(P)),this.add(this.picker.translate=O(T)),this.add(this.picker.rotate=O(C)),this.add(this.picker.scale=O(D)),this.add(this.helper.translate=O(M)),this.add(this.helper.rotate=O(A)),this.add(this.helper.scale=O(L)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1,this.updateMatrixWorld=function(){var t=this.space;"scale"===this.mode&&(t="local");var e="local"===t?this.worldQuaternion:V;this.gizmo.translate.visible="translate"===this.mode,this.gizmo.rotate.visible="rotate"===this.mode,this.gizmo.scale.visible="scale"===this.mode,this.helper.translate.visible="translate"===this.mode,this.helper.rotate.visible="rotate"===this.mode,this.helper.scale.visible="scale"===this.mode;var i=[];i=(i=(i=i.concat(this.picker[this.mode].children)).concat(this.gizmo[this.mode].children)).concat(this.helper[this.mode].children);for(var r=0;r<i.length;r++){var n=i[r];n.visible=!0,n.rotation.set(0,0,0),n.position.copy(this.worldPosition);var o=this.worldPosition.distanceTo(this.cameraPosition);if(n.scale.set(1,1,1).multiplyScalar(o*this.size/7),"helper"!==n.tag){if(n.quaternion.copy(e),"translate"===this.mode||"scale"===this.mode){"X"!==n.name&&"XYZX"!==n.name||Math.abs(B.copy(F).applyQuaternion(e).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"Y"!==n.name&&"XYZY"!==n.name||Math.abs(B.copy(U).applyQuaternion(e).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"Z"!==n.name&&"XYZZ"!==n.name||Math.abs(B.copy(G).applyQuaternion(e).dot(this.eye))>.99&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"XY"===n.name&&Math.abs(B.copy(G).applyQuaternion(e).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"YZ"===n.name&&Math.abs(B.copy(F).applyQuaternion(e).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),"XZ"===n.name&&Math.abs(B.copy(U).applyQuaternion(e).dot(this.eye))<.2&&(n.scale.set(1e-10,1e-10,1e-10),n.visible=!1),-1!==n.name.search("X")&&(B.copy(F).applyQuaternion(e).dot(this.eye)<0?"fwd"===n.tag?n.visible=!1:n.scale.x*=-1:"bwd"===n.tag&&(n.visible=!1)),-1!==n.name.search("Y")&&(B.copy(U).applyQuaternion(e).dot(this.eye)<0?"fwd"===n.tag?n.visible=!1:n.scale.y*=-1:"bwd"===n.tag&&(n.visible=!1)),-1!==n.name.search("Z")&&(B.copy(G).applyQuaternion(e).dot(this.eye)<0?"fwd"===n.tag?n.visible=!1:n.scale.z*=-1:"bwd"===n.tag&&(n.visible=!1))}else"rotate"===this.mode&&(j.copy(e),B.copy(this.eye).applyQuaternion(k.copy(e).inverse()),-1!==n.name.search("E")&&n.quaternion.setFromRotationMatrix(N.lookAt(this.eye,z,U)),"X"===n.name&&(k.setFromAxisAngle(F,Math.atan2(-B.y,B.z)),k.multiplyQuaternions(j,k),n.quaternion.copy(k)),"Y"===n.name&&(k.setFromAxisAngle(U,Math.atan2(B.x,B.z)),k.multiplyQuaternions(j,k),n.quaternion.copy(k)),"Z"===n.name&&(k.setFromAxisAngle(G,Math.atan2(B.y,B.x)),k.multiplyQuaternions(j,k),n.quaternion.copy(k)));n.visible=n.visible&&(-1===n.name.indexOf("X")||this.showX),n.visible=n.visible&&(-1===n.name.indexOf("Y")||this.showY),n.visible=n.visible&&(-1===n.name.indexOf("Z")||this.showZ),n.visible=n.visible&&(-1===n.name.indexOf("E")||this.showX&&this.showY&&this.showZ),n.material._opacity=n.material._opacity||n.material.opacity,n.material._color=n.material._color||n.material.color.clone(),n.material.color.copy(n.material._color),n.material.opacity=n.material._opacity,this.enabled?this.axis&&(n.name===this.axis?(n.material.opacity=1,n.material.color.lerp(new THREE.Color(1,1,1),.5)):this.axis.split("").some(function(t){return n.name===t})?(n.material.opacity=1,n.material.color.lerp(new THREE.Color(1,1,1),.5)):(n.material.opacity*=.25,n.material.color.lerp(new THREE.Color(1,1,1),.5))):(n.material.opacity*=.5,n.material.color.lerp(new THREE.Color(1,1,1),.5))}else n.visible=!1,"AXIS"===n.name?(n.position.copy(this.worldPositionStart),n.visible=!!this.axis,"X"===this.axis&&(k.setFromEuler(I.set(0,0,0)),n.quaternion.copy(e).multiply(k),Math.abs(B.copy(F).applyQuaternion(e).dot(this.eye))>.9&&(n.visible=!1)),"Y"===this.axis&&(k.setFromEuler(I.set(0,0,Math.PI/2)),n.quaternion.copy(e).multiply(k),Math.abs(B.copy(U).applyQuaternion(e).dot(this.eye))>.9&&(n.visible=!1)),"Z"===this.axis&&(k.setFromEuler(I.set(0,Math.PI/2,0)),n.quaternion.copy(e).multiply(k),Math.abs(B.copy(G).applyQuaternion(e).dot(this.eye))>.9&&(n.visible=!1)),"XYZE"===this.axis&&(k.setFromEuler(I.set(0,Math.PI/2,0)),B.copy(this.rotationAxis),n.quaternion.setFromRotationMatrix(N.lookAt(z,B,U)),n.quaternion.multiply(k),n.visible=this.dragging),"E"===this.axis&&(n.visible=!1)):"START"===n.name?(n.position.copy(this.worldPositionStart),n.visible=this.dragging):"END"===n.name?(n.position.copy(this.worldPosition),n.visible=this.dragging):"DELTA"===n.name?(n.position.copy(this.worldPositionStart),n.quaternion.copy(this.worldQuaternionStart),H.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),H.applyQuaternion(this.worldQuaternionStart.clone().inverse()),n.scale.copy(H),n.visible=this.dragging):(n.quaternion.copy(e),this.dragging?n.position.copy(this.worldPositionStart):n.position.copy(this.worldPosition),this.axis&&(n.visible=-1!==this.axis.search(n.name)))}THREE.Object3D.prototype.updateMatrixWorld.call(this)}},THREE.TransformControlsGizmo.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:THREE.TransformControlsGizmo,isTransformControlsGizmo:!0}),THREE.TransformControlsPlane=function(){"use strict";THREE.Mesh.call(this,new THREE.PlaneBufferGeometry(1e5,1e5,2,2),new THREE.MeshBasicMaterial({visible:!1,wireframe:!0,side:THREE.DoubleSide,transparent:!0,opacity:.1})),this.type="TransformControlsPlane";var t=new THREE.Vector3(1,0,0),e=new THREE.Vector3(0,1,0),i=new THREE.Vector3(0,0,1),r=new THREE.Vector3,n=new THREE.Vector3,o=new THREE.Vector3,a=new THREE.Matrix4,s=new THREE.Quaternion;this.updateMatrixWorld=function(){var h=this.space;switch(this.position.copy(this.worldPosition),"scale"===this.mode&&(h="local"),t.set(1,0,0).applyQuaternion("local"===h?this.worldQuaternion:s),e.set(0,1,0).applyQuaternion("local"===h?this.worldQuaternion:s),i.set(0,0,1).applyQuaternion("local"===h?this.worldQuaternion:s),o.copy(e),this.mode){case"translate":case"scale":switch(this.axis){case"X":o.copy(this.eye).cross(t),n.copy(t).cross(o);break;case"Y":o.copy(this.eye).cross(e),n.copy(e).cross(o);break;case"Z":o.copy(this.eye).cross(i),n.copy(i).cross(o);break;case"XY":n.copy(i);break;case"YZ":n.copy(t);break;case"XZ":o.copy(i),n.copy(e);break;case"XYZ":case"E":n.set(0,0,0)}break;case"rotate":default:n.set(0,0,0)}0===n.length()?this.quaternion.copy(this.cameraQuaternion):(a.lookAt(r.set(0,0,0),n,o),this.quaternion.setFromRotationMatrix(a)),THREE.Object3D.prototype.updateMatrixWorld.call(this)}},THREE.TransformControlsPlane.prototype=Object.assign(Object.create(THREE.Mesh.prototype),{constructor:THREE.TransformControlsPlane,isTransformControlsPlane:!0}),THREE.CopyShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},THREE.LuminosityHighPassShader={shaderID:"luminosityHighPass",uniforms:{tDiffuse:{type:"t",value:null},luminosityThreshold:{type:"f",value:1},smoothWidth:{type:"f",value:1},defaultColor:{type:"c",value:new THREE.Color(0)},defaultOpacity:{type:"f",value:0}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec3 defaultColor;","uniform float defaultOpacity;","uniform float luminosityThreshold;","uniform float smoothWidth;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float v = dot( texel.xyz, luma );","vec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );","float alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );","gl_FragColor = mix( outputColor, texel, alpha );","}"].join("\n")},THREE.FXAAShader={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform vec2 resolution;","#define FXAA_REDUCE_MIN   (1.0/128.0)","#define FXAA_REDUCE_MUL   (1.0/8.0)","#define FXAA_SPAN_MAX     8.0","void main() {","vec3 rgbNW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbNE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, -1.0 ) ) * resolution ).xyz;","vec3 rgbSW = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( -1.0, 1.0 ) ) * resolution ).xyz;","vec3 rgbSE = texture2D( tDiffuse, ( gl_FragCoord.xy + vec2( 1.0, 1.0 ) ) * resolution ).xyz;","vec4 rgbaM  = texture2D( tDiffuse,  gl_FragCoord.xy  * resolution );","vec3 rgbM  = rgbaM.xyz;","vec3 luma = vec3( 0.299, 0.587, 0.114 );","float lumaNW = dot( rgbNW, luma );","float lumaNE = dot( rgbNE, luma );","float lumaSW = dot( rgbSW, luma );","float lumaSE = dot( rgbSE, luma );","float lumaM  = dot( rgbM,  luma );","float lumaMin = min( lumaM, min( min( lumaNW, lumaNE ), min( lumaSW, lumaSE ) ) );","float lumaMax = max( lumaM, max( max( lumaNW, lumaNE) , max( lumaSW, lumaSE ) ) );","vec2 dir;","dir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));","dir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));","float dirReduce = max( ( lumaNW + lumaNE + lumaSW + lumaSE ) * ( 0.25 * FXAA_REDUCE_MUL ), FXAA_REDUCE_MIN );","float rcpDirMin = 1.0 / ( min( abs( dir.x ), abs( dir.y ) ) + dirReduce );","dir = min( vec2( FXAA_SPAN_MAX,  FXAA_SPAN_MAX),","max( vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX),","dir * rcpDirMin)) * resolution;","vec4 rgbA = (1.0/2.0) * (","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (1.0/3.0 - 0.5)) +","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (2.0/3.0 - 0.5)));","vec4 rgbB = rgbA * (1.0/2.0) + (1.0/4.0) * (","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (0.0/3.0 - 0.5)) +","texture2D(tDiffuse,  gl_FragCoord.xy  * resolution + dir * (3.0/3.0 - 0.5)));","float lumaB = dot(rgbB, vec4(luma, 0.0));","if ( ( lumaB < lumaMin ) || ( lumaB > lumaMax ) ) {","gl_FragColor = rgbA;","} else {","gl_FragColor = rgbB;","}","}"].join("\n")},THREE.AdditiveBlendShader={uniforms:{tDiffuse1:{type:"t",value:null},tDiffuse2:{type:"t",value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse1;","uniform sampler2D tDiffuse2;","varying vec2 vUv;","void main() {","vec4 texel1 = texture2D( tDiffuse1, vUv );","vec4 texel2 = texture2D( tDiffuse2, vUv );","gl_FragColor = texel1 + texel2;","}"].join("\n")},THREE.RenderableObject=function(){this.id=0,this.object=null,this.z=0,this.renderOrder=0},THREE.RenderableFace=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.v3=new THREE.RenderableVertex,this.normalModel=new THREE.Vector3,this.vertexNormalsModel=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],this.vertexNormalsLength=0,this.color=new THREE.Color,this.material=null,this.uvs=[new THREE.Vector2,new THREE.Vector2,new THREE.Vector2],this.z=0,this.renderOrder=0},THREE.RenderableVertex=function(){this.position=new THREE.Vector3,this.positionWorld=new THREE.Vector3,this.positionScreen=new THREE.Vector4,this.visible=!0},THREE.RenderableVertex.prototype.copy=function(t){this.positionWorld.copy(t.positionWorld),this.positionScreen.copy(t.positionScreen)},THREE.RenderableLine=function(){this.id=0,this.v1=new THREE.RenderableVertex,this.v2=new THREE.RenderableVertex,this.vertexColors=[new THREE.Color,new THREE.Color],this.material=null,this.z=0,this.renderOrder=0},THREE.RenderableSprite=function(){this.id=0,this.object=null,this.x=0,this.y=0,this.z=0,this.rotation=0,this.scale=new THREE.Vector2,this.material=null,this.renderOrder=0},THREE.Projector=function(){var t,e,i,r,n,o,a,s,h,l,c,u=[],p=0,d=[],f=0,m=[],g=0,v=[],y=0,E=[],x=0,_={objects:[],lights:[],elements:[]},w=new THREE.Vector3,b=new THREE.Vector4,S=new THREE.Box3(new THREE.Vector3(-1,-1,-1),new THREE.Vector3(1,1,1)),T=new THREE.Box3,M=new Array(3),R=new THREE.Matrix4,A=new THREE.Matrix4,C=new THREE.Matrix4,P=new THREE.Matrix3,D=new THREE.Frustum,L=new THREE.Vector4,O=new THREE.Vector4;this.projectVector=function(t,e){t.project(e)},this.unprojectVector=function(t,e){t.unproject(e)},this.pickingRay=function(){};var H=new function(){var t=[],e=[],r=[],o=null,s=null,h=new THREE.Matrix3;function l(t){var e=t.position,i=t.positionWorld,r=t.positionScreen;i.copy(e).applyMatrix4(c),r.copy(i).applyMatrix4(A);var n=1/r.w;r.x*=n,r.y*=n,r.z*=n,t.visible=r.x>=-1&&r.x<=1&&r.y>=-1&&r.y<=1&&r.z>=-1&&r.z<=1}function u(t,e,i){return!0===t.visible||!0===e.visible||!0===i.visible||(M[0]=t.positionScreen,M[1]=e.positionScreen,M[2]=i.positionScreen,S.intersectsBox(T.setFromPoints(M)))}function p(t,e,i){return(i.positionScreen.x-t.positionScreen.x)*(e.positionScreen.y-t.positionScreen.y)-(i.positionScreen.y-t.positionScreen.y)*(e.positionScreen.x-t.positionScreen.x)<0}return{setObject:function(i){s=(o=i).material,h.getNormalMatrix(o.matrixWorld),t.length=0,e.length=0,r.length=0},projectVertex:l,checkTriangleVisibility:u,checkBackfaceCulling:p,pushVertex:function(t,e,r){(i=z()).position.set(t,e,r),l(i)},pushNormal:function(e,i,r){t.push(e,i,r)},pushColor:function(t,i,r){e.push(t,i,r)},pushUv:function(t,e){r.push(t,e)},pushLine:function(t,i){var r=d[t],n=d[i];r.positionScreen.copy(r.position).applyMatrix4(C),n.positionScreen.copy(n.position).applyMatrix4(C),!0===V(r.positionScreen,n.positionScreen)&&(r.positionScreen.multiplyScalar(1/r.positionScreen.w),n.positionScreen.multiplyScalar(1/n.positionScreen.w),(a=k()).id=o.id,a.v1.copy(r),a.v2.copy(n),a.z=Math.max(r.positionScreen.z,n.positionScreen.z),a.renderOrder=o.renderOrder,a.material=o.material,o.material.vertexColors===THREE.VertexColors&&(a.vertexColors[0].fromArray(e,3*t),a.vertexColors[1].fromArray(e,3*i)),_.elements.push(a))},pushTriangle:function(e,i,a){var l=d[e],c=d[i],f=d[a];if(!1!==u(l,c,f)&&(s.side===THREE.DoubleSide||!0===p(l,c,f))){(n=N()).id=o.id,n.v1.copy(l),n.v2.copy(c),n.v3.copy(f),n.z=(l.positionScreen.z+c.positionScreen.z+f.positionScreen.z)/3,n.renderOrder=o.renderOrder,n.normalModel.fromArray(t,3*e),n.normalModel.applyMatrix3(h).normalize();for(var m=0;m<3;m++){var g=n.vertexNormalsModel[m];g.fromArray(t,3*arguments[m]),g.applyMatrix3(h).normalize(),n.uvs[m].fromArray(r,2*arguments[m])}n.vertexNormalsLength=3,n.material=o.material,_.elements.push(n)}}}};function I(i){(t=function(){if(e===p){var t=new THREE.RenderableObject;return u.push(t),p++,e++,t}return u[e++]}()).id=i.id,t.object=i,w.setFromMatrixPosition(i.matrixWorld),w.applyMatrix4(A),t.z=w.z,t.renderOrder=i.renderOrder,_.objects.push(t)}function B(t,e,i){var r=1/t.w;t.z*=r,t.z>=-1&&t.z<=1&&((h=function(){if(l===x){var t=new THREE.RenderableSprite;return E.push(t),x++,l++,t}return E[l++]}()).id=e.id,h.x=t.x*r,h.y=t.y*r,h.z=t.z,h.renderOrder=e.renderOrder,h.object=e,h.rotation=e.rotation,h.scale.x=e.scale.x*Math.abs(h.x-(t.x+i.projectionMatrix.elements[0])/(t.w+i.projectionMatrix.elements[12])),h.scale.y=e.scale.y*Math.abs(h.y-(t.y+i.projectionMatrix.elements[5])/(t.w+i.projectionMatrix.elements[13])),h.material=e.material,_.elements.push(h))}function z(){if(r===f){var t=new THREE.RenderableVertex;return d.push(t),f++,r++,t}return d[r++]}function N(){if(o===g){var t=new THREE.RenderableFace;return m.push(t),g++,o++,t}return m[o++]}function k(){if(s===y){var t=new THREE.RenderableLine;return v.push(t),y++,s++,t}return v[s++]}function j(t,e){return t.renderOrder!==e.renderOrder?t.renderOrder-e.renderOrder:t.z!==e.z?e.z-t.z:t.id!==e.id?t.id-e.id:0}function V(t,e){var i=0,r=1,n=t.z+t.w,o=e.z+e.w,a=-t.z+t.w,s=-e.z+e.w;return n>=0&&o>=0&&a>=0&&s>=0||!(n<0&&o<0||a<0&&s<0)&&(n<0?i=Math.max(i,n/(n-o)):o<0&&(r=Math.min(r,n/(n-o))),a<0?i=Math.max(i,a/(a-s)):s<0&&(r=Math.min(r,a/(a-s))),!(r<i)&&(t.lerp(e,i),e.lerp(t,1-r),!0))}this.projectScene=function(t,i,h,u){o=0,s=0,l=0,_.elements.length=0,!0===t.autoUpdate&&t.updateMatrixWorld(),null===i.parent&&i.updateMatrixWorld(),R.copy(i.matrixWorldInverse),A.multiplyMatrices(i.projectionMatrix,R),D.setFromMatrix(A),e=0,_.objects.length=0,_.lights.length=0,function t(e){if(!1!==e.visible){if(e instanceof THREE.Light)_.lights.push(e);else if(e instanceof THREE.Mesh||e instanceof THREE.Line||e instanceof THREE.Points){if(!1===e.material.visible)return;if(!0===e.frustumCulled&&!1===D.intersectsObject(e))return;I(e)}else if(e instanceof THREE.Sprite){if(!1===e.material.visible)return;if(!0===e.frustumCulled&&!1===D.intersectsSprite(e))return;I(e)}for(var i=e.children,r=0,n=i.length;r<n;r++)t(i[r])}}(t),!0===h&&_.objects.sort(j);for(var p=_.objects,f=0,m=p.length;f<m;f++){var g=p[f].object,v=g.geometry;if(H.setObject(g),c=g.matrixWorld,r=0,g instanceof THREE.Mesh){if(v instanceof THREE.BufferGeometry){var y=v.attributes,E=v.groups;if(void 0===y.position)continue;for(var x=0,S=(_t=y.position.array).length;x<S;x+=3)H.pushVertex(_t[x],_t[x+1],_t[x+2]);if(void 0!==y.normal){var T=y.normal.array;for(x=0,S=T.length;x<S;x+=3)H.pushNormal(T[x],T[x+1],T[x+2])}if(void 0!==y.uv){var M=y.uv.array;for(x=0,S=M.length;x<S;x+=2)H.pushUv(M[x],M[x+1])}if(null!==v.index){var F=v.index.array;if(E.length>0)for(var U=0;U<E.length;U++){var G=E[U];for(x=G.start,S=G.start+G.count;x<S;x+=3)H.pushTriangle(F[x],F[x+1],F[x+2])}else for(x=0,S=F.length;x<S;x+=3)H.pushTriangle(F[x],F[x+1],F[x+2])}else for(x=0,S=_t.length/3;x<S;x+=3)H.pushTriangle(x,x+1,x+2)}else if(v instanceof THREE.Geometry){var W=v.vertices,X=v.faces,Z=v.faceVertexUvs[0];P.getNormalMatrix(c);for(var Y=g.material,q=Array.isArray(Y),J=0,Q=W.length;J<Q;J++){var K=W[J];if(w.copy(K),!0===Y.morphTargets)for(var $=v.morphTargets,tt=g.morphTargetInfluences,et=0,it=$.length;et<it;et++){var rt=tt[et];if(0!==rt){var nt=$[et].vertices[J];w.x+=(nt.x-K.x)*rt,w.y+=(nt.y-K.y)*rt,w.z+=(nt.z-K.z)*rt}}H.pushVertex(w.x,w.y,w.z)}for(var ot=0,at=X.length;ot<at;ot++){var st=X[ot];if(void 0!==(Y=!0===q?g.material[st.materialIndex]:g.material)){var ht=Y.side,lt=d[st.a],ct=d[st.b],ut=d[st.c];if(!1!==H.checkTriangleVisibility(lt,ct,ut)){var pt=H.checkBackfaceCulling(lt,ct,ut);if(ht!==THREE.DoubleSide){if(ht===THREE.FrontSide&&!1===pt)continue;if(ht===THREE.BackSide&&!0===pt)continue}(n=N()).id=g.id,n.v1.copy(lt),n.v2.copy(ct),n.v3.copy(ut),n.normalModel.copy(st.normal),!1!==pt||ht!==THREE.BackSide&&ht!==THREE.DoubleSide||n.normalModel.negate(),n.normalModel.applyMatrix3(P).normalize();for(var dt=st.vertexNormals,ft=0,mt=Math.min(dt.length,3);ft<mt;ft++){var gt=n.vertexNormalsModel[ft];gt.copy(dt[ft]),!1!==pt||ht!==THREE.BackSide&&ht!==THREE.DoubleSide||gt.negate(),gt.applyMatrix3(P).normalize()}n.vertexNormalsLength=dt.length;var vt=Z[ot];if(void 0!==vt)for(var yt=0;yt<3;yt++)n.uvs[yt].copy(vt[yt]);n.color=st.color,n.material=Y,n.z=(lt.positionScreen.z+ct.positionScreen.z+ut.positionScreen.z)/3,n.renderOrder=g.renderOrder,_.elements.push(n)}}}}}else if(g instanceof THREE.Line){if(C.multiplyMatrices(A,c),v instanceof THREE.BufferGeometry){if(void 0!==(y=v.attributes).position){for(x=0,S=(_t=y.position.array).length;x<S;x+=3)H.pushVertex(_t[x],_t[x+1],_t[x+2]);if(void 0!==y.color){var Et=y.color.array;for(x=0,S=Et.length;x<S;x+=3)H.pushColor(Et[x],Et[x+1],Et[x+2])}if(null!==v.index)for(x=0,S=(F=v.index.array).length;x<S;x+=2)H.pushLine(F[x],F[x+1]);else{var xt=g instanceof THREE.LineSegments?2:1;for(x=0,S=_t.length/3-1;x<S;x+=xt)H.pushLine(x,x+1)}}}else if(v instanceof THREE.Geometry){if(0===(W=g.geometry.vertices).length)continue;(lt=z()).positionScreen.copy(W[0]).applyMatrix4(C);for(xt=g instanceof THREE.LineSegments?2:1,J=1,Q=W.length;J<Q;J++)(lt=z()).positionScreen.copy(W[J]).applyMatrix4(C),(J+1)%xt>0||(ct=d[r-2],L.copy(lt.positionScreen),O.copy(ct.positionScreen),!0===V(L,O)&&(L.multiplyScalar(1/L.w),O.multiplyScalar(1/O.w),(a=k()).id=g.id,a.v1.positionScreen.copy(L),a.v2.positionScreen.copy(O),a.z=Math.max(L.z,O.z),a.renderOrder=g.renderOrder,a.material=g.material,g.material.vertexColors===THREE.VertexColors&&(a.vertexColors[0].copy(g.geometry.colors[J]),a.vertexColors[1].copy(g.geometry.colors[J-1])),_.elements.push(a)))}}else if(g instanceof THREE.Points){if(C.multiplyMatrices(A,c),v instanceof THREE.Geometry)for(J=0,Q=(W=g.geometry.vertices).length;J<Q;J++){K=W[J];b.set(K.x,K.y,K.z,1),b.applyMatrix4(C),B(b,g,i)}else if(v instanceof THREE.BufferGeometry){if(void 0!==(y=v.attributes).position){var _t;for(x=0,S=(_t=y.position.array).length;x<S;x+=3)b.set(_t[x],_t[x+1],_t[x+2],1),b.applyMatrix4(C),B(b,g,i)}}}else g instanceof THREE.Sprite&&(b.set(c.elements[12],c.elements[13],c.elements[14],1),b.applyMatrix4(A),B(b,g,i))}return!0===u&&_.elements.sort(j),_}},THREE.SpriteCanvasMaterial=function(t){THREE.Material.call(this),this.type="SpriteCanvasMaterial",this.color=new THREE.Color(16777215),this.program=function(){},this.setValues(t)},THREE.SpriteCanvasMaterial.prototype=Object.create(THREE.Material.prototype),THREE.SpriteCanvasMaterial.prototype.constructor=THREE.SpriteCanvasMaterial,THREE.SpriteCanvasMaterial.prototype.isSpriteCanvasMaterial=!0,THREE.SpriteCanvasMaterial.prototype.clone=function(){var t=new THREE.SpriteCanvasMaterial;return t.copy(this),t.color.copy(this.color),t.program=this.program,t},THREE.CanvasRenderer=function(t){t=t||{};var e,i,r,n,o,a,s,h,l,c,u,p,d,f,m,g,v,y,E,x=this,_=new THREE.Projector,w=void 0!==t.canvas?t.canvas:document.createElement("canvas"),b=w.width,S=w.height,T=Math.floor(b/2),M=Math.floor(S/2),R=0,A=0,C=b,P=S,D=1,L=w.getContext("2d",{alpha:!0===t.alpha}),O=new THREE.Color(0),H=!0===t.alpha?0:1,I=1,B=0,z=null,N=null,k=null,j=null,V=null,F=[],U=new THREE.Color,G=new THREE.Color,W=new THREE.Color,X=new THREE.Color,Z={},Y=new THREE.Box2,q=new THREE.Box2,J=new THREE.Box2,Q=new THREE.Color,K=new THREE.Color,$=new THREE.Color,tt=new THREE.Vector3,et=new THREE.Vector3,it=new THREE.Vector3,rt=new THREE.Matrix3;function nt(t,e,i){pt(i.opacity),dt(i.blending);var r=e.scale.x*T,n=e.scale.y*M,o=Math.sqrt(r*r+n*n);if(J.min.set(t.x-o,t.y-o),J.max.set(t.x+o,t.y+o),i.isSpriteMaterial){var a=i.map;if(null!==a){var s=Z[a.id];if(void 0!==s&&s.version===a.version||(s=lt(a),Z[a.id]=s),void 0!==s.canvas){yt(s.canvas);var h=a.image,l=h.width*a.offset.x,c=h.height*a.offset.y,u=h.width*a.repeat.x,p=h.height*a.repeat.y,d=r/u,f=n/p;L.save(),L.translate(t.x,t.y),0!==i.rotation&&L.rotate(i.rotation),L.translate(-r/2,-n/2),L.scale(d,f),L.translate(-l,-c),L.fillRect(l,c,u,p),L.restore()}}else yt(i.color.getStyle()),L.save(),L.translate(t.x,t.y),0!==i.rotation&&L.rotate(i.rotation),L.scale(r,-n),L.fillRect(-.5,-.5,1,1),L.restore()}else i.isSpriteCanvasMaterial?(vt(i.color.getStyle()),yt(i.color.getStyle()),L.save(),L.translate(t.x,t.y),0!==i.rotation&&L.rotate(i.rotation),L.scale(r,n),i.program(L),L.restore()):i.isPointsMaterial&&(yt(i.color.getStyle()),L.save(),L.translate(t.x,t.y),0!==i.rotation&&L.rotate(i.rotation),L.scale(r*i.size,-n*i.size),L.fillRect(-.5,-.5,1,1),L.restore())}function ot(t,e,i,r){if(pt(r.opacity),dt(r.blending),L.beginPath(),L.moveTo(t.positionScreen.x,t.positionScreen.y),L.lineTo(e.positionScreen.x,e.positionScreen.y),r.isLineBasicMaterial){if(ft(r.linewidth),mt(r.linecap),gt(r.linejoin),r.vertexColors!==THREE.VertexColors)vt(r.color.getStyle());else{var n=i.vertexColors[0].getStyle(),o=i.vertexColors[1].getStyle();if(n===o)vt(n);else{try{var a=L.createLinearGradient(t.positionScreen.x,t.positionScreen.y,e.positionScreen.x,e.positionScreen.y);a.addColorStop(0,n),a.addColorStop(1,o)}catch(t){a=n}vt(a)}}r.isLineDashedMaterial&&Et([r.dashSize,r.gapSize]),L.stroke(),J.expandByScalar(2*r.linewidth),r.isLineDashedMaterial&&Et([])}}function at(t,e,i,n,o,a,_,w){var b,S,T,M,R,A;if(x.info.render.vertices+=3,x.info.render.faces++,pt(w.opacity),dt(w.blending),s=t.positionScreen.x,h=t.positionScreen.y,l=e.positionScreen.x,c=e.positionScreen.y,u=i.positionScreen.x,p=i.positionScreen.y,b=s,S=h,T=l,M=c,R=u,A=p,L.beginPath(),L.moveTo(b,S),L.lineTo(T,M),L.lineTo(R,A),L.closePath(),(w.isMeshLambertMaterial||w.isMeshPhongMaterial||w.isMeshStandardMaterial)&&null===w.map)G.copy(w.color),W.copy(w.emissive),w.vertexColors===THREE.FaceColors&&G.multiply(_.color),U.copy(Q),et.copy(t.positionWorld).add(e.positionWorld).add(i.positionWorld).divideScalar(3),function(t,e,i){for(var n=0,o=r.length;n<o;n++){var a=r[n];if(X.copy(a.color),a.isDirectionalLight){var s=tt.setFromMatrixPosition(a.matrixWorld).normalize();if((h=e.dot(s))<=0)continue;h*=a.intensity,i.add(X.multiplyScalar(h))}else if(a.isPointLight){var h;if(s=tt.setFromMatrixPosition(a.matrixWorld),(h=e.dot(tt.subVectors(s,t).normalize()))<=0)continue;if(0==(h*=0==a.distance?1:1-Math.min(t.distanceTo(s)/a.distance,1)))continue;h*=a.intensity,i.add(X.multiplyScalar(h))}}}(et,_.normalModel,U),U.multiply(G).add(W),!0===w.wireframe?st(U,w.wireframeLinewidth,w.wireframeLinecap,w.wireframeLinejoin):ht(U);else if(w.isMeshBasicMaterial||w.isMeshLambertMaterial||w.isMeshPhongMaterial||w.isMeshStandardMaterial){if(null!==w.map)w.map.mapping===THREE.UVMapping&&(d=_.uvs,ct(s,h,l,c,u,p,d[n].x,d[n].y,d[o].x,d[o].y,d[a].x,d[a].y,w.map));else null!==w.envMap?w.envMap.mapping===THREE.SphericalReflectionMapping&&(it.copy(_.vertexNormalsModel[n]).applyMatrix3(rt),f=.5*it.x+.5,m=.5*it.y+.5,it.copy(_.vertexNormalsModel[o]).applyMatrix3(rt),g=.5*it.x+.5,v=.5*it.y+.5,it.copy(_.vertexNormalsModel[a]).applyMatrix3(rt),y=.5*it.x+.5,E=.5*it.y+.5,ct(s,h,l,c,u,p,f,m,g,v,y,E,w.envMap)):(U.copy(w.color),w.vertexColors===THREE.FaceColors&&U.multiply(_.color),!0===w.wireframe?st(U,w.wireframeLinewidth,w.wireframeLinecap,w.wireframeLinejoin):ht(U))}else w.isMeshNormalMaterial?(it.copy(_.normalModel).applyMatrix3(rt),U.setRGB(it.x,it.y,it.z).multiplyScalar(.5).addScalar(.5),!0===w.wireframe?st(U,w.wireframeLinewidth,w.wireframeLinecap,w.wireframeLinejoin):ht(U)):(U.setRGB(1,1,1),!0===w.wireframe?st(U,w.wireframeLinewidth,w.wireframeLinecap,w.wireframeLinejoin):ht(U))}function st(t,e,i,r){ft(e),mt(i),gt(r),vt(t.getStyle()),L.stroke(),J.expandByScalar(2*e)}function ht(t){yt(t.getStyle()),L.fill()}function lt(t){if(0===t.version||t instanceof THREE.CompressedTexture||t instanceof THREE.DataTexture)return{canvas:void 0,version:t.version};var e=t.image;if(!1===e.complete)return{canvas:void 0,version:0};var i=t.wrapS===THREE.RepeatWrapping||t.wrapS===THREE.MirroredRepeatWrapping,r=t.wrapT===THREE.RepeatWrapping||t.wrapT===THREE.MirroredRepeatWrapping,n=t.wrapS===THREE.MirroredRepeatWrapping,o=t.wrapT===THREE.MirroredRepeatWrapping,a=document.createElement("canvas");a.width=e.width*(n?2:1),a.height=e.height*(o?2:1);var s=a.getContext("2d");s.setTransform(1,0,0,-1,0,e.height),s.drawImage(e,0,0),!0===n&&(s.setTransform(-1,0,0,-1,e.width,e.height),s.drawImage(e,-e.width,0)),!0===o&&(s.setTransform(1,0,0,1,0,0),s.drawImage(e,0,e.height)),!0===n&&!0===o&&(s.setTransform(-1,0,0,1,e.width,0),s.drawImage(e,-e.width,e.height));var h="no-repeat";!0===i&&!0===r?h="repeat":!0===i?h="repeat-x":!0===r&&(h="repeat-y");var l=L.createPattern(a,h);return t.onUpdate&&t.onUpdate(t),{canvas:l,version:t.version}}function ct(t,e,i,r,n,o,a,s,h,l,c,u,p){var d=Z[p.id];if(void 0!==d&&d.version===p.version||(d=lt(p),Z[p.id]=d),void 0===d.canvas)return yt("rgba( 0, 0, 0, 1)"),void L.fill();yt(d.canvas);var f,m,g,v,y,E,x,_,w=p.offset.x/p.repeat.x,b=p.offset.y/p.repeat.y,S=p.image.width*p.repeat.x,T=p.image.height*p.repeat.y;h=(h+w)*S,l=(l+b)*T,c=(c+w)*S,u=(u+b)*T,i-=t,r-=e,n-=t,o-=e,0!==(x=(h-=a=(a+w)*S)*(u-=s=(s+b)*T)-(c-=a)*(l-=s))&&(y=t-(f=(u*i-l*n)*(_=1/x))*a-(g=(h*n-c*i)*_)*s,E=e-(m=(u*r-l*o)*_)*a-(v=(h*o-c*r)*_)*s,L.save(),L.transform(f,m,g,v,y,E),L.fill(),L.restore())}function ut(t,e,i){var r,n=e.x-t.x,o=e.y-t.y,a=n*n+o*o;0!==a&&(n*=r=i/Math.sqrt(a),o*=r,e.x+=n,e.y+=o,t.x-=n,t.y-=o)}function pt(t){I!==t&&(L.globalAlpha=t,I=t)}function dt(t){B!==t&&(t===THREE.NormalBlending?L.globalCompositeOperation="source-over":t===THREE.AdditiveBlending?L.globalCompositeOperation="lighter":t===THREE.SubtractiveBlending?L.globalCompositeOperation="darker":t===THREE.MultiplyBlending&&(L.globalCompositeOperation="multiply"),B=t)}function ft(t){k!==t&&(L.lineWidth=t,k=t)}function mt(t){j!==t&&(L.lineCap=t,j=t)}function gt(t){V!==t&&(L.lineJoin=t,V=t)}function vt(t){z!==t&&(L.strokeStyle=t,z=t)}function yt(t){N!==t&&(L.fillStyle=t,N=t)}function Et(t){F.length!==t.length&&(L.setLineDash(t),F=t)}void 0===L.setLineDash&&(L.setLineDash=function(){}),this.domElement=w,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.getContext=function(){return L},this.getContextAttributes=function(){return L.getContextAttributes()},this.getPixelRatio=function(){return D},this.setPixelRatio=function(t){void 0!==t&&(D=t)},this.setSize=function(t,e,i){b=t*D,S=e*D,w.width=b,w.height=S,T=Math.floor(b/2),M=Math.floor(S/2),!1!==i&&(w.style.width=t+"px",w.style.height=e+"px"),Y.min.set(-T,-M),Y.max.set(T,M),q.min.set(-T,-M),q.max.set(T,M),I=1,B=0,z=null,N=null,k=null,j=null,V=null,this.setViewport(0,0,t,e)},this.setViewport=function(t,e,i,r){R=t*D,A=e*D,C=i*D,P=r*D},this.setScissor=function(){},this.setScissorTest=function(){},this.setClearColor=function(t,e){O.set(t),H=void 0!==e?e:1,q.min.set(-T,-M),q.max.set(T,M)},this.setClearColorHex=function(t,e){this.setClearColor(t,e)},this.getClearColor=function(){return O},this.getClearAlpha=function(){return H},this.getMaxAnisotropy=function(){return 0},this.clear=function(){!1===q.isEmpty()&&(q.intersect(Y),q.expandByScalar(2),q.min.x=q.min.x+T,q.min.y=-q.min.y+M,q.max.x=q.max.x+T,q.max.y=-q.max.y+M,H<1&&L.clearRect(0|q.min.x,0|q.max.y,q.max.x-q.min.x|0,q.min.y-q.max.y|0),H>0&&(pt(1),dt(THREE.NormalBlending),yt("rgba("+Math.floor(255*O.r)+","+Math.floor(255*O.g)+","+Math.floor(255*O.b)+","+H+")"),L.fillRect(0|q.min.x,0|q.max.y,q.max.x-q.min.x|0,q.min.y-q.max.y|0)),q.makeEmpty())},this.clearColor=function(){},this.clearDepth=function(){},this.clearStencil=function(){},this.render=function(t,s){if(void 0!==s.isCamera){var h=t.background;h&&h.isColor?(pt(1),dt(THREE.NormalBlending),yt(h.getStyle()),L.fillRect(0,0,b,S)):!0===this.autoClear&&this.clear(),x.info.render.vertices=0,x.info.render.faces=0,L.setTransform(C/b,0,0,-P/S,R,S-A),L.translate(T,M),e=_.projectScene(t,s,this.sortObjects,this.sortElements),i=e.elements,r=e.lights,rt.getNormalMatrix(s.matrixWorldInverse),function(){Q.setRGB(0,0,0),K.setRGB(0,0,0),$.setRGB(0,0,0);for(var t=0,e=r.length;t<e;t++){var i=r[t],n=i.color;i.isAmbientLight?Q.add(n):i.isDirectionalLight?K.add(n):i.isPointLight&&$.add(n)}}();for(var l=0,c=i.length;l<c;l++){var u=i[l],p=u.material;if(void 0!==p&&0!==p.opacity){if(J.makeEmpty(),u instanceof THREE.RenderableSprite)(n=u).x*=T,n.y*=M,nt(n,u,p);else if(u instanceof THREE.RenderableLine)n=u.v1,o=u.v2,n.positionScreen.x*=T,n.positionScreen.y*=M,o.positionScreen.x*=T,o.positionScreen.y*=M,J.setFromPoints([n.positionScreen,o.positionScreen]),!0===Y.intersectsBox(J)&&ot(n,o,u,p);else if(u instanceof THREE.RenderableFace){if(n=u.v1,o=u.v2,a=u.v3,n.positionScreen.z<-1||n.positionScreen.z>1)continue;if(o.positionScreen.z<-1||o.positionScreen.z>1)continue;if(a.positionScreen.z<-1||a.positionScreen.z>1)continue;n.positionScreen.x*=T,n.positionScreen.y*=M,o.positionScreen.x*=T,o.positionScreen.y*=M,a.positionScreen.x*=T,a.positionScreen.y*=M,p.overdraw>0&&(ut(n.positionScreen,o.positionScreen,p.overdraw),ut(o.positionScreen,a.positionScreen,p.overdraw),ut(a.positionScreen,n.positionScreen,p.overdraw)),J.setFromPoints([n.positionScreen,o.positionScreen,a.positionScreen]),!0===Y.intersectsBox(J)&&at(n,o,a,0,1,2,u,p)}q.union(J)}}L.setTransform(1,0,0,1,0,0)}}},THREE.RaytracingRenderer=function(t){t=t||{};var e,i,r=this,n=[],o=!1,a=document.createElement("canvas"),s=a.getContext("2d",{alpha:!0===t.alpha}),h=new THREE.Color(0);this.domElement=a,this.autoClear=!0;var l=t.workers,c=t.blockSize||64;this.randomize=t.randomize;var u,p,d,f=[],m=0,g=0;function v(t){t.postMessage({init:[e,i],worker:t.id,blockSize:c})}function y(t){if(!f.length)return o=!1,r.dispatchEvent({type:"complete"});var e=f.pop(),i=e%p*c,n=(e/p|0)*c;t.postMessage({render:!0,x:i,y:n,sceneId:g}),s.fillStyle="#"+t.color,s.fillRect(i,n,c,c)}this.setWorkers=function(e){for(l=e||navigator.hardwareConcurrency||4;n.length<l;){var i=new Worker(t.workerPath);i.id=m++,i.onmessage=function(t){var e=t.data;if(e&&e.blockSize&&g==e.sceneId){var i=new ImageData(new Uint8ClampedArray(e.data),e.blockSize,e.blockSize);if(s.putImageData(i,e.blockX,e.blockY),n.length>l)return n.splice(n.indexOf(this),1),this.terminate();y(this)}},i.color=(new THREE.Color).setHSL(Math.random(),.8,.8).getHexString(),n.push(i),o&&(v(i),i.postMessage({scene:E,camera:x,annex:_,sceneId:g}),y(i))}if(!o)for(;n.length>l;)n.pop().terminate()},this.setWorkers(l),this.setClearColor=function(t,e){h.set(t)},this.setPixelRatio=function(){},this.setSize=function(t,r){a.width=t,a.height=r,e=a.width,i=a.height,s.fillStyle="white",n.forEach(v)},this.setSize(a.width,a.height),this.clear=function(){};var E,x,_={},w={mirror:1,reflectivity:1,refractionRatio:1,glass:1};function b(t){var e=t.material;if(e&&!(e.uuid in _)){var i={};for(var r in w)void 0!==e[r]&&(i[r]=e[r]);_[e.uuid]=i}}this.render=function(t,a){o=!0,!0===t.autoUpdate&&t.updateMatrixWorld(),null===a.parent&&a.updateMatrixWorld(),E=t.toJSON(),x=a.toJSON(),++g,t.traverse(b),n.forEach(function(t){t.postMessage({scene:E,camera:x,annex:_,sceneId:g})}),s.clearRect(0,0,e,i),Date.now(),p=Math.ceil(e/c),d=Math.ceil(i/c),u=p*d,f=[];for(var h=0;h<u;h++)f.push(h);if(r.randomize)for(h=0;h<u;h++){var l=Math.random()*u|0,m=f[l];f[l]=f[h],f[h]=m}n.forEach(y)}},Object.assign(THREE.RaytracingRenderer.prototype,THREE.EventDispatcher.prototype),THREE.SoftwareRenderer=function(t){var e,i,r,n,o,a,s,h,l,c,u,p,d,f,m,g,v=void 0!==(t=t||{}).canvas?t.canvas:document.createElement("canvas"),y=v.getContext("2d",{alpha:!0===t.alpha}),E=t.alpha,x={},_={},w=new THREE.Color(0),b=1,S=2,T=4,M=(1<<T)-1,R=3,A=1<<R,C=1<<24,P=!1,D=new THREE.Vector3(0,0,1),L=new THREE.Vector3,O=1/0,H=1/0,I=0,B=0,z=1/0,N=1/0,k=0,j=0,V=new THREE.Projector,F=new THREE.Vector4,U=new THREE.Vector4,G=new THREE.Vector4,W=new THREE.Vector2,X=new THREE.Vector2,Z=new THREE.Vector2,Y=[],q=0,J=[],Q=0,K=[],$=0;function tt(t){for(var r=e*i*4,n=0;n<r;n+=4)p[n]=255*t.r|0,p[n+1]=255*t.g|0,p[n+2]=255*t.b|0,p[n+3]=E?0:255;y.fillStyle=E?"rgba(0, 0, 0, 0)":t.getStyle(),y.fillRect(0,0,e,i)}function et(t,e){var i=0,r=0,n=255*t.color.r,o=255*t.color.g,a=255*t.color.b,s=new Uint8Array(768);if(e){for(;i<204;)s[r++]=Math.min(i*n/204,255),s[r++]=Math.min(i*o/204,255),s[r++]=Math.min(i*a/204,255),++i;for(;i<256;)s[r++]=Math.min(n+(i-204)*(255-n)/82,255),s[r++]=Math.min(o+(i-204)*(255-o)/82,255),s[r++]=Math.min(a+(i-204)*(255-a)/82,255),++i}else for(;i<256;)s[r++]=Math.min(i*n/255,255),s[r++]=Math.min(i*o/255,255),s[r++]=Math.min(i*a/255,255),++i;return s}function it(t,e,i,r,n,o,a,s,h){var l=4*i,c=_[h.map.id];if(c.data){var u=c.width,p=h.transparent,d=u-1,f=c.data,m=4*((o*u&d)*u+(n*u&d));if(p){var g=f[m],v=f[m+1],y=f[m+2],E=f[m+3]*h.opacity/255,x=t[l],w=t[l+1],b=t[l+2];t[l]=g*E+x*(1-E),t[l+1]=v*E+w*(1-E),t[l+2]=y*E+b*(1-E),t[l+3]=(h.opacity<<8)-1,255==t[l+3]&&(e[i]=r)}else t[l]=f[m],t[l+1]=f[m+1],t[l+2]=f[m+2],t[l+3]=(h.opacity<<8)-1,e[i]=r}}function rt(t,e,i,r,n,o,a,s,h){var l=4*i,c=_[h.map.id];if(c.data){var u=c.width,p=h.transparent,d=3*(a>0?~~a:0),f=u-1,m=c.data,g=4*((o*u&f)*u+(n*u&f));if(p){var v=h.palette[d]*m[g],y=h.palette[d+1]*m[g+1],E=h.palette[d+2]*m[g+2],x=m[g+3]*h.opacity/256,w=t[l],b=t[l+1],S=t[l+2];t[l]=v*x+w*(1-x),t[l+1]=y*x+b*(1-x),t[l+2]=E*x+S*(1-x),t[l+3]=(h.opacity<<8)-1,255==t[l+3]&&(e[i]=r)}else t[l]=h.palette[d]*m[g]>>8,t[l+1]=h.palette[d+1]*m[g+1]>>8,t[l+2]=h.palette[d+2]*m[g+2]>>8,t[l+3]=(h.opacity<<8)-1,e[i]=r}}function nt(t){var e=t.id,i=x[e];if(i&&t.map&&!_[t.map.id]&&delete x[e],void 0===x[e]||!0===t.needsUpdate){if(t instanceof THREE.MeshBasicMaterial||t instanceof THREE.MeshLambertMaterial||t instanceof THREE.MeshPhongMaterial||t instanceof THREE.SpriteMaterial)if(t instanceof THREE.MeshLambertMaterial?t.palette||(t.palette=et(t,!1)):t instanceof THREE.MeshPhongMaterial&&(t.palette||(t.palette=et(t,!0))),t.map){var r=new THREE.SoftwareRenderer.Texture;if(r.fromImage(t.map.image),!r.data)return;_[t.map.id]=r,i=t instanceof THREE.MeshBasicMaterial||t instanceof THREE.SpriteMaterial?it:rt}else n=t.vertexColors===THREE.FaceColors?["var colorOffset = offset * 4;","buffer[ colorOffset ] = face.color.r * 255;","buffer[ colorOffset + 1 ] = face.color.g * 255;","buffer[ colorOffset + 2 ] = face.color.b * 255;","buffer[ colorOffset + 3 ] = material.opacity * 255;","depthBuf[ offset ] = depth;"].join("\n"):["var colorOffset = offset * 4;","buffer[ colorOffset ] = material.color.r * 255;","buffer[ colorOffset + 1 ] = material.color.g * 255;","buffer[ colorOffset + 2 ] = material.color.b * 255;","buffer[ colorOffset + 3 ] = material.opacity * 255;","depthBuf[ offset ] = depth;"].join("\n"),i=new Function("buffer, depthBuf, offset, depth, u, v, n, face, material",n);else if(t instanceof THREE.LineBasicMaterial){var n=["var colorOffset = offset * 4;","buffer[ colorOffset ] = material.color.r * (color1.r+color2.r) * 0.5 * 255;","buffer[ colorOffset + 1 ] = material.color.g * (color1.g+color2.g) * 0.5 * 255;","buffer[ colorOffset + 2 ] = material.color.b * (color1.b+color2.b) * 0.5 * 255;","buffer[ colorOffset + 3 ] = 255;","depthBuf[ offset ] = depth;"].join("\n");i=new Function("buffer, depthBuf, offset, depth, color1, color2, material",n)}else{n=["var colorOffset = offset * 4;","buffer[ colorOffset ] = u * 255;","buffer[ colorOffset + 1 ] = v * 255;","buffer[ colorOffset + 2 ] = 0;","buffer[ colorOffset + 3 ] = 255;","depthBuf[ offset ] = depth;"].join("\n");i=new Function("buffer, depthBuf, offset, depth, u, v, n, face, material",n)}x[e]=i,t.needsUpdate=!1}return i}function ot(t,n,u,f,v,y,E,x,_){if(!(t.z<-1||t.z>1||n.z<-1||n.z>1||u.z<-1||u.z>1)){var w=1<<T,C=t.x*o+h|0,P=n.x*o+h|0,D=u.x*o+h|0,L=t.y*a+l|0,z=n.y*a+l|0,N=u.y*a+l|0,k=x.vertexNormalsModel&&x.vertexNormalsModel.length,j=f&&v&&y,V=Math.max(Math.sqrt((C-P)*(C-P)+(L-z)*(L-z)),Math.sqrt((P-D)*(P-D)+(z-N)*(z-N)),Math.sqrt((D-C)*(D-C)+(N-L)*(N-L)));if(!(x instanceof THREE.RenderableSprite)&&V>100*w){var F,U,G,W,X,Z,tt,et,it,rt,nt={vertexNormalsModel:[],color:x.color};if(j)$===K.length?(F=new THREE.Vector2,K.push(F),++$,U=new THREE.Vector2,K.push(U),++$,G=new THREE.Vector2,K.push(G),++$):(F=K[$],U=K[++$],G=K[++$],++$),W=(1+n.z)*(n.w/t.w)/(1+t.z),F.copy(f).multiplyScalar(W).add(v).multiplyScalar(1/(W+1)),W=(1+u.z)*(u.w/n.w)/(1+n.z),U.copy(v).multiplyScalar(W).add(y).multiplyScalar(1/(W+1)),W=(1+t.z)*(t.w/u.w)/(1+u.z),G.copy(y).multiplyScalar(W).add(f).multiplyScalar(1/(W+1));return q===Y.length?(X=new THREE.Vector4,Y.push(X),++q,Z=new THREE.Vector4,Y.push(Z),++q,tt=new THREE.Vector4,Y.push(tt),++q):(X=Y[q],Z=Y[++q],tt=Y[++q],++q),X.copy(t).add(n).multiplyScalar(.5),Z.copy(n).add(u).multiplyScalar(.5),tt.copy(u).add(t).multiplyScalar(.5),k&&(Q===J.length?(et=new THREE.Vector3,J.push(et),++Q,it=new THREE.Vector3,J.push(it),++Q,rt=new THREE.Vector3,J.push(rt),++Q):(et=J[Q],it=J[++Q],rt=J[++Q],++Q),et.copy(x.vertexNormalsModel[0]).add(x.vertexNormalsModel[1]).normalize(),it.copy(x.vertexNormalsModel[1]).add(x.vertexNormalsModel[2]).normalize(),rt.copy(x.vertexNormalsModel[2]).add(x.vertexNormalsModel[0]).normalize()),k&&(nt.vertexNormalsModel[0]=x.vertexNormalsModel[0],nt.vertexNormalsModel[1]=et,nt.vertexNormalsModel[2]=rt),ot(t,X,tt,f,F,G,E,nt,_),k&&(nt.vertexNormalsModel[0]=x.vertexNormalsModel[1],nt.vertexNormalsModel[1]=it,nt.vertexNormalsModel[2]=et),ot(n,Z,X,v,U,F,E,nt,_),k&&(nt.vertexNormalsModel[0]=et,nt.vertexNormalsModel[1]=it,nt.vertexNormalsModel[2]=rt),ot(X,Z,tt,F,U,G,E,nt,_),k&&(nt.vertexNormalsModel[0]=x.vertexNormalsModel[2],nt.vertexNormalsModel[1]=rt,nt.vertexNormalsModel[2]=it),void ot(u,tt,Z,y,G,U,E,nt,_)}var at,ht,lt,ct,ut,pt,dt,ft,mt,gt,vt,yt,Et=t.z*s+c|0,xt=n.z*s+c|0,_t=u.z*s+c|0;j=!1;f&&v&&y&&(j=!0,at=f.x,ht=1-f.y,lt=v.x,ct=1-v.y,ut=y.x,pt=1-y.y),k&&(dt=x.vertexNormalsModel[0],ft=x.vertexNormalsModel[1],mt=x.vertexNormalsModel[2],gt=255*dt.z,vt=255*ft.z,yt=255*mt.z);var wt=C-P,bt=z-L,St=P-D,Tt=N-z,Mt=D-C,Rt=L-N,At=Math.max(Math.min(C,P,D)+M>>T,0),Ct=Math.min(Math.max(C,P,D)+M>>T,e),Pt=Math.max(Math.min(L,z,N)+M>>T,0),Dt=Math.min(Math.max(L,z,N)+M>>T,i);O=Math.min(At,O),I=Math.max(Ct,I),H=Math.min(Pt,H),B=Math.max(Dt,B);var Lt=A,Ot=(At&=~(Lt-1))<<T,Ht=(Pt&=~(Lt-1))<<T,It=bt*(Ot-C)+wt*(Ht-L),Bt=Tt*(Ot-P)+St*(Ht-z),zt=Rt*(Ot-D)+Mt*(Ht-N);(bt>0||0==bt&&wt>0)&&It++,(Tt>0||0==Tt&&St>0)&&Bt++,(Rt>0||0==Rt&&Mt>0)&&zt++,It=It-1>>T,Bt=Bt-1>>T,zt=zt-1>>T;var Nt,kt,jt,Vt,Ft,Ut=Et-xt,Gt=_t-Et,Wt=1/(wt*Rt-Mt*bt),Xt=Wt*(Ut*Rt-Gt*bt),Zt=Wt*(Ut*Mt-wt*Gt),Yt=Et+(Ot-C)*Xt+(Ht-L)*Zt|0;if(Xt=Xt*w|0,Zt=Zt*w|0,j){var qt=at-lt,Jt=ut-at,Qt=Wt*(qt*Rt-Jt*bt),Kt=Wt*(qt*Mt-wt*Jt),$t=ht-ct,te=pt-ht;jt=at+(Ot-C)*Qt+(Ht-L)*Kt,Vt=ht+(Ot-C)*(Nt=Wt*($t*Rt-te*bt))+(Ht-L)*(kt=Wt*($t*Mt-wt*te)),Qt*=w,Kt*=w,Nt*=w,kt*=w}if(k){var ee,ie=gt-vt,re=yt-gt,ne=Wt*(ie*Rt-re*bt);Ft=gt+(Ot-C)*ne+(Ht-L)*(ee=Wt*(ie*Mt-wt*re)),ne*=w,ee*=w}var oe=Lt-1,ae=0,se=0,he=0,le=0,ce=0,ue=0,pe=0,de=0;wt>=0?se-=oe*wt:ae-=oe*wt,bt>=0?se-=oe*bt:ae-=oe*bt,St>=0?le-=oe*St:he-=oe*St,Tt>=0?le-=oe*Tt:he-=oe*Tt,Mt>=0?ue-=oe*Mt:ce-=oe*Mt,Rt>=0?ue-=oe*Rt:ce-=oe*Rt,Xt>=0?de+=oe*Xt:pe+=oe*Xt,Zt>=0?de+=oe*Zt:pe+=oe*Zt;var fe,me,ge,ve=e-Lt,ye=It,Ee=Bt,xe=zt,_e=Yt,we=-Lt,be=we*bt,Se=we*Tt,Te=we*Rt,Me=we*Xt;j&&(fe=we*Qt,me=we*Nt),k&&(ge=we*ne);for(var Re=At,Ae=Pt;Ae<Dt;Ae+=Lt){for(;Re>=At&&Re<Ct&&ye>=se&&Ee>=le&&xe>=ue;)Re+=we,ye+=be,Ee+=Se,xe+=Te,_e+=Me,j&&(jt+=fe,Vt+=me),k&&(Ft+=ge);for(we=-we,be=-be,Se=-Se,Te=-Te,Me=-Me,j&&(fe=-fe,me=-me),k&&(ge=-ge);Re+=we,ye+=be,Ee+=Se,xe+=Te,_e+=Me,j&&(jt+=fe,Vt+=me),k&&(Ft+=ge),!(Re<At||Re>=Ct);)if(ye<se){if(be<0)break}else if(Ee<le){if(Se<0)break}else if(xe<ue){if(Te<0)break}else{var Ce=Re>>R,Pe=Ae>>R,De=Ce+Pe*r,Le=_e+pe;if(!(m[De]<Le)){var Oe=g[De];Oe&S&&st(Ce,Pe),g[De]=Oe&~(b|S);var He=Re+Ae*e;if(ye>=ae&&Ee>=he&&xe>=ce){var Ie=_e+de;m[De]=Math.min(m[De],Ie);var Be=ye,ze=Ee,Ne=_e;j&&(Ge=jt,We=Vt),k&&(Xe=Ft);for(var ke=0;ke<Lt;ke++){var je=Be,Ve=ze,Fe=Ne;j&&(Ye=Ge,qe=We),k&&(Je=Xe);for(var Ue=0;Ue<Lt;Ue++){(Ke=Fe)<d[He]&&E(p,d,He,Ke,Ye,qe,Je,x,_),je+=bt,Ve+=Tt,Fe+=Xt,j&&(Ye+=Qt,qe+=Nt),k&&(Je+=ne),He++}Be+=wt,ze+=St,Ne+=Zt,j&&(Ge+=Kt,We+=kt),k&&(Xe+=ee),He+=ve}}else{Be=ye,ze=Ee;var Ge,We,Xe,Ze=xe;Ne=_e;j&&(Ge=jt,We=Vt),k&&(Xe=Ft);for(ke=0;ke<Lt;ke++){je=Be,Ve=ze;var Ye,qe,Je,Qe=Ze;Fe=Ne;j&&(Ye=Ge,qe=We),k&&(Je=Xe);for(Ue=0;Ue<Lt;Ue++){var Ke;if((je|Ve|Qe)>=0)(Ke=Fe)<d[He]&&E(p,d,He,Ke,Ye,qe,Je,x,_);je+=bt,Ve+=Tt,Qe+=Rt,Fe+=Xt,j&&(Ye+=Qt,qe+=Nt),k&&(Je+=ne),He++}Be+=wt,ze+=St,Ze+=Mt,Ne+=Zt,j&&(Ge+=Kt,We+=kt),k&&(Xe+=ee),He+=ve}}}}ye+=Lt*wt,Ee+=Lt*St,xe+=Lt*Mt,_e+=Lt*Zt,j&&(jt+=Lt*Kt,Vt+=Lt*kt),k&&(Ft+=Lt*ee)}}}function at(t,x,_,z,N,k){if(P||(P=!0,A=1<<(R=0),function(t,x){r=Math.floor(t/A),n=Math.floor(x/A);var _=1<<T;o=_*(e=r*A)/2,a=-_*(i=n*A)/2,s=C/2,h=_*e/2+.5,l=_*i/2+.5,c=C/2+.5,v.width=e,v.height=i,y.fillStyle=E?"rgba(0, 0, 0, 0)":w.getStyle(),y.fillRect(0,0,e,i),u=y.getImageData(0,0,e,i),p=u.data,d=new Int32Array(p.length/4),f=r*n,m=new Int32Array(f),g=new Uint8Array(f);for(var S=0,M=d.length;S<M;S++)d[S]=C;for(S=0;S<f;S++)g[S]=b;tt(w)}(v.width,v.height)),!(t.z<-1||t.z>1||x.z<-1||x.z>1)){var j=Math.floor(.5*(k.linewidth-1)),V=t.x*o+h|0,F=x.x*o+h|0,U=t.y*a+l|0,G=x.y*a+l|0,W=t.z*s+c|0,X=x.z*s+c|0,Z=V-F,Y=U-G,q=W-X,J=Math.max(Math.min(V,F)+M>>T,0),Q=Math.min(Math.max(V,F)+M>>T,e),K=Math.max(Math.min(U,G)+M>>T,0),$=Math.min(Math.max(U,G)+M>>T,i),et=Math.max(Math.min(W,X)+M>>T,0),it=Math.max(W,X)+M>>T;O=Math.min(J,O),I=Math.max(Q,I),H=Math.min(K,H),B=Math.max($,B);var rt,nt,ot,at,ht,lt=Math.sqrt(Y*Y+Z*Z),ct=Z/lt,ut=Y/lt,pt=q/lt;for(L.set(ct,ut,pt),L.cross(D),L.normalize();lt>0;){rt=(rt=F+lt*ct)+M>>T,nt=(nt=G+lt*ut)+M>>T,ht=X+lt*pt+M>>T;for(var dt=-j;dt<=j;++dt)if(ot=Math.floor(rt+L.x*dt),at=Math.floor(nt+L.y*dt),!(O>=ot||I<=ot||H>=at||B<=at)){var ft=ot>>R,mt=at>>R,gt=ft+mt*r;if(!(m[gt]<et)){m[gt]=Math.min(m[gt],it);var vt=g[gt];vt&S&&st(ft,mt),g[gt]=vt&~(b|S);var yt=ot+at*e;ht<d[yt]&&N(p,d,yt,ht,_,z,k)}}--lt}}}function st(t,i){for(var r=t*A+i*A*e,n=4*r,o=e-A,a=4*o,s=0;s<A;s++){for(var h=0;h<A;h++)d[r++]=C,p[n++]=255*w.r|0,p[n++]=255*w.g|0,p[n++]=255*w.b|0,p[n++]=E?0:255;r+=o,n+=a}}this.domElement=v,this.autoClear=!0,this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.setClearColor=function(t){w.set(t),tt(w)},this.setPixelRatio=function(){},this.setSize=function(t,x){r=Math.floor(t/A),n=Math.floor(x/A);var _=1<<T;o=_*(e=r*A)/2,a=-_*(i=n*A)/2,s=C/2,h=_*e/2+.5,l=_*i/2+.5,c=C/2+.5,v.width=e,v.height=i,y.fillStyle=E?"rgba(0, 0, 0, 0)":w.getStyle(),y.fillRect(0,0,e,i),u=y.getImageData(0,0,e,i),p=u.data,d=new Int32Array(p.length/4),f=r*n,m=new Int32Array(f),g=new Uint8Array(f);for(var S=0,M=d.length;S<M;S++)d[S]=C;for(S=0;S<f;S++)g[S]=b;tt(w)},this.setSize(v.width,v.height),this.clear=function(){O=1/0,H=1/0,I=0,B=0,q=0,Q=0,$=0;for(var t=0;t<f;t++)m[t]=C,g[t]=g[t]&b?b:S},this.render=function(t,e){this.clear();var i=t.background;i&&i.isColor&&tt(i);for(var o=V.projectScene(t,e,!1,!1).elements,a=0,s=o.length;a<s;a++){var h=o[a],l=h.material;if(d=nt(l))if(h instanceof THREE.RenderableFace)h.uvs?ot(h.v1.positionScreen,h.v2.positionScreen,h.v3.positionScreen,h.uvs[0],h.uvs[1],h.uvs[2],d,h,l):ot(h.v1.positionScreen,h.v2.positionScreen,h.v3.positionScreen,null,null,null,d,h,l);else if(h instanceof THREE.RenderableSprite){var c=.5*h.scale.x,p=.5*h.scale.y;F.copy(h),F.x-=c,F.y+=p,U.copy(h),U.x-=c,U.y-=p,G.copy(h),G.x+=c,G.y+=p,l.map?(W.set(0,1),X.set(0,0),Z.set(1,1),ot(F,U,G,W,X,Z,d,h,l)):ot(F,U,G,null,null,null,d,h,l),F.copy(h),F.x+=c,F.y+=p,U.copy(h),U.x-=c,U.y-=p,G.copy(h),G.x+=c,G.y-=p,l.map?(W.set(1,1),X.set(0,0),Z.set(1,0),ot(F,U,G,W,X,Z,d,h,l)):ot(F,U,G,null,null,null,d,h,l)}else if(h instanceof THREE.RenderableLine){var d=nt(l);at(h.v1.positionScreen,h.v2.positionScreen,h.vertexColors[0],h.vertexColors[1],d,l)}}!function(){for(var t=0,e=0;e<n;e++)for(var i=0;i<r;i++)g[t]&S&&(st(i,e),g[t]=b),t++}();var f=Math.min(O,z),m=Math.min(H,N),v=Math.max(I,k)-f,E=Math.max(B,j)-m;f!==1/0&&y.putImageData(u,0,0,f,m,v,E),z=O,N=H,k=I,j=B}},THREE.SoftwareRenderer.Texture=function(){var t;this.fromImage=function(e){if(!(!e||e.width<=0||e.height<=0)){void 0===t&&(t=document.createElement("canvas"));var i=e.width>e.height?e.width:e.height;i=THREE.Math.nextPowerOfTwo(i),t.width==i&&t.height==i||(t.width=i,t.height=i);var r=t.getContext("2d");r.clearRect(0,0,i,i),r.drawImage(e,0,0,i,i);var n=r.getImageData(0,0,i,i);this.data=n.data,this.width=i,this.height=i,this.srcUrl=e.src}}},THREE.SVGObject=function(t){THREE.Object3D.call(this),this.node=t},THREE.SVGObject.prototype=Object.create(THREE.Object3D.prototype),THREE.SVGObject.prototype.constructor=THREE.SVGObject,THREE.SVGRenderer=function(){var t,e,i,r,n,o,a,s,h,l,c,u,p,d=this,f=new THREE.Projector,m=document.createElementNS("http://www.w3.org/2000/svg","svg"),g=new THREE.Box2,v=new THREE.Box2,y=new THREE.Color,E=new THREE.Color,x=new THREE.Color,_=new THREE.Color,w=new THREE.Color,b=new THREE.Color,S=1,T=new THREE.Vector3,M=new THREE.Vector3,R=new THREE.Vector3,A=new THREE.Matrix3,C=new THREE.Matrix4,P=new THREE.Matrix4,D=[],L=0,O=1,H=null;function I(){for(L=0;m.childNodes.length>0;)m.removeChild(m.childNodes[0])}function B(t,e){var i=Math.floor(255*t.r)+","+Math.floor(255*t.g)+","+Math.floor(255*t.b);return void 0===e||1===e?"rgb("+i+")":"rgba("+i+","+e+")"}function z(t){return null!==H?t.toFixed(H):t}function N(t,e,i){var r=e.scale.x*o,n=e.scale.y*a;i.isPointsMaterial&&(r*=i.size,n*=i.size);var s="M"+z(t.x-.5*r)+","+z(t.y-.5*n)+"h"+z(r)+"v"+z(n)+"h"+z(-r)+"z",h="";(i.isSpriteMaterial||i.isPointsMaterial)&&(h="fill:"+B(i.color,i.opacity)),V(h,s)}function k(t,e,i,r){var n="M"+z(t.positionScreen.x)+","+z(t.positionScreen.y)+"L"+z(e.positionScreen.x)+","+z(e.positionScreen.y);if(r.isLineBasicMaterial){var o="fill:none;stroke:"+B(r.color,r.opacity)+";stroke-width:"+r.linewidth+";stroke-linecap:"+r.linecap;r.isLineDashedMaterial&&(o=o+";stroke-dasharray:"+r.dashSize+","+r.gapSize),V(o,n)}}function j(t,e,r,n,o){d.info.render.vertices+=3,d.info.render.faces++;var a="M"+z(t.positionScreen.x)+","+z(t.positionScreen.y)+"L"+z(e.positionScreen.x)+","+z(e.positionScreen.y)+"L"+z(r.positionScreen.x)+","+z(r.positionScreen.y)+"z";o instanceof THREE.MeshBasicMaterial?(y.copy(o.color),o.vertexColors===THREE.FaceColors&&y.multiply(n.color)):o instanceof THREE.MeshLambertMaterial||o instanceof THREE.MeshPhongMaterial?(E.copy(o.color),o.vertexColors===THREE.FaceColors&&E.multiply(n.color),y.copy(x),M.copy(t.positionWorld).add(e.positionWorld).add(r.positionWorld).divideScalar(3),function(t,e,i,r){for(var n=0,o=t.length;n<o;n++){var a=t[n],s=a.color;if(a instanceof THREE.DirectionalLight){var h=T.setFromMatrixPosition(a.matrixWorld).normalize();if((l=i.dot(h))<=0)continue;l*=a.intensity,r.r+=s.r*l,r.g+=s.g*l,r.b+=s.b*l}else if(a instanceof THREE.PointLight){var l;if(h=T.setFromMatrixPosition(a.matrixWorld),(l=i.dot(T.subVectors(h,e).normalize()))<=0)continue;if(0==(l*=0==a.distance?1:1-Math.min(e.distanceTo(h)/a.distance,1)))continue;l*=a.intensity,r.r+=s.r*l,r.g+=s.g*l,r.b+=s.b*l}}}(i,M,n.normalModel,y),y.multiply(E).add(o.emissive)):o instanceof THREE.MeshNormalMaterial&&(R.copy(n.normalModel).applyMatrix3(A),y.setRGB(R.x,R.y,R.z).multiplyScalar(.5).addScalar(.5)),V(o.wireframe?"fill:none;stroke:"+B(y,o.opacity)+";stroke-width:"+o.wireframeLinewidth+";stroke-linecap:"+o.wireframeLinecap+";stroke-linejoin:"+o.wireframeLinejoin:"fill:"+B(y,o.opacity),a)}function V(t,e){p===t?u+=e:(F(),p=t,u=e)}function F(){u&&((c=function(t){if(null==D[t])return D[t]=document.createElementNS("http://www.w3.org/2000/svg","path"),0==O&&D[t].setAttribute("shape-rendering","crispEdges"),D[t];return D[t]}(L++)).setAttribute("d",u),c.setAttribute("style",p),m.appendChild(c)),u="",p=""}this.domElement=m,this.autoClear=!0,this.sortObjects=!0,this.sortElements=!0,this.info={render:{vertices:0,faces:0}},this.setQuality=function(t){switch(t){case"high":O=1;break;case"low":O=0}},this.supportsVertexTextures=function(){},this.setFaceCulling=function(){},this.setClearColor=function(t,e){b.set(t),S=void 0!==e?e:1},this.setPixelRatio=function(){},this.setSize=function(t,e){o=(r=t)/2,a=(n=e)/2,m.setAttribute("viewBox",-o+" "+-a+" "+r+" "+n),m.setAttribute("width",r),m.setAttribute("height",n),g.min.set(-o,-a),g.max.set(o,a)},this.setPrecision=function(t){H=t},this.clear=function(){I(),m.style.backgroundColor=B(b,S)},this.render=function(r,n){if(n instanceof THREE.Camera!=!1){var c=r.background;c&&c.isColor?(I(),m.style.backgroundColor=B(c)):!0===this.autoClear&&this.clear(),d.info.render.vertices=0,d.info.render.faces=0,C.copy(n.matrixWorldInverse),P.multiplyMatrices(n.projectionMatrix,C),t=f.projectScene(r,n,this.sortObjects,this.sortElements),e=t.elements,i=t.lights,A.getNormalMatrix(n.matrixWorldInverse),function(t){x.setRGB(0,0,0),_.setRGB(0,0,0),w.setRGB(0,0,0);for(var e=0,i=t.length;e<i;e++){var r=t[e],n=r.color;r instanceof THREE.AmbientLight?(x.r+=n.r,x.g+=n.g,x.b+=n.b):r instanceof THREE.DirectionalLight?(_.r+=n.r,_.g+=n.g,_.b+=n.b):r instanceof THREE.PointLight&&(w.r+=n.r,w.g+=n.g,w.b+=n.b)}}(i),u="",p="";for(var y=0,E=e.length;y<E;y++){var b=e[y],S=b.material;if(void 0!==S&&0!==S.opacity)if(v.makeEmpty(),b instanceof THREE.RenderableSprite)(s=b).x*=o,s.y*=-a,N(s,b,S);else if(b instanceof THREE.RenderableLine)s=b.v1,h=b.v2,s.positionScreen.x*=o,s.positionScreen.y*=-a,h.positionScreen.x*=o,h.positionScreen.y*=-a,v.setFromPoints([s.positionScreen,h.positionScreen]),!0===g.intersectsBox(v)&&k(s,h,b,S);else if(b instanceof THREE.RenderableFace){if(s=b.v1,h=b.v2,l=b.v3,s.positionScreen.z<-1||s.positionScreen.z>1)continue;if(h.positionScreen.z<-1||h.positionScreen.z>1)continue;if(l.positionScreen.z<-1||l.positionScreen.z>1)continue;s.positionScreen.x*=o,s.positionScreen.y*=-a,h.positionScreen.x*=o,h.positionScreen.y*=-a,l.positionScreen.x*=o,l.positionScreen.y*=-a,v.setFromPoints([s.positionScreen,h.positionScreen,l.positionScreen]),!0===g.intersectsBox(v)&&j(s,h,l,b,S)}}F(),r.traverseVisible(function(t){if(t instanceof THREE.SVGObject){T.setFromMatrixPosition(t.matrixWorld),T.applyMatrix4(P);var e=T.x*o,i=-T.y*a,r=t.node;r.setAttribute("transform","translate("+e+","+i+")"),m.appendChild(r)}})}}},THREE.CSS2DObject=function(t){THREE.Object3D.call(this),this.element=t,this.element.style.position="absolute",this.addEventListener("removed",function(t){null!==this.element.parentNode&&this.element.parentNode.removeChild(this.element)})},THREE.CSS2DObject.prototype=Object.create(THREE.Object3D.prototype),THREE.CSS2DObject.prototype.constructor=THREE.CSS2DObject,THREE.CSS2DRenderer=function(){var t,e,i=new THREE.Vector3,r=new THREE.Matrix4,n=new THREE.Matrix4,o=document.createElement("div");o.style.overflow="hidden",this.domElement=o,this.setSize=function(i,r){t=i/2,e=r/2,o.style.width=i+"px",o.style.height=r+"px"};var a=function(r,s){if(r instanceof THREE.CSS2DObject&&r.parent.parent instanceof VB.Poi)if(r.parent.parent.visible){r.element.style.display="block",i.setFromMatrixPosition(r.matrixWorld),i.applyMatrix4(n);var h=r.element,l="translate(-50%,-100%) translate("+(i.x*t+t)+"px,"+(-i.y*e+e)+"px)";h.style.WebkitTransform=l,h.style.MozTransform=l,h.style.oTransform=l,h.style.transform=l,h.parentNode!==o&&o.appendChild(h)}else r.element.style.display="none";for(var c=0,u=r.children.length;c<u;c++)a(r.children[c],s)};this.render=function(t,e){t.updateMatrixWorld(),null===e.parent&&e.updateMatrixWorld(),r.copy(e.matrixWorldInverse),n.multiplyMatrices(e.projectionMatrix,r),a(t,e)}},THREE.CSS3DObject=function(t){THREE.Object3D.call(this),this.element=t,this.element.style.position="absolute",this.addEventListener("removed",function(){null!==this.element.parentNode&&this.element.parentNode.removeChild(this.element)})},THREE.CSS3DObject.prototype=Object.create(THREE.Object3D.prototype),THREE.CSS3DObject.prototype.constructor=THREE.CSS3DObject,THREE.CSS3DSprite=function(t){THREE.CSS3DObject.call(this,t)},THREE.CSS3DSprite.prototype=Object.create(THREE.CSS3DObject.prototype),THREE.CSS3DSprite.prototype.constructor=THREE.CSS3DSprite,THREE.CSS3DRenderer=function(){var t,e,i,r,n=new THREE.Matrix4,o={camera:{fov:0,style:""},objects:{}},a=document.createElement("div");a.style.overflow="hidden",this.domElement=a;var s=document.createElement("div");s.style.WebkitTransformStyle="preserve-3d",s.style.MozTransformStyle="preserve-3d",s.style.transformStyle="preserve-3d",a.appendChild(s);var h=/Trident/i.test(navigator.userAgent);function l(t){return Math.abs(t)<1e-10?0:t}function c(t,e){var n=t.elements,o="matrix3d("+l(n[0])+","+l(n[1])+","+l(n[2])+","+l(n[3])+","+l(-n[4])+","+l(-n[5])+","+l(-n[6])+","+l(-n[7])+","+l(n[8])+","+l(n[9])+","+l(n[10])+","+l(n[11])+","+l(n[12])+","+l(n[13])+","+l(n[14])+","+l(n[15])+")";return h?"translate(-50%,-50%)translate("+i+"px,"+r+"px)"+e+o:"translate(-50%,-50%)"+o}function u(t,e,i){if(t instanceof THREE.CSS3DObject){var r;t instanceof THREE.CSS3DSprite?(n.copy(e.matrixWorldInverse),n.transpose(),n.copyPosition(t.matrixWorld),n.scale(t.scale),n.elements[3]=0,n.elements[7]=0,n.elements[11]=0,n.elements[15]=1,r=c(n,i)):r=c(t.matrixWorld,i);var a=t.element,l=o.objects[t.id]&&o.objects[t.id].style;void 0!==l&&l===r||(a.style.WebkitTransform=r,a.style.MozTransform=r,a.style.transform=r,o.objects[t.id]={style:r},h&&(o.objects[t.id].distanceToCameraSquared=f(e,t))),a.parentNode!==s&&s.appendChild(a)}for(var p=0,d=t.children.length;p<d;p++)u(t.children[p],e,i)}this.setClearColor=function(){},this.getSize=function(){return{width:t,height:e}},this.setSize=function(n,o){i=(t=n)/2,r=(e=o)/2,a.style.width=n+"px",a.style.height=o+"px",s.style.width=n+"px",s.style.height=o+"px"};var p,d,f=(p=new THREE.Vector3,d=new THREE.Vector3,function(t,e){return p.setFromMatrixPosition(t.matrixWorld),d.setFromMatrixPosition(e.matrixWorld),p.distanceToSquared(d)});this.render=function(t,e){var n=e.projectionMatrix.elements[5]*r;o.camera.fov!==n&&(a.style.WebkitPerspective=n+"px",a.style.MozPerspective=n+"px",a.style.perspective=n+"px",o.camera.fov=n),t.updateMatrixWorld(),null===e.parent&&e.updateMatrixWorld();var c,p,d="translateZ("+n+"px)"+(c=e.matrixWorldInverse,"matrix3d("+l((p=c.elements)[0])+","+l(-p[1])+","+l(p[2])+","+l(p[3])+","+l(p[4])+","+l(-p[5])+","+l(p[6])+","+l(p[7])+","+l(p[8])+","+l(-p[9])+","+l(p[10])+","+l(p[11])+","+l(p[12])+","+l(-p[13])+","+l(p[14])+","+l(p[15])+")"),f=d+"translate("+i+"px,"+r+"px)";o.camera.style===f||h||(s.style.WebkitTransform=f,s.style.MozTransform=f,s.style.transform=f,o.camera.style=f),u(t,e,d),h&&function(t){var e=Object.keys(o.objects).sort(function(t,e){return o.objects[t].distanceToCameraSquared-o.objects[e].distanceToCameraSquared}),i=e.length;t.traverse(function(t){var r=e.indexOf(t.id+"");-1!==r&&(t.element.style.zIndex=i-r)})}(t)}},THREE.EffectComposer=function(t,e){if(this.renderer=t,void 0===e){var i={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1},r=t.getSize();(e=new THREE.WebGLRenderTarget(r.width,r.height,i)).texture.name="EffectComposer.rt1"}this.renderTarget1=e,this.renderTarget2=e.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.passes=[],THREE.CopyShader,THREE.ShaderPass,this.copyPass=new THREE.ShaderPass(THREE.CopyShader)},Object.assign(THREE.EffectComposer.prototype,{swapBuffers:function(){var t=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=t},addPass:function(t){this.passes.push(t);var e=this.renderer.getSize();t.setSize(e.width,e.height)},insertPass:function(t,e){this.passes.splice(e,0,t)},render:function(t){var e,i,r=!1,n=this.passes.length;for(i=0;i<n;i++)if(!1!==(e=this.passes[i]).enabled){if(e.render(this.renderer,this.writeBuffer,this.readBuffer,t,r),e.needsSwap){if(r){var o=this.renderer.context;o.stencilFunc(o.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,t),o.stencilFunc(o.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==THREE.MaskPass&&(e instanceof THREE.MaskPass?r=!0:e instanceof THREE.ClearMaskPass&&(r=!1))}},reset:function(t){if(void 0===t){var e=this.renderer.getSize();(t=this.renderTarget1.clone()).setSize(e.width,e.height)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=t,this.renderTarget2=t.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(t,e){this.renderTarget1.setSize(t,e),this.renderTarget2.setSize(t,e);for(var i=0;i<this.passes.length;i++)this.passes[i].setSize(t,e)}}),THREE.Pass=function(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1},Object.assign(THREE.Pass.prototype,{setSize:function(t,e){},render:function(t,e,i,r,n){}}),THREE.ClearPass=function(t,e){THREE.Pass.call(this),this.needsSwap=!1,this.clearColor=void 0!==t?t:0,this.clearAlpha=void 0!==e?e:0},THREE.ClearPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.ClearPass,render:function(t,e,i,r,n){var o,a;this.clearColor&&(o=t.getClearColor().getHex(),a=t.getClearAlpha(),t.setClearColor(this.clearColor,this.clearAlpha)),t.setRenderTarget(this.renderToScreen?null:i),t.clear(),this.clearColor&&t.setClearColor(o,a)}}),THREE.MaskPass=function(t,e){THREE.Pass.call(this),this.scene=t,this.camera=e,this.clear=!0,this.needsSwap=!1,this.inverse=!1},THREE.MaskPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.MaskPass,render:function(t,e,i,r,n){var o,a,s=t.context,h=t.state;h.buffers.color.setMask(!1),h.buffers.depth.setMask(!1),h.buffers.color.setLocked(!0),h.buffers.depth.setLocked(!0),this.inverse?(o=0,a=1):(o=1,a=0),h.buffers.stencil.setTest(!0),h.buffers.stencil.setOp(s.REPLACE,s.REPLACE,s.REPLACE),h.buffers.stencil.setFunc(s.ALWAYS,o,4294967295),h.buffers.stencil.setClear(a),t.render(this.scene,this.camera,i,this.clear),t.render(this.scene,this.camera,e,this.clear),h.buffers.color.setLocked(!1),h.buffers.depth.setLocked(!1),h.buffers.stencil.setFunc(s.EQUAL,1,4294967295),h.buffers.stencil.setOp(s.KEEP,s.KEEP,s.KEEP)}}),THREE.ClearMaskPass=function(){THREE.Pass.call(this),this.needsSwap=!1},THREE.ClearMaskPass.prototype=Object.create(THREE.Pass.prototype),Object.assign(THREE.ClearMaskPass.prototype,{render:function(t,e,i,r,n){t.state.buffers.stencil.setTest(!1)}}),THREE.ShaderPass=function(t,e){THREE.Pass.call(this),this.textureID=void 0!==e?e:"tDiffuse",t instanceof THREE.ShaderMaterial?(this.uniforms=t.uniforms,this.material=t):t&&(this.uniforms=THREE.UniformsUtils.clone(t.uniforms),this.material=new THREE.ShaderMaterial({defines:t.defines||{},uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader})),this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)},THREE.ShaderPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.ShaderPass,render:function(t,e,i,r,n){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.quad.material=this.material,this.renderToScreen?t.render(this.scene,this.camera):t.render(this.scene,this.camera,e,this.clear)}}),THREE.RenderPass=function(t,e,i,r,n){THREE.Pass.call(this),this.scene=t,this.camera=e,this.overrideMaterial=i,this.clearColor=r,this.clearAlpha=void 0!==n?n:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1},THREE.RenderPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.RenderPass,render:function(t,e,i,r,n){var o,a,s=t.autoClear;t.autoClear=!1,this.scene.overrideMaterial=this.overrideMaterial,this.clearColor&&(o=t.getClearColor().getHex(),a=t.getClearAlpha(),t.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&t.clearDepth(),t.render(this.scene,this.camera,this.renderToScreen?null:i,this.clear),this.clearColor&&t.setClearColor(o,a),this.scene.overrideMaterial=null,t.autoClear=s}}),THREE.OutlinePass=function(t,e,i,r){this.renderScene=e,this.renderCamera=i,this.selectedObjects=void 0!==r?r:[],this.visibleEdgeColor=new THREE.Color(1,1,1),this.hiddenEdgeColor=new THREE.Color(.1,.04,.02),this.edgeGlow=0,this.usePatternTexture=!1,this.edgeThickness=1,this.edgeStrength=3,this.downSampleRatio=2,this.pulsePeriod=0,THREE.Pass.call(this),this.resolution=void 0!==t?new THREE.Vector2(t.x,t.y):new THREE.Vector2(256,256);var n={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat},o=Math.round(this.resolution.x/this.downSampleRatio),a=Math.round(this.resolution.y/this.downSampleRatio);this.maskBufferMaterial=new THREE.MeshBasicMaterial({color:16777215}),this.maskBufferMaterial.side=THREE.DoubleSide,this.renderTargetMaskBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,n),this.renderTargetMaskBuffer.texture.name="OutlinePass.mask",this.renderTargetMaskBuffer.texture.generateMipmaps=!1,this.depthMaterial=new THREE.MeshDepthMaterial,this.depthMaterial.side=THREE.DoubleSide,this.depthMaterial.depthPacking=THREE.RGBADepthPacking,this.depthMaterial.blending=THREE.NoBlending,this.prepareMaskMaterial=this.getPrepareMaskMaterial(),this.prepareMaskMaterial.side=THREE.DoubleSide,this.renderTargetDepthBuffer=new THREE.WebGLRenderTarget(this.resolution.x,this.resolution.y,n),this.renderTargetDepthBuffer.texture.name="OutlinePass.depth",this.renderTargetDepthBuffer.texture.generateMipmaps=!1,this.renderTargetMaskDownSampleBuffer=new THREE.WebGLRenderTarget(o,a,n),this.renderTargetMaskDownSampleBuffer.texture.name="OutlinePass.depthDownSample",this.renderTargetMaskDownSampleBuffer.texture.generateMipmaps=!1,this.renderTargetBlurBuffer1=new THREE.WebGLRenderTarget(o,a,n),this.renderTargetBlurBuffer1.texture.name="OutlinePass.blur1",this.renderTargetBlurBuffer1.texture.generateMipmaps=!1,this.renderTargetBlurBuffer2=new THREE.WebGLRenderTarget(Math.round(o/2),Math.round(a/2),n),this.renderTargetBlurBuffer2.texture.name="OutlinePass.blur2",this.renderTargetBlurBuffer2.texture.generateMipmaps=!1,this.edgeDetectionMaterial=this.getEdgeDetectionMaterial(),this.renderTargetEdgeBuffer1=new THREE.WebGLRenderTarget(o,a,n),this.renderTargetEdgeBuffer1.texture.name="OutlinePass.edge1",this.renderTargetEdgeBuffer1.texture.generateMipmaps=!1,this.renderTargetEdgeBuffer2=new THREE.WebGLRenderTarget(Math.round(o/2),Math.round(a/2),n),this.renderTargetEdgeBuffer2.texture.name="OutlinePass.edge2",this.renderTargetEdgeBuffer2.texture.generateMipmaps=!1;this.separableBlurMaterial1=this.getSeperableBlurMaterial(4),this.separableBlurMaterial1.uniforms.texSize.value=new THREE.Vector2(o,a),this.separableBlurMaterial1.uniforms.kernelRadius.value=1,this.separableBlurMaterial2=this.getSeperableBlurMaterial(4),this.separableBlurMaterial2.uniforms.texSize.value=new THREE.Vector2(Math.round(o/2),Math.round(a/2)),this.separableBlurMaterial2.uniforms.kernelRadius.value=4,this.overlayMaterial=this.getOverlayMaterial(),THREE.CopyShader;var s=THREE.CopyShader;this.copyUniforms=THREE.UniformsUtils.clone(s.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new THREE.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:s.vertexShader,fragmentShader:s.fragmentShader,blending:THREE.NoBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this.oldClearColor=new THREE.Color,this.oldClearAlpha=1,this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad),this.tempPulseColor1=new THREE.Color,this.tempPulseColor2=new THREE.Color,this.textureMatrix=new THREE.Matrix4},THREE.OutlinePass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.OutlinePass,dispose:function(){this.renderTargetMaskBuffer.dispose(),this.renderTargetDepthBuffer.dispose(),this.renderTargetMaskDownSampleBuffer.dispose(),this.renderTargetBlurBuffer1.dispose(),this.renderTargetBlurBuffer2.dispose(),this.renderTargetEdgeBuffer1.dispose(),this.renderTargetEdgeBuffer2.dispose()},setSize:function(t,e){this.renderTargetMaskBuffer.setSize(t,e);var i=Math.round(t/this.downSampleRatio),r=Math.round(e/this.downSampleRatio);this.renderTargetMaskDownSampleBuffer.setSize(i,r),this.renderTargetBlurBuffer1.setSize(i,r),this.renderTargetEdgeBuffer1.setSize(i,r),this.separableBlurMaterial1.uniforms.texSize.value=new THREE.Vector2(i,r),i=Math.round(i/2),r=Math.round(r/2),this.renderTargetBlurBuffer2.setSize(i,r),this.renderTargetEdgeBuffer2.setSize(i,r),this.separableBlurMaterial2.uniforms.texSize.value=new THREE.Vector2(i,r)},changeVisibilityOfSelectedObjects:function(t){function e(e){e instanceof THREE.Mesh&&(e.visible=t)}for(var i=0;i<this.selectedObjects.length;i++){this.selectedObjects[i].traverse(e)}},changeVisibilityOfNonSelectedObjects:function(t){var e=[];function i(t){t instanceof THREE.Mesh&&e.push(t)}for(var r=0;r<this.selectedObjects.length;r++){this.selectedObjects[r].traverse(i)}this.renderScene.traverse(function(i){if(i instanceof THREE.Mesh||i instanceof THREE.Line||i instanceof THREE.Sprite){for(var r=!1,n=0;n<e.length;n++)if(e[n].id===i.id){r=!0;break}if(!r){var o=i.visible;t&&!i.bVisible||(i.visible=t),i.bVisible=o}}})},updateTextureMatrix:function(){this.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.renderCamera.projectionMatrix),this.textureMatrix.multiply(this.renderCamera.matrixWorldInverse)},render:function(t,e,i,r,n){if(0!==this.selectedObjects.length){this.oldClearColor.copy(t.getClearColor()),this.oldClearAlpha=t.getClearAlpha();var o=t.autoClear;t.autoClear=!1,n&&t.context.disable(t.context.STENCIL_TEST),t.setClearColor(16777215,1),this.changeVisibilityOfSelectedObjects(!1);var a=this.renderScene.background;if(this.renderScene.background=null,this.renderScene.overrideMaterial=this.depthMaterial,t.render(this.renderScene,this.renderCamera,this.renderTargetDepthBuffer,!0),this.changeVisibilityOfSelectedObjects(!0),this.updateTextureMatrix(),this.changeVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.prepareMaskMaterial,this.prepareMaskMaterial.uniforms.cameraNearFar.value=new THREE.Vector2(this.renderCamera.near,this.renderCamera.far),this.prepareMaskMaterial.uniforms.depthTexture.value=this.renderTargetDepthBuffer.texture,this.prepareMaskMaterial.uniforms.textureMatrix.value=this.textureMatrix,t.render(this.renderScene,this.renderCamera,this.renderTargetMaskBuffer,!0),this.renderScene.overrideMaterial=null,this.changeVisibilityOfNonSelectedObjects(!0),this.renderScene.background=a,this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetMaskBuffer.texture,t.render(this.scene,this.camera,this.renderTargetMaskDownSampleBuffer,!0),this.tempPulseColor1.copy(this.visibleEdgeColor),this.tempPulseColor2.copy(this.hiddenEdgeColor),this.pulsePeriod>0){var s=.625+.75*Math.cos(.01*performance.now()/this.pulsePeriod)/2;this.tempPulseColor1.multiplyScalar(s),this.tempPulseColor2.multiplyScalar(s)}this.quad.material=this.edgeDetectionMaterial,this.edgeDetectionMaterial.uniforms.maskTexture.value=this.renderTargetMaskDownSampleBuffer.texture,this.edgeDetectionMaterial.uniforms.texSize.value=new THREE.Vector2(this.renderTargetMaskDownSampleBuffer.width,this.renderTargetMaskDownSampleBuffer.height),this.edgeDetectionMaterial.uniforms.visibleEdgeColor.value=this.tempPulseColor1,this.edgeDetectionMaterial.uniforms.hiddenEdgeColor.value=this.tempPulseColor2,t.render(this.scene,this.camera,this.renderTargetEdgeBuffer1,!0),this.quad.material=this.separableBlurMaterial1,this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetEdgeBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=THREE.OutlinePass.BlurDirectionX,this.separableBlurMaterial1.uniforms.kernelRadius.value=this.edgeThickness,t.render(this.scene,this.camera,this.renderTargetBlurBuffer1,!0),this.separableBlurMaterial1.uniforms.colorTexture.value=this.renderTargetBlurBuffer1.texture,this.separableBlurMaterial1.uniforms.direction.value=THREE.OutlinePass.BlurDirectionY,t.render(this.scene,this.camera,this.renderTargetEdgeBuffer1,!0),this.quad.material=this.separableBlurMaterial2,this.separableBlurMaterial2.uniforms.colorTexture.value=this.renderTargetEdgeBuffer1.texture,this.separableBlurMaterial2.uniforms.direction.value=THREE.OutlinePass.BlurDirectionX,t.render(this.scene,this.camera,this.renderTargetBlurBuffer2,!0),this.separableBlurMaterial2.uniforms.colorTexture.value=this.renderTargetBlurBuffer2.texture,this.separableBlurMaterial2.uniforms.direction.value=THREE.OutlinePass.BlurDirectionY,t.render(this.scene,this.camera,this.renderTargetEdgeBuffer2,!0),this.quad.material=this.overlayMaterial,this.overlayMaterial.uniforms.maskTexture.value=this.renderTargetMaskBuffer.texture,this.overlayMaterial.uniforms.edgeTexture1.value=this.renderTargetEdgeBuffer1.texture,this.overlayMaterial.uniforms.edgeTexture2.value=this.renderTargetEdgeBuffer2.texture,this.overlayMaterial.uniforms.patternTexture.value=this.patternTexture,this.overlayMaterial.uniforms.edgeStrength.value=this.edgeStrength,this.overlayMaterial.uniforms.edgeGlow.value=this.edgeGlow,this.overlayMaterial.uniforms.usePatternTexture.value=this.usePatternTexture,n&&t.context.enable(t.context.STENCIL_TEST),t.render(this.scene,this.camera,i,!1),t.setClearColor(this.oldClearColor,this.oldClearAlpha),t.autoClear=o}},getPrepareMaskMaterial:function(){return new THREE.ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new THREE.Vector2(.5,.5)},textureMatrix:{value:new THREE.Matrix4}},vertexShader:"varying vec2 vUv;\t\t\t\tvarying vec4 projTexCoord;\t\t\t\tvarying vec4 vPosition;\t\t\t\tuniform mat4 textureMatrix;\t\t\t\tvoid main() {\t\t\t\t\tvUv = uv;\t\t\t\t\tvPosition = modelViewMatrix * vec4( position, 1.0 );\t\t\t\t\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\t\t\t\t\tprojTexCoord = textureMatrix * worldPosition;\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <packing>\t\t\t\tvarying vec2 vUv;\t\t\t\tvarying vec4 vPosition;\t\t\t\tvarying vec4 projTexCoord;\t\t\t\tuniform sampler2D depthTexture;\t\t\t\tuniform vec2 cameraNearFar;\t\t\t\t\t\t\t\tvoid main() {\t\t\t\t\tfloat depth = unpackRGBAToDepth(texture2DProj( depthTexture, projTexCoord ));\t\t\t\t\tfloat viewZ = -perspectiveDepthToViewZ( depth, cameraNearFar.x, cameraNearFar.y );\t\t\t\t\tfloat depthTest = (-vPosition.z > viewZ) ? 1.0 : 0.0;\t\t\t\t\tgl_FragColor = vec4(0.0, depthTest, 1.0, 1.0);\t\t\t\t}"})},getEdgeDetectionMaterial:function(){return new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},visibleEdgeColor:{value:new THREE.Vector3(1,1,1)},hiddenEdgeColor:{value:new THREE.Vector3(1,1,1)}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\t\t\t\tuniform sampler2D maskTexture;\t\t\t\tuniform vec2 texSize;\t\t\t\tuniform vec3 visibleEdgeColor;\t\t\t\tuniform vec3 hiddenEdgeColor;\t\t\t\t\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 invSize = 1.0 / texSize;\t\t\t\t\tvec4 uvOffset = vec4(1.0, 0.0, 0.0, 1.0) * vec4(invSize, invSize);\t\t\t\t\tvec4 c1 = texture2D( maskTexture, vUv + uvOffset.xy);\t\t\t\t\tvec4 c2 = texture2D( maskTexture, vUv - uvOffset.xy);\t\t\t\t\tvec4 c3 = texture2D( maskTexture, vUv + uvOffset.yw);\t\t\t\t\tvec4 c4 = texture2D( maskTexture, vUv - uvOffset.yw);\t\t\t\t\tfloat diff1 = (c1.r - c2.r)*0.5;\t\t\t\t\tfloat diff2 = (c3.r - c4.r)*0.5;\t\t\t\t\tfloat d = length( vec2(diff1, diff2) );\t\t\t\t\tfloat a1 = min(c1.g, c2.g);\t\t\t\t\tfloat a2 = min(c3.g, c4.g);\t\t\t\t\tfloat visibilityFactor = min(a1, a2);\t\t\t\t\tvec3 edgeColor = 1.0 - visibilityFactor > 0.001 ? visibleEdgeColor : hiddenEdgeColor;\t\t\t\t\tgl_FragColor = vec4(edgeColor, 1.0) * vec4(d);\t\t\t\t}"})},getSeperableBlurMaterial:function(t){return new THREE.ShaderMaterial({defines:{MAX_RADIUS:t},uniforms:{colorTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},direction:{value:new THREE.Vector2(.5,.5)},kernelRadius:{value:1}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\t\t\t\tvarying vec2 vUv;\t\t\t\tuniform sampler2D colorTexture;\t\t\t\tuniform vec2 texSize;\t\t\t\tuniform vec2 direction;\t\t\t\tuniform float kernelRadius;\t\t\t\t\t\t\t\tfloat gaussianPdf(in float x, in float sigma) {\t\t\t\t\treturn 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\t\t\t\t}\t\t\t\tvoid main() {\t\t\t\t\tvec2 invSize = 1.0 / texSize;\t\t\t\t\tfloat weightSum = gaussianPdf(0.0, kernelRadius);\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;\t\t\t\t\tvec2 delta = direction * invSize * kernelRadius/float(MAX_RADIUS);\t\t\t\t\tvec2 uvOffset = delta;\t\t\t\t\tfor( int i = 1; i <= MAX_RADIUS; i ++ ) {\t\t\t\t\t\tfloat w = gaussianPdf(uvOffset.x, kernelRadius);\t\t\t\t\t\tvec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;\t\t\t\t\t\tvec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;\t\t\t\t\t\tdiffuseSum += ((sample1 + sample2) * w);\t\t\t\t\t\tweightSum += (2.0 * w);\t\t\t\t\t\tuvOffset += delta;\t\t\t\t\t}\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, 1.0);\t\t\t\t}"})},getOverlayMaterial:function(){return new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},edgeTexture1:{value:null},edgeTexture2:{value:null},patternTexture:{value:null},edgeStrength:{value:1},edgeGlow:{value:1},usePatternTexture:{value:0}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\t\t\t\tuniform sampler2D maskTexture;\t\t\t\tuniform sampler2D edgeTexture1;\t\t\t\tuniform sampler2D edgeTexture2;\t\t\t\tuniform sampler2D patternTexture;\t\t\t\tuniform float edgeStrength;\t\t\t\tuniform float edgeGlow;\t\t\t\tuniform bool usePatternTexture;\t\t\t\t\t\t\t\tvoid main() {\t\t\t\t\tvec4 edgeValue1 = texture2D(edgeTexture1, vUv);\t\t\t\t\tvec4 edgeValue2 = texture2D(edgeTexture2, vUv);\t\t\t\t\tvec4 maskColor = texture2D(maskTexture, vUv);\t\t\t\t\tvec4 patternColor = texture2D(patternTexture, 6.0 * vUv);\t\t\t\t\tfloat visibilityFactor = 1.0 - maskColor.g > 0.0 ? 1.0 : 0.5;\t\t\t\t\tvec4 edgeValue = edgeValue1 + edgeValue2 * edgeGlow;\t\t\t\t\tvec4 finalColor = edgeStrength * maskColor.r * edgeValue;\t\t\t\t\tif(usePatternTexture)\t\t\t\t\t\tfinalColor += + visibilityFactor * (1.0 - maskColor.r) * (1.0 - patternColor.r);\t\t\t\t\tgl_FragColor = finalColor;\t\t\t\t}",blending:THREE.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0})}}),THREE.OutlinePass.BlurDirectionX=new THREE.Vector2(1,0),THREE.OutlinePass.BlurDirectionY=new THREE.Vector2(0,1),THREE.UnrealBloomPass=function(t,e,i,r){THREE.Pass.call(this),this.strength=void 0!==e?e:1,this.radius=i,this.threshold=r,this.resolution=void 0!==t?new THREE.Vector2(t.x,t.y):new THREE.Vector2(256,256);var n={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat};this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;var o=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2);this.renderTargetBright=new THREE.WebGLRenderTarget(o,a,n),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(var s=0;s<this.nMips;s++){var h;(h=new THREE.WebGLRenderTarget(o,a,n)).texture.name="UnrealBloomPass.h"+s,h.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(h),(h=new THREE.WebGLRenderTarget(o,a,n)).texture.name="UnrealBloomPass.v"+s,h.texture.generateMipmaps=!1,this.renderTargetsVertical.push(h),o=Math.round(o/2),a=Math.round(a/2)}THREE.LuminosityHighPassShader;var l=THREE.LuminosityHighPassShader;this.highPassUniforms=THREE.UniformsUtils.clone(l.uniforms),this.highPassUniforms.luminosityThreshold.value=r,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new THREE.ShaderMaterial({uniforms:this.highPassUniforms,vertexShader:l.vertexShader,fragmentShader:l.fragmentShader,defines:{}}),this.separableBlurMaterials=[];var c=[3,5,7,9,11];for(o=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2),s=0;s<this.nMips;s++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(c[s])),this.separableBlurMaterials[s].uniforms.texSize.value=new THREE.Vector2(o,a),o=Math.round(o/2),a=Math.round(a/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=e,this.compositeMaterial.uniforms.bloomRadius.value=.1,this.compositeMaterial.needsUpdate=!0;this.compositeMaterial.uniforms.bloomFactors.value=[1,.8,.6,.4,.2],this.bloomTintColors=[new THREE.Vector3(1,1,1),new THREE.Vector3(1,1,1),new THREE.Vector3(1,1,1),new THREE.Vector3(1,1,1),new THREE.Vector3(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,THREE.CopyShader;var u=THREE.CopyShader;this.copyUniforms=THREE.UniformsUtils.clone(u.uniforms),this.copyUniforms.opacity.value=1,this.materialCopy=new THREE.ShaderMaterial({uniforms:this.copyUniforms,vertexShader:u.vertexShader,fragmentShader:u.fragmentShader,blending:THREE.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this.oldClearColor=new THREE.Color,this.oldClearAlpha=1,this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)},THREE.UnrealBloomPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.UnrealBloomPass,dispose:function(){for(var t=0;t<this.renderTargetsHorizontal.length;t++)this.renderTargetsHorizontal[t].dispose();for(t=0;t<this.renderTargetsVertical.length;t++)this.renderTargetsVertical[t].dispose();this.renderTargetBright.dispose()},setSize:function(t,e){var i=Math.round(t/2),r=Math.round(e/2);this.renderTargetBright.setSize(i,r);for(var n=0;n<this.nMips;n++)this.renderTargetsHorizontal[n].setSize(i,r),this.renderTargetsVertical[n].setSize(i,r),this.separableBlurMaterials[n].uniforms.texSize.value=new THREE.Vector2(i,r),i=Math.round(i/2),r=Math.round(r/2)},render:function(t,e,i,r,n){this.oldClearColor.copy(t.getClearColor()),this.oldClearAlpha=t.getClearAlpha();var o=t.autoClear;t.autoClear=!1,t.setClearColor(new THREE.Color(0,0,0),0),n&&t.context.disable(t.context.STENCIL_TEST),this.highPassUniforms.tDiffuse.value=i.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.quad.material=this.materialHighPassFilter,t.render(this.scene,this.camera,this.renderTargetBright,!0);for(var a=this.renderTargetBright,s=0;s<this.nMips;s++)this.quad.material=this.separableBlurMaterials[s],this.separableBlurMaterials[s].uniforms.colorTexture.value=a.texture,this.separableBlurMaterials[s].uniforms.direction.value=THREE.UnrealBloomPass.BlurDirectionX,t.render(this.scene,this.camera,this.renderTargetsHorizontal[s],!0),this.separableBlurMaterials[s].uniforms.colorTexture.value=this.renderTargetsHorizontal[s].texture,this.separableBlurMaterials[s].uniforms.direction.value=THREE.UnrealBloomPass.BlurDirectionY,t.render(this.scene,this.camera,this.renderTargetsVertical[s],!0),a=this.renderTargetsVertical[s];this.quad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,t.render(this.scene,this.camera,this.renderTargetsHorizontal[0],!0),this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,n&&t.context.enable(t.context.STENCIL_TEST),t.render(this.scene,this.camera,i,!1),t.setClearColor(this.oldClearColor,this.oldClearAlpha),t.autoClear=o},getSeperableBlurMaterial:function(t){return new THREE.ShaderMaterial({defines:{KERNEL_RADIUS:t,SIGMA:t},uniforms:{colorTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},direction:{value:new THREE.Vector2(.5,.5)}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\t\t\t\tvarying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform vec2 texSize;\t\t\t\tuniform vec2 direction;\t\t\t\t\t\t\t\tfloat gaussianPdf(in float x, in float sigma) {\t\t\t\t\treturn 0.39894 * exp( -0.5 * x * x/( sigma * sigma))/sigma;\t\t\t\t}\t\t\t\tvoid main() {\n\t\t\t\t\tvec2 invSize = 1.0 / texSize;\t\t\t\t\tfloat fSigma = float(SIGMA);\t\t\t\t\tfloat weightSum = gaussianPdf(0.0, fSigma);\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv).rgb * weightSum;\t\t\t\t\tfor( int i = 1; i < KERNEL_RADIUS; i ++ ) {\t\t\t\t\t\tfloat x = float(i);\t\t\t\t\t\tfloat w = gaussianPdf(x, fSigma);\t\t\t\t\t\tvec2 uvOffset = direction * invSize * x;\t\t\t\t\t\tvec3 sample1 = texture2D( colorTexture, vUv + uvOffset).rgb;\t\t\t\t\t\tvec3 sample2 = texture2D( colorTexture, vUv - uvOffset).rgb;\t\t\t\t\t\tdiffuseSum += (sample1 + sample2) * w;\t\t\t\t\t\tweightSum += 2.0 * w;\t\t\t\t\t}\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, 1.0);\n\t\t\t\t}"})},getCompositeMaterial:function(t){return new THREE.ShaderMaterial({defines:{NUM_MIPS:t},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},dirtTexture:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\t\t\t\tuniform sampler2D blurTexture1;\t\t\t\tuniform sampler2D blurTexture2;\t\t\t\tuniform sampler2D blurTexture3;\t\t\t\tuniform sampler2D blurTexture4;\t\t\t\tuniform sampler2D blurTexture5;\t\t\t\tuniform sampler2D dirtTexture;\t\t\t\tuniform float bloomStrength;\t\t\t\tuniform float bloomRadius;\t\t\t\tuniform float bloomFactors[NUM_MIPS];\t\t\t\tuniform vec3 bloomTintColors[NUM_MIPS];\t\t\t\t\t\t\t\tfloat lerpBloomFactor(const in float factor) { \t\t\t\t\tfloat mirrorFactor = 1.2 - factor;\t\t\t\t\treturn mix(factor, mirrorFactor, bloomRadius);\t\t\t\t}\t\t\t\t\t\t\t\tvoid main() {\t\t\t\t\tgl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) + \t\t\t\t\t\t\t\t\t\t\t\t\t lerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );\t\t\t\t}"})}}),THREE.UnrealBloomPass.BlurDirectionX=new THREE.Vector2(1,0),THREE.UnrealBloomPass.BlurDirectionY=new THREE.Vector2(0,1),THREE.VREffect=function(t,e){var i,r,n,o,a=new THREE.Vector3,s=new THREE.Vector3,h=new THREE.Matrix4,l=new THREE.Matrix4,c=new THREE.Matrix4,u=null;"VRFrameData"in window&&(u=new window.VRFrameData),navigator.getVRDisplays&&navigator.getVRDisplays().then(function(t){r=t,t.length>0?i=t[0]:e&&e("HMD not available")}).catch(function(){}),this.isPresenting=!1;var p=this,d=t.getSize(),f=!1,m=t.getPixelRatio();this.getVRDisplay=function(){return i},this.setVRDisplay=function(t){i=t},this.getVRDisplays=function(){return r},this.setSize=function(e,r,n){if(d={width:e,height:r},f=n,p.isPresenting){var o=i.getEyeParameters("left");t.setPixelRatio(1),t.setSize(2*o.renderWidth,o.renderHeight,!1)}else t.setPixelRatio(m),t.setSize(e,r,n)};var g=t.domElement,v=[0,0,.5,1],y=[.5,0,.5,1];function E(){var e=p.isPresenting;if(p.isPresenting=void 0!==i&&i.isPresenting,p.isPresenting){var r=i.getEyeParameters("left"),n=r.renderWidth,o=r.renderHeight;e||(m=t.getPixelRatio(),d=t.getSize(),t.setPixelRatio(1),t.setSize(2*n,o,!1))}else e&&(t.setPixelRatio(m),t.setSize(d.width,d.height,f))}window.addEventListener("vrdisplaypresentchange",E,!1),this.setFullScreen=function(t){return new Promise(function(e,r){void 0!==i?p.isPresenting!==t?e(t?i.requestPresent([{source:g}]):i.exitPresent()):e():r(new Error("No VR hardware found."))})},this.requestPresent=function(){return this.setFullScreen(!0)},this.exitPresent=function(){return this.setFullScreen(!1)},this.requestAnimationFrame=function(t){return void 0!==i?i.requestAnimationFrame(t):window.requestAnimationFrame(t)},this.cancelAnimationFrame=function(t){void 0!==i?i.cancelAnimationFrame(t):window.cancelAnimationFrame(t)},this.submitFrame=function(){void 0!==i&&p.isPresenting&&i.submitFrame()},this.autoSubmitFrame=!0;var x=new THREE.PerspectiveCamera;x.layers.enable(1);var _=new THREE.PerspectiveCamera;_.layers.enable(2),this.render=function(e,r,d,f){if(i&&p.isPresenting){var m=e.autoUpdate;m&&(e.updateMatrixWorld(),e.autoUpdate=!1),Array.isArray(e)&&(e=e[0]);var g,E,T=t.getSize(),M=i.getLayers();if(M.length){var R=M[0];g=null!==R.leftBounds&&4===R.leftBounds.length?R.leftBounds:v,E=null!==R.rightBounds&&4===R.rightBounds.length?R.rightBounds:y}else g=v,E=y;if(n={x:Math.round(T.width*g[0]),y:Math.round(T.height*g[1]),width:Math.round(T.width*g[2]),height:Math.round(T.height*g[3])},o={x:Math.round(T.width*E[0]),y:Math.round(T.height*E[1]),width:Math.round(T.width*E[2]),height:Math.round(T.height*E[3])},d?(t.setRenderTarget(d),d.scissorTest=!0):(t.setRenderTarget(null),t.setScissorTest(!0)),(t.autoClear||f)&&t.clear(),null===r.parent&&r.updateMatrixWorld(),r.matrixWorld.decompose(x.position,x.quaternion,x.scale),_.position.copy(x.position),_.quaternion.copy(x.quaternion),_.scale.copy(x.scale),i.getFrameData)i.depthNear=r.near,i.depthFar=r.far,i.getFrameData(u),x.projectionMatrix.elements=u.leftProjectionMatrix,_.projectionMatrix.elements=u.rightProjectionMatrix,function(t){t.pose.orientation?(w.fromArray(t.pose.orientation),h.makeRotationFromQuaternion(w)):h.identity();t.pose.position&&(b.fromArray(t.pose.position),h.setPosition(b));l.fromArray(t.leftViewMatrix),l.multiply(h),c.fromArray(t.rightViewMatrix),c.multiply(h),l.getInverse(l),c.getInverse(c)}(u),x.updateMatrix(),x.matrix.multiply(l),x.matrix.decompose(x.position,x.quaternion,x.scale),_.updateMatrix(),_.matrix.multiply(c),_.matrix.decompose(_.position,_.quaternion,_.scale);else{var A=i.getEyeParameters("left"),C=i.getEyeParameters("right");x.projectionMatrix=S(A.fieldOfView,!0,r.near,r.far),_.projectionMatrix=S(C.fieldOfView,!0,r.near,r.far),a.fromArray(A.offset),s.fromArray(C.offset),x.translateOnAxis(a,x.scale.x),_.translateOnAxis(s,_.scale.x)}return d?(d.viewport.set(n.x,n.y,n.width,n.height),d.scissor.set(n.x,n.y,n.width,n.height)):(t.setViewport(n.x,n.y,n.width,n.height),t.setScissor(n.x,n.y,n.width,n.height)),t.render(e,x,d,f),d?(d.viewport.set(o.x,o.y,o.width,o.height),d.scissor.set(o.x,o.y,o.width,o.height)):(t.setViewport(o.x,o.y,o.width,o.height),t.setScissor(o.x,o.y,o.width,o.height)),t.render(e,_,d,f),d?(d.viewport.set(0,0,T.width,T.height),d.scissor.set(0,0,T.width,T.height),d.scissorTest=!1,t.setRenderTarget(null)):(t.setViewport(0,0,T.width,T.height),t.setScissorTest(!1)),m&&(e.autoUpdate=!0),void(p.autoSubmitFrame&&p.submitFrame())}t.render(e,r,d,f)},this.dispose=function(){window.removeEventListener("vrdisplaypresentchange",E,!1)};var w=new THREE.Quaternion,b=new THREE.Vector3;function S(t,e,i,r){var n=Math.PI/180;return function(t,e,i,r){e=void 0===e||e,i=void 0===i?.01:i,r=void 0===r?1e4:r;var n=e?-1:1,o=new THREE.Matrix4,a=o.elements,s=function(t){var e=2/(t.leftTan+t.rightTan),i=(t.leftTan-t.rightTan)*e*.5,r=2/(t.upTan+t.downTan);return{scale:[e,r],offset:[i,(t.upTan-t.downTan)*r*.5]}}(t);return a[0]=s.scale[0],a[1]=0,a[2]=s.offset[0]*n,a[3]=0,a[4]=0,a[5]=s.scale[1],a[6]=-s.offset[1]*n,a[7]=0,a[8]=0,a[9]=0,a[10]=r/(i-r)*-n,a[11]=r*i/(i-r),a[12]=0,a[13]=0,a[14]=n,a[15]=0,o.transpose(),o}({upTan:Math.tan(t.upDegrees*n),downTan:Math.tan(t.downDegrees*n),leftTan:Math.tan(t.leftDegrees*n),rightTan:Math.tan(t.rightDegrees*n)},e,i,r)}},THREE.VRControls=function(t,e){var i,r,n=this,o=new THREE.Matrix4,a=null;"VRFrameData"in window&&(a=new VRFrameData),navigator.getVRDisplays&&navigator.getVRDisplays().then(function(t){r=t,t.length>0?i=t[0]:e&&e("VR input not available.")}).catch(function(){}),this.scale=1,this.standing=!1,this.userHeight=1.6,this.getVRDisplay=function(){return i},this.setVRDisplay=function(t){i=t},this.getVRDisplays=function(){return r},this.getStandingMatrix=function(){return o},this.update=function(){var e;i&&(i.getFrameData?(i.getFrameData(a),e=a.pose):i.getPose&&(e=i.getPose()),null!==e.orientation&&t.quaternion.fromArray(e.orientation),null!==e.position?t.position.fromArray(e.position):t.position.set(0,0,0),this.standing&&(i.stageParameters?(t.updateMatrix(),o.fromArray(i.stageParameters.sittingToStandingTransform),t.applyMatrix(o)):t.position.setY(t.position.y+this.userHeight)),t.position.multiplyScalar(n.scale))},this.dispose=function(){i=null}},THREE.OBJLoader=function(){var t=/^[og]\s*(.+)?/,e=/^mtllib /,i=/^usemtl /;function r(t){this.manager=void 0!==t?t:THREE.DefaultLoadingManager,this.materials=null}return r.prototype={constructor:r,load:function(t,e,i,r){var n=this,o=new THREE.FileLoader(n.manager);o.setPath(this.path),o.load(t,function(t){e(n.parse(t))},i,r)},setPath:function(t){this.path=t},setMaterials:function(t){return this.materials=t,this},parse:function(r){var n=new function(){var t={objects:[],object:{},vertices:[],normals:[],uvs:[],materialLibraries:[],startObject:function(t,e){if(this.object&&!1===this.object.fromDeclaration)return this.object.name=t,void(this.object.fromDeclaration=!1!==e);var i=this.object&&"function"==typeof this.object.currentMaterial?this.object.currentMaterial():void 0;if(this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0),this.object={name:t||"",fromDeclaration:!1!==e,geometry:{vertices:[],normals:[],uvs:[]},materials:[],smooth:!0,startMaterial:function(t,e){var i=this._finalize(!1);i&&(i.inherited||i.groupCount<=0)&&this.materials.splice(i.index,1);var r={index:this.materials.length,name:t||"",mtllib:Array.isArray(e)&&e.length>0?e[e.length-1]:"",smooth:void 0!==i?i.smooth:this.smooth,groupStart:void 0!==i?i.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(t){var e={index:"number"==typeof t?t:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:0,groupEnd:-1,groupCount:-1,inherited:!1};return e.clone=this.clone.bind(e),e}};return this.materials.push(r),r},currentMaterial:function(){if(this.materials.length>0)return this.materials[this.materials.length-1]},_finalize:function(t){var e=this.currentMaterial();if(e&&-1===e.groupEnd&&(e.groupEnd=this.geometry.vertices.length/3,e.groupCount=e.groupEnd-e.groupStart,e.inherited=!1),t&&this.materials.length>1)for(var i=this.materials.length-1;i>=0;i--)this.materials[i].groupCount<=0&&this.materials.splice(i,1);return t&&0===this.materials.length&&this.materials.push({name:"",smooth:this.smooth}),e}},i&&i.name&&"function"==typeof i.clone){var r=i.clone(0);r.inherited=!0,this.object.materials.push(r)}this.objects.push(this.object)},finalize:function(){this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0)},parseVertexIndex:function(t,e){var i=parseInt(t,10);return 3*(i>=0?i-1:i+e/3)},parseNormalIndex:function(t,e){var i=parseInt(t,10);return 3*(i>=0?i-1:i+e/3)},parseUVIndex:function(t,e){var i=parseInt(t,10);return 2*(i>=0?i-1:i+e/2)},addVertex:function(t,e,i){var r=this.vertices,n=this.object.geometry.vertices;n.push(r[t+0],r[t+1],r[t+2]),n.push(r[e+0],r[e+1],r[e+2]),n.push(r[i+0],r[i+1],r[i+2])},addVertexLine:function(t){var e=this.vertices;this.object.geometry.vertices.push(e[t+0],e[t+1],e[t+2])},addNormal:function(t,e,i){var r=this.normals,n=this.object.geometry.normals;n.push(r[t+0],r[t+1],r[t+2]),n.push(r[e+0],r[e+1],r[e+2]),n.push(r[i+0],r[i+1],r[i+2])},addUV:function(t,e,i){var r=this.uvs,n=this.object.geometry.uvs;n.push(r[t+0],r[t+1]),n.push(r[e+0],r[e+1]),n.push(r[i+0],r[i+1])},addUVLine:function(t){var e=this.uvs;this.object.geometry.uvs.push(e[t+0],e[t+1])},addFace:function(t,e,i,r,n,o,a,s,h){var l=this.vertices.length,c=this.parseVertexIndex(t,l),u=this.parseVertexIndex(e,l),p=this.parseVertexIndex(i,l);if(this.addVertex(c,u,p),void 0!==r){var d=this.uvs.length;c=this.parseUVIndex(r,d),u=this.parseUVIndex(n,d),p=this.parseUVIndex(o,d),this.addUV(c,u,p)}if(void 0!==a){var f=this.normals.length;c=this.parseNormalIndex(a,f),u=a===s?c:this.parseNormalIndex(s,f),p=a===h?c:this.parseNormalIndex(h,f),this.addNormal(c,u,p)}},addLineGeometry:function(t,e){this.object.geometry.type="Line";for(var i=this.vertices.length,r=this.uvs.length,n=0,o=t.length;n<o;n++)this.addVertexLine(this.parseVertexIndex(t[n],i));var a=0;for(o=e.length;a<o;a++)this.addUVLine(this.parseUVIndex(e[a],r))}};return t.startObject("",!1),t};-1!==r.indexOf("\r\n")&&(r=r.replace(/\r\n/g,"\n")),-1!==r.indexOf("\\\n")&&(r=r.replace(/\\\n/g,""));for(var o=r.split("\n"),a="",s="",h=[],l="function"==typeof"".trimLeft,c=0,u=o.length;c<u;c++)if(a=o[c],0!==(a=l?a.trimLeft():a.trim()).length&&"#"!==(s=a.charAt(0)))if("v"===s){var p=a.split(/\s+/);switch(p[0]){case"v":n.vertices.push(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3]));break;case"vn":n.normals.push(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3]));break;case"vt":n.uvs.push(parseFloat(p[1]),parseFloat(p[2]))}}else if("f"===s){for(var d=a.substr(1).trim().split(/\s+/),f=[],m=0,g=d.length;m<g;m++){var v=d[m];if(v.length>0){var y=v.split("/");f.push(y)}}var E=f[0];for(m=1,g=f.length-1;m<g;m++){var x=f[m],_=f[m+1];n.addFace(E[0],x[0],_[0],E[1],x[1],_[1],E[2],x[2],_[2])}}else if("l"===s){var w=a.substring(1).trim().split(" "),b=[],S=[];if(-1===a.indexOf("/"))b=w;else for(var T=0,M=w.length;T<M;T++){var R=w[T].split("/");""!==R[0]&&b.push(R[0]),""!==R[1]&&S.push(R[1])}n.addLineGeometry(b,S)}else if(null!==(h=t.exec(a))){var A=(" "+h[0].substr(1).trim()).substr(1);n.startObject(A)}else if(i.test(a))n.object.startMaterial(a.substring(7).trim(),n.materialLibraries);else if(e.test(a))n.materialLibraries.push(a.substring(7).trim());else{if("s"!==s){if("\0"===a)continue;throw new Error("Unexpected line: '"+a+"'")}if((h=a.split(" ")).length>1){var C=h[1].trim().toLowerCase();n.object.smooth="0"!==C&&"off"!==C}else n.object.smooth=!0;(V=n.object.currentMaterial())&&(V.smooth=n.object.smooth)}n.finalize();var P=new THREE.Group;P.materialLibraries=[].concat(n.materialLibraries);for(c=0,u=n.objects.length;c<u;c++){var D=n.objects[c],L=D.geometry,O=D.materials,H="Line"===L.type;if(0!==L.vertices.length){var I=new THREE.BufferGeometry;I.addAttribute("position",new THREE.BufferAttribute(new Float32Array(L.vertices),3)),L.normals.length>0?I.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(L.normals),3)):I.computeVertexNormals(),L.uvs.length>0&&I.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(L.uvs),2));for(var B,z=[],N=0,k=O.length;N<k;N++){var j=O[N],V=void 0;if(null!==this.materials&&(V=this.materials.create(j.name),H&&V&&!(V instanceof THREE.LineBasicMaterial))){var F=new THREE.LineBasicMaterial;F.copy(V),V=F}V||((V=H?new THREE.LineBasicMaterial:new THREE.MeshPhongMaterial).name=j.name),V.flatShading=!j.smooth,z.push(V)}if(z.length>1){for(N=0,k=O.length;N<k;N++){j=O[N];I.addGroup(j.groupStart,j.groupCount,N)}B=H?new THREE.LineSegments(I,z):new THREE.Mesh(I,z)}else B=H?new THREE.LineSegments(I,z[0]):new THREE.Mesh(I,z[0]);B.name=D.name,P.add(B)}}return P}},r}(),THREE.MTLLoader=function(t){this.manager=void 0!==t?t:THREE.DefaultLoadingManager},THREE.MTLLoader.prototype={constructor:THREE.MTLLoader,load:function(t,e,i,r){var n=this,o=new THREE.FileLoader(this.manager);o.setPath(this.path),o.load(t,function(t){e(n.parse(t))},i,r)},setPath:function(t){this.path=t},setTexturePath:function(t){this.texturePath=t},setBaseUrl:function(t){this.setTexturePath(t)},setCrossOrigin:function(t){this.crossOrigin=t},setMaterialOptions:function(t){this.materialOptions=t},parse:function(t){for(var e=t.split("\n"),i={},r=/\s+/,n={},o=0;o<e.length;o++){var a=e[o];if(0!==(a=a.trim()).length&&"#"!==a.charAt(0)){var s=a.indexOf(" "),h=s>=0?a.substring(0,s):a;h=h.toLowerCase();var l=s>=0?a.substring(s+1):"";if(l=l.trim(),"newmtl"===h)i={name:l},n[l]=i;else if(i)if("ka"===h||"kd"===h||"ks"===h){var c=l.split(r,3);i[h]=[parseFloat(c[0]),parseFloat(c[1]),parseFloat(c[2])]}else i[h]=l}}var u=new THREE.MTLLoader.MaterialCreator(this.texturePath||this.path,this.materialOptions);return u.setCrossOrigin(this.crossOrigin),u.setManager(this.manager),u.setMaterials(n),u}},THREE.MTLLoader.MaterialCreator=function(t,e){this.baseUrl=t||"",this.options=e,this.materialsInfo={},this.materials={},this.materialsArray=[],this.nameLookup={},this.side=this.options&&this.options.side?this.options.side:THREE.FrontSide,this.wrap=this.options&&this.options.wrap?this.options.wrap:THREE.RepeatWrapping},THREE.MTLLoader.MaterialCreator.prototype={constructor:THREE.MTLLoader.MaterialCreator,crossOrigin:"Anonymous",setCrossOrigin:function(t){this.crossOrigin=t},setManager:function(t){this.manager=t},setMaterials:function(t){this.materialsInfo=this.convert(t),this.materials={},this.materialsArray=[],this.nameLookup={}},convert:function(t){if(!this.options)return t;var e={};for(var i in t){var r=t[i],n={};for(var o in e[i]=n,r){var a=!0,s=r[o],h=o.toLowerCase();switch(h){case"kd":case"ka":case"ks":this.options&&this.options.normalizeRGB&&(s=[s[0]/255,s[1]/255,s[2]/255]),this.options&&this.options.ignoreZeroRGBs&&0===s[0]&&0===s[1]&&0===s[2]&&(a=!1)}a&&(n[h]=s)}}return e},preload:function(){for(var t in this.materialsInfo)this.create(t)},getIndex:function(t){return this.nameLookup[t]},getAsArray:function(){var t=0;for(var e in this.materialsInfo)this.materialsArray[t]=this.create(e),this.nameLookup[e]=t,t++;return this.materialsArray},create:function(t){return void 0===this.materials[t]&&this.createMaterial_(t),this.materials[t]},createMaterial_:function(t){var e=this,i=this.materialsInfo[t],r={name:t,side:this.side};function n(t,i){if(!r[t]){var n,o,a=e.getTextureParams(i,r),s=e.loadTexture((n=e.baseUrl,"string"!=typeof(o=a.url)||""===o?"":/^https?:\/\//i.test(o)?o:n+o));s.repeat.copy(a.scale),s.offset.copy(a.offset),s.wrapS=e.wrap,s.wrapT=e.wrap,r[t]=s}}for(var o in i){var a,s=i[o];if(""!==s)switch(o.toLowerCase()){case"kd":r.color=(new THREE.Color).fromArray(s);break;case"ks":r.specular=(new THREE.Color).fromArray(s);break;case"map_kd":n("map",s);break;case"map_ks":n("specularMap",s);break;case"norm":n("normalMap",s);break;case"map_bump":case"bump":n("bumpMap",s);break;case"ns":r.shininess=parseFloat(s);break;case"d":(a=parseFloat(s))<1&&(r.opacity=a,r.transparent=!0);break;case"tr":(a=parseFloat(s))>0&&(r.opacity=1-a,r.transparent=!0)}}return this.materials[t]=new THREE.MeshPhongMaterial(r),this.materials[t]},getTextureParams:function(t,e){var i,r={scale:new THREE.Vector2(1,1),offset:new THREE.Vector2(0,0)},n=t.split(/\s+/);return(i=n.indexOf("-bm"))>=0&&(e.bumpScale=parseFloat(n[i+1]),n.splice(i,2)),(i=n.indexOf("-s"))>=0&&(r.scale.set(parseFloat(n[i+1]),parseFloat(n[i+2])),n.splice(i,4)),(i=n.indexOf("-o"))>=0&&(r.offset.set(parseFloat(n[i+1]),parseFloat(n[i+2])),n.splice(i,4)),r.url=n.join(" ").trim(),r},loadTexture:function(t,e,i,r,n){var o,a=THREE.Loader.Handlers.get(t),s=void 0!==this.manager?this.manager:THREE.DefaultLoadingManager;return null===a&&(a=new THREE.TextureLoader(s)),a.setCrossOrigin&&a.setCrossOrigin(this.crossOrigin),o=a.load(t,i,r,n),void 0!==e&&(o.mapping=e),o}},THREE.DDSLoader=function(){this._parser=THREE.DDSLoader.parse},THREE.DDSLoader.prototype=Object.create(THREE.CompressedTextureLoader.prototype),THREE.DDSLoader.prototype.constructor=THREE.DDSLoader,THREE.DDSLoader.parse=function(t,e){var i={mipmaps:[],width:0,height:0,format:null,mipmapCount:1};function r(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}function n(t,e,i,r){for(var n=i*r*4,o=new Uint8Array(t,e,n),a=new Uint8Array(n),s=0,h=0,l=0;l<r;l++)for(var c=0;c<i;c++){var u=o[h],p=o[++h],d=o[++h],f=o[++h];h++,a[s]=d,a[++s]=p,a[++s]=u,a[++s]=f,s++}return a}var o,a=r("DXT1"),s=r("DXT3"),h=r("DXT5"),l=r("ETC1"),c=new Int32Array(t,0,31);if(542327876!==c[0])return i;if(4&!c[20])return i;var u=!1;switch(c[21]){case a:o=8,i.format=THREE.RGB_S3TC_DXT1_Format;break;case s:o=16,i.format=THREE.RGBA_S3TC_DXT3_Format;break;case h:o=16,i.format=THREE.RGBA_S3TC_DXT5_Format;break;case l:o=8,i.format=THREE.RGB_ETC1_Format;break;default:if(!(32===c[22]&&16711680&c[23]&&65280&c[24]&&255&c[25]&&4278190080&c[26]))return i;u=!0,o=64,i.format=THREE.RGBAFormat}i.mipmapCount=1,131072&c[2]&&!1!==e&&(i.mipmapCount=Math.max(1,c[7]));var p=c[28];if(i.isCubemap=!!(512&p),i.isCubemap&&(!(1024&p)||!(2048&p)||!(4096&p)||!(8192&p)||!(16384&p)||!(32768&p)))return i;i.width=c[4],i.height=c[3];for(var d=c[1]+4,f=i.isCubemap?6:1,m=0;m<f;m++)for(var g=i.width,v=i.height,y=0;y<i.mipmapCount;y++){if(u)var E=(x=n(t,d,g,v)).length;else{E=Math.max(4,g)/4*Math.max(4,v)/4*o;var x=new Uint8Array(t,d,E)}var _={data:x,width:g,height:v};i.mipmaps.push(_),d+=E,g=Math.max(g>>1,1),v=Math.max(v>>1,1)}return i},function(){function t(t){var e,i=t.properties.Content,r=t.properties.RelativeFilename||t.properties.Filename;switch(r.slice(r.lastIndexOf(".")+1).toLowerCase()){case"bmp":e="image/bmp";break;case"jpg":e="image/jpeg";break;case"png":e="image/png";break;case"tif":e="image/tiff";break;default:return}if("string"==typeof i)return"data:"+e+";base64,"+i;var n=new Uint8Array(i);return window.URL.createObjectURL(new Blob([n],{type:e}))}function e(t,e,i,r){var n,o=t.id,a=t.name,s=t.properties.FileName,h=t.properties.RelativeFilename,l=r.get(o).children;if(void 0!==l&&l.length>0&&i.has(l[0].ID))n=i.get(l[0].ID);else if(void 0!==h&&"/"!==h[0]&&null===h.match(/^[a-zA-Z]:/))n=h;else{var c=s.split(/[\\\/]/);n=c.length>0?c[c.length-1]:s}var u=e.path;0!==n.indexOf("blob:")&&0!==n.indexOf("data:")||e.setPath(void 0);var p=e.load(n);p.name=a,p.FBX_ID=o;var d=t.properties.WrapModeU,f=t.properties.WrapModeV,m=void 0!==d?d.value:0,g=void 0!==f?f.value:0;return p.wrapS=0===m?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,p.wrapT=0===g?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,e.setPath(u),p}function i(t,e,i){var r=t.id,n=t.attrName,o=t.properties.ShadingModel;"object"==typeof o&&(o=o.value);var a,s=i.get(r).children,h=function(t,e,i){var r={};t.Diffuse&&(r.color=L(t.Diffuse));t.Specular&&(r.specular=L(t.Specular));t.Shininess&&(r.shininess=t.Shininess.value);t.Emissive&&(r.emissive=L(t.Emissive));t.EmissiveFactor&&(r.emissiveIntensity=t.EmissiveFactor.value);t.Opacity&&(r.opacity=t.Opacity.value);r.opacity<1&&(r.transparent=!0);for(var n=0,o=i.length;n<o;++n){var a=i[n],s=a.relationship;switch(s){case"DiffuseColor":case' "DiffuseColor':r.map=e.get(a.ID);break;case"Bump":case' "Bump':r.bumpMap=e.get(a.ID);break;case"NormalMap":case' "NormalMap':r.normalMap=e.get(a.ID)}}return r}(t.properties,e,s);switch(o.toLowerCase()){case"phong":a=new THREE.MeshPhongMaterial;break;case"lambert":a=new THREE.MeshLambertMaterial;break;default:a=new THREE.MeshBasicMaterial({color:3342591})}return a.setValues(h),a.name=n,a}function r(t,e){for(var i={},r=t.children,n=0,o=r.length;n<o;++n){var a=r[n],s=e[a.ID],h={FBX_ID:a.ID,index:n,indices:[],weights:[],transform:O(s.subNodes.Transform.properties.a),transformLink:O(s.subNodes.TransformLink.properties.a),linkMode:s.properties.Mode};"Indexes"in s.subNodes&&(h.indices=P(s.subNodes.Indexes.properties.a),h.weights=C(s.subNodes.Weights.properties.a)),i[a.ID]=h}return{map:i,bones:[]}}function n(t,e,i){switch(t.attrType){case"Mesh":return function(t,e,i){for(var r=0;r<e.children.length;++r){var n=i[e.children[r].ID];if(void 0!==n)break}return function(t,e){var i=new w,r=t.subNodes,n=C(r.Vertices.properties.a),o=P(r.PolygonVertexIndex.properties.a);if(r.LayerElementNormal)var a=function(t){var e=t.properties.MappingInformationType,i=t.properties.ReferenceInformationType,r=C(t.subNodes.Normals.properties.a),n=[];"IndexToDirect"===i&&("NormalIndex"in t.subNodes?n=P(t.subNodes.NormalIndex.properties.a):"NormalsIndex"in t.subNodes&&(n=P(t.subNodes.NormalsIndex.properties.a)));return{dataSize:3,buffer:r,indices:n,mappingType:e,referenceType:i}}(r.LayerElementNormal[0]);if(r.LayerElementUV)var h=function(t){var e=t.properties.MappingInformationType,i=t.properties.ReferenceInformationType,r=C(t.subNodes.UV.properties.a),n=[];"IndexToDirect"===i&&(n=P(t.subNodes.UVIndex.properties.a));return{dataSize:2,buffer:r,indices:n,mappingType:e,referenceType:i}}(r.LayerElementUV[0]);if(r.LayerElementColor)var l=function(t){var e=t.properties.MappingInformationType,i=t.properties.ReferenceInformationType,r=C(t.subNodes.Colors.properties.a),n=[];"IndexToDirect"===i&&(n=C(t.subNodes.ColorIndex.properties.a));return{dataSize:4,buffer:r,indices:n,mappingType:e,referenceType:i}}(r.LayerElementColor[0]);if(r.LayerElementMaterial)var c=function(t){var e=t.properties.MappingInformationType,i=t.properties.ReferenceInformationType;if("NoMappingInformation"===e)return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:i};for(var r=P(t.subNodes.Materials.properties.a),n=[],o=0,a=r.length;o<a;++o)n.push(o);return{dataSize:1,buffer:r,indices:n,mappingType:e,referenceType:i}}(r.LayerElementMaterial[0]);var u={};if(e){var p=e.map;for(var d in p)for(var f=p[d],m=f.indices,g=0;g<m.length;g++){var v=m[g],y=f.weights[g];void 0===u[v]&&(u[v]=[]),u[v].push({id:f.index,weight:y})}}for(var x=[],b=0,S=!1,T=0;T<o.length;T++){var M=o[T],R=!1;M<0&&(M^=-1,o[T]=M,R=!0);var A=new E,D=[],L=[];if(A.position.fromArray(n,3*M),e){if(void 0!==u[M])for(var O=u[M],g=0,H=O.length;g<H;g++)L.push(O[g].weight),D.push(O[g].id);if(L.length>4){S||(S=!0);var I=[0,0,0,0],B=[0,0,0,0];L.forEach(function(t,e){var i=t,r=D[e];B.forEach(function(t,e,n){if(i>t){n[e]=i,i=t;var o=I[e];I[e]=r,r=o}})}),D=I,L=B}for(var z=L.length;z<4;++z)L[z]=0,D[z]=0;A.skinWeights.fromArray(L),A.skinIndices.fromArray(D)}if(a&&A.normal.fromArray(s(T,b,M,a)),h&&A.uv.fromArray(s(T,b,M,h)),l&&A.color.fromArray(s(T,b,M,l)),x.push(A),R){var N=new _;if(N.genTrianglesFromVertices(x),void 0!==c){var k=s(T,b,M,c);N.materialIndex=k[0]}else N.materialIndex=0;i.faces.push(N),x=[],b++,R=!1}}var j=i.flattenToBuffers(),V=new THREE.BufferGeometry;V.name=t.name,V.addAttribute("position",new THREE.Float32BufferAttribute(j.vertexBuffer,3)),j.normalBuffer.length>0&&V.addAttribute("normal",new THREE.Float32BufferAttribute(j.normalBuffer,3));j.uvBuffer.length>0&&V.addAttribute("uv",new THREE.Float32BufferAttribute(j.uvBuffer,2));r.LayerElementColor&&V.addAttribute("color",new THREE.Float32BufferAttribute(j.colorBuffer,3));e&&(V.addAttribute("skinIndex",new THREE.Float32BufferAttribute(j.skinIndexBuffer,4)),V.addAttribute("skinWeight",new THREE.Float32BufferAttribute(j.skinWeightBuffer,4)),V.FBX_Deformer=e);for(var F=j.materialIndexBuffer,U=F[0],G=0,z=0;z<F.length;++z)F[z]!==U&&(V.addGroup(G,z-G,U),U=F[z],G=z);return V}(t,n)}(t,e,i);case"NurbsCurve":return function(t){if(void 0===THREE.NURBSCurve)return new THREE.BufferGeometry;var e=parseInt(t.properties.Order);if(isNaN(e))return new THREE.BufferGeometry;for(var i,r,n=e-1,o=C(t.subNodes.KnotVector.properties.a),a=[],s=C(t.subNodes.Points.properties.a),h=0,l=s.length;h<l;h+=4)a.push((new THREE.Vector4).fromArray(s,h));if("Closed"===t.properties.Form)a.push(a[0]);else if("Periodic"===t.properties.Form){i=n,r=o.length-1-i;for(var h=0;h<n;++h)a.push(a[h])}for(var c=new THREE.NURBSCurve(n,o,a,i,r).getPoints(7*a.length),u=new Float32Array(3*c.length),h=0,l=c.length;h<l;++h)c[h].toArray(u,3*h);var p=new THREE.BufferGeometry;return p.addAttribute("position",new THREE.BufferAttribute(u,3)),p}(t)}}THREE.FBXLoader=function(t){this.manager=void 0!==t?t:THREE.DefaultLoadingManager},Object.assign(THREE.FBXLoader.prototype,{load:function(t,e,i,r){var n=this,o=THREE.Loader.prototype.extractUrlBase(t),a=new THREE.FileLoader(this.manager);a.setResponseType("arraybuffer"),a.load(t,function(i){try{var a=n.parse(i,o);e(a)}catch(e){window.setTimeout(function(){r&&r(e),n.manager.itemError(t)},0)}},i,r)},parse:function(o,a){var s,u,p;if(p="Kaydara FBX Binary  \0",(u=o).byteLength>=p.length&&p===H(u,0,p.length))s=(new S).parse(o);else{var d=H(o);if(!function(t){var e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"],i=0;function r(e){var r=t[e-1];return t=t.slice(i+e),i++,r}for(var n=0;n<e.length;++n){var o=r(1);if(o===e[n])return!1}return!0}(d))throw new Error("THREE.FBXLoader: Unknown format.");if(R(d)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+R(d));s=(new b).parse(d)}var f=function(t){var e=new Map;if("Connections"in t)for(var i=t.Connections.properties.connections,r=0,n=i.length;r<n;++r){var o=i[r];e.has(o[0])||e.set(o[0],{parents:[],children:[]});var a={ID:o[1],relationship:o[2]};e.get(o[0]).parents.push(a),e.has(o[1])||e.set(o[1],{parents:[],children:[]});var s={ID:o[0],relationship:o[2]};e.get(o[1]).children.push(s)}return e}(s),g=function(e){var i=new Map;if("Video"in e.Objects.subNodes){var r=e.Objects.subNodes.Video;for(var n in r){var o=r[n];if("Content"in o.properties){var a=t(r[n]);i.set(parseInt(n),a)}}}return i}(s),v=function(t,e,r){var n=new Map;if("Material"in t.Objects.subNodes){var o=t.Objects.subNodes.Material;for(var a in o){var s=i(o[a],e,r);n.set(parseInt(a),s)}}return n}(s,function(t,i,r,n){var o=new Map;if("Texture"in t.Objects.subNodes){var a=t.Objects.subNodes.Texture;for(var s in a){var h=e(a[s],i,r,n);o.set(parseInt(s),h)}}return o}(s,new THREE.TextureLoader(this.manager).setPath(a),g,f),f),y=function(t,e){var i={};if("Deformer"in t.Objects.subNodes){var n=t.Objects.subNodes.Deformer;for(var o in n){var a=n[o];if("Skin"===a.attrType){var s=e.get(parseInt(o)),h=r(s,n);h.FBX_ID=parseInt(o),i[o]=h}}}return i}(s,f);return function(t,e,i,r,n){var o=new THREE.Group,a=t.Objects.subNodes.Model,s=[],u=new Map;for(var p in a){for(var d=parseInt(p),f=a[p],g=e.get(d),v=null,y=0;y<g.parents.length;++y)for(var E in i){var x=i[E],_=x.map,w=_[g.parents[y].ID];if(w){var b=v;v=new THREE.Bone,x.bones[w.index]=v,null!==b&&v.add(b)}}if(!v)switch(f.attrType){case"Mesh":for(var S=null,T=null,M=[],R=0,A=g.children.length;R<A;++R){var P=g.children[R];r.has(P.ID)&&(S=r.get(P.ID)),n.has(P.ID)&&M.push(n.get(P.ID))}if(M.length>1?T=M:M.length>0?T=M[0]:(T=new THREE.MeshBasicMaterial({color:3342591}),M.push(T)),"color"in S.attributes)for(var L=0,H=M.length;L<H;++L)M[L].vertexColors=THREE.VertexColors;if(S.FBX_Deformer){for(var N=0,k=M.length;N<k;++N)M[N].skinning=!0;v=new THREE.SkinnedMesh(S,T)}else v=new THREE.Mesh(S,T);break;case"NurbsCurve":for(var S=null,R=0,A=g.children.length;R<A;++R){var P=g.children[R];r.has(P.ID)&&(S=r.get(P.ID))}T=new THREE.LineBasicMaterial({color:3342591,linewidth:5}),v=new THREE.Line(S,T);break;default:v=new THREE.Object3D}v.name=f.attrName.replace(/:/,"").replace(/_/,"").replace(/-/,""),v.FBX_ID=d,s.push(v),u.set(d,v)}for(var j=0,V=s.length;j<V;++j){var v=s[j],f=a[v.FBX_ID];if("Lcl_Translation"in f.properties&&v.position.fromArray(C(f.properties.Lcl_Translation.value)),"Lcl_Rotation"in f.properties){var F=C(f.properties.Lcl_Rotation.value).map(I);F.push("ZYX"),v.rotation.fromArray(F)}if("Lcl_Scaling"in f.properties&&v.scale.fromArray(C(f.properties.Lcl_Scaling.value)),"PreRotation"in f.properties){var U=(new THREE.Euler).setFromVector3(D(f.properties.PreRotation).multiplyScalar(B),"ZYX");U=(new THREE.Quaternion).setFromEuler(U);var G=(new THREE.Quaternion).setFromEuler(v.rotation);U.multiply(G),v.rotation.setFromQuaternion(U,"ZYX")}for(var g=e.get(v.FBX_ID),W=0;W<g.parents.length;W++){var X=z(s,function(t){return t.FBX_ID===g.parents[W].ID});if(X>-1){s[X].add(v);break}}null===v.parent&&o.add(v)}o.updateMatrixWorld(!0);var Z=t.Objects.subNodes.Pose;for(var p in Z)if("BindPose"===Z[p].attrType){Z=Z[p];break}if(Z)for(var Y=Z.subNodes.PoseNode,q=new Map,J=0,Q=Y.length;J<Q;++J){var f=Y[J],K=O(f.subNodes.Matrix.properties.a);q.set(parseInt(f.id),K)}for(var E in i){var x=i[E],_=x.map;for(var $ in _){var w=_[$],tt=w.index,et=x.bones[tt];if(!q.has(et.FBX_ID))break;var it=q.get(et.FBX_ID);et.matrixWorld.copy(it)}x.skeleton=new THREE.Skeleton(x.bones);for(var g=e.get(x.FBX_ID),rt=g.parents,nt=0,ot=rt.length;nt<ot;++nt){var at=rt[nt];if(r.has(at.ID))for(var st=at.ID,ht=e.get(st),y=0;y<ht.parents.length;++y)if(u.has(ht.parents[y].ID)){var v=u.get(ht.parents[y].ID);v.bind(x.skeleton,v.matrixWorld);break}}}o.updateMatrixWorld(!0),o.skeleton={bones:s};var lt=function(t,e,i){var r=t.Objects.subNodes.AnimationCurveNode,n=t.Objects.subNodes.AnimationCurve,o=t.Objects.subNodes.AnimationLayer,a=t.Objects.subNodes.AnimationStack,s={curves:new Map,layers:{},stacks:{},length:0,fps:30,frames:0},u=[];for(var p in r)if(p.match(/\d+/)){var d=h(t,r[p],e,i);u.push(d)}for(var f=new Map,m=0;m<u.length;++m)null!==u[m]&&f.set(u[m].id,u[m]);var g=[];for(p in n)if(p.match(/\d+/)){var v=l(n[p]);if(!e.has(v.id))continue;g.push(v);var y=e.get(v.id).parents[0],E=y.ID,x=y.relationship,_="";if(x.match(/X/))_="x";else if(x.match(/Y/))_="y";else{if(!x.match(/Z/))continue;_="z"}f.get(E).curves[_]=v}for(var p in f.forEach(function(t){var e=t.containerBoneID;if(s.curves.has(e)||s.curves.set(e,{T:null,R:null,S:null}),s.curves.get(e)[t.attr]=t,"R"===t.attr){var i=t.curves;if(null===i.x&&(i.x={version:null,times:[0],values:[0]}),null===i.y&&(i.y={version:null,times:[0],values:[0]}),null===i.z&&(i.z={version:null,times:[0],values:[0]}),i.x.values=i.x.values.map(I),i.y.values=i.y.values.map(I),i.z.values=i.z.values.map(I),null!==t.preRotations){var r=(new THREE.Euler).setFromVector3(t.preRotations,"ZYX");r=(new THREE.Quaternion).setFromEuler(r);for(var n=new THREE.Euler,o=new THREE.Quaternion,a=0;a<i.x.times.length;++a)n.set(i.x.values[a],i.y.values[a],i.z.values[a],"ZYX"),o.setFromEuler(n).premultiply(r),n.setFromQuaternion(o,"ZYX"),i.x.values[a]=n.x,i.y.values[a]=n.y,i.z.values[a]=n.z}}}),o){for(var w=[],b=e.get(parseInt(p)).children,S=0;S<b.length;S++)if(f.has(b[S].ID)){var T=f.get(b[S].ID),M=T.containerBoneID;void 0===w[M]&&(w[M]={T:null,R:null,S:null}),w[M][T.attr]=T}s.layers[p]=w}for(var p in a){for(var R=[],b=e.get(parseInt(p)).children,A={max:0,min:Number.MAX_VALUE},S=0;S<b.length;++S){var C=s.layers[b[S].ID];if(void 0!==C){R.push(C);for(var P=0,D=C.length;P<D;++P){var w=C[P];w&&c(w,A)}}}A.max>A.min&&(s.stacks[p]={name:a[p].attrName,layers:R,length:A.max-A.min,frames:30*(A.max-A.min)})}return s}(t,e,o);return function(t,e){void 0===t.animations&&(t.animations=[]);var i=e.stacks;for(var r in i){for(var n=i[r],o={name:n.name,fps:30,length:n.length,hierarchy:[]},a=t.skeleton.bones,s=0,h=a.length;s<h;++s){var l=a[s],c=l.name.replace(/.*:/,""),u=z(a,function(t){return l.parent===t});o.hierarchy.push({parent:u,name:c,keys:[]})}for(var p=0;p<=n.frames;p++)for(var s=0,h=a.length;s<h;++s)for(var l=a[s],d=s,f=n.layers[0][d],g=0,v=o.hierarchy.length;g<v;++g){var y=o.hierarchy[g];y.name===l.name&&y.keys.push(m(e,f,l,p))}t.animations.push(THREE.AnimationClip.parseAnimation(o,a))}}(o,lt),o}(s,f,y,function(t,e,i){var r=new Map;if("Geometry"in t.Objects.subNodes){var o=t.Objects.subNodes.Geometry;for(var a in o){var s=e.get(parseInt(a)),h=n(o[a],s,i);r.set(parseInt(a),h)}}return r}(s,f,y),v)}});var o=[],a={ByPolygonVertex:{Direct:function(t,e,i,r){var n=t*r.dataSize,a=t*r.dataSize+r.dataSize;return k(o,r.buffer,n,a)},IndexToDirect:function(t,e,i,r){var n=r.indices[t],a=n*r.dataSize,s=n*r.dataSize+r.dataSize;return k(o,r.buffer,a,s)}},ByPolygon:{Direct:function(t,e,i,r){var n=e*r.dataSize,a=e*r.dataSize+r.dataSize;return k(o,r.buffer,n,a)},IndexToDirect:function(t,e,i,r){var n=r.indices[e],a=n*r.dataSize,s=n*r.dataSize+r.dataSize;return k(o,r.buffer,a,s)}},ByVertice:{Direct:function(t,e,i,r){var n=i*r.dataSize,a=i*r.dataSize+r.dataSize;return k(o,r.buffer,n,a)}},AllSame:{IndexToDirect:function(t,e,i,r){var n=r.indices[0]*r.dataSize,a=r.indices[0]*r.dataSize+r.dataSize;return k(o,r.buffer,n,a)}}};function s(t,e,i,r){return a[r.mappingType][r.referenceType](t,e,i,r)}function h(t,e,i,r){var n=t.Objects.subNodes.Model,o={id:e.id,attr:e.attrName,internalID:e.id,attrX:!1,attrY:!1,attrZ:!1,containerBoneID:-1,containerID:-1,curves:{x:null,y:null,z:null},preRotations:null};if(!o.attr.match(/S|R|T/))return null;for(var a in e.properties)a.match(/X/)&&(o.attrX=!0),a.match(/Y/)&&(o.attrY=!0),a.match(/Z/)&&(o.attrZ=!0);for(var s=i.get(o.id).parents,h=s.length-1;h>=0;--h){var l=z(r.skeleton.bones,function(t){return t.FBX_ID===s[h].ID});if(l>-1){o.containerBoneID=l,o.containerID=s[h].ID;var c=n[o.containerID.toString()];"PreRotation"in c.properties&&(o.preRotations=D(c.properties.PreRotation).multiplyScalar(Math.PI/180));break}}return o}function l(t){return{version:null,id:t.id,internalID:t.id,times:C(t.subNodes.KeyTime.properties.a).map(A),values:C(t.subNodes.KeyValueFloat.properties.a),attrFlag:P(t.subNodes.KeyAttrFlags.properties.a),attrData:C(t.subNodes.KeyAttrDataFloat.properties.a)}}function c(t,e){t.R&&u(t.R.curves,e),t.S&&u(t.S.curves,e),t.T&&u(t.T.curves,e)}function u(t,e){t.x&&p(t.x,e),t.y&&p(t.y,e),t.z&&p(t.z,e)}function p(t,e){e.max=t.times[t.times.length-1]>e.max?t.times[t.times.length-1]:e.max,e.min=t.times[0]<e.min?t.times[0]:e.min}var d=new THREE.Euler,f=new THREE.Quaternion;function m(t,e,i,r){var n={time:r/t.fps,pos:i.position.toArray(),rot:i.quaternion.toArray(),scl:i.scale.toArray()};if(void 0===e)return n;try{if(v(e,"T")&&y(e.T,r)&&(n.pos=[e.T.curves.x.values[r],e.T.curves.y.values[r],e.T.curves.z.values[r]]),v(e,"R")&&y(e.R,r)){var o=e.R.curves.x.values[r],a=e.R.curves.y.values[r],s=e.R.curves.z.values[r];f.setFromEuler(d.set(o,a,s,"ZYX")),n.rot=f.toArray()}v(e,"S")&&y(e.S,r)&&(n.scl=[e.S.curves.x.values[r],e.S.curves.y.values[r],e.S.curves.z.values[r]])}catch(t){}return n}var g=["x","y","z"];function v(t,e){if(void 0===t)return!1;var i=t[e];return!!i&&g.every(function(t){return null!==i.curves[t]})}function y(t,e){return g.every(function(i){return function(t,e){return void 0!==t.values[e]}(t.curves[i],e)})}function E(){this.position=new THREE.Vector3,this.normal=new THREE.Vector3,this.uv=new THREE.Vector2,this.color=new THREE.Vector3,this.skinIndices=new THREE.Vector4(0,0,0,0),this.skinWeights=new THREE.Vector4(0,0,0,0)}function x(){this.vertices=[]}function _(){this.triangles=[],this.materialIndex=0}function w(){this.faces=[],this.skeleton=null}function b(){}function S(){}function T(t,e){this.dv=new DataView(t),this.offset=0,this.littleEndian=void 0===e||e}function M(){}function R(t){var e=t.match(/FBXVersion: (\d+)/);if(e)return parseInt(e[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function A(t){return t/46186158e3}function C(t){for(var e=t.split(","),i=0,r=e.length;i<r;i++)e[i]=parseFloat(e[i]);return e}function P(t){for(var e=t.split(","),i=0,r=e.length;i<r;i++)e[i]=parseInt(e[i]);return e}function D(t){return(new THREE.Vector3).fromArray(t.value)}function L(t){return(new THREE.Color).fromArray(t.value)}function O(t){return(new THREE.Matrix4).fromArray(C(t))}function H(t,e,i){void 0===e&&(e=0),void 0===i&&(i=t.byteLength);var r=new Uint8Array(t,e,i);if(void 0!==window.TextDecoder)return(new TextDecoder).decode(r);for(var n="",o=0,a=r.length;o<a;o++)n+=String.fromCharCode(r[o]);return n}function I(t){return t*B}Object.assign(E.prototype,{copy:function(t){var e=t||new E;return e.position.copy(this.position),e.normal.copy(this.normal),e.uv.copy(this.uv),e.skinIndices.copy(this.skinIndices),e.skinWeights.copy(this.skinWeights),e},flattenToBuffers:function(t,e,i,r,n,o){this.position.toArray(t,t.length),this.normal.toArray(e,e.length),this.uv.toArray(i,i.length),this.color.toArray(r,r.length),this.skinIndices.toArray(n,n.length),this.skinWeights.toArray(o,o.length)}}),Object.assign(x.prototype,{copy:function(t){for(var e=t||new x,i=0;i<this.vertices.length;++i)this.vertices[i].copy(e.vertices[i]);return e},flattenToBuffers:function(t,e,i,r,n,o){for(var a=this.vertices,s=0,h=a.length;s<h;++s)a[s].flattenToBuffers(t,e,i,r,n,o)}}),Object.assign(_.prototype,{copy:function(t){for(var e=t||new _,i=0;i<this.triangles.length;++i)this.triangles[i].copy(e.triangles[i]);return e.materialIndex=this.materialIndex,e},genTrianglesFromVertices:function(t){for(var e=2;e<t.length;++e){var i=new x;i.vertices[0]=t[0],i.vertices[1]=t[e-1],i.vertices[2]=t[e],this.triangles.push(i)}},flattenToBuffers:function(t,e,i,r,n,o,a){for(var s=this.triangles,h=this.materialIndex,l=0,c=s.length;l<c;++l)s[l].flattenToBuffers(t,e,i,r,n,o),N(a,[h,h,h])}}),Object.assign(w.prototype,{flattenToBuffers:function(){for(var t=[],e=[],i=[],r=[],n=[],o=[],a=[],s=this.faces,h=0,l=s.length;h<l;++h)s[h].flattenToBuffers(t,e,i,r,n,o,a);return{vertexBuffer:t,normalBuffer:e,uvBuffer:i,colorBuffer:r,skinIndexBuffer:n,skinWeightBuffer:o,materialIndexBuffer:a}}}),Object.assign(b.prototype,{getPrevNode:function(){return this.nodeStack[this.currentIndent-2]},getCurrentNode:function(){return this.nodeStack[this.currentIndent-1]},getCurrentProp:function(){return this.currentProp},pushStack:function(t){this.nodeStack.push(t),this.currentIndent+=1},popStack:function(){this.nodeStack.pop(),this.currentIndent-=1},setCurrentProp:function(t,e){this.currentProp=t,this.currentPropName=e},parse:function(t){this.currentIndent=0,this.allNodes=new M,this.nodeStack=[],this.currentProp=[],this.currentPropName="";for(var e=t.split("\n"),i=0,r=e.length;i<r;i++){if(!(h=e[i]).match(/^[\s\t]*;/)&&!h.match(/^[\s\t]*$/)){var n=new RegExp("^\\t{"+this.currentIndent+"}(\\w+):(.*){","");if(l=h.match(n)){for(var o=l[1].trim().replace(/^"/,"").replace(/"$/,""),a=l[2].split(","),s=0,h=a.length;s<h;s++)a[s]=a[s].trim().replace(/^"/,"").replace(/"$/,"");this.parseNodeBegin(h,o,a||null)}else{var l,c=new RegExp("^\\t{"+this.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)");if(l=h.match(c)){var u=l[1].replace(/^"/,"").replace(/"$/,"").trim(),p=l[2].replace(/^"/,"").replace(/"$/,"").trim();"Content"===u&&","===p&&(p=e[++i].replace(/"/g,"").trim()),this.parseNodeProperty(h,u,p)}else{var d=new RegExp("^\\t{"+(this.currentIndent-1)+"}}");h.match(d)?this.nodeEnd():h.match(/^[^\s\t}]/)&&this.parseNodePropertyContinued(h)}}}}return this.allNodes},parseNodeBegin:function(t,e,i){var r={name:e,properties:{},subNodes:{}},n=this.parseNodeAttr(i),o=this.getCurrentNode();if(0===this.currentIndent)this.allNodes.add(e,r);else if(e in o.subNodes){var a=o.subNodes[e];this.isFlattenNode(o.subNodes[e])&&(""===n.id?(o.subNodes[e]=[],o.subNodes[e].push(a)):(o.subNodes[e]={},o.subNodes[e][a.id]=a)),""===n.id?o.subNodes[e].push(r):o.subNodes[e][n.id]=r}else"number"==typeof n.id||n.id.match(/^\d+$/)?(o.subNodes[e]={},o.subNodes[e][n.id]=r):o.subNodes[e]=r;i&&(r.id=n.id,r.attrName=n.name,r.attrType=n.type),this.pushStack(r)},parseNodeAttr:function(t){var e=t[0];""!==t[0]&&(e=parseInt(t[0]),isNaN(e)&&(e=t[0]));var i="",r="";return t.length>1&&(i=t[1].replace(/^(\w+)::/,""),r=t[2]),{id:e,name:i,type:r}},parseNodeProperty:function(t,e,i){var r=this.getCurrentNode(),n=r.name;if(void 0!==n&&n.match(/Properties(\d)+/))return void this.parseNodeSpecialProperty(t,e,i);if("C"===e){var o=i.split(",").slice(1),a=parseInt(o[0]),s=parseInt(o[1]),h=i.split(",").slice(3);e="connections",N(i=[a,s],h),void 0===r.properties[e]&&(r.properties[e]=[])}if("Node"===e){var l=parseInt(i);r.properties.id=l,r.id=l}e in r.properties?Array.isArray(r.properties[e])?r.properties[e].push(i):r.properties[e]+=i:Array.isArray(r.properties[e])?r.properties[e].push(i):r.properties[e]=i,this.setCurrentProp(r.properties,e)},parseNodePropertyContinued:function(t){this.currentProp[this.currentPropName]+=t},parseNodeSpecialProperty:function(t,e,i){for(var r=i.split('",'),n=0,o=r.length;n<o;n++)r[n]=r[n].trim().replace(/^\"/,"").replace(/\s/,"_");var a=r[0],s=r[1],h=r[2],l=r[3],c=r[4];switch(s){case"int":c=parseInt(c);break;case"double":c=parseFloat(c);break;case"ColorRGB":case"Vector3D":c=C(c)}this.getPrevNode().properties[a]={type:s,type2:h,flag:l,value:c},this.setCurrentProp(this.getPrevNode().properties,a)},nodeEnd:function(){this.popStack()},isFlattenNode:function(t){return"subNodes"in t&&"properties"in t}}),Object.assign(S.prototype,{parse:function(t){var e=new T(t);e.skip(23);for(var i=e.getUint32(),r=new M;!this.endOfContent(e);){var n=this.parseNode(e,i);null!==n&&r.add(n.name,n)}return r},endOfContent:function(t){return t.size()%16==0?(t.getOffset()+160+16&-16)>=t.size():t.getOffset()+160+16>=t.size()},parseNode:function(t,e){var i=e>=7500?t.getUint64():t.getUint32(),r=e>=7500?t.getUint64():t.getUint32(),n=(e>=7500?t.getUint64():t.getUint32(),t.getUint8()),o=t.getString(n);if(0===i)return null;for(var a=[],s=0;s<r;s++)a.push(this.parseProperty(t));var h=a.length>0?a[0]:"",l=a.length>1?a[1]:"",c=a.length>2?a[2]:"",u={},p={},d=!1;for(1===r&&t.getOffset()===i&&(d=!0);i>t.getOffset();){var f=this.parseNode(t,e);if(null!==f)if(!0!==f.singleProperty)if("Connections"!==o||"C"!==f.name)if(f.name.match(/^Properties\d+$/)){var m=Object.keys(f.properties);for(s=0,b=m.length;s<b;s++){var g=m[s];p[g]=f.properties[g]}}else if(o.match(/^Properties\d+$/)&&"P"===f.name){var v,y=f.propertyList[0],E=f.propertyList[1],x=f.propertyList[2],_=f.propertyList[3];0===y.indexOf("Lcl ")&&(y=y.replace("Lcl ","Lcl_")),0===E.indexOf("Lcl ")&&(E=E.replace("Lcl ","Lcl_")),v="ColorRGB"===E||"Vector"===E||"Vector3D"===E||0===E.indexOf("Lcl_")?[f.propertyList[4],f.propertyList[5],f.propertyList[6]]:f.propertyList[4],0===E.indexOf("Lcl_")&&(v=v.toString()),p[y]={type:E,type2:x,flag:_,value:v}}else void 0===u[f.name]?"number"==typeof f.id?(u[f.name]={},u[f.name][f.id]=f):u[f.name]=f:""===f.id?(Array.isArray(u[f.name])||(u[f.name]=[u[f.name]]),u[f.name].push(f)):void 0===u[f.name][f.id]?u[f.name][f.id]=f:(Array.isArray(u[f.name][f.id])||(u[f.name][f.id]=[u[f.name][f.id]]),u[f.name][f.id].push(f));else{for(var w=[],s=1,b=f.propertyList.length;s<b;s++)w[s-1]=f.propertyList[s];void 0===p.connections&&(p.connections=[]),p.connections.push(w)}else{var S=f.propertyList[0];Array.isArray(S)?(f.properties[f.name]=f.propertyList[0],u[f.name]=f,f.properties.a=S.toString()):p[f.name]=S}}return{singleProperty:d,id:h,attrName:l,attrType:c,name:o,properties:p,propertyList:a,subNodes:u}},parseProperty:function(t){var e=t.getChar();switch(e){case"F":return t.getFloat32();case"D":return t.getFloat64();case"L":return t.getInt64();case"I":return t.getInt32();case"Y":return t.getInt16();case"C":return t.getBoolean();case"f":case"d":case"l":case"i":case"b":var i=t.getUint32(),r=t.getUint32(),n=t.getUint32();if(0===r)switch(e){case"f":return t.getFloat32Array(i);case"d":return t.getFloat64Array(i);case"l":return t.getInt64Array(i);case"i":return t.getInt32Array(i);case"b":return t.getBooleanArray(i)}if(void 0===window.Zlib)throw new Error("THREE.FBXLoader: External library Inflate.min.js required, obtain or import from https://github.com/imaya/zlib.js");var o=new T(new Zlib.Inflate(new Uint8Array(t.getArrayBuffer(n))).decompress().buffer);switch(e){case"f":return o.getFloat32Array(i);case"d":return o.getFloat64Array(i);case"l":return o.getInt64Array(i);case"i":return o.getInt32Array(i);case"b":return o.getBooleanArray(i)}case"S":var a=t.getUint32();return t.getString(a);case"R":a=t.getUint32();return t.getArrayBuffer(a);default:throw new Error("THREE.FBXLoader: Unknown property type "+e)}}}),Object.assign(T.prototype,{getOffset:function(){return this.offset},size:function(){return this.dv.buffer.byteLength},skip:function(t){this.offset+=t},getBoolean:function(){return 1==(1&this.getUint8())},getBooleanArray:function(t){for(var e=[],i=0;i<t;i++)e.push(this.getBoolean());return e},getInt8:function(){var t=this.dv.getInt8(this.offset);return this.offset+=1,t},getInt8Array:function(t){for(var e=[],i=0;i<t;i++)e.push(this.getInt8());return e},getUint8:function(){var t=this.dv.getUint8(this.offset);return this.offset+=1,t},getUint8Array:function(t){for(var e=[],i=0;i<t;i++)e.push(this.getUint8());return e},getInt16:function(){var t=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,t},getInt16Array:function(t){for(var e=[],i=0;i<t;i++)e.push(this.getInt16());return e},getUint16:function(){var t=this.dv.getUint16(this.offset,this.littleEndian);return this.offset+=2,t},getUint16Array:function(t){for(var e=[],i=0;i<t;i++)e.push(this.getUint16());return e},getInt32:function(){var t=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,t},getInt32Array:function(t){for(var e=[],i=0;i<t;i++)e.push(this.getInt32());return e},getUint32:function(){var t=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,t},getUint32Array:function(t){for(var e=[],i=0;i<t;i++)e.push(this.getUint32());return e},getInt64:function(){var t,e;return this.littleEndian?(t=this.getUint32(),e=this.getUint32()):(e=this.getUint32(),t=this.getUint32()),2147483648&e?(e=4294967295&~e,4294967295===(t=4294967295&~t)&&(e=e+1&4294967295),-(4294967296*e+(t=t+1&4294967295))):4294967296*e+t},getInt64Array:function(t){for(var e=[],i=0;i<t;i++)e.push(this.getInt64());return e},getUint64:function(){var t,e;return this.littleEndian?(t=this.getUint32(),e=this.getUint32()):(e=this.getUint32(),t=this.getUint32()),4294967296*e+t},getUint64Array:function(t){for(var e=[],i=0;i<t;i++)e.push(this.getUint64());return e},getFloat32:function(){var t=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,t},getFloat32Array:function(t){for(var e=[],i=0;i<t;i++)e.push(this.getFloat32());return e},getFloat64:function(){var t=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,t},getFloat64Array:function(t){for(var e=[],i=0;i<t;i++)e.push(this.getFloat64());return e},getArrayBuffer:function(t){var e=this.dv.buffer.slice(this.offset,this.offset+t);return this.offset+=t,e},getChar:function(){return String.fromCharCode(this.getUint8())},getString:function(t){for(var e="";t>0;){var i=this.getUint8();if(t--,0===i)break;e+=String.fromCharCode(i)}return this.skip(t),e}}),Object.assign(M.prototype,{add:function(t,e){this[t]=e},searchConnectionParent:function(t){if(void 0===this.__cache_search_connection_parent&&(this.__cache_search_connection_parent=[]),void 0!==this.__cache_search_connection_parent[t])return this.__cache_search_connection_parent[t];this.__cache_search_connection_parent[t]=[];for(var e=this.Connections.properties.connections,i=[],r=0;r<e.length;++r)if(e[r][0]==t){var n=0===e[r][1]?-1:e[r][1];i.push(n)}return i.length>0?(N(this.__cache_search_connection_parent[t],i),i):(this.__cache_search_connection_parent[t]=[-1],[-1])},searchConnectionChildren:function(t){if(void 0===this.__cache_search_connection_children&&(this.__cache_search_connection_children=[]),void 0!==this.__cache_search_connection_children[t])return this.__cache_search_connection_children[t];this.__cache_search_connection_children[t]=[];for(var e=this.Connections.properties.connections,i=[],r=0;r<e.length;++r)e[r][1]==t&&i.push(0===e[r][0]?-1:e[r][0]);return i.length>0?(N(this.__cache_search_connection_children[t],i),i):(this.__cache_search_connection_children[t]=[],[])},searchConnectionType:function(t,e){var i=t+","+e;if(void 0===this.__cache_search_connection_type&&(this.__cache_search_connection_type={}),void 0!==this.__cache_search_connection_type[i])return this.__cache_search_connection_type[i];this.__cache_search_connection_type[i]="";for(var r=this.Connections.properties.connections,n=0;n<r.length;++n)if(r[n][0]==t&&r[n][1]==e)return this.__cache_search_connection_type[i]=r[n][2],r[n][2];return this.__cache_search_connection_type[t]=null,null}});var B=Math.PI/180;function z(t,e){for(var i=0,r=t.length;i<r;i++)if(e(t[i]))return i;return-1}function N(t,e){for(var i=0,r=t.length,n=e.length;i<n;i++,r++)t[r]=e[i]}function k(t,e,i,r){for(var n=i,o=0;n<r;n++,o++)t[o]=e[n];return t}}(),THREE.TGALoader=function(t){this.manager=void 0!==t?t:THREE.DefaultLoadingManager},THREE.TGALoader.prototype={constructor:THREE.TGALoader,load:function(t,e,i,r){var n=this,o=new THREE.Texture,a=new THREE.FileLoader(this.manager);return a.setResponseType("arraybuffer"),a.load(t,function(t){o.image=n.parse(t),o.needsUpdate=!0,void 0!==e&&e(o)},i,r),o},parse:function(t){var e=1,i=2,r=3,n=9,o=10,a=11,s=48,h=4,l=0,c=1,u=2,p=3;t.length;var d=new Uint8Array(t),f=0,m={id_length:d[f++],colormap_type:d[f++],image_type:d[f++],colormap_index:d[f++]|d[f++]<<8,colormap_length:d[f++]|d[f++]<<8,colormap_size:d[f++],origin:[d[f++]|d[f++]<<8,d[f++]|d[f++]<<8],width:d[f++]|d[f++]<<8,height:d[f++]|d[f++]<<8,pixel_size:d[f++],flags:d[f++]};!function(t){switch(t.image_type){case e:case n:t.colormap_length>256||24!==t.colormap_size||t.colormap_type;break;case i:case r:case o:case a:t.colormap_type}t.width<=0||t.height,8!==t.pixel_size&&16!==t.pixel_size&&24!==t.pixel_size&&t.pixel_size}(m),m.id_length,t.length,f+=m.id_length;var g=!1,v=!1,y=!1;switch(m.image_type){case n:g=!0,v=!0;break;case e:v=!0;break;case o:g=!0;break;case i:break;case a:g=!0,y=!0;break;case r:y=!0}var E=document.createElement("canvas");E.width=m.width,E.height=m.height;var x=E.getContext("2d"),_=x.createImageData(m.width,m.height),w=function(t,e,i,r,n){var o,a,s,h;if(a=i.pixel_size>>3,s=i.width*i.height*a,e&&(h=n.subarray(r,r+=i.colormap_length*(i.colormap_size>>3))),t){var l,c,u;o=new Uint8Array(s);for(var p=0,d=new Uint8Array(a);p<s;)if(c=1+(127&(l=n[r++])),128&l){for(u=0;u<a;++u)d[u]=n[r++];for(u=0;u<c;++u)o.set(d,p+u*a);p+=a*c}else{for(c*=a,u=0;u<c;++u)o[p+u]=n[r++];p+=c}}else o=n.subarray(r,r+=e?i.width*i.height:s);return{pixel_data:o,palettes:h}}(g,v,m,f,d);!function(t,e,i,r,n){var o,a,d,f,g,v;switch((m.flags&s)>>h){default:case u:o=0,d=1,g=e,a=0,f=1,v=i;break;case l:o=0,d=1,g=e,a=i-1,f=-1,v=-1;break;case p:o=e-1,d=-1,g=-1,a=0,f=1,v=i;break;case c:o=e-1,d=-1,g=-1,a=i-1,f=-1,v=-1}if(y)switch(m.pixel_size){case 8:!function(t,e,i,r,n,o,a,s){var h,l,c,u=0,p=m.width;for(c=e;c!==r;c+=i)for(l=n;l!==a;l+=o,u++)h=s[u],t[4*(l+p*c)+0]=h,t[4*(l+p*c)+1]=h,t[4*(l+p*c)+2]=h,t[4*(l+p*c)+3]=255}(t,a,f,v,o,d,g,r);break;case 16:!function(t,e,i,r,n,o,a,s){var h,l,c=0,u=m.width;for(l=e;l!==r;l+=i)for(h=n;h!==a;h+=o,c+=2)t[4*(h+u*l)+0]=s[c+0],t[4*(h+u*l)+1]=s[c+0],t[4*(h+u*l)+2]=s[c+0],t[4*(h+u*l)+3]=s[c+1]}(t,a,f,v,o,d,g,r)}else switch(m.pixel_size){case 8:!function(t,e,i,r,n,o,a,s,h){var l,c,u,p=h,d=0,f=m.width;for(u=e;u!==r;u+=i)for(c=n;c!==a;c+=o,d++)l=s[d],t[4*(c+f*u)+3]=255,t[4*(c+f*u)+2]=p[3*l+0],t[4*(c+f*u)+1]=p[3*l+1],t[4*(c+f*u)+0]=p[3*l+2]}(t,a,f,v,o,d,g,r,n);break;case 16:!function(t,e,i,r,n,o,a,s){var h,l,c,u=0,p=m.width;for(c=e;c!==r;c+=i)for(l=n;l!==a;l+=o,u+=2)h=s[u+0]+(s[u+1]<<8),t[4*(l+p*c)+0]=(31744&h)>>7,t[4*(l+p*c)+1]=(992&h)>>2,t[4*(l+p*c)+2]=(31&h)>>3,t[4*(l+p*c)+3]=32768&h?0:255}(t,a,f,v,o,d,g,r);break;case 24:!function(t,e,i,r,n,o,a,s){var h,l,c=0,u=m.width;for(l=e;l!==r;l+=i)for(h=n;h!==a;h+=o,c+=3)t[4*(h+u*l)+3]=255,t[4*(h+u*l)+2]=s[c+0],t[4*(h+u*l)+1]=s[c+1],t[4*(h+u*l)+0]=s[c+2]}(t,a,f,v,o,d,g,r);break;case 32:!function(t,e,i,r,n,o,a,s){var h,l,c=0,u=m.width;for(l=e;l!==r;l+=i)for(h=n;h!==a;h+=o,c+=4)t[4*(h+u*l)+2]=s[c+0],t[4*(h+u*l)+1]=s[c+1],t[4*(h+u*l)+0]=s[c+2],t[4*(h+u*l)+3]=s[c+3]}(t,a,f,v,o,d,g,r)}}(_.data,m.width,m.height,w.pixel_data,w.palettes);return x.putImageData(_,0,0),E}},function(t){function e(t,e,i,r,n){this._listener=e,this._isOnce=i,this.context=r,this._signal=t,this._priority=n||0}function i(t,e){if("function"!=typeof t)throw Error("listener is a required param of {fn}() and should be a Function.".replace("{fn}",e))}var r={VERSION:"0.7.4"};e.prototype={active:!0,params:null,execute:function(t){var e;return this.active&&this._listener&&(t=this.params?this.params.concat(t):t,e=this._listener.apply(this.context,t),this._isOnce&&this.detach()),e},detach:function(){return this.isBound()?this._signal.remove(this._listener,this.context):null},isBound:function(){return!!this._signal&&!!this._listener},getListener:function(){return this._listener},_destroy:function(){delete this._signal,delete this._listener,delete this.context},isOnce:function(){return this._isOnce},toString:function(){return"[SignalBinding isOnce:"+this._isOnce+", isBound:"+this.isBound()+", active:"+this.active+"]"}},r.Signal=function(){this._bindings=[],this._prevParams=null},r.Signal.prototype={memorize:!1,_shouldPropagate:!0,active:!0,_registerListener:function(t,i,r,n){var o=this._indexOfListener(t,r);if(-1!==o){if((t=this._bindings[o]).isOnce()!==i)throw Error("You cannot add"+(i?"":"Once")+"() then add"+(i?"Once":"")+"() the same listener without removing the relationship first.")}else t=new e(this,t,i,r,n),this._addBinding(t);return this.memorize&&this._prevParams&&t.execute(this._prevParams),t},_addBinding:function(t){var e=this._bindings.length;do{--e}while(this._bindings[e]&&t._priority<=this._bindings[e]._priority);this._bindings.splice(e+1,0,t)},_indexOfListener:function(t,e){for(var i,r=this._bindings.length;r--;)if((i=this._bindings[r])._listener===t&&i.context===e)return r;return-1},has:function(t,e){return-1!==this._indexOfListener(t,e)},add:function(t,e,r){return i(t,"add"),this._registerListener(t,!1,e,r)},addOnce:function(t,e,r){return i(t,"addOnce"),this._registerListener(t,!0,e,r)},remove:function(t,e){i(t,"remove");var r=this._indexOfListener(t,e);return-1!==r&&(this._bindings[r]._destroy(),this._bindings.splice(r,1)),t},removeAll:function(){for(var t=this._bindings.length;t--;)this._bindings[t]._destroy();this._bindings.length=0},getNumListeners:function(){return this._bindings.length},halt:function(){this._shouldPropagate=!1},dispatch:function(t){if(this.active){var e,i=Array.prototype.slice.call(arguments),r=this._bindings.length;if(this.memorize&&(this._prevParams=i),r){e=this._bindings.slice(),this._shouldPropagate=!0;do{r--}while(e[r]&&this._shouldPropagate&&!1!==e[r].execute(i))}}},forget:function(){this._prevParams=null},dispose:function(){this.removeAll(),delete this._bindings,delete this._prevParams},toString:function(){return"[Signal active:"+this.active+" numListeners:"+this.getNumListeners()+"]"}},"function"==typeof define&&define.amd?define(r):"undefined"!=typeof module&&module.exports?module.exports=r:t.signals=r}(this);var UI={Element:function(t){this.dom=t}};UI.Element.prototype={add:function(){for(var t=0;t<arguments.length;t++){var e=arguments[t];e instanceof UI.Element&&this.dom.appendChild(e.dom)}return this},remove:function(){for(var t=0;t<arguments.length;t++){var e=arguments[t];e instanceof UI.Element&&this.dom.removeChild(e.dom)}return this},clear:function(){for(;this.dom.children.length;)this.dom.removeChild(this.dom.lastChild)},setId:function(t){return this.dom.id=t,this},setClass:function(t){return this.dom.className=t,this},setStyle:function(t,e){for(var i=0;i<e.length;i++)this.dom.style[t]=e[i];return this},setDisabled:function(t){return this.dom.disabled=t,this},setTextContent:function(t){return this.dom.textContent=t,this}};var properties=["position","left","top","right","bottom","width","height","border","borderLeft","borderTop","borderRight","borderBottom","borderColor","display","overflow","margin","marginLeft","marginTop","marginRight","marginBottom","padding","paddingLeft","paddingTop","paddingRight","paddingBottom","color","background","backgroundColor","opacity","fontSize","fontWeight","textAlign","textDecoration","textTransform","cursor","zIndex"];properties.forEach(function(t){var e="set"+t.substr(0,1).toUpperCase()+t.substr(1,t.length);UI.Element.prototype[e]=function(){return this.setStyle(t,arguments),this}});var events=["KeyUp","KeyDown","MouseOver","MouseOut","Click","DblClick","Change"];events.forEach(function(t){var e="on"+t;UI.Element.prototype[e]=function(e){return this.dom.addEventListener(t.toLowerCase(),e.bind(this),!1),this}}),UI.Span=function(){return UI.Element.call(this),this.dom=document.createElement("span"),this},UI.Span.prototype=Object.create(UI.Element.prototype),UI.Span.prototype.constructor=UI.Span,UI.Div=function(){return UI.Element.call(this),this.dom=document.createElement("div"),this},UI.Div.prototype=Object.create(UI.Element.prototype),UI.Div.prototype.constructor=UI.Div,UI.Row=function(){UI.Element.call(this);var t=document.createElement("div");return t.className="Row",this.dom=t,this},UI.Row.prototype=Object.create(UI.Element.prototype),UI.Row.prototype.constructor=UI.Row,UI.Panel=function(){UI.Element.call(this);var t=document.createElement("div");return t.className="Panel",this.dom=t,this},UI.Panel.prototype=Object.create(UI.Element.prototype),UI.Panel.prototype.constructor=UI.Panel,UI.Text=function(t){UI.Element.call(this);var e=document.createElement("span");return e.className="Text",e.style.cursor="default",e.style.display="inline-block",e.style.verticalAlign="middle",this.dom=e,this.setValue(t),this},UI.Text.prototype=Object.create(UI.Element.prototype),UI.Text.prototype.constructor=UI.Text,UI.Text.prototype.getValue=function(){return this.dom.textContent},UI.Text.prototype.setValue=function(t){return void 0!==t&&(this.dom.textContent=t),this},UI.Input=function(t){UI.Element.call(this);var e=document.createElement("input");return e.className="Input",e.style.padding="2px",e.style.border="1px solid transparent",e.addEventListener("keydown",function(t){t.stopPropagation()},!1),this.dom=e,this.setValue(t),this},UI.Input.prototype=Object.create(UI.Element.prototype),UI.Input.prototype.constructor=UI.Input,UI.Input.prototype.getValue=function(){return this.dom.value},UI.Input.prototype.setValue=function(t){return this.dom.value=t,this},UI.TextArea=function(){UI.Element.call(this);var t=document.createElement("textarea");return t.className="TextArea",t.style.padding="2px",t.spellcheck=!1,t.addEventListener("keydown",function(e){if(e.stopPropagation(),9===e.keyCode){e.preventDefault();var i=t.selectionStart;t.value=t.value.substring(0,i)+"\t"+t.value.substring(i),t.selectionStart=i+1,t.selectionEnd=t.selectionStart}},!1),this.dom=t,this},UI.TextArea.prototype=Object.create(UI.Element.prototype),UI.TextArea.prototype.constructor=UI.TextArea,UI.TextArea.prototype.getValue=function(){return this.dom.value},UI.TextArea.prototype.setValue=function(t){return this.dom.value=t,this},UI.Select=function(){UI.Element.call(this);var t=document.createElement("select");return t.className="Select",t.style.padding="2px",this.dom=t,this},UI.Select.prototype=Object.create(UI.Element.prototype),UI.Select.prototype.constructor=UI.Select,UI.Select.prototype.setMultiple=function(t){return this.dom.multiple=t,this},UI.Select.prototype.setOptions=function(t){for(var e=this.dom.value;this.dom.children.length>0;)this.dom.removeChild(this.dom.firstChild);for(var i in t){var r=document.createElement("option");r.value=i,r.innerHTML=t[i],this.dom.appendChild(r)}return this.dom.value=e,this},UI.Select.prototype.getValue=function(){return this.dom.value},UI.Select.prototype.setValue=function(t){return t=String(t),this.dom.value!==t&&(this.dom.value=t),this},UI.Checkbox=function(t){UI.Element.call(this);var e=document.createElement("input");return e.className="Checkbox",e.type="checkbox",this.dom=e,this.setValue(t),this},UI.Checkbox.prototype=Object.create(UI.Element.prototype),UI.Checkbox.prototype.constructor=UI.Checkbox,UI.Checkbox.prototype.getValue=function(){return this.dom.checked},UI.Checkbox.prototype.setValue=function(t){return void 0!==t&&(this.dom.checked=t),this},UI.Color=function(){UI.Element.call(this);var t=document.createElement("input");t.className="Color",t.style.width="64px",t.style.height="17px",t.style.border="0px",t.style.padding="2px",t.style.backgroundColor="transparent";try{t.type="color",t.value="#ffffff"}catch(t){}return this.dom=t,this},UI.Color.prototype=Object.create(UI.Element.prototype),UI.Color.prototype.constructor=UI.Color,UI.Color.prototype.getValue=function(){return this.dom.value},UI.Color.prototype.getHexValue=function(){return parseInt(this.dom.value.substr(1),16)},UI.Color.prototype.setValue=function(t){return this.dom.value=t,this},UI.Color.prototype.setHexValue=function(t){return this.dom.value="#"+("000000"+t.toString(16)).slice(-6),this},UI.Number=function(t){UI.Element.call(this);var e=this,i=document.createElement("input");i.className="Number",i.value="0.00",i.addEventListener("keydown",function(t){t.stopPropagation(),13===t.keyCode&&i.blur()},!1),this.value=0,this.min=-1/0,this.max=1/0,this.precision=2,this.step=1,this.unit="",this.dom=i,this.setValue(t);var r=document.createEvent("HTMLEvents");r.initEvent("change",!0,!0);var n=0,o=0,a=[0,0],s=[0,0];function h(t){var h=e.value;a=[t.clientX,t.clientY],n+=a[0]-s[0]-(a[1]-s[1]);var l=o+n/(t.shiftKey?5:50)*e.step;h!==(l=Math.min(e.max,Math.max(e.min,l)))&&(e.setValue(l),i.dispatchEvent(r)),s=[t.clientX,t.clientY]}function l(t){document.removeEventListener("mousemove",h,!1),document.removeEventListener("mouseup",l,!1),Math.abs(n)<2&&(i.focus(),i.select())}function c(t){i.style.backgroundColor="transparent",i.style.cursor="col-resize"}return c(),i.addEventListener("mousedown",function(t){t.preventDefault(),n=0,o=e.value,s=[t.clientX,t.clientY],document.addEventListener("mousemove",h,!1),document.addEventListener("mouseup",l,!1)},!1),i.addEventListener("change",function(t){e.setValue(i.value)},!1),i.addEventListener("focus",function(t){i.style.backgroundColor="",i.style.cursor=""},!1),i.addEventListener("blur",c,!1),this},UI.Number.prototype=Object.create(UI.Element.prototype),UI.Number.prototype.constructor=UI.Number,UI.Number.prototype.getValue=function(){return this.value},UI.Number.prototype.setValue=function(t){return void 0!==t&&((t=parseFloat(t))<this.min&&(t=this.min),t>this.max&&(t=this.max),this.value=t,this.dom.value=t.toFixed(this.precision),""!==this.unit&&(this.dom.value+=" "+this.unit)),this},UI.Number.prototype.setPrecision=function(t){return this.precision=t,this},UI.Number.prototype.setStep=function(t){return this.step=t,this},UI.Number.prototype.setRange=function(t,e){return this.min=t,this.max=e,this},UI.Number.prototype.setUnit=function(t){return this.unit=t,this},UI.Integer=function(t){UI.Element.call(this);var e=this,i=document.createElement("input");i.className="Number",i.value="0",i.addEventListener("keydown",function(t){t.stopPropagation()},!1),this.value=0,this.min=-1/0,this.max=1/0,this.step=1,this.dom=i,this.setValue(t);var r=document.createEvent("HTMLEvents");r.initEvent("change",!0,!0);var n=0,o=0,a=[0,0],s=[0,0];function h(t){var h=e.value;a=[t.clientX,t.clientY],n+=a[0]-s[0]-(a[1]-s[1]);var l=o+n/(t.shiftKey?5:50)*e.step;h!==(l=0|Math.min(e.max,Math.max(e.min,l)))&&(e.setValue(l),i.dispatchEvent(r)),s=[t.clientX,t.clientY]}function l(t){document.removeEventListener("mousemove",h,!1),document.removeEventListener("mouseup",l,!1),Math.abs(n)<2&&(i.focus(),i.select())}function c(t){i.style.backgroundColor="transparent",i.style.cursor="col-resize"}return c(),i.addEventListener("mousedown",function(t){t.preventDefault(),n=0,o=e.value,s=[t.clientX,t.clientY],document.addEventListener("mousemove",h,!1),document.addEventListener("mouseup",l,!1)},!1),i.addEventListener("change",function(t){e.setValue(i.value)},!1),i.addEventListener("focus",function(t){i.style.backgroundColor="",i.style.cursor=""},!1),i.addEventListener("blur",c,!1),this},UI.Integer.prototype=Object.create(UI.Element.prototype),UI.Integer.prototype.constructor=UI.Integer,UI.Integer.prototype.getValue=function(){return this.value},UI.Integer.prototype.setValue=function(t){return void 0!==t&&(t=parseInt(t),this.value=t,this.dom.value=t),this},UI.Integer.prototype.setStep=function(t){return this.step=parseInt(t),this},UI.Integer.prototype.setRange=function(t,e){return this.min=t,this.max=e,this},UI.Break=function(){UI.Element.call(this);var t=document.createElement("br");return t.className="Break",this.dom=t,this},UI.Break.prototype=Object.create(UI.Element.prototype),UI.Break.prototype.constructor=UI.Break,UI.HorizontalRule=function(){UI.Element.call(this);var t=document.createElement("hr");return t.className="HorizontalRule",this.dom=t,this},UI.HorizontalRule.prototype=Object.create(UI.Element.prototype),UI.HorizontalRule.prototype.constructor=UI.HorizontalRule,UI.Button=function(t){UI.Element.call(this);var e=document.createElement("button");return e.className="Button",this.dom=e,this.dom.textContent=t,this},UI.Button.prototype=Object.create(UI.Element.prototype),UI.Button.prototype.constructor=UI.Button,UI.Button.prototype.setLabel=function(t){return this.dom.textContent=t,this},UI.Image=function(t){UI.Element.call(this);var e=document.createElement("img");return e.className="Img",this.dom=e,this.dom.src=t,this.dom.style="cursor:hand",this},UI.Image.prototype=Object.create(UI.Element.prototype),UI.Image.prototype.constructor=UI.Image,UI.Modal=function(t){var e=this,i=document.createElement("div");return i.style.position="absolute",i.style.width="100%",i.style.height="100%",i.style.backgroundColor="rgba(0,0,0,0.5)",i.style.display="none",i.style.alignItems="center",i.style.justifyContent="center",i.addEventListener("click",function(t){e.hide()}),this.dom=i,this.container=new UI.Panel,this.container.dom.style.width="200px",this.container.dom.style.padding="20px",this.container.dom.style.backgroundColor="#ffffff",this.container.dom.style.boxShadow="0px 5px 10px rgba(0,0,0,0.5)",this.add(this.container),this},UI.Modal.prototype=Object.create(UI.Element.prototype),UI.Modal.prototype.constructor=UI.Modal,UI.Modal.prototype.show=function(t){return this.container.clear(),this.container.add(t),this.dom.style.display="flex",this},UI.Modal.prototype.hide=function(){return this.dom.style.display="none",this},UI.Texture=function(t){UI.Element.call(this);var e=this,i=document.createElement("span"),r=document.createElement("form"),n=document.createElement("input");n.type="file",n.addEventListener("change",function(t){s(t.target.files[0])}),r.appendChild(n);var o=document.createElement("canvas");o.width=32,o.height=16,o.style.cursor="pointer",o.style.marginRight="5px",o.style.border="1px solid #888",o.addEventListener("click",function(t){n.click()},!1),o.addEventListener("drop",function(t){t.preventDefault(),t.stopPropagation(),s(t.dataTransfer.files[0])},!1),i.appendChild(o);var a=document.createElement("input");function s(i){if(i.type.match("image.*")){var n=new FileReader;"image/targa"===i.type?(n.addEventListener("load",function(r){var n=(new THREE.TGALoader).parse(r.target.result),o=new THREE.CanvasTexture(n,t);o.sourceFile=i.name,e.setValue(o),e.onChangeCallback&&e.onChangeCallback()},!1),n.readAsArrayBuffer(i)):(n.addEventListener("load",function(r){var n=document.createElement("img");n.addEventListener("load",function(r){var n=new THREE.Texture(this,t);n.sourceFile=i.name,n.needsUpdate=!0,e.setValue(n),e.onChangeCallback&&e.onChangeCallback()},!1),n.src=r.target.result},!1),n.readAsDataURL(i))}r.reset()}return a.disabled=!0,a.style.width="64px",a.style.border="1px solid #ccc",i.appendChild(a),this.dom=i,this.texture=null,this.onChangeCallback=null,this},UI.Texture.prototype=Object.create(UI.Element.prototype),UI.Texture.prototype.constructor=UI.Texture,UI.Texture.prototype.getValue=function(){return this.texture},UI.Texture.prototype.setValue=function(t){var e=this.dom.children[0],i=this.dom.children[1],r=e.getContext("2d");if(null!==t){var n=t.image;if(void 0!==n&&n.width>0){i.value=t.sourceFile;var o=e.width/n.width;r.drawImage(n,0,0,n.width*o,n.height*o)}else i.value=t.sourceFile+" (error)",r.clearRect(0,0,e.width,e.height)}else i.value="",null!==r&&r.clearRect(0,0,e.width,e.height);this.texture=t},UI.Texture.prototype.onChange=function(t){return this.onChangeCallback=t,this},UI.Outliner=function(t){UI.Element.call(this);var e=this,i=document.createElement("div");return i.className="Outliner",i.tabIndex=0,this.scene=t.scene,i.addEventListener("keydown",function(t){switch(t.keyCode){case 38:case 40:t.preventDefault(),t.stopPropagation()}},!1),i.addEventListener("keyup",function(t){switch(t.keyCode){case 38:e.selectIndex(e.selectedIndex-1);break;case 40:e.selectIndex(e.selectedIndex+1)}},!1),this.dom=i,this.options=[],this.selectedIndex=-1,this.selectedValue=null,this},UI.Outliner.prototype=Object.create(UI.Element.prototype),UI.Outliner.prototype.constructor=UI.Outliner,UI.Outliner.prototype.selectIndex=function(t){if(t>=0&&t<this.options.length){this.setValue(this.options[t].value);var e=document.createEvent("HTMLEvents");e.initEvent("change",!0,!0),this.dom.dispatchEvent(e)}},UI.Outliner.prototype.setOptions=function(t){for(var e,i=this;i.dom.children.length>0;)i.dom.removeChild(i.dom.firstChild);function r(){i.setValue(this.value);var t=document.createEvent("HTMLEvents");t.initEvent("change",!0,!0),i.dom.dispatchEvent(t)}function n(t){e=this}function o(t){t.dataTransfer.setData("text","foo")}function a(t){if(this!==e){var i=t.offsetY/this.clientHeight;this.className=i<.25?"option dragTop":i>.75?"option dragBottom":"option drag"}}function s(){this!==e&&(this.className="option")}function h(t){if(this!==e){this.className="option";var r=i.scene,n=r.getObjectById(e.value),o=t.offsetY/this.clientHeight;if(o<.25)l(n,(a=r.getObjectById(this.value)).parent,a);else if(o>.75){var a;l(n,(a=r.getObjectById(this.nextSibling.value)).parent,a)}else{l(n,r.getObjectById(this.value))}}}function l(t,e,r){null===r&&(r=void 0);var n=!1;if(t.traverse(function(t){t===e&&(n=!0)}),!n){editor.execute(new MoveObjectCommand(t,e,r));var o=document.createEvent("HTMLEvents");o.initEvent("change",!0,!0),i.dom.dispatchEvent(o)}}i.options=[];for(var c=0;c<t.length;c++){var u=t[c];u.className="option",i.dom.appendChild(u),i.options.push(u),u.addEventListener("click",r,!1),!0===u.draggable&&(u.addEventListener("drag",n,!1),u.addEventListener("dragstart",o,!1),u.addEventListener("dragover",a,!1),u.addEventListener("dragleave",s,!1),u.addEventListener("drop",h,!1))}return i},UI.Outliner.prototype.getValue=function(){return this.selectedValue},UI.Outliner.prototype.setValue=function(t){for(var e=0;e<this.options.length;e++){var i=this.options[e];if(i.value===t){i.classList.add("active");var r=i.offsetTop-this.dom.offsetTop,n=r+i.offsetHeight-this.dom.offsetHeight;this.dom.scrollTop>r?this.dom.scrollTop=r:this.dom.scrollTop<n&&(this.dom.scrollTop=n),this.selectedIndex=e}else i.classList.remove("active")}return this.selectedValue=t,this},UI.THREE={},UI.THREE.Boolean=function(t,e){UI.Span.call(this),this.setMarginRight("10px"),this.checkbox=new UI.Checkbox(t),this.text=new UI.Text(e).setMarginLeft("3px"),this.add(this.checkbox),this.add(this.text)},UI.THREE.Boolean.prototype=Object.create(UI.Span.prototype),UI.THREE.Boolean.prototype.constructor=UI.THREE.Boolean,UI.THREE.Boolean.prototype.getValue=function(){return this.checkbox.getValue()},UI.THREE.Boolean.prototype.setValue=function(t){return this.checkbox.setValue(t)};var Storage=function(){var t=window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB;if(void 0===t)return{init:function(){},get:function(){},set:function(){},clear:function(){}};var e;return{init:function(i){var r=t.open("threejs-editor",1);r.onupgradeneeded=function(t){var e=t.target.result;!1===e.objectStoreNames.contains("states")&&e.createObjectStore("states")},r.onsuccess=function(t){e=t.target.result,i()},r.onerror=function(t){}},get:function(t){e.transaction(["states"],"readwrite").objectStore("states").get(0).onsuccess=function(e){t(e.target.result)}},set:function(t,i){performance.now();e.transaction(["states"],"readwrite").objectStore("states").put(t,0).onsuccess=function(t){}},clear:function(){void 0!==e&&(e.transaction(["states"],"readwrite").objectStore("states").clear().onsuccess=function(t){})}}},Command=function(t){this.id=-1,this.inMemory=!1,this.updatable=!1,this.type="",this.name="",void 0!==t&&(Command.editor=t),this.editor=Command.editor};Command.prototype.toJSON=function(){var t={};return t.type=this.type,t.id=this.id,t.name=this.name,t},Command.prototype.fromJSON=function(t){this.inMemory=!0,this.type=t.type,this.id=t.id,this.name=t.name},History=function(t){this.editor=t,this.undos=[],this.redos=[],this.lastCmdTime=new Date,this.idCounter=0,this.historyDisabled=!1,this.config=t.config,Command(t);var e=this;this.editor.signals.startPlayer.add(function(){e.historyDisabled=!0}),this.editor.signals.stopPlayer.add(function(){e.historyDisabled=!1})},History.prototype={execute:function(t,e){var i=this.undos[this.undos.length-1],r=(new Date).getTime()-this.lastCmdTime.getTime(),n=i&&i.updatable&&t.updatable&&i.object===t.object&&i.type===t.type&&i.script===t.script&&i.attributeName===t.attributeName;n&&"SetScriptValueCommand"===t.type?(i.update(t),t=i):n&&r<500?(i.update(t),t=i):(this.undos.push(t),t.id=++this.idCounter),t.name=void 0!==e?e:t.name,t.execute(),t.inMemory=!0,this.config.getKey("settings/history")&&(t.json=t.toJSON()),this.lastCmdTime=new Date,this.redos=[],this.editor.signals.historyChanged.dispatch(t)},undo:function(){if(!this.historyDisabled){var t=void 0;return this.undos.length>0&&!1===(t=this.undos.pop()).inMemory&&t.fromJSON(t.json),void 0!==t&&(t.undo(),this.redos.push(t),this.editor.signals.historyChanged.dispatch(t)),t}},redo:function(){if(!this.historyDisabled){var t=void 0;return this.redos.length>0&&!1===(t=this.redos.pop()).inMemory&&t.fromJSON(t.json),void 0!==t&&(t.execute(),this.undos.push(t),this.editor.signals.historyChanged.dispatch(t)),t}},toJSON:function(){var t={undos:[],redos:[]};if(!this.config.getKey("settings/history"))return t;for(var e=0;e<this.undos.length;e++)this.undos[e].hasOwnProperty("json")&&t.undos.push(this.undos[e].json);for(e=0;e<this.redos.length;e++)this.redos[e].hasOwnProperty("json")&&t.redos.push(this.redos[e].json);return t},fromJSON:function(t){if(void 0!==t){for(var e=0;e<t.undos.length;e++){var i=t.undos[e];(r=new window[i.type]).json=i,r.id=i.id,r.name=i.name,this.undos.push(r),this.idCounter=i.id>this.idCounter?i.id:this.idCounter}for(e=0;e<t.redos.length;e++){var r;i=t.redos[e];(r=new window[i.type]).json=i,r.id=i.id,r.name=i.name,this.redos.push(r),this.idCounter=i.id>this.idCounter?i.id:this.idCounter}this.editor.signals.historyChanged.dispatch(this.undos[this.undos.length-1])}},clear:function(){this.undos=[],this.redos=[],this.idCounter=0,this.editor.signals.historyChanged.dispatch()},goToState:function(t){if(!this.historyDisabled){this.editor.signals.sceneGraphChanged.active=!1,this.editor.signals.historyChanged.active=!1;var e=this.undos.length>0?this.undos[this.undos.length-1]:void 0;if(void 0===e||t>e.id)for(e=this.redo();void 0!==e&&t>e.id;)e=this.redo();else for(;void 0!==(e=this.undos[this.undos.length-1])&&t!==e.id;)this.undo();this.editor.signals.sceneGraphChanged.active=!0,this.editor.signals.historyChanged.active=!0,this.editor.signals.sceneGraphChanged.dispatch(),this.editor.signals.historyChanged.dispatch(e)}},enableSerialization:function(t){this.goToState(-1),this.editor.signals.sceneGraphChanged.active=!1,this.editor.signals.historyChanged.active=!1;for(var e=this.redo();void 0!==e;)e.hasOwnProperty("json")||(e.json=e.toJSON()),e=this.redo();this.editor.signals.sceneGraphChanged.active=!0,this.editor.signals.historyChanged.active=!0,this.goToState(t)}};var Editor=function(){this.DEFAULT_CAMERA=new THREE.PerspectiveCamera(50,1,1,3e5),this.DEFAULT_CAMERA.name="Camera",this.DEFAULT_CAMERA.position.set(20,10,20),this.DEFAULT_CAMERA.lookAt(new THREE.Vector3);var t=signals.Signal;this.signals={editScript:new t,startPlayer:new t,stopPlayer:new t,playAnimation:new t,stopAnimation:new t,showModal:new t,editorCleared:new t,savingStarted:new t,savingFinished:new t,themeChanged:new t,transformModeChanged:new t,snapChanged:new t,spaceChanged:new t,rendererChanged:new t,sceneBackgroundChanged:new t,sceneFogChanged:new t,sceneGraphChanged:new t,cameraChanged:new t,geometryChanged:new t,objectSelected:new t,objectFocused:new t,objectAdded:new t,objectChanged:new t,objectRemoved:new t,helperAdded:new t,helperRemoved:new t,materialChanged:new t,scriptAdded:new t,scriptChanged:new t,scriptRemoved:new t,windowResize:new t,showGridChanged:new t,refreshSidebarObject3D:new t,historyChanged:new t},this.config=new Config("threejs-editor"),this.history=new History(this),this.storage=new Storage,this.loader=new Loader(this),this.camera=this.DEFAULT_CAMERA.clone(),this.scene=new THREE.Scene,this.scene.name="Scene",this.scene.background=new THREE.Color(11184810),this.sceneHelpers=new THREE.Scene,this.object={},this.geometries={},this.materials={},this.textures={},this.scripts={},this.selected=null,this.helpers={}};Editor.prototype={setTheme:function(t){document.getElementById("theme").href=t,this.signals.themeChanged.dispatch(t)},setScene:function(t){for(this.scene.uuid=t.uuid,this.scene.name=t.name,null!==t.background&&(this.scene.background=t.background.clone()),null!==t.fog&&(this.scene.fog=t.fog.clone()),this.scene.userData=JSON.parse(JSON.stringify(t.userData)),this.signals.sceneGraphChanged.active=!1;t.children.length>0;)this.addObject(t.children[0]);this.signals.sceneGraphChanged.active=!0,this.signals.sceneGraphChanged.dispatch()},addObject:function(t){var e=this;t.traverse(function(t){void 0!==t.geometry&&e.addGeometry(t.geometry),void 0!==t.material&&e.addMaterial(t.material),e.addHelper(t)}),this.scene.add(t),this.signals.objectAdded.dispatch(t),this.signals.sceneGraphChanged.dispatch()},moveObject:function(t,e,i){if(void 0===e&&(e=this.scene),e.add(t),void 0!==i){var r=e.children.indexOf(i);e.children.splice(r,0,t),e.children.pop()}this.signals.sceneGraphChanged.dispatch()},nameObject:function(t,e){t.name=e,this.signals.sceneGraphChanged.dispatch()},removeObject:function(t){if(null!==t.parent){var e=this;t.traverse(function(t){e.removeHelper(t)}),t.parent.remove(t),this.signals.objectRemoved.dispatch(t),this.signals.sceneGraphChanged.dispatch()}},addGeometry:function(t){this.geometries[t.uuid]=t},setGeometryName:function(t,e){t.name=e,this.signals.sceneGraphChanged.dispatch()},addMaterial:function(t){this.materials[t.uuid]=t},setMaterialName:function(t,e){t.name=e,this.signals.sceneGraphChanged.dispatch()},addTexture:function(t){this.textures[t.uuid]=t},addHelper:function(){var t=new THREE.SphereBufferGeometry(2,4,2),e=new THREE.MeshBasicMaterial({color:16711680,visible:!1});return function(i){var r;if(i instanceof THREE.Camera)r=new THREE.CameraHelper(i,1);else if(i instanceof THREE.PointLight)r=new THREE.PointLightHelper(i,1);else if(i instanceof THREE.DirectionalLight)r=new THREE.DirectionalLightHelper(i,1);else if(i instanceof THREE.SpotLight)r=new THREE.SpotLightHelper(i,1);else if(i instanceof THREE.HemisphereLight)r=new THREE.HemisphereLightHelper(i,1);else{if(!(i instanceof THREE.SkinnedMesh))return;r=new THREE.SkeletonHelper(i)}var n=new THREE.Mesh(t,e);n.name="picker",n.userData.object=i,r.add(n),this.sceneHelpers.add(r),this.helpers[i.id]=r,this.signals.helperAdded.dispatch(r)}}(),removeHelper:function(t){if(void 0!==this.helpers[t.id]){var e=this.helpers[t.id];e.parent.remove(e),delete this.helpers[t.id],this.signals.helperRemoved.dispatch(e)}},addScript:function(t,e){void 0===this.scripts[t.uuid]&&(this.scripts[t.uuid]=[]),this.scripts[t.uuid].push(e),this.signals.scriptAdded.dispatch(e)},removeScript:function(t,e){if(void 0!==this.scripts[t.uuid]){var i=this.scripts[t.uuid].indexOf(e);-1!==i&&this.scripts[t.uuid].splice(i,1),this.signals.scriptRemoved.dispatch(e)}},getObjectMaterial:function(t,e){var i=t.material;return Array.isArray(i)&&(i=i[e]),i},setObjectMaterial:function(t,e,i){Array.isArray(t.material)?t.material[e]=i:t.material=i},select:function(t){if(this.selected!==t){var e=null;null!==t&&(e=t.uuid),this.selected=t,this.config.setKey("selected",e),this.signals.objectSelected.dispatch(t)}},selectById:function(t){t!==this.camera.id?this.select(this.scene.getObjectById(t,!0)):this.select(this.camera)},selectByUuid:function(t){var e=this;this.scene.traverse(function(i){i.uuid===t&&e.select(i)})},deselect:function(){this.select(null)},focus:function(t){this.signals.objectFocused.dispatch(t)},focusById:function(t){this.focus(this.scene.getObjectById(t,!0))},clear:function(){this.history.clear(),this.storage.clear(),this.camera.copy(this.DEFAULT_CAMERA),this.scene.background.setHex(11184810),this.scene.fog=null;for(var t=this.scene.children;t.length>0;)this.removeObject(t[0]);this.geometries={},this.materials={},this.textures={},this.scripts={},this.deselect(),this.signals.editorCleared.dispatch()},fromJSON:function(t){var e=new THREE.ObjectLoader;if(void 0!==t.scene){var i=e.parse(t.camera);this.camera.copy(i),this.camera.aspect=this.DEFAULT_CAMERA.aspect,this.camera.updateProjectionMatrix(),this.history.fromJSON(t.history),this.scripts=t.scripts,this.setScene(e.parse(t.scene))}else this.setScene(e.parse(t))},toJSON:function(){var t=this.scene,e=this.scripts;for(var i in e){0!==e[i].length&&void 0!==t.getObjectByProperty("uuid",i)||delete e[i]}return{metadata:{},project:{gammaInput:this.config.getKey("project/renderer/gammaInput"),gammaOutput:this.config.getKey("project/renderer/gammaOutput"),shadows:this.config.getKey("project/renderer/shadows"),vr:this.config.getKey("project/vr")},camera:this.camera.toJSON(),scene:this.scene.toJSON(),scripts:this.scripts,history:this.history.toJSON()}},objectByUuid:function(t){return this.scene.getObjectByProperty("uuid",t,!0)},execute:function(t,e){this.history.execute(t,e)},undo:function(){this.history.undo()},redo:function(){this.history.redo()}};var Config=function(t){var e={autosave:!0,theme:"css/light.css","project/renderer":"WebGLRenderer","project/renderer/antialias":!0,"project/renderer/gammaInput":!1,"project/renderer/gammaOutput":!1,"project/renderer/shadows":!0,"project/vr":!1,"settings/history":!1};if(void 0===window.localStorage[t])window.localStorage[t]=JSON.stringify(e);else{var i=JSON.parse(window.localStorage[t]);for(var r in i)e[r]=i[r]}return{getKey:function(t){return e[t]},setKey:function(){for(var i=0,r=arguments.length;i<r;i+=2)e[arguments[i]]=arguments[i+1];window.localStorage[t]=JSON.stringify(e)},clear:function(){delete window.localStorage[t]}}},Loader=function(t){var e=this;t.signals;function i(i,r,n){switch(void 0===i.metadata&&(i.metadata={type:"Geometry"}),void 0===i.metadata.type&&(i.metadata.type="Geometry"),void 0!==i.metadata.formatVersion&&(i.metadata.version=i.metadata.formatVersion),i.metadata.type.toLowerCase()){case"buffergeometry":var o=(l=new THREE.BufferGeometryLoader).parse(i),a=new THREE.Mesh(o);t.execute(new AddObjectCommand(a));break;case"geometry":(l=new THREE.JSONLoader).setTexturePath(e.texturePath);var s,h=(o=l.parse(i)).geometry;s=void 0!==o.materials?o.materials.length>1?new THREE.MultiMaterial(o.materials):o.materials[0]:new THREE.MeshStandardMaterial,h.sourceType="ascii",h.sourceFile=r.name,(a=h.animation&&h.animation.hierarchy?new THREE.SkinnedMesh(h,s):new THREE.Mesh(h,s)).name=n,t.execute(new AddObjectCommand(a));break;case"object":var l;(l=new THREE.ObjectLoader).setTexturePath(e.texturePath),(o=l.parse(i))instanceof THREE.Scene?t.execute(new SetSceneCommand(o)):t.execute(new AddObjectCommand(o));break;case"app":t.fromJSON(i)}}this.texturePath="",this.loadFile=function(e){var r=e.name,n=r.split(".").pop().toLowerCase(),o=new FileReader;switch(o.addEventListener("progress",function(t){Math.floor(t.total/1e3).format(),Math.floor(t.loaded/t.total*100)}),n){case"3ds":o.addEventListener("load",function(e){var i=(new THREE.TDSLoader).parse(e.target.result);t.execute(new AddObjectCommand(i))},!1),o.readAsArrayBuffer(e);break;case"amf":o.addEventListener("load",function(e){var i=(new THREE.AMFLoader).parse(e.target.result);t.execute(new AddObjectCommand(i))},!1),o.readAsArrayBuffer(e);break;case"awd":o.addEventListener("load",function(e){var i=(new THREE.AWDLoader).parse(e.target.result);t.execute(new SetSceneCommand(i))},!1),o.readAsArrayBuffer(e);break;case"babylon":o.addEventListener("load",function(e){var i=e.target.result,r=JSON.parse(i),n=(new THREE.BabylonLoader).parse(r);t.execute(new SetSceneCommand(n))},!1),o.readAsText(e);break;case"babylonmeshdata":o.addEventListener("load",function(e){var i=e.target.result,n=JSON.parse(i),o=(new THREE.BabylonLoader).parseGeometry(n),a=new THREE.MeshStandardMaterial,s=new THREE.Mesh(o,a);s.name=r,t.execute(new AddObjectCommand(s))},!1),o.readAsText(e);break;case"ctm":o.addEventListener("load",function(i){var n=new Uint8Array(i.target.result),o=new CTM.Stream(n);o.offset=0,(new THREE.CTMLoader).createModel(new CTM.File(o),function(i){i.sourceType="ctm",i.sourceFile=e.name;var n=new THREE.MeshStandardMaterial,o=new THREE.Mesh(i,n);o.name=r,t.execute(new AddObjectCommand(o))})},!1),o.readAsArrayBuffer(e);break;case"dae":o.addEventListener("load",function(e){var i=e.target.result,n=(new THREE.ColladaLoader).parse(i);n.scene.name=r,t.execute(new AddObjectCommand(n.scene))},!1),o.readAsText(e);break;case"fbx":o.addEventListener("load",function(e){var i=e.target.result,r=(new THREE.FBXLoader).parse(i);t.execute(new AddObjectCommand(r))},!1),o.readAsArrayBuffer(e);break;case"glb":case"gltf":o.addEventListener("load",function(e){var i=e.target.result;(new THREE.GLTFLoader).parse(i,"",function(e){e.scene.name=r,t.execute(new AddObjectCommand(e.scene))})},!1),o.readAsArrayBuffer(e);break;case"js":case"json":case"3geo":case"3mat":case"3obj":case"3scn":o.addEventListener("load",function(t){var n,o=t.target.result;if(-1!==o.indexOf("postMessage")){var a=new Blob([o],{type:"text/javascript"}),s=URL.createObjectURL(a),h=new Worker(s);return h.onmessage=function(t){t.data.metadata={version:2},i(t.data,e,r)},void h.postMessage(Date.now())}try{n=JSON.parse(o)}catch(t){return}i(n,e,r)},!1),o.readAsText(e);break;case"kmz":o.addEventListener("load",function(e){var i=(new THREE.KMZLoader).parse(e.target.result);i.scene.name=r,t.execute(new AddObjectCommand(i.scene))},!1),o.readAsArrayBuffer(e);break;case"md2":o.addEventListener("load",function(e){var i=e.target.result,n=(new THREE.MD2Loader).parse(i),o=new THREE.MeshStandardMaterial({morphTargets:!0,morphNormals:!0}),a=new THREE.Mesh(n,o);a.mixer=new THREE.AnimationMixer(a),a.name=r,t.execute(new AddObjectCommand(a))},!1),o.readAsArrayBuffer(e);break;case"obj":o.addEventListener("load",function(e){var i=e.target.result,n=(new THREE.OBJLoader).parse(i);n.name=r,t.execute(new AddObjectCommand(n))},!1),o.readAsText(e);break;case"playcanvas":o.addEventListener("load",function(e){var i=e.target.result,r=JSON.parse(i),n=(new THREE.PlayCanvasLoader).parse(r);t.execute(new AddObjectCommand(n))},!1),o.readAsText(e);break;case"ply":o.addEventListener("load",function(i){var n=i.target.result,o=(new THREE.PLYLoader).parse(n);o.sourceType="ply",o.sourceFile=e.name;var a=new THREE.MeshStandardMaterial,s=new THREE.Mesh(o,a);s.name=r,t.execute(new AddObjectCommand(s))},!1),o.readAsArrayBuffer(e);break;case"stl":o.addEventListener("load",function(i){var n=i.target.result,o=(new THREE.STLLoader).parse(n);o.sourceType="stl",o.sourceFile=e.name;var a=new THREE.MeshStandardMaterial,s=new THREE.Mesh(o,a);s.name=r,t.execute(new AddObjectCommand(s))},!1),void 0!==o.readAsBinaryString?o.readAsBinaryString(e):o.readAsArrayBuffer(e);break;case"vtk":o.addEventListener("load",function(i){var n=i.target.result,o=(new THREE.VTKLoader).parse(n);o.sourceType="vtk",o.sourceFile=e.name;var a=new THREE.MeshStandardMaterial,s=new THREE.Mesh(o,a);s.name=r,t.execute(new AddObjectCommand(s))},!1),o.readAsText(e);break;case"wrl":o.addEventListener("load",function(e){var i=e.target.result,r=(new THREE.VRMLLoader).parse(i);t.execute(new SetSceneCommand(r))},!1),o.readAsText(e);break;case"zip":o.addEventListener("load",function(e){var i=e.target.result,r=new JSZip(i);if(r.files["model.obj"]&&r.files["materials.mtl"]){var n=(new THREE.MTLLoader).parse(r.file("materials.mtl").asText()),o=(new THREE.OBJLoader).setMaterials(n).parse(r.file("model.obj").asText());t.execute(new AddObjectCommand(o))}},!1),o.readAsBinaryString(e)}}},Viewport=function(t){var e=t.signals,i=new UI.Panel;i.setId("viewport"),i.setPosition("absolute"),i.add(new Viewport.Info(t));var r=null,n=t.camera,o=t.scene,a=t.sceneHelpers,s=[],h=new THREE.GridHelper(60,60);a.add(h);var l=new THREE.Box3,c=new THREE.BoxHelper;c.material.depthTest=!1,c.material.transparent=!0,c.visible=!1,a.add(c);var u=null,p=null,d=null,f=new THREE.TransformControls(n,i.dom);f.addEventListener("change",function(){var i=f.object;void 0!==i&&(c.setFromObject(i),void 0!==t.helpers[i.id]&&t.helpers[i.id].update(),e.refreshSidebarObject3D.dispatch(i)),R()}),f.addEventListener("mouseDown",function(){var t=f.object;u=t.position.clone(),p=t.rotation.clone(),d=t.scale.clone(),T.enabled=!1}),f.addEventListener("mouseUp",function(){var e=f.object;if(void 0!==e)switch(f.getMode()){case"translate":u.equals(e.position)||t.execute(new SetPositionCommand(e,e.position,u));break;case"rotate":p.equals(e.rotation)||t.execute(new SetRotationCommand(e,e.rotation,p));break;case"scale":d.equals(e.scale)||t.execute(new SetScaleCommand(e,e.scale,d))}T.enabled=!0}),a.add(f);var m=new THREE.Raycaster,g=new THREE.Vector2;function v(t,e){return g.set(2*t.x-1,-2*t.y+1),m.setFromCamera(g,n),m.intersectObjects(e)}var y=new THREE.Vector2,E=new THREE.Vector2,x=new THREE.Vector2;function _(t,e,i){var r=t.getBoundingClientRect();return[(e-r.left)/r.width,(i-r.top)/r.height]}function w(){if(0===y.distanceTo(E)){var e=v(E,s);if(e.length>0){var i=e[0].object;void 0!==i.userData.object?t.select(i.userData.object):t.select(i)}else t.select(null);R()}}function b(t){var e=_(i.dom,t.clientX,t.clientY);E.fromArray(e),w(),document.removeEventListener("mouseup",b,!1)}function S(t){var e=t.changedTouches[0],r=_(i.dom,e.clientX,e.clientY);E.fromArray(r),w(),document.removeEventListener("touchend",S,!1)}i.dom.addEventListener("mousedown",function(t){t.preventDefault();var e=_(i.dom,t.clientX,t.clientY);y.fromArray(e),document.addEventListener("mouseup",b,!1)},!1),i.dom.addEventListener("touchstart",function(t){var e=t.changedTouches[0],r=_(i.dom,e.clientX,e.clientY);y.fromArray(r),document.addEventListener("touchend",S,!1)},!1),i.dom.addEventListener("dblclick",function(t){var r=_(i.dom,t.clientX,t.clientY);x.fromArray(r);var n=v(x,s);if(n.length>0){var o=n[0];e.objectFocused.dispatch(o.object)}},!1);var T=new THREE.EditorControls(n,i.dom);T.addEventListener("change",function(){f.update(),e.cameraChanged.dispatch(n)}),e.editorCleared.add(function(){T.center.set(0,0,0),R()}),e.themeChanged.add(function(t){switch(t){case"css/light.css":a.remove(h),h=new THREE.GridHelper(60,60,4473924,8947848),a.add(h);break;case"css/dark.css":a.remove(h),h=new THREE.GridHelper(60,60,12303291,8947848),a.add(h)}R()}),e.transformModeChanged.add(function(t){f.setMode(t)}),e.snapChanged.add(function(t){f.setTranslationSnap(t)}),e.spaceChanged.add(function(t){f.setSpace(t)}),e.rendererChanged.add(function(t){null!==r&&i.dom.removeChild(r.domElement),(r=t).autoClear=!1,r.autoUpdateScene=!1,r.setPixelRatio(window.devicePixelRatio),r.setSize(i.dom.offsetWidth,i.dom.offsetHeight),i.dom.appendChild(r.domElement),R()}),e.sceneGraphChanged.add(function(){R()}),e.cameraChanged.add(function(){R()}),e.objectSelected.add(function(t){c.visible=!1,f.detach(),null!==t&&t!==o&&t!==n&&(l.setFromObject(t),!1===l.isEmpty()&&(c.setFromObject(t),c.visible=!0),f.attach(t)),R()}),e.objectFocused.add(function(t){T.focus(t)}),e.geometryChanged.add(function(t){void 0!==t&&c.setFromObject(t),R()}),e.objectAdded.add(function(t){t.traverse(function(t){s.push(t)})}),e.objectChanged.add(function(e){t.selected===e&&(c.setFromObject(e),f.update()),e instanceof THREE.PerspectiveCamera&&e.updateProjectionMatrix(),void 0!==t.helpers[e.id]&&t.helpers[e.id].update(),R()}),e.objectRemoved.add(function(t){t.traverse(function(t){s.splice(s.indexOf(t),1)})}),e.helperAdded.add(function(t){s.push(t.getObjectByName("picker"))}),e.helperRemoved.add(function(t){s.splice(s.indexOf(t.getObjectByName("picker")),1)}),e.materialChanged.add(function(t){R()}),e.sceneBackgroundChanged.add(function(t){o.background.setHex(t),R()});var M=null;function R(){a.updateMatrixWorld(),o.updateMatrixWorld(),r.render(o,n),r instanceof THREE.RaytracingRenderer==!1&&r.render(a,n)}return e.sceneFogChanged.add(function(t,e,i,r,n){if(M!==t){switch(t){case"None":o.fog=null;break;case"Fog":o.fog=new THREE.Fog;break;case"FogExp2":o.fog=new THREE.FogExp2}M=t}o.fog instanceof THREE.Fog?(o.fog.color.setHex(e),o.fog.near=i,o.fog.far=r):o.fog instanceof THREE.FogExp2&&(o.fog.color.setHex(e),o.fog.density=n),R()}),e.windowResize.add(function(){t.DEFAULT_CAMERA.aspect=i.dom.offsetWidth/i.dom.offsetHeight,t.DEFAULT_CAMERA.updateProjectionMatrix(),n.aspect=i.dom.offsetWidth/i.dom.offsetHeight,n.updateProjectionMatrix(),r.setSize(i.dom.offsetWidth,i.dom.offsetHeight),R()}),e.showGridChanged.add(function(t){h.visible=t,R()}),i};Viewport.Info=function(t){var e=t.signals,i=new UI.Panel;i.setId("info"),i.setPosition("absolute"),i.setLeft("10px"),i.setBottom("10px"),i.setFontSize("12px"),i.setColor("#fff");var r=new UI.Text("0").setMarginLeft("6px"),n=new UI.Text("0").setMarginLeft("6px"),o=new UI.Text("0").setMarginLeft("6px");function a(){for(var e=t.scene,i=0,a=0,s=0,h=0,l=e.children.length;h<l;h++){e.children[h].traverseVisible(function(t){if(i++,t instanceof THREE.Mesh){var e=t.geometry;e instanceof THREE.Geometry?(a+=e.vertices.length,s+=e.faces.length):e instanceof THREE.BufferGeometry&&(null!==e.index?(a+=3*e.index.count,s+=e.index.count):(a+=e.attributes.position.count,s+=e.attributes.position.count/3))}})}r.setValue(i.format()),n.setValue(a.format()),o.setValue(s.format())}return i.add(new UI.Text("objects"),r,new UI.Break),i.add(new UI.Text("vertices"),n,new UI.Break),i.add(new UI.Text("triangles"),o,new UI.Break),e.objectAdded.add(a),e.objectRemoved.add(a),e.geometryChanged.add(a),i},THREE.SubdivisionModifier=function(t){this.subdivisions=void 0===t?1:t},THREE.SubdivisionModifier.prototype.modify=function(t){for(var e=this.subdivisions;e-- >0;)this.smooth(t);t.computeFaceNormals(),t.computeVertexNormals()},function(){var t=["a","b","c"];function e(t,e,i){return i[Math.min(t,e)+"_"+Math.max(t,e)]}function i(t,e,i,r,n,o){var a,s=Math.min(t,e),h=Math.max(t,e),l=s+"_"+h;l in r?a=r[l]:(a={a:i[s],b:i[h],newEdge:null,faces:[]},r[l]=a);a.faces.push(n),o[t].edges.push(a),o[e].edges.push(a)}function r(t,e,i,r){t.push(new THREE.Face3(e,i,r))}function n(t,e){return Math.abs(e-t)/2+Math.min(t,e)}function o(t,e,i,r){t.push([e.clone(),i.clone(),r.clone()])}THREE.SubdivisionModifier.prototype.smooth=function(a){var s,h,l,c,u,p,d,f,m,g,v,y,E,x,_=new THREE.Vector3,w=[];s=a.vertices,h=a.faces;var b,S,T,M,R,A,C,P,D,L,O,H,I,B,z=void 0!==(l=a.faceVertexUvs[0])&&l.length>0;for(d in function(t,e,r,n){var o,a,s;for(o=0,a=t.length;o<a;o++)r[o]={edges:[]};for(o=0,a=e.length;o<a;o++)i((s=e[o]).a,s.b,t,n,s,r),i(s.b,s.c,t,n,s,r),i(s.c,s.a,t,n,s,r)}(s,h,v=new Array(s.length),y={}),E=[],y){for(S=y[d],T=new THREE.Vector3,R=3/8,A=1/8,2!=(C=S.faces.length)&&(R=.5,A=0),T.addVectors(S.a,S.b).multiplyScalar(R),_.set(0,0,0),m=0;m<C;m++){for(M=S.faces[m],g=0;g<3&&((b=s[M[t[g]]])===S.a||b===S.b);g++);_.add(b)}_.multiplyScalar(A),T.add(_),S.newEdge=E.length,E.push(T)}for(x=[],d=0,f=s.length;d<f;d++){for(I=s[d],3==(p=(H=v[d].edges).length)?P=3/16:p>3&&(P=3/(8*p)),D=1-p*P,L=P,p<=2&&2==p&&(D=.75,L=1/8),B=I.clone().multiplyScalar(D),_.set(0,0,0),m=0;m<p;m++)b=(O=H[m]).a!==I?O.a:O.b,_.add(b);_.multiplyScalar(L),B.add(_),x.push(B)}c=x.concat(E);var N,k,j,V,F,U,G,W=x.length;u=[];var X=new THREE.Vector2,Z=new THREE.Vector2,Y=new THREE.Vector2;for(d=0,f=h.length;d<f;d++)r(u,N=e((M=h[d]).a,M.b,y).newEdge+W,k=e(M.b,M.c,y).newEdge+W,j=e(M.c,M.a,y).newEdge+W),r(u,M.a,N,j),r(u,M.b,k,N),r(u,M.c,j,k),z&&(F=(V=l[d])[0],U=V[1],G=V[2],X.set(n(F.x,U.x),n(F.y,U.y)),Z.set(n(U.x,G.x),n(U.y,G.y)),Y.set(n(F.x,G.x),n(F.y,G.y)),o(w,X,Z,Y),o(w,F,X,Y),o(w,U,Z,X),o(w,G,Y,Z));a.vertices=c,a.faces=u,z&&(a.faceVertexUvs[0]=w)}}();var SEA3D={VERSION:18100,getVersion:function(){var t=SEA3D.VERSION.toString(),e=t.length;return t.substring(0,e-4)+"."+t.substring(e-4,e-3)+"."+t.substring(e-3,e-2)+"."+parseFloat(t.substring(e-2,e)).toString()},Stream:function(t){this.position=0,this.buffer=t||new ArrayBuffer}};SEA3D.Stream.NONE=0,SEA3D.Stream.BOOLEAN=1,SEA3D.Stream.BYTE=2,SEA3D.Stream.UBYTE=3,SEA3D.Stream.SHORT=4,SEA3D.Stream.USHORT=5,SEA3D.Stream.INT24=6,SEA3D.Stream.UINT24=7,SEA3D.Stream.INT=8,SEA3D.Stream.UINT=9,SEA3D.Stream.FLOAT=10,SEA3D.Stream.DOUBLE=11,SEA3D.Stream.DECIMAL=12,SEA3D.Stream.VECTOR3D=74,SEA3D.Stream.VECTOR4D=106,SEA3D.Stream.STRING_TINY=128,SEA3D.Stream.STRING_SHORT=129,SEA3D.Stream.STRING_LONG=130,SEA3D.Stream.ASSET=200,SEA3D.Stream.GROUP=255,SEA3D.Stream.BLEND_MODE=["normal","add","subtract","multiply","dividing","mix","alpha","screen","darken","overlay","colorburn","linearburn","lighten","colordodge","lineardodge","softlight","hardlight","pinlight","spotlight","spotlightblend","hardmix","average","difference","exclusion","hue","saturation","color","value","linearlight","grainextract","reflect","glow","darkercolor","lightercolor","phoenix","negation"],SEA3D.Stream.INTERPOLATION_TABLE=["normal","linear","sine.in","sine.out","sine.inout","cubic.in","cubic.out","cubic.inout","quint.in","quint.out","quint.inout","circ.in","circ.out","circ.inout","back.in","back.out","back.inout","quad.in","quad.out","quad.inout","quart.in","quart.out","quart.inout","expo.in","expo.out","expo.inout","elastic.in","elastic.out","elastic.inout","bounce.in","bounce.out","bounce.inout"],SEA3D.Stream.sizeOf=function(t){return 0==t?0:t>=1&&t<=31?1:t>=32&&t<=63?2:t>=64&&t<=95?3:t>=96&&t<=125?4:-1},SEA3D.Stream.prototype={constructor:SEA3D.Stream,set buffer(t){this.buf=t,this.length=t.byteLength,this.data=new DataView(t)},get buffer(){return this.buf},get bytesAvailable(){return this.length-this.position}},SEA3D.Stream.prototype.getByte=function(t){return this.data.getInt8(t)},SEA3D.Stream.prototype.readBytes=function(t){var e=this.buf.slice(this.position,this.position+t);return this.position+=t,e},SEA3D.Stream.prototype.readByte=function(){return this.data.getInt8(this.position++)},SEA3D.Stream.prototype.readUByte=function(){return this.data.getUint8(this.position++)},SEA3D.Stream.prototype.readBool=function(){return 0!=this.data.getInt8(this.position++)},SEA3D.Stream.prototype.readShort=function(){var t=this.data.getInt16(this.position,!0);return this.position+=2,t},SEA3D.Stream.prototype.readUShort=function(){var t=this.data.getUint16(this.position,!0);return this.position+=2,t},SEA3D.Stream.prototype.readUInt24=function(){var t=16777215&this.data.getUint32(this.position,!0);return this.position+=3,t},SEA3D.Stream.prototype.readUInt24F=function(){return this.readUShort()|this.readUByte()<<16},SEA3D.Stream.prototype.readInt=function(){var t=this.data.getInt32(this.position,!0);return this.position+=4,t},SEA3D.Stream.prototype.readUInt=function(){var t=this.data.getUint32(this.position,!0);return this.position+=4,t},SEA3D.Stream.prototype.readFloat=function(){var t=this.data.getFloat32(this.position,!0);return this.position+=4,t},SEA3D.Stream.prototype.readUInteger=function(){var t=this.readUByte(),e=127&t;return 0!=(128&t)&&(e|=(127&(t=this.readUByte()))<<7,0!=(128&t)&&(e|=(127&(t=this.readUByte()))<<13)),e},SEA3D.Stream.prototype.readVector2=function(){return{x:this.readFloat(),y:this.readFloat()}},SEA3D.Stream.prototype.readVector3=function(){return{x:this.readFloat(),y:this.readFloat(),z:this.readFloat()}},SEA3D.Stream.prototype.readVector4=function(){return{x:this.readFloat(),y:this.readFloat(),z:this.readFloat(),w:this.readFloat()}},SEA3D.Stream.prototype.readMatrix=function(){var t=new Float32Array(16);return t[0]=this.readFloat(),t[1]=this.readFloat(),t[2]=this.readFloat(),t[3]=0,t[4]=this.readFloat(),t[5]=this.readFloat(),t[6]=this.readFloat(),t[7]=0,t[8]=this.readFloat(),t[9]=this.readFloat(),t[10]=this.readFloat(),t[11]=0,t[12]=this.readFloat(),t[13]=this.readFloat(),t[14]=this.readFloat(),t[15]=1,t},SEA3D.Stream.prototype.readUTF8=function(t){var e=this.readBytes(t);return window.TextDecoder?(new TextDecoder).decode(e):decodeURIComponent(escape(String.fromCharCode.apply(null,new Uint8Array(e))))},SEA3D.Stream.prototype.readExt=function(){return this.readUTF8(4).replace(/\0/g,"")},SEA3D.Stream.prototype.readUTF8Tiny=function(){return this.readUTF8(this.readUByte())},SEA3D.Stream.prototype.readUTF8Short=function(){return this.readUTF8(this.readUShort())},SEA3D.Stream.prototype.readUTF8Long=function(){return this.readUTF8(this.readUInt())},SEA3D.Stream.prototype.readUByteArray=function(t){var e=new Uint8Array(t);return SEA3D.Stream.memcpy(e.buffer,0,this.buffer,this.position,t),this.position+=t,e},SEA3D.Stream.prototype.readUShortArray=function(t){var e=new Uint16Array(t),i=2*t;return SEA3D.Stream.memcpy(e.buffer,0,this.buffer,this.position,i),this.position+=i,e},SEA3D.Stream.prototype.readUInt24Array=function(t){for(var e=new Uint32Array(t),i=0;i<t;i++)e[i]=this.readUInt24();return e},SEA3D.Stream.prototype.readUIntArray=function(t){var e=new Uint32Array(t),i=4*t;return SEA3D.Stream.memcpy(e.buffer,0,this.buffer,this.position,i),this.position+=i,e},SEA3D.Stream.prototype.readFloatArray=function(t){var e=new Float32Array(t),i=4*t;return SEA3D.Stream.memcpy(e.buffer,0,this.buffer,this.position,i),this.position+=i,e},SEA3D.Stream.prototype.readBlendMode=function(){return SEA3D.Stream.BLEND_MODE[this.readUByte()]},SEA3D.Stream.prototype.readInterpolation=function(){return SEA3D.Stream.INTERPOLATION_TABLE[this.readUByte()]},SEA3D.Stream.prototype.readTags=function(t){for(var e=this.readUByte(),i=0;i<e;++i){var r=this.readUShort(),n=this.readUInt(),o=this.position;t(r,this,n),this.position=o+=n}},SEA3D.Stream.prototype.readProperties=function(t){var e=this.readUByte(),i={},r={};i.__type=r;for(var n=0;n<e;n++){var o=this.readUTF8Tiny(),a=this.readUByte();r[o]=a,i[o]=a==SEA3D.Stream.GROUP?this.readProperties(t):this.readToken(a,t)}return i},SEA3D.Stream.prototype.readAnimationList=function(t){for(var e=[],i=this.readUByte(),r=0;r<i;){var n=this.readUByte(),o={};o.relative=0!=(1&n),2&n&&(o.timeScale=this.readFloat()),o.tag=t.getObject(this.readUInt()),e[r++]=o}return e},SEA3D.Stream.prototype.readScriptList=function(t){for(var e=[],i=this.readUByte(),r=0;r<i;){var n=this.readUByte(),o={};if(o.priority=1&n|2&n,4&n){var a=this.readUByte();o.params={};for(var s=0;s<a;s++){var h=this.readUTF8Tiny();o.params[h]=this.readObject(t)}}8&n&&(o.method=this.readUTF8Tiny()),o.tag=t.getObject(this.readUInt()),e[r++]=o}return e},SEA3D.Stream.prototype.readObject=function(t){return this.readToken(this.readUByte(),t)},SEA3D.Stream.prototype.readToken=function(t,e){switch(t){case SEA3D.Stream.BOOLEAN:return this.readBool();case SEA3D.Stream.UBYTE:return this.readUByte();case SEA3D.Stream.USHORT:return this.readUShort();case SEA3D.Stream.UINT24:return this.readUInt24();case SEA3D.Stream.INT:return this.readInt();case SEA3D.Stream.UINT:return this.readUInt();case SEA3D.Stream.FLOAT:return this.readFloat();case SEA3D.Stream.VECTOR3D:return this.readVector3();case SEA3D.Stream.VECTOR4D:return this.readVector4();case SEA3D.Stream.STRING_TINY:return this.readUTF8Tiny();case SEA3D.Stream.STRING_SHORT:return this.readUTF8Short();case SEA3D.Stream.STRING_LONG:return this.readUTF8Long();case SEA3D.Stream.ASSET:var i=this.readUInt();return i>0?e.getObject(i-1).tag:null}return null},SEA3D.Stream.prototype.readVector=function(t,e,i){var r=SEA3D.Stream.sizeOf(t),n=i*r+e*r;switch(t){case SEA3D.Stream.BOOLEAN:case SEA3D.Stream.UBYTE:return this.readUByteArray(n);case SEA3D.Stream.USHORT:return this.readUShortArray(n);case SEA3D.Stream.UINT24:return this.readUInt24Array(n);case SEA3D.Stream.UINT:return this.readUIntArray(n);case SEA3D.Stream.FLOAT:case SEA3D.Stream.VECTOR3D:case SEA3D.Stream.VECTOR4D:return this.readFloatArray(n)}},SEA3D.Stream.prototype.append=function(t){var e=new ArrayBuffer(this.data.byteLength+t.byteLength);e.set(new ArrayBuffer(this.data),0),e.set(new ArrayBuffer(t),this.data.byteLength),this.data=e},SEA3D.Stream.prototype.concat=function(t,e){return new SEA3D.Stream(this.buffer.slice(t,t+e))},SEA3D.Stream.memcpy=function(t,e,i,r,n){var o=new Uint8Array(t,e,n),a=new Uint8Array(i,r,n);o.set(a)},SEA3D.UByteArray=function(){this.ubytes=[],this.length=0},SEA3D.UByteArray.prototype={constructor:SEA3D.UByteArray,add:function(t){this.ubytes.push(t),this.length+=t.byteLength},toBuffer:function(){for(var t=new Uint8Array(this.length),e=0,i=0;e<this.ubytes.length;e++)t.set(this.ubytes[e],i),i+=this.ubytes[e].byteLength;return t.buffer}},SEA3D.Math={DEGREES:180/Math.PI,RADIANS:Math.PI/180},SEA3D.Math.angle=function(t){var e=t<0;return(t=(e?-t:t)%360)>180&&(t=t-180-180),e?-t:t},SEA3D.Math.lerpAngle=function(t,e,i){return Math.abs(t-e)>180&&(t>e?e+=360:e-=360),t+=(e-t)*i,SEA3D.Math.angle(t)},SEA3D.Math.lerpColor=function(t,e,i){var r=t>>24&255,n=t>>16&255,o=t>>8&255,a=255&t;return(r+=((e>>24&255)-r)*i)<<24|(n+=((e>>16&255)-n)*i)<<16|(o+=((e>>8&255)-o)*i)<<8|(a+=((255&e)-a)*i)},SEA3D.Math.lerp=function(t,e,i){return t+(e-t)*i},SEA3D.Math.lerp1x=function(t,e,i){t[0]+=(e[0]-t[0])*i},SEA3D.Math.lerp3x=function(t,e,i){t[0]+=(e[0]-t[0])*i,t[1]+=(e[1]-t[1])*i,t[2]+=(e[2]-t[2])*i},SEA3D.Math.lerpAng1x=function(t,e,i){t[0]=SEA3D.Math.lerpAngle(t[0],e[0],i)},SEA3D.Math.lerpColor1x=function(t,e,i){t[0]=SEA3D.Math.lerpColor(t[0],e[0],i)},SEA3D.Math.lerpQuat4x=function(t,e,i){var r,n,o,a,s,h=t[0],l=t[1],c=t[2],u=t[3],p=e[0],d=e[1],f=e[2],m=e[3];h*p+l*d+c*f+u*m<0&&(p=-p,d=-d,f=-f,m=-m),r=h+i*(p-h),n=l+i*(d-l),o=c+i*(f-c),a=u+i*(m-u),s=1/Math.sqrt(a*a+r*r+n*n+o*o),t[0]=r*s,t[1]=n*s,t[2]=o*s,t[3]=a*s},SEA3D.Timer=function(){this.time=this.start=Date.now()},SEA3D.Timer.prototype={constructor:SEA3D.Timer,get now(){return Date.now()},get deltaTime(){return Date.now()-this.time},get elapsedTime(){return Date.now()-this.start},update:function(){this.time=Date.now()}},SEA3D.Object=function(t,e,i,r){this.name=t,this.data=e,this.type=i,this.sea3d=r},SEA3D.GeometryBase=function(t,e,i){this.name=t,this.data=e,this.sea3d=i,this.attrib=e.readUShort(),this.isBig=0!=(1&this.attrib),e.readVInt=this.isBig?e.readUInt:e.readUShort,this.numVertex=e.readVInt(),this.length=3*this.numVertex},SEA3D.Geometry=function(t,e,i){var r,n,o;if(SEA3D.GeometryBase.call(this,t,e,i),4&this.attrib&&(this.normal=e.readFloatArray(this.length)),8&this.attrib&&(this.tangent=e.readFloatArray(this.length)),32&this.attrib)for(this.uv=[],this.uv.length=e.readUByte(),o=2*this.numVertex,r=0;r<this.uv.length;)this.uv[r++]=e.readFloatArray(o);if(64&this.attrib){this.jointPerVertex=e.readUByte();var a=this.numVertex*this.jointPerVertex;this.joint=e.readUShortArray(a),this.weight=e.readFloatArray(a)}if(128&this.attrib){var s=e.readUByte();for(this.numColor=1+((64&s)>>6|(128&s)>>6),this.color=[],r=0,o=15&s;r<o;r++)this.color.push(e.readFloatArray(this.numVertex*this.numColor))}this.vertex=e.readFloatArray(this.length);var h=e.readUByte();if(this.groups=[],1024&this.attrib){for(r=0,o=0;r<h;r++)n=3*e.readVInt(),this.groups.push({start:o,count:n}),o+=n;this.indexes=this.isBig?e.readUIntArray(o):e.readUShortArray(o)}else{var l=this.isBig?4:2,c=new SEA3D.UByteArray;for(r=0,n=0;r<h;r++)o=3*e.readVInt(),this.groups.push({start:n,count:o}),n+=o,c.add(e.readUByteArray(o*l));this.indexes=this.isBig?new Uint32Array(c.toBuffer()):new Uint16Array(c.toBuffer())}},SEA3D.Geometry.prototype=Object.create(SEA3D.GeometryBase.prototype),SEA3D.Geometry.prototype.constructor=SEA3D.Geometry,SEA3D.Geometry.prototype.type="geo",SEA3D.Object3D=function(t,e,i){if(this.name=t,this.data=e,this.sea3d=i,this.isStatic=!1,this.visible=!0,this.attrib=e.readUShort(),1&this.attrib&&(this.parent=i.getObject(e.readUInt())),2&this.attrib&&(this.animations=e.readAnimationList(i)),4&this.attrib&&(this.scripts=e.readScriptList(i)),16&this.attrib&&(this.attributes=i.getObject(e.readUInt())),32&this.attrib){var r=e.readUByte();this.isStatic=0!=(1&r),this.visible=0==(2&r)}},SEA3D.Object3D.prototype.readTag=function(t,e,i){},SEA3D.Entity3D=function(t,e,i){if(SEA3D.Object3D.call(this,t,e,i),this.castShadows=!0,64&this.attrib){var r=e.readUByte();this.castShadows=0==(1&r)}},SEA3D.Entity3D.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.Entity3D.prototype.constructor=SEA3D.Entity3D,SEA3D.Sound3D=function(t,e,i){SEA3D.Object3D.call(this,t,e,i),this.autoPlay=0!=(64&this.attrib),128&this.attrib&&(this.mixer=i.getObject(e.readUInt())),this.sound=i.getObject(e.readUInt()),this.volume=e.readFloat()},SEA3D.Sound3D.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.Sound3D.prototype.constructor=SEA3D.Sound3D,SEA3D.SoundPoint=function(t,e,i){SEA3D.Sound3D.call(this,t,e,i),this.position=e.readVector3(),this.distance=e.readFloat(),e.readTags(this.readTag.bind(this))},SEA3D.SoundPoint.prototype=Object.create(SEA3D.Sound3D.prototype),SEA3D.SoundPoint.prototype.constructor=SEA3D.SoundPoint,SEA3D.SoundPoint.prototype.type="sp",SEA3D.Container3D=function(t,e,i){SEA3D.Object3D.call(this,t,e,i),this.transform=e.readMatrix(),e.readTags(this.readTag.bind(this))},SEA3D.Container3D.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.Container3D.prototype.constructor=SEA3D.Container3D,SEA3D.Container3D.prototype.type="c3d",SEA3D.ScriptURL=function(t,e,i){this.name=t,this.data=e,this.sea3d=i,this.url=e.readUTF8(e.length)},SEA3D.ScriptURL.prototype.type="src",SEA3D.TextureURL=function(t,e,i){this.name=t,this.data=e,this.sea3d=i,this.url=e.readUTF8(e.length)},SEA3D.TextureURL.prototype.type="urlT",SEA3D.CubeMapURL=function(t,e,i){this.name=t,this.data=e,this.sea3d=i,this.faces=[];for(var r=0;r<6;r++)this.faces[r]=e.readUTF8Tiny()},SEA3D.CubeMapURL.prototype.type="cURL",SEA3D.Actions=function(t,e,i){this.name=t,this.data=e,this.sea3d=i,this.count=e.readUInt(),this.actions=[];for(var r=0;r<this.count;r++){var n=e.readUByte(),o=e.readUShort(),a=e.readUShort(),s=e.position,h=this.actions[r]={kind:o};switch(1&n&&(h.range=[e.readUInt(),e.readUInt()]),2&n&&(h.time=e.readUInt()),4&n&&(h.intrpl=e.readInterpolation(),0==h.intrpl.indexOf("back.")?h.intrplParam0=e.readFloat():0==h.intrpl.indexOf("elastic.")&&(h.intrplParam0=e.readFloat(),h.intrplParam1=e.readFloat())),o){case SEA3D.Actions.RTT_TARGET:case SEA3D.Actions.LOOK_AT:h.source=i.getObject(e.readUInt()),h.target=i.getObject(e.readUInt());break;case SEA3D.Actions.PLAY_SOUND:h.sound=i.getObject(e.readUInt()),h.offset=e.readUInt();break;case SEA3D.Actions.PLAY_ANIMATION:h.object=i.getObject(e.readUInt()),h.name=e.readUTF8Tiny();break;case SEA3D.Actions.FOG:h.color=e.readUInt24(),h.min=e.readFloat(),h.max=e.readFloat();break;case SEA3D.Actions.ENVIRONMENT:h.texture=i.getObject(e.readUInt());break;case SEA3D.Actions.ENVIRONMENT_COLOR:h.color=e.readUInt24F();break;case SEA3D.Actions.CAMERA:h.camera=i.getObject(e.readUInt());break;case SEA3D.Actions.SCRIPTS:h.scripts=e.readScriptList(i);break;case SEA3D.Actions.CLASS_OF:h.classof=i.getObject(e.readUInt());break;case SEA3D.Actions.ATTRIBUTES:h.attributes=i.getObject(e.readUInt())}e.position=s+a}},SEA3D.Actions.SCENE=0,SEA3D.Actions.ENVIRONMENT_COLOR=1,SEA3D.Actions.ENVIRONMENT=2,SEA3D.Actions.FOG=3,SEA3D.Actions.PLAY_ANIMATION=4,SEA3D.Actions.PLAY_SOUND=5,SEA3D.Actions.ANIMATION_AUDIO_SYNC=6,SEA3D.Actions.LOOK_AT=7,SEA3D.Actions.RTT_TARGET=8,SEA3D.Actions.CAMERA=9,SEA3D.Actions.SCRIPTS=10,SEA3D.Actions.CLASS_OF=11,SEA3D.Actions.ATTRIBUTES=12,SEA3D.Actions.prototype.type="act",SEA3D.Properties=function(t,e,i){this.name=t,this.data=e,this.sea3d=i,this.tag=e.readProperties(i),this.tag.__name=t},SEA3D.Properties.prototype.type="prop",SEA3D.FileInfo=function(t,e,i){this.name=t,this.data=e,this.sea3d=i,this.tag=e.readProperties(i),this.tag.__name=t,i.info=this.tag},SEA3D.FileInfo.prototype.type="info",SEA3D.JavaScript=function(t,e,i){this.name=t,this.data=e,this.sea3d=i,this.src=e.readUTF8(e.length)},SEA3D.JavaScript.prototype.type="js",SEA3D.JavaScriptMethod=function(t,e,i){this.name=t,this.data=e,this.sea3d=i;var r=e.readUShort();this.methods={};for(var n=0;n<r;n++){e.readUByte();var o=e.readUTF8Tiny();this.methods[o]={src:e.readUTF8Long()}}},SEA3D.JavaScriptMethod.prototype.type="jsm",SEA3D.GLSL=function(t,e,i){this.name=t,this.data=e,this.sea3d=i,this.src=e.readUTF8(e.length)},SEA3D.GLSL.prototype.type="glsl",SEA3D.Dummy=function(t,e,i){SEA3D.Object3D.call(this,t,e,i),this.transform=e.readMatrix(),this.width=e.readFloat(),this.height=e.readFloat(),this.depth=e.readFloat(),e.readTags(this.readTag.bind(this))},SEA3D.Dummy.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.Dummy.prototype.constructor=SEA3D.Dummy,SEA3D.Dummy.prototype.type="dmy",SEA3D.Line=function(t,e,i){SEA3D.Object3D.call(this,t,e,i),this.count=3*(64&this.attrib?e.readUInt():e.readUShort()),this.closed=0!=(128&this.attrib),this.transform=e.readMatrix(),this.vertex=[];for(var r=0;r<this.count;)this.vertex[r++]=e.readFloat();e.readTags(this.readTag.bind(this))},SEA3D.Line.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.Line.prototype.constructor=SEA3D.Line,SEA3D.Line.prototype.type="line",SEA3D.Sprite=function(t,e,i){SEA3D.Object3D.call(this,t,e,i),256&this.attrib&&(this.material=i.getObject(e.readUInt())),this.position=e.readVector3(),this.width=e.readFloat(),this.height=e.readFloat(),e.readTags(this.readTag.bind(this))},SEA3D.Sprite.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.Sprite.prototype.constructor=SEA3D.Sprite,SEA3D.Sprite.prototype.type="m2d",SEA3D.Mesh=function(t,e,i){if(SEA3D.Entity3D.call(this,t,e,i),256&this.attrib)if(this.material=[],1==(o=e.readUByte()))this.material[0]=i.getObject(e.readUInt());else for(var r=0;r<o;){var n=e.readUInt();this.material[r++]=n>0?i.getObject(n-1):void 0}if(512&this.attrib){this.modifiers=[];var o=e.readUByte();for(r=0;r<o;r++)this.modifiers[r]=i.getObject(e.readUInt())}1024&this.attrib&&(this.reference={type:e.readUByte(),ref:i.getObject(e.readUInt())}),this.transform=e.readMatrix(),this.geometry=i.getObject(e.readUInt()),e.readTags(this.readTag.bind(this))},SEA3D.Mesh.prototype=Object.create(SEA3D.Entity3D.prototype),SEA3D.Mesh.prototype.constructor=SEA3D.Mesh,SEA3D.Mesh.prototype.type="m3d",SEA3D.Skeleton=function(t,e,i){this.name=t,this.data=e,this.sea3d=i;var r=e.readUShort();this.joint=[];for(var n=0;n<r;n++)this.joint[n]={name:e.readUTF8Tiny(),parentIndex:e.readUShort()-1,inverseBindMatrix:e.readMatrix()}},SEA3D.Skeleton.prototype.type="skl",SEA3D.SkeletonLocal=function(t,e,i){this.name=t,this.data=e,this.sea3d=i;var r=e.readUShort();this.joint=[];for(var n=0;n<r;n++)this.joint[n]={name:e.readUTF8Tiny(),parentIndex:e.readUShort()-1,x:e.readFloat(),y:e.readFloat(),z:e.readFloat(),qx:e.readFloat(),qy:e.readFloat(),qz:e.readFloat(),qw:e.readFloat()}},SEA3D.SkeletonLocal.prototype.type="sklq",SEA3D.AnimationBase=function(t,e,i){this.name=t,this.data=e,this.sea3d=i;var r=e.readUByte();if(this.sequence=[],1&r)for(var n=e.readUShort(),o=0;o<n;o++)r=e.readUByte(),this.sequence[o]={name:e.readUTF8Tiny(),start:e.readUInt(),count:e.readUInt(),repeat:0!=(1&r),intrpl:0==(2&r)};this.frameRate=e.readUByte(),this.numFrames=e.readUInt(),0==this.sequence.length&&(this.sequence[0]={name:"root",start:0,count:this.numFrames,repeat:!0,intrpl:!0})},SEA3D.Animation=function(t,e,i){SEA3D.AnimationBase.call(this,t,e,i),this.dataList=[];for(var r=0,n=e.readUByte();r<n;r++){var o=e.readUShort(),a=e.readUByte(),s=e.readVector(a,this.numFrames,0);this.dataList.push({kind:o,type:a,blockSize:SEA3D.Stream.sizeOf(a),data:s})}},SEA3D.Animation.POSITION=0,SEA3D.Animation.ROTATION=1,SEA3D.Animation.SCALE=2,SEA3D.Animation.COLOR=3,SEA3D.Animation.MULTIPLIER=4,SEA3D.Animation.ATTENUATION_START=5,SEA3D.Animation.ATTENUATION_END=6,SEA3D.Animation.FOV=7,SEA3D.Animation.OFFSET_U=8,SEA3D.Animation.OFFSET_V=9,SEA3D.Animation.SCALE_U=10,SEA3D.Animation.SCALE_V=11,SEA3D.Animation.ANGLE=12,SEA3D.Animation.ALPHA=13,SEA3D.Animation.VOLUME=14,SEA3D.Animation.DefaultLerpFuncs=[SEA3D.Math.lerp3x,SEA3D.Math.lerpQuat4x,SEA3D.Math.lerp3x,SEA3D.Math.lerpColor1x,SEA3D.Math.lerp1x,SEA3D.Math.lerp1x,SEA3D.Math.lerp1x,SEA3D.Math.lerp1x,SEA3D.Math.lerp1x,SEA3D.Math.lerp1x,SEA3D.Math.lerp1x,SEA3D.Math.lerp1x,SEA3D.Math.lerpAng1x,SEA3D.Math.lerp1x,SEA3D.Math.lerp1x],SEA3D.Animation.prototype=Object.create(SEA3D.AnimationBase.prototype),SEA3D.Animation.prototype.constructor=SEA3D.Animation,SEA3D.Animation.prototype.type="anm",SEA3D.SkeletonAnimation=function(t,e,i){SEA3D.AnimationBase.call(this,t,e,i),this.name=t,this.data=e,this.sea3d=i,this.numJoints=e.readUShort(),this.raw=e.readFloatArray(this.numFrames*this.numJoints*7)},SEA3D.SkeletonAnimation.prototype.type="skla",SEA3D.Morph=function(t,e,i){SEA3D.GeometryBase.call(this,t,e,i);var r=0!=(2&this.attrib),n=0!=(4&this.attrib),o=e.readUShort();this.node=[];for(var a=0;a<o;a++){var s,h,l=e.readUTF8Tiny();r&&(s=e.readFloatArray(this.length)),n&&(h=e.readFloatArray(this.length)),this.node[a]={vertex:s,normal:h,name:l}}},SEA3D.Morph.prototype=Object.create(SEA3D.GeometryBase.prototype),SEA3D.Morph.prototype.constructor=SEA3D.Morph,SEA3D.Morph.prototype.type="mph",SEA3D.VertexAnimation=function(t,e,i){SEA3D.AnimationBase.call(this,t,e,i);var r=e.readUByte();this.isBig=0!=(1&r),e.readVInt=this.isBig?e.readUInt:e.readUShort,this.numVertex=e.readVInt(),this.length=3*this.numVertex;var n,o,a,s=0!=(2&r),h=0!=(4&r);for(this.frame=[],n=0;n<this.numFrames;n++)s&&(o=e.readFloatArray(this.length)),h&&(a=e.readFloatArray(this.length)),this.frame[n]={vertex:o,normal:a}},SEA3D.VertexAnimation.prototype=Object.create(SEA3D.AnimationBase.prototype),SEA3D.VertexAnimation.prototype.constructor=SEA3D.VertexAnimation,SEA3D.VertexAnimation.prototype.type="vtxa",SEA3D.Camera=function(t,e,i){SEA3D.Object3D.call(this,t,e,i),64&this.attrib&&(this.dof={distance:e.readFloat(),range:e.readFloat()}),this.transform=e.readMatrix(),this.fov=e.readFloat(),e.readTags(this.readTag.bind(this))},SEA3D.Camera.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.Camera.prototype.constructor=SEA3D.Camera,SEA3D.Camera.prototype.type="cam",SEA3D.OrthographicCamera=function(t,e,i){SEA3D.Object3D.call(this,t,e,i),this.transform=e.readMatrix(),this.height=e.readFloat(),e.readTags(this.readTag.bind(this))},SEA3D.OrthographicCamera.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.OrthographicCamera.prototype.constructor=SEA3D.OrthographicCamera,SEA3D.OrthographicCamera.prototype.type="camo",SEA3D.JointObject=function(t,e,i){SEA3D.Object3D.call(this,t,e,i),this.target=i.getObject(e.readUInt()),this.joint=e.readUShort(),e.readTags(this.readTag.bind(this))},SEA3D.JointObject.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.JointObject.prototype.constructor=SEA3D.JointObject,SEA3D.JointObject.prototype.type="jnt",SEA3D.Light=function(t,e,i){if(SEA3D.Object3D.call(this,t,e,i),this.attenStart=Number.MAX_VALUE,this.attenEnd=Number.MAX_VALUE,64&this.attrib){var r=e.readUByte();this.shadow={},this.shadow.opacity=1&r?e.readFloat():1,this.shadow.color=2&r?e.readUInt24():0}512&this.attrib&&(this.attenStart=e.readFloat(),this.attenEnd=e.readFloat()),this.color=e.readUInt24(),this.multiplier=e.readFloat()},SEA3D.Light.prototype=Object.create(SEA3D.Object3D.prototype),SEA3D.Light.prototype.constructor=SEA3D.Light,SEA3D.PointLight=function(t,e,i){SEA3D.Light.call(this,t,e,i),128&this.attrib&&(this.attenuation={start:e.readFloat(),end:e.readFloat()}),this.position=e.readVector3(),e.readTags(this.readTag.bind(this))},SEA3D.PointLight.prototype=Object.create(SEA3D.Light.prototype),SEA3D.PointLight.prototype.constructor=SEA3D.PointLight,SEA3D.PointLight.prototype.type="plht",SEA3D.HemisphereLight=function(t,e,i){SEA3D.Light.call(this,t,e,i),128&this.attrib&&(this.attenuation={start:e.readFloat(),end:e.readFloat()}),this.secondColor=e.readUInt24(),e.readTags(this.readTag.bind(this))},SEA3D.HemisphereLight.prototype=Object.create(SEA3D.Light.prototype),SEA3D.HemisphereLight.prototype.constructor=SEA3D.HemisphereLight,SEA3D.HemisphereLight.prototype.type="hlht",SEA3D.AmbientLight=function(t,e,i){SEA3D.Light.call(this,t,e,i),e.readTags(this.readTag.bind(this))},SEA3D.AmbientLight.prototype=Object.create(SEA3D.Light.prototype),SEA3D.AmbientLight.prototype.constructor=SEA3D.AmbientLight,SEA3D.AmbientLight.prototype.type="alht",SEA3D.DirectionalLight=function(t,e,i){SEA3D.Light.call(this,t,e,i),this.transform=e.readMatrix(),e.readTags(this.readTag.bind(this))},SEA3D.DirectionalLight.prototype=Object.create(SEA3D.Light.prototype),SEA3D.DirectionalLight.prototype.constructor=SEA3D.DirectionalLight,SEA3D.DirectionalLight.prototype.type="dlht",SEA3D.Material=function(t,e,i){this.name=t,this.data=e,this.sea3d=i,this.technique=[],this.tecniquesDict={},this.attrib=e.readUShort(),this.alpha=1,this.blendMode="normal",this.physical=!1,this.anisotropy=!1,this.bothSides=0!=(1&this.attrib),this.receiveLights=0==(2&this.attrib),this.receiveShadows=0==(4&this.attrib),this.receiveFog=0==(8&this.attrib),this.repeat=0==(16&this.attrib),32&this.attrib&&(this.alpha=e.readFloat()),64&this.attrib&&(this.blendMode=e.readBlendMode()),128&this.attrib&&(this.animations=e.readAnimationList(i)),this.depthWrite=0==(256&this.attrib),this.depthTest=0==(512&this.attrib),this.premultipliedAlpha=0!=(1024&this.attrib);for(var r=e.readUByte(),n=0;n<r;++n){var o,a,s=e.readUShort(),h=e.readUShort(),l=e.position;switch(s){case SEA3D.Material.PHONG:o={ambientColor:e.readUInt24(),diffuseColor:e.readUInt24(),specularColor:e.readUInt24(),specular:e.readFloat(),gloss:e.readFloat()};break;case SEA3D.Material.PHYSICAL:o={color:e.readUInt24(),roughness:e.readFloat(),metalness:e.readFloat()};break;case SEA3D.Material.ANISOTROPIC:break;case SEA3D.Material.COMPOSITE_TEXTURE:o={composite:i.getObject(e.readUInt())};break;case SEA3D.Material.DIFFUSE_MAP:case SEA3D.Material.SPECULAR_MAP:case SEA3D.Material.NORMAL_MAP:o={texture:i.getObject(e.readUInt())};break;case SEA3D.Material.REFLECTION:case SEA3D.Material.FRESNEL_REFLECTION:o={texture:i.getObject(e.readUInt()),alpha:e.readFloat()},s==SEA3D.Material.FRESNEL_REFLECTION&&(o.power=e.readFloat(),o.normal=e.readFloat());break;case SEA3D.Material.REFRACTION:o={texture:i.getObject(e.readUInt()),alpha:e.readFloat(),ior:e.readFloat()};break;case SEA3D.Material.RIM:o={color:e.readUInt24(),strength:e.readFloat(),power:e.readFloat(),blendMode:e.readBlendMode()};break;case SEA3D.Material.LIGHT_MAP:o={texture:i.getObject(e.readUInt()),channel:e.readUByte(),blendMode:e.readBlendMode()};break;case SEA3D.Material.DETAIL_MAP:o={texture:i.getObject(e.readUInt()),scale:e.readFloat(),blendMode:e.readBlendMode()};break;case SEA3D.Material.CEL:o={color:e.readUInt24(),levels:e.readUByte(),size:e.readFloat(),specularCutOff:e.readFloat(),smoothness:e.readFloat()};break;case SEA3D.Material.TRANSLUCENT:o={translucency:e.readFloat(),scattering:e.readFloat()};break;case SEA3D.Material.BLEND_NORMAL_MAP:a=e.readUByte(),o={texture:i.getObject(e.readUInt()),secondaryTexture:i.getObject(e.readUInt())},1&a?(o.offsetX0=e.readFloat(),o.offsetY0=e.readFloat(),o.offsetX1=e.readFloat(),o.offsetY1=e.readFloat()):o.offsetX0=o.offsetY0=o.offsetX1=o.offsetY1=0,o.animate=2&a;break;case SEA3D.Material.MIRROR_REFLECTION:o={texture:i.getObject(e.readUInt()),alpha:e.readFloat()};break;case SEA3D.Material.AMBIENT_MAP:case SEA3D.Material.ALPHA_MAP:o={texture:i.getObject(e.readUInt())};break;case SEA3D.Material.EMISSIVE:o={color:e.readUInt24()};break;case SEA3D.Material.EMISSIVE_MAP:o={texture:i.getObject(e.readUInt())};break;case SEA3D.Material.ROUGHNESS_MAP:case SEA3D.Material.METALNESS_MAP:o={texture:i.getObject(e.readUInt())};break;case SEA3D.Material.VERTEX_COLOR:o={blendMode:e.readBlendMode()};break;case SEA3D.Material.WRAP_LIGHTING:o={color:e.readUInt24(),strength:e.readFloat()};break;case SEA3D.Material.COLOR_REPLACE:a=e.readUByte(),o={red:e.readUInt24(),green:e.readUInt24(),blue:e.readUInt24F()},1&a&&(o.mask=i.getObject(e.readUInt())),2&a&&(o.alpha=e.readFloat());break;case SEA3D.Material.REFLECTION_SPHERICAL:o={texture:i.getObject(e.readUInt()),alpha:e.readFloat()};break;case SEA3D.Material.REFLECTIVITY:a=e.readUByte(),o={strength:e.readFloat()},1&a&&(o.mask=i.getObject(e.readUInt()));break;case SEA3D.Material.CLEAR_COAT:o={strength:e.readFloat(),roughness:e.readFloat()};break;default:e.position=l+=h;continue}o.kind=s,this.technique.push(o),this.tecniquesDict[s]=o,e.position=l+=h}},SEA3D.Material.PHONG=0,SEA3D.Material.COMPOSITE_TEXTURE=1,SEA3D.Material.DIFFUSE_MAP=2,SEA3D.Material.SPECULAR_MAP=3,SEA3D.Material.REFLECTION=4,SEA3D.Material.REFRACTION=5,SEA3D.Material.NORMAL_MAP=6,SEA3D.Material.FRESNEL_REFLECTION=7,SEA3D.Material.RIM=8,SEA3D.Material.LIGHT_MAP=9,SEA3D.Material.DETAIL_MAP=10,SEA3D.Material.CEL=11,SEA3D.Material.TRANSLUCENT=12,SEA3D.Material.BLEND_NORMAL_MAP=13,SEA3D.Material.MIRROR_REFLECTION=14,SEA3D.Material.AMBIENT_MAP=15,SEA3D.Material.ALPHA_MAP=16,SEA3D.Material.EMISSIVE_MAP=17,SEA3D.Material.VERTEX_COLOR=18,SEA3D.Material.WRAP_LIGHTING=19,SEA3D.Material.COLOR_REPLACE=20,SEA3D.Material.REFLECTION_SPHERICAL=21,SEA3D.Material.ANISOTROPIC=22,SEA3D.Material.EMISSIVE=23,SEA3D.Material.PHYSICAL=24,SEA3D.Material.ROUGHNESS_MAP=25,SEA3D.Material.METALNESS_MAP=26,SEA3D.Material.REFLECTIVITY=27,SEA3D.Material.CLEAR_COAT=28,SEA3D.Material.prototype.type="mat",SEA3D.Composite=function(t,e,i){this.name=t,this.data=e,this.sea3d=i;var r=e.readUByte();this.layer=[];for(var n=0;n<r;n++)this.layer[n]=new SEA3D.Composite.prototype.Layer(e,i)},SEA3D.Composite.prototype.getLayerByName=function(t){for(var e=0;e<this.layer.length;e++)if(this.layer[e].name==t)return this.layer[e]},SEA3D.Composite.prototype.Layer=function(t,e){var i=t.readUShort();1&i?this.texture=new SEA3D.Composite.LayerBitmap(t,e):this.color=t.readUInt24(),2&i&&(this.mask=new SEA3D.Composite.LayerBitmap(t,e)),4&i&&(this.name=t.readUTF8Tiny()),this.blendMode=8&i?t.readBlendMode():"normal",this.opacity=16&i?t.readFloat():1},SEA3D.Composite.LayerBitmap=function(t,e){this.map=e.getObject(t.readUInt());var i=t.readUShort();this.channel=1&i?t.readUByte():0,this.repeat=!1&i,this.offsetU=4&i?t.readFloat():0,this.offsetV=8&i?t.readFloat():0,this.scaleU=16&i?t.readFloat():1,this.scaleV=32&i?t.readFloat():1,this.rotation=64&i?t.readFloat():0,128&i&&(this.animation=t.readAnimationList(e))},SEA3D.Composite.prototype.type="ctex",SEA3D.PlanarRender=function(t,e,i){this.name=t,this.data=e,this.sea3d=i,this.attrib=e.readUByte(),this.quality=1&this.attrib|2&this.attrib,this.transform=e.readMatrix()},SEA3D.PlanarRender.prototype.type="rttp",SEA3D.CubeRender=function(t,e,i){this.name=t,this.data=e,this.sea3d=i,this.attrib=e.readUByte(),this.quality=1&this.attrib|2&this.attrib,this.position=e.readVector3()},SEA3D.CubeRender.prototype.type="rttc",SEA3D.CubeMap=function(t,e,i){this.name=t,this.data=e,this.sea3d=i,this.transparent=!1;e.readExt();this.faces=[];for(var r=0;r<6;r++){var n=e.readUInt();this.faces[r]=e.concat(e.position,n),e.position+=n}},SEA3D.CubeMap.prototype.type="cmap",SEA3D.JPEG=function(t,e,i){this.name=t,this.data=e,this.sea3d=i,this.transparent=!1},SEA3D.JPEG.prototype.type="jpg",SEA3D.JPEG_XR=function(t,e,i){this.name=t,this.data=e,this.sea3d=i,this.transparent=!0},SEA3D.JPEG_XR.prototype.type="wdp",SEA3D.PNG=function(t,e,i){this.name=t,this.data=e,this.sea3d=i,this.transparent=6==e.getByte(25)},SEA3D.PNG.prototype.type="png",SEA3D.GIF=function(t,e,i){this.name=t,this.data=e,this.sea3d=i,this.transparent=e.getByte(11)>0},SEA3D.GIF.prototype.type="gif",SEA3D.OGG=function(t,e,i){this.name=t,this.data=e,this.sea3d=i},SEA3D.OGG.prototype.type="ogg",SEA3D.MP3=function(t,e,i){this.name=t,this.data=e,this.sea3d=i},SEA3D.MP3.prototype.type="mp3",SEA3D.File=function(t){this.config={streaming:!0,timeLimit:60},t&&(void 0!==t.streaming&&(this.config.streaming=t.streaming),void 0!==t.timeLimit&&(this.config.timeLimit=t.timeLimit)),this.version=SEA3D.VERSION,this.objects=[],this.typeClass={},this.typeRead={},this.typeUnique={},this.position=this.dataPosition=0,this.scope=this,this.addClass(SEA3D.FileInfo,!0),this.addClass(SEA3D.Geometry,!0),this.addClass(SEA3D.Mesh),this.addClass(SEA3D.Sprite),this.addClass(SEA3D.Material),this.addClass(SEA3D.Composite),this.addClass(SEA3D.PointLight),this.addClass(SEA3D.DirectionalLight),this.addClass(SEA3D.HemisphereLight),this.addClass(SEA3D.AmbientLight),this.addClass(SEA3D.Skeleton,!0),this.addClass(SEA3D.SkeletonLocal,!0),this.addClass(SEA3D.SkeletonAnimation,!0),this.addClass(SEA3D.JointObject),this.addClass(SEA3D.Camera),this.addClass(SEA3D.OrthographicCamera),this.addClass(SEA3D.Morph,!0),this.addClass(SEA3D.VertexAnimation,!0),this.addClass(SEA3D.CubeMap,!0),this.addClass(SEA3D.Animation),this.addClass(SEA3D.Dummy),this.addClass(SEA3D.Line),this.addClass(SEA3D.SoundPoint),this.addClass(SEA3D.PlanarRender),this.addClass(SEA3D.CubeRender),this.addClass(SEA3D.Actions),this.addClass(SEA3D.Container3D),this.addClass(SEA3D.Properties),this.addClass(SEA3D.ScriptURL,!0),this.addClass(SEA3D.TextureURL,!0),this.addClass(SEA3D.CubeMapURL,!0),this.addClass(SEA3D.JPEG,!0),this.addClass(SEA3D.JPEG_XR,!0),this.addClass(SEA3D.PNG,!0),this.addClass(SEA3D.GIF,!0),this.addClass(SEA3D.OGG,!0),this.addClass(SEA3D.MP3,!0),this.addClass(SEA3D.JavaScript,!0),this.addClass(SEA3D.JavaScriptMethod,!0),this.addClass(SEA3D.GLSL,!0);for(var e=SEA3D.File.Extensions.length;e--;)SEA3D.File.Extensions[e].call(this)},SEA3D.File.Extensions=[],SEA3D.File.CompressionLibs={},SEA3D.File.DecompressionMethod={},SEA3D.File.setExtension=function(t){SEA3D.File.Extensions.push(t)},SEA3D.File.setDecompressionEngine=function(t,e,i){SEA3D.File.CompressionLibs[t]=e,SEA3D.File.DecompressionMethod[t]=i},SEA3D.File.prototype.addClass=function(t,e){this.typeClass[t.prototype.type]=t,this.typeUnique[t.prototype.type]=!0===e},SEA3D.File.prototype.readHead=function(){if(this.stream.bytesAvailable<16)return!1;if("SEA"!=this.stream.readUTF8(3))throw new Error("Invalid SEA3D format.");if(this.sign=this.stream.readUTF8(3),this.version=this.stream.readUInt24(),0!=this.stream.readUByte())throw new Error("Protection algorithm not compatible.");if(this.compressionID=this.stream.readUByte(),this.compressionAlgorithm=SEA3D.File.CompressionLibs[this.compressionID],this.decompressionMethod=SEA3D.File.DecompressionMethod[this.compressionID],this.compressionID>0&&!this.decompressionMethod)throw new Error("Compression algorithm not compatible.");return this.length=this.stream.readUInt(),this.dataPosition=this.stream.position,this.objects.length=0,this.state=this.readBody,this.onHead&&this.onHead({file:this,sign:this.sign}),!0},SEA3D.File.prototype.getObject=function(t){return this.objects[t]},SEA3D.File.prototype.getObjectByName=function(t){return this.objects[t]},SEA3D.File.prototype.readSEAObject=function(){if(this.stream.bytesAvailable<4)return null;var t=this.stream.readUInt(),e=this.stream.position;if(this.stream.bytesAvailable<t)return null;var i=this.stream.readUByte(),r=this.stream.readExt(),n=null,o=1&i?this.stream.readUTF8Tiny():"",a=0!=(2&i),s=0!=(4&i);if(8&i){var h=this.stream.readUShort(),l=this.stream.concat(this.stream.position,h);this.stream.position+=h,a&&this.decompressionMethod&&(l.buffer=this.decompressionMethod(l.buffer)),n=l.readProperties(this)}t-=this.stream.position-e,e=this.stream.position;var c,u=this.stream.concat(e,t);return this.typeClass[r]?(a&&this.decompressionMethod&&(u.buffer=this.decompressionMethod(u.buffer)),c=new this.typeClass[r](o,u,this),(this.config.streaming&&s||this.config.forceStreaming)&&this.typeRead[r]&&this.typeRead[r].call(this.scope,c)):c=new SEA3D.Object(o,u,r,this),c.streaming=s,c.metadata=n,this.objects.push(this.objects[c.name+"."+c.type]=c),this.dataPosition=e+t,++this.position,c},SEA3D.File.prototype.isDone=function(){return this.position==this.length},SEA3D.File.prototype.readBody=function(){if(this.timer.update(),!this.resume)return!1;for(;this.position<this.length;){if(!(this.timer.deltaTime<this.config.timeLimit))return!1;this.stream.position=this.dataPosition;var t=this.readSEAObject();if(!t)return!1;this.dispatchCompleteObject(t)}return this.state=this.readComplete,!0},SEA3D.File.prototype.initParse=function(){this.timer=new SEA3D.Timer,this.position=0,this.resume=!0},SEA3D.File.prototype.parse=function(){this.initParse(),isFinite(this.config.timeLimit)?setTimeout(this.parseObject.bind(this),10):this.parseObject()},SEA3D.File.prototype.parseObject=function(){for(this.timer.update();this.position<this.length&&this.timer.deltaTime<this.config.timeLimit;){var t=this.objects[this.position++],e=t.type;this.typeUnique[e]||delete t.tag,(t.streaming||this.config.forceStreaming)&&this.typeRead[e]&&void 0==t.tag&&this.typeRead[e].call(this.scope,t)}if(this.position==this.length){var i=this.timer.elapsedTime,r=i+"ms, "+this.objects.length+" objects";this.onParseComplete&&this.onParseComplete({file:this,timeTotal:i,message:r})}else this.onParseProgress&&this.onParseProgress({file:this,loaded:this.position,total:this.length}),setTimeout(this.parseObject.bind(this),10)},SEA3D.File.prototype.readComplete=function(){return this.stream.position=this.dataPosition,this.stream.readUInt24F(),delete this.state,!1},SEA3D.File.prototype.readState=function(){for(;this.state();)continue;this.state?(requestAnimationFrame(this.readState.bind(this)),this.dispatchProgress()):this.dispatchComplete()},SEA3D.File.prototype.read=function(t){if(!t)throw new Error("No data found.");this.initParse(),this.stream=new SEA3D.Stream(t),this.state=this.readHead,this.readState()},SEA3D.File.prototype.dispatchCompleteObject=function(t){this.onCompleteObject&&this.onCompleteObject({file:this,object:t})},SEA3D.File.prototype.dispatchProgress=function(){this.onProgress&&this.onProgress({file:this,loaded:this.position,total:this.length})},SEA3D.File.prototype.dispatchDownloadProgress=function(t,e){this.onDownloadProgress&&this.onDownloadProgress({file:this,loaded:t,total:e})},SEA3D.File.prototype.dispatchComplete=function(){var t=this.timer.elapsedTime,e=t+"ms, "+this.objects.length+" objects";this.onComplete&&this.onComplete({file:this,timeTotal:t,message:e})},SEA3D.File.prototype.dispatchError=function(t,e){this.onError&&this.onError({file:this,id:t,message:e})},SEA3D.File.prototype.load=function(t){var e=this,i=new XMLHttpRequest;i.open("GET",t,!0),i.responseType="arraybuffer",i.onprogress=function(t){t.lengthComputable&&e.dispatchDownloadProgress(t.loaded,t.total)},i.onreadystatechange=function(){2===i.readyState||3===i.readyState||4===i.readyState&&(200===i.status||0===i.status?e.read(this.response):this.dispatchError(1001,"Couldn't load ["+t+"] ["+i.status+"]"))},i.send()},void 0===THREE.Float32BufferAttribute&&(THREE.Float32BufferAttribute=THREE.Float32Attribute),THREE.SEA3D=function(t){this.config={id:"",scripts:!0,runScripts:!0,autoPlay:!1,dummys:!0,multiplier:1,bounding:!0,audioRolloffFactor:10,lights:!0,useEnvironment:!0,useVertexTexture:!0,forceStatic:!1,streaming:!0,async:!0,paths:{},timeLimit:10},t&&this.loadConfig(t)},THREE.SEA3D.MTXBUF=new THREE.Matrix4,THREE.SEA3D.VECBUF=new THREE.Vector3,THREE.SEA3D.QUABUF=new THREE.Quaternion,THREE.SEA3D.BACKGROUND_COLOR=3355443,THREE.SEA3D.HELPER_COLOR=10140133,THREE.SEA3D.RTT_SIZE=512,THREE.SEA3D.prototype=Object.assign(Object.create(THREE.EventDispatcher.prototype),{constructor:THREE.SEA3D,setShadowMap:function(t){t.shadow.mapSize.width=2048,t.shadow.mapSize.height=1024,t.castShadow=!0,t.shadow.camera.left=-200,t.shadow.camera.right=200,t.shadow.camera.top=200,t.shadow.camera.bottom=-200,t.shadow.camera.near=1,t.shadow.camera.far=3e3,t.shadow.camera.fov=45,t.shadow.bias=-.001}}),Object.defineProperties(THREE.SEA3D.prototype,{container:{set:function(t){this.config.container=t},get:function(){return this.config.container}},elapsedTime:{get:function(){return this.file.timer.elapsedTime}}}),THREE.SEA3D.Domain=function(t,e,i){this.id=t,this.objects=e,this.container=i,this.sources=[],this.global={},this.scriptTargets=[],this.events=new THREE.EventDispatcher},Object.assign(THREE.SEA3D.Domain.prototype,{add:function(t){this.sources.push(t)},remove:function(t){this.sources.splice(this.sources.indexOf(t),1)},contains:function(t){return-1!=this.sources.indexOf(t)},addEventListener:function(t,e){this.events.addEventListener(t,e)},hasEventListener:function(t,e){return this.events.hasEventListener(t,e)},removeEventListener:function(t,e){this.events.removeEventListener(t,e)},print:function(){console.log.apply(console,arguments)},watch:function(){console.log.apply(console,"watch:",arguments)},runScripts:function(){for(var t=0;t<this.scriptTargets.length;t++)this.runJSMList(this.scriptTargets[t])},runJSMList:function(t){for(var e=t.scripts,i=0;i<e.length;i++)this.runJSM(t,e[i]);return e},runJSM:function(t,e){void 0==t.local&&(t.local={});var i={print:this.print,watch:this.watch,sea3d:this,scene:this.container,source:new THREE.SEA3D.ScriptDomain(this,t instanceof THREE.SEA3D.Domain)};Object.freeze(i.source),THREE.SEA3D.ScriptHandler.add(i.source);try{this.methods[e.method](i,this.getReference,this.global,t.local,t,e.params)}catch(t){}},getReference:function(ns){return eval(ns)},disposeList:function(t){if(t&&t.length)for(var e=(t=t.concat()).length;e--;)t[e].dispose()},dispatchEvent:function(t){t.domain=this;for(var e=this.sources.concat(),i=e.length;i--;)e[i].dispatchEvent(t);this.events.dispatchEvent(t)},dispose:function(){for(this.disposeList(this.sources);this.container.children.length;)this.container.remove(this.container.children[0]);for(var t=THREE.SEA3D.EXTENSIONS_DOMAIN.length;t--;){var e=THREE.SEA3D.EXTENSIONS_DOMAIN[t];e.dispose&&e.dispose.call(this)}this.disposeList(this.materials),this.disposeList(this.dummys),this.dispatchEvent({type:"dispose"})}}),THREE.SEA3D.DomainManager=function(t){this.domains=[],this.autoDisposeRootDomain=void 0==t},Object.assign(THREE.SEA3D.DomainManager.prototype,{onDisposeDomain:function(t){this.remove(t.domain),this.autoDisposeRootDomain&&1==this.domains.length&&this.dispose()},add:function(t){this._onDisposeDomain=this._onDisposeDomain||this.onDisposeDomain.bind(this),t.on("dispose",this._onDisposeDomain),this.domains.push(t),this.textures=this.textures||t.textures,this.cubemaps=this.cubemaps||t.cubemaps,this.geometries=this.geometries||t.geometries},remove:function(t){t.removeEvent("dispose",this._onDisposeDomain),this.domains.splice(this.domains.indexOf(t),1)},contains:function(t){return-1!=this.domains.indexOf(t)},disposeList:function(t){if(t&&t.length)for(var e=(t=t.concat()).length;e--;)t[e].dispose()},dispose:function(){this.disposeList(this.domains),this.disposeList(this.textures),this.disposeList(this.cubemaps),this.disposeList(this.geometries)}}),THREE.SEA3D.ScriptDomain=function(t,e){(t=t||new THREE.SEA3D.Domain).add(this);var i=new THREE.EventDispatcher;this.getId=function(){return t.id},this.isRoot=function(){return e},this.addEventListener=function(t,e){i.addEventListener(t,e)},this.hasEventListener=function(t,e){return i.hasEventListener(t,e)},this.removeEventListener=function(t,e){i.removeEventListener(t,e)},this.dispatchEvent=function(t){t.script=this,i.dispatchEvent(t)},this.dispose=function(){t.remove(this),e&&t.dispose(),this.dispatchEvent({type:"dispose"})}},THREE.SEA3D.ScriptManager=function(){this.scripts=[];var t=function(t){this.remove(t.script)}.bind(this);this.add=function(e){e.addEventListener("dispose",t),this.scripts.push(e)},this.remove=function(e){e.removeEventListener("dispose",t),this.scripts.splice(this.scripts.indexOf(e),1)},this.contains=function(t){return this.scripts.indexOf(t)>-1},this.dispatchEvent=function(t){for(var e=this.scripts.concat(),i=e.length;i--;)e[i].dispatchEvent(t)}},THREE.SEA3D.ScriptHandler=new THREE.SEA3D.ScriptManager,THREE.SEA3D.ScriptHandler.dispatchUpdate=function(t){this.dispatchEvent({type:"update",delta:t})},THREE.SEA3D.AnimationClip=function(t,e,i,r){THREE.AnimationClip.call(this,t,e,i),this.repeat=void 0===r||r},THREE.SEA3D.AnimationClip.fromClip=function(t,e){return new THREE.SEA3D.AnimationClip(t.name,t.duration,t.tracks,e)},THREE.SEA3D.AnimationClip.prototype=Object.assign(Object.create(THREE.AnimationClip.prototype),{constructor:THREE.SEA3D.AnimationClip}),THREE.SEA3D.Animation=function(t,e){this.clip=t,this.timeScale=void 0!==e?e:1},THREE.SEA3D.Animation.COMPLETE="animationComplete",THREE.SEA3D.Animation.prototype=Object.assign(Object.create(THREE.EventDispatcher.prototype),{constructor:THREE.SEA3D.Animation,onComplete:function(t){this.dispatchEvent({type:THREE.SEA3D.Animation.COMPLETE,target:this})}}),Object.defineProperties(THREE.SEA3D.Animation.prototype,{name:{get:function(){return this.clip.name}},repeat:{get:function(){return this.clip.repeat}},mixer:{set:function(t){this.mx&&(this.mx.uncacheClip(this.clip),delete this.mx),t&&(this.mx=t,this.mx.clipAction(this.clip))},get:function(){return this.mx}}}),THREE.SEA3D.Animator=function(t,e){this.updateAnimations(t,e),this.clone=function(t){return new this.constructor(this.clips,new THREE.AnimationMixer(t)).copyFrom(this)}.bind(this)},Object.assign(THREE.SEA3D.Animator.prototype,{update:function(t){return this.mixer.update(t||0),this.currentAnimationAction&&this.currentAnimationAction.paused&&(this.pause(),this.currentAnimation&&this.currentAnimation.onComplete(this)),this},updateAnimations:function(t,e){if(this.playing&&this.stop(),this.mixer&&THREE.SEA3D.AnimationHandler.remove(this),this.mixer=e,this.relative=!1,this.playing=!1,this.paused=!1,this.timeScale=1,this.animations=[],this.animation={},this.clips=[],t)for(var i=0;i<t.length;i++)this.addAnimation(t[i]);return this},addAnimation:function(t){return t instanceof THREE.AnimationClip&&(this.clips.push(t),t=new THREE.SEA3D.Animation(t)),this.animations.push(t),this.animation[t.name]=t,t.mixer=this.mixer,t},removeAnimation:function(t){return t instanceof THREE.AnimationClip&&(t=this.getAnimationByClip(t)),this.clips.splice(this.clips.indexOf(t.clip),1),delete this.animation[t.name],this.animations.splice(this.animations.indexOf(t),1),t.mixer=null,t},getAnimationByClip:function(t){for(var e=0;e<this.animations.length;e++)if(this.animations[e].clip===t)return t},getAnimationByName:function(t){return"number"==typeof t?this.animations[t]:this.animation[t]},setAnimationWeight:function(t,e){this.mixer.clipAction(this.getAnimationByName(t).clip).setEffectiveWeight(e)},getAnimationWeight:function(t){return this.mixer.clipAction(this.getAnimationByName(t).clip).getEffectiveWeight()},pause:function(){return this.playing&&this.currentAnimation&&(THREE.SEA3D.AnimationHandler.remove(this),this.playing=!1),this},resume:function(){return!this.playing&&this.currentAnimation&&(THREE.SEA3D.AnimationHandler.add(this),this.playing=!0),this},setTimeScale:function(t){return this.timeScale=t,this.currentAnimationAction&&this.updateTimeScale(),this},getTimeScale:function(){return this.timeScale},updateTimeScale:function(){return this.currentAnimationAction.setEffectiveTimeScale(this.timeScale*(this.currentAnimation?this.currentAnimation.timeScale:1)),this},play:function(t,e,i,r){var n=this.getAnimationByName(t);if(!n)throw new Error('Animation "'+t+'" not found.');return n==this.currentAnimation?(void 0===i&&n.repeat||(this.currentAnimationAction.time=void 0!==i?i:this.currentAnimationAction.timeScale>=0?0:this.currentAnimation.duration),this.currentAnimationAction.setEffectiveWeight(void 0!==r?r:1),this.currentAnimationAction.paused=!1,this.resume()):(this.previousAnimation=this.currentAnimation,this.currentAnimation=n,this.previousAnimationAction=this.currentAnimationAction,this.currentAnimationAction=this.mixer.clipAction(n.clip).setLoop(n.repeat?THREE.LoopRepeat:THREE.LoopOnce,1/0).reset(),this.currentAnimationAction.clampWhenFinished=!n.repeat,this.currentAnimationAction.paused=!1,this.updateTimeScale(),void 0===i&&n.repeat||(this.currentAnimationAction.time=void 0!==i?i:this.currentAnimationAction.timeScale>=0?0:this.currentAnimation.duration),this.currentAnimationAction.setEffectiveWeight(void 0!==r?r:1),this.currentAnimationAction.play(),this.playing||this.mixer.update(0),this.playing=!0,this.previousAnimation&&this.previousAnimationAction.crossFadeTo(this.currentAnimationAction,e||0,!1),THREE.SEA3D.AnimationHandler.add(this),this)},stop:function(){return this.playing&&THREE.SEA3D.AnimationHandler.remove(this),this.currentAnimation&&(this.currentAnimationAction.stop(),this.previousAnimation=this.currentAnimation,this.previousAnimationAction=this.currentAnimationAction,delete this.currentAnimationAction,delete this.currentAnimation,this.playing=!1),this},playw:function(t,e){this.playing||this.paused||THREE.SEA3D.AnimationHandler.add(this);var i=this.getAnimationByName(t);this.playing=!0;var r=this.mixer.clipAction(i.clip);return r.setLoop(i.repeat?THREE.LoopRepeat:THREE.LoopOnce,1/0).reset(),r.clampWhenFinished=!i.repeat,r.paused=!1,r.setEffectiveWeight(e).play(),r},crossFade:function(t,e,i,r){this.mixer.stopAllAction();var n=this.playw(t,1),o=this.playw(e,1);return n.crossFadeTo(o,i,void 0!==r&&r),this},stopAll:function(){return this.stop().mixer.stopAllAction(),this.playing=!1,this},unPauseAll:function(){return this.mixer.timeScale=1,this.playing=!0,this.paused=!1,this},pauseAll:function(){return this.mixer.timeScale=0,this.playing=!1,this.paused=!0,this},setRelative:function(t){if(this.relative!=t)return this.stop(),this.relative=t,this},getRelative:function(){return this.relative},copyFrom:function(t){for(var e=0;e<this.animations.length;e++)this.animations[e].timeScale=t.animations[e].timeScale;return this}}),THREE.SEA3D.Object3DAnimator=function(t,e){this.object3d=e,THREE.SEA3D.Animator.call(this,t,new THREE.AnimationMixer(e)),this.clone=function(t){return new this.constructor(this.clips,t).copyFrom(this)}.bind(this)},THREE.SEA3D.Object3DAnimator.prototype=Object.assign(Object.create(THREE.SEA3D.Animator.prototype),{constructor:THREE.SEA3D.Object3DAnimator,stop:function(){if(this.currentAnimation){var t=this.object3d.animate;t&&this instanceof THREE.SEA3D.Object3DAnimator&&(t.position.set(0,0,0),t.quaternion.set(0,0,0,1),t.scale.set(1,1,1))}THREE.SEA3D.Animator.prototype.stop.call(this)},setRelative:function(t){THREE.SEA3D.Animator.prototype.setRelative.call(this,t),this.object3d.setAnimator(this.relative),this.updateAnimations(this.clips,new THREE.AnimationMixer(this.relative?this.object3d.animate:this.object3d))}}),THREE.SEA3D.CameraAnimator=function(t,e){THREE.SEA3D.Object3DAnimator.call(this,t,e)},THREE.SEA3D.CameraAnimator.prototype=Object.assign(Object.create(THREE.SEA3D.Object3DAnimator.prototype),{constructor:THREE.SEA3D.CameraAnimator}),THREE.SEA3D.SoundAnimator=function(t,e){THREE.SEA3D.Object3DAnimator.call(this,t,e)},THREE.SEA3D.SoundAnimator.prototype=Object.assign(Object.create(THREE.SEA3D.Object3DAnimator.prototype),{constructor:THREE.SEA3D.SoundAnimator}),THREE.SEA3D.LightAnimator=function(t,e){THREE.SEA3D.Object3DAnimator.call(this,t,e)},THREE.SEA3D.LightAnimator.prototype=Object.assign(Object.create(THREE.SEA3D.Object3DAnimator.prototype),{constructor:THREE.SEA3D.LightAnimator}),THREE.SEA3D.Object3D=function(){THREE.Object3D.call(this)},THREE.SEA3D.Object3D.prototype=Object.assign(Object.create(THREE.Object3D.prototype),{constructor:THREE.SEA3D.Object3D,updateAnimateMatrix:function(t){!0===this.matrixAutoUpdate&&this.updateMatrix(),!0!==this.matrixWorldNeedsUpdate&&!0!==t||(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.animate.updateMatrix(),this.matrixWorld.multiplyMatrices(this.matrixWorld,this.animate.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);for(var e=0,i=this.children.length;e<i;e++)this.children[e].updateMatrixWorld(t)},setAnimator:function(t){this.getAnimator()!=t&&(t?(this.animate=new THREE.Object3D,this.updateMatrixWorld=THREE.SEA3D.Object3D.prototype.updateAnimateMatrix):(delete this.animate,this.updateMatrixWorld=THREE.Object3D.prototype.updateMatrixWorld),this.matrixWorldNeedsUpdate=!0)},getAnimator:function(){return void 0!=this.animate},copy:function(t){return THREE.Object3D.prototype.copy.call(this,t),this.attribs=t.attribs,this.scripts=t.scripts,t.animator&&(this.animator=t.animator.clone(this)),this}}),THREE.SEA3D.Dummy=function(t,e,i){this.width=void 0!=t?t:100,this.height=void 0!=e?e:100,this.depth=void 0!=i?i:100;var r=new THREE.BoxGeometry(this.width,this.height,this.depth,1,1,1);r.computeBoundingBox(),r.computeBoundingSphere(),THREE.Mesh.call(this,r,THREE.SEA3D.Dummy.MATERIAL)},THREE.SEA3D.Dummy.MATERIAL=new THREE.MeshBasicMaterial({wireframe:!0,color:THREE.SEA3D.HELPER_COLOR}),THREE.SEA3D.Dummy.prototype=Object.assign(Object.create(THREE.Mesh.prototype),THREE.SEA3D.Object3D.prototype,{constructor:THREE.SEA3D.Dummy,copy:function(t){return THREE.Mesh.prototype.copy.call(this,t),this.attribs=t.attribs,this.scripts=t.scripts,t.animator&&(this.animator=t.animator.clone(this)),this},dispose:function(){this.geometry.dispose()}}),THREE.SEA3D.Mesh=function(t,e){THREE.Mesh.call(this,t,e)},THREE.SEA3D.Mesh.prototype=Object.assign(Object.create(THREE.Mesh.prototype),THREE.SEA3D.Object3D.prototype,{constructor:THREE.SEA3D.Mesh,setWeight:function(t,e){var i="number"==typeof t?t:this.morphTargetDictionary[t];this.morphTargetInfluences[i]=e},getWeight:function(t){var e="number"==typeof t?t:this.morphTargetDictionary[t];return this.morphTargetInfluences[e]},copy:function(t){return THREE.Mesh.prototype.copy.call(this,t),this.attribs=t.attribs,this.scripts=t.scripts,t.animator&&(this.animator=t.animator.clone(this)),this}}),THREE.SEA3D.SkinnedMesh=function(t,e,i){THREE.SkinnedMesh.call(this,t,e,i),this.updateAnimations(t.animations,new THREE.AnimationMixer(this))},THREE.SEA3D.SkinnedMesh.prototype=Object.assign(Object.create(THREE.SkinnedMesh.prototype),THREE.SEA3D.Mesh.prototype,THREE.SEA3D.Animator.prototype,{constructor:THREE.SEA3D.SkinnedMesh,boneByName:function(t){for(var e=this.skeleton.bones,i=0,r=e.length;i<r;i++)if(t==e[i].name)return e[i]},copy:function(t){return THREE.SkinnedMesh.prototype.copy.call(this,t),this.attribs=t.attribs,this.scripts=t.scripts,t.animator&&(this.animator=t.animator.clone(this)),this}}),THREE.SEA3D.VertexAnimationMesh=function(t,e){THREE.Mesh.call(this,t,e),this.type="MorphAnimMesh",this.updateAnimations(t.animations,new THREE.AnimationMixer(this))},THREE.SEA3D.VertexAnimationMesh.prototype=Object.assign(Object.create(THREE.Mesh.prototype),THREE.SEA3D.Mesh.prototype,THREE.SEA3D.Animator.prototype,{constructor:THREE.SEA3D.VertexAnimationMesh,copy:function(t){return THREE.Mesh.prototype.copy.call(this,t),this.attribs=t.attribs,this.scripts=t.scripts,t.animator&&(this.animator=t.animator.clone(this)),this}}),THREE.SEA3D.Camera=function(t,e,i,r){THREE.PerspectiveCamera.call(this,t,e,i,r)},THREE.SEA3D.Camera.prototype=Object.assign(Object.create(THREE.PerspectiveCamera.prototype),THREE.SEA3D.Object3D.prototype,{constructor:THREE.SEA3D.Camera,copy:function(t){return THREE.PerspectiveCamera.prototype.copy.call(this,t),this.attribs=t.attribs,this.scripts=t.scripts,t.animator&&(this.animator=t.animator.clone(this)),this}}),THREE.SEA3D.OrthographicCamera=function(t,e,i,r,n,o){THREE.OrthographicCamera.call(this,t,e,i,r,n,o)},THREE.SEA3D.OrthographicCamera.prototype=Object.assign(Object.create(THREE.OrthographicCamera.prototype),THREE.SEA3D.Object3D.prototype,{constructor:THREE.SEA3D.OrthographicCamera,copy:function(t){return THREE.OrthographicCamera.prototype.copy.call(this,t),this.attribs=t.attribs,this.scripts=t.scripts,t.animator&&(this.animator=t.animator.clone(this)),this}}),THREE.SEA3D.PointLight=function(t,e,i,r){THREE.PointLight.call(this,t,e,i,r)},THREE.SEA3D.PointLight.prototype=Object.assign(Object.create(THREE.PointLight.prototype),THREE.SEA3D.Object3D.prototype,{constructor:THREE.SEA3D.PointLight,copy:function(t){return THREE.PointLight.prototype.copy.call(this,t),this.attribs=t.attribs,this.scripts=t.scripts,t.animator&&(this.animator=t.animator.clone(this)),this}}),THREE.SEA3D.PointSound=function(t){THREE.PositionalAudio.call(this,t)},THREE.SEA3D.PointSound.prototype=Object.assign(Object.create(THREE.PositionalAudio.prototype),THREE.SEA3D.Object3D.prototype,{constructor:THREE.SEA3D.PointSound,copy:function(t){return THREE.PositionalAudio.prototype.copy.call(this,t),this.attribs=t.attribs,this.scripts=t.scripts,t.animator&&(this.animator=t.animator.clone(this)),this}}),THREE.SEA3D.AnimationHandler={animators:[],update:function(t){for(var e=0;e<this.animators.length;)this.animators[e++].update(t)},add:function(t){-1===this.animators.indexOf(t)&&this.animators.push(t)},remove:function(t){var e=this.animators.indexOf(t);-1!==e&&this.animators.splice(e,1)}},THREE.SEA3D.Domain.prototype.getMesh=THREE.SEA3D.prototype.getMesh=function(t){return this.objects["m3d/"+t]},THREE.SEA3D.Domain.prototype.getDummy=THREE.SEA3D.prototype.getDummy=function(t){return this.objects["dmy/"+t]},THREE.SEA3D.Domain.prototype.getLine=THREE.SEA3D.prototype.getLine=function(t){return this.objects["line/"+t]},THREE.SEA3D.Domain.prototype.getSound3D=THREE.SEA3D.prototype.getSound3D=function(t){return this.objects["sn3d/"+t]},THREE.SEA3D.Domain.prototype.getMaterial=THREE.SEA3D.prototype.getMaterial=function(t){return this.objects["mat/"+t]},THREE.SEA3D.Domain.prototype.getLight=THREE.SEA3D.prototype.getLight=function(t){return this.objects["lht/"+t]},THREE.SEA3D.Domain.prototype.getGLSL=THREE.SEA3D.prototype.getGLSL=function(t){return this.objects["glsl/"+t]},THREE.SEA3D.Domain.prototype.getCamera=THREE.SEA3D.prototype.getCamera=function(t){return this.objects["cam/"+t]},THREE.SEA3D.Domain.prototype.getTexture=THREE.SEA3D.prototype.getTexture=function(t){return this.objects["tex/"+t]},THREE.SEA3D.Domain.prototype.getCubeMap=THREE.SEA3D.prototype.getCubeMap=function(t){return this.objects["cmap/"+t]},THREE.SEA3D.Domain.prototype.getJointObject=THREE.SEA3D.prototype.getJointObject=function(t){return this.objects["jnt/"+t]},THREE.SEA3D.Domain.prototype.getContainer3D=THREE.SEA3D.prototype.getContainer3D=function(t){return this.objects["c3d/"+t]},THREE.SEA3D.Domain.prototype.getSprite=THREE.SEA3D.prototype.getSprite=function(t){return this.objects["m2d/"+t]},THREE.SEA3D.Domain.prototype.getProperties=THREE.SEA3D.prototype.getProperties=function(t){return this.objects["prop/"+t]},THREE.SEA3D.prototype.isPowerOfTwo=function(t){return!!t&&(t&-t)==t},THREE.SEA3D.prototype.nearestPowerOfTwo=function(t){return Math.pow(2,Math.round(Math.log(t)/Math.LN2))},THREE.SEA3D.prototype.updateTransform=function(t,e){var i=THREE.SEA3D.MTXBUF,r=THREE.SEA3D.VECBUF;e.transform?i.fromArray(e.transform):i.makeTranslation(e.position.x,e.position.y,e.position.z),t.position.setFromMatrixPosition(i),t.scale.setFromMatrixScale(i),i.scale(r.set(1/t.scale.x,1/t.scale.y,1/t.scale.z)),t.rotation.setFromRotationMatrix(i),(this.config.forceStatic||e.isStatic)&&(t.updateMatrix(),t.matrixAutoUpdate=!1)},THREE.SEA3D.prototype.toVector3=function(t){return new THREE.Vector3(t.x,t.y,t.z)},THREE.SEA3D.prototype.toFaces=function(t){var e=[];return e[0]=t[1],e[1]=t[0],e[2]=t[3],e[3]=t[2],e[4]=t[5],e[5]=t[4],e},THREE.SEA3D.prototype.updateScene=function(){if(void 0!=this.materials)for(var t=0,e=this.materials.length;t<e;++t)this.materials[t].needsUpdate=!0},THREE.SEA3D.prototype.addSceneObject=function(t,e){(e=e||t.tag).visible=t.visible,t.parent?t.parent.tag.add(e):this.config.container&&this.config.container.add(e),t.attributes&&(e.attribs=t.attributes.tag),t.scripts&&(e.scripts=this.getJSMList(e,t.scripts),this.config.runScripts&&this.domain.runJSMList(e))},THREE.SEA3D.prototype.createObjectURL=function(t,e){return(window.URL||window.webkitURL).createObjectURL(new Blob([t],{type:e}))},THREE.SEA3D.prototype.bufferToTexture=function(t){return this.createObjectURL(t,"image")},THREE.SEA3D.prototype.bufferToSound=function(t){return this.createObjectURL(t,"audio")},THREE.SEA3D.prototype.parsePath=function(t){var e=this.config.paths;for(var i in e)t=t.replace(new RegExp("%"+i+"%","g"),e[i]);return t},THREE.SEA3D.prototype.addDefaultAnimation=function(t,e){for(var i=t.tag,r=0,n=t.animations?t.animations.length:0;r<n;r++){var o=t.animations[r];switch(o.tag.type){case SEA3D.Animation.prototype.type:var a=o.tag.tag||this.getAnimationType({sea:o.tag,scope:i,relative:o.relative});return i.animator=new e(a,i),i.animator.setRelative(o.relative),this.config.autoPlay&&i.animator.play(0),i.animator}}},THREE.SEA3D.prototype.readGeometryBuffer=function(t){for(var e=new THREE.BufferGeometry,i=0;i<t.groups.length;i++){var r=t.groups[i];e.addGroup(r.start,r.count,i)}e.setIndex(new THREE.BufferAttribute(t.indexes,1)),e.addAttribute("position",new THREE.BufferAttribute(t.vertex,3)),t.uv&&(e.addAttribute("uv",new THREE.BufferAttribute(t.uv[0],2)),t.uv.length>1&&e.addAttribute("uv2",new THREE.BufferAttribute(t.uv[1],2))),t.normal?e.addAttribute("normal",new THREE.BufferAttribute(t.normal,3)):e.computeVertexNormals(),t.tangent4&&e.addAttribute("tangent",new THREE.BufferAttribute(t.tangent4,4)),t.color&&e.addAttribute("color",new THREE.BufferAttribute(t.color[0],t.numColor)),t.joint&&(e.addAttribute("skinIndex",new THREE.Float32BufferAttribute(t.joint,t.jointPerVertex)),e.addAttribute("skinWeight",new THREE.Float32BufferAttribute(t.weight,t.jointPerVertex))),this.config.bounding&&(e.computeBoundingBox(),e.computeBoundingSphere()),e.name=t.name,this.domain.geometries=this.geometries=this.geometries||[],this.geometries.push(this.objects["geo/"+t.name]=t.tag=e)},THREE.SEA3D.prototype.readDummy=function(t){var e=new THREE.SEA3D.Dummy(t.width,t.height,t.depth);e.name=t.name,this.domain.dummys=this.dummys=this.dummys||[],this.dummys.push(this.objects["dmy/"+t.name]=t.tag=e),this.addSceneObject(t),this.updateTransform(e,t),this.addDefaultAnimation(t,THREE.SEA3D.Object3DAnimator)},THREE.SEA3D.prototype.readLine=function(t){var e=new THREE.BufferGeometry;t.closed&&t.vertex.push(t.vertex[0],t.vertex[1],t.vertex[2]),e.addAttribute("position",new THREE.Float32BufferAttribute(t.vertex,3));var i=new THREE.Line(e,new THREE.LineBasicMaterial({color:THREE.SEA3D.HELPER_COLOR,linewidth:3}));i.name=t.name,this.lines=this.lines||[],this.lines.push(this.objects["line/"+t.name]=t.tag=i),this.addSceneObject(t),this.updateTransform(i,t),this.addDefaultAnimation(t,THREE.SEA3D.Object3DAnimator)},THREE.SEA3D.prototype.readContainer3D=function(t){var e=new THREE.SEA3D.Object3D;this.domain.containers=this.containers=this.containers||[],this.containers.push(this.objects["c3d/"+t.name]=t.tag=e),this.addSceneObject(t),this.updateTransform(e,t),this.addDefaultAnimation(t,THREE.SEA3D.Object3DAnimator)},THREE.SEA3D.prototype.readSprite=function(t){var e;t.material&&(t.material.tag.sprite?e=t.material.tag.sprite:(e=t.material.tag.sprite=new THREE.SpriteMaterial,this.setBlending(e,t.blendMode),e.map=t.material.tag.map,e.map.flipY=!0,e.color.set(t.material.tag.color),e.opacity=t.material.tag.opacity,e.fog=t.material.receiveFog));var i=new THREE.Sprite(e);i.name=t.name,this.domain.sprites=this.sprites=this.sprites||[],this.sprites.push(this.objects["m2d/"+t.name]=t.tag=i),this.addSceneObject(t),this.updateTransform(i,t),i.scale.set(t.width,t.height,1)},THREE.SEA3D.prototype.readMesh=function(t){var e,i,r,n,o,a,s,h,l=t.geometry.tag;for(e=0,i=t.modifiers?t.modifiers.length:0;e<i;e++){var c=t.modifiers[e];switch(c.type){case SEA3D.Skeleton.prototype.type:case SEA3D.SkeletonLocal.prototype.type:o=c,l.bones=o.tag;break;case SEA3D.Morph.prototype.type:h=c,l.morphAttributes=h.tag.attribs,l.morphTargets=h.tag.targets}}for(e=0,i=t.animations?t.animations.length:0;e<i;e++){var u=t.animations[e];switch(u.tag.type){case SEA3D.SkeletonAnimation.prototype.type:a=u.tag,l.animations=a.tag||this.getAnimationType({sea:a,skeleton:o,relative:!0});break;case SEA3D.VertexAnimation.prototype.type:s=u.tag,l.morphAttributes=s.tag.attribs,l.morphTargets=s.tag.targets,l.animations=s.tag.animations}}var p=void 0!=h||void 0!=s,d=h&&void 0!=h.tag.attribs.normal||s&&void 0!=s.tag.attribs.normal;if(t.material)if(t.material.length>1){var f=[];for(e=0;e<t.material.length;e++)f[e]=t.material[e].tag,f[e].skinning=void 0!=o,f[e].morphTargets=p,f[e].morphNormals=d,f[e].vertexColors=t.geometry.color?THREE.VertexColors:THREE.NoColors;n=f}else(n=t.material[0].tag).skinning=void 0!=o,n.morphTargets=p,n.morphNormals=d,n.vertexColors=t.geometry.color?THREE.VertexColors:THREE.NoColors;o?(r=new THREE.SEA3D.SkinnedMesh(l,n,this.config.useVertexTexture),this.config.autoPlay&&a&&r.play(0)):s?(r=new THREE.SEA3D.VertexAnimationMesh(l,n,s.frameRate),this.config.autoPlay&&r.play(0)):r=new THREE.SEA3D.Mesh(l,n),r.name=t.name,r.castShadow=t.castShadows,r.receiveShadow=!t.material||t.material[0].receiveShadows,this.domain.meshes=this.meshes=this.meshes||[],this.meshes.push(this.objects["m3d/"+t.name]=t.tag=r),this.addSceneObject(t),this.updateTransform(r,t),this.addDefaultAnimation(t,THREE.SEA3D.Object3DAnimator)},THREE.SEA3D.prototype.readSoundPoint=function(t){this.audioListener||(this.audioListener=new THREE.AudioListener,this.config.container&&this.config.container.add(this.audioListener));var e=new THREE.SEA3D.PointSound(this.audioListener);(new THREE.AudioLoader).load(t.sound.tag,function(t){e.setBuffer(t)}),e.autoplay=t.autoPlay,e.setLoop(t.autoPlay),e.setVolume(t.volume),e.setRefDistance(t.distance),e.setRolloffFactor(this.config.audioRolloffFactor),e.name=t.name,this.domain.sounds3d=this.sounds3d=this.sounds3d||[],this.sounds3d.push(this.objects["sn3d/"+t.name]=t.tag=e),this.addSceneObject(t),this.updateTransform(e,t),this.addDefaultAnimation(t,THREE.SEA3D.SoundAnimator)},THREE.SEA3D.prototype.readCubeRender=function(t){var e=new THREE.CubeCamera(.1,5e3,THREE.SEA3D.RTT_SIZE);e.renderTarget.cubeCamera=e,t.tag=e.renderTarget,this.domain.cubeRenderers=this.cubeRenderers=this.cubeRenderers||[],this.cubeRenderers.push(this.objects["rttc/"+t.name]=e),this.addSceneObject(t,e),this.updateTransform(e,t)},THREE.SEA3D.prototype.readTexture=function(t){var e=new Image,i=new THREE.Texture;i.name=t.name,i.wrapS=i.wrapT=THREE.RepeatWrapping,i.flipY=!1,i.image=e,void 0!==this.config.anisotropy&&(i.anisotropy=this.config.anisotropy),e.onload=function(){i.needsUpdate=!0},e.src=this.bufferToTexture(t.data.buffer),this.domain.textures=this.textures=this.textures||[],this.textures.push(this.objects["tex/"+t.name]=t.tag=i)},THREE.SEA3D.prototype.readCubeMap=function(t){var e=this.toFaces(t.faces),i=new THREE.CubeTexture([]),r=0;i.name=t.name,i.flipY=!1,i.format=THREE.RGBFormat;for(var n=function(){6==++r&&(i.needsUpdate=!0,this.config.async||(this.file.resume=!0))}.bind(this),o=0;o<e.length;++o){var a=new Image;a.onload=n,a.src=this.bufferToTexture(e[o].buffer),i.images[o]=a}this.config.async||(this.file.resume=!1),this.domain.cubemaps=this.cubemaps=this.cubemaps||[],this.cubemaps.push(this.objects["cmap/"+t.name]=t.tag=i)},THREE.SEA3D.prototype.readSound=function(t){var e=this.bufferToSound(t.data.buffer);this.domain.sounds=this.sounds=this.sounds||[],this.sounds.push(this.objects["snd/"+t.name]=t.tag=e)},THREE.SEA3D.prototype.readScriptURL=function(t){this.file.resume=!1,(new THREE.FileLoader).setResponseType("text").load(t.url,function(e){this.file.resume=!0,this.domain.scripts=this.scripts=this.scripts||[],this.scripts.push(this.objects["src/"+t.name]=t.tag=e)}.bind(this))},THREE.SEA3D.prototype.readTextureURL=function(t){var e=(new THREE.TextureLoader).load(this.parsePath(t.url));e.name=t.name,e.wrapS=e.wrapT=THREE.RepeatWrapping,e.flipY=!1,void 0!==this.config.anisotropy&&(e.anisotropy=this.config.anisotropy),this.domain.textures=this.textures=this.textures||[],this.textures.push(this.objects["tex/"+t.name]=t.tag=e)},THREE.SEA3D.prototype.readCubeMapURL=function(t){for(var e=this.toFaces(t.faces),i=0;i<e.length;i++)e[i]=this.parsePath(e[i]);var r;if("hdr"==e[0].substr(-3)){var n=null!=THREE.PMREMGenerator;this.file.resume=!n,r=(new THREE.HDRCubeTextureLoader).load(THREE.UnsignedByteType,e,function(e){if(n){var i=new THREE.PMREMGenerator(e);i.update(this.config.renderer);var r=new THREE.PMREMCubeUVPacker(i.cubeLods);r.update(this.config.renderer),e.dispose(),this.objects["cmap/"+t.name]=t.tag=r.CubeUVRenderTarget.texture,this.file.resume=!0}}.bind(this))}else r=(new THREE.CubeTextureLoader).load(e);r.name=t.name,r.wrapS=r.wrapT=THREE.RepeatWrapping,r.flipY=!1,void 0!==this.config.anisotropy&&(r.anisotropy=this.config.anisotropy),this.domain.cubemaps=this.cubemaps=this.cubemaps||[],this.cubemaps.push(this.objects["cmap/"+t.name]=t.tag=r)},THREE.SEA3D.prototype.getJSMList=function(t,e){for(var i=[],r=0;r<e.length;r++){var n=e[r];n.tag.type==SEA3D.JavaScriptMethod.prototype.type&&i.push(n)}return this.domain.scriptTargets=this.scriptTargets=this.scriptTargets||[],this.scriptTargets.push(t),i},THREE.SEA3D.prototype.readJavaScriptMethod=function(sea){try{var src="(function() {\nvar $METHOD = {}\n",declare='function($INC, $REF, global, local, $his, $PARAM) {\nvar watch = $INC["watch"],\nscene = $INC["scene"],\nsea3d = $INC["sea3d"],\nprint = $INC["print"];\n';for(var name in declare+='var $SRC = $INC["source"],\naddEventListener = $SRC.addEventListener.bind( $SRC ),\nhasEventListener = $SRC.hasEventListener.bind( $SRC ),\nremoveEventListener = $SRC.removeEventListener.bind( $SRC ),\ndispatchEvent = $SRC.dispatchEvent.bind( $SRC ),\ndispose = $SRC.dispose.bind( $SRC );\n',sea.methods)src+='$METHOD["'+name+'"] = '+declare+sea.methods[name].src+"}\n";src+="return $METHOD; })",this.domain.methods=eval(src)()}catch(t){}},THREE.SEA3D.prototype.readGLSL=function(t){this.domain.glsl=this.glsl=this.glsl||[],this.glsl.push(this.objects["glsl/"+t.name]=t.tag=t.src)},THREE.SEA3D.prototype.materialTechnique=function(){var t={onComplete:function(t,e){(e.alpha<1||t.blending>THREE.NormalBlending)&&(t.opacity=e.alpha,t.transparent=!0)}};return t[SEA3D.Material.PHYSICAL]=function(t,e){t.color.setHex(e.color),t.roughness=e.roughness,t.metalness=e.metalness},t[SEA3D.Material.REFLECTIVITY]=function(t,e){t.reflectivity=e.strength},t[SEA3D.Material.CLEAR_COAT]=function(t,e){t.clearCoat=e.strength,t.clearCoatRoughness=e.roughness},t[SEA3D.Material.PHONG]=function(t,e){t.color.setHex(e.diffuseColor),t.specular.setHex(e.specularColor).multiplyScalar(e.specular),t.shininess=e.gloss},t[SEA3D.Material.DIFFUSE_MAP]=function(t,e,i){t.map=e.texture.tag,t.color.setHex(16777215),t.map.wrapS=t.map.wrapT=i.repeat?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping,e.texture.transparent&&(t.transparent=!0)},t[SEA3D.Material.ROUGHNESS_MAP]=function(t,e){t.roughnessMap=e.texture.tag},t[SEA3D.Material.METALNESS_MAP]=function(t,e){t.metalnessMap=e.texture.tag},t[SEA3D.Material.SPECULAR_MAP]=function(t,e){t.specular&&(t.specularMap=e.texture.tag,t.specular.setHex(16777215))},t[SEA3D.Material.NORMAL_MAP]=function(t,e){t.normalMap=e.texture.tag},t[SEA3D.Material.REFLECTION]=t[SEA3D.Material.FRESNEL_REFLECTION]=function(t,e){t.envMap=e.texture.tag,t.envMap.mapping=THREE.CubeReflectionMapping,t.combine=THREE.MixOperation,t.reflectivity=e.alpha},t[SEA3D.Material.REFLECTION_SPHERICAL]=function(t,e){t.envMap=e.texture.tag,t.envMap.mapping=THREE.SphericalReflectionMapping,t.combine=THREE.MixOperation,t.reflectivity=e.alpha},t[SEA3D.Material.REFRACTION_MAP]=function(t,e){t.envMap=e.texture.tag,t.envMap.mapping=THREE.CubeRefractionMapping,t.refractionRatio=e.ior,t.reflectivity=e.alpha},t[SEA3D.Material.LIGHT_MAP]=function(t,e){"multiply"==e.blendMode?t.aoMap=e.texture.tag:t.lightMap=e.texture.tag},t[SEA3D.Material.EMISSIVE]=function(t,e){t.emissive.setHex(e.color)},t[SEA3D.Material.EMISSIVE_MAP]=function(t,e){t.emissiveMap=e.texture.tag},t[SEA3D.Material.ALPHA_MAP]=function(t,e,i){t.alphaMap=e.texture.tag,t.transparent=!0,t.alphaMap.wrapS=t.alphaMap.wrapT=i.repeat?THREE.RepeatWrapping:THREE.ClampToEdgeWrapping},t}(),THREE.SEA3D.prototype.createMaterial=function(t){return t.tecniquesDict[SEA3D.Material.REFLECTIVITY]||t.tecniquesDict[SEA3D.Material.CLEAR_COAT]?new THREE.MeshPhysicalMaterial:t.tecniquesDict[SEA3D.Material.PHYSICAL]?new THREE.MeshStandardMaterial:new THREE.MeshPhongMaterial},THREE.SEA3D.prototype.setBlending=function(t,e){if("normal"!==e){switch(e){case"add":t.blending=THREE.AdditiveBlending;break;case"subtract":t.blending=THREE.SubtractiveBlending;break;case"multiply":t.blending=THREE.MultiplyBlending;break;case"screen":t.blending=THREE.CustomBlending,t.blendSrc=THREE.OneFactor,t.blendDst=THREE.OneMinusSrcColorFactor,t.blendEquation=THREE.AddEquation}t.transparent=!0}},THREE.SEA3D.prototype.readMaterial=function(t){var e=this.createMaterial(t);e.name=t.name,e.depthWrite=t.depthWrite,e.depthTest=t.depthTest,e.premultipliedAlpha=t.premultipliedAlpha,e.side=t.bothSides?THREE.DoubleSide:THREE.FrontSide,this.setBlending(e,t.blendMode);for(var i=0;i<t.technique.length;i++){var r=t.technique[i];this.materialTechnique[r.kind]&&this.materialTechnique[r.kind].call(this,e,r,t)}this.materialTechnique.onComplete&&this.materialTechnique.onComplete.call(this,e,t),this.domain.materials=this.materials=this.materials||[],this.materials.push(this.objects["mat/"+t.name]=t.tag=e)},THREE.SEA3D.prototype.readPointLight=function(t){var e=new THREE.SEA3D.PointLight(t.color,t.multiplier*this.config.multiplier);e.name=t.name,t.attenuation&&(e.distance=t.attenuation.end),t.shadow&&this.setShadowMap(e),this.domain.lights=this.lights=this.lights||[],this.lights.push(this.objects["lht/"+t.name]=t.tag=e),this.addSceneObject(t),this.updateTransform(e,t),this.addDefaultAnimation(t,THREE.SEA3D.LightAnimator),this.updateScene()},THREE.SEA3D.prototype.readHemisphereLight=function(t){var e=new THREE.HemisphereLight(t.color,t.secondColor,t.multiplier*this.config.multiplier);e.position.set(0,500,0),e.name=t.name,this.domain.lights=this.lights=this.lights||[],this.lights.push(this.objects["lht/"+t.name]=t.tag=e),this.addSceneObject(t),this.addDefaultAnimation(t,THREE.SEA3D.LightAnimator),this.updateScene()},THREE.SEA3D.prototype.readAmbientLight=function(t){var e=new THREE.AmbientLight(t.color,t.multiplier*this.config.multiplier);e.name=t.name,this.domain.lights=this.lights=this.lights||[],this.lights.push(this.objects["lht/"+t.name]=t.tag=e),this.addSceneObject(t),this.addDefaultAnimation(t,THREE.SEA3D.LightAnimator),this.updateScene()},THREE.SEA3D.prototype.readDirectionalLight=function(t){var e=new THREE.DirectionalLight(t.color,t.multiplier*this.config.multiplier);e.name=t.name,t.shadow&&this.setShadowMap(e),this.domain.lights=this.lights=this.lights||[],this.lights.push(this.objects["lht/"+t.name]=t.tag=e),this.addSceneObject(t),this.updateTransform(e,t),this.addDefaultAnimation(t,THREE.SEA3D.LightAnimator),this.updateScene()},THREE.SEA3D.prototype.readCamera=function(t){var e=new THREE.SEA3D.Camera(t.fov);e.name=t.name,this.domain.cameras=this.cameras=this.cameras||[],this.cameras.push(this.objects["cam/"+t.name]=t.tag=e),this.addSceneObject(t),this.updateTransform(e,t),this.addDefaultAnimation(t,THREE.SEA3D.CameraAnimator)},THREE.SEA3D.prototype.readOrthographicCamera=function(t){var e,i,r,n=void 0!==this.config.stageWidth?this.config.stageWidth:window?window.innerWidth:1024,o=void 0!==this.config.stageHeight?this.config.stageHeight:window?window.innerHeight:1024;n>o?(e=n/o,i=t.height*e,r=t.height):(e=o/n,i=t.height,r=t.height*e);var a=new THREE.SEA3D.OrthographicCamera(-i,i,r,-r);a.name=t.name,this.domain.cameras=this.cameras=this.cameras||[],this.cameras.push(this.objects["cam/"+t.name]=t.tag=a),this.addSceneObject(t),this.updateTransform(a,t),this.addDefaultAnimation(t,THREE.SEA3D.CameraAnimator)},THREE.SEA3D.prototype.readSkeletonLocal=function(t){for(var e=[],i=0;i<t.joint.length;i++){var r=t.joint[i];e[i]={name:r.name,pos:[r.x,r.y,r.z],rotq:[r.qx,r.qy,r.qz,r.qw],parent:r.parentIndex}}t.tag=e},THREE.SEA3D.prototype.readJointObject=function(t){var e=t.target.tag.skeleton.bones[t.joint];this.domain.joints=this.joints=this.joints||[],this.joints.push(this.objects["jnt/"+t.name]=t.tag=e)},THREE.SEA3D.prototype.readMorpher=function(t){for(var e={position:[]},i=[],r=0;r<t.node.length;r++){var n=t.node[r];e.position[r]=new THREE.Float32BufferAttribute(n.vertex,3),e.position[r].name=n.name,n.normal&&(e.normal=e.normal||[],e.normal[r]=new THREE.Float32BufferAttribute(n.normal,3)),i[r]={name:n.name}}t.tag={attribs:e,targets:i}},THREE.SEA3D.prototype.readAnimation=function(t){for(var e=[],i=1e3/t.frameRate/1e3,r=0;r<t.sequence.length;r++){for(var n=t.sequence[r],o=[],a=0;a<t.dataList.length;a++){var s,h,l,c,u=t.dataList[a],p=u.data,d=n.start*u.blockSize,f=d+n.count*u.blockSize,m=!!n.intrpl&&THREE.InterpolateLinear,g=null;switch(u.kind){case SEA3D.Animation.POSITION:g=".position";break;case SEA3D.Animation.ROTATION:g=".quaternion";break;case SEA3D.Animation.SCALE:g=".scale";break;case SEA3D.Animation.COLOR:g=".color";break;case SEA3D.Animation.MULTIPLIER:g=".intensity";break;case SEA3D.Animation.FOV:g=".fov"}if(g)switch(u.type){case SEA3D.Stream.BYTE:case SEA3D.Stream.UBYTE:case SEA3D.Stream.INT:case SEA3D.Stream.UINT:case SEA3D.Stream.FLOAT:case SEA3D.Stream.DOUBLE:case SEA3D.Stream.DECIMAL:for(c=p.subarray(d,f),l=new Float32Array(c.length),s=0,h=0;h<l.length;h++)l[h]=s,s+=i;o.push(new THREE.VectorKeyframeTrack(g,l,c,m));break;case SEA3D.Stream.VECTOR3D:for(c=p.subarray(d,f),l=new Float32Array(c.length/u.blockSize),s=0,h=0;h<l.length;h++)l[h]=s,s+=i;o.push(new THREE.VectorKeyframeTrack(g,l,c,m));break;case SEA3D.Stream.VECTOR4D:for(c=p.subarray(d,f),l=new Float32Array(c.length/u.blockSize),s=0,h=0;h<l.length;h++)l[h]=s,s+=i;o.push(new THREE.QuaternionKeyframeTrack(g,l,c,m));break;case SEA3D.Stream.INT24:case SEA3D.Stream.UINT24:for(c=new Float32Array(3*(f-d)),l=new Float32Array(c.length/3),s=0,h=0;h<l.length;h++)c[3*h]=(p[h]>>16&255)/255,c[3*h+1]=(p[h]>>8&255)/255,c[3*h+2]=(255&p[h])/255,l[h]=s,s+=i;o.push(new THREE.VectorKeyframeTrack(g,l,c,m))}}e.push(new THREE.SEA3D.AnimationClip(n.name,-1,o,n.repeat))}this.domain.clips=this.clips=this.clips||[],this.clips.push(this.objects[t.name+".anm"]=t.tag=e)},THREE.SEA3D.prototype.readSkeletonAnimation=function(t,e){for(var i=[],r=1e3/t.frameRate/1e3,n=0;n<t.sequence.length;n++){for(var o=t.sequence[n],a=o.start,s=a+o.count,h={name:o.name,fps:t.frameRate,length:r*o.count,hierarchy:[]},l=t.numJoints,c=t.raw,u=0;u<l;u++){for(var p={parent:e.joint[u].parentIndex,keys:[]},d=p.keys,f=0,m=a;m<s;m++){var g=m*l*7+7*u;d.push({time:f,pos:[c[g],c[g+1],c[g+2]],rot:[c[g+3],c[g+4],c[g+5],c[g+6]],scl:[1,1,1]}),f+=r}h.hierarchy[u]=p}i.push(THREE.SEA3D.AnimationClip.fromClip(THREE.AnimationClip.parseAnimation(h,e.tag),o.repeat))}this.domain.clips=this.clips=this.clips||[],this.clips.push(this.objects[t.name+".skla"]=t.tag=i)},THREE.SEA3D.prototype.readVertexAnimation=function(t){var e,i,r,n={position:[]},o=[],a=[];for(e=0,r=t.frame.length;e<r;e++){var s=t.frame[e];n.position[e]=new THREE.Float32BufferAttribute(s.vertex,3),s.normal&&(n.normal=n.normal||[],n.normal[e]=new THREE.Float32BufferAttribute(s.normal,3)),o[e]={name:e}}for(e=0;e<t.sequence.length;e++){var h=t.sequence[e],l=[];for(i=0;i<h.count;i++)l[i]=o[h.start+i];a.push(THREE.SEA3D.AnimationClip.fromClip(THREE.AnimationClip.CreateFromMorphTargetSequence(h.name,l,t.frameRate),h.repeat))}t.tag={attribs:n,targets:o,animations:a},this.domain.clips=this.clips=this.clips||[],this.clips.push(this.objects[t.name+".vtxa"]=t.tag)},THREE.SEA3D.prototype.getAnimationType=function(t){var e=t.sea;switch(e.type){case SEA3D.SkeletonAnimation.prototype.type:this.readSkeletonAnimation(e,t.skeleton)}return e.tag},THREE.SEA3D.prototype.applyEnvironment=function(t){for(var e=0,i=this.materials.length;e<i;++e){var r=this.materials[e];if(r instanceof THREE.MeshStandardMaterial){if(r.envMap)continue;r.envMap=t,r.envMap.mapping=THREE.CubeReflectionMapping,r.needsUpdate=!0}}},THREE.SEA3D.prototype.readActions=function(t){for(var e=0;e<t.actions.length;e++){var i=t.actions[e];switch(i.kind){case SEA3D.Actions.ATTRIBUTES:this.attribs=this.domain.attribs=i.attributes.tag;break;case SEA3D.Actions.SCRIPTS:this.domain.scripts=this.getJSMList(this.domain,i.scripts),this.config.runScripts&&this.domain.runJSMList(this.domain);break;case SEA3D.Actions.ENVIRONMENT_COLOR:this.domain.background=this.background=this.background||{},this.background.color=new THREE.Color(i.color);break;case SEA3D.Actions.ENVIRONMENT:this.domain.background=this.background=this.background||{},this.background.texture=i.texture.tag,this.config.useEnvironment&&void 0!=this.materials&&this.applyEnvironment(i.texture.tag)}}},THREE.SEA3D.Event={PROGRESS:"sea3d_progress",LOAD_PROGRESS:"sea3d_load",DOWNLOAD_PROGRESS:"sea3d_download",COMPLETE:"sea3d_complete",OBJECT_COMPLETE:"sea3d_object",PARSE_PROGRESS:"parse_progress",PARSE_COMPLETE:"parse_complete",ERROR:"sea3d_error"},THREE.SEA3D.prototype.onProgress=function(t){t.status=t.type,t.progress=t.loaded/t.total,t.type=THREE.SEA3D.Event.PROGRESS,this.dispatchEvent(t)},THREE.SEA3D.prototype.onLoadProgress=function(t){t.type=THREE.SEA3D.Event.LOAD_PROGRESS,this.dispatchEvent(t),this.onProgress(t)},THREE.SEA3D.prototype.onDownloadProgress=function(t){t.type=THREE.SEA3D.Event.DOWNLOAD_PROGRESS,this.dispatchEvent(t),this.onProgress(t)},THREE.SEA3D.prototype.onComplete=function(t){t.type=THREE.SEA3D.Event.COMPLETE,this.dispatchEvent(t)},THREE.SEA3D.prototype.onCompleteObject=function(t){t.type=THREE.SEA3D.Event.OBJECT_COMPLETE,this.dispatchEvent(t)},THREE.SEA3D.prototype.onParseProgress=function(t){t.type=THREE.SEA3D.Event.PARSE_PROGRESS,this.dispatchEvent(t)},THREE.SEA3D.prototype.onParseComplete=function(t){t.type=THREE.SEA3D.Event.PARSE_COMPLETE,this.dispatchEvent(t)},THREE.SEA3D.prototype.onError=function(t){t.type=THREE.SEA3D.Event.ERROR,this.dispatchEvent(t)},THREE.SEA3D.prototype.createDomain=function(){return this.domain=new THREE.SEA3D.Domain(this.config.id,this.objects={},this.config.container)},THREE.SEA3D.prototype.clone=function(t,e,i){if(!this.file.isDone())throw new Error("Previous parse is not completed.");this.config.container=t&&void 0!==t.container?t.container:new THREE.Object3D,t&&this.loadConfig(t);var r=this.config.timeLimit;return this.config.timeLimit=t&&void 0!==t.timeLimit?t.timeLimit:1/0,this.parse(e,i),this.config.timeLimit=r,this.domain},THREE.SEA3D.prototype.loadConfig=function(t){for(var e in t)this.config[e]=t[e]},THREE.SEA3D.prototype.parse=function(t,e){delete this.cameras,delete this.containers,delete this.lights,delete this.joints,delete this.meshes,delete this.materials,delete this.animationSets,delete this.sprites,delete this.sounds3d,delete this.cubeRenderers,delete this.sounds,delete this.glsl,delete this.dummy,delete this.background,delete this.domain,this.createDomain(),this.setTypeRead(),this.file.onParseComplete=function(e){this.config.manager&&this.config.manager.add(this.domain),(t||this.onParseComplete).call(this,e)}.bind(this),this.file.onParseProgress=e||this.onParseProgress;for(var i=THREE.SEA3D.EXTENSIONS_LOADER.length;i--;){var r=THREE.SEA3D.EXTENSIONS_LOADER[i];r.parse&&r.parse.call(this)}return this.file.parse(),this.domain},THREE.SEA3D.prototype.onHead=function(t){if("TJS"!=t.sign)throw new Error("Sign '"+t.sign+"' not supported! Use SEA3D Studio to publish or SEA3DLegacy.js")},THREE.SEA3D.EXTENSIONS_LOADER=[],THREE.SEA3D.EXTENSIONS_DOMAIN=[],THREE.SEA3D.prototype.setTypeRead=function(){this.file.typeRead={},this.file.typeRead[SEA3D.Geometry.prototype.type]=this.readGeometryBuffer,this.file.typeRead[SEA3D.Mesh.prototype.type]=this.readMesh,this.file.typeRead[SEA3D.Sprite.prototype.type]=this.readSprite,this.file.typeRead[SEA3D.Container3D.prototype.type]=this.readContainer3D,this.file.typeRead[SEA3D.Line.prototype.type]=this.readLine,this.file.typeRead[SEA3D.Material.prototype.type]=this.readMaterial,this.file.typeRead[SEA3D.Camera.prototype.type]=this.readCamera,this.file.typeRead[SEA3D.OrthographicCamera.prototype.type]=this.readOrthographicCamera,this.file.typeRead[SEA3D.SkeletonLocal.prototype.type]=this.readSkeletonLocal,this.file.typeRead[SEA3D.JointObject.prototype.type]=this.readJointObject,this.file.typeRead[SEA3D.CubeMap.prototype.type]=this.readCubeMap,this.file.typeRead[SEA3D.CubeRender.prototype.type]=this.readCubeRender,this.file.typeRead[SEA3D.Animation.prototype.type]=this.readAnimation,this.file.typeRead[SEA3D.SoundPoint.prototype.type]=this.readSoundPoint,this.file.typeRead[SEA3D.TextureURL.prototype.type]=this.readTextureURL,this.file.typeRead[SEA3D.CubeMapURL.prototype.type]=this.readCubeMapURL,this.file.typeRead[SEA3D.Morph.prototype.type]=this.readMorpher,this.file.typeRead[SEA3D.VertexAnimation.prototype.type]=this.readVertexAnimation,this.file.typeRead[SEA3D.Actions.prototype.type]=this.readActions,this.config.dummys&&(this.file.typeRead[SEA3D.Dummy.prototype.type]=this.readDummy),this.config.scripts&&(this.file.typeRead[SEA3D.ScriptURL.prototype.type]=this.readScriptURL,this.file.typeRead[SEA3D.JavaScriptMethod.prototype.type]=this.readJavaScriptMethod),this.config.lights&&(this.file.typeRead[SEA3D.PointLight.prototype.type]=this.readPointLight,this.file.typeRead[SEA3D.DirectionalLight.prototype.type]=this.readDirectionalLight,this.file.typeRead[SEA3D.HemisphereLight.prototype.type]=this.readHemisphereLight,this.file.typeRead[SEA3D.AmbientLight.prototype.type]=this.readAmbientLight),this.file.typeRead[SEA3D.JPEG.prototype.type]=this.file.typeRead[SEA3D.JPEG_XR.prototype.type]=this.file.typeRead[SEA3D.PNG.prototype.type]=this.file.typeRead[SEA3D.GIF.prototype.type]=this.readTexture,this.file.typeRead[SEA3D.MP3.prototype.type]=this.readSound,this.file.typeRead[SEA3D.GLSL.prototype.type]=this.readGLSL;for(var t=THREE.SEA3D.EXTENSIONS_LOADER.length;t--;){var e=THREE.SEA3D.EXTENSIONS_LOADER[t];e.setTypeRead&&e.setTypeRead.call(this)}},THREE.SEA3D.prototype.load=function(t){this.file=new SEA3D.File,this.file.scope=this,this.file.config=this.config,this.file.onProgress=this.onLoadProgress.bind(this),this.file.onCompleteObject=this.onCompleteObject.bind(this),this.file.onDownloadProgress=this.onDownloadProgress.bind(this),this.file.onParseProgress=this.onParseProgress.bind(this),this.file.onParseComplete=this.onParseComplete.bind(this),this.file.onError=this.onError.bind(this),this.file.onHead=this.onHead.bind(this),this.file.onComplete=function(t){this.config.manager&&this.config.manager.add(this.domain),this.onComplete.call(this,t)}.bind(this),this.createDomain(),this.setTypeRead(),void 0!==t&&("string"==typeof t?this.file.load(t):this.file.read(t))};var VB={REVISION:"5",Effect:function(){var t,e;this.fire_map=new Map,this.water_map=new Map,this.smokeParticles=[],this.particles=[],this.wf_time=[],this.Clock=new THREE.Clock,this.params=[],VB.Effect.prototype.initSmoke=function(t,e){var i=THREE.ImageUtils.loadTexture(e.imagepath),r=new THREE.MeshLambertMaterial({color:e.color,map:i,transparent:!0,side:e.side,depthWrite:!1,depthTest:e.depthTest}),n=new THREE.PlaneGeometry(400,400);for(n.applyMatrix((new THREE.Matrix4).makeRotationX(THREE.Math.degToRad(e.angle))),p=0;p<e.intensity;p++){var o=n.faces[0].normal,a=new THREE.Mesh(n,r);a.smokeParticlesPosOrg=e.pos.clone(),a.smokeParticlesPos=e.posMove.clone(),a.position.set(Math.random()*e.width*(1-Math.abs(o.x)),Math.random()*e.height*(1-Math.abs(o.y)),Math.random()*e.height*(1-Math.abs(o.z))),a.position.set(a.position.x+e.pos.x,a.position.y+e.pos.y,a.position.z+e.pos.z),a.rotateOnAxis(o,360*Math.random()),a.orgPosion=a.position.clone(),t.add(a),this.smokeParticles.push(a)}return a},VB.Effect.prototype.doSmokeAnimation=function(t,e){for(var i=this.Clock.getDelta(),r=this.smokeParticles.length;r--;){var n=new THREE.Vector3;n.subVectors(this.smokeParticles[r].smokeParticlesPos,this.smokeParticles[r].smokeParticlesPosOrg).normalize(),this.smokeParticles[r].rotateOnAxis(this.smokeParticles[r].geometry.faces[0].normal,.4*i*(r>this.smokeParticles.length/2?-1:1)),n.multiplyScalar(100*i),this.smokeParticles[r].position.add(n),this.smokeParticles[r].position.distanceTo(this.smokeParticles[r].orgPosion)>this.smokeParticles[r].smokeParticlesPos.distanceTo(this.smokeParticles[r].smokeParticlesPosOrg)&&this.smokeParticles[r].position.set(this.smokeParticles[r].orgPosion.x,this.smokeParticles[r].orgPosion.y,this.smokeParticles[r].orgPosion.z)}},VB.Effect.prototype.initWaterFall=function(t,e){var i,r,n;this.params=e;var o=this.params.pos.distanceTo(this.params.target),a=this.params.target.clone().sub(this.params.pos);for(a=a.normalize(),n=new THREE.BufferGeometry,i=applyTex(e.imagepath,1,1),pMaterial=new THREE.PointsMaterial({color:16777215,map:i,size:e.size,sizeAttenuation:!0,fog:!0,depthWrite:!1,side:THREE.DoubleSide,transparent:!0}),r=0;r<e.particleCount;r++){this.particles[r]={position:new THREE.Vector3(Math.random()*this.params.range+e.pos.x,Math.random()*this.params.range+e.pos.y,Math.random()*this.params.range+e.pos.z),drop:!0,dropangle:this.params.dropangle.clone()};var s=a.clone();this.particles[r].position.add(s.multiplyScalar(Math.random()*o)),this.particles[r].dropangle.applyAxisAngle(a,6.28*Math.random()),this.wf_time[r]=new THREE.Clock,this.wf_time[r].start()}for(var h=new Float32Array(3*this.particles.length),l=0,c=this.particles.length;l<c;l++)this.particles[l].position.toArray(h,3*l);n.addAttribute("position",new THREE.Float32BufferAttribute(h,3)),n.computeBoundingSphere(),this.particleSys=new THREE.PointCloud(n,pMaterial),this.particleSys.sortParticles=!0,this.particleSys.visible=!1,t.add(this.particleSys),this.water_map.set(e.name,this.particleSys)},VB.Effect.prototype.WaterFallingMgr=function(){var t=this.particles.length,e=this.params.target.clone().sub(this.params.pos);for(e=e.normalize();t--;){var i=this.particles[t],r=this.wf_time[t].getElapsedTime()%20,n=i.position.distanceTo(this.params.target);if(i.drop)if(n<this.params.range+this.params.range)0==this.particleSys.visible&&1==t&&(this.particleSys.visible=!0),this.params.radius>0?i.drop=!1:(this.wf_time[t]=new THREE.Clock,this.wf_time[t].start(),i.position.set(Math.random()*this.params.range+this.params.pos.x,Math.random()*this.params.range+this.params.pos.y,Math.random()*this.params.range+this.params.pos.z),this.particleSys.geometry.attributes.position.setXYZ(t,i.position.x,i.position.y,i.position.z));else{var o,a=e.clone();(o=this.params.applygrvity?.5*this.params.speed*r:.5*this.params.speed)>n/2&&(o=n/2),a.multiplyScalar(o),i.position.add(a),this.particleSys.geometry.attributes.position.setXYZ(t,i.position.x,i.position.y,i.position.z)}else if((n=i.position.distanceTo(this.params.target))<this.params.radius)(a=i.dropangle.clone()).multiplyScalar(this.params.speed/4),i.position.add(a),this.particleSys.geometry.attributes.position.setXYZ(t,i.position.x,i.position.y,i.position.z);else this.wf_time[t]=new THREE.Clock,this.wf_time[t].start(),i.position.set(Math.random()*this.params.range+this.params.pos.x,Math.random()*this.params.range+this.params.pos.y,Math.random()*this.params.range+this.params.pos.z),this.particleSys.geometry.attributes.position.setXYZ(t,i.position.x,i.position.y,i.position.z),i.drop=!0;this.particles[t]=i}this.particleSys.geometry.attributes.position.needsUpdate=!0},VB.Effect.prototype.initWater=function(i){(t=new THREE.PlaneGeometry(1e4,1e4,1,1)).applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),t.computeFaceNormals(),t.computeVertexNormals();var r=THREE.ImageUtils.loadTexture("imagepath");r.wrapS=r.wrapT=THREE.RepeatWrapping,r.repeat.set(100,100),e=new THREE.MeshBasicMaterial({color:17663,map:r}),mesh=new THREE.Mesh(t,e),mesh.position.y=-1,scene.add(mesh);var n=new THREE.Mesh(new THREE.CubeGeometry(5,5,5),new THREE.MeshLambertMaterial({color:16711680}));scene.add(n),n.position.set(0,1,-50)}}};VB.Effect.prototype.initFire=function(t,e,i,r,n){var o=new THREE.TextureLoader;o.crossOrigin="";null==this.fireTex&&(this.fireTex=o.load(i,function(i){var o=new THREE.Fire(i),a=new THREE.Mesh(o.geometry,this.wireframeMat.clone());o.add(a),a.visible=!1,o.position.copy(r),o.scale.set(n,n,n),t.add(o),this.fire_map.set(e,o)}.bind(this)),this.wireframeMat=new THREE.MeshBasicMaterial({color:new THREE.Color(16777215),wireframe:!0}))},VB.Effect.prototype.getFire=function(t){return this.fire_map.get(t)},VB.Effect.prototype.removeFire=function(t,e){t.remove(this.fire_map.get(e)),this.fire_map.delete(e)},VB.Effect.prototype.removeWaterFall=function(t,e){t.remove(this.water_map.get(e)),this.water_map.delete(e)},VB.Editor=function(){Editor.call(this),this.loader=new VB.Loader(this),this.poiManager=null,this.poi3DManager=null,this.DeviceManager=null,this.topologyManager=null,this.LibraryManager=null,this.labelRenderer=null,this.sceneBloom=new THREE.Scene,this.camera.near=10,this.signals.continuousRender=new signals.Signal,this.signals.continuousRenderSrc=new signals.Signal,this.signals.updateBoundingBox=new signals.Signal,this.signals.selectPosition=new signals.Signal,this.signals.libraryClick=new signals.Signal,this.selectMode=VB.Editor.SelectMode.object,this.SELECTMODE=VB.Editor.SelectMode,this.bbox=null,this.orthoscene=null},VB.Editor.prototype=Object.create(Editor.prototype),VB.Editor.prototype.constructor=VB.Editor,VB.Editor.prototype.clear=function(){this.camera.position.set(500,250,500),this.camera.lookAt(new THREE.Vector3);var t=this.scene.children;for(this.signals.sceneGraphChanged.active=!1;t.length>0;)this.removeObject(t[0]);for(var e in this.poiManager&&this.poiManager.clear(),this.poi3DManager&&this.poi3DManager.clear(),this.LibraryManager&&this.LibraryManager.clear(),this.DeviceManager&&this.DeviceManager.clear(),this.topologyManager&&this.topologyManager.clear(),this.geometries)this.geometries[e].dispose();for(var i in this.materials)this.materials[i].dispose();for(var r in this.textures)this.textures[r].dispose();this.geometries={},this.materials={},this.textures={},this.scripts={},this.deselect(),this.signals.sceneGraphChanged.active=!0,this.signals.editorCleared.dispatch(),this.signals.sceneGraphChanged.dispatch()},VB.Editor.prototype.setScene=function(t){for(this.scene.uuid=t.uuid,this.scene.name=t.name,this.scene.userData=t.userData,this.signals.sceneGraphChanged.active=!1;t.children.length>0;)this.addObject(t.children[0]);this.signals.sceneGraphChanged.active=!0,this.signals.sceneGraphChanged.dispatch()},VB.Editor.prototype.getBoundingBox=function(t,e){var i=new THREE.Box3;if(e)i.setFromObject(t);else{var r=function(t,e){if(t&&e(t))for(var i=0,n=t.children.length;i<n;i++)r(t.children[i],e)};r(t,function(t){if(t.visible&&t instanceof THREE.Mesh&&"sky"!=t.name)try{var e=(new THREE.Box3).setFromObject(t);e.min.x==e.min.x&&e.min.y==e.min.y&&e.min.z==e.min.z&&i.union(t.geometry.boundingBox)}catch(t){}return t.visible})}return i},VB.Editor.prototype.autoFitTo=function(t,e,i){var r=(new Box3).setFromObject(t).getBoundingSphere(),n=e.fov*Math.PI/180*.618,o=r.radius/Math.tan(n/2),a=Math.sqrt(Math.pow(o,2)+Math.pow(o,2));e.position.set(a,a,a),i.update(),e.lookAt(r.center),e.updateProjectionMatrix(),this.setViewpoint(viewpoint)},VB.Editor.prototype.fitBoundingBoxToScreen=function(t,e,i,r,n,o,a){var s=new THREE.Quaternion;null!=n&&(s.copy(this.camera.quaternion),this.camera.rotation.set(n.x,n.y,n.z));var h=new THREE.Vector3(0,0,-1);h.applyQuaternion(this.camera.quaternion);var l=new THREE.Vector3(0,1,0);l.applyQuaternion(this.camera.quaternion);var c=torad(this.camera.fov),u=c*(t/e),p=new THREE.Vector3,d=[new THREE.Vector3(i.max.x,i.max.y,i.max.z),new THREE.Vector3(i.max.x,i.max.y,i.min.z),new THREE.Vector3(i.max.x,i.min.y,i.max.z),new THREE.Vector3(i.max.x,i.min.y,i.min.z),new THREE.Vector3(i.min.x,i.max.y,i.max.z),new THREE.Vector3(i.min.x,i.max.y,i.min.z),new THREE.Vector3(i.min.x,i.min.y,i.max.z),new THREE.Vector3(i.min.x,i.min.y,i.min.z)],f=i.getCenter(),m=getRotationTo(h,UNIT_X.clone());l.applyQuaternion(m);var g=getRotationTo(l,UNIT_Y.clone()).clone();g.multiply(m);for(var v,y=Math.tan(c/2),E=FLT_MIN,x=FLT_MAX,_=Math.tan(u/2.15),w=FLT_MIN,b=FLT_MAX,S=(new THREE.Vector3,0);S<d.length;++S){var T=d[S];T.sub(f),T.applyQuaternion(g),(v=T.y-y*T.x)>E&&(E=v),(v=T.y+y*T.x)<x&&(x=v),(v=T.z-_*T.x)>w&&(w=v),(v=T.z+_*T.x)<b&&(b=v)}if(!(y<.001||_<.001)){var M=(x-E)/(2*y),R=(x+E)/2,A=(b-w)/(2*_),C=(b+w)/2;M<A?(p.x=M/1,p.y=R,p.z=C,!0):(p.x=A/1,p.z=C,p.y=R,!1),g.inverse(),p.applyQuaternion(g),p.add(f);var P=i.getCenter(),D=h.clone();D.negate(),D.normalize();var L=new THREE.Plane(D,-P.length()-1e3),O=new THREE.Ray(p.clone(),h).intersectPlane(L);O||(P.y=0,O=P),a||(a=0),p.x+=h.x*a,p.y+=h.y*a,p.z+=h.z*a;var H=this;if(null!=n&&this.camera.setRotationFromQuaternion(s),void 0!==r&&r){this.signals.continuousRender.dispatch(!0);new TWEEN.Tween(H.camera.position).to({x:p.x,y:p.y,z:p.z},1500).easing(TWEEN.Easing.Circular.Out).onUpdate(function(){}).onComplete(function(){H.signals.continuousRenderSrc.dispatch()}).start();if(n)new TWEEN.Tween(H.camera.rotation).to({x:n.x,y:n.y,z:n.z},1500).easing(TWEEN.Easing.Linear.None).onUpdate(function(){}).onComplete(function(){o&&o()}).start()}else this.camera.position.copy(p),null!=n&&this.setViewpoint(n)}},VB.Editor.prototype.flyTargetViewport=function(t,e,i){var r=this;new TWEEN.Tween(r.camera.position).to({x:t.x,y:t.y,z:t.z},1500).easing(TWEEN.Easing.Circular.Out).onUpdate(function(){}).onComplete(function(){r.signals.continuousRenderSrc.dispatch()}).start(),new TWEEN.Tween(r.camera.rotation).to({x:e.x,y:e.y,z:e.z},1500).easing(TWEEN.Easing.Linear.None).onUpdate(function(){}).onComplete(function(){i&&i()}).start()},VB.Editor.prototype.setViewpoint=function(t){this.camera.rotation.x=t.x,this.camera.rotation.y=t.y,this.camera.rotation.z=t.z,this.camera.rotationAutoUpdate=!1},VB.Editor.prototype.createFire=function(t,e,i,r){null==this.FireEffect&&(this.FireClock=new THREE.Clock,this.FireEffect=new VB.Effect),this.FireEffect.initFire(this.scene,t,e,i,r)},VB.Editor.prototype.createSmoke=function(t){return null==this.SmokeEffect&&(this.SmokeEffect=new VB.Effect),this.SmokeEffect.initSmoke(this.scene,t)},VB.Editor.prototype.createWaterFall=function(t){return null==this.WaterFallEffect&&(this.WaterFallEffect=new VB.Effect),this.WaterFallEffect.initWaterFall(this.scene,t)},VB.Editor.prototype.removeWaterFall=function(t){null!=this.WaterFallEffect&&this.WaterFallEffect.removeWaterFall(this.scene,t)},VB.Editor.prototype.removeFire=function(t){null!=this.FireEffect&&this.FireEffect.removeFire(this.scene,t)},VB.Editor.prototype.createDeviceManager=function(t,e,i){if(null==this.DeviceManager){this.DeviceManager=new VB.DeviceManager(t,e,i),this.signals.layerChanged=new signals.Signal,this.signals.layerAdded=new signals.Signal,this.signals.objectRemoved.add(this.DeviceManager.removeLayer.bind(this.DeviceManager)),this.signals.windowResize.add(this.DeviceManager.onResize.bind(this.DeviceManager));new THREE.Raycaster}},VB.Editor.prototype.createLibraryManager=function(t,e,i,r){null==this.LibraryManager&&(this.LibraryManager=new VB.LibraryManager(t,e,i,r))},VB.Editor.prototype.createPoi3DManager=function(t,e,i,r){null==this.poi3DManager&&(this.poi3DManager=new VB.Poi3DManager(t,e,i,r))},VB.Editor.prototype.createPoiManager=function(t,e,i,r){if(null==this.poiManager){this.poiManager=new VB.PoiManager(t,e,i,r),this.signals.layerChanged=new signals.Signal,this.signals.layerAdded=new signals.Signal,this.signals.objectRemoved.add(this.poiManager.removeLayer.bind(this.poiManager)),this.signals.windowResize.add(this.poiManager.onResize.bind(this.poiManager));new THREE.Raycaster}},VB.Editor.prototype.addLayer=function(t){if(this.poiManager){var e=this.poiManager.createLayer(t);return this.signals.sceneGraphChanged.dispatch(),e}},VB.Editor.prototype.selectPoiById=function(t){this.select(this.poiManager.poiScene.getObjectById(t))},VB.Editor.prototype.addPoi=function(t){if(this.poiManager){var e=this.poiManager.addPoi(t);return this.signals.sceneGraphChanged.dispatch(),e}},VB.Editor.prototype.addPoi3D=function(t){if(this.poi3DManager){var e=this.poi3DManager.addPoi(t);return this.signals.sceneGraphChanged.dispatch(),e}},VB.Editor.prototype.addPoi2D=function(t){if(this.labelRenderer&&this.poiManager){var e=this.poiManager.addPoi(t);t.element.id=t.id;var i=new THREE.CSS2DObject(t.element);return i.rotateY(t.rotate),i.userData.id=t.id,e.point.add(i),e.point.visible=!1,this.signals.sceneGraphChanged.dispatch(),e}},VB.Editor.prototype.removePoi2D=function(t){this.labelRenderer&&this.poiManager.removePoiByProperty("uuid",t.uuid)},VB.Editor.prototype.addDevice=function(t){if(this.DeviceManager){var e=this.DeviceManager.addDevice(t);return this.signals.sceneGraphChanged.dispatch(),e}},VB.Editor.prototype.createTopologyManager=function(t,e,i,r){null==this.topologyManager&&(this.topologyManager=new VB.TopologyManager(this,t,r),this.signals.windowResize.add(this.topologyManager.onResize.bind(this.topologyManager)))},VB.Editor.prototype.getParentByProperty=function(t,e,i,r){var n,o=function(t,e){t&&(e(t),r&&o(t.parent,e))};return o(t.parent,function(t){t&&null!=t[e]&&t[e]===i&&(n=t)}),n},VB.Editor.prototype.getParentByUserData=function(t,e,i,r){var n,o=function(t,e){t&&(e(t),r&&o(t.parent,e))};return o(t.parent,function(t){t&&t.userData&&null!=t.userData[e]&&t.userData[e]===i&&(n=t)}),n},VB.Editor.prototype.getChildByProperty=function(t,e,i,r){for(var n,o=function(t){t&&null!=t[e]&&t[e]===i&&(n=t)},a=function(t,e){if(t&&(e(t),r))for(var i=0,n=t.children.length;i<n;i++)a(t.children[i],e)},s=0,h=t.children.length;s<h;s++)a(t.children[s],o);return n},VB.Editor.prototype.getChildByUserData=function(t,e,i,r){for(var n,o=function(t){t&&t.userData&&null!=t.userData[e]&&t.userData[e]===i&&(n=t)},a=function(t,e){if(t&&(e(t),r))for(var i=0,n=t.children.length;i<n;i++)a(t.children[i],e)},s=0,h=t.children.length;s<h;s++)a(t.children[s],o);return n},VB.Editor.prototype.importModel=function(t,e){this.signals.sceneGraphChanged.active=!1,this.addObject(t),e!==this.scene&&this.moveObject(t,e),this.signals.sceneGraphChanged.active=!0,this.signals.sceneGraphChanged.dispatch()},VB.Editor.prototype.selectPosition=function(t){this.signals.selectPosition.dispatch(t)},VB.Editor.prototype.selectLibrary=function(t){this.signals.libraryClick.dispatch(t)},VB.Editor.prototype.addMaterial=function(t){var e=t.uuid;this.materials[e]=t},VB.Editor.prototype.removeMaterial=function(t){var e=this.materials[t];e&&(delete this.materials[t],e.dispose())},VB.Editor.prototype.addTexture=function(t){var e=t.sourceFile;this.texture[e]=t},VB.Editor.prototype.removeTexture=function(t){var e=this.textures[t];e&&(delete this.textures[t],e.dispose())},VB.Editor.prototype.removeGeometry=function(t){var e=this.geometries[t];e&&(delete this.geometries[t],e.dispose())},VB.Editor.prototype.select=function(t){if(this.selected!==t){null!==t&&t.uuid,this.selected=t,this.signals.objectSelected.dispatch(t)}},VB.Editor.prototype.updateSceneBoundingBox=function(t){this.bbox=this.getBoundingBox(this.scene,t),this.signals.updateBoundingBox.dispatch(this.bbox.getCenter())},VB.Editor.prototype.update=function(){},VB.Editor.SelectMode={object:1,position:2,deviceobject:4},VB.Editor.prototype.createLabelRenderer=function(t){this.labelRenderer=new THREE.CSS2DRenderer;var e=document.getElementById(t);this.labelRenderer.setSize(e.offsetWidth,e.offsetHeight),this.labelRenderer.domElement.style.position="absolute",this.labelRenderer.domElement.style.top=0,this.labelRenderer.domElement.style.pointerEvents="none",e.appendChild(this.labelRenderer.domElement),this.poiManager.labelRenderer=this.labelRenderer},VB.Editor.prototype.saveCameraState=function(){this.state=[],this.state.position=this.camera.position.clone(),this.state.rotation=new THREE.Vector3(this.camera.rotation._x,this.camera.rotation._y,this.camera.rotation._z)},VB.Editor.prototype.getSavedCameraState=function(){return this.state},VB.EditorControls=function(t,e,i){e=void 0!==e?e:document,this.rotateTiltRange={max:Math.PI,min:Math.PI/2},this.enabled=!0,this.center=new THREE.Vector3,this.centerzoom=!0,this.wheelscale=1,this.rotateRad=new THREE.Vector3,this.handmode=!1,this.getIntersectPoint;var r=!1,n=new THREE.Vector3,o=this,a=new THREE.Vector3,s=VB.EditorControls.STATE.NONE;this.navigationMode={lbuttonDown:VB.EditorControls.STATE.ROTATE,mbuttonDown:VB.EditorControls.STATE.ZOOM,rbuttonDown:VB.EditorControls.STATE.PAN},this.oldNavigantionMode={lbuttonDown:VB.EditorControls.STATE.ROTATE,mbuttonDown:VB.EditorControls.STATE.ZOOM,rbuttonDown:VB.EditorControls.STATE.PAN},this.saveNavigationMode=function(){o.oldNavigantionMode.lbuttonDown=o.navigationMode.lbuttonDown,o.oldNavigantionMode.mbuttonDown=o.navigationMode.mbuttonDown,o.oldNavigantionMode.rbuttonDown=o.navigationMode.rbuttonDown},this.restoreNavigationMode=function(){o.navigationMode.lbuttonDown=o.oldNavigantionMode.lbuttonDown,o.navigationMode.mbuttonDown=o.oldNavigantionMode.mbuttonDown,o.navigationMode.rbuttonDown=o.oldNavigantionMode.rbuttonDown};var h=new THREE.Matrix3,l=new THREE.Vector2,c=new THREE.Vector2,u={type:"change"};function p(t){if(!1!==o.enabled){t.preventDefault(),l.set(t.clientX,t.clientY);var e=l.x-c.x,i=l.y-c.y;s===VB.EditorControls.STATE.ROTATE?o.rotate(new THREE.Vector3(-e*o.rotationSpeed/1e4,-i*o.rotationSpeed/1e4,0),!1):s===VB.EditorControls.STATE.ZOOM?o.zoom(new THREE.Vector3(0,0,i)):s===VB.EditorControls.STATE.PAN?o.pan(new THREE.Vector3(-e,i,0)):s==VB.EditorControls.STATE.PARALLELPAN&&o.parallelpan(new THREE.Vector3(-e,i,0)),c.set(t.clientX,t.clientY)}}function d(t){e.removeEventListener("mousemove",p,!1),e.removeEventListener("mouseup",d,!1),e.removeEventListener("dblclick",d,!1),s=VB.EditorControls.STATE.NONE}function f(t){if(t.preventDefault(),!1!==o.enabled){var e=0;t.wheelDelta?e=-t.wheelDelta*o.wheelscale:t.detail&&(e=10*t.detail*o.wheelscale),o.centerzoom?o.zoom_on_point(new THREE.Vector3(0,0,e)):o.zoom(new THREE.Vector3(0,0,e))}}this.focus=function(e,i){var r=new THREE.Vector3;e.matrixWorld.decompose(o.center,new THREE.Quaternion,r);var n=(new THREE.Vector3).copy(o.center);if(i&&e.geometry){r=(r.x+r.y+r.z)/3,n.add(e.geometry.boundingSphere.center.clone().multiplyScalar(r));var a=e.geometry.boundingSphere.radius*r,s=t.position.clone().sub(n).normalize().multiplyScalar(2*a);t.position.copy(n).add(s)}t.lookAt(n),o.dispatchEvent(u)},this.panLeft=function(e){var i=new THREE.Vector3,r=t.matrix.elements;i.set(r[0],r[1],r[2]),i.multiplyScalar(e),t.position.add(i)},this.panUp=function(e){var i=new THREE.Vector3,r=t.matrix.elements;i.set(r[4],r[5],r[6]),i.multiplyScalar(e),t.position.add(i)},this.pan=function(i){if(void 0!==t.fov){var r=t.position.clone().sub(n).length();r*=Math.tan(t.fov/2*Math.PI/180),o.panLeft(2*i.x*r/e.offsetHeight),o.panUp(2*i.y*r/e.offsetHeight)}else void 0!==t.top&&(o.panLeft(i.x*(t.right-t.left)/e.offsetWidth),o.panUp(i.y*(t.top-t.bottom)/e.offsetHeight))},this.parallelpan=function(e){var i=t.position.distanceTo(o.center);i<5e3&&(i=5e3),e.multiplyScalar(.002*i),e.applyMatrix3(h.getNormalMatrix(t.matrix)),e.y=0,t.position.add(e),o.dispatchEvent(u)},this.zoom_on_point=function(i){var r=i.z,n=e.getBoundingClientRect(),a=(event.clientX-n.left)/n.width*2-1,s=-(event.clientY-n.top)/n.height*2+1,h=new THREE.Vector3(a,s,.1);h.unproject(t),h.sub(t.position);var l=o.center.distanceTo(t.position);c.set(event.clientX,event.clientY);var p=o.getIntersectPoint(c);if(p)l=p.distanceTo(t.position);l<10&&(l=10);var d=l*o.wheelscale/10*(r<0?1:-1);t.position.addVectors(t.position,h.setLength(d)),o.dispatchEvent(u)},this.zoom=function(e){var r=t.position.distanceTo(o.center);if(r<5e3&&(r=5e3),e.multiplyScalar(.001*r),!(e.length()>r)){if(e.applyMatrix3(h.getNormalMatrix(t.matrix)),this.rotateTiltRange.min>=Math.PI/2){var n=(new THREE.Vector3).copy(t.position).add(e),a=(i.bbox.containsPoint(t.position),i.bbox.containsPoint(n),i.bbox.getCenter()),s=[];(new THREE.Vector3).copy(a).x=i.bbox.min.x,(new THREE.Vector3).copy(a).x=i.bbox.max.x,(new THREE.Vector3).copy(a).z=i.bbox.max.z,(new THREE.Vector3).copy(a).z=i.bbox.min.z,(new THREE.Vector3).copy(a).y=i.bbox.min.y,s.push(new THREE.Plane(new THREE.Vector3(-1,0,0),-Math.abs(i.bbox.min.x))),s.push(new THREE.Plane(new THREE.Vector3(1,0,0),-Math.abs(i.bbox.max.x))),s.push(new THREE.Plane(new THREE.Vector3(0,0,1),-Math.abs(i.bbox.max.z))),s.push(new THREE.Plane(new THREE.Vector3(0,0,-1),-Math.abs(i.bbox.min.z))),s.push(new THREE.Plane(new THREE.Vector3(0,-1,0),-Math.abs(i.bbox.min.y)));var l=new THREE.Vector3(0,0,-1);l.applyMatrix3(h.getNormalMatrix(t.matrix)),l.normalize();var c=(new THREE.Vector3).copy(e);c.normalize();for(var p=c.dot(l),d=new THREE.Ray(t.position,c),f=0;f<s.length;++f){var m=d.distanceToPlane(s[f]);if(m&&m-100-t.near<e.length()&&Math.abs(p-1)<.001&&c.dot(s[f].normal)>0)return}}t.position.add(e),o.dispatchEvent(u)}},this.rotate=function(e,i){if(i&&(r=!0,n.copy(o.center)),o.getIntersectPoint&&r){!1;var s=new THREE.Vector3(0,0,-1);s.applyQuaternion(t.quaternion);var h=s.angleTo(new THREE.Vector3(0,1,0));o.rotateTiltRange.max<h-e.y?e.y=0:h-e.y<o.rotateTiltRange.min&&(e.y=0),a.copy(t.position).sub(n);var l=new THREE.Matrix4;l.makeRotationAxis(new THREE.Vector3(0,1,0),e.x);var c=new THREE.Vector3(1,0,0).applyEuler(t.rotation),p=new THREE.Matrix4;p.makeRotationAxis(c,e.y),l.multiply(p),a.applyMatrix4(l),t.position.copy(n).add(a),s.applyMatrix4(l),t.lookAt(s.add(t.position))}o.dispatchEvent(u)},this.rotate2=function(e,i){if(i&&(r=!0,n.copy(o.center)),o.getIntersectPoint&&r){a.copy(t.position).sub(o.center);var s=Math.atan2(a.x,a.z),h=Math.atan2(Math.sqrt(a.x*a.x+a.z*a.z),a.y);s+=e;h=Math.max(1e-6,Math.min(Math.PI-1e-6,h));var l=a.length();a.x=l*Math.sin(h)*Math.sin(s),a.y=l*Math.cos(h),a.z=l*Math.sin(h)*Math.cos(s),t.position.copy(o.center).add(a),t.lookAt(o.center)}o.dispatchEvent(u)},this.rotationSpeed=30;new THREE.Vector3;var m=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],g=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],v=null;"ontouchstart"in window?(e.addEventListener("touchstart",function(t){if(!1!==o.enabled){switch(t.touches.length){case 1:m[0].set(t.touches[0].pageX,t.touches[0].pageY,0),m[1].set(t.touches[0].pageX,t.touches[0].pageY,0);break;case 2:m[0].set(t.touches[0].pageX,t.touches[0].pageY,0),m[1].set(t.touches[1].pageX,t.touches[1].pageY,0),v=m[0].distanceTo(m[1]);break;case 3:m[0].set(t.touches[0].pageX,t.touches[0].pageY,0),m[1].set(t.touches[1].pageX,t.touches[1].pageY,0)}var e;g[0].copy(m[0]),g[1].copy(m[1]),!o.getIntersectPoint||1!==t.touches.length&&3!==t.touches.length||((e=o.getIntersectPoint(new THREE.Vector2(t.touches[0].pageX,t.touches[0].pageY)))?(r=!0,n.copy(e)):(r=!0,n.copy(o.center))),o.getIntersectPoint&&2===t.touches.length&&((e=o.getIntersectPoint(new THREE.Vector2((t.touches[0].pageX+t.touches[1].pageX)/2,(t.touches[0].pageY+t.touches[1].pageY)/2)))?(r=!0,n.copy(e)):(r=!0,n.copy(o.center)))}},!1),e.addEventListener("touchmove",function(t){if(t.preventDefault(),t.stopPropagation(),!1!==o.enabled){var e=function(t,e){var i=e[0];for(var r in e)i.distanceTo(t)>e[r].distanceTo(t)&&(i=e[r]);return i};if(o.navigationMode.lbuttonDown==VB.EditorControls.STATE.ROTATE)switch(t.touches.length){case 1:m[0].set(t.touches[0].pageX,t.touches[0].pageY,0),m[1].set(t.touches[0].pageX,t.touches[0].pageY,0),o.rotate(m[0].sub(e(m[0],g)).multiplyScalar(-.005),!1);break;case 2:m[0].set(t.touches[0].pageX,t.touches[0].pageY,0),m[1].set(t.touches[1].pageX,t.touches[1].pageY,0),distance=m[0].distanceTo(m[1]),o.zoom(new THREE.Vector3(0,0,v-distance)),v=distance;var i=m[0].clone().sub(e(m[0],g)),r=m[1].clone().sub(e(m[1],g));i.x=-i.x,r.x=-r.x,o.pan(i.add(r).multiplyScalar(.5))}else switch(t.touches.length){case 1:m[0].set(t.touches[0].pageX,t.touches[0].pageY,0),(i=m[0].clone().sub(e(m[0],g))).x=-i.x,o.parallelpan(i);break;case 2:m[0].set(t.touches[0].pageX,t.touches[0].pageY,0),m[1].set(t.touches[1].pageX,t.touches[1].pageY,0);var n=m[1].sub(m[0]).angleTo(g[1].sub(g[0]));m[1].sub(m[0]).cross(g[1].sub(g[0])).z>0&&(n*=-1),o.rotate2(n,!1),m[0].set(t.touches[0].pageX,t.touches[0].pageY,0),m[1].set(t.touches[1].pageX,t.touches[1].pageY,0),distance=m[0].distanceTo(m[1]),o.zoom(new THREE.Vector3(0,0,2*(v-distance))),v=distance;break;case 3:m[0].set(t.touches[0].pageX,t.touches[0].pageY,0),m[1].set(t.touches[0].pageX,t.touches[0].pageY,0),o.rotate(m[0].sub(e(m[0],g)).multiplyScalar(-.005),!1)}g[0].copy(m[0]),g[1].copy(m[1])}},!1),e.addEventListener("mousewheel",f,!1)):(e.addEventListener("contextmenu",function(t){t.preventDefault()},!1),e.addEventListener("mousedown",function(t){if(!1!==o.enabled){if(t.preventDefault(),0===t.button?s=o.navigationMode.lbuttonDown:1===t.button?s=o.navigationMode.mbuttonDown:2===t.button&&(s=o.navigationMode.rbuttonDown),c.set(t.clientX,t.clientY),o.getIntersectPoint&&(s===VB.EditorControls.STATE.ROTATE||s===VB.EditorControls.STATE.PAN)){var i=o.getIntersectPoint(c);i?(r=!0,n.copy(i)):(r=!0,n.copy(o.center))}e.addEventListener("mousemove",p,!1),e.addEventListener("mouseup",d,!1),e.addEventListener("dblclick",d,!1)}},!1),e.addEventListener("mousewheel",f,!1),e.addEventListener("DOMMouseScroll",f,!1)),this.update=function(){this.rotateRad.length()&&(r=!0,n.copy(n.copy(o.center)),this.rotate(this.rotateRad,!1))}},VB.EditorControls.STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,PARALLELPAN:3},VB.EditorControls.prototype=Object.create(THREE.EventDispatcher.prototype),VB.EditorControls.prototype.constructor=VB.EditorControls,VB.Loader=function(t){t.signals;this.loadFile=function(i){var r=i.name;switch(r.split(".").pop().toLowerCase()){case"awd":(n=new FileReader).addEventListener("load",function(e){var i=(new THREE.AWDLoader).parse(e.target.result);t.setScene(i)},!1),n.readAsArrayBuffer(i);break;case"babylon":(n=new FileReader).addEventListener("load",function(e){var i=e.target.result,r=JSON.parse(i),n=(new THREE.BabylonLoader).parse(r);t.setScene(n)},!1),n.readAsText(i);break;case"babylonmeshdata":(n=new FileReader).addEventListener("load",function(e){var i=e.target.result,n=JSON.parse(i),o=(new THREE.BabylonLoader).parseGeometry(n),a=new THREE.MeshPhongMaterial,s=new THREE.Mesh(o,a);s.name=r,t.addObject(s),t.select(s)},!1),n.readAsText(i);break;case"ctm":(n=new FileReader).addEventListener("load",function(e){var n=new Uint8Array(e.target.result),o=new CTM.Stream(n);o.offset=0,(new THREE.CTMLoader).createModel(new CTM.File(o),function(e){e.sourceType="ctm",e.sourceFile=i.name;var n=new THREE.MeshPhongMaterial,o=new THREE.Mesh(e,n);o.name=r,t.addObject(o),t.select(o)})},!1),n.readAsArrayBuffer(i);break;case"dae":(n=new FileReader).addEventListener("load",function(e){var i=e.target.result,n=(new DOMParser).parseFromString(i,"text/xml");(new THREE.ColladaLoader).parse(n,function(e){e.scene.name=r,t.addObject(e.scene),t.select(e.scene)})},!1),n.readAsText(i);break;case"js":case"json":case"3geo":case"3mat":case"3obj":case"3scn":(n=new FileReader).addEventListener("load",function(t){var n,o=t.target.result;if(-1!==o.indexOf("postMessage")){var a=new Blob([o],{type:"text/javascript"}),s=URL.createObjectURL(a),h=new Worker(s);return h.onmessage=function(t){t.data.metadata={version:2},e(t.data,i,r)},void h.postMessage(Date.now())}try{n=JSON.parse(o)}catch(t){return}e(n,i,r)},!1),n.readAsText(i);break;case"obj":(n=new FileReader).addEventListener("load",function(e){var i=e.target.result,n=(new THREE.OBJLoader).parse(i);n.name=r,t.addObject(n),t.select(n)},!1),n.readAsText(i);break;case"ply":(n=new FileReader).addEventListener("load",function(e){var n=e.target.result,o=(new THREE.PLYLoader).parse(n);o.sourceType="ply",o.sourceFile=i.name;var a=new THREE.MeshPhongMaterial,s=new THREE.Mesh(o,a);s.name=r,t.addObject(s),t.select(s)},!1),n.readAsText(i);break;case"stl":(n=new FileReader).addEventListener("load",function(e){var n=e.target.result,o=(new THREE.STLLoader).parse(n);o.sourceType="stl",o.sourceFile=i.name;var a=new THREE.MeshPhongMaterial,s=new THREE.Mesh(o,a);s.name=r,t.addObject(s),t.select(s)},!1),void 0!==n.readAsBinaryString?n.readAsBinaryString(i):n.readAsArrayBuffer(i);break;case"vtk":(n=new FileReader).addEventListener("load",function(e){var n=e.target.result,o=(new THREE.VTKLoader).parse(n);o.sourceType="vtk",o.sourceFile=i.name;var a=new THREE.MeshPhongMaterial,s=new THREE.Mesh(o,a);s.name=r,t.addObject(s),t.select(s)},!1),n.readAsText(i);break;case"wrl":var n;(n=new FileReader).addEventListener("load",function(e){var i=e.target.result,r=(new THREE.VRMLLoader).parse(i);t.setScene(r)},!1),n.readAsText(i)}};var e=function(e,i,r){if(void 0===e.metadata&&(e.metadata={type:"Geometry"}),void 0===e.metadata.type&&(e.metadata.type="Geometry"),void 0===e.metadata.version&&(e.metadata.version=e.metadata.formatVersion),"BufferGeometry"===e.metadata.type){var n=(new THREE.BufferGeometryLoader).parse(e),o=new THREE.Mesh(n);t.addObject(o),t.select(o)}else if("geometry"===e.metadata.type.toLowerCase()){var a,s=(n=(new THREE.JSONLoader).parse(e)).geometry;a=void 0!==n.materials?n.materials.length>1?new THREE.MeshFaceMaterial(n.materials):n.materials[0]:new THREE.MeshPhongMaterial,s.sourceType="ascii",s.sourceFile=i.name,(o=s.animation&&s.animation.hierarchy?new THREE.SkinnedMesh(s,a):new THREE.Mesh(s,a)).name=r,t.addObject(o),t.select(o)}else if("object"===e.metadata.type.toLowerCase()){(n=(new THREE.ObjectLoader).parse(e))instanceof THREE.Scene?t.setScene(n):(t.addObject(n),t.select(n))}else if("scene"===e.metadata.type.toLowerCase()){(new THREE.SceneLoader).parse(e,function(e){t.setScene(e.scene)},"")}}},VB.BoxHelper=function(t){THREE.BoxHelper.call(this,t)},VB.BoxHelper.prototype=Object.create(THREE.BoxHelper.prototype),VB.BoxHelper.prototype.constructor=VB.BoxHelper,VB.BoxHelper.prototype.update=function(t){var e,i,r;if(t instanceof THREE.Object3D){var n=(new THREE.Box3).setFromObject(t);i=n.min,r=n.max}else null===(e=t.geometry).boundingBox&&e.computeBoundingBox(),i=e.boundingBox.min,r=e.boundingBox.max;var o=this.geometry.attributes.position.array;o[0]=r.x,o[1]=r.y,o[2]=r.z,o[3]=i.x,o[4]=r.y,o[5]=r.z,o[6]=i.x,o[7]=r.y,o[8]=r.z,o[9]=i.x,o[10]=i.y,o[11]=r.z,o[12]=i.x,o[13]=i.y,o[14]=r.z,o[15]=r.x,o[16]=i.y,o[17]=r.z,o[18]=r.x,o[19]=i.y,o[20]=r.z,o[21]=r.x,o[22]=r.y,o[23]=r.z,o[24]=r.x,o[25]=r.y,o[26]=i.z,o[27]=i.x,o[28]=r.y,o[29]=i.z,o[30]=i.x,o[31]=r.y,o[32]=i.z,o[33]=i.x,o[34]=i.y,o[35]=i.z,o[36]=i.x,o[37]=i.y,o[38]=i.z,o[39]=r.x,o[40]=i.y,o[41]=i.z,o[42]=r.x,o[43]=i.y,o[44]=i.z,o[45]=r.x,o[46]=r.y,o[47]=i.z,o[48]=r.x,o[49]=r.y,o[50]=r.z,o[51]=r.x,o[52]=r.y,o[53]=i.z,o[54]=i.x,o[55]=r.y,o[56]=r.z,o[57]=i.x,o[58]=r.y,o[59]=i.z,o[60]=i.x,o[61]=i.y,o[62]=r.z,o[63]=i.x,o[64]=i.y,o[65]=i.z,o[66]=r.x,o[67]=i.y,o[68]=r.z,o[69]=r.x,o[70]=i.y,o[71]=i.z,this.geometry.attributes.position.needsUpdate=!0,this.geometry.computeBoundingSphere(),this.matrix=t.matrixWorld,this.matrixAutoUpdate=!1},VB.Viewport=function(t,e){var i=0;this.preRender=new SoonMap,this.postRender=new SoonMap,this.renderRequestId=-1,this.enable=!0,this.continuousRender=!1,this.enableFocus=!0,this.enableSelect=!0,this.enablePoiFlash=!1,this.enableBoundedSelection=!1,this.enableBloomEffect=!1,this.mixer=null,e&&(this.continuousRender=!0===e.continuousRender||null==e.continuousRender,this.enableFocus=!0===e.enableFocus,this.enableSelect=!0===e.enableSelect||null==e.enableSelect,this.enableBoundedSelection=!0===e.enableBoundedSelection||null===e.enableBoundedSelection,this.gizmo=!0===e.gizmo||null==e.gizmo,this.gizmohan=!0===e.gizmohan||null===e.gizmohan,this.enableBloomEffect=!0===e.enableBloomEffect||null===e.enableBloomEffect,this.shadow=!0===e.shadow||null===e.shadow,this.captureScreen=!0===e.captureScreen||null===e.captureScreen);var r=this.enableBoundedSelection,n=this.enableBloomEffect;this.renderer=null,this.rendererCSS3D=null,this.transformUserControl=null,this.INTERSECTED=null,this.gizmos=[];var o,a,s,h,l,c,u=this,p=t.signals,d=this.continuousRender;p.continuousRender.add(function(t){d=u.continuousRender,u.continuousRender=t}),p.continuousRenderSrc.add(function(){u.continuousRender=d});var f=new UI.Panel;this.container=f,f.setId("viewport"),f.setPosition("absolute"),f.add(new Viewport.Info(t));var m=t.scene;this.scene=m;var g=t.sceneHelpers,v=[];this.clipPlanes=[];var y=new THREE.GridHelper(500,25);g.add(y);var E=new THREE.Clock,x=t.camera,_=[],w=new THREE.TransformControls(x,f.dom);this.transformControls=w,w.addEventListener("change",function(){if(w.visible){var e=w.object;void 0!==e&&void 0!==t.helpers[e.id]&&t.helpers[e.id].update(),V()}}),w.addEventListener("mouseDown",function(){w.visible&&(I.enabled=!1)}),w.addEventListener("mouseUp",function(){w.visible&&(p.objectChanged.dispatch(w.object),I.enabled=!0)}),g.add(w);var b=new THREE.Raycaster,S=new THREE.Vector2,T=function(t,e){return S.set(2*t.x-1,-2*t.y+1),b.setFromCamera(S,x),e instanceof Array?b.intersectObjects(e):b.intersectObject(e)};this.getIntersectPoint=function(e){var i=new THREE.Vector3;i.fromArray(P(f.dom,e.x,e.y));for(var r=T(i,v),n=0;n<r.length;++n){var o=r[n].object;if(o.visible)if(null==t.getParentByProperty(o,"visible",!1,!0))return r[n].point}},this.Select=function(t,e){if(r&&s){var i=[];i.push(t),s.selectedObjects=i,s.visibleEdgeColor.set(e),s.hiddenEdgeColor.set(e)}},this.drawOutLine=function(t,e){if(r&&s)return s.selectedObjects.push(t),s.visibleEdgeColor.set(e),s.hiddenEdgeColor.set(e),s},this.clearOutLine=function(){r&&s&&(s.selectedObjects=[])},this.UnSelect=function(t){r&&s&&(s.selectedObjects=[])},this.insertBloomObject=function(e){t.sceneBloom.add(e)};var M=new THREE.Vector2,R=new THREE.Vector2,A=new THREE.Vector2,C=new THREE.Vector2;this.onMovePosition=C;var P=function(t,e,i){var r=t.getBoundingClientRect();return[(e-r.left)/r.width,(i-r.top)/r.height]},D=function(e){i++,setTimeout(function(){if(1===i){if(M.distanceTo(R)<.001&&(t.selectMode&VB.Editor.SelectMode.object||t.selectMode&VB.Editor.SelectMode.deviceobject)){var n=T(R,v);if(n.length>0){for(var o,a=0;a<n.length;++a)if((o=n[a].object).visible){if(null==t.getParentByProperty(o,"visible",!1,!0))break;o=void 0}o&&void 0!==o.userData.object&&t.select(o.userData.object);for(a=0;a<n.length;++a)if((o=n[a].object).visible){if(null==t.getParentByProperty(o,"visible",!1,!0))break;o=void 0}if(o){if(t.selectMode&VB.Editor.SelectMode.object&&t.selectPosition(n[a]),t.selectMode&VB.Editor.SelectMode.deviceobject)if(o&&o.parent&&o.parent.device&&"library"==o.parent.userData.type){t.selectLibrary(o.parent);var h=[];h.push(o.parent),s.selectedObjects=h}else t.selectLibrary(),r&&s&&(s.selectedObjects=[])}else t.selectMode&VB.Editor.SelectMode.object&&t.selectPosition(),t.selectMode&VB.Editor.SelectMode.deviceobject&&t.selectLibrary()}else t.selectPosition(),t.select(null);V()}i=0}else i>1&&(M.distanceTo(R)<.1&&H(e),i=0)},200)},L=function(t){t.preventDefault();var e=P(f.dom,t.clientX,t.clientY);R.fromArray(e),0===t.button&&D(t),document.removeEventListener("mouseup",L,!1)},O=function(t){t.preventDefault();var e=t.changedTouches[0],i=P(f.dom,e.clientX,e.clientY);R.fromArray(i),C.fromArray(i),D(t),document.removeEventListener("touchend",O,!1)},H=function(e){e.preventDefault();var i=P(f.dom,e.clientX,e.clientY);A.fromArray(i);for(var r,n=T(A,v),o=0;o<n.length;++o)if(r=n[o].object){if(null==t.getParentByProperty(r,"visible",!1,!0))break;r=void 0}n.length,r&&p.objectFocused.dispatch(r)};"ontouchstart"in window?(f.dom.addEventListener("touchstart",function(t){t.preventDefault();var e=t.changedTouches[0],i=P(f.dom,e.clientX,e.clientY);M.fromArray(i),C.fromArray(i),document.addEventListener("touchend",O,!1)},!0),f.dom.addEventListener("touchmove",function(t){var e=t.changedTouches[0],i=P(f.dom,e.clientX,e.clientY);C.fromArray(i)},!0)):(f.dom.addEventListener("mousedown",function(t){t.preventDefault();var e=P(f.dom,t.clientX,t.clientY);M.fromArray(e),document.addEventListener("mouseup",L,!1)},!0),f.dom.addEventListener("mousemove",function(e){var i=P(f.dom,e.clientX,e.clientY);if(C.fromArray(i),this.enablePoiFlash){var r=t.poiManager.getIntersectObject();r.length>0?this.INTERSECTED!=r[0].object&&(this.INTERSECTED&&this.INTERSECTED.scale.copy(this.INTERSECTED.currentScale),this.INTERSECTED=r[0].object,this.INTERSECTED.currentScale=new THREE.Vector3,this.INTERSECTED.currentScale.copy(this.INTERSECTED.scale),this.INTERSECTED.scale.x=2*this.INTERSECTED.scale.x,this.INTERSECTED.scale.y=2*this.INTERSECTED.scale.y):(this.INTERSECTED&&this.INTERSECTED.scale.copy(this.INTERSECTED.currentScale),this.INTERSECTED=null)}},!0)),document.addEventListener("keydown",function(e){"Escape"==e.key&&(t.select(null),r&&s&&(s.selectedObjects=[]))},!0);var I=new VB.EditorControls(x,f.dom,t);this.controls=I,I.addEventListener("change",function(){w.update(),p.cameraChanged.dispatch(x)}),I.getIntersectPoint=this.getIntersectPoint,p.editorCleared.add(function(){I.center.set(0,0,0),V()}),p.themeChanged.add(function(t){switch(t){case"../lib/THREE/editor/css/light.css":y.setColors(4473924,8947848),B=11184810;break;case"../lib/THREE/editor/css/dark.css":default:y.setColors(12303291,8947848),B=3355443}u.renderer.setClearColor(B),V()}),p.transformModeChanged.add(function(t){w.setMode(t)}),p.snapChanged.add(function(t){w.setSnap(t)}),p.spaceChanged.add(function(t){w.setSpace(t)}),p.rendererChanged.add(function(t,e){f.dom.removeChild(u.renderer.domElement),u.renderer=z(t,e,this.shadow,this.captureScreen),u.renderer.setSize(f.dom.offsetWidth,f.dom.offsetHeight),f.dom.appendChild(u.renderer.domElement),u.rendererCSS3D=N(),f.dom.appendChild(u.rendererCSS3D.domElement),V()}),p.sceneGraphChanged.add(function(){V()}),p.cameraChanged.add(function(){V()}),p.objectSelected.add(function(t){if(!1!==u.enableSelect){for(var e=0;e<_.length;++e)g.remove(_[e]);if(_=[],w.detach(),null!==t&&t instanceof VB.Poi==!1&&t instanceof VB.Layer==!1){if(void 0!==t.geometry&&t instanceof THREE.Sprite==!1)if(t.parent&&t.parent instanceof THREE.Group)for(e=0;e<t.parent.children.length;++e){var i=new THREE.EdgesHelper(t.parent.children[e],16711680);_.push(i,16776960),g.add(i)}else{i=new THREE.EdgesHelper(t,16711680);_.push(i,16711680),g.add(i)}w.attach(t)}V()}}),p.objectFocused.add(function(t){u.enableFocus&&I.focus(t)}),p.geometryChanged.add(function(e){if(t.selected.parent&&t.selected.parent instanceof THREE.Group)for(var i=0;i<t.selected.parent.children.length;++i){var r=new THREE.EdgesHelper(t.selected.parent.children[i],16711680);_.push(r,16711680),g.add(r)}else{r=new THREE.EdgesHelper(t.selected,16711680);_.push(r,16711680),g.add(r)}V()}),p.objectAdded.add(function(t){var e=!1;t.traverse(function(t){t instanceof THREE.Light&&(e=!0),v.push(t)}),!0===e&&k()}),p.objectChanged.add(function(e){w.update(),e instanceof THREE.PerspectiveCamera&&e.updateProjectionMatrix(),void 0!==t.helpers[e.id]&&t.helpers[e.id].update(),V()}),p.objectRemoved.add(function(t){var e=!1;t.traverse(function(t){t instanceof THREE.Light&&(e=!0),v.splice(v.indexOf(t),1)}),!0===e&&k()}),p.helperAdded.add(function(t){v.push(t.getObjectByName("picker"))}),p.helperRemoved.add(function(t){v.splice(v.indexOf(t.getObjectByName("picker")),1)}),p.materialChanged.add(function(t){V()}),p.windowResize.add(function(){x.aspect=f.dom.offsetWidth/f.dom.offsetHeight,x.updateProjectionMatrix(),u.renderer.setSize(f.dom.offsetWidth,f.dom.offsetHeight),u.rendererCSS3D&&u.rendererCSS3D.setSize(f.dom.offsetWidth,f.dom.offsetHeight),t.labelRenderer&&t.labelRenderer.setSize(f.dom.offsetWidth,f.dom.offsetHeight);var e=f.dom.offsetWidth||2,i=f.dom.offsetHeight||2;o&&o.setSize(e,i),l&&l.uniforms.resolution.value.set(1/e,1/i),a&&a.setSize(e,i),c&&c.uniforms.resolution.value.set(1/e,1/i),V()}),p.showGridChanged.add(function(t){y.visible=t,V()}),p.updateBoundingBox.add(function(t){I.center.copy(t)});var B,z=function(e,i,u,p){var d=!1;"WebGLRenderer"===e&&(!1===System.support.webgl?e="CanvasRenderer":d=!1);var f=new THREE[e]({antialias:i,logarithmicDepthBuffer:d,preserveDrawingBuffer:p});if(f.setClearColor(B),f.setPixelRatio(window.devicePixelRatio),f.autoClear=!1,f.autoUpdateScene=!1,f.gammaInput=!0,f.gammaOutput=!0,u&&(f.shadowMapType=THREE.PCFSoftShadowMap,f.shadowMapEnabled=!0),n){a=new THREE.EffectComposer(f);THREE.LinearFilter,THREE.LinearFilter,THREE.RGBFormat;t.sceneBloom.background=new THREE.Color(0);var g=new THREE.RenderPass(t.sceneBloom,x);a.addPass(g);var v={exposure:1,bloomStrength:1.5,bloomThreshold:0,bloomRadius:0};(h=new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth,window.innerHeight),1.5,.4,.85)).renderToScreen=!0,h.threshold=v.bloomThreshold,h.strength=v.bloomStrength,h.radius=v.bloomRadius,a.addPass(h),(c=new THREE.ShaderPass(THREE.FXAAShader)).uniforms.resolution.value.set(1/window.innerWidth,1/window.innerHeight),c.renderToScreen=!0,a.addPass(c)}if(r){o=new THREE.EffectComposer(f);g=new THREE.RenderPass(m,x);if(o.addPass(g),(s=new THREE.OutlinePass(new THREE.Vector2(window.innerWidth,window.innerHeight),m,x)).edgeThickness=3,s.pulsePeriod=2,o.addPass(s),n){var y=new THREE.ShaderPass(THREE.AdditiveBlendShader,"tDiffuse1");y.uniforms.tDiffuse2.value=a.renderTarget2,y.renderToScreen=!0,o.addPass(y)}else(l=new THREE.ShaderPass(THREE.FXAAShader)).uniforms.resolution.value.set(1/window.innerWidth,1/window.innerHeight),l.renderToScreen=!0,o.addPass(l)}return f},N=function(){var t=new THREE.CSS3DRenderer(f.dom,x);return t.setSize(f.dom.offsetWidth,f.dom.offsetHeight),t.domElement.style.position="absolute",t.domElement.style.top=0,t};function k(){t.scene.traverse(function(t){if(t.material&&(t.material.needsUpdate=!0,t.material instanceof THREE.MeshFaceMaterial))for(var e=0;e<t.material.materials.length;e++)t.material.materials[e].needsUpdate=!0})}this.renderer=z(t.config.getKey("project/renderer"),t.config.getKey("project/renderer/antialias"),this.shadow,this.captureScreen),this.rendererCSS3D=N(),this.gizmo&&this.addGizmos(t.camera),f.dom.appendChild(this.renderer.domElement),f.dom.appendChild(this.rendererCSS3D.domElement),this.animate(),this.mainRender=function(){for(var e in u.controls.update(),a||o?(a&&a.render(),o&&o.render(),u.renderer.clearDepth()):u.renderer.render(m,x),u.renderer instanceof THREE.RaytracingRenderer==!1&&u.renderer.render(g,x),t.update&&t.update(),this.gizmos){var i=this.gizmos[e];i.render&&i.render()}if(t.FireEffect&&null!=t.FireEffect.fire_map){var r=t.FireClock.getDelta(),n=t.FireClock.elapsedTime;t.FireEffect.fire_map.forEach(function(t,e,i){t.update(n)})}if(t.SmokeEffect&&t.SmokeEffect.doSmokeAnimation(),t.WaterFallEffect&&t.WaterFallEffect.WaterFallingMgr(),u.mixer){r=E.getDelta();u.mixer.update(r)}u.rendererCSS3D&&u.rendererCSS3D.render(t.poi3DManager.poiScene,t.poi3DManager.camera)};var j=function(){if(u.firstPersonControls&&u.firstPersonControls.enabled){if(u.firstPersonControls.render(),u.rendererCSS3D&&u.rendererCSS3D.render(t.poi3DManager.poiScene,u.firstPersonControls.firstPersonCamera),t.labelRenderer){var e=u.firstPersonControls.person.position.clone();e.add(u.firstPersonControls.firstPersonCamera.position),t.poiManager.update(t.labelRenderer,u.firstPersonControls.firstPersonCamera,e)}}else if(u.enable){for(var i in g.updateMatrixWorld(),m.updateMatrixWorld(),TWEEN&&TWEEN.update(),u.renderer.clear(),!1===u.renderer.autoClear&&u.renderer.clearDepth(),u.preRender.map)u.preRender.map[i]();for(var i in u.mainRender(),u.postRender.map)u.postRender.map[i]();u.transformUserControl&&u.transformUserControl.update()}},V=function(){!1===u.continuousRender&&j()};this.renderByState=V,this.render=j,this.getMousePosition=P,VB.Viewport.prototype.worldToScreen=function(t){var e=f.dom.getBoundingClientRect(),i=new THREE.Vector3;return i.copy(t),i.project(x),i.x=Math.round((i.x+1)*e.width/2+e.x),i.y=Math.round((1-i.y)*e.height/2+e.y),i.z=0,i},VB.Viewport.prototype.setNavigationMode=function(t,e){I.navigationMode[t]=e}},VB.Viewport.prototype.getWidth=function(){return this.renderer.domElement.width},VB.Viewport.prototype.getHeight=function(){return this.renderer.domElement.height},VB.Viewport.prototype.animate=function(){var t=this;if(this.renderRequestId=requestAnimationFrame(function(){t.animate()}),THREE.SEA3D.AnimationHandler.animators.length>0){THREE.SEA3D.AnimationHandler.update(.016);for(var e=0,i=sceneHelpers.children.length;e<i;e++){var r=sceneHelpers.children[e];r instanceof THREE.SkeletonHelper&&r.update()}t.render()}else t.render&&t.continuousRender&&t.render()},VB.Viewport.prototype.stopAnimate=function(){-1!==this.renderRequestId&&window.cancelAnimationFrame(this.renderRequestId),this.renderRequestId=-1},VB.Viewport.prototype.addPreRender=function(t,e){this.preRender.containsKey(t)||this.preRender.put(t,e)},VB.Viewport.prototype.removePreRender=function(t,e){this.preRender.containsKey(t)&&this.preRender.remove(t)},VB.Viewport.prototype.addPostRender=function(t,e){this.postRender.containsKey(t)||this.postRender.put(t,e)},VB.Viewport.prototype.removePostRender=function(t,e){this.postRender.containsKey(t)||this.postRender.put(t,e)},VB.Viewport.prototype.enableTransformControl=function(t){this.transformControls.visible=t},VB.Viewport.prototype.setFog=function(t){const e=t.color,i=t.near,r=t.far;editor.scene.fog=new THREE.Fog(e,i,r)},VB.Viewport.prototype.setFog2=function(t){const e=t.color,i=t.density;editor.scene.fog=new THREE.FogExp2(e,i)},VB.Viewport.prototype.OnClick_Gizmo=function(t,e,i){var r,n=editor.bbox;"+X"==t.name?r=VIEWPOINT.RIGHT:"-X"==t.name?r=VIEWPOINT.LEFT:"+Z"==t.name?r=VIEWPOINT.FRONT:"-Z"==t.name?r=VIEWPOINT.BACK:"+Y"==t.name?r=VIEWPOINT.TOP:"-Y"==t.name&&(r=VIEWPOINT.BOTTOM),editor.fitBoundingBoxToScreen(e,i,n,!0,r)},VB.Viewport.prototype.addGizmos=function(t){var e=new VB.CameraGizmo(this,t,VB.Viewport.prototype.OnClick_Gizmo,this.gizmohan);this.gizmos.push(e),e.mousemove&&(this.container.dom.addEventListener("mousedown",e.mousedown.bind(e),!1),this.container.dom.addEventListener("mousemove",e.mousemove.bind(e),!1),this.container.dom.addEventListener("mouseup",e.mouseup.bind(e),!1))};var filesToEncoding={"utf8.bin":"utf-8","utf16le.bin":"utf-16le","macintosh.bin":"macintosh"},m1=new THREE.Matrix4,m2=new THREE.Matrix4,m3=new THREE.Matrix4;m1.makeRotationY(1*-Math.PI/4),m2.makeRotationX(1*-Math.PI/4);var lt=new THREE.Euler;m3.multiplyMatrices(m1,m2),lt.setFromRotationMatrix(m3),m1=new THREE.Matrix4,m2=new THREE.Matrix4,m3=new THREE.Matrix4,m1.makeRotationY(1*Math.PI/4-.009),m2.makeRotationX(1*-Math.PI/4-.009);var rt=new THREE.Euler;m3.multiplyMatrices(m1,m2),rt.setFromRotationMatrix(m3);var VIEWPOINT={LEFT:{x:0,y:-Math.PI/2+.009,z:0},RIGHT:{x:0,y:Math.PI/2-.009,z:0},FRONT:{x:0,y:0,z:0},BACK:{x:0,y:Math.PI-.009,z:0},TOP:{x:-Math.PI/2+.009,y:0,z:0},BOTTOM:{x:Math.PI/2-.009,y:0,z:0},LEFTTOP:{x:lt.x,y:lt.y,z:lt.z},RIGHTTOP:{x:rt.x,y:rt.y,z:rt.z}},UNIT_X=new THREE.Vector3(1,0,0),UNIT_Y=new THREE.Vector3(0,1,0),FLT_MAX=3.402823466e38,FLT_MIN=1.175494351e-38;function torad(t){return t*(Math.PI/180)}function getRotationTo(t,e){var i=new THREE.Quaternion,r=t.clone(),n=e;r.normalize(),n.normalize();var o=r.dot(n);if(o>=1)return i;if(o<1e-6-1){var a=new THREE.Vector3;a.crossVectors(UNIT_X,t),a.lengthSq()<1e-12&&a.crossVectors(UNIT_Y,t),a.normalize(),i.setFromAxisAngle(a,Math.PI)}else{var s=Math.sqrt(2*(1+o)),h=1/s,l=new THREE.Vector3;l.crossVectors(r,n),i.x=l.x*h,i.y=l.y*h,i.z=l.z*h,i.w=.5*s,i.normalize()}return i}function getAsciiString(t,e,i){return String.fromCharCode.apply(null,new Uint8Array(t,e,i))}var drawCylinder=function(t,e={},i={},r={}){const n=document.createElement("canvas").getContext("2d");n.canvas.width=64,n.canvas.height=64,n.translate(32,32),n.rotate(.5*Math.PI),n.fillStyle="rgb(0,255,255)",n.textAlign="center",n.textBaseline="middle",n.font="60px sans-serif",n.fillText("",0,0);const o=new THREE.CanvasTexture(n.canvas);o.wrapS=THREE.RepeatWrapping,o.wrapT=THREE.RepeatWrapping,o.repeat.x=1;const a=new THREE.Vector3(e.x,e.y,e.z),s=new THREE.Vector3(i.x,i.y,i.z),h=a.distanceTo(s);o.repeat.y=h/30;const l=r.radiusTop,c=r.radiusBottom,u=r.radiusSegments,p=r.heightSegments,d=r.openEnded,f=new THREE.CylinderBufferGeometry(l,c,h,u,p,d),m=new THREE.MeshBasicMaterial({color:r.color,opacity:r.opacity,side:THREE.DoubleSide,depthWrite:!1,depthTest:!1,transparent:!0});f.applyMatrix((new THREE.Matrix4).makeTranslation(0,h/2,0)),f.applyMatrix((new THREE.Matrix4).makeRotationX(THREE.Math.degToRad(90)));const g=new THREE.Mesh(f,m);g.position.set(i.x,i.y,i.z),g.lookAt(a),t.add(g);const v=new THREE.PlaneBufferGeometry(5*l,h),y=new THREE.MeshBasicMaterial({map:o,opacity:.5,side:THREE.DoubleSide,depthWrite:!1,depthTest:!1,transparent:!0});v.applyMatrix((new THREE.Matrix4).makeTranslation(0,h/2,0)),v.applyMatrix((new THREE.Matrix4).makeRotationX(THREE.Math.degToRad(90)));const E=new THREE.Mesh(v,y);if(E.position.set(i.x,i.y,i.z),E.lookAt(a),t.add(E),r.tween)new TWEEN.Tween(o.offset).to({y:1},1500).easing(TWEEN.Easing.Linear.None).onUpdate(function(){}).onComplete(function(){o.offset.y=1}).repeat(1/0).start()},drawAxisHelpers=function(t,e={},i={},r,n={}){var o=n.radius||.05,a=n.arrowheight||.4,s=n.tween||!0,h=parseInt(n.color.replace(/^#/,""),16)||16711680,l=new THREE.Vector3(e.x,e.y,e.z),c=new THREE.Vector3(i.x,i.y,i.z).distanceTo(l),u=new THREE.CylinderGeometry(0,2*o,a),p=new THREE.MeshBasicMaterial({color:h}),d=new THREE.CylinderGeometry(o,o,c),f=new THREE.Group,m=new THREE.Mesh(d,p),g=new THREE.Mesh(u,p),v=c/a;if(s){var y=new THREE.Vector3(1,v,1);g.scale.set(y.x,v,y.z),m.scale.set(y.x,0,y.z);new TWEEN.Tween(y).to({y:1},1500).easing(TWEEN.Easing.Linear.None).onUpdate(function(){g.scale.set(y.x,y.y,y.z),g.position.y=c/2-a*y.y/2,m.scale.set(y.x,1-y.y/v,y.z),m.position.y=-c/2+c*(1-y.y/v)/2}).onComplete(function(){y.y=10,g.position.y=c/2}).repeat(1/0).start()}f.add(m),f.add(g),f.rotateZ(THREE.Math.degToRad(-90)),f.rotateX(THREE.Math.degToRad(r));var E=new THREE.Vector3(Math.cos(THREE.Math.degToRad(r))*c/2,1,Math.sin(THREE.Math.degToRad(r))*c/2);f.position.add(E),f.position.add(l),t.add(f)},drawInformationScene=function(t,e){for(var i=0;i<e.length;i++){var r=e[i],n=new THREE.Group,o=new THREE.SphereGeometry(2.5,32,32),a=new THREE.MeshBasicMaterial({color:16711680}),s=new THREE.Mesh(o,a);n.add(s);a=new THREE.LineBasicMaterial({color:255,thickness:10});(o=new THREE.Geometry).vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(r.pos1.x,r.pos1.y,r.pos1.z),new THREE.Vector3(r.pos2.x,r.pos2.y,r.pos2.z));p=window.innerWidth,d=window.innerHeight;var h=new THREE.Line(o,a);n.add(h);var l=(new THREE.TextureLoader).load(r.texture),c=new THREE.SpriteMaterial({map:l,color:16777215}),u=new THREE.Sprite(c);u.position.set(r.pos2.x,r.pos2.y,r.pos2.z),u.center.set(-.001,.5);var p=100,d=20;u.scale.set(p,d,1),n.add(u),n.scale.set(r.scale,r.scale,r.scale),n.position.set(r.position.x,r.position.y,r.position.z),t.add(n)}};function applyTex(t,e,i){var r,n=new THREE.TextureLoader;return r=n.load(t,function(t){t.wrapS=r.wrapT=THREE.RepeatWrapping,t.repeat.set(e,i)})}var mirrorCubeArray=[];function addMirrorBox(t,e,i){var r=i.width,n=i.height,o=i.thick,a=i.opacity||1,s=i.transparent||!1,h=(i.angle,new THREE.CubeGeometry(r,n,o,1,1,1));mirrorCubeCamera=new THREE.CubeCamera(1,1e5,512),mirrorCubeArray.push(mirrorCubeCamera);var l=new THREE.MeshBasicMaterial({envMap:mirrorCubeCamera.renderTarget,opacity:a,transparent:s});mirrorCube=new THREE.Mesh(h,l),mirrorCube.add(mirrorCubeCamera),mirrorCube.position.copy(i.position),mirrorCube.rotateY(i.angle),e.add(mirrorCube),t.addPreRender("mirror",function(){for(var i=0;i<mirrorCubeArray.length;i++)mirrorCubeArray[i].visible=!1,mirrorCubeArray[i].updateCubeMap(t.renderer,e),mirrorCubeArray[i].visible=!0})}VB.TextureUtils={nextHighestPowerOfTwo_:function(t){--t;for(var e=1;e<32;e<<=1)t|=t>>e;return t+1},ensurePowerOfTw:function(t){if(!THREE.Math.isPowerOfTwo(t.width)||!THREE.Math.isPowerOfTwo(t.height)){var e=document.createElement("canvas");return e.width=this.nextHighestPowerOfTwo_(t.width),e.height=this.nextHighestPowerOfTwo_(t.height),e.getContext("2d").drawImage(t,0,0,t.width,t.height,0,0,e.width,e.height),e}return t},load:function(t,e){var i,r=this,n=THREE.Loader.Handlers.get(t);return null!==n?i=n.load(t,e):(i=new THREE.Texture,(n=new THREE.ImageLoader).crossOrigin="anonymous",n.load(t,function(t){i.image=r.ensurePowerOfTw(t),i.needsUpdate=!0,e&&e(i)})),i.sourceFile=t,i}},VB.LibraryManager=function(t,e,i,r){this.scene=e,this.mainCamera=i,this.renderer=t,this.onMovePosition=r;this.renderer.domElement.clientWidth,this.renderer.domElement.clientHeight,new THREE.Vector2,new THREE.Vector2;var n=new SoonMap,o=new SoonMap;this.LoadLibrary=function(t,e,i,r,o){var a=i.length,s=i.lastIndexOf("."),h=i.substring(s,a).toLowerCase();if(".fbx"===h)(new THREE.FBXLoader).load(i,function(t){t.userData.type="library",t.visible=!1,n.put(e,t),new THREE.AnimationMixer(t).clipAction(t.animations[0]).play(),t.traverse(function(t){t.isMesh&&(t.castShadow=!0,t.receiveShadow=!0)}),o&&o(t)});else if(".sbm"===h){var l=new VB.SBMLoader;l.textures=editor.textures;var c={id:n.size()+1,name:e,fileUrl:i,useBufferGeometry:!0,scale:1,totalSBMs:1,currentSBMs:0,textureUrl:r,baseFloor:1};l.load(i,c,function(t,i){t.userData.type="library",t.visible=!1,n.put(e,t),o&&o(t)})}},this.clear=function(){n.clear(),o.clear()},cloneFbx=function(t){const e=t.clone(!0);e.animations=t.animations,e.skeleton={bones:[]};const i={};t.traverse(t=>{t.isSkinnedMesh&&(i[t.name]=t)});const r={},n={};e.traverse(t=>{t.isBone&&(r[t.name]=t),t.isSkinnedMesh&&(n[t.name]=t)});for(let t in i){const o=i[t].skeleton,a=n[t],s=[];for(let t=0;t<o.bones.length;t++){const e=r[o.bones[t].name];s.push(e)}a.bind(new THREE.Skeleton(s,o.boneInverses),a.matrixWorld),e.skeleton.bones.push(a),e.skeleton.bones.push(...s)}return e},createInstace=function(t,e,i,r){var o=n.get(t);if(null==o)return null;var a=cloneFbx(o);return a.userData.id="library",a.visible=!0,a.translateX(e.x),a.translateY(e.y),a.translateZ(e.z),a.rotateX(THREE.Math.degToRad(r)),a.rotateY(THREE.Math.degToRad(i)),a},this.getIntersectObjectByPos=function(t){var e=new THREE.Vector3;e.set(0,-1,0).transformDirection(this.mainCamera.matrixWorld);var i=new THREE.Raycaster;return i.set(t,e),i.intersectObject(editor.scene,!0)},this.GetComponent=function(t){return o.get(t)},this.InsertLibrary=function(t,e,i,r,n,a,s){var h=t.editor,l=createInstace(i,r,n,a);if(l&&(l.userData.name=i,l.userData.id=e),s&&s>0){for(var c=1e11,u=this.getIntersectObjectByPos(r),p=0;p<u.length;++p)c=Math.min(c,u[p].distance);var d=new THREE.ConeGeometry(s,c-20,32),f=new THREE.MeshBasicMaterial({color:16776960,transparent:!0,opacity:.2}),m=new THREE.Mesh(d,f);m.translateY(-c/2+10),l.add(m),l.userData.lightcone=m}return o.put(e,l),h.addObject(l),l},this.update=function(){}},VB.LibraryManager.prototype.setVisibleLight=function(t,e,i){},VB.LibraryManager.prototype.getIntersectObject=function(){var t=new THREE.Vector3(2*this.onMovePosition.x-1,-2*this.onMovePosition.y+1,-1);return t.unproject(this.mainCamera),new THREE.Raycaster(this.mainCamera.position,t.sub(this.mainCamera.position).normalize()).intersectObject(this.scene,!0)},VB.LibraryManager.prototype.getParentByProperty=function(t,e,i,r){var n,o=function(t,e){t&&(e(t),r&&o(t.parent,e))};return o(t.parent,function(t){t&&null!=t[e]&&t[e]===i&&(n=t)}),n},VB.Layer=function(){THREE.Group.call(this),this.type="Layer"},VB.Layer.prototype=Object.create(THREE.Group.prototype),VB.Icon=function(t){THREE.Sprite.call(this,t)},VB.Icon.prototype=Object.create(THREE.Sprite.prototype),VB.Poi=function(){THREE.Object3D.call(this),this.type="POI",this.icon=null,this.text=null,this.line=null,this.point=null,this.circle=null,this.mixer=null,this.clipAction=null,this.clock=new THREE.Clock,this.tweenAlram=null,this.group=null,this.width=0,this.height=0,this.pos3D=new THREE.Vector3,this.elevation=0,this.srcMaterial={text:void 0,icon:void 0,line:void 0,point:void 0,circle:void 0},this.lod=[],this.zindex=0};var lineGeometry=new THREE.Geometry;lineGeometry.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,10,0));var pointGeometry=new THREE.CircleGeometry(1,8);VB.Poi.prototype=Object.create(THREE.Object3D.prototype),VB.Poi.prototype.createIcon=function(t){this.icon=new VB.Icon(t.material);var e=t.width||1,i=t.width||1;this.icon.scale.set(e,i,1),this.icon.position.set(t.position.x,t.position.y,t.position.z),this.add(this.icon)},VB.Poi.prototype.createText=function(t,e){this.text=new Text2D(void 0,t,e),this.add(this.text.sprite),this.text.texture.flipY=!1},VB.Poi.prototype.createLine=function(t){this.line=new THREE.Line(lineGeometry,new THREE.LineDashedMaterial({color:16724016,dashSize:2,gapSize:1})),this.point=new THREE.Mesh(pointGeometry,new THREE.MeshBasicMaterial({color:16724016,side:THREE.BackSide})),this.add(this.line),this.add(this.point)},VB.Poi.prototype.createCircle=function(t){void 0==t&&(t=2),this.group=new THREE.Group;var e=new THREE.CircleGeometry(t,18),i=new THREE.MeshBasicMaterial({color:16711680,transparent:!0,opacity:.5,side:THREE.BackSide}),r=new THREE.Mesh(e,i);this.group.add(r);var n=new THREE.CircleGeometry(2*t/3,18),o=new THREE.MeshBasicMaterial({color:65280,transparent:!0,opacity:.5,side:THREE.BackSide}),a=new THREE.Mesh(n,o);this.group.add(a);var s=new THREE.CircleGeometry(t/3,18),h=new THREE.MeshBasicMaterial({color:255,transparent:!0,opacity:.5,side:THREE.BackSide}),l=new THREE.Mesh(s,h);this.group.add(l),this.add(this.group);var c=this.group,u=this.icon,p=new THREE.Vector3(1,1,1);this.tweenAlram=new TWEEN.Tween(p).to({x:8,y:8,z:8},1500).easing(TWEEN.Easing.Linear.None).onUpdate(function(){c.position.set(u.position.x,u.position.y,u.position.z),c.scale.set(p.x,p.y,p.z)}).onComplete(function(){p.set(1,1,1)}).repeat(1/0).start()},VB.Poi.prototype.play=function(){this.clipAction.play()},VB.Poi.prototype.stop=function(){this.clipAction.stop()},VB.Poi.prototype.create=function(t){this.width=t.width,this.height=t.height,this.userData.id=t.id,this.name=t.name,this.pos3D=new THREE.Vector3(t.position.x,t.position.y,t.position.z),this.zindex=null!=t.zindex?t.zindex:0,this.elevation=null!=t.elevation?t.elevation:0,this.userData.floorid=null!=t.floorid?t.floorid:0,this.link=null!=t.link?t.link:0,t.material&&(t.material.map.flipY=!1),this.createIcon(t);var e=new Array,i={text:t.name,size:10};void 0!=t.margin&&(i.margin=t.margin),e.push(i),this.createText(e,this.icon.position),this.createLine(t),this.saveMaterial()},VB.Poi.prototype.dispose=function(){this.parent&&(this.children.length>0&&this.remove(this.children[0]),this.parent.remove(this)),this.restoreMaterial(),this.text.dispose(),this.srcMaterial={}},VB.Poi.prototype.setAnimation=function(t){this.createCircle(t),this.animation=!0,this.needsUpdate=!0},VB.Poi.prototype.stopAnimation=function(){this.tweenAlram&&(this.tweenAlram.stop(),this.remove(this.group))},VB.Poi.prototype.saveMaterial=function(){this.srcMaterial={text:this.text.sprite.material,icon:this.icon.material}},VB.Poi.prototype.restoreMaterial=function(){this.srcMaterial.text.uuid!==this.text.sprite.material.uuid&&(this.text.sprite.material.dispose(),this.text.sprite.material=this.srcMaterial.text),this.srcMaterial.icon.uuid!==this.icon.material.uuid&&(this.icon.material.dispose(),this.icon.material=this.srcMaterial.icon)},VB.Poi.prototype.setColor=function(t,e,i,r){this.srcMaterial.text.uuid===this.text.sprite.material.uuid&&(this.text.sprite.material=this.text.sprite.material.clone()),this.srcMaterial.icon.uuid===this.icon.material.uuid&&(this.icon.material=this.icon.material.clone()),null!=t&&this.text.sprite.material.color.set(t),null!=i&&(this.text.sprite.material.opacity=i),null!=e&&this.icon.material.color.set(e),null!=r&&(this.icon.material.opacity=r)},VB.Poi.prototype.addLOD=function(t){t&&this.lod.push(t)},VB.Poi.prototype.getLODByDistance=function(t){for(var e in this.lod){var i=this.lod[e];if(t>i.min&&t<i.max)return i}},VB.Poi.prototype.applyLOD=function(t){t&&(this.icon.scale.set(t.iconSize.width,t.iconSize.height,1),this.icon.visible=t.visibleIcon,this.text.sprite.visible=t.visibleText,this.line.visible=t.visibleIcon||t.visibleText,this.point.visible=this.line.visible,this.circle&&(this.circle.visible=this.line.visible))},VB.Poi.LOD=function(t,e,i,r,n,o,a){this.level=t,this.iconSize={width:e,height:i},this.visibleText=r,this.visibleIcon=n,this.min=o,this.max=a};var SHOWONLY_POI=0,SHOW_POI=1,HIDE_POI=2;VB.PoiManager=function(t,e,i,r){this.orthoCamera=null,this.mainCamera=i,this.renderer=t,this.controldom=e,this.labelRenderer=null,this.clear(),this.visible=!0,this.mouseOverObj=null,this.checkDepth,this.cellSize=50,this.poiCellDepthResult=[],this.onMovePosition=r;var n=this.renderer.domElement.clientWidth,o=this.renderer.domElement.clientHeight;this.orthoCamera=new THREE.OrthographicCamera(0,n,0,o,-10,1e3),this.orthoCamera.updateProjectionMatrix(),this.orthoMenuCamera=new THREE.OrthographicCamera(0,n,0,o,-10,10),this.orthoMenuCamera.updateProjectionMatrix();var a=new THREE.Vector2,s=new THREE.Vector2,h=this,l=0;this.devselectprev=null;var c=function(t){t.preventDefault(),s.copy(h.onMovePosition),l++,setTimeout(function(){1===l?(0==a.distanceTo(s)&&0===t.button&&h.handleClick(t,l),l=0):l>1&&(0==a.distanceTo(s)&&0===t.button&&h.handleClick(t,l),l=0)},200),document.removeEventListener("mouseup",c,!1)},u=function(t){s.copy(h.onMovePosition),l++,setTimeout(function(){1===l?(a.distanceTo(s)<.1&&h.handleClick(t,l),l=0):l>1&&(a.distanceTo(s)<.1&&h.handleClick(t,l),l=0)},200),document.removeEventListener("touchend",u,!1)};"ontouchstart"in window?e.addEventListener("touchstart",function(t){t.preventDefault();t.changedTouches[0];a.copy(h.onMovePosition),document.addEventListener("touchend",u,!1)},!1):e.addEventListener("mousedown",function(t){t.preventDefault(),a.copy(h.onMovePosition),document.addEventListener("mouseup",c,!1)},!1),this.materials=[],this.moving},VB.PoiManager.prototype.createTooltip=function(){var t=new Array;t.push({text:"undefined",size:12}),this.tooltip=new Text2D(this.tooltipScene,t,new THREE.Vector3(0,0,0)),this.tooltip.texture.flipY=!1,this.tooltip.clearRect()},VB.PoiManager.prototype.ClearPoi=function(){this.poiMenuScene=new THREE.Scene,this.poiMenuScene.name="POIS_MENU"},VB.PoiManager.prototype.CreatePoiMenu=function(){this.ClearPoi();var t=this.poiMenuScene,e=this.poiScene,i=new THREE.TextureLoader,r=i.load("../image/poi/poi_icon_indoor_play.png");i.load("../image/poi/poi_icon_indoor.png",function(i){var n=new THREE.SpriteMaterial({map:i});n.map.flipY=!1;n.map.image.width,n.map.image.height;var o=new THREE.SpriteMaterial({map:r});o.map.flipY=!1;var a=100;e.traverse(function(e){if(e instanceof VB.Poi&&e.visible){var i=""==e.link?new THREE.Sprite(n):new THREE.Sprite(o);i.scale.set(32,32,1),i.position.set(20,a,1),i.menu=e.name;var r=new Array,s={text:e.name,size:10,textAlign:"left",textBaseline:"top"};r.push(s);var h=new Text2D(void 0,r,{x:0,y:0,z:0});h.texture.flipY=!1,h.sprite.position.set(35,a,1),h.sprite.menu=e.name,t.add(h.sprite),t.add(i),a+=40}})})},VB.PoiManager.prototype.clearMaterial=function(){for(var t in this.materials){var e=this.materials[t];e.map&&e.map.dispose(),e.dispose()}this.materials=[]},VB.PoiManager.prototype.addMaterial=function(t){if(null!=t){var e=this.materials[t.id];null==e&&(e=new THREE.SpriteMaterial({map:VB.TextureUtils.load(t.textureUrl),color:null==t.color?16777215:t.color,fog:null==t.fog||t.fog}),this.materials[t.id]=e)}},VB.PoiManager.prototype.clear=function(){this.poiScene=new THREE.Scene,this.poiScene.name="POIS",this.poiMenuScene=new THREE.Scene,this.poiMenuScene.name="POIS_MENU",this.clearMaterial()},VB.PoiManager.prototype.getIntersectObject=function(){var t=new THREE.Vector3(2*this.onMovePosition.x-1,-2*this.onMovePosition.y+1,-1);t.unproject(this.orthoCamera);var e=new THREE.Vector3;e.set(0,0,-1).transformDirection(this.orthoCamera.matrixWorld);var i=new THREE.Raycaster;return i.set(t,e),i.intersectObject(this.poiScene,!0)},VB.PoiManager.prototype.getIntersectMenuObject=function(){var t=new THREE.Vector3(2*this.onMovePosition.x-1,-2*this.onMovePosition.y+1,-1);t.unproject(this.orthoMenuCamera);var e=new THREE.Vector3(0,0,-1),i=new THREE.Raycaster;i.set(t,e);for(var r,n,o=i.intersectObject(this.poiMenuScene,!0),a=0;a<o.length;++a)(0==a||t.distanceTo(o[a].object.position)<n)&&(r=o[a].object,n=t.distanceTo(r.position));return r},VB.Poi.prototype.createInfoForm=function(t){var e=document.getElementsByClassName(t)[0].cloneNode(!0);e.style.visibility="hidden",document.body.appendChild(e);var i=new THREE.CSS2DObject(e);return i.position.y=-2.5,this.icon.add(i),i},VB.Poi.prototype.ShowCSToolTip=function(){this.point.visible=!0,this.line.visible=!0,this.icon.children.length>0&&(this.icon.children[0].element.style.visibility="visible")},VB.Poi.prototype.HideCSToolTip=function(){this.point.visible=!1,this.line.visible=!1,this.icon.children.length>0&&(this.icon.children[0].element.style.visibility="hidden")},VB.PoiManager.prototype.handleHover=function(t){for(var e,i=this.getIntersectObject(),r=-1,n=1e5,o=0;o<i.length;++o)if(i[o].object instanceof VB.Icon){if(i[o].object.parent.userData.poi_visible&&0==i[o].object.parent.userData.poi_visible)continue;i[o].object.parent.visible&&(e=i[o].object.parent.pos3D.distanceTo(this.mainCamera.position))<n&&(r=o,n=e)}if(r>=0&&(i[r].object instanceof VB.Icon&&i[r].object.parent.visible&&null==this.getParentByProperty(i[r].object,"visible",!1,!0))){t.stopPropagation();var a={id:i[r].object.parent.id,layerId:i[r].object.parent.parent.name,name:i[r].object.parent.name,poi:i[r].object.parent};return void this.onHover(a)}},VB.PoiManager.prototype.handleClick=function(t,e){t.preventDefault();for(var i,r=this.getIntersectObject(),n=-1,o=1e5,a=0;a<r.length;++a)if(r[a].object instanceof VB.Icon){if(r[a].object.parent.userData.poi_visible&&0==r[a].object.parent.userData.poi_visible)continue;r[a].object.parent.visible&&(i=r[a].object.parent.pos3D.distanceTo(this.mainCamera.position))<o&&(n=a,o=i)}if(n>=0&&(r[n].object instanceof VB.Icon&&r[n].object.parent.visible&&null==this.getParentByProperty(r[n].object,"visible",!1,!0))){t.stopPropagation();var s={id:r[n].object.parent.id,layerId:r[n].object.parent.parent.name,name:r[n].object.parent.name,poi:r[n].object.parent,clicks:e};return void(1===e?this.onClick(s):this.onDblClick(s))}var h=this.getIntersectMenuObject();if(h){t.stopPropagation();s={menu:h.menu,clicks:e};1===e?this.onClick(s):this.onDblClick(s)}else 1===e?this.onClick(s):this.onDblClick(s)},VB.PoiManager.prototype.getLayer=function(t){return this.getLayerByProperty("name",t)},VB.PoiManager.prototype.getLayerByProperty=function(t,e){var i;return this.poiScene.traverse(function(r){r instanceof VB.Layer&&null!=r[t]&&r[t]===e&&(i=r)}),i},VB.PoiManager.prototype.createLayer=function(t){var e=this.getLayerByProperty("name",t);return null==e&&((e=new VB.Layer).name=t,this.poiScene.add(e)),e},VB.PoiManager.prototype.removeLayerByProperty=function(t,e){var i=this.getLayerByProperty(t,e);null!=i&&this.removeLayer(i)},VB.PoiManager.prototype.removeLayer=function(t){t.traverse(function(t){VB.Poi}),t.parent&&t.parent.remove(t)},VB.PoiManager.prototype.getPoiByProperty=function(t,e){var i;return this.poiScene.traverse(function(r){r instanceof VB.Poi&&null!=r[t]&&r[t]===e&&(i=r)}),i},VB.PoiManager.prototype.getPoiByUserData=function(t,e){var i;return this.poiScene.traverse(function(r){"POI"===r.type&&null!=r.userData[t]&&r.userData[t]===e&&(i=r)}),i},VB.PoiManager.prototype.addPoi=function(t){var e=t.layerName,i=this.createLayer(e),r=new VB.Poi;return r.create(t),i.add(r),r},VB.PoiManager.prototype.update=function(t,e,i){if(!1!==this.visible){var r=void 0===e?this.mainCamera:e,n=void 0===t?this.renderer:t,o=void 0===t?r.position:i,a=n.autoClear;n.autoClear=!1,r.updateProjectionMatrix(),r.updateMatrixWorld();var s=new THREE.Frustum;(new THREE.Matrix4).multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse),s.setFromMatrix((new THREE.Matrix4).multiplyMatrices(r.projectionMatrix,r.matrixWorldInverse));var h=new Array,l=new Array,c=this;if(this.poiScene.traverse(function(t){if(t instanceof VB.Poi&&t.parent.visible){var e=t.pos3D.clone();e.project(r);var i=t.pos3D.clone();i.project(r),t&&(e.x=Math.round((e.x+1)*n.domElement.clientWidth/2),e.y=Math.round((1-e.y)*n.domElement.clientHeight/2),e.z=0,i.x=Math.round((i.x+1)*n.domElement.clientWidth/2),i.y=Math.round((1-i.y)*n.domElement.clientHeight/2),i.z=0),t.icon.position.set(e.x,e.y-t.icon.scale.y/2,t.zindex),t.text.sprite.position.copy(t.icon.position),t.text.sprite.position.y-=t.icon.scale.y/1.2,t.text.sprite.position.z+=1,t.line.position.copy(e),t.line.scale.y=(new THREE.Vector3).subVectors(e,i).length();var a=new THREE.Vector3(0,1,0).angleTo((new THREE.Vector3).subVectors(i,e).normalize());if(t.line.rotation.x=0,t.line.rotation.y=0,t.line.rotation.z=0,e.x<i.x&&(a=-a),t.line.rotateOnAxis(new THREE.Vector3(0,0,1),a),t.point.position.copy(i),t.point.scale.set(3,3,3),t.circle){t.circle.position.copy(i),t.circle.scale.set(3,3,3);var u=t.clock.getDelta();t.mixer.update(u)}if(s.containsPoint(t.pos3D)){var p=t.pos3D.distanceTo(o);if(t.getLODByDistance(p)){t.text.sprite.position.y=t.icon.position.y,t.text.sprite.position.y-=t.icon.scale.y/1.2;var d=new THREE.Vector3;d.subVectors(o,t.pos3D),d.normalize(),t.visible=!0,t.userData.poi_visible=!0}else t.lod.length>0&&(h.push(t),l.push(t.visible),t.visible=!1,t.userData.poi_visible=!1)}else c.moving!==t&&(h.push(t),l.push(t.visible),t.visible=!1,t.userData.poi_visible=!1)}}),this.moving){var u=this.moving.pos3D.clone();u.project(r),u.x=Math.round(this.onMovePosition.x*n.domElement.clientWidth),u.y=Math.round(this.onMovePosition.y*n.domElement.clientHeight),u.z=0,this.moving.icon.position.set(u.x,u.y-this.moving.height/2,this.moving.zindex),this.moving.text.sprite.position.copy(this.moving.icon.position),this.moving.text.sprite.position.y-=this.moving.height/1.2,this.moving.text.sprite.position.z+=1}n.render(this.poiScene,this.orthoCamera),n.render(this.poiMenuScene,this.orthoMenuCamera),this.labelRenderer&&this.labelRenderer!==n&&this.labelRenderer.render(this.poiScene,this.orthoCamera);for(var p=0,d=l.length;p<d;++p)h[p].visible=l[p];n.autoClear=a}},VB.PoiManager.prototype.update2=function(){if(!1!==this.visible){var t=this.renderer.autoClear;this.renderer.autoClear=!1,this.renderer.clearDepth(),this.mainCamera.updateMatrix(),this.mainCamera.updateMatrixWorld();var e=new THREE.Frustum;(new THREE.Matrix4).multiplyMatrices(this.mainCamera.projectionMatrix,this.mainCamera.matrixWorldInverse),e.setFromMatrix((new THREE.Matrix4).multiplyMatrices(this.mainCamera.projectionMatrix,this.mainCamera.matrixWorldInverse));var i=this,r=new Array;if(this.poiScene.traverse(function(t){if(t instanceof VB.Poi){var n=t.pos3D.clone();n.project(i.mainCamera),t&&(n.x=Math.round((n.x+1)*i.renderer.domElement.clientWidth/2),n.y=Math.round((1-n.y)*i.renderer.domElement.clientHeight/2),n.z=0),t.icon.position.set(n.x,n.y-t.height/2,0),t.text.sprite.position.copy(t.icon.position),t.text.sprite.position.y-=t.height/1.2,t.text.sprite.position.z+=1,e.containsPoint(t.pos3D)||i.moving!==t&&(r.push(t),visibleArray.push(t.visible),t.visible=!1)}}),this.moving){var n=this.moving.pos3D.clone();n.project(i.mainCamera),n.x=Math.round(i.onMovePosition.x*i.renderer.domElement.clientWidth),n.y=Math.round(i.onMovePosition.y*i.renderer.domElement.clientHeight),n.z=0,this.moving.icon.position.set(n.x,n.y-this.moving.height/2,0),this.moving.text.sprite.position.copy(this.moving.icon.position),this.moving.text.sprite.position.y-=this.moving.height/1.2,this.moving.text.sprite.position.z+=1}this.renderer.render(this.poiScene,this.orthoCamera),this.renderer.render(this.poiMenuScene,this.orthoMenuCamera),this.renderer.autoClear=t}},VB.PoiManager.prototype.onClick=function(t){},VB.PoiManager.prototype.onHover=function(t){},VB.PoiManager.prototype.onDblClick=function(t){},VB.PoiManager.prototype.show=function(t){this.visible=t},VB.PoiManager.prototype.showLayer=function(t,e){for(var i=0;i<t.length;++i){var r=t[i],n=this.getLayerByProperty("name",r);n&&(n.visible=e)}},VB.PoiManager.prototype.onResize=function(){this.orthoCamera.right=this.renderer.domElement.clientWidth,this.orthoCamera.bottom=this.renderer.domElement.clientHeight,this.orthoCamera.updateProjectionMatrix(),this.orthoMenuCamera.right=this.renderer.domElement.clientWidth,this.orthoMenuCamera.bottom=this.renderer.domElement.clientHeight,this.orthoMenuCamera.updateProjectionMatrix()},VB.PoiManager.prototype.getBoundingBox=function(t,e){if(t){var i=new THREE.Vector3,r=new THREE.Vector3,n=new THREE.Vector3(500,500,500);return e&&n.copy(e),i.copy(t.pos3D),r.copy(t.pos3D),i.sub(n),r.add(n),new THREE.Box3(i,r)}},VB.PoiManager.prototype.getBoundingBoxByUserId=function(t,e){var i=this.getPoiByUserData("id",t);if(i)return getBoundingBox(i)},VB.PoiManager.prototype.moveObject=function(t,e,i){if(void 0===e&&(e=this.poiScene),e.add(t),void 0!==i){var r=e.children.indexOf(i);e.children.splice(r,0,t),e.children.pop()}},VB.PoiManager.prototype.removePoiByLayerName=function(t){var e=this.getLayerByProperty("name",t);if(e){for(var i=[],r=0;r<e.children.length;++r){var n=e.children[r];n instanceof VB.Poi&&i.push(n)}for(r=0;r<i.length;++r)e.remove(i[r])}},VB.PoiManager.prototype.removePoiByProperty=function(t,e){var i=this.getPoiByProperty(t,e);i&&i.dispose()},VB.PoiManager.prototype.getParentByProperty=function(t,e,i,r){var n,o=function(t,e){t&&(e(t),r&&o(t.parent,e))};return o(t.parent,function(t){t&&null!=t[e]&&t[e]===i&&(n=t)}),n},VB.PoiManager.prototype.setMovingPoi=function(t){this.moving&&(this.moving.dispose(),this.moving=void 0),t&&(this.moving=this.addPoi({width:t.width,height:t.height,material:t.srcMaterial.icon,name:t.name,id:t.userData.id,position:{x:t.pos3D.x,y:t.pos3D.y,z:t.pos3D.z},layerName:"moving",zindex:2}))},VB.PoiManager.prototype.load=function(t,e,i,r){var n=this;if(document.implementation&&document.implementation.createDocument){var o=new XMLHttpRequest;o.onreadystatechange=function(){if(4===o.readyState&&(0===o.status||200===o.status))if(o.responseXML)n.parse(t,o.responseXML,e,i);else if(o.responseText){var a=(new DOMParser).parseFromString(o.responseText,"application/xml");n.parse(t,a,e,i)}else r&&r()},o.open("GET",t,!0),o.send(null)}},VB.PoiManager.prototype.parse=function(t,e,i,r){var n=0,o=(e.evaluate?e:document).evaluate("Project/Poi",e,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),a=o.iterateNext();for(n=0;a;){var s={layerName:"",id:"Poi "+ ++n,name:"",floorid:-1,imgname:"",memo:"",position:{x:0,y:0,z:0},width:32,height:32,icon:"../image/poi/poi_icon_indoor.png",material:null};s.id=a.getAttribute("id"),s.layerName=a.getAttribute("layername"),s.name=a.getAttribute("name"),s.imgname=a.getAttribute("imgname");var h=a.getAttribute("position").split(",");s.position.x=h[0],s.position.y=h[1],s.position.z=h[2],s.memo=a.getAttribute("memo"),s.floorid=a.getAttribute("floorid"),s.link=a.getAttribute("link"),""!=s.link&&(s.icon="../image/poi/poi_icon_indoor_play.png");var l=VB.TextureUtils.load(s.icon),c=new THREE.SpriteMaterial({map:l,color:16777215,fog:!0});s.material=c,this.addPoi(s),a=o.iterateNext()}i&&i()},VB.Poi3D=function(){THREE.Object3D.call(this),this.type="POI3D"},VB.Poi3D.prototype=Object.create(THREE.Object3D.prototype),VB.Poi3D.prototype.create=function(t){t.element.id=t.id;var e=new THREE.CSS3DObject(t.element);e.rotateY(t.rotate),e.position.x=t.position.x,e.position.y=t.position.y,e.position.z=t.position.z,e.userData.id=t.id,e.scale.x=e.scale.y=e.scale.z=t.scale,this.add(e)},VB.Poi3D.prototype.dispose=function(){this.parent&&(this.remove(this.children[0]),this.parent.remove(this))},VB.Poi3DManager=function(t,e,i,r){this.renderer=t,this.controldom=e,this.camera=i,this.onMovePosition=r,this.raycaster=new THREE.Raycaster;var n=new THREE.Vector2,o=new THREE.Vector2,a=0;this.clear();var s=this,h=function(t){t.preventDefault(),o.copy(s.onMovePosition),a++,setTimeout(function(){1===a?(0==n.distanceTo(o)&&0===t.button&&s.handleClick(t,a),a=0):a>1&&(0==n.distanceTo(o)&&0===t.button&&s.handleClick(t,a),a=0)},200),document.removeEventListener("mouseup",h,!1)},l=function(t){o.copy(s.onMovePosition),a++,setTimeout(function(){1===a?(n.distanceTo(o)<.1&&s.handleClick(t,a),a=0):a>1&&(n.distanceTo(o)<.1&&s.handleClick(t,a),a=0)},200),document.removeEventListener("touchend",l,!1)};"ontouchstart"in window?e.addEventListener("touchstart",function(t){t.preventDefault();t.changedTouches[0];n.copy(s.onMovePosition),document.addEventListener("touchend",l,!1)},!1):e.addEventListener("mousedown",function(t){t.preventDefault(),n.copy(s.onMovePosition),document.addEventListener("mouseup",h,!1)},!1)},VB.Poi3DManager.prototype.addPoi=function(t){var e=t.layerName,i=this.createLayer(e),r=new VB.Poi3D;return r.create(t),i.add(r),r},VB.Poi3DManager.prototype.createLayer=function(t){var e=this.getLayerByProperty("name",t);return null==e&&((e=new VB.Layer).name=t,this.poiScene.add(e)),e},VB.Poi3DManager.prototype.getLayerByProperty=function(t,e){var i;return this.poiScene.traverse(function(r){r instanceof VB.Layer&&null!=r[t]&&r[t]===e&&(i=r)}),i},VB.Poi3DManager.prototype.clear=function(){this.poiScene=new THREE.Scene},VB.Poi3DManager.prototype.onClick=function(t){},VB.Poi3DManager.prototype.onHover=function(t){},VB.Poi3DManager.prototype.onDblClick=function(t){},VB.Poi3DManager.prototype.getIntersectObject=function(){var t=new THREE.Vector3(2*this.onMovePosition.x-1,-2*this.onMovePosition.y+1,-1);return t.unproject(this.camera),new THREE.Raycaster(this.camera.position,t.sub(this.camera.position).normalize()).intersectObject(this.poiScene,!0)},VB.Poi3DManager.prototype.handleHover=function(t){if(t.target){var e={id:t.target.id};this.onHover(e)}},VB.Poi3DManager.prototype.handleClick=function(t,e){if(t.preventDefault(),t.target){var i={id:t.target.id};1===e?this.onClick(i):this.onDblClick(i)}},VB.Poi3DManager.prototype.getPoiByProperty=function(t,e){var i;return this.poiScene.traverse(function(r){r instanceof VB.Poi3D&&null!=r[t]&&r[t]===e&&(i=r)}),i},VB.Poi3DManager.prototype.removePoiByProperty=function(t,e){var i=this.getPoiByProperty(t,e);i&&i.dispose()},VB.Device=function(){THREE.Object3D.call(this),this.type="DEVICE",this.icon=null,this.text=null,this.line=null,this.point=null,this.circle=null,this.mixer=null,this.clipAction=null,this.clock=new THREE.Clock,this.point2=null,this.width=0,this.height=0,this.pos3D=new THREE.Vector3,this.elevation=0,this.srcMaterial={text:void 0,icon:void 0,line:void 0,point:void 0,circle:void 0},this.lod=[],this.zindex=0,this.DeviceSelected=!1,this.DeviceStates=VB.Device.DeviceState.Normal,this.tooltip=!1,this.tooltip_text=null},VB.Device.DeviceState={Normal:-1,On:0,Off:1,NotRegister:2,Error:3,ComError:4};var lineGeometry=new THREE.Geometry;lineGeometry.vertices.push(new THREE.Vector3(0,0,0),new THREE.Vector3(0,-125,0));var pointGeometry=new THREE.CircleGeometry(1,8);VB.Device.prototype=Object.create(THREE.Object3D.prototype),VB.Device.prototype.createIcon=function(t){this.icon=new VB.Icon(t.material),this.icon.scale.set(t.width,t.height,1),this.icon.position.set(t.position.x,t.position.y,t.position.z),this.add(this.icon)},VB.Device.prototype.createText=function(t,e){this.text=new Text2D(void 0,t,e),this.add(this.text.sprite),this.text.texture.flipY=!1},VB.Device.prototype.createInfoForm=function(t,e){var i=document.getElementsByClassName(t)[0].cloneNode(!0);e?(i.style.visibility="visible",this.point.visible=!0,this.line.visible=!0):i.style.visibility="hidden",document.body.appendChild(i);var r=new THREE.CSS2DObject(i);return r.position.y=-8,this.icon.add(r),this.showAlways=e,r},VB.Device.prototype.hidePoint=function(){this.point.visible=!1},VB.Device.prototype.hideIcon=function(){this.icon.visible=!1},VB.Device.prototype.createLine=function(t){this.line=new THREE.Line(lineGeometry,new THREE.LineBasicMaterial({color:16724016,linewidth:5,linecap:"round",linejoin:"round"})),this.line.visible=!1,this.point=new THREE.Mesh(pointGeometry,new THREE.MeshBasicMaterial({color:16724016,side:THREE.BackSide})),this.add(this.line),this.add(this.point)},VB.Device.prototype.createCircle=function(t){void 0==t&&(t=2);var e,i=new THREE.CircleGeometry(t,18);e=this.DeviceStates==VB.Device.DeviceState.Error?new THREE.MeshBasicMaterial({color:16711680,transparent:!0,opacity:.5,side:THREE.BackSide}):new THREE.MeshBasicMaterial({color:255,transparent:!0,opacity:.5,side:THREE.BackSide}),this.circle=new THREE.Mesh(i,e),this.add(this.circle)},VB.Device.prototype.play=function(){this.clipAction&&this.clipAction.play()},VB.Device.prototype.stop=function(){this.circle&&this.remove(this.circle),this.clipAction&&this.clipAction.stop()},VB.Device.prototype.create=function(t){this.width=t.width,this.height=t.height,this.userData.id=t.id,this.name=t.name,this.pos3D=new THREE.Vector3(t.position.x,t.position.y,t.position.z),this.zindex=null!=t.zindex?t.zindex:0,this.elevation=null!=t.elevation?t.elevation:0,null!=t.material&&(t.material.map.flipY=!1),this.createIcon(t);var e=new Array,i={text:t.name,size:10};e.push(i),this.createText(e,this.icon.position),this.createLine(t),this.saveMaterial()},VB.Device.prototype.dispose=function(){this.parent&&this.parent.remove(this),this.restoreMaterial(),this.icon.geometry.dispose(),this.text.dispose(),this.srcMaterial={}},VB.Device.prototype.setAnimation=function(){this.createCircle(3);var t=new THREE.VectorKeyframeTrack(".scale",[0,1,2,3],[1,10,20,30]),e=new THREE.AnimationClip("Device Anmation",.8,[t]);this.mixer=new THREE.AnimationMixer(this.circle),this.clipAction=this.mixer.clipAction(e),this.clipAction.play()},VB.Device.prototype.saveMaterial=function(){this.srcMaterial={text:this.text.sprite.material,icon:this.icon.material}},VB.Device.prototype.restoreMaterial=function(){this.srcMaterial.text.uuid!==this.text.sprite.material.uuid&&(this.text.sprite.material.dispose(),this.text.sprite.material=this.srcMaterial.text),this.srcMaterial.icon.uuid!==this.icon.material.uuid&&(this.icon.material.dispose(),this.icon.material=this.srcMaterial.icon)},VB.Device.prototype.setSelect=function(){this.DeviceSelected?this.setDeselect():(this.DeviceSelected=!0,this.StopColorAnimator(),this.CreateColorAnimator(new THREE.Color(0,0,0),new THREE.Color(0,0,1),1e3))},VB.Device.prototype.setDeselect=function(){this.DeviceSelected=!1,this.setObjectState(this.DeviceStates)},VB.Device.prototype.setDeviceText=function(t,e,i){var r=new Array,n={text:t,size:i,color:e};r.push(n),this.text.setText(r)},VB.Device.prototype.setObjectState=function(t,e,i){switch(void 0==i&&(i=!1),this.object=this.GetObject(),this.stop(),this.StopColorAnimator(),this.DeviceStates=e,e){case VB.Device.DeviceState.Normal:i&&this.setDeviceText(this.name,"#ffffff",10),this.setColor(16777215,16777215,1,1);break;case VB.Device.DeviceState.On:case VB.Device.DeviceState.Off:this.setColor(16777215,16777215,1,1);break;case VB.Device.DeviceState.NotRegister:this.CreateColorAnimator(new THREE.Color(.5,.5,.5),new THREE.Color(.5,.5,.5),0),i&&this.setDeviceText(this.name+" : ","#000000",12),t.setVisibleLight(this,!1,!0),this.setColor(16777215,5263440,1,1);break;case VB.Device.DeviceState.Error:null==this.object?this.setAnimation():this.CreateColorAnimator(new THREE.Color(1,1,0),new THREE.Color(1,0,0),100),this.setColor(16777215,16711680,1,1),i&&this.setDeviceText(this.name+" : ","#ff0000",12),t.setVisibleLight(this,!1,!0);break;case VB.Device.DeviceState.ComError:this.setAnimation(),i&&this.setDeviceText(this.name+" : ","#0000ff",12),t.setVisibleLight(this,!1,!0),this.setColor(16777215,255,1,1)}},VB.Device.prototype.setColor=function(t,e,i,r){this.srcMaterial.text.uuid===this.text.sprite.material.uuid&&(this.text.sprite.material=this.text.sprite.material.clone()),this.srcMaterial.icon.uuid===this.icon.material.uuid&&(this.icon.material=this.icon.material.clone()),null!=t&&this.text.sprite.material.color.set(t),null!=i&&(this.text.sprite.material.opacity=i),null!=e&&this.icon.material.color.set(e),null!=r&&(this.icon.material.opacity=r)},VB.Device.prototype.addLOD=function(t){t&&this.lod.push(t)},VB.Device.prototype.getLODByDistance=function(t){for(var e in this.lod){var i=this.lod[e];if(t>i.min&&t<i.max)return i}},VB.Device.prototype.applyLOD=function(t){t&&(t.iconSize&&this.icon.scale.set(t.iconSize.width,t.iconSize.height,1),this.text.sprite.visible=t.visibleText,this.point.visible=this.line.visible,this.circle&&(this.circle.visible=this.line.visible))},VB.Device.LOD=function(t,e,i,r,n,o,a){this.level=t,this.iconSize={width:e,height:i},this.visibleText=r,this.visibleIcon=n,this.min=o,this.max=a},VB.Device.prototype.GetObject=function(){return this.userData.meshContainer},VB.Device.prototype.CreateColorAnimator=function(t,e,i){this.object=this.GetObject(),this.duration=i,this.controlMaterial=new THREE.MeshStandardMaterial({side:THREE.DoubleSide}),this.startColor=t,this.destColor=e,this.currColor=new THREE.Color(t.r,t.g,t.b),this.tweenToEnd=new TWEEN.Tween(this.currColor).to(this.destColor,this.duration),this.tweenToStart=new TWEEN.Tween(this.currColor).to(this.startColor,this.duration),this.tweenToEnd.easing=TWEEN.Easing.Elastic.InOut,this.tweenToStart.easing=TWEEN.Easing.Elastic.InOut,this.tweenToEnd.chain(this.tweenToStart),this.tweenToStart.chain(this.tweenToEnd),this.arrayMaterials=new Array;var r=this.controlMaterial,n=this.currColor;null!=this.object&&(this.object.traverse(function(t){t instanceof THREE.Mesh&&(t.material_bak=t.material,r.map=t.material.map,t.material=r)}),this.tweenToEnd.onUpdate(function(){r.color=n}),this.tweenToStart.onUpdate(function(){r.color=n}),this.tweenToEnd.start())},VB.Device.prototype.StopColorAnimator=function(){null!=this.object&&this.tweenToEnd&&(this.object.traverse(function(t){t instanceof THREE.Mesh&&(t.material=t.material_bak)}),this.tweenToEnd.stop())},VB.Device.prototype.ShowCSToolTip=function(){this.showAlways||0==this.icon.children.length||(this.point.visible=!0,this.line.visible=!0,this.icon.children.length>0&&(this.icon.children[0].element.style.visibility="visible"))},VB.Device.prototype.HideCSToolTip=function(){this.showAlways||0==this.icon.children.length||(this.point.visible=!1,this.line.visible=!1,this.icon.children.length>0&&(this.icon.children[0].element.style.visibility="hidden"))};var SHOWONLY_POI=0,SHOW_POI=1,HIDE_POI=2;VB.DeviceManager=function(t,e,i){this.orthoCamera=null,this.mainCamera=e,this.renderer=t,this.clear(),this.visible=!0,this.mouseOverObj=null,this.checkDepth,this.cellSize=50,this.poiCellDepthResult=[],this.tooltip_device=null,this.onMovePosition=i;var r=this.renderer.domElement.clientWidth,n=this.renderer.domElement.clientHeight;this.orthoCamera=new THREE.OrthographicCamera(0,r,0,n,-10,1e3),this.orthoCamera.updateProjectionMatrix();new THREE.Vector2,new THREE.Vector2;this.onLOD=!0;this.materials=[],this.moving},VB.DeviceManager.prototype.createTooltip=function(){this.tooltip_device=this.addDevice({layerName:"tooltip",id:99999,name:"",position:{x:0,y:0,z:1},width:0,height:0,icon:"",groupId:0,zindex:2,elevation:0,animation:!1}),this.tooltip_device.tooltip=!0},VB.DeviceManager.prototype.clearMaterial=function(){for(var t in this.materials){var e=this.materials[t];e.map&&e.map.dispose(),e.dispose()}this.materials=[]},VB.DeviceManager.prototype.resetSelection=function(){this.deviceScene.traverse(function(t){t instanceof VB.Device&&t.parent.visible&&t.DeviceSelected&&t.setDeselect()})},VB.DeviceManager.prototype.getSelectedList=function(){var t=new Array;return this.deviceScene.traverse(function(e){e instanceof VB.Device&&e.parent.visible&&e.DeviceSelected&&t.push(e)}),t},VB.DeviceManager.prototype.addMaterial=function(t){if(null!=t){var e=this.materials[t.id];null==e&&(e=new THREE.SpriteMaterial({map:VB.TextureUtils.load(t.textureUrl),color:null==t.color?16777215:t.color,fog:null==t.fog||t.fog}),this.materials[t.id]=e)}},VB.DeviceManager.prototype.clear=function(t){this.deviceScene=new THREE.Scene,this.deviceScene.name="DEVICES",t&&this.clearMaterial()},VB.DeviceManager.prototype.getIntersectObject=function(){var t=new THREE.Vector3(2*this.onMovePosition.x-1,-2*this.onMovePosition.y+1,-1);t.unproject(this.orthoCamera);var e=new THREE.Vector3;e.set(0,0,-1).transformDirection(this.orthoCamera.matrixWorld);var i=new THREE.Raycaster;return i.set(t,e),i.intersectObject(this.deviceScene,!0)},VB.DeviceManager.prototype.getIntersectPoi=function(){var t=new THREE.Vector3(2*this.onMovePosition.x-1,-2*this.onMovePosition.y+1,-1);t.unproject(this.orthoCamera);var e=new THREE.Vector3;e.set(0,0,-1).transformDirection(this.orthoCamera.matrixWorld);var i=new THREE.Raycaster;i.set(t,e);for(var r=i.intersectObject(this.deviceScene,!0),n=0;n<r.length;++n){if(r[n].object instanceof VB.Icon)if(r[n].object.parent.visible)if(null==this.getParentByProperty(r[n].object,"visible",!1,!0))return event.stopPropagation(),{id:r[n].object.parent.id,layerId:r[n].object.parent.parent.name,name:r[n].object.parent.name,device:r[n].object.parent}}return null},VB.DeviceManager.prototype.getLayer=function(t){return this.getLayerByProperty("name",t)},VB.DeviceManager.prototype.getLayerByProperty=function(t,e){var i;return this.deviceScene.traverse(function(r){r instanceof VB.Layer&&null!=r[t]&&r[t]===e&&(i=r)}),i},VB.DeviceManager.prototype.createLayer=function(t){var e=this.getLayerByProperty("name",t);return null==e&&((e=new VB.Layer).name=t,this.deviceScene.add(e)),e},VB.DeviceManager.prototype.removeLayerByProperty=function(t,e){var i=this.getLayerByProperty(t,e);null!=i&&this.removeLayer(i)},VB.DeviceManager.prototype.removeLayer=function(t){t.traverse(function(t){VB.Device}),t.parent&&t.parent.remove(t)},VB.DeviceManager.prototype.getDeviceByProperty=function(t,e){var i;return this.deviceScene.traverse(function(r){r instanceof VB.Device&&null!=r[t]&&r[t]===e&&(i=r)}),i},VB.DeviceManager.prototype.getDeviceByUserData=function(t,e){var i;return this.deviceScene.traverse(function(r){"DEVICE"===r.type&&null!=r.userData[t]&&r.userData[t]===e&&(i=r)}),i},VB.DeviceManager.prototype.addDevice=function(t){var e=t.layerName,i=this.createLayer(e),r=new VB.Device;return r.create(t),i.add(r),r},VB.DeviceManager.prototype.update=function(){if(!1!==this.visible){var t=this.renderer.autoClear;this.mainCamera.updateProjectionMatrix(),this.mainCamera.updateMatrixWorld();var e=new THREE.Frustum;(new THREE.Matrix4).multiplyMatrices(this.mainCamera.projectionMatrix,this.mainCamera.matrixWorldInverse),e.setFromMatrix((new THREE.Matrix4).multiplyMatrices(this.mainCamera.projectionMatrix,this.mainCamera.matrixWorldInverse));var i=this,r=new Array,n=new Array;if(this.tooltip_device){var o=this.getIntersectObject(),a=!1;for(u=0;u<o.length;u++)if(o[u].object.parent instanceof VB.Device&&!o[u].object.parent.tooltip){this.tooltip_device.tooltip_text=o[u].object.parent.tooltip_text,a=!0;break}if(o.length>0&&a){var s=new Array,h={text:this.tooltip_device.tooltip_text,size:12};s.push(h),this.tooltip_device.text.setText(s)}else this.tooltip_device.text.clearRect()}var l,c=this.tooltip_device;if(this.deviceScene.traverse(function(t){if(t instanceof VB.Device&&t.parent.visible&&t!=c){var o=t.pos3D.clone();o.project(i.mainCamera);var a=t.pos3D.clone();a.project(i.mainCamera),t&&(o.x=Math.round((o.x+1)*i.renderer.domElement.clientWidth/2),o.y=Math.round((1-o.y)*i.renderer.domElement.clientHeight/2),o.z=0,a.x=Math.round((a.x+1)*i.renderer.domElement.clientWidth/2),a.y=Math.round((1-a.y)*i.renderer.domElement.clientHeight/2),a.z=0),t.icon.position.set(o.x,o.y-t.icon.scale.y/2,t.zindex),t.text.sprite.position.copy(t.icon.position),t.text.sprite.position.y-=t.icon.scale.y/1.2,t.line.position.copy(o);var s=new THREE.Vector3(0,1,0).angleTo((new THREE.Vector3).subVectors(a,o).normalize());if(a.x==o.x&&a.y==o.y&&a.z==o.z&&(s=0),t.line.rotation.x=0,t.line.rotation.y=0,t.line.rotation.z=0,o.x<a.x&&(s=-s),t.line.rotateOnAxis(new THREE.Vector3(0,0,1),s),t.point.position.copy(a),t.point.scale.set(3,3,3),t.circle&&(t.circle.position.copy(a),t.circle.scale.set(3,3,3)),t.mixer){var h=t.clock.getDelta();t.mixer.update(h)}if(!0===i.onLOD)if(e.containsPoint(t.pos3D)){var l=t.pos3D.distanceTo(i.mainCamera.position),u=t.getLODByDistance(l);if(u){t.applyLOD(u),t.text.sprite.position.y=t.icon.position.y,t.text.sprite.position.y-=t.icon.scale.y/1.2;var p=new THREE.Vector3;p.subVectors(i.mainCamera.position,t.pos3D),p.normalize(),t.visible=!0,t.userData.poi_visible=!0,t.userData.meshContainer.visible=!0}else t.lod.length>0&&(r.push(t),n.push(t.visible),t.visible=!1,t.userData.poi_visible=!1,t.userData.meshContainer.visible=!1)}else i.moving!==t&&(r.push(t),n.push(t.visible),t.visible=!1,t.userData.poi_visible=!1)}}),this.tooltip_device)(l=i.onMovePosition.clone()).x=Math.round(i.onMovePosition.x*i.renderer.domElement.clientWidth),l.y=Math.round(i.onMovePosition.y*i.renderer.domElement.clientHeight),l.z=10,this.tooltip_device.text.sprite.position.set(l.x,l.y,l.z);if(this.moving)(l=this.moving.pos3D.clone()).project(i.mainCamera),l.x=Math.round(i.onMovePosition.x*i.renderer.domElement.clientWidth),l.y=Math.round(i.onMovePosition.y*i.renderer.domElement.clientHeight),l.z=0,this.moving.icon.position.set(l.x,l.y-this.moving.height/2,this.moving.zindex),this.moving.text.sprite.position.copy(this.moving.icon.position),this.moving.text.sprite.position.y-=this.moving.height/1.2,this.moving.text.sprite.position.z+=1;this.renderer.render(this.deviceScene,this.orthoCamera);for(var u=0;u<r.length;++u)r[u].visible=n[u];this.renderer.autoClear=t,this.composer&&this.composer.render()}},VB.DeviceManager.prototype.update2=function(){if(!1!==this.visible){var t=this.renderer.autoClear;this.renderer.autoClear=!1,this.renderer.clearDepth(),this.mainCamera.updateMatrix(),this.mainCamera.updateMatrixWorld();var e=new THREE.Frustum;(new THREE.Matrix4).multiplyMatrices(this.mainCamera.projectionMatrix,this.mainCamera.matrixWorldInverse),e.setFromMatrix((new THREE.Matrix4).multiplyMatrices(this.mainCamera.projectionMatrix,this.mainCamera.matrixWorldInverse));var i=this,r=new Array,n=new Array;if(this.deviceScene.traverse(function(t){if(t instanceof VB.Device){var o=t.pos3D.clone();o.project(i.mainCamera),t&&(o.x=Math.round((o.x+1)*i.renderer.domElement.clientWidth/2),o.y=Math.round((1-o.y)*i.renderer.domElement.clientHeight/2),o.z=0),t.icon.position.set(o.x,o.y-t.height/2,0),t.text.sprite.position.copy(t.icon.position),t.text.sprite.position.y-=t.height/1.2,t.text.sprite.position.z+=1,e.containsPoint(t.pos3D)||i.moving!==t&&(r.push(t),n.push(t.visible),t.visible=!1)}}),this.moving){var o=this.moving.pos3D.clone();o.project(i.mainCamera),o.x=Math.round(i.onMovePosition.x*i.renderer.domElement.clientWidth),o.y=Math.round(i.onMovePosition.y*i.renderer.domElement.clientHeight),o.z=0,this.moving.icon.position.set(o.x,o.y-this.moving.height/2,0),this.moving.text.sprite.position.copy(this.moving.icon.position),this.moving.text.sprite.position.y-=this.moving.height/1.2,this.moving.text.sprite.position.z+=1}this.renderer.render(this.deviceScene,this.orthoCamera);for(var a=0;a<r.length;++a)r[a].visible=n[a];this.renderer.autoClear=t}},VB.DeviceManager.prototype.show=function(t){this.visible=t},VB.DeviceManager.prototype.showLayer=function(t,e){for(var i=0;i<t.length;++i){var r=t[i],n=this.getLayerByProperty("name",r);n&&(n.visible=e)}},VB.DeviceManager.prototype.onResize=function(){this.orthoCamera.right=this.renderer.domElement.clientWidth,this.orthoCamera.bottom=this.renderer.domElement.clientHeight,this.orthoCamera.updateProjectionMatrix()},VB.DeviceManager.prototype.getBoundingBox=function(t,e){if(t){var i=new THREE.Box3;return i.setFromObject(t.userData.meshContainer),i}},VB.DeviceManager.prototype.getBoundingBoxByUserId=function(t,e){var i=this.getDeviceByUserData("id",t);if(i)return getBoundingBox(i)},VB.DeviceManager.prototype.getBoundingBoxByName=function(t){var e=this.getDeviceByProperty("name",t);if(e)return this.getBoundingBox(e)},VB.DeviceManager.prototype.moveObject=function(t,e,i){if(void 0===e&&(e=this.deviceScene),e.add(t),void 0!==i){var r=e.children.indexOf(i);e.children.splice(r,0,t),e.children.pop()}},VB.DeviceManager.prototype.removeDeviceByLayerName=function(t){var e=this.getLayerByProperty("name",t);if(e){for(var i=[],r=0;r<e.children.length;++r){var n=e.children[r];n instanceof VB.Device&&i.push(n)}for(r=0;r<i.length;++r)e.remove(i[r])}},VB.DeviceManager.prototype.removeDeviceByProperty=function(t,e){var i=this.getDeviceByProperty(t,e);i&&i.dispose()},VB.DeviceManager.prototype.getParentByProperty=function(t,e,i,r){var n,o=function(t,e){t&&(e(t),r&&o(t.parent,e))};return o(t.parent,function(t){t&&null!=t[e]&&t[e]===i&&(n=t)}),n},VB.DeviceManager.prototype.setMovingDevice=function(t){this.moving&&(this.moving.dispose(),this.moving=void 0),t&&(this.moving=this.addDevice({width:t.width,height:t.height,material:t.srcMaterial.icon,name:t.name,id:t.userData.id,position:{x:t.pos3D.x,y:t.pos3D.y,z:t.pos3D.z},layerName:"moving",zindex:2}))},VB.DeviceManager.prototype.setPoiData=function(t){this.deviceScene.traverse(function(e){e instanceof VB.Device&&e.parent.visible&&t(device.pos3D)})},VB.DeviceManager.prototype.load=function(t,e,i,r,n){var o=this;if(document.implementation&&document.implementation.createDocument){var a=new XMLHttpRequest;a.onreadystatechange=function(){if(4===a.readyState&&(0===a.status||200===a.status))if(a.responseXML)o.parse(t,e,a.responseXML,i,r);else if(a.responseText){var s=(new DOMParser).parseFromString(a.responseText,"application/xml");o.parse(t,s,i,r)}else n&&n()},a.open("GET",t,!0),a.send(null)}},VB.DeviceManager.prototype.parse=function(t,e,i,r,n){var o=i.evaluate?i:document,a=VB.TextureUtils.load(e),s=new THREE.SpriteMaterial({map:a,color:16777215,fog:!0}),h=o.evaluate("devices/floors/floor/entities/entity",i,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),l=h.iterateNext();for(0;l;){var c={layerName:"devices",id:99999,name:"",position:{x:0,y:0,z:1},width:0,height:0,icon:"",groupId:0,zindex:2,elevation:0,animation:!1,width:25,height:25,material:s};c.id=l.getAttribute("id"),c.name=l.getAttribute("id");var u=o.evaluate("center",l,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null).iterateNext();if(u){var p=u.textContent.split(" ");c.position.x=p[0],c.position.y=p[1],c.position.z=p[2]}var d=this.addDevice(c);r&&r(d,c),l=h.iterateNext()}},Text2D=function(t,e,i){this.width=256,this.height=64;var r=this.width,n=this.height;this.params=e,this.canvas=document.createElement("canvas"),this.canvas.width=r,this.canvas.height=n,this.context=this.canvas.getContext("2d");var o=.5*r,a=.5*n;if(e instanceof Array){for(var s=0,h=0;h<e.length;++h){if(void 0!==(u=e[h]).text){void 0===u.font&&(u.font=" "),void 0===u.size&&(u.size=12),void 0===u.margin&&(u.margin=h+1===e.length?0:5),void 0===u.color&&(u.color="#FFFFFF"),void 0===u.textAlign&&(u.textAlign="center"),void 0===u.textBaseline&&(u.textBaseline="top");var l=96*u.size/72;u.height=l,s+=l+u.margin}}var c=a-.5*s;this.context.textAlign=u.textAlign,this.context.textBaseline=u.textBaseline;for(h=0;h<e.length;++h){var u;void 0!==(u=e[h]).text&&(this.context.save(),this.context.font=u.size+"pt "+u.font,this.context.shadowBlur=4,this.context.shadowColor="black",this.context.strokeStyle="black",this.context.lineWidth=3,this.context.strokeText(u.text,o,c),this.context.shadowBlur=0,this.context.fillStyle=u.color,this.context.fillText(u.text,o,c),c+=u.height+u.margin,this.context.restore())}}this.texture=new THREE.Texture(this.canvas),this.texture.generateMipMaps=!1,this.texture.needsUpdate=!0,this.material=new THREE.SpriteMaterial({map:this.texture,depthTest:!1}),this.sprite=new THREE.Sprite(this.material),this.sprite.scale.set(r,n),this.sprite.position.set(i.x,i.y,i.z),t&&t.add(this.sprite)},Text2D.prototype.clearRect=function(){this.context.clearRect(0,0,this.width,this.height),this.texture.needsUpdate=!0},Text2D.prototype.setText=function(t){this.clearRect(),this.params=t;var e=.5*this.width,i=.5*this.height;if(t instanceof Array){for(var r=0,n=0;n<t.length;++n){if(void 0!==(s=t[n]).text){void 0===s.font&&(s.font=" "),void 0===s.size&&(s.size=12),void 0===s.margin&&(s.margin=n+1===t.length?0:5),void 0===s.color&&(s.color="#FFFFFF");var o=96*s.size/72;s.height=o,r+=o+s.margin}}var a=i-.5*r;this.context.textAlign="center",this.context.textBaseline="top";for(n=0;n<t.length;++n){var s;void 0!==(s=t[n]).text&&(this.context.save(),this.context.font=s.size+"pt "+s.font,this.context.shadowBlur=4,this.context.shadowColor="black",this.context.strokeStyle="black",this.context.lineWidth=3,this.context.strokeText(s.text,e,a),this.context.shadowBlur=0,this.context.fillStyle=s.color,this.context.fillText(s.text,e,a),a+=s.height+s.margin,this.context.restore())}}},Text2D.prototype.dispose=function(){this.texture.dispose(),this.material.dispose()},Text2DManager=function(t){this.textObjects=new Array,this.scene=t},Text2DManager.prototype.add=function(t,e){var i=new Text2D(this.scene,t,e);return this.textObjects.push(i),i},Text2DManager.prototype.remove=function(t){this.scene.remove(t.sprite);var e=this.textObjects.indexOf(t);-1!==e&&this.textObjects.splice(e,1)},Text2DManager.prototype.clear=function(){for(;this.textObjects.length>0;){var t=this.textObjects[0];this.remove(t)}},Text2DManager.prototype.update=function(t){for(var e=0;e<this.textObjects.length;++e){var i=this.textObjects[e],r=i.sprite.position.clone();r.sub(t.position);var n=r.length()/875;i.sprite.scale.set(i.width*n,i.height*n)}},VB.SBMLoader=function(t){this.manager=void 0!==t?t:THREE.DefaultLoadingManager,this.materials={},this.textures={},this.worker},VB.SBMLoader.prototype={constructor:VB.SBMLoader,load:function(t,e,i,r,n){var o=this,a=new XMLHttpRequest;a.open("GET",t,!0),a.responseType="arraybuffer",a.crossOrigin=this.crossOrgin,a.onreadystatechange=function(){if(4===this.readyState&&(200===this.status||304===this.status))if(null==o.worker){var t=o.parse(this.response,e,r,n);i&&i(t,e)}else o.parseWorker(this.response,e,r,i)},a.send(null)},parse:function(t,e,i,r){var n={totalModels:0,totalMaterials:0,loadedModels:0,loadedMaterials:0,totalSBMs:e.totalSBMs,currentSBMs:e.currentSBMs},o=new THREE.Object3D;o.userData.filesource=e.fileUrl,o.userData.id=e.id,o.userData.materials=[],o.userData.textures=[],null!=e.baseFloor&&(o.userData.baseFloor=e.baseFloor),o.name=e.name,e.position&&o.position.set(e.position.x||0,e.position.y||0,e.position.z||0);var a=new DataView(t),s=0,h=getAsciiString(t,s,8);if(s+=8,"SBM-----"!==h)throw r&&r(),"it's not sbm file.";var l=a.getUint8(s);if(s+=1,l>4)throw"sbm version is wrong.";if(l>3){a.getUint8(s);s+=1;a.getUint16(s);s+=2;a.getUint16(s);s+=2;a.getUint16(s);s+=2;a.getUint16(s);s+=2}var c=a.getUint16(s,!0);s+=2;var u=a.getUint16(s,!0);if(s+=2,n.totalModels=u,n.totalMaterials=c,l>3){a.getUint8(s);s+=1;a.getUint8(s);s+=1}for(var p=0;p<c;++p){var d=l>3?a.getUint32(s,!0):a.getUint16(s,!0);if(s+=l>3?4:2,l>3){a.getUint8(s);s+=1}a.getFloat32(s,!0);s+=4;a.getFloat32(s,!0);s+=4;a.getFloat32(s,!0);s+=4;a.getFloat32(s,!0);s+=4;var f=a.getFloat32(s,!0);s+=4;var m=a.getFloat32(s,!0);s+=4;var g=a.getFloat32(s,!0);s+=4;var v=a.getFloat32(s,!0);s+=4;a.getFloat32(s,!0);s+=4;a.getFloat32(s,!0);s+=4;a.getFloat32(s,!0);s+=4;a.getFloat32(s,!0);s+=4;var y=a.getUint8(s,!0);s+=1;var E=0;0===y?E=THREE.FrontSide:1===y?E=THREE.BackSide:2===y&&(E=THREE.DoubleSide);var x=a.getUint16(s,!0);s+=2;var _=null;if(x>0){for(var w=t.slice(s,s+x),b="",S="",T=new Uint8Array(w,0,x),M=0;M<x;++M)T[M]>127?S=S+"%"+T[M].toString(16).toUpperCase():(b+=String.fromCharCode(T[M]),S="");s+=x,b=b.replace("\\","/");var R=null;if(e.textureUrl){if(e.textureUrl.toString().length){var A=b;-1!==(C=A.lastIndexOf("/"))&&(A=A.substr(C+1,A.length-C+1)),R=e.textureUrl+A}}else{var C,P=b.lastIndexOf("/");-1!==P&&(b="Maps/"+b.substr(P+1)),R=-1!==(C=(R=e.fileUrl).lastIndexOf("/"))?R.substr(0,C+1)+b:b}this.textures[R]?_=this.textures[R]:((_=VB.TextureUtils.load(R)).name=b,this.textures[R]=_,o.userData.textures.push(R)),_.wrapS=THREE.RepeatWrapping,_.wrapT=THREE.RepeatWrapping,_.flipY=!1,e.anisotropy&&(_.anisotropy=e.anisotropy)}var D=this.materials[d.toString()];if(null==D){var L=v<1;(D=new THREE.MeshPhongMaterial({color:new THREE.Color(f,m,g),opacity:v,transparent:L,map:_,side:E,alphaTest:L?.01:.5,shininess:50,specular:328965,needsUpdate:!0})).name=d.toString(),this.materials[d.toString()]=D,o.userData.materials.push(D.uuid)}n.loadedMaterials++,i&&i(n)}for(p=0;p<u;++p){d=String(l>3?a.getUint32(s,!0):a.getUint16(s,!0));if(s+=l>3?4:2,l>2){var O=a.getUint16(s,!0);s+=2;_=null;if(O>0){for(w=t.slice(s,s+O),S="",T=new Uint8Array(w,0,O),M=0;M<O;++M)T[M]>127?S=S+"%"+T[M].toString(16).toUpperCase():(S.length&&decodeURIComponent(S),String.fromCharCode(T[M]),S="");s+=O}}if(l>3){a.getUint16(s,!0);s+=2;a.getUint16(s,!0);s+=2}var H=l>3?a.getUint32(s,!0):a.getUint16(s,!0);s+=l>3?4:2;var I=new THREE.Geometry,B=l>2?a.getUint32(s,!0):a.getUint16(s,!0);if(s+=l>2?4:2,l>3){a.getUint8(s,!0);s+=1}if(B>0)for(var z=0;z<B;++z){var N=new THREE.Vector3;N.x=a.getFloat32(s,!0),s+=4,N.y=a.getFloat32(s,!0),s+=4,N.z=a.getFloat32(s,!0),s+=4,N.multiplyScalar(e.scale),I.vertices.push(N)}var k=l>2?a.getUint32(s,!0):a.getUint16(s,!0);if(s+=l>2?4:2,l>3){a.getUint8(s,!0);s+=1}if(k>0)for(var j=0;j<k;++j){var V=new THREE.Vector3;V.x=a.getFloat32(s,!0),s+=4,V.y=a.getFloat32(s,!0),s+=4,V.z=a.getFloat32(s,!0),s+=4}var F=l>2?a.getUint32(s,!0):a.getUint16(s,!0);if(s+=l>2?4:2,l>3){a.getUint8(s,!0);s+=1}var U=new Array(F);if(F>0)for(var G=0;G<F;++G){var W=new THREE.Vector2;W.x=a.getFloat32(s,!0),s+=4,W.y=a.getFloat32(s,!0),s+=4,U[G]=W}var X=l>2?a.getUint32(s,!0):a.getUint16(s,!0);if(s+=l>2?4:2,l>3){a.getUint8(s,!0);s+=1;a.getUint8(s,!0);s+=1}if(X>0)for(var Z=0;Z<X;++Z){var Y=new THREE.Face3;Y.a=l>2?a.getUint32(s,!0):a.getUint16(s,!0),s+=l>2?4:2,Y.b=l>2?a.getUint32(s,!0):a.getUint16(s,!0),s+=l>2?4:2,Y.c=l>2?a.getUint32(s,!0):a.getUint16(s,!0),s+=l>2?4:2,I.faces.push(Y),U.length>0&&I.faceVertexUvs[0].push([U[Y.a],U[Y.b],U[Y.c]])}I.computeBoundingSphere(),I.computeBoundingBox(),I.computeVertexNormals(!0),I.computeFaceNormals();var q=I;if(e.useBufferGeometry&&((q=new THREE.BufferGeometry).fromGeometry(I),q.boundingBox=I.boundingBox.clone()),this.materials[H.toString()]){var J=new THREE.Mesh(q,this.materials[H.toString()]);J.userData.id=d,J.name=d,J.castShadow=!0,J.receiveShadow=!0,o.add(J)}n.loadedModels++,i&&i(n)}return o},parseWorker:function(t,e,i,r){var n=this,o={totalModels:0,totalMaterials:0,loadedModels:0,loadedMaterials:0,totalSBMs:e.totalSBMs,currentSBMs:e.currentSBMs},a=new THREE.Object3D;a.userData.filesource=e.fileUrl,a.userData.id=e.id,a.userData.materials=[],a.userData.textures=[],null!=e.baseFloor&&(a.userData.baseFloor=e.baseFloor),a.name=e.name;var s=new Worker(this.worker);s.onmessage=function(t){if("progress"===t.data.msg)i&&i(t.data.val);else if("finish"===t.data.msg)r&&r(a,e),s.terminate();else if("debug"===t.data.msg);else if("material"===t.data.msg){var o=n.getTexture(t.data.texture.textureUrl,t.data.texture.textureName,e.anisotropy,a),h=n.materials[t.data.material.id];null==h&&(h=n.createMaterial(t.data.material,o,a))}else if("mesh"===t.data.msg){for(var l=new THREE.Geometry,c=t.data.geom.vertices,u=0;u<c.length;++u){var p=new THREE.Vector3(c[u][0],c[u][1],c[u][2]);p.multiplyScalar(e.scale),l.vertices.push(p)}var d=t.data.geom.texcoords,f=t.data.geom.indices;for(u=0;u<f.length;++u){var m=new THREE.Face3;m.a=f[u][0],m.b=f[u][1],m.c=f[u][2],l.faces.push(m),d.length>0&&l.faceVertexUvs[0].push([new THREE.Vector2(d[m.a][0],d[m.a][1]),new THREE.Vector2(d[m.b][0],d[m.b][1]),new THREE.Vector2(d[m.c][0],d[m.c][1])])}l.computeBoundingSphere(),l.computeBoundingBox(),l.computeVertexNormals(!0),l.computeFaceNormals();var g=l;e.useBufferGeometry&&((g=new THREE.BufferGeometry).fromGeometry(l),g.boundingBox=l.boundingBox.clone());var v=t.data.mat_id,y=t.data.id;if(n.materials[v.toString()]){var E=new THREE.Mesh(g,n.materials[v.toString()]);E.userData.id=y,E.name=y,E.castShadow=!0,E.receiveShadow=!0,a.add(E)}}};var h={progress:o,sbmInfo:e,data:t};s.postMessage(h)},getTexture:function(t,e,i,r){var n;return null!=t&&null==(n=this.textures[t])&&((n=VB.TextureUtils.load(t)).name=e,this.textures[t]=n,r.userData.textures.push(t),n.wrapS=THREE.RepeatWrapping,n.wrapT=THREE.RepeatWrapping,n.flipY=!1,i&&(n.anisotropy=i)),n},createMaterial:function(t,e,i){var r=THREE.FrontSide;if(1===t.side?r=THREE.BackSide:2===t.side&&(r=THREE.DoubleSide),e.sourceFile)var n=d3<1,o=new THREE.MeshPhongMaterial({color:new THREE.Color(t.d[0],t.d[1],t.d[2]),opacity:t.opacity,transparent:n,map:e,side:r,alphaTest:.5,shininess:50,specular:328965,needsUpdate:!0});else n=d3<1,o=new THREE.MeshPhongMaterial({color:new THREE.Color(t.d[0],t.d[1],t.d[2]),opacity:t.opacity,transparent:n,side:r,alphaTest:.5,shininess:50,specular:328965,needsUpdate:!0});return o.name=t.id.toString(),this.materials[o.name]=o,i.userData.materials.push(o.uuid),o}},VB.TopologyManager=function(t,e,i){this.dijkstras=new Dijkstras,this.cameraObject,this.camera,this.cameraHelper,this.enableAutoLookAt=!0,this.path,this.DriveMode=VB.TopologyManager.CameraMove,this.DrivePoi,this.mapPostRender=i,this.restrict_bit=0,this.mainRender,this.pauseState=!1;var r,n,o=this;o.camera=new THREE.PerspectiveCamera(84,e.domElement.clientWidth/e.domElement.clientHeight,10,1e5),o.cameraObject=new THREE.Object3D,o.cameraObject.add(o.camera),o.cameraHelper=new THREE.CameraHelper(o.camera),o.cameraHelper.visible=!1,r=new THREE.Vector3,n=new THREE.Vector3;var a,s=0,h=new THREE.Vector3,l=new THREE.Vector3,c=!1,u=0;this.cameraElevation=150,this.speed=120,this.render=function(){t.scene.updateMatrixWorld(),e.clear(),!1===e.autoClear&&e.clearDepth();var i=o.cameraElevation,a=1/(o.path.parameters.path.getLength()/(o.speed/32))*s;if(a<1){!1===o.pauseState&&s++;var p=o.path.parameters.path.getPointAt(a),d=o.path.tangents.length,f=a*d,m=Math.floor(f),g=(m+1)%d;r.subVectors(o.path.binormals[g],o.path.binormals[m]),r.multiplyScalar(f-m).add(o.path.binormals[m]);var v=o.path.parameters.path.getTangentAt(a);n.set(0,1,0),p.add(n.clone().multiplyScalar(i)),o.camera.position.copy(p);var y=a+o.speed/o.path.parameters.path.getLength();y>1?y=1:y%=1;var E=o.path.parameters.path.getPointAt(y);E.add(v.multiplyScalar(0)),E.add(n.clone().multiplyScalar(140));var x=1-Math.abs(o.path.parameters.path.getTangentAt(y).y)<1e-5||1-Math.abs(o.path.parameters.path.getTangentAt(a).y)<1e-5;if(x||1===y){if(E.copy(l).add((new THREE.Vector3).subVectors(p,h)),x)if(!1===c&&0===u)c=!0;else if(c){var _=new THREE.Vector3;_.copy(p),_.y=E.y,E.subVectors(E,_),E.applyAxisAngle(new THREE.Vector3(0,1,0),5*Math.PI/180),E.addVectors(E,_),u+=5*Math.PI/180,Math.abs(u-Math.PI)<1e-5&&(c=!1)}}else c=!1,u=0;if(l.copy(E),h.copy(p),this.DriveMode==VB.TopologyManager.DriveMode.CameraMove)this.enableAutoLookAt&&(o.camera.matrix.lookAt(o.camera.position,E,n),o.camera.rotation.setFromRotationMatrix(o.camera.matrix,o.camera.rotation.order),o.cameraHelper.update());else{var w=new THREE.Vector3;w.x=p.x-this.DrivePoi.pos3D.x,w.y=p.y-this.DrivePoi.pos3D.y,w.z=p.z-this.DrivePoi.pos3D.z,this.DrivePoi.pos3D.set(p.x,p.y,p.z),t.camera.position.x+=w.x,t.camera.position.y+=w.y,t.camera.position.z+=w.z}}if(this.DriveMode==VB.TopologyManager.DriveMode.CameraMove)e.render(t.scene,o.camera);else for(var b in e.render(t.scene,t.camera),o.mapPostRender.map)o.mapPostRender.map[b]()},VB.TopologyManager.prototype.setCameraPos=function(t,e){const i=e.fov*Math.PI/180,r=t/Math.tan(i/2),n=Math.sqrt(Math.pow(r,2)+Math.pow(r,2));e.position.set(n,n,n)},VB.TopologyManager.prototype.start=function(){if(null!=this.path){0===s&&(t.scene.add(this.cameraObject),t.scene.add(this.cameraHelper));var e=this;a=requestAnimationFrame(function(){e.start()}),this.render()}},VB.TopologyManager.prototype.stop=function(){-1!==a&&window.cancelAnimationFrame(a),a=-1,s=0,t.scene.remove(o.cameraHelper)},VB.TopologyManager.prototype.pause=function(){this.pauseState=!this.pauseState},VB.TopologyManager.prototype.onResize=function(){this.camera.aspect=e.domElement.clientWidth/e.domElement.clientHeight,this.camera.updateProjectionMatrix()},VB.TopologyManager.prototype.getPath=function(t,e,i){var r=this.dijkstras.getPath(e,i),n=new THREE.CurvePath,o=t.getObjectByProperty("gmlid",e),a=t.getObjectByProperty("gmlid",r[0]);n.add(new THREE.LineCurve3(o.getWorldPosition(),a.getWorldPosition()));for(var s=0;s<r.length-1;++s){var h=r[s],l=r[s+1],c=t.getObjectByProperty("gmlid",h),u=t.getObjectByProperty("gmlid",l);c&&u&&n.add(new THREE.LineCurve3(c.getWorldPosition(),u.getWorldPosition()))}var p=new THREE.TubeGeometry(n,265,5,8,!1),d=new THREE.MeshBasicMaterial({color:65331,wireframe:!1,transparent:!0,opacity:1});return new THREE.Mesh(p,d)},VB.TopologyManager.prototype.getPaths=function(t,e){if(!(e.length<2)){for(var i=new THREE.CurvePath,r=0;r<e.length-1;++r){var n=this.dijkstras.getPath(e[r],e[r+1]);if(n.length){var o=t.getObjectByProperty("gmlid",e[r]),a=t.getObjectByProperty("gmlid",n[0]);i.add(new THREE.LineCurve3(o.getWorldPosition(),a.getWorldPosition()));for(var s=0;s<n.length-1;++s){var h=n[s],l=n[s+1],c=t.getObjectByProperty("gmlid",h),u=t.getObjectByProperty("gmlid",l);c&&u&&i.add(new THREE.LineCurve3(c.getWorldPosition(),u.getWorldPosition()))}}}if(i.curves.length){var p=new THREE.TubeGeometry(i,32,10,16,!1);new THREE.SubdivisionModifier(.1).modify(p);var d=new THREE.MeshBasicMaterial({color:65331,wireframe:!1,transparent:!1,opacity:1}),f=new THREE.Mesh(p,d);return f.userData.type="pathcurve",f}}}},VB.TopologyManager.prototype.updateLink=function(t,e){t.traverse(function(t){t instanceof VB.Node&&t.updateLink(e)})},VB.TopologyManager.prototype.clear=function(){this.path=void 0},VB.TopologyManager.prototype.setLink=function(t,e,i,r,n){var o=t.getObjectByProperty("gmlid",e),a=t.getObjectByProperty("gmlid",i);if(void 0!==o&&void 0!==a&&3!==n){if(void 0===n||0===n||1===n)o.addLink(a).restrict=r;if(void 0===n||0===n||2===n)a.addLink(o).restrict=r}},VB.TopologyManager.prototype.makeGraph=function(t){var e=[];t.traverse(function(t){if(t instanceof VB.Node){var i=t.makeGraph();e.push(i)}}),this.dijkstras.setGraph(e)},VB.TopologyManager.prototype.showPath=function(t){},VB.TopologyManager.prototype.addImmediateNode=function(t){},VB.TopologyManager.prototype.makeLink=function(t,e){var i=t.getObjectByProperty("gmlid",e.source),r=t.getObjectByProperty("gmlid",e.target),n=i.position,o=r.position,a=n.distanceTo(o),s=new THREE.Vector3;s.subVectors(o,n),s.normalize();var h=e.material,l=new VB.Link(VB.LinkGeometry,h);l.gmlid=e.gmlid,l.userData.id=e.gmlid,l.name=e.name,l.userData.thickness=e.thickness,l.userData.restrict=e.restrict;var c=new THREE.Vector3(1,0,0),u=(new THREE.Quaternion).setFromUnitVectors(c,s),p=(new THREE.Matrix4).makeRotationFromQuaternion(u);return l.applyMatrix(p),l.scale.x=a,l.scale.z=e.radius,l.scale.y=e.radius,l.position.copy(n),l},VB.TopologyManager.DriveMode={CameraMove:0,"PoiMove : ":1},function(){var t=new THREE.CylinderGeometry(1,1,1,8);t.applyMatrix((new THREE.Matrix4).makeRotationZ(torad(-90))),t.applyMatrix((new THREE.Matrix4).makeTranslation(.5,0,0)),t.computeBoundingBox(),VB.LinkGeometry=new THREE.BufferGeometry,VB.LinkGeometry.fromGeometry(t),VB.LinkGeometry.boundingBox=t.boundingBox.clone(),VB.LinkMaterial={available:new THREE.MeshBasicMaterial({color:65280,wireframe:!1}),impossibility:new THREE.MeshBasicMaterial({color:16711680,wireframe:!1})}}(),VB.Link=function(t,e){THREE.Mesh.call(this,t,e),this.gmlid},VB.Link.prototype=Object.create(THREE.Mesh.prototype),VB.Link.prototype.constructor=VB.Link,function(){var t=new THREE.SphereGeometry(10,32,32);t.computeBoundingBox(),VB.NodeGeometry=new THREE.BufferGeometry,VB.NodeGeometry.fromGeometry(t),VB.NodeGeometry.boundingBox=t.boundingBox.clone(),VB.NodeMaterial=new THREE.MeshBasicMaterial({color:255,wireframe:!1})}(),VB.Node=function(t,e){THREE.Mesh.call(this,t,e),this.gmlid,this.floorId,this.links=new SoonMap,VB.Node.prototype.addLink=function(t){if(!this.links.containsKey(t.gmlid)){var e=this.position.distanceTo(t.position),i=new VB.Node.Link(t.gmlid,e);return this.links.put(t.gmlid,i),i}},VB.Node.prototype.updateLink=function(t){for(var e in this.links.map){var i=this.links.map[e];i.enable=(t&i.restrict)===i.restrict,(0===t&&1!==i.restrict||1!==t&&0===i.restrict)&&(i.enable=!0)}},VB.Node.prototype.makeGraph=function(){var t=[];t.push(this.gmlid);var e=[];for(var i in this.links.map){var r=this.links.map[i];r.enable&&e.push(r.makeGraph())}return t.push(e),t}},VB.Node.prototype=Object.create(THREE.Mesh.prototype),VB.Node.prototype.constructor=VB.Node,VB.Node.Link=function(t,e){this.targetNodeId=t,this.weight=e,this.enable=!0,this.restrict=0},VB.Node.Link.prototype.makeGraph=function(){var t=[];return t.push(this.targetNodeId),t.push(this.weight),t};var Dijkstras=function(){var t=function(){this.graph=[],this.queue,this.distance=[],this.previous=[]};t.prototype.setGraph=function(t){if("object"!=typeof t)throw"graph isn't an object ("+typeof t+")";if(t.length<1)throw"graph is empty";for(var e in t){var i=t[e];if("object"!=typeof i||2!==i.length)throw"node must be an array and contain 2 values (name, vertices). Failed at index: "+e;var r=i[0],n=i[1];for(var o in this.graph[r]=[],n){var a=n[o];if("object"!=typeof a||2!==a.length)throw"vertex must be an array and contain 2 values (name, vertices). Failed at index: "+e+"["+o+"]";var s=a[0],h=a[1];this.graph[r][s]=h}}},t.prototype.getPath=function(t,i){if(void 0===this.graph[t])throw"source "+t+" doesn't exist";if(void 0===this.graph[i])throw"target "+i+" doesn't exist";if(t===i)return[];this.queue=new e,this.queue.add(t,0),this.previous[t]=null;for(var r=null;r=this.queue.shift();){if(r===i){for(var n=[];null!=this.previous[r];)n.unshift(r),r=this.previous[r];return n}if(this.queue.getDistance(r)==1/0)return[];var o=this.queue.getDistance(r);for(var a in this.graph[r]){var s=this.queue.getDistance(a),h=o+this.graph[r][a];h<s&&(this.queue.update(a,h),this.previous[a]=r)}}return[]};var e=function(){var t=function(){this.min=null,this.roots=[],this.nodes=[]};return t.prototype.shift=function(){var t=this.min;if(null==t||this.roots.length<1)return this.min=null,t;this.remove(t),this.roots.length>50&&this.consolidate();for(var e=1/0,i=this.roots.length,r=0;r<i;r++){var n=this.roots[r],o=this.getDistance(n);o<e&&(e=o,this.min=n)}return t},t.prototype.consolidate=function(){for(var t=[[],[],[],[],[],[],[]],e=t.length-1,i=this.roots.length,r=0;r<i;r++){var n=this.roots[r];(o=this.nodes[n].depth)<e&&t[o].push(n)}for(var o=0;o<=e;o++)for(;t[o].length>1;){var a=t[o].shift(),s=t[o].shift(),h=o+1,l=-1;this.nodes[a].distance<this.nodes[s].distance?(this.nodes[a].depth=h,this.nodes[a].children.push(s),this.nodes[s].parent=a,h<=e&&t[h].push(a),l=this.roots.indexOf(s)):(this.nodes[s].depth=h,this.nodes[s].children.push(a),this.nodes[a].parent=s,h<=e&&t[h].push(s),l=this.roots.indexOf(a)),l>-1&&this.roots.splice(l,1)}},t.prototype.add=function(t,e){this.nodes[t]={node:t,distance:e,depth:0,parent:null,children:[]},(!this.min||e<this.nodes[this.min].distance)&&(this.min=t),this.roots.push(t)},t.prototype.update=function(t,e){this.remove(t),this.add(t,e)},t.prototype.remove=function(t){if(this.nodes[t]){var e=this.nodes[t].children.length;if(e>0)for(var i=0;i<e;i++){var r=this.nodes[t].children[i];this.nodes[r].parent=this.nodes[t].parent,null==this.nodes[r].parent&&this.roots.push(r)}var n=this.nodes[t].parent;if(null==n){var o=this.roots.indexOf(t);o>-1&&this.roots.splice(o,1)}else for(;n;)this.nodes[n].depth--,n=this.nodes[n].parent}},t.prototype.getDistance=function(t){return this.nodes[t]?this.nodes[t].distance:1/0},t}();return t}();VB.GMLLoader=function(t){this.topologyManager=t,this.option={fittingOrign:!1,orign:{x:0,y:0,z:0},makeToplogyMesh:!0}},VB.GMLLoader.prototype={constructor:VB.GMLLoader,load:function(t,e,i,r){var n=this;if(document.implementation&&document.implementation.createDocument){var o=new XMLHttpRequest;o.onreadystatechange=function(){if(4===o.readyState&&(0===o.status||200===o.status))if(o.responseXML)n.parse(t,o.responseXML,e,i);else if(o.responseText){var a=(new DOMParser).parseFromString(o.responseText,"application/xml");n.parse(t,a,e,i)}else r&&r()},o.open("GET",t,!0),o.overrideMimeType("application/xml"),o.send(null)}},parse:function(t,e,i,r){var n=this,o=!1,a=new THREE.Object3D,s=function(t){if(t.children)for(var e=t.children,i=0;i<e.length;++i){var r=e[i];if("zcoord"===r.tagName)"true"===r.getElementsByTagName("apply_floorheight")[0].firstChild.nodeValue&&(o=!0);else r.tagName}else for(var a=t.firstElementChild;a;){if("zcoord"===a.tagName)"true"===a.getElementsByTagName("apply_floorheight")[0].firstChild.nodeValue&&(o=!0);else if("restrict"===a.tagName){var s=a.getElementsByTagName("restrict_bit");n.topologyManager.restrict_bit=parseInt(s[0].firstChild.nodeValue)}a=a.nextElementSibling}},h=function(t){function e(t,i,r){if(0===t.children.length)return i;for(var n=t.children,o=0,a=n.length;o<a;o++)n[o].tagName===r?i.push(n[o]):e(n[o],i,r)}for(var i=t.getElementsByTagName("X_floor"),r=0;r<i.length;++r){var s=new THREE.Object3D,h=i[r],l=parseInt(h.getAttribute("number")),c=parseInt(h.getAttribute("level")),u=h.getAttribute("id");nodeName="gml:Node";var p=h.getElementsByTagName(nodeName);0===p.length&&e(h,p=[],"gml:Node");for(var d=0;d<p.length;++d){var f=new VB.Node(VB.NodeGeometry,VB.NodeMaterial),m=p[d];f.gmlid=m.getAttribute("gml:id"),f.userData.id=m.getAttribute("gml:id");var g=m.getElementsByTagName("type");f.userData.type=parseInt(g[0].firstChild.nodeValue),/Trident/i.test(navigator.userAgent)?(f.position.x=parseInt(m.getElementsByTagName("xcoord")[0].firstChild.wholeText),f.position.z=-1*parseInt(m.getElementsByTagName("ycoord")[0].firstChild.wholeText),f.position.y=parseInt(m.getElementsByTagName("zcoord")[0].firstChild.wholeText)+5):(f.position.x=parseInt(m.getElementsByTagName("xcoord")[0].firstChild.nodeValue),f.position.z=-1*parseInt(m.getElementsByTagName("ycoord")[0].firstChild.nodeValue),f.position.y=parseInt(m.getElementsByTagName("zcoord")[0].firstChild.nodeValue)+5),!1===o&&(f.position.z+=c),s.add(f)}s.userData.baseFloor=l,s.userData.id=u,s.userData.type="floor",a.add(s)}for(r=0;r<i.length;++r){s=a.children[r];var v=(h=i[r]).getElementsByTagName("Transition");for(d=0;d<v.length;++d){var y=v[d],E=y.getAttribute("gml:id");nodeName="gml:directedNode";var x,_,w=y.getElementsByTagName(nodeName);if(0===w.length&&e(y,w=[],"gml:directedNode"),2===w.length){x=w[0].getAttribute("xlink:href"),_=w[1].getAttribute("xlink:href");var b,S=y.getElementsByTagName("restrict"),T=parseInt(S[0].firstChild.nodeValue),M=y.getElementsByTagName("length"),R=(parseInt(M[0].firstChild.nodeValue),y.getElementsByTagName("link_name"));R[0].firstChild&&(b=R[0].firstChild.nodeValue);var A,C=y.getElementsByTagName("Width");if(C.length>0&&C[0].firstChild&&(A=parseInt(C[0].firstChild.nodeValue)),n.topologyManager.setLink(a,x,_,T),n.option.makeToplogyMesh){var P={gmlid:E,source:x,target:_,radius:5,thickness:A,material:1===T?VB.LinkMaterial.impossibility:VB.LinkMaterial.available,name:b,restrict:T},D=n.topologyManager.makeLink(a,P);s.add(D)}}}}},l=e.firstChild;if("MultiLayeredGraph"===l.tagName)if(l.children)for(var c=l.children,u=0;u<c.length;++u){var p=c[u];"X_definition"===p.tagName?s(p):"SpaceLayerMember"===p.tagName&&h(p)}else for(var d=l.firstElementChild;d;)"X_definition"===d.tagName?s(d):"SpaceLayerMember"===d.tagName&&h(d),d=d.nextElementSibling;n.topologyManager.updateLink(a),i&&i(a)}},VB.Toolbar=function(t,e){var r=new UI.Panel,n=t;this.container=r,r.setId("toolbar"),r.dom.style.position="absolute",e.horizontal||(r.dom.style.width="24px"),r.dom.style.top=e.pos_top,r.dom.style.right=e.pos_right,r.dom.style.zIndex=100;var o=new UI.Panel;r.add(o);var a,s=!0;for(showAll=function(){for(i=1;i<o.dom.children.length;i++)o.dom.children[i].style.visibility="visible";o.dom.children[0].src="../image/showtoolbar.png",s=!0},hideAll=function(){for(i=1;i<o.dom.children.length;i++)o.dom.children[i].style.visibility="hidden";o.dom.children[0].src="../image/hidetoolbar.png",s=!1},a=new UI.Image("../image/showtoolbar.png").onClick(function(){s?hideAll():showAll()}),o.add(a),o.add(new UI.HorizontalRule),e.button_home&&(a=new UI.Image("../image/home.png").onClick(function(){var t=n.getSceneBoundingBox(!1);n.setViewpoint(VIEWPOINT.RIGHTTOP,t.min,t.max,!1)}),o.add(a),e.button_rotate&&o.add(new UI.HorizontalRule)),e.button_rotate&&(a=new UI.Image("../image/rotate_left.png").onClick(function(){n.rotate(new THREE.Vector3(-.2,0,0))}),o.add(a),a=new UI.Image("../image/rotate_right.png").onClick(function(){n.rotate(new THREE.Vector3(.2,0,0))}),o.add(a),e.button_sideview&&o.add(new UI.HorizontalRule)),e.button_sideview&&(a=new UI.Image("../image/zoomin.png").onClick(function(){n.getSceneBoundingBox(!1);n.zoom(-100)}),o.add(a),a=new UI.Image("../image/zoomout.png").onClick(function(){n.getSceneBoundingBox(!1);n.zoom(100)}),o.add(a),o.add(new UI.HorizontalRule),a=new UI.Image("../image/left_side.png").onClick(function(){var t=n.getSceneBoundingBox(!1);n.setViewpoint(VIEWPOINT.LEFT,t.min,t.max,!1)}),o.add(a),a=new UI.Image("../image/right_side.png").onClick(function(){var t=n.getSceneBoundingBox(!1);n.setViewpoint(VIEWPOINT.RIGHT,t.min,t.max,!1)}),o.add(a),a=new UI.Image("../image/front_side.png").onClick(function(){var t=n.getSceneBoundingBox(!1);n.setViewpoint(VIEWPOINT.FRONT,t.min,t.max,!1)}),o.add(a),a=new UI.Image("../image/back_side.png").onClick(function(){var t=n.getSceneBoundingBox(!1);n.setViewpoint(VIEWPOINT.BACK,t.min,t.max,!1)}),o.add(a),a=new UI.Image("../image/up_side.png").onClick(function(){var t=n.getSceneBoundingBox(!1);n.setViewpoint(VIEWPOINT.TOP,t.min,t.max,!1)}),o.add(a)),i=1;i<o.dom.children.length;i++)o.dom.children[i].src&&(o.dom.children[i].addEventListener("mouseover",h),o.dom.children[i].addEventListener("mouseout",l));function h(t){var e=t.target.src.replace(".png","_over.png");t.target.src=e}function l(t){var e=t.target.src.replace("_over.png",".png");t.target.src=e}return this},VB.GKXMLLoader=function(t){this.onPluginParser=function(t){},t&&(this.onPluginParser=t),this.resourceManager={textures:void 0,materials:void 0,geometries:void 0}},VB.GKXMLLoader.prototype={constructor:VB.GKXMLLoader,setResoucreManager:function(t,e,i){this.resourceManager.textures=t,this.resourceManager.materials=e,this.resourceManager.geometries=i},load:function(t,e,i,r,n){var o=this;if(document.implementation&&document.implementation.createDocument){var a=new XMLHttpRequest;a.onreadystatechange=function(){if(4===a.readyState&&(0===a.status||200===a.status))if(a.responseXML)o.parse(t,a.responseXML,e,i,r);else if(a.responseText){var s=(new DOMParser).parseFromString(a.responseText,"application/xml");o.parse(t,s,e,i,r)}else n&&n()},a.open("GET",t,!0),a.send(null)}},parse:function(t,e,i,r,n){var o=this,a=0,s=0,h=new THREE.Object3D;h.userData.boundingBox=new THREE.Box3;for(var l=e.evaluate?e:document,c=l.evaluate("count(Project/Building/Floors/Floor)",e,null,XPathResult.ANY_TYPE,null).numberValue,u=l.evaluate("Project/Building/Floors/Floor/FileSource",e,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),p=u.iterateNext();p;){var d={id:null,name:null,fileUrl:null,useBufferGeometry:!0,scale:1,totalSBMs:c,currentSBMs:a++};o.resourceManager.textures&&(d.textures=o.resourceManager.textures),d.id=p.parentNode.getAttribute("id"),d.name=p.parentNode.getAttribute("name");var f=p.getAttribute("name"),m=f.lastIndexOf("\\");-1!==m&&(f=f.substr(m+1));var g="";-1!==(m=t.lastIndexOf("/"))&&(g=t.substr(0,m+1)),d.fileUrl=g+f;var v=new VB.SBMLoader;v.worker=n,v.load(d.fileUrl,d,function(t,r){var n=new SoonMap;t.traverse(function(t){t instanceof THREE.Mesh&&n.put(t.userData.id,t)});for(var a=(e.evaluate?e:document).evaluate("Project/Building/ObjectHierarchy/Entity[@id='"+r.id+"']",e,null,XPathResult.ANY_UNORDERED_NODE_TYPE,null).singleNodeValue,u=(e.evaluate?e:document).evaluate("Entity",a,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),p=u.iterateNext();p;){var d=n.get(p.getAttribute("id"));d&&(d.userData.name=p.getAttribute("name"),d.userData.longname=p.getAttribute("longname"),d.userData.type=p.getAttribute("type"),d.userData.posX=p.getAttribute("posX"),d.userData.posY=p.getAttribute("posY"),d.userData.posZ=p.getAttribute("posZ"),d.userData.area=p.getAttribute("area")),p=u.iterateNext()}if(t.userData.id=a.getAttribute("id"),t.userData.name=a.getAttribute("name"),t.userData.type=a.getAttribute("type"),t.userData.longname=a.getAttribute("longname"),t.userData.filesource=r.fileUrl,t.userData.index=s,t.name=a.getAttribute("name"),h.add(t),++s===c){var f=l.evaluate("Project/PluginData",e,null,XPathResult.ANY_UNORDERED_NODE_TYPE,null).singleNodeValue;o.onPluginParser(f),h.name="Main Model Scene",i(h)}},r),p=u.iterateNext()}}},VB.CameraGizmo=function(t,e,i,r){this.CameraGizmoScene=new THREE.Scene,this.name="camera gizmo",this.selected_axis=null,this.texture_selected_axis=null,this.main_camera=e,this.gizmo_size=1,this.canvas=null,this.callback_onclick=i,this.han=r,this.viewport=[10,10,100,100],this.layout_viewport=t,this.updateTexture();var n=this.createMesh();this.CameraGizmoScene.add(n),this.render_camera=new THREE.PerspectiveCamera(75,1,.1,100),this.render_camera.position.z=0},VB.CameraGizmo.axis=[{name:"+X",v:new THREE.Vector3(1,0,0),up:new THREE.Vector3(0,1,0)},{name:"-X",v:new THREE.Vector3(-1,0,0),up:new THREE.Vector3(0,1,0)},{name:"+Y",v:new THREE.Vector3(0,1,0),up:new THREE.Vector3(0,0,-1)},{name:"-Y",v:new THREE.Vector3(0,-1,0),up:new THREE.Vector3(0,0,-1)},{name:"+Z",v:new THREE.Vector3(0,0,1),up:new THREE.Vector3(0,1,0)},{name:"-Z",v:new THREE.Vector3(0,0,-1),up:new THREE.Vector3(0,1,0)}],VB.CameraGizmo.prototype.render=function(){if(this.main_camera){this.render_camera.useTarget=!1,this.render_camera.rotation.copy(this.main_camera.rotation);var t=new THREE.Vector3(0,0,-1);t.applyQuaternion(this.main_camera.quaternion);var e=t.clone();e.multiplyScalar(-1.8),this.render_camera.position.copy(e);var i=this.layout_viewport.renderer.getSize();this.layout_viewport.renderer.setViewport(this.viewport[0],this.viewport[0],this.viewport[2],this.viewport[3]),this.layout_viewport.renderer.render(this.CameraGizmoScene,this.render_camera),this.layout_viewport.renderer.setViewport(0,0,i.width,i.height)}},VB.CameraGizmo.prototype.insideGizmoArea=function(t){if(this.canvas){var e=this.layout_viewport.container.dom.getBoundingClientRect(),i=this.canvas.height-t.clientY;return!(t.clientX<e.left||t.clientX>e.left+this.viewport[2]||i<e.left.top||i>e.left.top+this.viewport[3])}},VB.CameraGizmo.prototype.getIntersectObject=function(t){var e=this.layout_viewport.container.dom.getBoundingClientRect(),i=new THREE.Vector2,r=new THREE.Raycaster;return i.x=(t.clientX-e.left)/this.viewport[2]*2-1,i.y=-(t.clientY-e.top)/this.viewport[3]*2+1,r.setFromCamera(i,this.render_camera),r.intersectObjects(this.CameraGizmoScene.children,!0)},VB.CameraGizmo.prototype.checkSide=function(t){if(this.canvas){this.canvas.height,t.clientY;if(this.insideGizmoArea(t)){var e=this.getIntersectObject(t);if(e.length>0){var i=e[0].face.normal,r=-1,n=null;for(var o in VB.CameraGizmo.axis){var a=VB.CameraGizmo.axis[o];a.dot=i.dot(a.v),a.dot<r||(r=a.dot,n=a)}return n}return null}}},VB.CameraGizmo.prototype.mousedown=function(t){if(this.insideGizmoArea(t))return t.preventDefault(),t.stopPropagation(),0==t.button&&(this.orbiting=!0),2==t.button||void 0},VB.CameraGizmo.prototype.mousemove=function(t){if(this._mouse_is_over=this.insideGizmoArea(t),this.selected_axis&&(this.selected_axis=null,this.updateTexture()),this._mouse_is_over){var e=this.checkSide(t);return e?(this.selected_axis=e,this.updateTexture()):(this.selected_axis=null,this.texture_selected_axis&&this.updateTexture()),!(!t.dragging||!this.orbiting)||void 0}},VB.CameraGizmo.prototype.mouseup=function(t){if(this.insideGizmoArea(t)){if(t.preventDefault(),t.stopPropagation(),t.click_time>300)return!0;if(0==t.button&&this.orbiting){var e=this.checkSide(t);e&&this.callback_onclick(e,this.layout_viewport.getWidth(),this.layout_viewport.getHeight())}return this.orbiting=!1,t.preventDefault(),t.stopPropagation(),!0}},VB.CameraGizmo.prototype.updateTexture=function(){if(!this.texture||this.texture_selected_axis!=this.selected_axis){this.canvas=this.canvas||document.createElement("canvas"),this.canvas.width=150,this.canvas.height=150;var t,e=this.canvas.getContext("2d");e.save(),e.fillStyle="black",e.strokeStyle="white",e.fillRect(0,0,this.canvas.width,this.canvas.height),e.translate(0,this.canvas.height),e.scale(1,-1),e.font="20px Arial",t=this.han?["","","","","",""]:["-X","+X","-Z","+Z","+Y","-Y"],e.fillStyle="white";var i=this.canvas.width/4;e.lineWidth=2;for(var r=0;r<t.length;r++){var n=!1;this.selected_axis&&t[r]==this.selected_axis.name&&(n=!0);var o=r*i%this.canvas.width,a=Math.floor(r*i/this.canvas.width)*i;e.fillStyle=n?"#909090":"#222",e.fillRect(o+.5,a+.5,i,i),e.strokeStyle="white",e.strokeRect(o+.5,a+.5,i,i),e.fillStyle="white",e.fillText(t[r],o+.5+.15*i,a+.5+.7*i)}e.restore(),this.texture_selected_axis=this.selected_axis,this.texture||(this.texture=new THREE.Texture(this.canvas)),this.texture.needsUpdate=!0}},VB.CameraGizmo.prototype.createMesh=function(){sizex=.5,sizey=.5,sizez=.5;for(var t=.25,e=[new THREE.Vector3(-sizex,+sizey,-sizez),new THREE.Vector3(-sizex,-sizey,+sizez),new THREE.Vector3(-sizex,+sizey,+sizez),new THREE.Vector3(-sizex,+sizey,-sizez),new THREE.Vector3(-sizex,-sizey,-sizez),new THREE.Vector3(-sizex,-sizey,+sizez),new THREE.Vector3(+sizex,+sizey,+sizez),new THREE.Vector3(+sizex,-sizey,-sizez),new THREE.Vector3(+sizex,+sizey,-sizez),new THREE.Vector3(+sizex,+sizey,+sizez),new THREE.Vector3(+sizex,-sizey,+sizez),new THREE.Vector3(+sizex,-sizey,-sizez),new THREE.Vector3(+sizex,+sizey,-sizez),new THREE.Vector3(-sizex,-sizey,-sizez),new THREE.Vector3(-sizex,+sizey,-sizez),new THREE.Vector3(+sizex,+sizey,-sizez),new THREE.Vector3(+sizex,-sizey,-sizez),new THREE.Vector3(-sizex,-sizey,-sizez),new THREE.Vector3(-sizex,+sizey,+sizez),new THREE.Vector3(+sizex,-sizey,+sizez),new THREE.Vector3(+sizex,+sizey,+sizez),new THREE.Vector3(-sizex,+sizey,+sizez),new THREE.Vector3(-sizex,-sizey,+sizez),new THREE.Vector3(+sizex,-sizey,+sizez),new THREE.Vector3(-sizex,+sizey,-sizez),new THREE.Vector3(+sizex,+sizey,+sizez),new THREE.Vector3(+sizex,+sizey,-sizez),new THREE.Vector3(-sizex,+sizey,-sizez),new THREE.Vector3(-sizex,+sizey,+sizez),new THREE.Vector3(+sizex,+sizey,+sizez),new THREE.Vector3(+sizex,-sizey,-sizez),new THREE.Vector3(-sizex,-sizey,+sizez),new THREE.Vector3(-sizex,-sizey,-sizez),new THREE.Vector3(+sizex,-sizey,-sizez),new THREE.Vector3(+sizex,-sizey,+sizez),new THREE.Vector3(-sizex,-sizey,+sizez)],i=new THREE.Geometry,r=0;r<e.length;r++)i.vertices.push(e[r]);for(r=0;r<e.length;r+=3)i.faces.push(new THREE.Face3(r,r+1,r+2));i.computeVertexNormals(),i.normalize();var n=[];h(0,0),h(t,0),h(2*t,0),h(3*t,0),h(0,t),h(t,t);for(r=0;r<n.length;r+=3){var o=[];o.push(new THREE.Vector2(n[r][0],n[r][1])),o.push(new THREE.Vector2(n[r+1][0],n[r+1][1])),o.push(new THREE.Vector2(n[r+2][0],n[r+2][1])),i.faceVertexUvs[0].push(o)}i.computeFaceNormals(),i.computeVertexNormals();var a=new THREE.MeshBasicMaterial({transparent:!0,opacity:.6,map:this.texture}),s=new THREE.Mesh(i,a);return s;function h(e,i,r){var o=i,a=i+t;r&&(o=a,a=i),n.push([e,o],[e+t,a],[e+t,o],[e,o],[e,a],[e+t,a])}},VB.AssetLoader=function(){this.resourceManager={textures:void 0,materials:void 0,geometries:void 0}},VB.AssetLoader.prototype={constructor:VB.AssetLoader,setResoucreManager:function(t,e,i){this.resourceManager.textures=t,this.resourceManager.materials=e,this.resourceManager.geometries=i},load:function(t,e,i,r,n,o){var a=this;if(document.implementation&&document.implementation.createDocument){var s=new XMLHttpRequest;s.onreadystatechange=function(){if(4===s.readyState&&(0===s.status||200===s.status))if(s.responseXML)a.parse(t,e,s.responseXML,i,r,n);else if(s.responseText){var h=(new DOMParser).parseFromString(s.responseText,"application/xml");a.parse(t,e,h,i,r,n)}else o&&o()},s.open("GET",e,!0),s.send(null)}},is_url:function(t){return regexp=/^(?:(?:https?|ftp):\/\/)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:\/\S*)?$/,!!regexp.test(t)},loadJson:function(t,e,i,r,n,o){var a=this;if(a.is_url(e)){var s=new XMLHttpRequest;s.onreadystatechange=function(){if(4===s.readyState&&(0===s.status||200===s.status))if(s.responseXML)a.parseJson(t,e,s.responseXML,i,r,n);else if(s.responseText){var h=(new DOMParser).parseFromString(s.responseText,"application/xml");a.parseJson(t,e,h,i,r,n)}else o&&o()},s.open("GET",e,!0),s.send(null)}else a.parseJson(t,"",e,i,r,n)},parse_model:function(t,e,i,r,n,o,a){for(var s=i.evaluate?i:document,h=0,l=0,c=new THREE.Object3D,u=s.evaluate("count(asset_model/model/model_item)",i,null,XPathResult.ANY_TYPE,null).numberValue,p=s.evaluate("asset_model/model/model_item",i,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),d=p.iterateNext();d;){var f={id:null,name:null,type:null,fileUrl:null,textureUrl:null,trans:null,useBufferGeometry:!0,scale:1,totalSBMs:u,currentSBMs:h++};a.textures&&(f.textures=a.textures),f.id=d.getAttribute("id"),f.name=d.getAttribute("name"),f.type=d.getAttribute("type"),f.trans=d.getAttribute("trans");var m=d.getAttribute("filename");-1!==(g=m.lastIndexOf("\\"))&&(m=m.substr(g+1));var g,v="";-1!==(g=e.lastIndexOf("/"))&&(v=e.substr(0,g+1)),f.fileUrl=v+m,textureUrl=d.getAttribute("mappath"),-1!==(g=textureUrl.lastIndexOf("\\"))&&(textureUrl=textureUrl.substr(g+1)),f.textureUrl=v+textureUrl;var y=new VB.SBMLoader;y.worker=o,y.load(f.fileUrl,f,function(t,e){var i=new SoonMap;if(t.traverse(function(t){t instanceof THREE.Mesh&&i.put(t.userData.id,t)}),t.userData.id=e.id,t.userData.name=e.name,t.userData.type=e.type,t.userData.filesource=e.fileUrl,t.userData.index=l,t.name=e.name,e.trans){var n=e.trans.split(",");t.position.set(n[0],n[1],n[2])}c.add(t),++l===u&&(c.name="Main Model Scene",r(c))},n),d=p.iterateNext()}},parse_library:function(t,e,i,r){for(var n=i.evaluate?i:document,o=0,a=0,s=n.evaluate("count(asset_model/library/library_item)",i,null,XPathResult.ANY_TYPE,null).numberValue,h=n.evaluate("asset_model/library/library_item",i,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),l=h.iterateNext();l;){var c={id:null,name:null,type:null,fileUrl:null,textureUrl:null,useBufferGeometry:!0,scale:1,totalSBMs:s,currentSBMs:a++};this.resourceManager.textures&&(c.textures=this.resourceManager.textures),c.id=l.getAttribute("id"),c.name=l.getAttribute("name"),c.type="library";var u=l.getAttribute("filename");-1!==(p=u.lastIndexOf("\\"))&&(u=u.substr(p+1));var p,d="";-1!==(p=e.lastIndexOf("/"))&&(d=e.substr(0,p+1)),c.fileUrl=d+u,textureUrl=l.getAttribute("mappath"),-1!==(p=textureUrl.lastIndexOf("\\"))&&(textureUrl=textureUrl.substr(p+1)),c.textureUrl=d+textureUrl;try{t.editor.LibraryManager.LoadLibrary(t,c.name,c.fileUrl,c.textureUrl,function(t){++o===s&&r()})}catch(t){}l=h.iterateNext()}},parse_component:function(t,e,i,r,n){for(var o=i.evaluate?i:document,a=(o.evaluate("count(asset_model/component/component_item)",i,null,XPathResult.ANY_TYPE,null).numberValue,o.evaluate("asset_model/component/component_item",i,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null)),s=a.iterateNext();s;){var h={id:null,name:null,type:null,libname:null,position:null,angle:null,vangle:null,xarr:null,yarr:null,zarr:null,lodmin:null,lodmax:null,info:null,infoalways:null};n.textures&&(h.textures=n.textures),h.id=s.getAttribute("id"),h.name=s.getAttribute("name"),h.type="Component",h.libname=s.getAttribute("libname");var l=s.getAttribute("position").split(",");if(h.position=new THREE.Vector3(l[0],l[1],l[2]),h.angle=s.getAttribute("angle"),h.vangle=s.getAttribute("vangle"),h.xarr=s.getAttribute("xarr"),h.yarr=s.getAttribute("yarr"),h.zarr=s.getAttribute("zarr"),h.info=s.getAttribute("info"),h.infoalways=s.getAttribute("infoalways"),M=s.getAttribute("lod")){var c=M.split(",");h.lodmin=c[0],h.lodmax=c[1]}var u,p=1,d=0,f=1,m=0,g=1,v=0;if(h.xarr)p=(u=h.xarr.split(","))[0],d=u[1];if(h.yarr)f=(u=h.yarr.split(","))[0],m=u[1];if(h.zarr)g=(u=h.zarr.split(","))[0],v=u[1];try{for(var y=h.position.clone(),E=0,x=0;x<p;x++){for(var _=y.clone(),w=0;w<f;w++){for(var b=_,S=0;S<g;S++){var T=t.insertLibrary(h.id+"_"+E++,h.libname,b,h.name,h.angle,h.vangle,0);if(T.hidePoint(),T.hideIcon(),h.info&&T.createInfoForm(h.info,h.infoalways),h.lodmin&&h.lodmax){var M={visibleIcon:!1,visibleText:!1,level:1,min:h.lodmin,max:h.lodmax};T.lod.push(M)}b.z=parseFloat(b.z)+parseFloat(v)}_.y=parseFloat(_.y)+parseFloat(m)}y.x=parseFloat(y.x)+parseFloat(d)}}catch(t){}s=a.iterateNext()}r&&r()},parse_etc:function(t,e,i,r){for(var n=i.evaluate?i:document,o=n.evaluate("asset_model/arrow/arrow_item",i,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),a=o.iterateNext();a;){var s=a.getAttribute("start").split(","),h=a.getAttribute("end").split(","),l={radius:25,arrowheight:80,tween:!0,color:16711680},c=parseFloat(a.getAttribute("angle"));l.radius=parseFloat(a.getAttribute("radius")),l.arrowheight=parseFloat(a.getAttribute("arrowheight")),l.tween=a.getAttribute("tween"),l.color=a.getAttribute("color"),drawAxisHelpers(t.editor.scene,{x:parseFloat(s[0]),y:parseFloat(s[1]),z:parseFloat(s[2])},{x:parseFloat(h[0]),y:parseFloat(h[1]),z:parseFloat(h[2])},c,l),a=o.iterateNext()}for(var u=n.evaluate("asset_model/pipe/pipe_item",i,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),p=u.iterateNext();p;){s=p.getAttribute("start").split(","),h=p.getAttribute("end").split(",");(l={radiusTop:5,radiusBottom:5,radiusSegments:20,heightSegments:2,openEnded:!0,tween:!0,opacity:.5,color:4210943}).radiusTop=parseFloat(p.getAttribute("radius")),l.radiusBottom=l.radiusTop,l.opacity=parseFloat(p.getAttribute("opacity")),l.tween=p.getAttribute("tween"),drawCylinder(t.editor.scene,{x:parseFloat(s[0]),y:parseFloat(s[1]),z:parseFloat(s[2])},{x:parseFloat(h[0]),y:parseFloat(h[1]),z:parseFloat(h[2])},l),p=u.iterateNext()}r&&r()},parse:function(t,e,i,r,n,o){var a=this.parse_component,s=this.parse_etc,h=this.parse_model,l=this.resourceManager;this.parse_library(t,e,i,function(){a(t,e,i,function(){s(t,e,i,function(){h(t,e,i,r,n,o,l)})},l)})},parseJson:function(t,e,i,r,n,o){var a=this,s=0,h=0,l=new THREE.Object3D;l.userData.boundingBox=new THREE.Box3;var c,u=0,p=0;if((c="string"==typeof i?JSON.parse(i):i).asset_model.library){var d=c.asset_model.library.library_item.length;c.asset_model.library.library_item.forEach(function(i){var r={id:null,name:null,type:null,fileUrl:null,textureUrl:null,useBufferGeometry:!0,scale:1,totalSBMs:d,currentSBMs:p++};a.resourceManager.textures&&(r.textures=a.resourceManager.textures),r.id=i.id,r.name=i.name,r.type="library";var n=i.filename;-1!==(o=n.lastIndexOf("\\"))&&(n=n.substr(o+1));var o,s="";-1!==(o=e.lastIndexOf("/"))&&(s=e.substr(0,o+1)),r.fileUrl=s+n,textureUrl=i.mappath,-1!==(o=textureUrl.lastIndexOf("\\"))&&(textureUrl=textureUrl.substr(o+1)),r.textureUrl=s+textureUrl;try{t.editor.LibraryManager.LoadLibrary(t,r.name,r.fileUrl,r.textureUrl,function(e){if(++u===d&&c.asset_model.component){c.asset_model.component.component_item.length;c.asset_model.component.component_item.forEach(function(e){var i={id:null,name:null,type:null,libname:null,position:null,angle:null,vangle:null,xarr:null,yarr:null,zarr:null,lodmin:null,lodmax:null,info:null,infoalways:null};a.resourceManager.textures&&(i.textures=a.resourceManager.textures),i.id=e.id,i.name=e.name,i.type="Component",i.libname=e.libname;var r=e.position.split(",");if(i.position=new THREE.Vector3(r[0],r[1],r[2]),i.angle=e.angle,i.vangle=e.vangle,i.xarr=e.xarr,i.yarr=e.yarr,i.zarr=e.zarr,i.info=e.info,i.infoalways=e.infoalways,_=e.lod){var n=_.split(",");i.lodmin=n[0],i.lodmax=n[1]}var o,s=1,h=0,l=1,c=0,u=1,p=0;i.xarr&&(s=(o=i.xarr.split(","))[0],h=o[1]);i.yarr&&(l=(o=i.yarr.split(","))[0],c=o[1]);i.zarr&&(u=(o=i.zarr.split(","))[0],p=o[1]);try{for(var d=i.position.clone(),f=0,m=0;m<s;m++){for(var g=d.clone(),v=0;v<l;v++){for(var y=g,E=0;E<u;E++){var x=t.insertLibrary(i.id+"_"+f++,i.libname,y,i.name,i.angle,i.vangle,0);if(x.hidePoint(),x.hideIcon(),i.info&&x.createInfoForm(i.info,i.infoalways),i.lodmin&&i.lodmax){var _={visibleIcon:!1,visibleText:!1,level:1,min:i.lodmin,max:i.lodmax};x.lod.push(_)}y.z=parseFloat(y.z)+parseFloat(p)}g.y=parseFloat(g.y)+parseFloat(c)}d.x=parseFloat(d.x)+parseFloat(h)}}catch(t){}})}})}catch(t){}})}if(c.asset_model.model){var f=c.asset_model.model.model_item.length;c.asset_model.model.model_item.forEach(function(i){var u={id:null,name:null,type:null,fileUrl:null,textureUrl:null,trans:null,useBufferGeometry:!0,scale:1,totalSBMs:f,currentSBMs:s++};a.resourceManager.textures&&(u.textures=a.resourceManager.textures),u.id=i.id,u.name=i.name,u.type=i.type,u.trans=i.trans;var p=i.filename;-1!==(d=p.lastIndexOf("\\"))&&(p=p.substr(d+1));var d,m="";-1!==(d=e.lastIndexOf("/"))&&(m=xmlurl.substr(0,d+1)),u.fileUrl=m+p,textureUrl=i.mappath,-1!==(d=textureUrl.lastIndexOf("\\"))&&(textureUrl=textureUrl.substr(d+1)),u.textureUrl=m+textureUrl;var g=new VB.SBMLoader;g.worker=o,g.load(u.fileUrl,u,function(e,i){var n=new SoonMap;if(e.traverse(function(t){t instanceof THREE.Mesh&&n.put(t.userData.id,t)}),e.userData.id=i.id,e.userData.name=i.name,e.userData.type=i.type,e.userData.filesource=i.fileUrl,e.userData.index=h,e.name=i.name,i.trans){var o=i.trans.split(",");e.position.set(o[0],o[1],o[2])}if(l.add(e),++h===i.totalSBMs){if(l.name="Main Model Scene",r(l),c.asset_model.arrow){c.asset_model.arrow.arrow_item.length;c.asset_model.arrow.arrow_item.forEach(function(e){var i=e.start,r=i.split(","),n=(i=e.end).split(","),o={radius:25,arrowheight:80,tween:!0,color:16711680},a=parseFloat(e.angle);o.radius=parseFloat(e.radius),o.arrowheight=parseFloat(e.arrowheight),o.tween=e.tween,o.color=e.color,drawAxisHelpers(t.editor.scene,{x:parseFloat(r[0]),y:parseFloat(r[1]),z:parseFloat(r[2])},{x:parseFloat(n[0]),y:parseFloat(n[1]),z:parseFloat(n[2])},a,o),ArrowItemNode=ArrowItemIter.iterateNext()})}if(c.asset_model.pipe){c.asset_model.pipe.pipe_item.length;c.asset_model.pipe.pipe_item.forEach(function(e){var i=e.start,r=i.split(","),n=(i=e.end).split(","),o={radiusTop:5,radiusBottom:5,radiusSegments:20,heightSegments:2,openEnded:!0,tween:!0,opacity:.5,color:4210943};o.radiusTop=parseFloat(e.radius),o.radiusBottom=o.radiusTop,o.opacity=parseFloat(e.opacity),o.tween=e.tween,drawCylinder(t.editor.scene,{x:parseFloat(r[0]),y:parseFloat(r[1]),z:parseFloat(r[2])},{x:parseFloat(n[0]),y:parseFloat(n[1]),z:parseFloat(n[2])},o)})}}},n)})}}},VB.Animation=function(t){this.SoonSpace=t,this.mapSchedule=new SoonMap},VB.Animation.ActionType={MOVE:1,ROTATE:2,ROTATE_AXIS:4,JUMP:8},VB.Animation.prototype={constructor:VB.Animation,addSchedule:function(t){switch(t.action){case VB.Animation.ActionType.MOVE:if(null==(n=this.SoonSpace.editor.LibraryManager.GetComponent(t.devicd_id)))throw"object not found";var e=t.move_pos.clone();t.relative&&(e=n.position.clone()).add(t.move_pos);var i=new TWEEN.Tween(n.position).to({x:e.x,y:e.y,z:e.z},t.duration).easing(t.move_type).delay(t.delay).onUpdate(function(){}).onComplete(function(){});return t.repeat&&i.repeat(1/0),t.start&&i.start(),t.chain&&this.mapSchedule[t.chain].chain(i),this.mapSchedule[t.name]=i,i;case VB.Animation.ActionType.ROTATE:if(null==(n=this.SoonSpace.editor.LibraryManager.GetComponent(t.devicd_id)))return null;var r=new TWEEN.Tween(n.rotation).to({x:n.rotation._x+t.rotate_angle.x,y:n.rotation._y+t.rotate_angle.y,z:n.rotation._z+ +t.rotate_angle.z},t.duration).delay(t.delay).onUpdate(function(){}).onComplete(function(){});return t.repeat&&r.repeat(1/0),t.start&&r.start(),t.chain&&this.mapSchedule[t.chain].chain(r),this.mapSchedule[t.name]=r,r;case VB.Animation.ActionType.ROTATE_AXIS:var n;if(null==(n=this.SoonSpace.editor.LibraryManager.GetComponent(t.devicd_id)))return null;var o=n.position.clone();o=o.sub(t.MovePos);var a=0,s={x:0,y:0,z:0},h=new TWEEN.Tween(s).to({value:t.EndAngle},t.duration).delay(t.delay).onUpdate(function(){n.translateX(-o.x),n.translateY(-o.y),n.translateZ(-o.z),n.rotateOnAxis(t.Axis,s.value-a),n.translateX(+o.x),n.translateY(+o.y),n.translateZ(+o.z),a=s.value}).onComplete(function(){});return t.repeat&&h.repeat(1/0),t.start&&h.start(),t.chain&&this.mapSchedule[t.chain].chain(h),this.mapSchedule[t.name]=i,i}},get:function(t){return this.mapSchedule[t]},run:function(t){this.mapSchedule[t].start()},stop:function(t){this.mapSchedule[t].stop()}},VB.CommandCopyArray=function(t,e,i){this.soonSpace=t,this.obj=e,this.scene=t.editor.scene,this.camera=t.editor.camera,this.viewport=t.viewport,this.space=i,this.x=this.onMouseDown.bind(this),document.addEventListener("mousedown",this.x)},VB.CommandCopyArray.prototype=Object.create(THREE.EventDispatcher.prototype),VB.CommandCopyArray.prototype.constructor=VB.CommandCopyArray,VB.CommandCopyArray.prototype.CreateLine=function(){var t=new THREE.BufferGeometry;this.positions=new Float32Array(6),t.addAttribute("position",new THREE.BufferAttribute(this.positions,3)),this.positions[0]=0,this.positions[1]=0,this.positions[2]=0,this.positions[3]=0,this.positions[4]=0,this.positions[5]=0;var e=new THREE.LineBasicMaterial({color:16711680,linewidth:5,depthTest:!1});this.line=new THREE.Line(t,e),this.scene.add(this.line)},VB.CommandCopyArray.prototype.onMouseDown=function(t){t.preventDefault(),this.CreateLine(),this.x_1=this.onMouseMove.bind(this),document.addEventListener("mousemove",this.x_1),this.x_2=this.onMouseUp.bind(this),document.addEventListener("mouseup",this.x_2),this.viewport.controls.enabled=!1;var e=this.viewport.getIntersectPoint(new THREE.Vector2(t.clientX,t.clientY));if(void 0!=e){var i=this.line.geometry.attributes.position.array;i[0]=i[3]=e.x,i[1]=i[4]=e.y,i[2]=i[5]=e.z,this.line.geometry.attributes.position.needsUpdate=!0}},VB.CommandCopyArray.prototype.onMouseMove=function(t){t.preventDefault();var e=this.viewport.getIntersectPoint(new THREE.Vector2(t.clientX,t.clientY));if(void 0!=e){var i=this.line.geometry.attributes.position.array;i[3]=e.x,i[4]=e.y,i[5]=e.z,this.line.geometry.attributes.position.needsUpdate=!0}},VB.CommandCopyArray.prototype.onMouseUp=function(t){t.preventDefault(),document.removeEventListener("mousedown",this.x,!1),document.removeEventListener("mousemove",this.x_1,!1),document.removeEventListener("mouseup",this.x_2,!1),this.scene.remove(this.line),this.viewport.controls.enabled=!0;var e=this.viewport.getIntersectPoint(new THREE.Vector2(t.clientX,t.clientY)),i=[];if(void 0!=e)for(var r=this.line.geometry.attributes.position.array,n=new THREE.Vector3(r[0],r[1],r[2]),o=e.clone(),a=o.distanceTo(n),s=o.sub(n).normalize(),h=0;h<a;h+=this.space)if(n.addScaledVector(s,this.space),this.obj.userData.type&&"library"==this.obj.userData.type){var l=this.soonSpace.insertLibrary(this.obj.id+"_"+h,this.obj.name,n,"",0,0,0);i.push(l),l.hidePoint(),l.hideIcon()}else{var c=this.obj.clone();i.push(c),c.position.set(n.x,n.y,n.z),this.soonSpace.editor.addObject(c)}this.dispatchEvent({type:"end",object:this.obj,newObjects:i})},VB.CommandMove=function(t,e){this.soonSpace=t,this.obj=e,this.scene=t.editor.scene,this.camera=t.editor.camera,this.viewport=t.viewport,this.x=this.onMouseDown.bind(this),document.addEventListener("mousedown",this.x)},VB.CommandMove.prototype=Object.create(THREE.EventDispatcher.prototype),VB.CommandMove.prototype.constructor=VB.CommandMove,VB.CommandMove.prototype.CreateLine=function(){var t=new THREE.BufferGeometry;this.positions=new Float32Array(6),t.addAttribute("position",new THREE.BufferAttribute(this.positions,3)),this.positions[0]=0,this.positions[1]=0,this.positions[2]=0,this.positions[3]=0,this.positions[4]=0,this.positions[5]=0;var e=new THREE.LineBasicMaterial({color:16711680,linewidth:5,depthTest:!1});this.line=new THREE.Line(t,e),this.scene.add(this.line)},VB.CommandMove.prototype.onMouseDown=function(t){t.preventDefault(),this.CreateLine(),this.x_1=this.onMouseMove.bind(this),document.addEventListener("mousemove",this.x_1),this.x_2=this.onMouseUp.bind(this),document.addEventListener("mouseup",this.x_2),this.viewport.controls.enabled=!1;var e=this.viewport.getIntersectPoint(new THREE.Vector2(t.clientX,t.clientY));if(void 0!=e){var i=this.line.geometry.attributes.position.array;i[0]=i[3]=e.x,i[1]=i[4]=e.y,i[2]=i[5]=e.z,this.line.geometry.attributes.position.needsUpdate=!0}},VB.CommandMove.prototype.onMouseMove=function(t){t.preventDefault();var e=this.viewport.getIntersectPoint(new THREE.Vector2(t.clientX,t.clientY));if(void 0!=e){var i=this.line.geometry.attributes.position.array;i[3]=e.x,i[4]=e.y,i[5]=e.z,this.line.geometry.attributes.position.needsUpdate=!0}},VB.CommandMove.prototype.onMouseUp=function(t){t.preventDefault(),document.removeEventListener("mousedown",this.x,!1),document.removeEventListener("mousemove",this.x_1,!1),document.removeEventListener("mouseup",this.x_2,!1),this.scene.remove(this.line),this.viewport.controls.enabled=!0;var e=this.viewport.getIntersectPoint(new THREE.Vector2(t.clientX,t.clientY));if(void 0!=e){var i=this.line.geometry.attributes.position.array,r=new THREE.Vector3(i[0],i[1],i[2]),n=e.clone(),o=(n.distanceTo(r),n.sub(r));this.obj.position.set(this.obj.position.x+o.x,this.obj.position.y+o.y,this.obj.position.z+o.z)}this.dispatchEvent({type:"end",object:this.obj})},VB.CommandMoveReal=function(t,e){this.soonSpace=t,this.scene=t.editor.scene,this.camera=t.editor.camera,this.viewport=t.viewport,e&&this.init(e)},VB.CommandMoveReal.prototype=Object.create(THREE.EventDispatcher.prototype),VB.CommandMoveReal.prototype.constructor=VB.CommandMoveReal,VB.CommandMoveReal.prototype.init=function(t){this.obj=t,this.obj.userData.oldposition=t.position.clone(),this.oldposition=new THREE.Vector3(this.obj.position.x,this.obj.position.y,this.obj.position.z);var e=(new THREE.Box3).setFromObject(t);this.basePoint=new THREE.Vector3((e.min.x+e.max.x)/2,e.min.y,(e.min.z+e.max.z)/2),this.x=this.onMouseDown.bind(this),this.viewport.container.dom.addEventListener("mousedown",this.x),this.x_1=this.onMouseMove.bind(this),this.viewport.container.dom.addEventListener("mousemove",this.x_1),this.x_2=this.onMouseKeyDown.bind(this),this.viewport.container.dom.addEventListener("keydown",this.x_2,!1),this.viewport.container.dom.addEventListener("keyup",this.onKeyUp.bind(this),!1)},VB.CommandMoveReal.prototype.onKeyUp=function(t){t.preventDefault()},VB.CommandMoveReal.prototype.attach=function(t){this.init(t)},VB.CommandMoveReal.prototype.detach=function(){this.viewport.container.dom.removeEventListener("mousedown",this.x,!1),this.viewport.container.dom.removeEventListener("mousemove",this.x_1,!1),this.viewport.container.dom.removeEventListener("keydown",this.x_2,!1),this.obj.position.copy(this.obj.userData.oldposition.clone()),this.dispatchEvent({type:"end",object:this.obj})},VB.CommandMoveReal.prototype.GetParentTopIndoor=function(t,e){return t.parent&&t.parent.userData.type===e?t.parent:t.parent&&t.parent.userData.type!=e?this.GetParentTopIndoor(t.parent,e):void 0},VB.CommandMoveReal.prototype.MouseToWorld=function(t){var e=new THREE.Vector3(0,0,.5),i=new THREE.Raycaster,r=this.soonSpace.viewport.renderer.domElement.getBoundingClientRect(),n=t.clientX-r.left,o=t.clientY-r.top,a=new THREE.Vector3;a.x=n/r.width*2-1,a.y=-o/r.height*2+1,e.set(a.x,a.y,1).unproject(this.soonSpace.editor.camera),i.set(this.soonSpace.editor.camera.position,e.sub(this.soonSpace.editor.camera.position).normalize());for(var s=i.intersectObjects(this.soonSpace.editor.scene.children,!0),h=0;h<s.length;h++){if(this.GetParentTopIndoor(s[h].object,this.obj.userData.type)!=this.obj)return s[h].point}},VB.CommandMoveReal.prototype.onMouseDown=function(t){if(t.preventDefault(),3==t.which&&this.detach(),1==t.which){var e=this.MouseToWorld(t);void 0!=e&&this.obj.position.set(e.x-this.basePoint.x+this.oldposition.x,e.y-this.basePoint.y+this.oldposition.y,e.z-this.basePoint.z+this.oldposition.z),this.x_up=this.onMouseUp.bind(this),this.viewport.container.dom.addEventListener("mouseup",this.x_up,!1),this.viewport.container.dom.removeEventListener("mousedown",this.x,!1),this.viewport.container.dom.removeEventListener("mousemove",this.x_1,!1),this.viewport.container.dom.removeEventListener("keydown",this.x_2,!1)}},VB.CommandMoveReal.prototype.onMouseUp=function(t){t.stopImmediatePropagation(),this.viewport.controls.enabled=!0,this.dispatchEvent({type:"end",object:{model:this.obj,oldPos:this.obj.userData.oldposition,newPos:this.obj.position}}),this.viewport.container.dom.removeEventListener("mouseup",this.x_up,!1)},VB.CommandMoveReal.prototype.onMouseKeyDown=function(t){t.preventDefault(),"Escape"==t.key&&(this.viewport.container.dom.removeEventListener("mousedown",this.x,!1),this.viewport.container.dom.removeEventListener("mousemove",this.x_1,!1),this.viewport.container.dom.removeEventListener("keydown",this.x_2,!1),this.viewport.controls.enabled=!0,obj.position.copy(this.obj.userData.oldposition.clone()),this.dispatchEvent({type:"end",object:this.obj}))},VB.CommandMoveReal.prototype.onMouseMove=function(t){t.preventDefault();var e=this.MouseToWorld(t);void 0!=e&&this.obj.position.set(e.x-this.basePoint.x+this.oldposition.x,e.y-this.basePoint.y+this.oldposition.y,e.z-this.basePoint.z+this.oldposition.z)},VB.CopyModel=function(t,e){this.soonSpace=t,this.obj=e.model,this.newObjects=[],this.scene=t.editor.scene,this.camera=t.editor.camera,this.viewport=t.viewport,this.space=e.space,this.copyNumber=e.copyNumber,this.axis=e.axis,this.mouseDown=this.onMouseDown.bind(this),this.mouseMove=this.onMouseMove.bind(this),this.mouseUp=this.onMouseUp.bind(this),document.addEventListener("mousedown",this.mouseDown),VB.CopyModel.prototype.cancelCopyModel=function(){this.newObjects.length>0&&this.newObjects.map(t=>{this.scene.remove(t)}),this.newObjects=[]}},VB.CopyModel.prototype=Object.create(THREE.EventDispatcher.prototype),VB.CopyModel.prototype.constructor=VB.CopyModel,VB.CopyModel.prototype.CreateLine=function(){var t=new THREE.BufferGeometry;this.positions=new Float32Array(6),t.addAttribute("position",new THREE.BufferAttribute(this.positions,3)),this.positions[0]=0,this.positions[1]=0,this.positions[2]=0,this.positions[3]=0,this.positions[4]=0,this.positions[5]=0;var e=new THREE.LineBasicMaterial({color:16711680,linewidth:5,depthTest:!1});this.line=new THREE.Line(t,e),this.scene.add(this.line)},VB.CopyModel.prototype.onMouseDown=function(t){t.preventDefault(),this.CreateLine(),document.addEventListener("mousemove",this.mouseMove),document.addEventListener("mouseup",this.mouseUp),this.viewport.controls.enabled=!1;var e=this.viewport.getIntersectPoint(new THREE.Vector2(t.clientX,t.clientY));if(void 0!=e){var i=this.line.geometry.attributes.position.array;i[0]=i[3]=e.x,i[1]=i[4]=e.y,i[2]=i[5]=e.z,this.line.geometry.attributes.position.needsUpdate=!0}},VB.CopyModel.prototype.onMouseMove=function(t){t.preventDefault();var e=this.viewport.getIntersectPoint(new THREE.Vector2(t.clientX,t.clientY));if(void 0!=e){var i=this.line.geometry.attributes.position.array;switch(this.axis){case"x":case"X":i[3]=e.x;break;case"y":case"Y":case"z":case"Z":i[5]=e.z;break;default:i[3]=e.x,i[5]=e.z}this.line.geometry.attributes.position.needsUpdate=!0}},VB.CopyModel.prototype.onMouseUp=function(t){t.preventDefault(),document.removeEventListener("mousedown",this.mouseDown,!1),document.removeEventListener("mousemove",this.mouseMove,!1),document.removeEventListener("mouseup",this.mouseUp,!1),this.scene.remove(this.line),this.viewport.controls.enabled=!0;var e=this.viewport.getIntersectPoint(new THREE.Vector2(t.clientX,t.clientY));if(void 0!=e){var i=this.line.geometry.attributes.position.array,r=new THREE.Vector3(i[0],i[1],i[2]),n=null;switch(this.axis){case"x":case"X":n=new THREE.Vector3(e.x,i[1],i[2]);break;case"y":case"Y":case"z":case"Z":n=new THREE.Vector3(i[0],i[1],e.z);break;default:n=new THREE.Vector3(e.x,i[1],e.z)}var o=n.distanceTo(r),a=n.sub(r).normalize();this.space=this.copyNumber?o/this.copyNumber:this.space;for(let t=0;t<o;t+=this.space)if(r.addScaledVector(a,this.space),this.obj.userData.type&&"library"==this.obj.userData.type){var s=this.soonSpace.insertLibrary(this.obj.id+"_"+t,this.obj.name,r,"",0,0,0);this.newObjects.push(s),s.hidePoint(),s.hideIcon()}else{var h=this.obj.clone();this.newObjects.push(h),h.position.set(r.x,r.y,r.z),this.soonSpace.editor.addObject(h)}}this.dispatchEvent({type:"end",object:this.obj,newObjects:this.newObjects})};var SoonSpace=function(){this.editor=null,this.viewport=null};function fadeMesh(t,e,i){i=i||{};var r={percentage:"in"==e?1:.01},n=t.material.materials?t.material.materials:[t.material],o=t.material.opacity,a=i.easing||TWEEN.Easing.Linear.None,s=i.duration||2e3;if(null!=o){var h=new TWEEN.Tween(r).to({percentage:"in"==e?.01:1},s).easing(a).onUpdate(function(){for(var t=0;t<n.length;t++)n[t].opacity=r.percentage}).onComplete(function(){for(var r=0;r<n.length;r++)n[r].visible="in"==e?"true":"false";i.callback&&i.callback(t)});return h.start(),h}}SoonSpace.version=1,SoonSpace.prototype.init=function(t,e,i){var r=document.getElementById(t);if(null===r)throw new Error('No element found by "init of Id"! ');var n=this;Number.prototype.format=function(){return this.toString().replace(/(\d)(?=(\d{3})+(?!\d))/g,"$1,")},this.editor=new VB.Editor;var o=this.editor;this.viewport=new VB.Viewport(o,i);var a=this.viewport;r.appendChild(a.container.dom),a.transformControls.visible=!1,a.container.dom.style.position="relative",a.container.dom.style.width="100%",a.container.dom.style.height="100%",a.continuousRender=!0,a.enableFocus=!1,o.signals.showGridChanged.dispatch(!0),i&&(a.transformControls.visible=!0===i.enableTransform,o.signals.showGridChanged.dispatch(!0===i.showGrid),a.renderer.setClearColor(i.backgroundColor));try{o.createLibraryManager(a.renderer,o.scene,o.camera,a.onMovePosition),a.addPostRender("Library Render",o.LibraryManager.update.bind(o.LibraryManager))}catch(t){}try{o.createPoiManager(a.renderer,a.rendererCSS3D.domElement,o.camera,a.onMovePosition),a.addPostRender("POI Render",o.poiManager.update.bind(o.poiManager)),o.poiManager.onClick=function(t){var i;e&&e.poiClick&&n.editor.selectMode&VB.Editor.SelectMode.object&&(t&&(i=t.poi?{uuid:t.poi.uuid,id:t.poi.id,userId:t.poi.userData.id,name:t.name,layerName:t.layerId}:{menu:t.menu}),e.poiClick(i))},o.poiManager.onHover=function(t){var i;e&&e.poiHover&&n.editor.selectMode&VB.Editor.SelectMode.object&&(t&&(i=t.poi?{uuid:t.poi.uuid,id:t.poi.id,userId:t.poi.userData.id,name:t.name,layerName:t.layerId}:{menu:t.menu}),e.poiHover(i))},o.poiManager.onDblClick=function(t){var i;e&&e.poiDblClick&&(t&&(i={uuid:t.poi.uuid,id:t.poi.id,userId:t.poi.userData.id,name:t.name,layerName:t.layerId}),e.poiDblClick(i))}}catch(t){}try{o.createPoi3DManager(a.renderer,a.rendererCSS3D.domElement,o.camera,a.onMovePosition),o.poi3DManager.onClick=function(t){var i;e&&e.poi3DClick&&n.editor.selectMode&VB.Editor.SelectMode.object&&(t&&(i=t.poi?{uuid:t.poi.uuid,id:t.poi.id,userId:t.poi.userData.id,name:t.name,layerName:t.layerId}:{menu:t.menu}),e.poi3DClick(i))},o.poi3DManager.onHover=function(t){var i;e&&e.poi3DHover&&n.editor.selectMode&VB.Editor.SelectMode.object&&(t&&(i=t.poi?{uuid:t.poi.uuid,id:t.poi.id,userId:t.poi.userData.id,name:t.name,layerName:t.layerId}:{menu:t.menu}),e.poi3DHover(i))},o.poi3DManager.onDblClick=function(t){var i;e&&e.poi3DDblClick&&(t&&(i={id:t.id}),e.poi3DDblClick(i))}}catch(t){}try{o.createDeviceManager(a.renderer,o.camera,a.onMovePosition),a.addPostRender("DEVICE Render",o.DeviceManager.update.bind(o.DeviceManager))}catch(t){}o.signals.objectSelected.add(function(t){if(e&&e.objClick){var i={};t&&(i.uuid=t.uuid,i.floorId=t.parent.userData.id,i.userId=t.parent.userData.id),e.objClick(i)}}),o.signals.objectFocused.add(function(t){e&&e.objDblClick&&e.objDblClick(t)}),o.signals.selectPosition.add(function(t){if(e&&e.selectPosition){var i={};t?(i.object=t.object,i.parentUesrId=t.object.parent.userData.id,i.longname=t.object.parent.userData.longname,i.floorId=t.object.parent.userData.id,i.position={x:t.point.x,y:t.point.y,z:t.point.z},e.selectPosition(i)):e.selectPosition()}}),o.signals.libraryClick.add(function(t){e&&e.libraryClick&&e.libraryClick(t)}),o.signals.cameraChanged.add(function(t){e&&e.cameraChanged&&e.cameraChanged(n.editor.camera)});try{o.createTopologyManager(a.renderer,o.camera,a.onMovePosition,a.postRender)}catch(t){}document.addEventListener("keydown",function(t){switch(t.keyCode){case 8:if("INPUT"!=t.target.nodeName&&"TEXTAREA"!=t.target.nodeName){t.preventDefault();break}}},!1);var s=function(t){e&&e.resize&&e.resize(t),o.signals.windowResize.dispatch()};return window.addEventListener("resize",s,!1),o.clear(),s(),!0},SoonSpace.prototype.defined=function(t){return void 0!==t&&null!==t},SoonSpace.prototype.defaultValue=function(t,e){return void 0!==t&&null!==t?t:e},SoonSpace.prototype.freezeObject=function(){var t=Object.freeze;return this.defined(t)||(t=function(t){return t}),t},SoonSpace.prototype.defaultValue.EMPTY_OBJECT=SoonSpace.prototype.freezeObject({}),SoonSpace.prototype.SetDefaultLight=function(){this.createAmbientLight({color:10132122,name:"MainAmbientLight"}),this.createDirectionalLight({color:16777215,intensity:1,name:"MainDirectionalLight",direction:{x:1,y:.5,z:.8}}),this.createHemisphereLight({skyColor:4494832,groundColor:11251373,intensity:.05,name:"MainHemisphereLight",position:{x:0,y:0,z:10}})},SoonSpace.prototype.SetDefaultLightDark=function(){var t=new THREE.AmbientLight(10132122,.1);return t.name="MainAmbientLight",this.editor.addObject(t),t},SoonSpace.prototype.SetDefaultMaterial=function(t){this.addDeviceMaterial({textureUrl:t?"../image/poi/poi_icon_led.png":"",id:"0",color:16777215}),this.addDeviceMaterial({textureUrl:t?"../image/poi/tip_gw_normal.png":"",id:"1",color:16777215}),this.addDeviceMaterial({textureUrl:t?"../image/poi/poi_icon_sensor.png":"",id:"2",color:16777215})},SoonSpace.prototype.SetControlWheelScale=function(t){this.viewport.controls.wheelscale=t},SoonSpace.prototype.updateBoundingBox=function(){this.editor.updateSceneBoundingBox()},SoonSpace.prototype.getSceneBoundingBox=function(t){var e=this.editor.bbox;return!0!==t&&null!=e||(this.editor.updateSceneBoundingBox(),e=this.editor.bbox),{min:{x:e.min.x,y:e.min.y,z:e.min.z},max:{x:e.max.x,y:e.max.y,z:e.max.z}}},SoonSpace.prototype.ShowPoi=function(t){for(i=0;i<editor.poiManager.poiScene.children.length;i++)if(obj=editor.poiManager.poiScene.children[i],obj instanceof VB.Layer)for(j=0;j<obj.children.length;j++){var e=obj.children[j];-1!=t&&e.userData.floorid!=t||(e.visible=!0)}},SoonSpace.prototype.HidePoi=function(t){for(i=0;i<editor.poiManager.poiScene.children.length;i++)if(obj=editor.poiManager.poiScene.children[i],obj instanceof VB.Layer)for(j=0;j<obj.children.length;j++){var e=obj.children[j];-1!=t&&e.userData.floorid!=t||(e.visible=!1)}},SoonSpace.prototype.SetOpcities=function(t,e){for(j=0;j<t.children.length;j++)t.children[j].material.opacity=e},SoonSpace.prototype.FadeInOutObject=function(t,e){var i={callback:function(t){t.visible="in"!=e}};for(j=0;j<t.children.length;j++)fadeMesh(t.children[j],e,i)},SoonSpace.prototype.ShowFloor=function(t){for(i=0;i<editor.scene.children.length;i++)if(obj=editor.scene.children[i],obj instanceof THREE.Object3D)for(j=0;j<obj.children.length;j++){var e=obj.children[j];e instanceof THREE.Object3D&&e.userData.type&&"floor"==e.userData.type.toLowerCase()&&(-1!=t&&e.userData.id!=t||(e.visible=!0))}},SoonSpace.prototype.GetFloorObject=function(t){for(i=0;i<editor.scene.children.length;i++)if(obj=editor.scene.children[i],"Object3D"===obj.type)for(j=0;j<obj.children.length;j++){var e=obj.children[j];if(e instanceof THREE.Object3D&&e.userData.type&&"floor"==e.userData.type.toLowerCase()&&(-1==t||e.userData.id==t))return e}},SoonSpace.prototype.HideFloor=function(t){for(i=0;i<editor.scene.children.length;i++)if(obj=editor.scene.children[i],obj instanceof THREE.Object3D)for(j=0;j<obj.children.length;j++){var e=obj.children[j];e instanceof THREE.Object3D&&e.userData.type&&"floor"==e.userData.type.toLowerCase()&&(-1!=t&&e.userData.id!=t||(e.visible=!1))}},SoonSpace.prototype.GetFloorInfoArray=function(){var t=[];for(i=0;i<editor.scene.children.length;i++)if(obj=editor.scene.children[i],obj instanceof THREE.Object3D)for(j=0;j<obj.children.length;j++){var e=obj.children[j];e instanceof THREE.Object3D&&e.userData.type&&"floor"==e.userData.type.toLowerCase()&&t.push({id:e.userData.id,name:e.name})}return t.sort(function(t,e){return t.id-e.id}),t};var setY=!1;function getObject(t,e,i){for(var r=0;r<t.scene.children.length;++r){var n=t.scene.children[r];if(n.userData.id===e)return t.getChildByUserData(n,"id",i)}}SoonSpace.prototype.IsDivideFloor=function(){return setY},SoonSpace.prototype.DivideFloor=function(t){function e(e,i,r){var n=0;for(o=0;o<e.length;o++)e[o].object instanceof THREE.Object3D&&(n=Math.max(n,e[o].value));null!=t&&t>0&&(n=t);for(var o=0;o<e.length;++o)for(var a=0;a<e.length;++a)if(e[a].id==o){e[a].object instanceof THREE.Object3D&&new TWEEN.Tween(e[a].object.position).to({x:e[a].object.position.x,y:e[a].object.position.y+n*i*o,z:e[a].object.position.z},500).easing(TWEEN.Easing.Linear.None).start();break}}var r=this.editor,n=(this.viewport,[]);for(i=0;i<r.scene.children.length;i++)if(obj=r.scene.children[i],obj instanceof THREE.Object3D)for(j=0;j<obj.children.length;j++){var o=obj.children[j];if(o instanceof THREE.Object3D&&o.userData.type&&"floor"===o.userData.type.toLowerCase())if(o.userData.id>=0){var a=(new THREE.Box3).setFromObject(o),s=a.max.y-a.min.y;n.push({id:1*o.userData.id,value:s,object:o})}}setY?(e(n,-1),setY=!1):(e(n,1),setY=!0)},SoonSpace.prototype.DivideFloorAndZoomFloor=function(t,e,r){function n(n,o,a){var s=0;for(i=parseInt(e);i<n.length;i++)n[i].object instanceof THREE.Object3D&&(s=Math.max(s,n[i].value));for(null!=t&&t>0&&(s=t),i=parseInt(e);i<n.length;i++){const t=i;n[i].object instanceof THREE.Object3D&&new TWEEN.Tween(n[i].object.position).to({x:n[i].object.position.x,y:n[i].object.position.y+s*o*n[i].id,z:n[i].object.position.z},500).easing(TWEEN.Easing.Linear.None).start().onComplete(function(){r&&r(e,t)})}}var o=this.editor,a=(this.viewport,[]),s=[];for(i=0;i<o.scene.children.length;i++)if(obj=o.scene.children[i],obj instanceof THREE.Object3D)for(j=0;j<obj.children.length;j++){var h=obj.children[j];if(h instanceof THREE.Object3D){var c=h.userData.id;if(c){var u=(new THREE.Box3).setFromObject(h),p=u.max.y-u.min.y;for(a.push({id:c,value:p,object:h}),k=0;k<o.poiManager.poiScene.children.length;k++)if(obj3=o.poiManager.poiScene.children[k],obj3 instanceof VB.Layer)for(l=0;l<obj3.children.length;l++){var d=obj3.children[l];d.userData.floorid==h.name&&s.push({id:c,value:p,object:d})}}}}setY?(setY=!1,n(a,-1)):(setY=!0,n(a,1))},SoonSpace.prototype.fitBoundingBoxToScreen=function(t,e,i,r,n){var o=this.editor,a=this.viewport,s=new THREE.Box3(new THREE.Vector3(t.x,t.y,t.z),new THREE.Vector3(e.x,e.y,e.z));o.fitBoundingBoxToScreen(a.getWidth(),a.getHeight(),s,!0===i,r,n)},SoonSpace.prototype.setViewpoint=function(t,e,i,r,n){this.editor,this.viewport;this.fitBoundingBoxToScreen(e,i,r,t,n)},SoonSpace.prototype.setZoomToMousePosition=function(t){this.viewport.controls.centerzoom=!t},SoonSpace.prototype.createFire=function(t,e,i,r){this.editor.createFire(t,e,i,r)},SoonSpace.prototype.removeFire=function(t){this.editor.removeFire(t)},SoonSpace.prototype.createSmoke=function(t){return this.editor.createSmoke(t)},SoonSpace.prototype.createWaterFall=function(t){return this.editor.createWaterFall(t)},SoonSpace.prototype.removeWaterFall=function(t){this.editor.removeWaterFall(t)},SoonSpace.prototype.setBackgroundColor=function(t){this.viewport.renderer.setClearColor(t),this.editor.scene.background=new THREE.Color(t)},SoonSpace.prototype.setBackgroundImage=function(t){(new THREE.TextureLoader).load(t,function(t){t.wrapS=THREE.MirroredRepeatWrapping,t.wrapT=THREE.MirroredRepeatWrapping,editor.scene.background=t})},SoonSpace.prototype.setSelectMode=function(t){this.editor.selectMode=t},SoonSpace.prototype.getSelectMode=function(){return this.editor.selectMode},SoonSpace.prototype.render=function(){this.viewport.renderByState()},SoonSpace.prototype.clear=function(){this.editor.clear()},SoonSpace.prototype.enableEditControl=function(t){this.viewport.controls.enabled=t},SoonSpace.prototype.zoom=function(t){this.viewport.controls.zoom(new THREE.Vector3(0,0,t))},SoonSpace.prototype.pan=function(t){this.viewport.controls.pan(t)},SoonSpace.prototype.rotate=function(t){this.viewport.controls.rotate(t,!0)},SoonSpace.prototype.startRotateByCenter=function(t,e,i){SoonSpace.viewport.controls.rotateRad=new THREE.Vector3(t,e,i)},SoonSpace.prototype.stopRotateByCenter=function(){SoonSpace.viewport.controls.rotateRad=new THREE.Vector3},SoonSpace.prototype.getMainCameraPosition=function(){var t=this.editor.camera.position;return{x:t.x,y:t.y,z:t.z}},SoonSpace.prototype.setZoomFactor=function(){},SoonSpace.prototype.selectObjByScreenCoordinate=function(t){},SoonSpace.prototype.changeClippingLength=function(t){this.editor.scene.traverse(function(e){if(e instanceof THREE.Mesh&&e.material.clippingPlanes){for(var i=0;i<e.material.clippingPlanes.length;i++)e.material.clippingPlanes[i].constant=t;e.material.needsUpdate=!0}})},SoonSpace.prototype.insertClipping=function(t,e,i,r){this.viewport.renderer.localClippingEnabled=!0;var n=new THREE.Plane(new THREE.Vector3(t,e,i),r);this.editor.scene.traverse(function(t){t instanceof THREE.Mesh&&(t.material.clippingPlanes?t.material.clippingPlanes.push(n):t.material.clippingPlanes=[n],t.material.clipIntersection=!0,t.material.needsUpdate=!0)})},SoonSpace.prototype.removeClipping=function(t,e,i,r){var n=new THREE.Vector3(t,e,i);this.editor.scene.traverse(function(t){if(t instanceof THREE.Mesh){if(t.material.clippingPlanes)for(var e=t.material.clippingPlanes.length-1;e>=0;e--)t.material.clippingPlanes[e].normal.equals(n)&&t.material.clippingPlanes[e].constant==r&&t.material.clippingPlanes.splice(e,1);t.material.needsUpdate=!0}})},SoonSpace.prototype.showClipping=function(){this.editor.scene.traverse(function(t){t instanceof THREE.Mesh&&(t.material.clipIntersection=!0)}),this.viewport.renderer.localClippingEnabled=!0},SoonSpace.prototype.hideClipping=function(){this.editor.scene.traverse(function(t){t instanceof THREE.Mesh&&(t.material.clipIntersection=!1)}),this.viewport.renderer.localClippingEnabled=!1},SoonSpace.prototype.setVisibleLight=function(t,e,i){editor.LibraryManager.setVisibleLight(t,e,i)},SoonSpace.prototype.setModelTransparent=function(t){this.editor.scene.traverse(function(e){e instanceof THREE.Mesh&&(e.opacity_bak=e.material.opacity,e.material.opacity=t,e.material.alphaTest=0,e.material.transparent=!0,e.material.needsUpdate=!0)})},SoonSpace.prototype.restoreModelTransparent=function(){this.editor.scene.traverse(function(t){t instanceof THREE.Mesh&&(t.opacity_bak&&(t.material.opacity=t.opacity_bak),t.material.alphaTest=.5,t.material.needsUpdate=!0)})},SoonSpace.prototype.createLabelEditor=function(t){this.editor.createLabelRenderer(t)},SoonSpace.prototype.importGML=function(t){if(null!=t.topologyID&&null!=t.fileUrl){var e=this.editor,i=e.getChildByUserData(e.scene,"id",t.parentID,!0);null==i&&(i=e.scene);var r=this;new VB.GMLLoader(this.editor.topologyManager).load(t.fileUrl,function(e){e.userData.type="topology",e.name="topology",e.userData.id=t.topologyID,null!=t.visible&&(e.visible=t.visible),t.offsetElevation&&e.translateY(t.offsetElevation),r.editor.importModel(e,i),t.onLoad&&t.onLoad(e.uuid)})}},SoonSpace.prototype.showTopologyByType=function(t){if(null!=t.topologyID&&null!=t.type&&null!=t.visible){var e=this.editor,i=e.getChildByUserData(e.scene,"id",t.topologyID,!0);i&&i.traverse(function(e){var i=-1;i=e instanceof VB.Node?1:e instanceof VB.Link?2:-1,(t.type===i||0===t.type&&i>0)&&(e.visible=t.visible)})}},SoonSpace.prototype.setTopologyColor=function(t){if(null!=t){var e=this.defaultValue(new THREE.Color(t.color),VB.NodeMaterial.color),i=!1,r=this.defaultValue(t.opacity,1);r>=0&&r<1&&(i=!0),1===t.type?(VB.NodeMaterial.color=e,VB.NodeMaterial.opacity=r,VB.NodeMaterial.transparent=i):2===t.type?(VB.LinkMaterial.available.color=e,VB.LinkMaterial.available.opacity=r,VB.LinkMaterial.available.transparent=i):0===t.type&&(VB.NodeMaterial.color=e,VB.NodeMaterial.opacity=r,VB.NodeMaterial.transparent=i,VB.LinkMaterial.available.color=e,VB.LinkMaterial.available.opacity=r,VB.LinkMaterial.available.transparent=i)}},SoonSpace.prototype.removeTopology=function(t){var e=this.editor,i=e.getChildByUserData(e.scene,"id",t,!0);i&&e.removeObject(i)},SoonSpace.prototype.clearTopology=function(){var t=this.editor,e=[];t.scene.traverse(function(t){"topology"===t.userData.type&&e.push(t)});for(var i=0;i<e.length;++i)t.removeObject(e[i])},SoonSpace.prototype.findShortestPath=function(t){if(null!=t&&null!=t.topologyID){var e=this.editor,i=e.getChildByUserData(e.scene,"id",t.toplogyID,!0);e.topologyManager.makeGraph(i);var r=e.topologyManager.getPaths(i,t.startGMLID,t.endGMLID);return e.importModel(i.parent,r),r.uuid}},SoonSpace.prototype.removePathByUUID=function(t){if(null!=t){var e=this.editor.getChildByProperty(this.editor.scene,"uuid",t,!0);e&&(this.editor.removeGeometry(e.geometry),e.material.map&&this.editor.removeTexture(e.material.map.sourceFile),this.editor.removeMaterial(e.material.uuid),this.editor.removeObject(e))}},SoonSpace.prototype.setPathColor=function(t,e){if(null!=t){var i=this.editor.getChildByProperty(this.editor.scene,"uuid",t,!0);i&&i.material.map&&i.material.map.color.set(e.color)}},SoonSpace.prototype.showPath=function(t,e){if(null!=t){var i=this.editor.getChildByProperty(this.editor.scene,"uuid",t,!0);i&&(i.visible=e)}},SoonSpace.prototype.checkHandicappedPath=function(){var t=this.editor.topologyManager.restrict_bit;return!t||4&t},SoonSpace.prototype.findShortestPathByPosition=function(t){if(null!=t&&null!=t.topologyID&&null!=t.positions&&!(t.positions.length<2)){var e=this.editor,i=e.getChildByUserData(e.scene,"id",t.topologyID,!0);e.topologyManager.updateLink(i,t.restrict),e.topologyManager.makeGraph(i);for(var r=[],n=0;n<t.positions.length;++n){var o=t.positions[n].position,a=h(i,new THREE.Vector3(o.x,o.y,o.z),t.positions[n].floorId,t.positions[n].longname);r.push(a.gmlid)}var s=e.topologyManager.getPaths(i,r);return null!=s?(e.importModel(s,i.parent),s.uuid):void 0}function h(t,e,i,r){var n,o=Number.MAX_VALUE,a=function(t,e,i){for(var r=0;r<t.children.length;++r){var n=t.children[r];if(i&&n.userData.id===i)return n;if(n.userData.id===e)return n}}(t,i,r);if(a)for(var s=0;s<a.children.length;++s){var h=a.children[s];if(h instanceof VB.Node){var l=h.getWorldPosition().clone().distanceTo(e);o>l&&(o=l,n=h)}}return n}},SoonSpace.prototype.getDistanceOfPath=function(t){if(null!=t){var e=this.editor.getChildByProperty(this.editor.scene,"uuid",t,!0);return e?e.geometry.parameters.path.getLength():0}},SoonSpace.prototype.followPath=function(t){switch(t.cmd){case 1:if(t.pathUUID){var e=this.editor.getChildByProperty(this.editor.scene,"uuid",t.pathUUID,!0);e&&(this.editor.topologyManager.stop(),this.viewport.enable=!1,this.viewport.stopAnimate(),this.editor.topologyManager.path=e.geometry,this.editor.topologyManager.speed=t.speed,this.editor.topologyManager.DriveMode=t.mode,this.editor.topologyManager.DrivePoi=t.poi,this.editor.topologyManager.enableAutoLookAt=t.lookat,this.editor.topologyManager.start())}break;case 2:this.editor.topologyManager.pause();break;case 3:this.editor.topologyManager.stop(),-1==this.viewport.renderRequestId&&(this.viewport.enable=!0,this.viewport.animate())}},SoonSpace.prototype.importGKXML=function(t,e,i,r,n,o){var a=this.editor;this.viewport;a.deselect();var s=new VB.GKXMLLoader;s.setResoucreManager(a.textures),s.load(e,function(t){if(!0===o)for(var e=0;e<this.editor.scene.children.length;++e){var r=a.getBoundingBox(a.scene.children[e],!0),n=r.getCenter();n.y=r.min.y;var s=(new THREE.Matrix4).makeTranslation(-n.x,-n.y,-n.z);a.scene.children[e].traverse(function(t){t instanceof THREE.Mesh&&(t.geometry.applyMatrix(s),t.geometry.computeBoundingSphere(),t.geometry.computeBoundingBox(),t.geometry.computeVertexNormals(!0),t.geometry.computeFaceNormals(),t.position.addVectors(t.position,n))})}a.importModel(t,a.scene),i&&i({object:t})},r,n,null)},SoonSpace.prototype.importAssetJson=function(t,e,i,r,n){var o=this.editor;this.viewport;o.deselect();var a=new VB.AssetLoader;a.setResoucreManager(o.textures),a.loadJson(this,t,function(t){if(!0===n)for(var i=0;i<this.editor.scene.children.length;++i){var r=o.getBoundingBox(o.scene.children[i],!0),a=r.getCenter();a.y=r.min.y;var s=(new THREE.Matrix4).makeTranslation(-a.x,-a.y,-a.z);o.scene.children[i].traverse(function(t){t instanceof THREE.Mesh&&(t.geometry.applyMatrix(s),t.geometry.computeBoundingSphere(),t.geometry.computeBoundingBox(),t.geometry.computeVertexNormals(!0),t.geometry.computeFaceNormals(),t.position.addVectors(t.position,a))})}o.importModel(t,o.scene),e&&e({userId:t.userData.id})},i,r,null)},SoonSpace.prototype.importAssetXML=function(t,e,i,r,n){var o=this.editor;this.viewport;o.deselect();var a=new VB.AssetLoader;a.setResoucreManager(o.textures),a.load(this,t,function(t){if(!0===n)for(var i=0;i<this.editor.scene.children.length;++i){var r=o.getBoundingBox(o.scene.children[i],!0),a=r.getCenter();a.y=r.min.y;var s=(new THREE.Matrix4).makeTranslation(-a.x,-a.y,-a.z);o.scene.children[i].traverse(function(t){t instanceof THREE.Mesh&&(t.geometry.applyMatrix(s),t.geometry.computeBoundingSphere(),t.geometry.computeBoundingBox(),t.geometry.computeVertexNormals(!0),t.geometry.computeFaceNormals(),t.position.addVectors(t.position,a))})}o.importModel(t,o.scene),e&&e({userId:t.userData.id})},i,r,null)},SoonSpace.prototype.insertGateware=function(t,e,i,r){var n=this.editor;void 0==r&&(r=0);var o=n.LibraryManager.InsertLibrary(this,0,t,e,r,0),a={id:0,name:i,materialId:1,width:20,height:20,position:{x:e.x,y:e.y,z:e.z}},s=this.createDevice(a,o);return n.DeviceManager.getDeviceByProperty("uuid",s)},SoonSpace.prototype.insertSense=function(t,e,i){var r=this.editor;void 0==i&&(i=0);var n=r.LibraryManager.InsertLibrary(this,0,t,e,i,0),o={id:0,name:"",materialId:2,width:20,height:20,position:{x:e.x,y:e.y,z:e.z}},a=this.createDevice(o,n);return r.DeviceManager.getDeviceByProperty("uuid",a)},SoonSpace.prototype.insertLED=function(t,e,i){var r=this.editor;void 0==i&&(i=0);var n=r.LibraryManager.InsertLibrary(this,0,t,e,i,0),o={id:0,name:"",materialId:0,width:20,height:20,position:{x:e.x,y:e.y,z:e.z}},a=this.createDevice(o,n);return r.DeviceManager.getDeviceByProperty("uuid",a)},SoonSpace.prototype.insertLibrary=function(t,e,i,r,n,o,a){var s=this.editor;void 0==n&&(n=0),void 0==a&&(a=100);var h=s.LibraryManager.InsertLibrary(this,t,e,i,n,o,a),l={id:0,name:r||"",materialId:0,width:20,height:20,position:{x:i.x,y:i.y,z:i.z}},c=this.createDevice(l,h);return s.DeviceManager.getDeviceByProperty("uuid",c)},SoonSpace.prototype.insertLEDPointLight=function(t,e,i,r,n,o,a,s){var h=this.editor;void 0==a&&(a=0);var l={color:16777215,position:{x:e.x,y:e.y,z:e.z},target:{x:e.x,y:e.y-2e3,z:e.z},intensity:1,distance:500,decay:1,shapetype:r,width:n,height:o,angle:a,enablelight:s},c=this.createLEDLight(l),u={id:0,name:i||"",materialId:0,width:20,height:20,position:{x:e.x,y:e.y,z:e.z}},p=this.createDevice(u,c);return h.DeviceManager.getDeviceByProperty("uuid",p)},SoonSpace.prototype.insertLightingLibrary=function(t,e,i,r,n){var o=this.editor;void 0==r&&(r=0),void 0==n&&(n=100);var a=o.LibraryManager.InsertLibrary(this,0,t,e,r,n),s={id:0,name:i||"",materialId:0,width:20,height:20,position:{x:e.x,y:e.y,z:e.z}},h=this.createDevice(s,a);return o.DeviceManager.getDeviceByProperty("uuid",h)},SoonSpace.prototype.loadLibrary=function(t,e,i,r){var n=this.editor;try{n.LibraryManager.LoadLibrary(this,t,e,i,r)}catch(t){}},SoonSpace.prototype.loadSbm=function(t){return new Promise((e,i)=>{switch(Object.prototype.toString.call(t).split("[object ")[1].split("]")[0].toLowerCase()){case"object":this.loadSbmItem(t).then(function(t){e(t)});break;case"array":const i=[];t.map(t=>{this.loadSbmItem(t).then(function(t){i.push(t)})}),e(i)}})},SoonSpace.prototype.loadSbmList=function(t){return new Promise(function(e,i){const r=[];t.map(function(t){this.loadSbmItem(t).then(function(t){r.push(t)})}),e(r)})},SoonSpace.prototype.loadSbmItem=function(t){return new Promise(function(e,i){var r=this.editor;r.deselect();var n=new VB.SBMLoader;n.textures=r.textures,n.load(t.url,t,function(t,i){r.importModel(t,r.scene),e(t)},null,function(t){i(t)})})},SoonSpace.prototype.importSBM=function(t,e,i,r,n,o,a){var s=this.editor;this.viewport;s.deselect();for(var h,l=0,c=this.viewport.renderer.capabilities.getMaxAnisotropy(),u=0;u<this.editor.scene.children.length;++u)if("Group"===s.scene.children[u].type){h=s.scene.children[u];break}null==h&&((h=new THREE.Group).userData.type="indoor",h.userData.id=t,null==t&&(h.userData.id=h.uuid.toString()),h.visible=!0);var p=function(t,u){var p=new VB.SBMLoader;p.worker=n,p.textures=s.textures,p.load(t.fileUrl,t,function(t,r){if(l++,t.userData.type="floor",!0===o){var n=s.getBoundingBox(t,!0),a=n.getCenter();a.y=n.min.y;var p=(new THREE.Matrix4).makeTranslation(-a.x,-a.y,-a.z);t.traverse(function(t){t instanceof THREE.Mesh&&(t.geometry.applyMatrix(p),t.geometry.computeBoundingSphere(),t.geometry.computeBoundingBox(),t.geometry.computeVertexNormals(!0),t.geometry.computeFaceNormals(),t.position.addVectors(t.position,a))})}if(h.add(t),l>=e.length)s.importModel(h,s.scene),i&&i(h);else if(l<e.length){var d=e[l];d.anisotropy=c,u(d,u)}},void 0!==r?r:void 0,a)},d=e[l];d.anisotropy=c,p(d,p)},SoonSpace.prototype.clearPointLight=function(){for(var t=[],e=0;e<this.editor.scene.children.length;++e)"pointlight"===this.editor.scene.children[e].userData.type&&t.push(this.editor.scene.children[e]);for(e=0;e<t.length;++e)this.editor.removeObject(t[e])},SoonSpace.prototype.clearSBM=function(){for(var t=[],e=0;e<this.editor.scene.children.length;++e)if("indoor"===this.editor.scene.children[e].userData.type){t.push(this.editor.scene.children[e]),this.editor.poiManager.poiScene.userData[this.editor.scene.children[e].userData.id]={};break}for(e=0;e<t.length;++e)this.editor.removeObject(t[e])},SoonSpace.prototype.clearObject3D=function(){this.editor.scene.traverse(t=>{"Object3D"===t.type&&t.parent.remove(t)})},SoonSpace.prototype.removeSBM=function(t,e){this.editor,this.viewport;for(var i=0;i<this.editor.scene.children.length;++i){var r=this.editor.scene.children[i];if(r.userData.id===t){var n=this.editor.getChildByUserData(r,"id",e);this.editor.removeObject(n),null!=this.editor.poiManager.poiScene.userData[t]&&null!=this.editor.poiManager.poiScene.userData[t][e]&&delete this.editor.poiManager.poiScene.userData[t][e];break}}},SoonSpace.prototype.showSBM=function(t,e,i){this.editor,this.viewport;for(var r=0;r<this.editor.scene.children.length;++r){var n=this.editor.scene.children[r];if(n.userData.id===t){var o=this.editor.getChildByUserData(n,"id",e);if("floor"===o.userData.type.toLowerCase()){o.visible=i;break}}}},SoonSpace.prototype.isExistSBM=function(t,e){this.editor,this.viewport;for(var i=0;i<this.editor.scene.children.length;++i){if(this.editor.scene.children[i].userData.id===t)if("floor"===this.editor.getChildByUserData("id",e).userData.type.toLowerCase())return!0}return!1},SoonSpace.prototype.selectObjByUserId=function(t){var e=this.editor.getChildByUserData(this.editor.scene,"id",t,!0);e&&this.editor.select(e)},SoonSpace.prototype.setSBMColorByUserID=function(t,e,i,r){var n=this.editor;this.viewport;function o(t,e,i){var r=n.materials[t.material.uuid];r&&(t.userData.srcMaterial=r.uuid,r=r.clone()),e&&r.color.set(e),i&&(r.opacity=i),t.material=r}var a=getObject(n,t,e);if(a)if("floor"===a.userData.type.toLowerCase())for(var s=0;s<a.children.length;++s){var h=a.children[s];h instanceof THREE.Mesh&&o(h,i,r)}else a instanceof THREE.Mesh&&o(a,i,r)},SoonSpace.prototype.restoreSBMColorByUserID=function(t,e){var i=this.editor;this.viewport;function r(t,e){var r=e.userData.srcMaterial;if(r){var n=i.materials[r];e.material=n}}var n=getObject(i,t,e);if(n)if("floor"===n.userData.type.toLowerCase())for(var o=0;o<n.children.length;++o){var a=n.children[o];a instanceof THREE.Mesh&&r(n.userData.materials,a)}else n instanceof THREE.Mesh&&this.editor.restoreMaterial(n.parent.userData.materials,n)},SoonSpace.prototype.enableSBM2DMode=function(t,e){var i=!1===e?1:.01,r=this.editor.getChildByUserData(this.editor.scene,"id",t,!0);if(r)for(var n=0;n<r.children.length;++n){var o=r.children[n];if("floor"===o.userData.type.toLowerCase())for(var a=this.editor.getBoundingBox(o,!0),s=0;s<o.children.length;++s)!1===e?o.children[s].position.y=o.children[s].oldpositionY:(o.children[s].oldpositionY=o.children[s].position.y,o.children[s].position.y+=a.min.y),o.children[s].scale.y=i}},SoonSpace.prototype.spreadSBM=function(t,e,i,r){var n=function(t){var e=t.scalar;return t.baseFloor>0?e*=t.baseFloor-1:e*=t.baseFloor,e};null!=r&&(n=r);var o=this.editor.getChildByUserData(this.editor.scene,"id",t,!0);if(o){for(var a,s=0;s<o.children.length;++s){if("topology"===(l=o.children[s]).userData.type){a=l;break}}var h={};for(s=0;s<o.children.length;++s){var l;if("floor"===(l=o.children[s]).userData.type.toLowerCase()){var c=n({scalar:e,baseFloor:l.userData.baseFloor,floorId:l.userData.id});if(l.translateOnAxis((new THREE.Vector3).set(i.x,i.y,i.z),c),l.updateMatrix(),l.updateMatrixWorld(),null!=this.editor.poiManager.poiScene.userData[t]&&null!=this.editor.poiManager.poiScene.userData[t][l.userData.id]){var u=this.editor.poiManager.poiScene.userData[t][l.userData.id];if(u){var p=new THREE.Vector3;for(var d in p.copy(i),p.multiplyScalar(c),u){var f=u[d];f.pos3D.addVectors(f.pos3D,p)}}}a&&(h[l.userData.id]=c)}}if(null!=a)for(s=0;s<a.children.length;++s){var m=a.children[s];null!=(c=h[m.userData.id])&&(m.translateOnAxis((new THREE.Vector3).set(i.x,i.y,i.z),c),m.updateMatrix(),m.updateMatrixWorld())}this.updateBoundingBox()}},SoonSpace.prototype.spreadSBMByBoundingBox=function(t,e,i,r){var n=function(t){var e=0,r=Math.abs(t.bb.max.x-t.bb.min.x),n=Math.abs(t.bb.max.z-t.bb.min.z),o=i.x<i.z?r:n;return t.baseFloor!==t.preBaseFloor&&(e=t.baseFloor>0?o*t.magnification+t.prePositiveValue:o*t.magnification*-1+t.preNegativeValue),e},o=new THREE.Box3,a=0,s=0,h=0;null!=r&&(n=r);var l=this.editor.getChildByUserData(this.editor.scene,"id",t,!0);if(l){for(var c,u=0;u<l.children.length;++u){if("topology"===(d=l.children[u]).userData.type){c=d;break}}var p={};for(u=0;u<l.children.length;++u){var d;if("floor"===(d=l.children[u]).userData.type.toLowerCase()){var f=e;if(d.userData.baseFloor){0===u&&(h=d.userData.baseFloor);f=n({magnification:e,preBaseFloor:h,baseFloor:d.userData.baseFloor,floorId:d.userData.id,bb:o,prePositiveValue:a,preNegativeValue:s});if(d.userData.baseFloor>0?a=f:s=f,d.translateOnAxis((new THREE.Vector3).set(i.x,i.y,i.z),f),d.updateMatrix(),null!=this.editor.poiManager.poiScene.userData[t]&&null!=this.editor.poiManager.poiScene.userData[t][d.userData.id]){var m=this.editor.poiManager.poiScene.userData[t][d.userData.id];if(m){var g=new THREE.Vector3;for(var v in g.copy(i),g.multiplyScalar(f),m){var y=m[v];y.pos3D.addVectors(y.pos3D,g)}}}c&&(p[d.userData.id]=f),h!==d.userData.baseFloor?o=this.editor.getBoundingBox(d,!0):o.union(this.editor.getBoundingBox(d,!0)),h=d.userData.baseFloor}}}if(null!=c)for(u=0;u<c.children.length;++u){var E=c.children[u];null!=(f=p[E.userData.id])&&(E.translateOnAxis((new THREE.Vector3).set(i.x,i.y,i.z),f),E.updateMatrix())}this.updateBoundingBox()}},SoonSpace.prototype.setStairMode=function(t){var e=this.editor.getChildByUserData(this.editor.scene,"id",t,!0);if(e){if(!0===e.userData.StairMode)return!0;e.userData.StairMode=!0;for(var i,r=SoonSpace.getSceneBoundingBox(),n=(f=Math.abs(r.max.x-r.min.x))<(m=Math.abs(r.max.z-r.min.z))?new THREE.Vector3(1,0,0):new THREE.Vector3(0,0,1),o=0;o<e.children.length;++o){if("topology"===(x=e.children[o]).userData.type){i=x;break}}var a={},s={},h=0,l=0;for(o=0;o<e.children.length;++o){if("floor"===(x=e.children[o]).userData.type.toLowerCase()){r=this.editor.getBoundingBox(x,!0);var c=x.userData.baseFloor.toString();null==s[c]&&(s[c]={floors:[],bb:new THREE.Box3}),s[c].bb.union(r),s[c].floors.push(x),h>parseInt(x.userData.baseFloor)&&(h=parseInt(x.userData.baseFloor)),l<parseInt(x.userData.baseFloor)&&(l=parseInt(x.userData.baseFloor))}}var u=0,p=0;for(o=-1;o>h;--o){r=s[o.toString()].bb;for(var d=s[(o+1).toString()].bb,f=Math.abs(d.min.x-r.max.x),m=Math.abs(d.min.z-r.max.z),g=n.x<n.z?f:m,v=0;v<s[o.toString()].floors.length;++v){if((x=s[o.toString()].floors[v]).userData.StairMode={axis:n,value:u+g},x.translateOnAxis(x.userData.StairMode.axis,x.userData.StairMode.value),x.updateMatrix(),x.updateMatrixWorld(),_=this.editor.poiManager.poiScene.userData[t][x.userData.id]){var y=new THREE.Vector3;for(var E in y.copy(x.userData.StairMode.axis),y.multiplyScalar(x.userData.StairMode.value),_){(w=_[E]).pos3D.addVectors(w.pos3D,y)}}i&&(a[x.userData.id]=x.userData.StairMode)}u+=g}for(o=1;o<l+1;++o){for(r=s[o.toString()].bb,d=s[(o-1).toString()].bb,f=Math.abs(d.max.x-r.min.x),m=Math.abs(d.max.z-r.min.z),g=n.x>n.z?f:m,v=0;v<s[o.toString()].floors.length;++v){var x,_;if((x=s[o.toString()].floors[v]).userData.StairMode={axis:(new THREE.Vector3).set(n.x,n.y,n.z),value:p+g},x.translateOnAxis(x.userData.StairMode.axis,x.userData.StairMode.value),x.updateMatrix(),x.updateMatrixWorld(),null!=this.editor.poiManager.poiScene.userData[t]&&null!=this.editor.poiManager.poiScene.userData[t][x.userData.id])if(_=this.editor.poiManager.poiScene.userData[t][x.userData.id]){y=new THREE.Vector3;for(var E in y.copy(x.userData.StairMode.axis),y.multiplyScalar(x.userData.StairMode.value),_){var w;(w=_[E]).pos3D.addVectors(w.pos3D,y)}}i&&(a[x.userData.id]=x.userData.StairMode)}p+=g}for(o=0;o<i.children.length;++o){var b=i.children[o],S=a[b.userData.id];null!=S&&(b.translateOnAxis(S.axis,S.value),b.updateMatrix(),b.updateMatrixWorld())}this.updateBoundingBox()}},SoonSpace.prototype.cancelStairMode=function(t){var e=this.editor.getChildByUserData(this.editor.scene,"id",t,!0);if(e){if(1!=e.userData.StairMode)return!0;var i;e.userData.StairMode=!1;for(var r=0;r<e.children.length;++r){if("topology"===(p=e.children[r]).userData.type){i=p;break}}var n={},o={},a=0,s=0;for(r=0;r<e.children.length;++r){if("floor"===(p=e.children[r]).userData.type.toLowerCase()){var h=p.userData.baseFloor.toString();null==o[h]&&(o[h]={floors:[]}),o[h].floors.push(p),a>parseInt(p.userData.baseFloor)&&(a=parseInt(p.userData.baseFloor)),s<parseInt(p.userData.baseFloor)&&(s=parseInt(p.userData.baseFloor))}}for(r=-1;r>a;--r)for(var l=0;l<o[r.toString()].floors.length;++l){if((p=o[r.toString()].floors[l]).translateOnAxis(p.userData.StairMode.axis,-p.userData.StairMode.value),p.updateMatrix(),p.updateMatrixWorld(),null!=this.editor.poiManager.poiScene.userData[t]&&null!=this.editor.poiManager.poiScene.userData[t][p.userData.id])if(d=this.editor.poiManager.poiScene.userData[t][p.userData.id]){var c=new THREE.Vector3;for(var u in c.copy(p.userData.StairMode.axis),c.multiplyScalar(-p.userData.StairMode.value),d){(f=d[u]).pos3D.addVectors(f.pos3D,c)}}i&&(n[p.userData.id]=p.userData.StairMode)}for(r=1;r<s+1;++r)for(l=0;l<o[r.toString()].floors.length;++l){var p,d;if((p=o[r.toString()].floors[l]).translateOnAxis(p.userData.StairMode.axis,-p.userData.StairMode.value),p.updateMatrix(),p.updateMatrixWorld(),d=this.editor.poiManager.poiScene.userData[t][p.userData.id]){c=new THREE.Vector3;for(var u in c.copy(p.userData.StairMode.axis),c.multiplyScalar(-p.userData.StairMode.value),d){var f;(f=d[u]).pos3D.addVectors(f.pos3D,c)}}i&&(n[p.userData.id]=p.userData.StairMode)}for(r=0;r<i.children.length;++r){var m=i.children[r],g=n[m.userData.id];null!=g&&(m.translateOnAxis(g.axis,-g.value),m.updateMatrix(),m.updateMatrixWorld())}this.updateBoundingBox()}},SoonSpace.prototype.createAmbientLight=function(t){if(null!=t){var e=new THREE.AmbientLight(t.color);return e.name=null==t.name?"ambientLight":t.name,this.editor.addObject(e),e.uuid}},SoonSpace.prototype.createDirectionalLight=function(t){if(null!=t){var e=new THREE.DirectionalLight(t.color,t.intensity);e.name=null==t.name?"directionalLight":t.name,e.position.set(t.direction.x,t.direction.y,t.direction.z),e.castShadow=!0;var i=t.depth;if(e.shadow.mapSize.width=1024,e.shadow.mapSize.height=1024,e.shadow.camera.near=t.near,e.shadow.camera.far=t.far,e.shadow.camera.right=-i,e.shadow.camera.left=i,e.shadow.camera.top=-i,e.shadow.camera.bottom=i,e.shadowDarkness=t.darkness,e.shadowBias=t.shadowBias,this.editor.addObject(e),this.editor.helpers[e.id].visible=!0===t.showHelper,t.showHelper){var r=new THREE.CameraHelper(e.shadow.camera);editor.scene.add(r)}return e.uuid}},SoonSpace.prototype.createHemisphereLight=function(t){if(null!=t){var e=new THREE.HemisphereLight(t.skyColor,t.groundColor,t.intensity);return e.name=null==t.name?"HemisphereLight":t.name,e.position.set(t.position.x,t.position.y,t.position.z),this.editor.addObject(e),this.editor.helpers[e.id].visible=!0===t.showHelper,e.uuid}},SoonSpace.prototype.createSpotLight=function(t){if(null!=t){var e=new THREE.SpotLight(t.color);return e.position.set(t.position.x,t.position.y,t.position.z),e.castShadow=!0,e.shadow.mapSize.width=1024,e.shadow.mapSize.height=1024,e.shadow.camera.near=500,e.shadow.camera.far=4e3,e.shadow.camera.fov=30,e.target.position.set(t.target.x,t.target.y,t.target.z),e.target.updateMatrixWorld(),e.angle=t.angle,e.distnace=t.distance,this.editor.addObject(e),this.editor.helpers[e.id].visible=!0===t.showHelper,e}},SoonSpace.prototype.createRectLight=function(t){if(null!=t){var e=new THREE.RectAreaLight(t.color,t.intensity,t.width,t.height);e.position.set(t.position.x,t.position.y,t.position.z);var i=new THREE.PlaneBufferGeometry(e.width,e.height,2,2),r=new THREE.MeshBasicMaterial({color:16777215,side:THREE.FrontSide}),n=new THREE.Mesh(i,r);e.add(n);var o=new THREE.PlaneBufferGeometry(e.width,e.height,2,2),a=new THREE.MeshBasicMaterial({color:526344,side:THREE.BackSide}),s=new THREE.Mesh(o,a);return e.add(s),this.editor.addObject(e),e}},SoonSpace.prototype.getAmbientLightUUIDs=function(){var t=[];return this.editor.scene.traverse(function(e){e instanceof THREE.AmbientLight&&t.push(e.uuid)}),t},SoonSpace.prototype.createLEDLight=function(t){if(null!=t){if(t.shapetype){switch(t.shapetype){case"square":(n=t.enablelight?new THREE.PointLight(t.color,t.intensity,t.distance,t.decay):new THREE.Object3D).castShadow=!0,n.position.set(t.position.x,t.position.y,t.position.z);var e=new THREE.PlaneBufferGeometry(t.width,t.height,2,2),i=new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide}),r=new THREE.Mesh(e,i);n.add(r);break;case"circle":var n;(n=t.enablelight?this.createSpotLight(t):new THREE.Object3D).position.set(t.position.x,t.position.y,t.position.z);break;default:(n=t.enablelight?new THREE.PointLight(t.color,t.intensity,t.distance,t.decay):new THREE.Object3D).position.set(t.position.x,t.position.y,t.position.z)}n.userData.type="pointlight",this.editor.addObject(n),t.enablelight&&(this.editor.helpers[n.id].visible=!0===t.showHelper)}return n}},SoonSpace.prototype.createLayer=function(t){this.editor.addLayer(t)},SoonSpace.prototype.showLayer=function(t,e){var i=[];i.push(t),this.editor.poiManager.showLayer(i,e)},SoonSpace.prototype.removeLayer=function(t){var e=this.editor.poiManager.getLayer(t);e&&this.editor.poiManager.removeLayer(e)},SoonSpace.prototype.addPOIMaterial=function(t){this.editor.poiManager.addMaterial(t)},SoonSpace.prototype.createPOI=function(t){if(null!=t){var e=this.editor.poiManager.materials[t.materialId],i={layerName:t.layerName,id:t.id,name:t.name,position:{x:t.position.x,y:t.position.y,z:t.position.z},width:t.width,height:t.height,icon:e.map.sourceFile,material:e,groupId:t.groupId,zindex:t.zindex,elevation:t.elevation,animation:t.animation,info:t.info};void 0!=t.margin&&(i.margin=t.margin);var r=this.editor.addPoi(i);if(r){if(r.visible=!0===t.visible||null==t.visible,t.animation&&r.setAnimation(),null!=t.floorid&&(r.userData.floorid=t.floorid,null==this.editor.poiManager.poiScene.userData[t.groupId]&&(this.editor.poiManager.poiScene.userData[t.groupId]={}),null==this.editor.poiManager.poiScene.userData[t.groupId][t.floorid]&&(this.editor.poiManager.poiScene.userData[t.groupId][t.floorid]={}),this.editor.poiManager.poiScene.userData[t.groupId][t.floorid][t.id]=r),t.lods)for(var n=0;n<t.lods.length;++n){var o=t.lods[n];r.addLOD(new VB.Poi.LOD(o.level,o.iconSize.width,o.iconSize.height,o.visibleText,o.visibleIcon,o.min,o.max))}return t.info&&r.createInfoForm(t.info),r}}},SoonSpace.prototype.createPOI3D=function(t){if(null!=t){var e=this.editor.addPoi3D(t);return e?(e.visible=!0===t.visible||null==t.visible,null!=t.floorid&&(e.userData.floorid=t.floorid),e.uuid):void 0}},SoonSpace.prototype.createPOI2D=function(t){if(null!=t){var e=this.editor.addPoi2D(t);if(e){if(null!=t.floorid&&(e.userData.floorid=t.floorid),t.lods)for(var i=0;i<t.lods.length;++i){var r=t.lods[i];e.addLOD(new VB.Poi.LOD(r.level,0,0,!1,!1,r.min,r.max))}return e}}},SoonSpace.prototype.removePOI=function(t){t&&this.editor.poiManager.removePoiByProperty("uuid",t)},SoonSpace.prototype.removePOI2D=function(t){t&&this.editor.removePoi2D(t)},SoonSpace.prototype.removePOI3D=function(t){t&&this.editor.poi3DManager.removePoiByProperty("uuid",t)},SoonSpace.prototype.setPOIColor=function(t,e,i,r,n){var o;t&&(o=this.editor.poiManager.getPoiByProperty("uuid",t))&&o.setColor(e,i,r,n)},SoonSpace.prototype.restorePOIColor=function(t){var e;t&&(e=this.editor.poiManager.getPoiByProperty("uuid",t))&&e.restoreMaterial()},SoonSpace.prototype.setMovingPOI=function(t){var e;t&&(e=this.editor.poiManager.getPoiByProperty("uuid",t)),this.editor.poiManager.setMovingPoi(e)},SoonSpace.prototype.setPOIPosition=function(t,e){var i;t&&(this.viewport.stopAnimate(),(i=this.editor.poiManager.getPoiByProperty("uuid",t))&&i.pos3D.set(e.x,e.y,e.z),this.viewport.animate())},SoonSpace.prototype.clearPOI=function(){this.editor.poiManager.clear()},SoonSpace.prototype.getUserIdToMovingPOI=function(){if(this.editor.poiManager.moving)return this.editor.poiManager.moving.userData.id},SoonSpace.prototype.getUserDataToMovingPOI=function(){if(this.editor.poiManager.moving)return this.editor.poiManager.moving.userData},SoonSpace.prototype.getLayerNameOfPOI=function(t){var e=this.editor.poiManager.getPoiByProperty("uuid",t);if(e)return e.parent.name},SoonSpace.prototype.getPOIInformation=function(t){var e,i=this.editor.poiManager.getPoiByProperty("uuid",t);return i&&(e={layerName:i.parent.name,userId:i.userData.id,name:i.name,uuid:i.uuid,id:i.id,position:{x:i.pos3D.x,y:i.pos3D.y,z:i.pos3D.z},link:i.link,floorid:i.userData.floorid}),e},SoonSpace.prototype.getPOIInformationByUserID=function(t){var e,i=this.editor.poiManager.getPoiByUserData("id",t);return i&&(e={layerName:i.parent.name,userId:i.userData.id,name:i.name,uuid:i.uuid,id:i.id,position:{x:i.pos3D.x,y:i.pos3D.y,z:i.pos3D.z},link:i.link,floorid:i.userData.floorid}),e},SoonSpace.prototype.flyToPoi=function(t,e,i="rightTop"){return new Promise(r=>{var n=this.editor.poiManager.getBoundingBox(t,new THREE.Vector3(e,e,e)),o=this.editor,a=this.viewport;o.fitBoundingBoxToScreen(a.getWidth(),a.getHeight(),n,!0,VIEWPOINT[i.toLocaleUpperCase()],()=>{r(t)})})},SoonSpace.prototype.focusPOIByUserID=function(t,e,i){return new Promise(r=>{var n=this.editor.poiManager.getPoiByUserData("id",t),o=this.editor.poiManager.getBoundingBox(n,new THREE.Vector3(e,e,e)),a=this.editor,s=this.viewport;if(o){var h=this.getSceneBoundingBox();return this.setViewpoint(i,h.min,h.max,!0,function(){a.fitBoundingBoxToScreen(s.getWidth(),s.getHeight(),o,!0,i,()=>{r(n)})}),n.uuid}})},SoonSpace.prototype.setUserDataOfPOI=function(t,e,i){var r=this.editor.poiManager.getPoiByProperty("uuid",t);r&&(r.userData[e]=i)},SoonSpace.prototype.addDeviceMaterial=function(t){this.editor.DeviceManager.addMaterial(t)},SoonSpace.prototype.createLightingDevice=function(t,e,i){insertLightingLibrary(t,i.position,e);var r=SoonSpace.createDevice(optionParam);return SoonSpace.editor.DeviceManager.getDeviceByProperty("uuid",r)},SoonSpace.prototype.focusDEVICEByUserID=function(t,e,i){var r=this.editor.DeviceManager.getDeviceByProperty("id",t),n=this.editor.DeviceManager.getBoundingBox(r,new THREE.Vector3(e,e,e)),o=this.editor,a=this.viewport;if(n){var s=this.getSceneBoundingBox();return this.setViewpoint(VIEWPOINT.LEFTTOP,s.min,s.max,!0,function(){o.fitBoundingBoxToScreen(a.getWidth(),a.getHeight(),n,!0,i)}),r.uuid}},SoonSpace.prototype.createDevice=function(t,e){if(null!=t){var i=this.editor.DeviceManager.materials[t.materialId],r={layerName:t.layerName,id:t.id,name:t.name,position:{x:t.position.x,y:t.position.y,z:t.position.z},width:t.width,height:t.height,icon:i?i.map.sourceFile:null,material:i,groupId:t.groupId,zindex:t.zindex,elevation:t.elevation,animation:t.animation},n=this.editor.addDevice(r);if(n){if(n.visible=!0===t.visible||null==t.visible,t.animation&&n.setAnimation(),null!=t.floorId&&(n.userData.floorId=t.floorId,null==this.editor.DeviceManager.deviceScene.userData[t.groupId]&&(this.editor.DeviceManager.deviceScene.userData[t.groupId]={}),null==this.editor.DeviceManager.deviceScene.userData[t.groupId][t.floorId]&&(this.editor.DeviceManager.deviceScene.userData[t.groupId][t.floorId]={}),this.editor.DeviceManager.deviceScene.userData[t.groupId][t.floorId][t.id]=n),t.lods)for(var o=0;o<t.lods.length;++o){var a=t.lods[o];n.addLOD(new VB.Device.LOD(a.level,a.iconSize.width,a.iconSize.height,a.visibleText,a.visibleIcon,a.min,a.max))}return e&&(n.userData.meshContainer=e,e.device=n),n.uuid}}},SoonSpace.prototype.removeDevice=function(t){t&&this.editor.DeviceManager.removePoiByProperty("uuid",t)},SoonSpace.prototype.SetState=function(t,e){t.setObjectState(this,e)},SoonSpace.prototype.getIntersectDevice=function(){return this.editor.DeviceManager.getIntersectObject()};var water="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAgAElEQVR4nO2cebQd1XWnv3NOVd2687v3zRqe5hkQowAxmMGAHWPHeGiT2LizuuPEdJzu9hB3dzqdobOcjttx4jZpx06CyWCceACP2NgGAwYEyBIgC0lo1tMb9OZ351vjOf3HfTKQMDmRMPSqT6vWulqrqm7d2r+z9zl77/MgISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEh4dWCOB03/au//Cy7dz9FsVhgcHCQajtgICP5t+cvRmRTEMXPvUAKaAbgx53PL4dcF5VDe3MTD3/l5nyPXG/3lseiVP+jwik+LrP5CZnpQlk2/vw4thQYExN5LSw3B0jiKAA0AovYxDjpNAIwyqW87hykm4Uo7LwhK+KLRwf49miapfkYIRRBFIOUxGGElAZLOSgB2sR4sUZHGiUMRtoYrRnockkryY6xxrXfe2LsT+36vPXerUObtCGOtHnJn+trQd7SXN3b4g1vvO5ntMgLY52yO/1rEBKv3SBstpCWelnnIxWtB+68Jz/z6IV2ziHao0G5kO4K4kz346Y4+IgpL78fp3ifyPXVIYZYgxDw0u/7lHDyawbyDgLjfmXX9KcfHWm/j7aF3fD104dHhJOyCeOXfqBWqOnJKOjNndJnfHUIwGiU64KwES/HAwiByGVRQ2u+1zzyyIXyhEEOdoGQmHbdEa2Zi/TkUxdpy/0g2b65sLT4R+QHv28yPd+je/kRIR1ozUHUOm0/SRvIO5J8xmbXWP3N9x9r/vnUtDdEKQvVCou73AcvuXBz1PBj9MvwAE2tGEp5ZKzJU/qcrw4BaI2dz2IXXDqP9BIvxBjId5Heet3vzVRbd4ip4/9D7dv1DrsnRg6W0FEaEQEmhvZMWVdH3opQb8XNE+b7HxDl1V+lZ/WXRK5nWmigPd+5p/jXR0RjOlFjMG9TafnZb+yZ/4vtR2o3ISUUHHBtqDboWSzu8RoVZqr+S99TGzw7w6ZUjG3ilzz/Z+HVIQBExz3TAJyFw/CiQggDdGUW2d39E7Ni/Tvj8bWv18ce/5i99+ktamkG8lmMJ8HOIOwMRscoy4H27OvM8Pjr9OiP/1hn++7UPetuNYObHhDZPLTmX/w7XwJtIO8qhJDsGmnc+IMjjT+p1eLFZGyQBlIOTNdwUoZ3XL351u5SjmJ39OL31Aa3kKFR90lP/hidLv2Ln+/5eJUI4CQCCBY+nxTBi50uoFVHSIW1csU94dDae5pPbPuIe/ThT9jds8glZbRvMJFGSoXMlJD5foSbQ0RBVtcnb4rGdtwUTe65L1i04Q/sofMfEFYajP6ZntoYkFIwmLOYrLW6f3C48amdh+vvwbEgb3V+hutC3Ycnd/H2XzzzPW97w6YTx6de4r4anCzYWXjoLz9PO5iFoSU/07O9FPKU3u1fjeAZEQS8rMdbcNumNg9+HXHOhX+iL73pfG++f3+4bxJhAUoghMToGO03IPQQ2W6ctVeT2XIj+RXnXWm3Zu/3f/KtL4QzR7My192ZaD7reKGpiTZQTCvKrmT7SP29t2yb2r/zSPM95BxIyWeMP11DjBzhojOz71jRm759ug6eD55vnvdotw2xgljC/Z/7W566907crj7EKQhTz+ZVJgDoCEDyXBG8vIkhcYSozSB7u3dGV75rsxeufCzcN4lyJAYNOgJjOkII28TNWbTfQi46g+yWmyisvezdYv7YIe/Yk0M4NkgNQoOMwGiePVczBpQUDOQsGn606B92TX/pHx6b/ttmILrJWwtaFpBOw/gMzoljlfdc2Lf1zNX9d8w1o4WVsMGY5zm0QaYEIgWH77qL4Ye/Qbp7ACll54tPIa+yEPBsFjyBMR0fqCOI45ecqOkoIpoep3vDOX7+mlsvnvn4h/Z7B55Y467t7/hUo0FrhNYIK4V0CwihMJGPs3Jry1l2wYA/tX843r8jL6RqWEQoETPZ7MN1FBB3Rr2rcGzJjpH6r35n7/yf+T45sjYoOm7BUmDZcGiEflPZ89arVl5X7sqM7T00wqD7wpI2GuyMJFOEY9/9HpM7v0eubylN38ecYuPDq9IDnESAVOiwTTA31XmZTgqkAimfIwRzMmYLhZVK071xM6VFi7DLXab4tn9/Y1zLoOseCLMQ33XnGqMRUiHcPKowiHTS94pM8cLU8otva4vu9dW4gJXKsbPSy65KiqIdo6RgMG9R96Nltz8+9bWvPVn5Kz+WOXJW521qA7YNKDg4zDIxf9e7Lll8bqmYG5uuei+q307MlxgbDn77u3iHt2MXehHKOuUj/ySvYg8ACIF0UlQPPIU1N03Xqg0Io0EpSLlIy8JojVQ2Jo7Br6Ism/bYCNWDTxN5HqrY+7jVv3IPzYObKD7jATAxxBEmDjFhGxO2IV3ol5mu7X5tejuZQn/JFUTK4s7JJcQYel1I2ZJtw/Xf+OZTc38SeMYlo0AtJJeMATcFXgyHj3DBIj7zujOW/4anYa7pI18kx2E0pHISJwv3/cVf0Dq8nbO2XEZtYvK0GR9e7QIAkArLTTF75AD1iXEy5S50JNBCIY2PUyih3DRShwgpEUqhkaTyJYprlhDO1mlE8z10KUykEZbuvFATY0zUEYKQGKkQ6cIS/8S+z0RTh57uWbn8b8Dh4wdXM9xWnFcKmfDNum/tmP6zA9PhG1EC8uq5q9W0C5UWHB/m2o3FD15y5sCnxqfr+JHGTTu8UL7n5Mi30vDj22/n4AN3sv7ci5FKnVbjw2tBAMYglIW0HYJmAzsl8ZsBQbNFuiuLclyMMUhlQzoFUhK0Y6RSFPqWEzz617dZ1ol+MuXOHMLEC15gIRzEnQmeiEOa27+wyJ88cH3fOa/7eCAHap8aXszeMM+Grhb3Hap+4J6R+NNBPRDk7I67P2kbAaRcmK6iJkfN9WcW3n7exiVfm2l6+KF+0ZGPASstsTLw5D/+Awfu/TLFwWUIyz4tMf+f8uoXAHREIATKcZC2g5WSGGQnBIQeSIUxGhMbpNEIN4PnCSb++g//r6o99CuplX1on04yRi/EfzRGa4yyiCf20RjeiVHO/xm44LL/fNjeyO0nziTKOriV45tu29f682MT/hU4C9k8YxaMbzpzEseB45NkaidG3r516E2Lu7O7T1TaCPXic1ZjQDmSdBYOfuc7HNv2bfIDQ/hBeNpH/kleGwJ4uWiNKXRD3djikS99yZU/uUGu6EGHEtAYDGYh/ks7izCGYO/d+I1KLTew5teK6y760v3mHO6c3kA2o/jJgeMfufvp+U9oo5B5B230M4YxBmwLhAUHhhlKtbddd/mSN2Wz6cpULcB17BddvBoDti0QLkw88hjV3Q/glvuJjcGY4EWuPLX8fyQAgyj3E0zMDKkdd9ydcw5tEP096EDxU1+tNUKAsFLE0wfx5kcxveu/uHjrDR/y7J7Jvw8vYLuzmUMz42fvPj7+2WlPXLikJ09kDFONoFO0EaJjvZQDoYHDh9jcrW+9fuvqX637IdM1n7T94hVNYwy2BZENew7MoI8+TTpfRAQVCF8548P/DwIwBiEl5HuIjh67Wj355Tuc4myR7n6M/0/qCVJhQo949Am0nZ1i3Rs/snjN2X8/b5X5fOMcfuQNMDo88tvH51of68tlWbfIYboRMtUInnHlJ2f6DQ+ODXPxEvnfrzl/5R+1jKTa8lEvUc00xmDbFrYNT+w5wejELCtzBXT9xCvm9p/Na1sAxoDtEGd6MHt3/qo89PW/sgc1ZPswnn5WtkWAFJjWHFEcoldc/oXMpmt/syzblV3NIp8LLuVomO8+MnLsy13ZwlXXbxggiGOOzXtE2qCkQCEIjYFMGmZqsP9prtzce8O56/q+PtsMQDlIIXix0r4QAmMMfhBy8Eid0fFJMtk8qi04tTW+l89rVwBGg5sDXxLv+MHH7dl7P2oNuWirCP6zjC8kxB66MY8oLxtVm978wVTv6q/m4lkmBi/l++JafvT9x25Y0xvd9vazlxUHsxbH5j1GaxFCCKTsNClJSSfBM18nPT/Ff/6Vi67RYXTPwdFJeoo5bPWM5YXoGFsbjda6k8IF/CAkn8uQcmyOjYyTSac6S9BX/u39lNemALSGbJE4dhCPfvVON9x5g1rWhY5dCE8aX4AQmMY0xhisDdf9LWuuvTmddttM7GHb4hs51nMZ0Uj9jLdtLP3mlesXFRtewNGKj2PJzqgXIBFIIRby8MDxEX7x0mUfvOHqs+55cNc4lZaHNhplqQXDd77bmI7n6AjBEIQRWmvWrBgil8vRavtIJdE/V/O/JgVgoNBNdGKmX+39x2+7Yt/5cmkPOlQdryDojPqwjW5UsAbXDps1133AHtr8bd2cI1M5xLElVzHddxF9MyNW2ZVPLdk8dJUfxTsnA32u0Z15gyUFSgqkMEgJSkpoB5C26Hb1333prm1EQlHqyhDFmnY7IAxiYiNo1ttkXJtVK5fQWy4RRRGxBstWZNIuXhC8eG7gFeQ1JICFCV2hDzM8drb16K3fd3pme+np76zxMXRGPZjGFCgbtfG6z7lnveWDsbDbunaCfDjHbnsT98tLKE4PU43CJSsHet/f9oP/62tmMrbCtSS2FFgSlBAd9y9AYcCxIDC0YnXplnUrvjk+72MpwezsHJVagxgbE8X4YUjKUViWhWPZaN0RptEGP4xOTyfuv5BXcTHoWRgDyoKuAbxdT75T/vhzT6QXVXrp7sd4C8IQEsIWen4CU1pxIHXlh69Lb3nP+4n9tqlPInVELCz2l7ZSsbqoizzzqnvs3uHWf5j14+NeGF08XvdpBBqDwJKdQwrxHCHQ28e3d4z8eblYlCuX9LJr7zDjJ6bRscayVCdhJWXH9WtNFEWEUUQYRkRx/KoyPrwWBGA0wklh0mX0nh//J/nU33xZ9bYg14vx9TMNIY1JjNaoTW+8JXXp+zfZA+u+b6rjmKDdaegwMU2ZI9e3mI1DLkNL+7nwjL5Q29aZv/fdp9vbRlt5x5K0o5iZZkgz0AhYCAN05gFxDL1dTDvlpR/8i7vve+SRHSgR46ZSKCVfkdTtqeaVF4D4GQ4TQ64Abhn96F2fcUbu/JSzMoNJlTBhpy+fsIWpTUJp5f706z9yuXvejf+RsB3p+kL37LNysRKDMRGehkBr6hGs6UkNl0R7xd/tGH3wMw+PMVoJKGUsutIWjiWf8QKyIwZ8H5b0ccjLXf75B0d3EgaL+gvOwhLvlXyRp4ZXVABCWSBtkNZLH0JBpogJoPHd276aqj10s7OihCbLycW2aUx1Rt3GN/2xvfXXNzi9Kx/UtROd+oB4gZ92Mo9vDGiotGPOGMhN/tLGrsvjoH3zVx4fG/789gkeOV7HizRZR5FzLFJqIaNoAM+DJb3Uepef++UD/p5dh6dv7LIhn7ZecyJ4xSaBAoHxWxCHmChGyE5Bx7zgMkggUmVmvnzLZ4PD97w9c3Yv2l9IsYZNTLsO/Rt2O+fe+Gsm2/2oaM2iG9MLlz5PpDWGtG2wneeWZaWAuXbMkpziF8/o/uxkw//rx8daN++bqLz/iYCNwrYoZWwEBj96JuTg+1BM004v7vrm+Mw/rKnUbtiyKPxoTy49PGPkC5Z+X228IgIQUqG1oXL8KApNoCFlKyylqAedbp5/ZrJUGr13X7f39D2/nl6bQ4dWJyQ0Z9BWBuvsd/2+tfryPxCWQzw/3KnwicLzfTvCxKRVyFRTUm/6WIN5qD5zhhQQacN0K8K2VHT9hq5bLl3q3/LUhHfdcD1610jDe0urGXeDAFt12r6EgDDsXLy4n4O11r85eqx6w9m56seX5eJP9vWnKx2xiOcXJPCsxMHPjVdEACkR09SS3dn1ZFI2ynbYc/AIy9rDnLO8RD0QiH/qCbJZwv27r5Kyjsh0Y2oNjF9H9G/anjrzF39TdK/eLr0K2qvyzKThZObfUHAMUsaEfhMj4RjLuG/KIpi4k4Fr3okul/5Z17kAwtgw3YqJI8Oabud7Fy8rfK8Zxfm9JxpvPt7g+uO18MqarwcIFwpDtgDtQ84hyvXbO2qt39kzMvv+i+Paf+sb8G8NkCbWz99mbgDjKJDqn//+V4hXxgMYjUHRyvah02ky6TQTYpbHDrYYstqkdIinnxuzTaWGGD/w+pSriecnQBVR57zrt8XSi/6Xsm3i2jhGyufEeoPAETEpO+LpWclIs8CSrjJ2psyhcBGhPITVGMfaeTd6y5vQiwoL1z1XC4JOv0jT16BiMilZ3zzgfvEMo75Y8YPUvC8vGa6GV0w2wysnmnqr7xuJF3Qu7CrQFk7PD/cd/KuNQ7U7U+nUnB9qTuYpxEI/o441xnGxWlVoz4HlnGYrPD+viAAMAgHYsYcdgQoNg6mYxzzYNglv6Te0/ZhnjxPjRyjfGzSxRi3b8qC98vW/SXHxrqg5hwk0Qlo8O3BoAxkVIhzJIxOD/OiEC1JR71pFl8yRsVq4+ITZEoKY1JM/wHKvw3O7aBmbULm0jU1kDEZpjIhhoUQTxIa6p4kMWJb0l5fcHy4q2D9MSZhpeEvHauGF86F10UQr3DLXbG2Iq2PVay9c9tk3X3FxtdEO0UZgZ9JYKYgDCP0IIzodxo1dd2P8Km1hvxKm+Gf83DKB2hgKxmePu4aLVy1mRSak7Rv0wt46J1dk0hIfaVSH/s+SK956b1yt0Z4fRSqLci5FZOhs8ZYSX4SkrJgoivlRZRkHmoqsmibtQoY2KaOITSfBg9EYNw9RG/P4jxgqDGKnprDrM7RjQ1u6+HaWGePSVFlSUmHxTI0+jA1VX9OIoMuGrC1H1vfYIxk3+9U2mubktHssDL3zV5ZwHJtCzkbHUBkZY+Tgk1TGj9DTXWJwyRLqM9P40yOk8mUIqy/8sk4jP9dUsCMFlom5ayziul7D6pIkWBCBpWNMpnhA28sOiKBN3K7gyggDPDBsMxOlWdbXTc6KyJuYulFsn1jEVJii5LSots0LL8kWRBAELQYqRygpj3qjjok6+w5CbGoqzaTJUbOHqLtdGBOgDdRiSUZIlDR4KkUYxqgopG1isAyOY3lYNjWTwcrCoe27GPvJQ8Rzx6nNThCEEe6aNcTpgLDW6uz9+jnmB3+uAtBAVhkUMV8b9rlBW6zuUni+6eTPQx/hN9A6xtUNRCrF9mgj/7jnAF1FQ6PYD62IlCgRxZIgkpQcnzB6GVs8jUZYDr5tU/diPJUhNnGndSDWdJkmxfYEcXSCydIa9qsBTKzZXIgZYpLRvU8iSgOMF1czalx6EKANzdgmcIpYQY2nvn473//y31As5FmxfhO5nsW0222sdAGcHMIB/JBX7A8WPA8/92KQNpCzBIGCO0ci3moEa8sSIzpzB4CsrjJvlTia3cJMXVJ2nqLspsnJgMjERFoigIyKMKcgt2WExBcOgcojw4CN4RibBtJoAytyUJuvMVGdoEyV8xal2eP2srPdBSrFoJhiyBmhdPgJDo0exc52Uehb1Nm7ELz4TuCfB6dFAEIIHMf5aQfMC51jWdZCvRyyVieV+s2xkLcKm9WLBE7YIA7mmZF97M1sQDo5snoYKZ9pohCAJXRHMObFnakQ4mdcdhsiadGULmvsEI2hqdNUjUOUylO3s7iW5Mr0LL2ihVYW+eYwY95xtJvH7upDzbUA87I2dQohFvoKnr3rySw0ppyepO1puavjONTr9dUnBRCGIVEcYds2qZSD67q4rovneUtt28Z1XWwnRXcuRS6d4rtTMNpQFBcto7X89RzNXIyTStPjatKZLADKsrBtG6kkSimklIiFf1LKnx6WZeE4DqlUCq31Mq3NYrlQrXv2iz75/5PHyetPntHUkraxEFJiSUkcR6uE0WWcDG2nwNq0x0ozS2AUbSuP5WZQQhAEQU8URUXLskmlUgviXchWmE6oi+MYpRS24xD4QUkqhW3bC91EAq21K5XCdd1TbqvT4gGefOLJW3Y89tgHtl56yZ9u3nz2h2u1GlJKZmdnmZkx9PT08PS+pz+y+8knPp5Jpz7lpt0Pt1ttTjr9ZhDyLWDp4GrqMaj9e7GImU2nmZyYvHx6YvyzRocH+3p7326MiXSsUcpCCIkQhiAMhyrz83+TclPNZqP5bq/drrWarQu8dns7ELXb7StTbuqhTgnXQnaEmo2i6FeiMPzVKIr6pZLbgC9YlvV1y7KI45jZyjzpdJqpyYlfbjSqt4eRVzl48ND5QojDtm0zODiAmzVEUbju6NEjH5qbmXl3qZj/id9u2rt/8mQpl8t/rqvU9WnHdvwoilBKkcvlyOVzTE5OZp7es+fOZqNxKbC7r6/vpq5S6VCr1WL6qT3fOnrkyOKzz9z8znXrN+w5lbY6LQI4uH//L6ccm2NHjn5obN3Y76fT6brv+zSbTVw3xcTEpPvItm2fkMDw0WNvyRcKHw58nzjWZDIZHNtm/+7dzM3OkVIS3/MQQmA7DjNTk9dGYbBhbnpmw+TE5GVdpdJ9vu/jOCksy8IYi3q9fqPnta+M45i5udlfsCzrHyvzleULI9vyPe9StHnISaVwHIdqrLe2W+07oigasC1re76Qv7cyX3lPGARvl0o90lXselculx+ZmJpkenqKer12lrIUQRB0jYyMbRJCHl60eIBcPsexY8fecfjQga80Gw36BgbuWLN2zX+tVCrpY0eHPz86Mvy/T5wY/w+DixZdni8UR9qtSVqtFrat2Ldn962jx49fl81mCYPgot1P7npk4/qNvX39gxSKxb3V+fnX3/OD7/+oUCz0As+fWvwXcFpCwLr1Gz4Jgmq1wr49e/5XLp9jfGycynyF5StWMD46+tszU1PYjsOVV1394csuuZwLLriQa6+9js2bz6ZarTN6/DhTI8cp5nMM9PfRVSxQ7irS09PzsO2kkErh++21QeARhB7tVoN6rUa1ViHw29J2bGw7hRSyYjsOmXz2sFKdLh0DO6I4Ip1J4/v+mmaz+bDReqDcXf773v6+C7OZ7E1Llw8tyxeLs167ffGJEyeOHzt+zInjGIHBtqzdasFNl8tdh5YvH2LVypWMjoyueGLHzq+0Wy3O3bLltquuueYdYRQesix792VXXHHB8pUrH52Zmlq+e9euH7pOmmKxi1a7yd69e9bs27v3xu6eHnr6+va62QxHDx/uefTRR24pFgqsX7/hY0PLl3PsyJHyww899O9Ppa1OiwCuuOrKP9p4xhk/9Noehw8d/I19e/e9OZPOorXhicefuGD7Y4/9jyiKuOaNb/jY5Ve87ptuxmX1mlUYDI/v3MmB/fuxHYfxsTF27thJ2/NBSNp+gJNyH065bhjrmCiKlhs6rVZSSVJpm5RrI5VIG2OwLEsrpbZjwLbtipQSoSSWbY1kczmUVMzPzX8BrcnkslOZTOa9WmtaXhvbso+Xy6WzXDf9Hdu2v5gvFLTtdPbrSSnmAZRSoRCMRlFApVph3759n2y3WnT39oZ9/f03x3GM62awLAvf8+jt6fudnt5eDh86tPqRbQ/fBNDb20ej2bixXqtRKpdnz9uyZdOKFauuL5VK7Nj+2Ad2P7W7r1gsTpXL3TsMhtmZmXefSludFgHYjuK8LVuu3rBx0x9aln30wfvv/+aRIwdvGT529I/vvuuu7UqpQ5dcfvn7tm695HdarQbKkhw8eIjv3PUdGvU6+XweJSXZbJZms0m1Oo+bdnAcRTafqaXT6SeiKCKO9QZLWljKxlI2tpXCsVIIVK+OwXHsxx3HmQujkCiMWkIIpJDoMK7pWNNsNi/XOt7ipBwc23nc87zBVqvVJ6Sw5ufmCfxgvLe/902ZbPbdgR9EjXqDth+gjWgDSKmq+UKxqaTF2OhoYX5u/q2WY1MqlX8gjPBnZ2Zx7E5oareaZHO5h/K5fBNjOHT44L+drcwyMTHB7PTMWUIIbMv6ies4XP/m6++6+pprPzI9Nc3B/Qc+VSwW6SqXfmjbDs1GY92ptNVpEUDKSSMRrFi96ncHFi36ThSGHD1y5AOHDuz/L816g6EVy3/QVS7/9djYGOlMhka9wQP3P0gcx+Ty+Z8uHQ1gO50iSaw1SIVtp8jkcvejDWEQXGDZNplcFsuxEcKAhFjHSzs7cOwHpFIEQUjgB7Gh4ynK5XKcyWbQ6EjZ1rztOMRx9IZ2qz0eBsGk73l13/O2N5vNLwR+8NFms/m68bExMm6aYqELy7KNpSyiKGwcPHQg9oMQx3Iv1DoWSllIwaPNWpVmrUa1Mk8UR8Q6xrKVn0qnDti2TbNeP2tuZg4jFGEUl23bJgiC2fGxUY4fH2ZoxfJPrlm7trL/6X2/VG/U6ent2aOUJAzDzKm01WkRwPJlK0m7abHtwQe/c/jggd/o6e/7+uazz9ly1jnnntfd1/utfU/tufmRBx+8VxtNd7mbttfG83wymTT2Qv5ALNTShZTYducvhikhMFqTzWbvcFIpvHZ7UaPRWBOFEXEUgVDEsSaKwgukEmSz2e/atkU2myGXz2UQotOZG/gEvk8um9vmuu5i27ZXWbb9NmWpP5NK7dDauGEUXuB53rvr9frH263m/XEc/y1SisDz8FotRxuNlEoWcgXA0Gq1xEJ4INZxOohDwihEm5gojgjCgCAM0NooAGPw4yhGGI2SItDaIKTszmRzzM3OEwUhGzZu/N1qtcpTu586u1atVQQCy7Kap9JWp0UAR44c4rHHHv3B2OjoGzds3HT3Za+74gZjzI8dx3n8xne/+y2bz9q8fXxs7Ko9u5+6Y2Z2ljgylEpFfC84b2R4+NO+590aBP5tQeDd5rVat87NzvxWrVqjMj+PkDC4aNH2QrE4XqvXaLdbN6Vcp7OOthziMF7eanr92UyunS8W7ou1RscxOtbdmM6fk2k0GnatWqNRqxMFYTuO4yOO43wtk8l8SCl1QSaTWWzbzntt277dsqxICEm90XjvXBAU664AAAVjSURBVGVeplIOtmP3LizjMosXLbUc20HZYptlWXEUhGitL+sqlenp66OrVMaSFsII4jBOhUGwxg8ClgwNfWPRokHiIEQp67iQglardUEum0+XSiXq9Trlcu9t+UKB2Znp3wrDcJPv+2RzueOn0lanRQD33nPPOx97ZNvVy1euNOedv+UdSxcvJZ1O46ZS9Pf1cta5Z79rYHCQhx988G3f+sa3rm81W5xzzrl093T3VqqV63OF7GXZXHZToVg8y0lZl8Rary0USmRzeRzLodRVYnDx4t+JOsu8D2fSGRnHEXEc4Hntj/q+h7LUJ+YrFd2o15FIMKZLxzHaGOxUqiuVdvE8j3ar/WuNeuPHvu//SVdXF4VCAWP0eKFY+Pvunu73GGNMEAQ4tv1gqVCMjRBEcdQthCCKokKlOptTlmD1mrWN7u6eLwRBQLVSvTQMo1I6nWFqYooojNiwfiO2ZV82PT2dzmazrN+w4ZPpbIbuvj56+/oelUJQr1VzrXZzazafJdYx5d5yY/HixQdGR0beNT05+StSSXL5/PZTaavTIoDjx499QAgY6O//fhQFzdGRYXp6e+nt62XPnj3YtnNs7bp1d4V+wMED+39/bn6Oer1GLpe7e/3GDSv7BvrXFoqlLT29/ed19/asH1i86H39vX0MDgySyWYIQ5+1a9bcNjQ0tG92ZiZz5PDhe+r1xlnT01P/bnJq4uZcPl8bGBz4mJtKoSwLI0Ab06sXvEEUhkuNMZR7e8gXCz1hGJw/Pz//4Uql8gGlFGEYkc1mCcPoT5vNpi2lZPGSJR/JZDLEscZo+owxxHHkaGOGolijY8PqVWs+mi8UqFTmGRsZ+btatYrntfHDAD8KmJyc+MT83Bxr1639bC6fOzo7M4ttKVasWPGNQrFIvVZnfHz8nUIo4ijC81oUisVvNxsNValU1mbSWXq6u792Km11WgQwMzN7eTaTRVn2g/PzFaamZqhVa4R+SOhHREFEIV+4PeWmmJ+bO69Wr65CGlqtFmEYEscxURQRRZ3PYRDS9tpEUUQumyPtpil2lTjnnPPekM3lmsPDx66cnp7adeLEiVvb7RYrV676hSWLlgTZTIZqrcbs/Bz1en250YYoiDCxPofOfJFyufxHbjr9B1prJiYmbpmamHifQGw5MTZ+64mx8Q8aYxgYHHzf0sVLtjeadcKgTRQFG4zWxHFEs9FePnFimmpljrM2nzF10datb7Qtx+x/eu/1Tz7++ONKqrd4nvfWr99xx8Ed27efffa55z501dXX3FwsdFEqduFYNqtWrZ5bt279p9vtNmMjI78+NzvTq41hYmwSr9V+WghBq9mk3NNTXbtu432n0lanJRPY29Oz7UQULt9y0ZYv9PX302o2AYGS1k8zeqVy+ZvHho/ubzVafX09/X4um0f0CfzAo16v80JlnTjWGGNoNlpkMtnjq1avOWNyYuKPwyD4hUKhsDebzX00nUo9rBd24XSXyji2je/7D0xPT09JKT3bse9emAsglcJNp39fa/1jv+19tN32/hKYj+PYSmfSf5mzcp/JZNK7PN/DSbkMLl6KUhNfnZmduTzlpE709vXsVFJh2TZRHFPuLt+9fNWqDa1m83cnJ0788tGjh78RRRE6juO1G9b/z01nnvV7hUIR3w/IFwpEcYhlSS593eW/dXzk+HnVavUs27EzXaUSvT09LFoyeFetXhuenpx0zzxr8y+Vy+XTYbKEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhISEhFcH/w+8a/9jR7krswAAAABJRU5ErkJggg==";function GisView(t){this.scene=t,this._origin=null,this.group=new THREE.Group}function Ground(t,e,i){if(!t.defined(i))throw"imageUrl";this.soonSpace=t,this.group=new THREE.Group,this.soonSpace.editor.scene.add(this.group),this.imageUrl=null,this.textureLoader=new THREE.TextureLoader,this.boundingBox=e,this.imageUrl=i,this.update(1)}function LoadJson(t){this.soonSpace=t,this.layer=null,this.deferred=when.defer(),this.fileDeferred=when.defer(),this.poiDeferred=when.defer(),this.modelsDeferred=when.defer(),this.poisReady=!1,this.modelsReady=!1,this.ready=!1,this.load=new THREE.FileLoader}function Tween(t,e){this.times=t||[],this.values=e||[]}function Particle(){this.position=new THREE.Vector3,this.velocity=new THREE.Vector3,this.acceleration=new THREE.Vector3,this.angle=0,this.angleVelocity=0,this.angleAcceleration=0,this.size=16,this.color=new THREE.Color,this.opacity=1,this.age=0,this.alive=0}Object.assign(SoonSpace.prototype,{addWatermark:function(t){var e,i,r,n,o=this,a=t.clientWidth,s=t.clientHeight;(i=new THREE.OrthographicCamera(-a/2,a/2,s/2,-s/2,1,10)).position.z=10,r=new THREE.Scene,o.editor.orthoscene=r,(new THREE.TextureLoader).load(water,function(e){var i=new THREE.SpriteMaterial({map:e,transparent:!0}),o=i.map.image.width,a=i.map.image.height;(n=new THREE.Sprite(i)).center.set(.5,1),n.scale.set(o,a,1),r.add(n),n.position.set(t.clientWidth/2-64,128-t.clientHeight/2,1)}),e=this.viewport.renderer,this.viewport.container.dom.appendChild(e.domElement),window.addEventListener("resize",function(){var r=t.clientWidth,o=t.clientHeight;i.left=-r/2,i.right=r/2,i.top=o/2,i.bottom=-o/2,i.updateProjectionMatrix(),n.position.set(t.clientWidth/2-64,128-t.clientHeight/2,1),e.setSize(t.clientWidth,t.clientHeight)},!1),function t(){o.editor.scene.dispatchEvent({type:"preUpdate"});requestAnimationFrame(t);e.render(r,i)}()}}),SoonSpace.prototype.calcDistance=function(t,e){return new THREE.Vector3(t.x,t.y,t.z).distanceTo(new THREE.Vector3(e.x,e.y,e.z))},SoonSpace.prototype.moveMainCamera=function(t,e,i,r){if(e){var n=null==i?1500:i;new TWEEN.Tween(this.editor.camera.position).to({x:t.x,y:t.y,z:t.z},n).easing(TWEEN.Easing.Circular.Out).onUpdate(function(){}).onComplete(function(){r&&r()}).start()}else this.editor.camera.position.set(t.x,t.y,t.z)},SoonSpace.prototype.transformMianCameraOnWorldAxis=function(t,e,i,r){var n=new THREE.Vector3(this.editor.camera.position.x,this.editor.camera.position.y,this.editor.camera.position.z),o=new THREE.Vector3(t.x,t.y,t.z);if(o.normalize(),o.multiplyScalar(e),n.addVectors(n,o),i)new TWEEN.Tween(this.editor.camera.position).to({x:n.x,y:n.y,z:n.z},1500).easing(TWEEN.Easing.Circular.Out).onUpdate(function(){}).onComplete(function(){r&&r()}).start();else this.editor.camera.position.set(n.x,n.y,n.z)},SoonSpace.prototype.setMainCameraRotation=function(t,e,i,r){var n=this.editor.camera;if(e){var o=null==i?500:i;new TWEEN.Tween(this.editor.camera.rotation).to({x:t.x,y:t.y,z:t.z},o).easing(TWEEN.Easing.Circular.Out).onUpdate(function(){}).onComplete(function(){n.updateMatrix(),r&&r()}).start()}else this.editor.setViewpoint(t)},SoonSpace.prototype.startFirstPersonCamera=function(t){var e=this;viewport.firstPersonControls||(e.viewport.firstPersonControls=new e.FirstPersonControl(e,t));this.enableEditControl(!1),this.editor.saveCameraState(),t.y+=e.viewport.firstPersonControls.person.height,this.moveMainCamera(t,!0,1500,function(){var t={x:0,y:e.editor.camera.rotation.y,z:0};e.setMainCameraRotation(t,!0,500,function(){e.viewport.firstPersonControls.init()})})},SoonSpace.prototype.stopFirstPersonCamera=function(t,e){var i=e||this.editor.getSavedCameraState();if(this.viewport.firstPersonControls&&(this.viewport.firstPersonControls.release(),this.viewport.firstPersonControls=null),this.enableEditControl(!0),!1!==t){var r=this,n={x:i.rotation.x,y:i.rotation.y,z:i.rotation.z};this.setMainCameraRotation(n,!0,500,function(){r.moveMainCamera(i.position,!0,1500,function(){})})}},SoonSpace.prototype.mobilecheck=function(){var t,e=!1;return t=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(e=!0),e},SoonSpace.prototype.addMirrorBox=function(t,e){addMirrorBox(t.viewport,t.editor.scene,e)},SoonSpace.prototype.Mirror=function(t){t.scale.x=-1==selObj.scale.x?1:-1,t.rotateY(Math.PI),t.traverse(t=>{if(t instanceof THREE.Mesh&&t.matrixWorld.determinant()<0){const e=t.geometry.attributes.position.array.length,i=t.geometry.attributes.position.array,r=t.geometry.attributes.normal.array;t.geometry.attributes.uv.array;for(let t=0;t<e;t+=9){const e=i[t+0],n=i[t+1],o=i[t+2];i[t+0]=i[t+6],i[t+1]=i[t+7],i[t+2]=i[t+8],i[t+6]=e,i[t+7]=n,i[t+8]=o;const a=r[t+0],s=r[t+1],h=r[t+2];r[t+0]=r[t+6],r[t+1]=r[t+7],r[t+2]=r[t+8],r[t+6]=a,r[t+7]=s,r[t+8]=h}}})},SoonSpace.prototype.Animation=VB.Animation,SoonSpace.prototype.CommandCopyArray=VB.CommandCopyArray,SoonSpace.prototype.CommandMove=VB.CommandMove,SoonSpace.prototype.CommandMoveReal=VB.CommandMoveReal,SoonSpace.prototype.CopyModel=VB.CopyModel,SoonSpace.prototype.setAnimation=function(t,e,i){return new TWEEN.Tween(t).to(e,i).easing(TWEEN.Easing.Linear.None)},Object.assign(THREE.PerspectiveCamera.prototype,{move:function(){},flyTo:function(t,e={}){if(!t.defined(e.position)&&!t.defined(e.rotation))throw"positionrotation";var i=e.position,r=e.rotation,n=t.defaultValue(e.useTween,!0),o=e.millisecond;SoonSpace.defined(o)&&(o=Math.ceil(this.position.distanceTo(i)/1e6)+2,o=Math.min(o,3e3));var a=e.onComplete;t.defined(i)&&t.moveMainCamera(i,n,o,a),SoonSpace.defined(r)&&t.setMainCameraRotation(r,n,o)},flyToModel:function(t,e){return new Promise((i,r)=>{var n=new THREE.Box3,o=(e=t.defaultValue(e,t.defaultValue.EMPTY_OBJECT)).object;t.defined(o)||r("object");var a=t.defaultValue(e.useTween,!0),s=t.defaultValue(e.viewpoint,VIEWPOINT.RIGHTTOP),h=t.defaultValue(e.boxScalar,1);n.expandByObject(o),n.expandByScalar(h),t.fitBoundingBoxToScreen(n.min,n.max,a,s,()=>{i(o)})})},flyToPoi:function(t,e){var i=new THREE.Box3,r=(e=t.defaultValue(e,t.defaultValue.EMPTY_OBJECT)).object;if(!t.defined(r))throw"object";var n=r.pos3D,o=t.defaultValue(e.useTween,!0),a=t.defaultValue(e.viewpoint,VIEWPOINT.RIGHTTOP),s=e.onComplate,h=t.defaultValue(e.boxScalar,20);i.expandByPoint(n),i.expandByScalar(h),t.fitBoundingBoxToScreen(i.min,i.max,o,a,s)},flyToBoundingSphere:function(t,e){}}),THREE.Fire=function(t,e){var i=new THREE.ShaderMaterial({defines:THREE.FireShader.defines,uniforms:THREE.UniformsUtils.clone(THREE.FireShader.uniforms),vertexShader:THREE.FireShader.vertexShader,fragmentShader:THREE.FireShader.fragmentShader,transparent:!0,depthWrite:!1,depthTest:!1});t.magFilter=t.minFilter=THREE.LinearFilter,t.wrapS=t.wrapT=THREE.ClampToEdgeWrapping,i.uniforms.fireTex.value=t,i.uniforms.color.value=e||new THREE.Color(15658734),i.uniforms.invModelMatrix.value=new THREE.Matrix4,i.uniforms.scale.value=new THREE.Vector3(1,1,1),i.uniforms.seed.value=19.19*Math.random(),THREE.Mesh.call(this,new THREE.BoxGeometry(1,1,1),i)},THREE.Fire.prototype=Object.create(THREE.Mesh.prototype),THREE.Fire.prototype.constructor=THREE.Fire,THREE.Fire.prototype.update=function(t){var e=this.material.uniforms.invModelMatrix.value;this.updateMatrixWorld(),e.getInverse(this.matrixWorld),void 0!==t&&(this.material.uniforms.time.value=t),this.material.uniforms.invModelMatrix.value=e,this.material.uniforms.scale.value=this.scale},THREE.FireShader={defines:{ITERATIONS:"20",OCTIVES:"3"},uniforms:{fireTex:{type:"t",value:null},color:{type:"c",value:null},time:{type:"f",value:0},seed:{type:"f",value:0},invModelMatrix:{type:"m4",value:null},scale:{type:"v3",value:null},noiseScale:{type:"v4",value:new THREE.Vector4(1,2,1,.3)},magnitude:{type:"f",value:1.3},lacunarity:{type:"f",value:2},gain:{type:"f",value:.5}},vertexShader:["varying vec3 vWorldPos;","void main() {","gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","vWorldPos = (modelMatrix * vec4(position, 1.0)).xyz;","}"].join("\n"),fragmentShader:["uniform vec3 color;","uniform float time;","uniform float seed;","uniform mat4 invModelMatrix;","uniform vec3 scale;","uniform vec4 noiseScale;","uniform float magnitude;","uniform float lacunarity;","uniform float gain;","uniform sampler2D fireTex;","varying vec3 vWorldPos;","vec3 mod289(vec3 x) {","return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec4 mod289(vec4 x) {","return x - floor(x * (1.0 / 289.0)) * 289.0;","}","vec4 permute(vec4 x) {","return mod289(((x * 34.0) + 1.0) * x);","}","vec4 taylorInvSqrt(vec4 r) {","return 1.79284291400159 - 0.85373472095314 * r;","}","float snoise(vec3 v) {","const vec2 C = vec2(1.0 / 6.0, 1.0 / 3.0);","const vec4 D = vec4(0.0, 0.5, 1.0, 2.0);","vec3 i  = floor(v + dot(v, C.yyy));","vec3 x0 = v - i + dot(i, C.xxx);","vec3 g = step(x0.yzx, x0.xyz);","vec3 l = 1.0 - g;","vec3 i1 = min(g.xyz, l.zxy);","vec3 i2 = max(g.xyz, l.zxy);","vec3 x1 = x0 - i1 + C.xxx;","vec3 x2 = x0 - i2 + C.yyy;","vec3 x3 = x0 - D.yyy;","i = mod289(i); ","vec4 p = permute(permute(permute( ","i.z + vec4(0.0, i1.z, i2.z, 1.0))","+ i.y + vec4(0.0, i1.y, i2.y, 1.0)) ","+ i.x + vec4(0.0, i1.x, i2.x, 1.0));","float n_ = 0.142857142857;","vec3  ns = n_ * D.wyz - D.xzx;","vec4 j = p - 49.0 * floor(p * ns.z * ns.z);","vec4 x_ = floor(j * ns.z);","vec4 y_ = floor(j - 7.0 * x_);","vec4 x = x_ * ns.x + ns.yyyy;","vec4 y = y_ * ns.x + ns.yyyy;","vec4 h = 1.0 - abs(x) - abs(y);","vec4 b0 = vec4(x.xy, y.xy);","vec4 b1 = vec4(x.zw, y.zw);","vec4 s0 = floor(b0) * 2.0 + 1.0;","vec4 s1 = floor(b1) * 2.0 + 1.0;","vec4 sh = -step(h, vec4(0.0));","vec4 a0 = b0.xzyw + s0.xzyw * sh.xxyy;","vec4 a1 = b1.xzyw + s1.xzyw * sh.zzww;","vec3 p0 = vec3(a0.xy, h.x);","vec3 p1 = vec3(a0.zw, h.y);","vec3 p2 = vec3(a1.xy, h.z);","vec3 p3 = vec3(a1.zw, h.w);","vec4 norm = taylorInvSqrt(vec4(dot(p0, p0), dot(p1, p1), dot(p2, p2), dot(p3, p3)));","p0 *= norm.x;","p1 *= norm.y;","p2 *= norm.z;","p3 *= norm.w;","vec4 m = max(0.6 - vec4(dot(x0, x0), dot(x1, x1), dot(x2, x2), dot(x3, x3)), 0.0);","m = m * m;","return 42.0 * dot(m * m, vec4(dot(p0, x0), dot(p1, x1), dot(p2, x2), dot(p3, x3)));","}","float turbulence(vec3 p) {","float sum = 0.0;","float freq = 1.0;","float amp = 1.0;","for(int i = 0; i < OCTIVES; i++) {","sum += abs(snoise(p * freq)) * amp;","freq *= lacunarity;","amp *= gain;","}","return sum;","}","vec4 samplerFire (vec3 p, vec4 scale) {","vec2 st = vec2(sqrt(dot(p.xz, p.xz)), p.y);","if(st.x <= 0.0 || st.x >= 1.0 || st.y <= 0.0 || st.y >= 1.0) return vec4(0.0);","p.y -= (seed + time) * scale.w;","p *= scale.xyz;","st.y += sqrt(st.y) * magnitude * turbulence(p);","if(st.y <= 0.0 || st.y >= 1.0) return vec4(0.0);","return texture2D(fireTex, st);","}","vec3 localize(vec3 p) {","return (invModelMatrix * vec4(p, 1.0)).xyz;","}","void main() {","vec3 rayPos = vWorldPos;","vec3 rayDir = normalize(rayPos - cameraPosition);","float rayLen = 0.0288 * length(scale.xyz);","vec4 col = vec4(0.0);","for(int i = 0; i < ITERATIONS; i++) {","rayPos += rayDir * rayLen;","vec3 lp = localize(rayPos);","lp.y += 0.5;","lp.xz *= 2.0;","col += samplerFire(lp, noiseScale);","}","col.a = col.r;","gl_FragColor = col;","}"].join("\n")},SoonSpace.prototype.FirstPersonControl=function(t,e,i){e=t.defaultValue(e,new THREE.Vector3(0,0,0)),this.domElement=void 0!==i?i:document,this.soonSpace=t,this.soonSpaceCamera=t.editor.camera,this.firstPersonCamera=new THREE.PerspectiveCamera(this.soonSpaceCamera.fov,this.soonSpaceCamera.aspect,this.soonSpaceCamera.near,this.soonSpaceCamera.far),this.camera=this.firstPersonCamera,this.renderer=t.viewport.renderer,this.scene=t.editor.scene,this.moveSpeed=1e3,this.enableGravity=!0,this.enableClash=!0,this.enabled=!1;var r=this,n=new THREE.Clock,o=this.camera,a=r.scene,s=new THREEx.KeyboardState,h={x:0,y:0},l=new THREE.Raycaster;this.person=new THREE.Object3D;var c=this.person,u={type:"end"};function p(t){if(!1!==r.enabled){var e=t.movementX||t.mozMovementX||t.webkitMovementX||0,i=t.movementY||t.mozMovementY||t.webkitMovementY||0;h.x+=e,h.y+=i}}function d(t){if(!1!==r.enabled){var e=document.body;document.pointerLockElement===e||document.mozPointerLockElement===e||document.webkitPointerLockElement===e?document.addEventListener("mousemove",p,!1):(r.dispatchEvent(u),document.removeEventListener("mousemove",p,!1))}}c.add(o),c.position.copy(e),o.rotation.copy(c.rotation),c.velocity=new THREE.Vector3(0,0,0),c.height=170,c.round=10,a.add(c),r.domElement.addEventListener("click",function(t){if(!1!==r.enabled&&("pointerLockElement"in document||"mozPointerLockElement"in document||"webkitPointerLockElement"in document)){var e=document.body;e.requestPointerLock=e.requestPointerLock||e.mozRequestPointerLock||e.webkitRequestPointerLock,e.requestPointerLock(),document.addEventListener("pointerlockchange",d,!1),document.addEventListener("mozpointerlockchange",d,!1),document.addEventListener("webkitpointerlockchange",d,!1)}},!1),this.render=function(){!function(){if(!1===r.enabled)return;var t=n.getDelta(),e=r.moveSpeed*t,i=Math.PI/4*t,u={xDist:0,yAngle:0,zDist:0};s.pressed("W")&&(u.zDist-=e);s.pressed("S")&&(u.zDist+=e);s.pressed("Q")&&(u.yAngle+=i);s.pressed("E")&&(u.yAngle-=i);s.pressed("A")&&(u.xDist-=e);s.pressed("D")&&(u.xDist+=e);u.yAngle-=i*h.x*.1,h.x=0,s.pressed("R")&&(c.velocity=new THREE.Vector3(0,0,0),c.translateY(e));s.pressed("F")&&(c.velocity=new THREE.Vector3(0,0,0),c.translateY(-e));0!=this.enableClash&&0!=function(t){var e=new THREE.Vector3(0,0,t);e.applyQuaternion(c.quaternion);var i=c.position.clone();i.add(o.position),i.y-=.1*c.height,l.set(i,e.normalize().clone());for(var r=l.intersectObject(a,!0),n=1e11,s=0;s<r.length;s++)r[s].distance<n&&(n=r[s].distance);if(r.length>0&&n<Math.abs(t)+c.round)return!0;return!1}(u.zDist)||c.translateZ(u.zDist);var p=o.getWorldDirection(new THREE.Vector3);(function(t,e,i){e.normalize(),e.multiplyScalar(i),t.position.add(new THREE.Vector3(0,-e.y,0)),t.updateProjectionMatrix()})(o,p,u.zDist),c.rotateY(u.yAngle),c.translateX(u.xDist),c.updateMatrix(),o.rotateX(-i*h.y*.05),h.y=0,o.rotation.x=THREE.Math.clamp(o.rotation.x,-1.04,1.04),s.pressed("R")&&s.pressed("F")&&o.rotateX(-6*o.rotation.x*i);if(s.pressed(" ")){var d=c.position.y;new TWEEN.Tween(c.position).to({x:c.position.x,y:d+1.5*c.height,z:c.position.z},400).easing(TWEEN.Easing.Linear.None).start().chain(new TWEEN.Tween(c.position).to({x:c.position.x,y:d,z:c.position.z},200).easing(TWEEN.Easing.Linear.None))}!function(){if(0==this.enableGravity)return;var t=c.position.clone();t.add(o.position),t.y-=.2*c.height;var e=new THREE.Vector3;e.set(0,-1,0),l.set(t,e);for(var i=l.intersectObject(a,!0),r=1e11,n=0;n<i.length;n++)i[n].distance<r&&(r=i[n].distance);if(i.length>0){var s=.1*c.height-r;c.translateY(s)}}()}(),!1!==r.enabled&&null!==r.camera&&(TWEEN&&TWEEN.update(),r.renderer.render(r.scene,r.camera))},this.init=function(){c.position.copy(this.soonSpaceCamera.position),c.rotation.copy(this.soonSpaceCamera.rotation),this.setEnabled(!0)},this.release=function(){this.setEnabled(!1)},this.setEnabled=function(t){this.enabled=t,this.camera=t?this.firstPersonCamera:this.soonSpaceCamera},this.setEnabled(!1)},SoonSpace.prototype.FirstPersonControl.prototype=Object.create(THREE.EventDispatcher.prototype),SoonSpace.prototype.FirstPersonControl.prototype.constructor=SoonSpace.prototype.FirstPersonControl,GisView.prototype={constructor:GisView,setOrigin:function(t){if(!1===t.isVector3)throw"Vector3";this._origin=t},add:function(t){return t.position.copy((new THREE.Vector3).subVectors(t.position,this._origin)),this}},Object.assign(Ground.prototype,{constructor:Ground,update:function(t,e){var i=this.createGround(t,e);return this.group.add(i),this},createGround:function(t,e){e=this.soonSpace.defaultValue(e,this.boundingBox),this.boundingBox=e;var i=this.imageUrl,r=e.getBoundingSphere(new THREE.Sphere),n=new THREE.Box3(e.min,e.max).getSize(new THREE.Vector3),o=this.textureLoader.load(i),a=10*r.radius,s=new THREE.PlaneBufferGeometry(a,a),h=new THREE.MeshStandardMaterial({side:THREE.DoubleSide,map:o,transparent:!0,opacity:t,roughness:.8}),l=new THREE.Mesh(s,h);return l.material.map.repeat.set(32,32),l.material.map.wrapS=THREE.RepeatWrapping,l.material.map.wrapT=THREE.RepeatWrapping,l.rotation.x=Math.PI/2,l.position.set(r.center.x,r.center.y-.51*n.y,r.center.z),l},updateImage:function(t){var e=this;this.imageUrl=t;var i=this.soonSpace.setAnimation(this.group.children[0].material,{opacity:0},1e3),r=e.createGround(0),n=this.soonSpace.setAnimation(r.material,{opacity:1},1e3);e.group.add(r),n.start(),i.start(),i.onComplete(function(){e.disposeObject()})},disposeObject:function(){var t=this.group.children[0];this.group.remove(t),t.material.dispose(),t.geometry.dispose(),t.material.map.dispose(),t.material.map=null,t.material=null,t.geometry=null,t=null}}),SoonSpace.prototype.Ground=Ground,Object.assign(LoadJson.prototype,{fromJson:function(t){var e=(t=this.soonSpace.defaultValue(t,this.soonSpace.defaultValue.EMPTY_OBJECT)).poiLayerName;if(!this.soonSpace.defined(e))throw"layerName";var i=this,r=t.baseUrl;if(!i.soonSpace.defined(r))throw"baseUrl";i.fileLoad(r),i.fileDeferred.promise.then(function(e){var r=e.poiCustomProp,n=e.modelInfo,o=e.poiInfo;i.loadPois(n,o,r,t),i.loadModels(n,o,r,t)})},fileLoad:function(t){var e=this;if(!e.soonSpace.defined(t))throw"baseUrl";e.load.setPath(t),e.load.load("db/modelInfo.json",function(t){e.load.load("db/poiInfo.json",function(i){e.load.load("db/poiCustomProp.json",function(r){r=JSON.parse(r),t=JSON.parse(t),i=JSON.parse(i),e.fileDeferred.resolve({poiCustomProp:r,modelInfo:t,poiInfo:i})})})})},loadPois:function(t,e,i,r){var n=this,o=n.getFloorInfo(t),a=r.poiLayerName,s=r.baseUrl;o.forEach(function(t){var r=t.id;jFunk("*[pid="+r+"]",e).get().forEach(function(e){n.soonSpace.addPOIMaterial({textureUrl:s+"/res/"+e.iconpathsub,id:e.id,color:16777215});var r={id:e.id,name:e.modelname,position:new THREE.Vector3(e.x,e.y,e.z),materialId:e.id,width:32,height:32,visible:!0,floorId:t.longname,layerName:a},o=n.soonSpace.createPOI(r),h=n.soonSpace.editor.poiManager.getPoiByProperty("uuid",o);h.userData.poiCustomProp=jFunk("*[poiid="+e.id+"]",i).get(),h.userData.devicecode=e.devicecode,h.userData.poicategory_code=e.poicategory_code,h.visible=!0})}),n.layer=SoonSpace.editor.poiManager.getLayerByProperty("name",a),n.poiDeferred.resolve(n.layer),n.poisReady=!0,!0===n.modelsReady&&(n.ready=!0,n.deferred.resolve())},loadModels:function(t,e,i,r){var n=[],o=r.baseUrl,a=r.modelCallbackProgress,s=r.modelOnLoad,h=jFunk("*[type=2]",t).get(),l=h.length;h.forEach(function(t,e){n.push({id:t.longname,name:t.floor_name,fileUrl:o+t.filepath,useBufferGeometry:!0,scale:1,totalSBMs:l,currentSBMs:e,textureUrl:o+"Maps/",baseFloor:t.baseFloor})});var c=this;c.soonSpace.importSBM(r.SBMGroupUserID,n,function(){c.modelsDeferred.resolve(c.layer),c.modelsReady=!0,s&&s(),!0===c.poisReady&&(c.ready=!0,c.deferred.resolve())},a)},getFloorInfo:function(t){return jFunk("*[type=2]",t).get()},setProperty:function(t,e){var i=this;function r(){i.layer.children.forEach(function(i){i[t]=e})}i.ready?i.layer.children.forEach(function(t){r()}):i.deferred.promise.then(function(){r()})},showAll:function(t){this.setProperty("visible",t)},getPoiByUserDataProperty:function(t,e){var i=this,r=[];function n(i){for(var n of i)n.userData[t]===e&&r.push(n);return r}if(this.ready)return n(i.layer.children);this.poiDeferred.promise.then(function(){return n(i.layer.children)})},showFloorPoisByFloorId:function(t,e){var i=this;this.ready?this.layer.children.forEach(function(i){i.userData.floorId==t&&(i.visible=e)}):this.poiDeferred.promise.then(function(){i.layer.children.forEach(function(i){i.userData.floorId==t&&(i.visible=e)})})}}),SoonSpace.prototype.LoadJson=LoadJson,particleVertexShader=["attribute vec3  customColor;","attribute float customOpacity;","attribute float customSize;","attribute float customAngle;","attribute float customVisible;","varying vec4  vColor;","varying float vAngle;","void main()","{","if ( customVisible > 0.5 )","vColor = vec4( customColor, customOpacity );","else","vColor = vec4(0.0, 0.0, 0.0, 0.0);","vAngle = customAngle;","vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","gl_PointSize = customSize * ( 300.0 / length( mvPosition.xyz ) );","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),particleFragmentShader=["uniform sampler2D texture;","varying vec4 vColor;","varying float vAngle;","void main()","{","gl_FragColor = vColor;","float c = cos(vAngle);","float s = sin(vAngle);","vec2 rotatedUV = vec2(c * (gl_PointCoord.x - 0.5) + s * (gl_PointCoord.y - 0.5) + 0.5,","c * (gl_PointCoord.y - 0.5) - s * (gl_PointCoord.x - 0.5) + 0.5);","vec4 rotatedTexture = texture2D( texture,  rotatedUV );","gl_FragColor = gl_FragColor * rotatedTexture;","}"].join("\n"),Tween.prototype.lerp=function(t){for(var e=0,i=this.times.length;e<i&&t>this.times[e];)e++;if(0==e)return this.values[0];if(e==i)return this.values[i-1];var r=(t-this.times[e-1])/(this.times[e]-this.times[e-1]);return this.values[0]instanceof THREE.Vector3?this.values[e-1].clone().lerp(this.values[e],r):this.values[e-1]+r*(this.values[e]-this.values[e-1])},Particle.prototype.update=function(t){if(this.position.add(this.velocity.clone().multiplyScalar(t)),this.velocity.add(this.acceleration.clone().multiplyScalar(t)),this.angle+=.01745329251*this.angleVelocity*t,this.angleVelocity+=.01745329251*this.angleAcceleration*t,this.age+=t,this.sizeTween.times.length>0&&(this.size=this.sizeTween.lerp(this.age)),this.colorTween.times.length>0){var e=this.colorTween.lerp(this.age);this.color=(new THREE.Color).setHSL(e.x,e.y,e.z)}this.opacityTween.times.length>0&&(this.opacity=this.opacityTween.lerp(this.age))};var Type=Object.freeze({CUBE:1,SPHERE:2});function ParticleEngine(t){this.editor=t,this.positionStyle=Type.CUBE,this.positionBase=new THREE.Vector3,this.positionSpread=new THREE.Vector3,this.positionRadius=0,this.velocityStyle=Type.CUBE,this.velocityBase=new THREE.Vector3,this.velocitySpread=new THREE.Vector3,this.speedBase=0,this.speedSpread=0,this.accelerationBase=new THREE.Vector3,this.accelerationSpread=new THREE.Vector3,this.angleBase=0,this.angleSpread=0,this.angleVelocityBase=0,this.angleVelocitySpread=0,this.angleAccelerationBase=0,this.angleAccelerationSpread=0,this.sizeBase=0,this.sizeSpread=0,this.sizeTween=new Tween,this.colorBase=new THREE.Vector3(0,1,.5),this.colorSpread=new THREE.Vector3(0,0,0),this.colorTween=new Tween,this.opacityBase=1,this.opacitySpread=0,this.opacityTween=new Tween,this.blendStyle=THREE.NormalBlending,this.particleArray=[],this.particlesPerSecond=100,this.particleDeathAge=1,this.emitterAge=0,this.emitterAlive=!0,this.emitterDeathAge=60,this.particleCount=this.particlesPerSecond*Math.min(this.particleDeathAge,this.emitterDeathAge),this.particleTexture=null,this.particleGeometry=new THREE.BufferGeometry,this.particleGeometry.addAttribute("position",new THREE.BufferAttribute(new Float32Array(3*this.particleCount),3).setDynamic(!0)),this.particleGeometry.addAttribute("customVisible",new THREE.BufferAttribute(new Float32Array(this.particleCount),1).setDynamic(!0)),this.particleGeometry.addAttribute("customColor",new THREE.BufferAttribute(new Float32Array(3*this.particleCount),3).setDynamic(!0)),this.particleGeometry.addAttribute("customSize",new THREE.BufferAttribute(new Float32Array(this.particleCount),1).setDynamic(!0)),this.particleGeometry.addAttribute("customAngle",new THREE.BufferAttribute(new Float32Array(this.particleCount),1).setDynamic(!0)),this.particleGeometry.addAttribute("customOpacity",new THREE.BufferAttribute(new Float32Array(this.particleCount),1).setDynamic(!0)),this.particleTexture=null,this.particleMaterial=new THREE.ShaderMaterial({uniforms:{texture:{type:"t",value:this.particleTexture}},vertexShader:particleVertexShader,fragmentShader:particleFragmentShader,transparent:!0,blending:THREE.NormalBlending}),this.particleMesh=new THREE.Mesh}ParticleEngine.prototype.setValues=function(t){if(void 0!==t){for(var e in this.sizeTween=new Tween,this.colorTween=new Tween,this.opacityTween=new Tween,t)this[e]=t[e];Particle.prototype.sizeTween=this.sizeTween,Particle.prototype.colorTween=this.colorTween,Particle.prototype.opacityTween=this.opacityTween,this.particleArray=[],this.emitterAge=0,this.emitterAlive=!0,this.particleCount=this.particlesPerSecond*Math.min(this.particleDeathAge,this.emitterDeathAge),this.particleGeometry=new THREE.BufferGeometry,this.particleGeometry.addAttribute("position",new THREE.BufferAttribute(new Float32Array(3*this.particleCount),3).setDynamic(!0)),this.particleGeometry.addAttribute("customVisible",new THREE.BufferAttribute(new Float32Array(this.particleCount),1).setDynamic(!0)),this.particleGeometry.addAttribute("customColor",new THREE.BufferAttribute(new Float32Array(3*this.particleCount),3).setDynamic(!0)),this.particleGeometry.addAttribute("customSize",new THREE.BufferAttribute(new Float32Array(this.particleCount),1).setDynamic(!0)),this.particleGeometry.addAttribute("customAngle",new THREE.BufferAttribute(new Float32Array(this.particleCount),1).setDynamic(!0)),this.particleGeometry.addAttribute("customOpacity",new THREE.BufferAttribute(new Float32Array(this.particleCount),1).setDynamic(!0)),this.particleMaterial=new THREE.ShaderMaterial({uniforms:{texture:{type:"t",value:this.particleTexture}},vertexShader:particleVertexShader,fragmentShader:particleFragmentShader,transparent:!0,alphaTest:.5,blending:THREE.NormalBlending,depthTest:!0,depthWrite:!1}),this.particleMesh=new THREE.ParticleSystem}},ParticleEngine.prototype.randomValue=function(t,e){return t+e*(Math.random()-.5)},ParticleEngine.prototype.randomVector3=function(t,e){var i=new THREE.Vector3(Math.random()-.5,Math.random()-.5,Math.random()-.5);return(new THREE.Vector3).addVectors(t,(new THREE.Vector3).multiplyVectors(e,i))},ParticleEngine.prototype.createParticle=function(){var t=new Particle;if(this.positionStyle==Type.CUBE&&(t.position=this.randomVector3(this.positionBase,this.positionSpread)),this.positionStyle==Type.SPHERE){var e=2*Math.random()-1,i=6.2832*Math.random(),r=Math.sqrt(1-e*e),n=new THREE.Vector3(r*Math.cos(i),r*Math.sin(i),e);t.position=(new THREE.Vector3).addVectors(this.positionBase,n.multiplyScalar(this.positionRadius))}if(this.velocityStyle==Type.CUBE&&(t.velocity=this.randomVector3(this.velocityBase,this.velocitySpread)),this.velocityStyle==Type.SPHERE){var o=(new THREE.Vector3).subVectors(t.position,this.positionBase),a=this.randomValue(this.speedBase,this.speedSpread);t.velocity=o.normalize().multiplyScalar(a)}t.acceleration=this.randomVector3(this.accelerationBase,this.accelerationSpread),t.angle=this.randomValue(this.angleBase,this.angleSpread),t.angleVelocity=this.randomValue(this.angleVelocityBase,this.angleVelocitySpread),t.angleAcceleration=this.randomValue(this.angleAccelerationBase,this.angleAccelerationSpread),t.size=this.randomValue(this.sizeBase,this.sizeSpread);var s=this.randomVector3(this.colorBase,this.colorSpread);return t.color=(new THREE.Color).setHSL(s.x,s.y,s.z),t.opacity=this.randomValue(this.opacityBase,this.opacitySpread),t.age=0,t.alive=0,t},ParticleEngine.prototype.initialize=function(){for(var t=this.particleGeometry.getAttribute("position"),e=this.particleGeometry.getAttribute("customVisible"),i=this.particleGeometry.getAttribute("customColor"),r=this.particleGeometry.getAttribute("customSize"),n=this.particleGeometry.getAttribute("customAngle"),o=this.particleGeometry.getAttribute("customOpacity"),a=0;a<this.particleCount;a++)this.particleArray[a]=this.createParticle(),t.array[3*a+0]=this.particleArray[a].position.x,t.array[3*a+1]=this.particleArray[a].position.y,t.array[3*a+2]=this.particleArray[a].position.z,e.array[a]=this.particleArray[a].alive,i.array[3*a+0]=this.particleArray[a].color.r,i.array[3*a+1]=this.particleArray[a].color.g,i.array[3*a+2]=this.particleArray[a].color.b,o.array[a]=this.particleArray[a].opacity,r.array[a]=this.particleArray[a].size,n.array[a]=this.particleArray[a].angle;t.needsUpdate=!0,e.needsUpdate=!0,i.needsUpdate=!0,r.needsUpdate=!0,n.needsUpdate=!0,o.needsUpdate=!0,this.particleMaterial.blending=this.blendStyle,this.blendStyle!=THREE.NormalBlending&&(this.particleMaterial.depthTest=!1),this.particleMesh=new THREE.ParticleSystem(this.particleGeometry,this.particleMaterial),this.particleMesh.dynamic=!0,this.particleMesh.sortParticles=!0,this.editor.addObject(this.particleMesh)},ParticleEngine.prototype.update=function(t){for(var e=[],i=this.particleGeometry.getAttribute("position"),r=this.particleGeometry.getAttribute("customVisible"),n=this.particleGeometry.getAttribute("customColor"),o=this.particleGeometry.getAttribute("customSize"),a=this.particleGeometry.getAttribute("customAngle"),s=this.particleGeometry.getAttribute("customOpacity"),h=0;h<this.particleCount;h++)this.particleArray[h].alive&&(this.particleArray[h].update(t),this.particleArray[h].age>this.particleDeathAge&&(this.particleArray[h].alive=0,e.push(h)),i.array[3*h+0]=this.particleArray[h].position.x,i.array[3*h+1]=this.particleArray[h].position.y,i.array[3*h+2]=this.particleArray[h].position.z,r.array[h]=this.particleArray[h].alive,n.array[3*h+0]=this.particleArray[h].color.r,n.array[3*h+1]=this.particleArray[h].color.g,n.array[3*h+2]=this.particleArray[h].color.b,s.array[h]=this.particleArray[h].opacity,o.array[h]=this.particleArray[h].size,a.array[h]=this.particleArray[h].angle);if(i.needsUpdate=!0,r.needsUpdate=!0,n.needsUpdate=!0,o.needsUpdate=!0,a.needsUpdate=!0,s.needsUpdate=!0,this.emitterAlive){if(this.emitterAge<this.particleDeathAge){var l=Math.round(this.particlesPerSecond*(this.emitterAge+0)),c=Math.round(this.particlesPerSecond*(this.emitterAge+t));c>this.particleCount&&(c=this.particleCount);for(h=l;h<c;h++)this.particleArray[h].alive=1}for(var u=0;u<e.length;u++){h=e[u];this.particleArray[h]=this.createParticle(),this.particleArray[h].alive=1,i.array[3*h+0]=this.particleArray[h].position.x,i.array[3*h+1]=this.particleArray[h].position.y,i.array[3*h+2]=this.particleArray[h].position.z}i.needsUpdate=!0,this.emitterAge+=t,this.emitterAge>this.emitterDeathAge&&(this.emitterAlive=!1)}},ParticleEngine.prototype.destroy=function(){this.editor.removeObject(this.particleMesh)},Object.assign(THREE.Scene.prototype,{preUpdate:{type:"change"}}),Object.assign(SoonSpace.prototype,{createSkyBackground:function(){var t,e=new THREE.CubeTextureLoader;return function(i,r){var n=this.editor.scene;n.background instanceof THREE.Color?((t=e.setPath(i).load(r)).format=THREE.RGBFormat,n.background=t):((t=n.background)instanceof THREE.CubeTexture&&t.dispose(),this.setBackgroundColor(4494832),t=null,this.createSkyBackground(i,r))}}()});var SoonMath={};SoonSpace.prototype.EarthControls=function(t,e){var i=new THREE.Raycaster,r=new THREE.Vector2,n=t.viewport.renderer.domElement;this.rotateTiltRange={max:Math.PI,min:Math.PI/2},this.minDistance=1,this.maxDistance=Number.POSITIVE_INFINITY,this.intersectObjects=e,this.enabled=!0,this.center=new THREE.Vector3,this.centerzoom=!0,this.wheelscale=1,this.rotateRad=new THREE.Vector3,this.handmode=!1,this.getIntersectPoint;var o=!1,a=new THREE.Vector3,s=t.editor.camera;this.STATE={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,PARALLELPAN:3};var h=this,l=new THREE.Vector3,c=this.STATE.NONE;this.navigationMode={lbuttonDown:this.STATE.ROTATE,mbuttonDown:this.STATE.ZOOM,rbuttonDown:this.STATE.PAN},this.oldNavigantionMode={lbuttonDown:this.STATE.ROTATE,mbuttonDown:this.STATE.ZOOM,rbuttonDown:this.STATE.PAN},this.saveNavigationMode=function(){h.oldNavigantionMode.lbuttonDown=h.navigationMode.lbuttonDown,h.oldNavigantionMode.mbuttonDown=h.navigationMode.mbuttonDown,h.oldNavigantionMode.rbuttonDown=h.navigationMode.rbuttonDown},this.restoreNavigationMode=function(){h.navigationMode.lbuttonDown=h.oldNavigantionMode.lbuttonDown,h.navigationMode.mbuttonDown=h.oldNavigantionMode.mbuttonDown,h.navigationMode.rbuttonDown=h.oldNavigantionMode.rbuttonDown};var u=new THREE.Matrix3,p=new THREE.Vector2,d=new THREE.Vector2,f={type:"change"};function m(t,e,n){return r.set(2*t.x-1,-2*t.y+1),i.setFromCamera(r,s,n),i.intersectObjects(h.intersectObjects,!0)}this.focus=function(t,e){var i=new THREE.Vector3;t.matrixWorld.decompose(h.center,new THREE.Quaternion,i);var r=(new THREE.Vector3).copy(h.center);if(e&&t.geometry){i=(i.x+i.y+i.z)/3,r.add(t.geometry.boundingSphere.center.clone().multiplyScalar(i));var n=t.geometry.boundingSphere.radius*i,o=s.position.clone().sub(r).normalize().multiplyScalar(2*n);s.position.copy(r).add(o)}s.lookAt(r),h.dispatchEvent(f)},this.pan=function(t){var e=s.position.distanceTo(h.center);e<5e3&&(e=5e3),t.multiplyScalar(.001*e),t.applyMatrix3(u.getNormalMatrix(s.matrix)),s.position.add(t),h.dispatchEvent(f)},this.parallelpan=function(t){var e=s.position.distanceTo(h.center);e<5e3&&(e=5e3),t.multiplyScalar(.002*e),t.applyMatrix3(u.getNormalMatrix(s.matrix)),t.y=0,s.position.add(t),h.dispatchEvent(f)},this.zoom_on_point=function(e,r){e.z;var o=s.position.distanceTo(h.center);if(o<5e3&&(o=5e3),e.multiplyScalar(.001*o),!(e.length()>o)){e.applyMatrix3(u.getNormalMatrix(s.matrix));var a,l=event.clientX/n.offsetWidth*2-1,c=-event.clientY/n.offsetHeight*2+1,p=new THREE.Vector3(l,c,.1);if(p.unproject(s),p.sub(s.position),i.setFromCamera(new THREE.Vector2(l,c),t.editor.camera),(a=i.intersectObjects(h.intersectObjects,!0))[0]){var d=.2*a[0].distance*r;d<this.minDistance&&d>0&&(d=0),a[0].distance>this.maxDistance&&r<0&&(d=0);var m=p.setLength(d);s.position.addVectors(s.position,m),h.dispatchEvent(f)}}},this.zoom=function(t){var e=s.position.distanceTo(h.center);if(e<5e3&&(e=5e3),t.multiplyScalar(.001*e),!(t.length()>e)){if(t.applyMatrix3(u.getNormalMatrix(s.matrix)),this.rotateTiltRange.min>=Math.PI/2){var i=(new THREE.Vector3).copy(s.position).add(t),r=(editor.bbox.containsPoint(s.position),editor.bbox.containsPoint(i),editor.bbox.getCenter()),n=[];(new THREE.Vector3).copy(r).x=editor.bbox.min.x,(new THREE.Vector3).copy(r).x=editor.bbox.max.x,(new THREE.Vector3).copy(r).z=editor.bbox.max.z,(new THREE.Vector3).copy(r).z=editor.bbox.min.z,(new THREE.Vector3).copy(r).y=editor.bbox.min.y,n.push(new THREE.Plane(new THREE.Vector3(-1,0,0),-Math.abs(editor.bbox.min.x))),n.push(new THREE.Plane(new THREE.Vector3(1,0,0),-Math.abs(editor.bbox.max.x))),n.push(new THREE.Plane(new THREE.Vector3(0,0,1),-Math.abs(editor.bbox.max.z))),n.push(new THREE.Plane(new THREE.Vector3(0,0,-1),-Math.abs(editor.bbox.min.z))),n.push(new THREE.Plane(new THREE.Vector3(0,-1,0),-Math.abs(editor.bbox.min.y)));var o=new THREE.Vector3(0,0,-1);o.applyMatrix3(u.getNormalMatrix(s.matrix)),o.normalize();var a=(new THREE.Vector3).copy(t);a.normalize();for(var l=a.dot(o),c=new THREE.Ray(s.position,a),p=0;p<n.length;++p){var d=c.distanceToPlane(n[p]);if(d&&d-100-s.near<t.length()&&Math.abs(l-1)<.001&&a.dot(n[p].normal)>0)return}}s.position.add(t),h.dispatchEvent(f)}},this.rotate=function(t,e){if(e&&(o=!0,a.copy(h.center)),h.getIntersectPoint&&o){!1;var i=new THREE.Vector3(0,0,-1);i.applyQuaternion(s.quaternion);var r=i.angleTo(new THREE.Vector3(0,1,0));h.rotateTiltRange.max<r-t.y?t.y=0:r-t.y<h.rotateTiltRange.min&&(t.y=0),l.copy(s.position).sub(a);var n=new THREE.Matrix4;n.makeRotationAxis(new THREE.Vector3(0,1,0),t.x);var c=new THREE.Vector3(1,0,0).applyEuler(s.rotation),u=new THREE.Matrix4;u.makeRotationAxis(c,t.y),n.multiply(u),l.applyMatrix4(n),s.position.copy(a).add(l),i.applyMatrix4(n),s.lookAt(i.add(s.position))}h.dispatchEvent(f)},this.rotate2=function(t,e){if(e&&(o=!0,a.copy(h.center)),h.getIntersectPoint&&o){l.copy(s.position).sub(h.center);var i=Math.atan2(l.x,l.z),r=Math.atan2(Math.sqrt(l.x*l.x+l.z*l.z),l.y);i+=t;r=Math.max(1e-6,Math.min(Math.PI-1e-6,r));var n=l.length();l.x=n*Math.sin(r)*Math.sin(i),l.y=n*Math.cos(r),l.z=n*Math.sin(r)*Math.cos(i),s.position.copy(h.center).add(l),s.lookAt(h.center)}h.dispatchEvent(f)},this.getIntersectPoint=function(t){var e=new THREE.Vector3;e.fromArray(g(n,t.x,t.y));for(var i=m(e,this.intersectObjects),r=0;r<i.length;++r){var o=i[r].object;if(o.visible)if(null==editor.getParentByProperty(o,"visible",!1,!0))return i[r].point}};var g=function(t,e,i){var r=t.getBoundingClientRect();return[(e-r.left)/r.width,(i-r.top)/r.height]};function v(t){if(!1!==h.enabled){p.set(t.clientX,t.clientY);var e=p.x-d.x,i=p.y-d.y;c===h.STATE.ROTATE?h.rotate(new THREE.Vector3(.005*-e,.005*-i,0),!1):c===h.STATE.ZOOM?h.zoom(new THREE.Vector3(0,0,.1*i)):c===h.STATE.PAN?h.pan(new THREE.Vector3(-e,i,0)):c==h.STATE.PARALLELPAN&&h.parallelpan(new THREE.Vector3(-e,i,0)),d.set(t.clientX,t.clientY)}}function y(t){n.removeEventListener("mousemove",v,!1),n.removeEventListener("mouseup",y,!1),n.removeEventListener("mouseout",y,!1),n.removeEventListener("dblclick",y,!1),c=this.NONE}function E(t){if(t.preventDefault(),!1!==h.enabled){var e,i=0;t.wheelDelta?(i=-t.wheelDelta*h.wheelscale,e=t.wheelDelta):t.detail&&(i=10*t.detail*h.wheelscale,e=-t.detail),h.centerzoom?h.zoom_on_point(new THREE.Vector3(0,0,i),Math.sign(e)):h.zoom(new THREE.Vector3(0,0,i),e)}}new THREE.Vector3;var x=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],_=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3],w=null;n.addEventListener("touchstart",function(t){if(!1!==h.enabled){switch(t.touches.length){case 1:x[0].set(t.touches[0].pageX,t.touches[0].pageY,0),x[1].set(t.touches[0].pageX,t.touches[0].pageY,0);break;case 2:x[0].set(t.touches[0].pageX,t.touches[0].pageY,0),x[1].set(t.touches[1].pageX,t.touches[1].pageY,0),w=x[0].distanceTo(x[1]);break;case 3:x[0].set(t.touches[0].pageX,t.touches[0].pageY,0),x[1].set(t.touches[1].pageX,t.touches[1].pageY,0)}var e;_[0].copy(x[0]),_[1].copy(x[1]),!h.getIntersectPoint||1!==t.touches.length&&3!==t.touches.length||((e=h.getIntersectPoint(new THREE.Vector2(t.touches[0].pageX,t.touches[0].pageY)))?(o=!0,a.copy(e)):(o=!0,a.copy(h.center))),h.getIntersectPoint&&2===t.touches.length&&((e=h.getIntersectPoint(new THREE.Vector2((t.touches[0].pageX+t.touches[1].pageX)/2,(t.touches[0].pageY+t.touches[1].pageY)/2)))?(o=!0,a.copy(e)):(o=!0,a.copy(h.center)))}},!1),n.addEventListener("touchmove",function(t){if(t.preventDefault(),t.stopPropagation(),!1!==h.enabled){var e=function(t,e){var i=e[0];for(var r in e)i.distanceTo(t)>e[r].distanceTo(t)&&(i=e[r]);return i};if(h.navigationMode.lbuttonDown==h.STATE.ROTATE)switch(t.touches.length){case 1:x[0].set(t.touches[0].pageX,t.touches[0].pageY,0),x[1].set(t.touches[0].pageX,t.touches[0].pageY,0),h.rotate(x[0].sub(e(x[0],_)).multiplyScalar(-.005),!1);break;case 2:x[0].set(t.touches[0].pageX,t.touches[0].pageY,0),x[1].set(t.touches[1].pageX,t.touches[1].pageY,0),distance=x[0].distanceTo(x[1]),h.zoom(new THREE.Vector3(0,0,w-distance)),w=distance;var i=x[0].clone().sub(e(x[0],_)),r=x[1].clone().sub(e(x[1],_));i.x=-i.x,r.x=-r.x,h.pan(i.add(r).multiplyScalar(.5))}else switch(t.touches.length){case 1:x[0].set(t.touches[0].pageX,t.touches[0].pageY,0),(i=x[0].clone().sub(e(x[0],_))).x=-i.x,h.parallelpan(i);break;case 2:x[0].set(t.touches[0].pageX,t.touches[0].pageY,0),x[1].set(t.touches[1].pageX,t.touches[1].pageY,0);var n=x[1].sub(x[0]).angleTo(_[1].sub(_[0]));x[1].sub(x[0]).cross(_[1].sub(_[0])).z>0&&(n*=-1),h.rotate2(n,!1),x[0].set(t.touches[0].pageX,t.touches[0].pageY,0),x[1].set(t.touches[1].pageX,t.touches[1].pageY,0),distance=x[0].distanceTo(x[1]),h.zoom(new THREE.Vector3(0,0,2*(w-distance))),w=distance;break;case 3:x[0].set(t.touches[0].pageX,t.touches[0].pageY,0),x[1].set(t.touches[0].pageX,t.touches[0].pageY,0),h.rotate(x[0].sub(e(x[0],_)).multiplyScalar(-.005),!1)}_[0].copy(x[0]),_[1].copy(x[1])}},!1),n.addEventListener("mousewheel",E,!1),n.addEventListener("contextmenu",function(t){t.preventDefault()},!1),n.addEventListener("mousedown",function(t){if(!1!==h.enabled){if(0===t.button?c=h.navigationMode.lbuttonDown:1===t.button?c=h.navigationMode.mbuttonDown:2===t.button&&(c=h.navigationMode.rbuttonDown),d.set(t.clientX,t.clientY),h.getIntersectPoint&&c===h.STATE.ROTATE){var e=h.getIntersectPoint(d);e?(o=!0,a.copy(e)):(o=!0,a.copy(h.center))}n.addEventListener("mousemove",v,!1),n.addEventListener("mouseup",y,!1),n.addEventListener("mouseout",y,!1),n.addEventListener("dblclick",y,!1)}},!1),n.addEventListener("mousewheel",E,!1),n.addEventListener("DOMMouseScroll",E,!1),this.update=function(){this.rotateRad.length()&&(o=!0,a.copy(a.copy(h.center)),this.rotate(this.rotateRad,!1))}},SoonSpace.prototype.EarthControls.prototype=Object.create(THREE.EventDispatcher.prototype),SoonSpace.prototype.EarthControls.prototype.constructor=SoonSpace.prototype.EarthControls;var THREEx=THREEx||{};function TransformObject(t){var e=t.viewport.renderer.domElement,i=t.editor.camera,r=new THREE.Raycaster,n=new THREE.Vector2;a(),this.enabled=!0,this.selectedObject=null,this.targetObject=null,this.activate=a,this.deactivate=s,this.dispose=function(){s()},this.attach=function(t,e){this.selectedObject=t,this.targetObject=e};var o=this;function a(){e.addEventListener("mousemove",h,!1),e.addEventListener("mousedown",l,!1)}function s(){e.removeEventListener("mousemove",h,!1),e.removeEventListener("mousedown",l,!1)}function h(a){if(!1!==o.enabled&&t.defined(o.selectedObject)){a.preventDefault();var s=e.getBoundingClientRect();n.x=(a.clientX-s.left)/s.width*2-1,n.y=-(a.clientY-s.top)/s.height*2+1,r.setFromCamera(n,i);var h=r.intersectObjects(o.targetObject);h.length>0&&o.selectedObject.position.copy(h[0].point)}}function l(t){t.preventDefault(),o.selectedObject=null}}THREEx.KeyboardState=function(){this.keyCodes={},this.modifiers={};var t=this;this._onKeyDown=function(e){t._onKeyChange(e,!0)},this._onKeyUp=function(e){t._onKeyChange(e,!1)},document.addEventListener("keydown",this._onKeyDown,!1),document.addEventListener("keyup",this._onKeyUp,!1)},THREEx.KeyboardState.prototype.destroy=function(){document.removeEventListener("keydown",this._onKeyDown,!1),document.removeEventListener("keyup",this._onKeyUp,!1)},THREEx.KeyboardState.MODIFIERS=["shift","ctrl","alt","meta"],THREEx.KeyboardState.ALIAS={left:37,up:38,right:39,down:40,space:32,pageup:33,pagedown:34,enter:13,escape:27,lbracket:219,rbracket:221,tab:9},THREEx.KeyboardState.prototype._onKeyChange=function(t,e){var i=t.keyCode;this.keyCodes[i]=e,this.modifiers.shift=t.shiftKey,this.modifiers.ctrl=t.ctrlKey,this.modifiers.alt=t.altKey,this.modifiers.meta=t.metaKey},THREEx.KeyboardState.prototype.pressed=function(t){for(var e=t.split("+"),i=0;i<e.length;i++){var r=e[i];if(!(-1!==THREEx.KeyboardState.MODIFIERS.indexOf(r)?this.modifiers[r]:-1!=Object.keys(THREEx.KeyboardState.ALIAS).indexOf(r)?this.keyCodes[THREEx.KeyboardState.ALIAS[r]]:this.keyCodes[r.toUpperCase().charCodeAt(0)]))return!1}return!0},SoonSpace.prototype.TransformControls=function(t){var e=t.editor.sceneHelpers,i=new THREE.TransformControls(t.editor.camera,t.viewport.rendererCSS3D.domElement);return e.add(i),e.addEventListener("preUpdate",function(){i.update()}),i.addEventListener("dragging-changed",function(e){t.viewport.controls.enabled=!e.value}),i},TransformObject.prototype=Object.create(THREE.EventDispatcher.prototype),TransformObject.prototype.constructor=TransformObject,SoonSpace.prototype.TransformObject=TransformObject;var scratchN=new THREE.Vector3,scratchK=new THREE.Vector3,wgs84RadiiSquared=new THREE.Vector3(40680631590769,40680631590769,40408299984661.445);Object.assign(THREE.Vector3,{fromDegrees:function(t,e,i,r){return t=THREE.Math.degToRad(t),e=THREE.Math.degToRad(e),this.fromRadians(t,e,i,r)},toDegrees:function(){},fromRadians:function(t,e,i,r){i||(i=0);var n=wgs84RadiiSquared,o=Math.cos(e);scratchN.x=o*Math.cos(t),scratchN.y=o*Math.sin(t),scratchN.z=Math.sin(e),scratchN.normalize(scratchN),scratchK.multiplyVectors(n,scratchN);var a=Math.sqrt(scratchN.dot(scratchK));return scratchK.divideScalar(a),scratchN.multiplyScalar(i),r||(r=new THREE.Vector3),r.addVectors(scratchK,scratchN),r}}),Object.assign(THREE.Vector3.prototype,{getMaxElement:function(){return Math.max(this.x,Math.max(this.y,this.z))}}),SoonSpace.prototype.analysisXml=function(t){let e={};return new Promise((i,r)=>{if(document.implementation&&document.implementation.createDocument){let n=new XMLHttpRequest;n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status){let t=(new DOMParser).parseFromString(n.responseText,"application/xml"),o=t.evaluate?t:document,a=o.evaluate("model_list",t,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),s=a.iterateNext();if(s){let i;for(;s;)i=s.getAttribute("type")||"single",s=a.iterateNext();switch(i){case"single":e.success=!0,e.data={},e.data.type=-1;let r=o.evaluate("model_list/asset_model_gis/model/model_item",t,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),n=r.iterateNext();for(;n;){let t=n.getAttribute("type")||"main";e.data.gis={},e.data.gis.id=n.getAttribute("id"),e.data.gis.name=n.getAttribute("name"),e.data.gis.url=n.getAttribute("filepage"),e.data.gis.type="main"===t?-1:"model_item type ",n=r.iterateNext()}let a=o.evaluate("model_list/asset_model/model/model_item",t,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),s=a.iterateNext();for(;s;){let t=s.getAttribute("type")||"item";e.data.bim={},e.data.bim.id=s.getAttribute("id"),e.data.bim.name=s.getAttribute("name"),e.data.bim.url=s.getAttribute("filepage"),e.data.bim.type="main"===t?1:"model_item type ",s=a.iterateNext()}break;case"multiple":let h=null,l=o.evaluate("model_list/asset_model_gis/model/model_item",t,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),c=l.iterateNext();for(;c;){let t=c.getAttribute("type")||"main",i=c.getAttribute("id");h=i;let r={type:"main"===t?-2:"model_item type ",id:i,name:c.getAttribute("name"),url:c.getAttribute("filepage")};e.success=!0,e.data={},e.data=Object.assign(e.data,r),c=l.iterateNext()}let u=o.evaluate("model_list/asset_model/model/model_item",t,null,XPathResult.UNORDERED_NODE_ITERATOR_TYPE,null),p=u.iterateNext();for(;p;){let t={type:"item"===(p.getAttribute("type")||"item")?2:"model_item type ",id:p.getAttribute("id"),pid:h,name:p.getAttribute("name"),url:p.getAttribute("filepage")};e.success=!0,e.data.children||(e.data.children=[]),e.data.children.push(t),p=u.iterateNext()}}}else delete e.data,e.success=!1,e.message="xml ",r(e);i(e)}else delete e.data,e.success=!1,e.message="xml ",r(e)},n.open("GET",t,!0),n.send(null)}else delete e.data,e.success=!1,e.message="Don't know to parse XML",r(e)})};var definePropertyWorks=function(){try{return"x"in Object.defineProperty({},"x",{})}catch(t){return!1}}(),defineProperties=Object.defineProperties;definePropertyWorks&&SoonSpace.prototype.defined(defineProperties)||(defineProperties=function(t){return t}),SoonSpace.prototype.drawLine=function(t={nextPoint:void 0,color:"red"}){let e=SoonSpace.viewport.scene,i=e.getObjectByName("drawLayer");void 0===i&&((i=new THREE.Group).name="drawLayer",i.userData.pointArr=[],e.add(i));var r=i.userData.pointArr,n=new THREE.BufferGeometry;let o=[];var a=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,linewidth:50});const{nextPoint:s,color:h}=t;r.push(s);const l=new THREE.Color(h);var c=[];let u=r.length;for(let t=0;t<u;++t)o.push(r[t].x,r[t].y,r[t].z),c.push(l.r),c.push(l.g),c.push(l.b);n.addAttribute("position",new THREE.Float32BufferAttribute(o,3)),n.addAttribute("color",new THREE.Float32BufferAttribute(c,3)),n.computeBoundingSphere();let p=new THREE.Line(n,a);return p.name="drawLine",i.add(p),e.add(i),n.dispose(),p},SoonSpace.prototype.drawFace=function(t={nextPoint:void 0,color:"red",opcity:.5,bounding:!0}){let e=SoonSpace.viewport.scene;const{nextPoint:i,color:r,opcity:n,bounding:o}=t;var a=new THREE.MeshStandardMaterial({transparent:!0,color:t.color,side:THREE.DoubleSide});a.opacity=n;var s=e.getObjectByName("drawLayer");void 0===s&&((s=new THREE.Group).name="drawLayer",s.userData.pointArr=[],e.add(s));var h=s.userData.pointArr;for(h.push(i);s.getObjectByName("markMesh");)s.remove(s.getObjectByName("markMesh"));var l={lineObject:void 0,faceObject:void 0};for(let t=0;t<h.length-2;++t){var c=new THREE.Geometry;c.vertices.push(h[0]),c.vertices.push(h[t+1]),c.vertices.push(h[t+2]);var u=new THREE.Vector3(0,1,0),p=new THREE.Color(r),d=new THREE.Face3(0,1,2,u,p,0);c.faces.push(d),c.computeFaceNormals(),c.computeVertexNormals();let e=new THREE.Mesh(c,a);e.name="markMesh",s.add(e),l.faceObject=e,c.dispose()}return o&&(l.lineObject=function(t){let e=SoonSpace.viewport.scene,i=e.getObjectByName("drawLayer");for(void 0===i&&((i=new THREE.Group).name="drawLayer",e.add(i));i.getObjectByName("drawLine");)i.remove(i.getObjectByName("drawLine"));var r=[].concat(i.userData.pointArr);r.length>0&&r.push(r[0]);var n=new THREE.BufferGeometry;let o=[];var a=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,linewidth:50});const s=new THREE.Color(t);var h=[];let l=r.length;for(let t=0;t<l;++t)o.push(r[t].x,r[t].y,r[t].z),h.push(s.r),h.push(s.g),h.push(s.b);n.addAttribute("position",new THREE.Float32BufferAttribute(o,3)),n.addAttribute("color",new THREE.Float32BufferAttribute(h,3)),n.computeBoundingSphere();let c=new THREE.Line(n,a);return c.name="drawLine",i.add(c),e.add(i),n.dispose(),c}("red")),l},SoonSpace.prototype.drawCirclePlane=function(t={center:{x:0,y:0,z:0},radius:800,color:"red"}){const{center:e,radius:i,color:r}=t;let n=new THREE.Color(r);var o={u_color:{value:new THREE.Vector3(n.r,n.g,n.b)},u_r:{value:.25},u_edge:{value:.05}},a=["varying vec2 vUv;","void main(){","vUv = uv;","\tgl_Position\t= projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),s=["varying vec2 vUv;","uniform vec3 u_color;","uniform float u_r;","uniform float u_edge;","void main(){","float pct = distance(vUv,vec2(0.5));","float t = smoothstep(pct-u_edge,pct,u_r);","vec3 color = vec3(t*2.0);","gl_FragColor = vec4(u_color,t);","}"].join("\n"),h=(["varying vec2 vUv;","uniform vec3 u_color;","uniform float u_r;","uniform float u_edge;","float plot(float d, float pct){","return  smoothstep( pct-u_edge, pct, d)- ","smoothstep( pct, pct+u_edge, d);","}","void main(){","float pct = distance(vUv,vec2(0.5));","float t = plot(pct,u_r);","vec3 color = vec3(t*2.0);","gl_FragColor = vec4(u_color,0.2);","}"].join("\n"),new THREE.PlaneGeometry(i,i)),l=new THREE.ShaderMaterial({vertexShader:a,fragmentShader:s,side:THREE.DoubleSide,uniforms:o,transparent:!0,depthWrite:!1}),c=new THREE.Mesh(h,l);c.position.set(e.x,e.y,e.z),c.rotation.set(Math.PI/2,0,0);SoonSpace.editor.scene.getObjectByName("drawLayer");return SoonSpace.editor.scene.add(c),c},SoonSpace.prototype.drawTorusPlane=function(t={center:{x:0,y:0,z:0},radius:800,planeSize:4e3,torusWidth:200,color:"red",opacity:o}){const{center:e,radius:i,planeSize:r,color:n,opacity:o,torusWidth:a}=t;let s=new THREE.Color(n);var h={u_color:{value:new THREE.Vector3(s.r,s.g,s.b)},u_r:{value:i/r},u_edge:{value:a/r},u_opcity:{value:o}},l=["varying vec2 vUv;","void main(){","vUv = uv;","\tgl_Position\t= projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),c=(["varying vec2 vUv;","uniform vec3 u_color;","uniform float u_r;","uniform float u_edge;","uniform float u_opcity;","void main(){","float pct = distance(vUv,vec2(0.5));","float t = smoothstep(pct-u_edge,pct,u_r);","vec3 color = vec3(t*2.0);","gl_FragColor = vec4(u_color,t);","}"].join("\n"),["varying vec2 vUv;","uniform vec3 u_color;","uniform float u_r;","uniform float u_edge;","uniform float u_opcity;","float plot(float d, float pct){","return  smoothstep( pct-u_edge, pct, d)- ","smoothstep( pct, pct+u_edge, d);","}","void main(){","float pct = distance(vUv,vec2(0.5));","float t = plot(pct,u_r)*u_opcity;","vec3 color = vec3(t*2.0);","gl_FragColor = vec4(u_color,t);","}"].join("\n")),u=new THREE.PlaneGeometry(i,i),p=new THREE.ShaderMaterial({vertexShader:l,fragmentShader:c,side:THREE.DoubleSide,uniforms:h,transparent:!0,depthWrite:!1}),d=new THREE.Mesh(u,p);d.position.set(e.x,e.y,e.z),d.rotation.set(Math.PI/2,0,0);SoonSpace.editor.scene.getObjectByName("drawLayer");return SoonSpace.editor.scene.add(d),d},SoonSpace.prototype.drawWord=function(t={scene:SoonSpace.editor.scene,word:"",color:"red",size:83,position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0}}){const{scene:e,word:i,color:r,size:n,position:o,rotation:a}=t;var s=document.createElement("canvas");s.width=1600,s.height=800;var h=s.getContext("2d");h.font="Normal  320px Arial",h.lineWidth=10,h.fillStyle=r,h.textBaseline="top",h.fillText(i,10,10);var l=new THREE.CanvasTexture(s);let c=new THREE.MeshBasicMaterial;c.map=l;let u=new THREE.Mesh(new THREE.BoxBufferGeometry(1,8e3,16e3),c),p=e.getObjectByName("markWordLayer");return void 0===p&&((p=new THREE.Group).name="markWordLayer",e.add(p)),p.add(u),u.material.alphaTest=.5,u.material.needsUpdate=!0,u.scale.set(1,n/8e3,n/8e3),u.position.set(o.x,o.y,o.z),u.rotation.set(a.x,a.y,a.z),u.name="word3D",u};var jFunk=function(t,e){if(!e)return[];for(var i=t.split(","),r=[],n=0;n<i.length;n++){var o=i[n].split(" "),a=[e];if(i[n].indexOf("(")>-1)for(var s=0;s<o.length;s++)if(o[s].indexOf("(")>-1){for(var h=s+1;h<o.length&&")"!=o[h];)h++;o[s]+=" "+o.splice(s+1,h-s-1).join(" ")}for(s=0;s<o.length;s++)">"==o[s]?(s++,a=jFunk.sub.find(o[s],a,1)):a=jFunk.sub.find(o[s],a);r=r.concat(a)}return{results:r,get:function(t){return"number"!=typeof t?this.results:this.results[t]}}};jFunk.init=function(t){for(pi in t)jFunk.sub[pi]=t[pi]},jFunk.sub={propertyPound:"id",propertyDot:"class",find:function(t,e,i){if("number"!=typeof t&&0==t.length)return obj;var r=t.split(":"),n=r[0].split("["),o=r[1];t=n.shift();for(var a=n,s=0;s<a.length;s++)a[s]=a[s].split("]")[0].split("=");var h=Number(t);isNaN(h)||(t=h);for(var l=[],c=0;c<e.length;c++)"object"==typeof e[c]&&(l=l.concat(this.find_sub(t,e[c],a,i)));return o?"first"==o?[l[0]]:"last"==o?[l.pop()]:o.indexOf("has")>-1?this.find_has(l,o):l:l},find_sub:function(t,e,i,r){if("object"!=typeof e)return[];var n=[];if("number"==typeof t)e[t]&&(i&&!this.find_matchProperty(e[t],i)||n.push(e[t]));else if("#"==t.charAt(0)&&e[jFunk.sub.propertyPound])e[jFunk.sub.propertyPound]==t.split("#")[1]&&(i&&!this.find_matchProperty(e,i)||n.push(e));else if("."==t.charAt(0)&&e[jFunk.sub.propertyDot])e[jFunk.sub.propertyDot]==t.split(".")[1]&&(i&&!this.find_matchProperty(e,i)||n.push(e));else if("*"==t)for(pr in e)i&&!this.find_matchProperty(e[pr],i)||n.push(e[pr]);else"*"!=t&&e[t]&&(i&&!this.find_matchProperty(e[t],i)||n.push(e[t]));if("object"==typeof e&&(!r||1==r&&e.sort)&&!e.innerHTML)for(pr in e)n=n.concat(jFunk.sub.find_sub(t,e[pr],i,r?2:null));return n},find_matchProperty:function(t,e){if(!e)return!0;for(var i=0;i<e.length;i++){if(1==e[i].length&&void 0===t[e[i][0]])return!1;if(2==e[i].length&&e[i][1]!=t[e[i][0]])return!1}return!0},find_has:function(t,e){for(var i=e.split("has(")[1].split(")")[0],r=0;r<t.length;r++){var n=jFunk(i,t[r]);n&&0!=n.length||(t.splice(r,1),r--)}return t}}(function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e(t.maptalks={})}(this,function(t){"use strict";var e=["MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"],i=["FeatureCollection","Feature","Point","LineString","Polygon"].concat(e),r=["markerFile","polygonPatternFile","linePatternFile","markerFillPatternFile","markerLinePatternFile"],n=[["markerWidth","markerHeight"],[],[null,"lineWidth"],[],[null,"markerLineWidth"]],o={lineWidth:1,lineOpacity:1,lineDx:1,lineDy:1,polygonOpacity:1,markerWidth:1,markerHeight:1,markerDx:1,markerDy:1,markerOpacity:1,markerFillOpacity:1,markerLineWidth:1,markerLineOpacity:1,textSize:1,textOpacity:1,textHaloRadius:1,textWrapWidth:1,textLineSpacing:1,textDx:1,textDy:1},a=["lineColor","polygonFill","markerFill","markerLineColor","textFill"];function s(){return Date.now()}function h(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var r in i)t[r]=i[r]}return t}function l(t){return null==t}function c(t){return"number"==typeof t&&!isNaN(t)}function u(t){return(0|t)===t}function p(t){return"object"==typeof t&&!!t}function d(t){return!l(t)&&("string"==typeof t||null!==t.constructor&&t.constructor===String)}function f(t){return!l(t)&&("function"==typeof t||null!==t.constructor&&t.constructor===Function)}var m=Object.prototype.hasOwnProperty;function g(t,e){return m.call(t,e)}var v=Math.PI/180;function y(t){return t*v}function E(t){return t/v}var x,_,w="[object process]"===Object.prototype.toString.call("undefined"!=typeof process?process:0)&&!process.versions.electron&&!process.versions.nw&&!process.versions["node-webkit"];function b(t){return t.length>4&&".svg"===t.slice(-4)?1:"data:image/svg+xml"===t.slice(0,"data:image/svg+xml".length)?2:0}function S(t,e){w&&S.node?S.node(t,e):t.src=e[0]}!function(){if(w)return x=function(t){return setTimeout(t,16)},void(_=clearTimeout);var t,e,i=1e3/30;function r(t){return setTimeout(t,i)}function n(t){return window["webkit"+t]||window["moz"+t]||window["ms"+t]}"undefined"!=typeof window?(t=window.requestAnimationFrame||n("RequestAnimationFrame")||r,e=window.cancelAnimationFrame||n("CancelAnimationFrame")||n("CancelRequestAnimationFrame")||function(t){window.clearTimeout(t)}):(t=r,e=clearTimeout),x=function(e){return t(e)},_=function(t){t&&e(t)}}();var T=0;function M(){return T++}var R=M;function A(t){return t&&d(t)?JSON.parse(t):t}function C(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];if(i)for(var r=0,n=i.length;r<n;r++)t.push(i[r])}return t.length}function P(t,e){var i=e.indexOf(t);i>-1&&e.splice(i,1)}function D(t,e,i){if(!Array.isArray(t))return i?e.call(i,t):e(t);for(var r,n,o=[],a=0,s=t.length;a<s;a++)l(r=t[a])?o.push(null):Array.isArray(r)?o.push(D(r,e,i)):(n=i?e.call(i,r):e(r),o.push(n));return o}function L(t,e){return void 0===t?e:t}function O(t){return Math.sign?Math.sign(t):0===(t=+t)||isNaN(t)?Number(t):t>0?1:-1}function H(t){if(Math.log2)return Math.log2(t);var e=Math.log(t)*Math.LOG2E,i=Math.round(e);return Math.abs(i-e)<1e-14?i:e}function I(t,e,i){return t*(1-i)+e*i}function B(t,e,i){if(t===i||t===e)return t;var r=i-e;return((t-e)%r+r)%r+e}function z(t,e,i){return Math.min(i,Math.max(e,t))}function N(t){return Array.isArray(t)&&t.length>0}function k(t){if(!t)return!1;var e=t.slice(0,6);return"http:/"===e||"https:"===e||"file:/"===e}var j=/^url\((['"])(.+)\1\)$/i,V=/^url\(([^'"].*[^'"])\)$/i;function F(t){if(!d(t))return 0;var e=t.slice(0,6);return"http:/"===e||"https:"===e?3:V.test(t)?1:j.test(t)?2:0}function U(t){var e=F(t);return 3===e?t:1===e?V.exec(t)[1]:2===e?j.exec(t)[2]:t}var G="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function W(t){if("undefined"!=typeof window&&window.btoa)return window.btoa(t);for(var e,i,r=String(t),n="",o=0,a=G;r.charAt(0|o)||(a="=",o%1);n+=a.charAt(63&e>>8-o%1*8)){if((i=r.charCodeAt(o+=.75))>255)throw new Error("'btoa' failed: The string to be encoded contains characters outside of the Latin1 range.");e=e<<8|i}return n}function X(t,e){for(var i=atob(t),r=new ArrayBuffer(i.length),n=new Uint8Array(r),o=0;o<i.length;o++)n[o]=255&i.charCodeAt(o);return new Blob([r],{type:e})}function Z(t,e,i,r){var n=i-t,o=r-e;return Math.atan2(o,n)}var Y="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";function q(t,e){if(!t&&!e)return!0;if(!t||!e)return!1;for(var i in t)if("center"===i){if(!e[i]||!J(t[i][0],e[i][0])||!J(t[i][1],e[i][1]))return!1}else if(t[i]!==e[i])return!1;return!0}function J(t,e,i){return null==i&&(i=1e-6),t>=e-i&&t<=e+i}function Q(t,e,i,r){t||(t=100),e||(e=4);var n=this;return e*=2,this._flashTimeout&&clearTimeout(this._flashTimeout),this._flashTimeout=setTimeout(function o(){if(0===e)return n.show(),void(i&&(r?i.call(r):i()));e%2==0?n.hide():n.show(),e--,n._flashTimeout=setTimeout(o,t)},t),this}function K(t,e){for(var i=Object.getOwnPropertyNames(e),r=0;r<i.length;r++){var n=i[r],o=Object.getOwnPropertyDescriptor(e,n);o&&o.configurable&&void 0===t[n]&&Object.defineProperty(t,n,o)}return t}var $=["Unknown","Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon","GeometryCollection"];function tt(t){return new Function("f","var p = (f && f.properties || {}); return "+et(t))}function et(t){if(!t)return"true";var e=t[0];return t.length<=1?"any"===e?"false":"true":"("+("=="===e?rt(t[1],t[2],"===",!1):"!="===e?rt(t[1],t[2],"!==",!1):"<"===e||">"===e||"<="===e||">="===e?rt(t[1],t[2],e,!0):"any"===e?nt(t.slice(1),"||"):"all"===e?nt(t.slice(1),"&&"):"none"===e?st(nt(t.slice(1),"||")):"in"===e?ot(t[1],t.slice(2)):"!in"===e?st(ot(t[1],t.slice(2))):"has"===e?at(t[1]):"!has"===e?st(at(t[1])):"true")+")"}function it(t){return"$"===t[0]?"f."+t.substring(1):"p["+JSON.stringify(t)+"]"}function rt(t,e,i,r){var n=it(t),o="$type"===t?$.indexOf(e):JSON.stringify(e);return(r?"typeof "+n+"=== typeof "+o+"&&":"")+n+i+o}function nt(t,e){return t.map(et).join(e)}function ot(t,e){"$type"===t&&(e=e.map(function(t){return $.indexOf(t)}));var i=JSON.stringify(e.sort(ht)),r=it(t);return e.length<=200?i+".indexOf("+r+") !== -1":"function(v, a, i, j) {\n        while (i <= j) { var m = (i + j) >> 1;\n            if (a[m] === v) return true; if (a[m] > v) j = m - 1; else i = m + 1;\n        }\n    return false; }("+r+", "+i+",0,"+(e.length-1)+")"}function at(t){return"$id"===t?'"id" in f':JSON.stringify(t)+" in p"}function st(t){return"!("+t+")"}function ht(t,e){return t<e?-1:t>e?1:0}function lt(t){var e=t._toJSON(),i=e.feature;return i.type=$.indexOf(i.geometry.type),i.subType=e.subType,i}function ct(t){if(!Array.isArray(t))return ct([t]);for(var e=[],i=0;i<t.length;i++){var r=void 0;r=!0===t[i].filter?function(){return!0}:tt(t[i].filter),e.push(ut({},t[i],{filter:r}))}return e}function ut(t){for(var e=1;e<arguments.length;e++){var i=arguments[e];for(var r in i)t[r]=i[r]}return t}function pt(t,e){for(var i=0;i<t.stops.length;i++)if(e===t.stops[i][0])return t.stops[i][1];return t.default}function dt(t,e){for(var i=0;i<t.stops.length&&!(e<t.stops[i][0]);i++);return t.stops[Math.max(i-1,0)][1]}function ft(t,e){for(var i=void 0!==t.base?t.base:1,r=0;!(r>=t.stops.length||e<=t.stops[r][0]);)r++;return 0===r?t.stops[r][1]:r===t.stops.length?t.stops[r-1][1]:function t(e,i,r,n,o,a){return"function"==typeof o?function(){var s=o.apply(void 0,arguments),h=a.apply(void 0,arguments);return t(e,i,r,n,s,h)}:o.length?function(t,e,i,r,n,o){for(var a=[],s=0;s<n.length;s++)a[s]=gt(t,e,i,r,n[s],o[s]);return a}(e,i,r,n,o,a):gt(e,i,r,n,o,a)}(e,i,t.stops[r-1][0],t.stops[r][0],t.stops[r-1][1],t.stops[r][1])}function mt(t,e){return i=e,r=t.default,void 0!==i?i:void 0!==r?r:void 0!==n?n:null;var i,r,n}function gt(t,e,i,r,n,o){var a,s=r-i,h=t-i;return n*(1-(a=1===e?h/s:(Math.pow(e,h)-1)/(Math.pow(e,s)-1)))+o*a}function vt(t){return t&&"object"==typeof t&&(t.stops||t.property&&"identity"===t.type)}function yt(t){for(var e in t)if(vt(t[e]))return!0;return!1}function Et(t){return wt(t,"exponential")}function xt(t,e){if(!t)return null;var i=!1;if(Array.isArray(t)){for(var r,n=[],o=0;o<t.length;o++)(r=xt(t[o],e))?(n.push(r),i=!0):n.push(t[o]);return i?n:t}var a,s={__fn_types_loaded:!0},h=[];for(a in t)t.hasOwnProperty(a)&&h.push(a);for(var l=function(t){Object.defineProperty(s,t,{get:function(){return this["__fn_"+t]||(this["__fn_"+t]=Et(this["_"+t])),this["__fn_"+t].apply(this,e())},set:function(e){this["_"+t]=e},configurable:!0,enumerable:!0})},c=0,u=h.length;c<u;c++)vt(t[a=h[c]])?(i=!0,s["_"+a]=t[a],l(a)):s[a]=t[a];return i?s:t}function _t(t){if(!t||!t.stops)return[];for(var e=[],i=0,r=t.stops.length;i<r;i++)e.push(t.stops[i][1]);return e}function wt(t,e){if(!vt(t))return function(){return t};var i=!0,r=!0,n=(t=JSON.parse(JSON.stringify(t))).stops;if(n)for(var o=0;o<n.length;o++)if(vt(n[o][1])){var a=wt(n[o][1],e);i=i&&a.isZoomConstant,r=r&&a.isFeatureConstant,n[o]=[n[o][0],a]}var s=function t(e,i){var r,n,o;if(vt(e)){var a,s=e.stops&&"object"==typeof e.stops[0][0],h=s||void 0!==e.property,l=s||!h,c=e.type||i||"exponential";if("exponential"===c)a=ft;else if("interval"===c)a=dt;else if("categorical"===c)a=pt;else{if("identity"!==c)throw new Error('Unknown function type "'+c+'"');a=mt}if(s){for(var u={},p=[],d=0;d<e.stops.length;d++){var f=e.stops[d];void 0===u[f[0].zoom]&&(u[f[0].zoom]={zoom:f[0].zoom,type:e.type,property:e.property,default:e.default,stops:[]}),u[f[0].zoom].stops.push([f[0].value,f[1]])}for(var m in u)p.push([u[m].zoom,t(u[m])]);r=function(t,i){var r=ft({stops:p,base:e.base},t)(t,i);return"function"==typeof r?r(t,i):r},n=!1,o=!1}else l?(r=function(t){var i=a(e,t);return"function"==typeof i?i(t):i},n=!0,o=!1):(r=function(t,i){var r=a(e,i?i[e.property]:null);return"function"==typeof r?r(t,i):r},n=!1,o=!0)}else r=function(){return e},n=!0,o=!0;return r.isZoomConstant=o,r.isFeatureConstant=n,r}(t,e);return s.isZoomConstant=i&&s.isZoomConstant,s.isFeatureConstant=r&&s.isFeatureConstant,s}var bt=Object.freeze({createFilter:tt,getFilterFeature:lt,compileStyle:ct,isFunctionDefinition:vt,hasFunctionDefinition:yt,interpolated:Et,piecewiseConstant:function(t){return wt(t,"interval")},loadFunctionTypes:xt,getFunctionTypeResources:_t});function St(t){var e={stroke:{stroke:t.markerLineColor,"stroke-width":t.markerLineWidth,"stroke-opacity":t.markerLineOpacity,"stroke-dasharray":null,"stroke-linecap":"butt","stroke-linejoin":"round"},fill:{fill:t.markerFill,"fill-opacity":t.markerFillOpacity}};return 0===e.stroke["stroke-width"]&&(e.stroke["stroke-opacity"]=0),e}function Tt(t,e,i){if(!t.markerPath)return null;var r=1,n=St(t);c(t.markerOpacity)&&(r=t.markerOpacity),c(t.opacity)&&(r*=t.opacity);var o={};if(n){for(var a in n.stroke)n.stroke.hasOwnProperty(a)&&(l(n.stroke[a])||(o[a]=n.stroke[a]));for(var s in n.fill)n.fill.hasOwnProperty(s)&&(l(n.fill[s])||(o[s]=n.fill[s]))}for(var u,p=Array.isArray(t.markerPath)?t.markerPath:[t.markerPath],f=[],m=0;m<p.length;m++)(u=h({},u=d(p[m])?{path:p[m]}:p[m],o)).d=u.path,delete u.path,f.push(u);var g=['<svg version="1.1"','xmlns="http://www.w3.org/2000/svg"'];r<1&&g.push('opacity="'+r+'"'),t.markerPathWidth&&t.markerPathHeight&&g.push('viewBox="0 0 '+t.markerPathWidth+" "+t.markerPathHeight+'"'),g.push('preserveAspectRatio="none"'),e&&g.push('width="'+e+'"'),i&&g.push('height="'+i+'"'),g.push("><defs></defs>");for(var v=0;v<f.length;v++){var y="<path ";for(var E in f[v])f[v].hasOwnProperty(E)&&(y+=" "+E+'="'+f[v][E]+'"');y+="></path>",g.push(y)}return g.push("</svg>"),"data:image/svg+xml;base64,"+W(g.join(" "))}function Mt(t,e){if(!t)return[];var i=t;Array.isArray(t)||(i=[t]);for(var o,a,s,h,l=[],c=r,u=i.length-1;u>=0;u--)if(t=i[u]){e&&(t=Rt(t));for(var p=0;p<c.length;p++)if(vt(o=t[c[p]])&&(o=_t(o)),o){Array.isArray(o)||(o=[o]);for(var d=0;d<o.length;d++)"url("===o[d].slice(0,4)&&(o[d]=U(o[d])),a=n[p],l.push([o[d],t[a[0]],t[a[1]]])}if("path"===t.markerType&&t.markerPath)if(s=vt(t.markerWidth)?200:t.markerWidth,h=vt(t.markerHeight)?200:t.markerHeight,vt(t.markerPath)){o=_t(t.markerPath);for(var f=t.markerPath,m=0;m<o.length;m++)t.markerPath=o[m],l.push([Tt(t),s,h]);t.markerPath=f}else l.push([Tt(t),s,h])}return l}function Rt(t){if(!t)return null;var e=t;if(w)return e;for(var i,n=r,o=0,a=n.length;o<a;o++)(i=e[n[o]])&&(e[n[o]]=At(i));return e}function At(t){if(vt(t)){for(var e=t.stops,i=0;i<e.length;i++)e[i][1]=At(e[i][1]);return t}return"url("===t.slice(0,4)&&(t=U(t)),!k(t)&&(t.length<="data:".length||"data:"!==t.substring(0,"data:".length))&&(t=function(t,e){var i=t.split("/"),r=e.split("/");if(0===e.slice(0,1))return i.slice(0,3).join("/")+e;i.pop();for(var n=0;n<r.length;n++)"."!==r[n]&&(".."===r[n]?i.pop():i.push(r[n]));return i.join("/")}(location.href,t)),t}function Ct(t){return t&&t.colorStops}function Pt(t){var e=[t.type];if(t.places&&e.push(t.places.join()),t.colorStops){for(var i=[],r=t.colorStops.length-1;r>=0;r--)i.push(t.colorStops[r].join());e.push(i.join(","))}return e.join("_")}function Dt(t,e){function i(t,e){l(t.opacity)?t.opacity=e:t.opacity*=e}var r;if(Array.isArray(t)){r=[];for(var n=0;n<t.length;n++){var o=h({},t[n]);i(o,e),r.push(o)}}else i(r=h({},t),e);return r}function Lt(t){var e=Array.prototype.slice.call(arguments,1);if(e&&e.length||(e=[{}]),Array.isArray(t)){for(var i,r,n=[],o=0,a=t.length;o<a;o++){i=t[o],r={};for(var s=0,c=e.length;s<c;s++)Array.isArray(e[s])?l(e[s][o])?h(r,i||{}):h(r,i,e[s][o]):h(r,i,e[s]?e[s]:{});n.push(r)}return n}var u=[{},t];return u.push.apply(u,e),h.apply(this,u)}var Ot=Object.freeze({now:s,extend:h,isNil:l,isNumber:c,isInteger:u,isObject:p,isString:d,isFunction:f,hasOwn:g,join:function(t,e){return t.join?t.join(e||","):Array.prototype.join.call(t,e||",")},toRadian:y,toDegree:E,IS_NODE:w,get requestAnimFrame(){return x},get cancelAnimFrame(){return _},isSVG:b,loadImage:S,UID:M,GUID:R,parseJSON:A,pushIn:C,removeFromArray:P,forEachCoord:D,getValueOrDefault:L,sign:O,log2:H,interpolate:I,wrap:B,clamp:z,isArrayHasData:N,isURL:k,isCssUrl:F,extractCssUrl:U,btoa:W,b64toBlob:X,computeDegree:Z,emptyImageUrl:Y,equalMapView:q,flash:Q,_defaults:K,translateToSVGStyles:St,getMarkerPathBase64:Tt,getExternalResources:Mt,convertResourceUrl:Rt,isGradient:Ct,getGradientStamp:Pt,getSymbolStamp:function t(e){var i=[];if(Array.isArray(e)){for(var r=0;r<e.length;r++)i.push(t(e[r]));return"[ "+i.join(" , ")+" ]"}for(var n in e)g(e,n)&&(f(e[n])||(Ct(e[n])?i.push(n+"="+Pt(e[n])):i.push(n+"="+e[n])));return i.join(";")},lowerSymbolOpacity:Dt,extendSymbol:Lt}),Ht={};if(!w){var It=navigator.userAgent.toLowerCase(),Bt=document.documentElement,zt="ActiveXObject"in window,Nt=-1!==It.indexOf("webkit"),kt=-1!==It.indexOf("phantom"),jt=-1!==It.search("android [23]"),Vt=-1!==It.indexOf("chrome"),Ft=-1!==It.indexOf("gecko")&&!Nt&&!window.opera&&!zt,Ut="undefined"!=typeof orientation||-1!==It.indexOf("mobile"),Gt=!window.PointerEvent&&window.MSPointerEvent,Wt=window.PointerEvent&&navigator.pointerEnabled||Gt,Xt=zt&&"transition"in Bt.style,Zt="WebKitCSSMatrix"in window&&"m11"in new window.WebKitCSSMatrix&&!jt,Yt="MozPerspective"in Bt.style,qt="OTransition"in Bt.style,Jt=(Xt||Zt||Yt)&&!qt&&!kt,Qt=0;Vt&&(Qt=It.match(/chrome\/([\d.]+)/)[1]);var Kt,$t=!kt&&(Wt||"ontouchstart"in window||window.DocumentTouch&&document instanceof window.DocumentTouch);try{var te=document.createElement("canvas"),ee=te.getContext("webgl")||te.getContext("experimental-webgl");Kt=ee&&ee instanceof WebGLRenderingContext}catch(t){Kt=!1}var ie=window.devicePixelRatio||window.screen.deviceXDPI/window.screen.logicalXDPI;Ht={ie:zt,ielt9:zt&&!document.addEventListener,edge:"msLaunchUri"in navigator&&!("documentMode"in document),webkit:Nt,gecko:Ft,android:-1!==It.indexOf("android"),android23:jt,chrome:Vt,chromeVersion:Qt,safari:!Vt&&-1!==It.indexOf("safari"),phantomjs:kt,ie3d:Xt,webkit3d:Zt,gecko3d:Yt,opera12:qt,any3d:Jt,mobile:Ut,mobileWebkit:Ut&&Nt,mobileWebkit3d:Ut&&Zt,mobileOpera:Ut&&window.opera,mobileGecko:Ut&&Ft,touch:!!$t,msPointer:!!Gt,pointer:!!Wt,retina:ie>1,devicePixelRatio:ie,language:navigator.browserLanguage?navigator.browserLanguage:navigator.language,ie9:zt&&9===document.documentMode,ie10:zt&&10===document.documentMode,webgl:Kt}}var re=Ht;function ne(t,e){t.prototype=Object.create(e.prototype),t.prototype.constructor=t,"undefined"!=typeof document&&document.documentMode<11?K(t,e):t.__proto__=e}function oe(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}var ae=function(){function t(t,e){if(l(t)||l(e)?l(t.x)||l(t.y)?Array.isArray(t)&&(this.x=+t[0],this.y=+t[1]):(this.x=+t.x,this.y=+t.y):(this.x=+t,this.y=+e),this._isNaN())throw new Error("Position is NaN")}var e=t.prototype;return e.set=function(t,e){return this.x=t,this.y=e,this},e.abs=function(){return new this.constructor(Math.abs(this.x),Math.abs(this.y))},e._abs=function(){return this.x=Math.abs(this.x),this.y=Math.abs(this.y),this},e._round=function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},e.round=function(){return new this.constructor(Math.round(this.x),Math.round(this.y))},e._ceil=function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},e.ceil=function(){return new this.constructor(Math.ceil(this.x),Math.ceil(this.y))},e._floor=function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},e.floor=function(){return new this.constructor(Math.floor(this.x),Math.floor(this.y))},e.copy=function(){return new this.constructor(this.x,this.y)},e._add=function(t,e){return l(t.x)?l(t[0])?(this.x+=t,this.y+=e):(this.x+=t[0],this.y+=t[1]):(this.x+=t.x,this.y+=t.y),this},e.add=function(t,e){var i,r;return l(t.x)?l(t[0])?(i=this.x+t,r=this.y+e):(i=this.x+t[0],r=this.y+t[1]):(i=this.x+t.x,r=this.y+t.y),new this.constructor(i,r)},e._sub=function(t,e){return l(t.x)?l(t[0])?(this.x-=t,this.y-=e):(this.x-=t[0],this.y-=t[1]):(this.x-=t.x,this.y-=t.y),this},e._substract=function(){return this._sub.apply(this,arguments)},e.sub=function(t,e){var i,r;return l(t.x)?l(t[0])?(i=this.x-t,r=this.y-e):(i=this.x-t[0],r=this.y-t[1]):(i=this.x-t.x,r=this.y-t.y),new this.constructor(i,r)},e.substract=function(){return this.sub.apply(this,arguments)},e.multi=function(t){return new this.constructor(this.x*t,this.y*t)},e._multi=function(t){return this.x*=t,this.y*=t,this},e.div=function(t){return this.multi(1/t)},e._div=function(t){return this._multi(1/t)},e.equals=function(t){return t instanceof this.constructor&&(this.x===t.x&&this.y===t.y)},e._isNaN=function(){return isNaN(this.x)||isNaN(this.y)},e.isZero=function(){return 0===this.x&&0===this.y},e.toArray=function(){return[this.x,this.y]},e.toFixed=function(t){return new this.constructor(this.x.toFixed(t),this.y.toFixed(t))},e.toJSON=function(){return{x:this.x,y:this.y}},t}(),se=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.closeTo=function(t,e){return e||(e=0),this.x>=t.x-e&&this.x<=t.x+e&&this.y>=t.y-e&&this.y<=t.y+e},i.distanceTo=function(t){var e=t.x-this.x,i=t.y-this.y;return Math.sqrt(e*e+i*i)},i.mag=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},i.unit=function(){return this.copy()._unit()},i._unit=function(){return this._div(this.mag()),this},i.perp=function(){return this.copy()._perp()},i._perp=function(){var t=this.y;return this.y=this.x,this.x=-t,this},i.angleWith=function(t){return this.angleWithSep(t.x,t.y)},i.angleWithSep=function(t,e){return Math.atan2(this.x*e-this.y*t,this.x*t+this.y*e)},i._rotate=function(t){var e=Math.cos(t),i=Math.sin(t),r=e*this.x-i*this.y,n=i*this.x+e*this.y;return this.x=r,this.y=n,this},i.rotate=function(t){return this.copy()._rotate(t)},e}(ae),he=function(){function t(t,e){c(t)&&c(e)?(this.width=t,this.height=e):c(t.width)?(this.width=t.width,this.height=t.height):Array.isArray(t)&&(this.width=t[0],this.height=t[1])}var e=t.prototype;return e.copy=function(){return new t(this.width,this.height)},e.add=function(e,i){var r,n;return e instanceof t?(r=this.width+e.width,n=this.height+e.height):(r=this.width+e,n=this.height+i),new t(r,n)},e.equals=function(t){return this.width===t.width&&this.height===t.height},e.multi=function(e){return new t(this.width*e,this.height*e)},e._multi=function(t){return this.width*=t,this.height*=t,this},e._round=function(){return this.width=Math.round(this.width),this.height=Math.round(this.height),this},e.toPoint=function(){return new se(this.width,this.height)},e.toArray=function(){return[this.width,this.height]},e.toJSON=function(){return{width:this.width,height:this.height}},t}();function le(t){return t.trim?t.trim():t.replace(/^\s+|\s+$/g,"")}var ce=/[\b\t\r\v\f]/gim;function ue(t){return d(t)?t.replace(ce,""):t}function pe(t){return le(t).split(/\s+/)}var de="undefined"!=typeof document?document.createElement("canvas").getContext("2d"):null;function fe(t,e){return fe.node?fe.node(t,e):(de.font=e,de.measureText(t).width)}var me={};function ge(t,e){if(ge.node)return ge.node(t,e);var i=fe(t,e);return e||(e="_default_"),me[e]||(me[e]=ve(e)),new he(i,me[e])}function ve(t){var e=Qe();"_default_"!==t&&(e.style.font=t),e.innerHTML="";var i=e.clientHeight;return Oe(e),i}function ye(t,e,i,r){if(!t||0===t.length)return[{text:"",width:0}];var n=l(r)?fe(t,e):r,o=n/t.length,a=Math.floor(i/o/2);if(o>=i||a<=0)return[{text:"",width:i}];if(n<=i)return[{text:t,width:n}];for(var s=[],h=t.substring(0,a),c=o*a,u=a,p=t.length;u<p;u++){var d=t[u],f=fe(h+d);f>=i?(s.push({text:h,width:c}),h=t.substring(u,a+u),u+=a-1,c=o*a):(h+=d,c=f),u>=p-1&&(c=fe(h),s.push({text:h,width:c}))}return s}var Ee=/\{([\w_]+)\}/g;function xe(t,e){return d(t)?t.replace(Ee,function(t,i){if(!e)return"";var r=e[i];return l(r)?"":Array.isArray(r)?r.join():r}):t}function _e(t,e,i){var r=t.width,n=t.height;return new se("left"===e?-r:"right"===e?0:-r/2,"top"===i?-n:"bottom"===i?0:-n/2)}var we="monospace";function be(t){return t.textFont?t.textFont:(t.textStyle&&"normal"!==t.textStyle?t.textStyle+" ":"")+(t.textWeight&&"normal"!==t.textWeight?t.textWeight+" ":"")+t.textSize+"px "+(t.textFaceName?'"'===t.textFaceName[0]?t.textFaceName:'"'+t.textFaceName+'"':we)}function Se(t,e){var i=be(e),r=e.textLineSpacing||0,n=ge(t,i),o=n.width,a=n.height,s=e.textWrapCharacter,h=[],l=e.textWrapWidth;(!l||l>o)&&(l=o),d(t)||(t+="");var c=0;if(s&&t.indexOf(s)>=0)for(var u=t.split(s),p=0,f=u.length;p<f;p++){var m=u[p],g=fe(m,i);if(g>l)for(var v=ye(m,i,l,g),y=0,E=v.length;y<E;y++){var x=v[y].width;x>c&&(c=x),h.push({text:v[y].text,size:new he(x,a)})}else g>c&&(c=g),h.push({text:m,size:new he(g,a)})}else if(o>l)for(var _=ye(t,i,l,o),w=0;w<_.length;w++){var b=_[w].width;b>c&&(c=b),h.push({text:_[w].text,size:new he(b,a)})}else o>c&&(c=o),h.push({text:t,size:n});var S=h.length;return{total:S,size:new he(c,a*S+r*(S-1)),rows:h,rawSize:n}}var Te=Object.freeze({trim:le,escapeSpecialChars:ue,splitWords:pe,stringWidth:fe,stringLength:ge,getFontHeight:ve,splitContent:ye,replaceVariable:xe,getAlignPoint:_e,getFont:be,splitTextToRow:Se}),Me=w?function(t){return t[0]}:function(t){for(var e=document.documentElement.style,i=0;i<t.length;i++)if(t[i]in e)return t[i];return!1},Re=Me(["transform","WebkitTransform","OTransform","MozTransform","msTransform"]),Ae=Me(["transformOrigin","WebkitTransformOrigin","OTransformOrigin","MozTransformOrigin","msTransformOrigin"]),Ce=Me(["transition","WebkitTransition","OTransition","MozTransition","msTransition"]),Pe=Me(["filter","WebkitFilter","OFilter","MozFilter","msFilter"]);function De(t,e){var i=document.createElement(t);return e&&Xe(i,e),i}function Le(t,e,i){var r=De(t);return e&&Ue(r,e),i&&i.appendChild(r),r}function Oe(t){if(!t)return this;if(re.ielt9||re.ie9){var e=De("div");e.appendChild(t),e.innerHTML="",e=null}else t.parentNode&&t.parentNode.removeChild(t);return this}function He(t,e,i,r){if(!(t&&t.addEventListener&&e&&i))return this;for(var n=function(e){e||(e=window.event),i.call(r||t,e)},o=e.split(" "),a=o.length-1;a>=0;a--){var s=o[a];if(s)t["Z__"+s]||(t["Z__"+s]=[]),Be(t,s,i)>=0&&Ie(t,s,i),t["Z__"+s].push({callback:n,src:i}),"mousewheel"===s&&re.gecko&&(s="DOMMouseScroll"),t.addEventListener(s,n,!1)}return this}function Ie(t,e,i){function r(e,i){"mousewheel"===e&&re.gecko&&(e="DOMMouseScroll"),t.removeEventListener(e,i,!1)}if(!t||!t.removeEventListener||!e)return this;for(var n=e.split(" "),o=n.length-1;o>=0;o--){var a=n[o];if(a){if(!i&&t["Z__"+a]){for(var s=t["Z__"+a],h=0,l=s.length;h<l;h++)r(s[h].callback);return delete t["Z__"+a],this}var c=Be(t,a,i);if(c<0)return this;r(a,t["Z__"+a][c].callback),t["Z__"+a].splice(c,1)}}return this}function Be(t,e,i){if(!t||!t["Z__"+e]||!i)return-1;for(var r=t["Z__"+e],n=0,o=r.length;n<o;n++)if(r[n].src===i)return n;return-1}function ze(t){return t.preventDefault?t.preventDefault():t.returnValue=!1,this}function Ne(t){return t.stopPropagation?t.stopPropagation():t.cancelBubble=!0,this}function ke(t){return t.onselectstart=function(){return!1},t.ondragstart=function(){return!1},t.setAttribute("unselectable","on"),this}function je(t,e){return t?(re.any3d?Ye(t,e):(t.style.left=e.x+"px",t.style.top=e.y+"px"),e):null}function Ve(t){var e=window.getComputedStyle(t),i=[parseInt(e["padding-left"]),parseInt(e["padding-top"])],r=t.getBoundingClientRect(),n=t.offsetWidth,o=t.offsetHeight,a=n?r.width/n:1,s=o?r.height/o:1;return t.__position=[r.left+i[0],r.top+i[1],a,s],t.__position}function Fe(t,e){t||(t=window.event);var i=e.__position;return i||(i=Ve(e)),new se((t.clientX-i[0]-e.clientLeft)/i[2],(t.clientY-i[1]-e.clientTop)/i[3])}function Ue(t,e){var i,r,n,o=t.style.cssText;return r=";",(n=(i=o).length-r.length)>=0&&i.indexOf(r,n)===n||(o+=";"),t.style.cssText=o+e,this}function Ge(t,e){if(void 0!==t.classList)return t.classList.contains(e);var i=Ze(t);return i.length>0&&new RegExp("(^|\\s)"+e+"(\\s|$)").test(i)}function We(t,e){if(void 0===t.classList||Ge(t,e)){var i=Ze(t);Xe(t,(i?i+" ":"")+e)}else for(var r=pe(e),n=0,o=r.length;n<o;n++)t.classList.add(r[n]);return this}function Xe(t,e){return l(t.className.baseVal)?t.className=e:t.className.baseVal=e,this}function Ze(t){return l(t.className.baseVal)?t.className:t.className.baseVal}function Ye(t,e){var i=e||new se(0,0);return t.style[Re]=re.any3d?"translate3d("+i.x+"px,"+i.y+"px,0px)":"translate("+i.x+"px,"+i.y+"px)",this}function qe(t){return/<[a-z\][\s\S]*>/i.test(t)}function Je(t,e){var i=Qe(t);d(e)?i.innerHTML=e:i.appendChild(e);var r=new he(i.clientWidth,i.clientHeight);return Oe(i),r}function Qe(t){var e=document.createElement(t);return e.style.cssText="position:absolute;left:-10000px;top:-10000px;",document.body.appendChild(e),e}var Ke=He,$e=Ie,ti=Object.freeze({TRANSFORM:Re,TRANSFORMORIGIN:Ae,TRANSITION:Ce,CSSFILTER:Pe,createEl:De,createElOn:Le,removeDomNode:Oe,addDomEvent:He,removeDomEvent:Ie,listensDomEvent:Be,preventDefault:ze,stopPropagation:Ne,preventSelection:ke,offsetDom:je,computeDomPosition:Ve,getEventContainerPoint:Fe,setStyle:Ue,hasClass:Ge,addClass:We,setClass:Xe,getClass:Ze,setOpacity:function(t,e){return t.style.opacity=e,this},setTransform:Ye,setTransformMatrix:function(t,e){var i="matrix("+(d(e)?e:e.join())+")";return t.style[Re]!==i&&(t.style[Re]=i),this},removeTransform:function(t){return t.style[Re]&&(t.style[Re]=""),this},isHTML:qe,measureDom:Je,getDomRuler:Qe,on:Ke,off:$e}),ei={jsonp:function(t,e){var i="_maptalks_jsonp_"+M();t.match(/\?/)?t+="&callback="+i:t+="?callback="+i;var r=document.createElement("script");return r.type="text/javascript",r.src=t,window[i]=function(t){e(null,t),document.getElementsByTagName("head")[0].removeChild(r),r=null,delete window[i]},document.getElementsByTagName("head")[0].appendChild(r),this},get:function(t,e,i){if(f(e)){var r=i;i=e,e=r}if(w&&this.get.node)return this.get.node(t,i,e);var n=this._getClient(i);if(n.open("GET",t,!0),e){for(var o in e.headers)n.setRequestHeader(o,e.headers[o]);n.withCredentials="include"===e.credentials,e.responseType&&(n.responseType=e.responseType)}return n.send(null),n},post:function(t,e,i){var r;if(d(t)){if(f(e)){var n=i;i=e,e=n}r=(e=e||{}).postData}else{var o=i;r=e,t=(e=t).url,i=o}if(w&&this.post.node)return e.url=t,this.post.node(e,r,i);var a=this._getClient(i);if(a.open("POST",e.url,!0),e.headers||(e.headers={}),e.headers["Content-Type"]||(e.headers["Content-Type"]="application/x-www-form-urlencoded"),"setRequestHeader"in a)for(var s in e.headers)e.headers.hasOwnProperty(s)&&a.setRequestHeader(s,e.headers[s]);return d(r)||(r=JSON.stringify(r)),a.send(r),a},_wrapCallback:function(t,e){return function(){4===t.readyState&&(200===t.status?"arraybuffer"===t.responseType?0===t.response.byteLength?e(new Error("http status 200 returned without content.")):e(null,{data:t.response,cacheControl:t.getResponseHeader("Cache-Control"),expires:t.getResponseHeader("Expires"),contentType:t.getResponseHeader("Content-Type")}):e(null,t.responseText):e(new Error(t.statusText+","+t.status)))}},_getClient:function(t){var e;try{e=new XMLHttpRequest}catch(t){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}}return e.onreadystatechange=this._wrapCallback(e,t),e},getArrayBuffer:function(t,e,i){if(f(e)){var r=i;i=e,e=r}return e||(e={}),e.responseType="arraybuffer",this.get(t,e,i)},getJSON:function(t,e,i){if(f(e)){var r=i;i=e,e=r}var n=function(t,e){var r=e?A(e):null;i(t,r)};return e&&e.jsonp?this.jsonp(t,n):this.get(t,e,n)},getImage:function(t,e,i){return this.getArrayBuffer(e,i,function(e,i){if(e)t.onerror&&t.onerror(e);else if(i){var r=window.URL||window.webkitURL,n=t.onload;t.onload=function(){n&&n(),r.revokeObjectURL(t.src)};var o=new Blob([new Uint8Array(i.data)],{type:i.contentType});t.cacheControl=i.cacheControl,t.expires=i.expires,t.src=i.data.byteLength?r.createObjectURL(o):Y}})}},ii=!1,ri=null,ni={setHitTesting:function(t){ii=t},createCanvas:function(t,e,i){var r;return w?r=new i(t,e):((r=De("canvas")).width=t,r.height=e),r},prepareCanvasFont:function(t,e){t.textBaseline="top",t.font=be(e);var i=e.textFill;i||(i="#000"),t.fillStyle=ni.getRgba(i,e.textOpacity)},prepareCanvas:function(t,e,i,r){if(e){var n=e.lineWidth;l(n)||t.lineWidth===n||(t.lineWidth=n);var o=e.linePatternFile||e.lineColor||"#000";if(r)t.strokeStyle="#000";else if(si(o)&&i){var a;(e.linePatternDx||e.linePatternDy)&&(a=[e.linePatternDx,e.linePatternDy]),ni._setStrokePattern(t,o,n,a,i),e.lineDasharray=[]}else Ct(o)?e.lineGradientExtent?t.strokeStyle=ni._createGradient(t,o,e.lineGradientExtent):t.strokeStyle="#000":t.strokeStyle=o;e.lineJoin&&(t.lineJoin=e.lineJoin),e.lineCap&&(t.lineCap=e.lineCap),t.setLineDash&&N(e.lineDasharray)&&t.setLineDash(e.lineDasharray);var s=e.polygonPatternFile||e.polygonFill||"rgba(255,255,255,0)";if(r)t.fillStyle="#000";else if(si(s)&&i){var h=hi(s),c=i.getImage([h,null,null]);if(c||(c=i.getImage([h+"-texture",null,n])),b(h)&&c instanceof Image&&(re.edge||re.ie)){var u=c.width||20,p=c.height||20,d=ni.createCanvas(u,p);ni.image(d.getContext("2d"),c,0,0,u,p),c=d}c&&(t.fillStyle=t.createPattern(c,"repeat"),(e.polygonPatternDx||e.polygonPatternDy)&&(t.fillStyle.polygonPatternOffset=[e.polygonPatternDx,e.polygonPatternDy]))}else Ct(s)?e.polygonGradientExtent?t.fillStyle=ni._createGradient(t,s,e.polygonGradientExtent):t.fillStyle="rgba(255,255,255,0)":t.fillStyle=s}},_createGradient:function(t,e,i){var r=null,n=e.places,o=i.getMin(),a=i.getMax(),s=i.getWidth(),h=i.getHeight();if(e.type&&"linear"!==e.type){if("radial"===e.type){if(n){if(6!==n.length)throw new Error("A radial gradient's places should have 6 numbers.");n=[o.x+n[0]*s,o.y+n[1]*h,s*n[2],o.x+n[3]*s,o.y+n[4]*h,s*n[5]]}else{var l=i.getCenter()._round();n=[l.x,l.y,Math.abs(l.x-o.x),l.x,l.y,0]}r=t.createRadialGradient.apply(t,n)}}else{if(n){if(4!==n.length)throw new Error("A linear gradient's places should have 4 numbers.");n=[o.x+n[0]*s,o.y+n[1]*h,o.x+n[2]*s,o.y+n[3]*h]}else n=[o.x,o.y,a.x,o.y];r=t.createLinearGradient.apply(t,n)}return e.colorStops.forEach(function(t){r.addColorStop.apply(r,t)}),r},_setStrokePattern:function(t,e,i,r,n){var o,a=hi(e);if(w)o=n.getImage([a,null,i]);else{var s=a+"-texture-"+i;if(!(o=n.getImage(s))){var h=n.getImage([a,null,null]);if(h){var l;l=h.width&&h.height?Math.round(h.width*i/h.height):i;var c=ni.createCanvas(l,i,t.canvas.constructor);ni.image(c.getContext("2d"),h,0,0,l,i),n.addResource([s,null,i],c),o=c}}}o&&(t.strokeStyle=t.createPattern(o,"repeat"),t.strokeStyle.linePatternOffset=r)},clearRect:function(t,e,i,r,n){t.canvas._drawn=!1,t.clearRect(e,i,r,n)},fillCanvas:function(t,e,i,r){if(ii&&(e=1),t.canvas._drawn=!0,0!==e){var n,o=ni._isPattern(t.fillStyle),a=t.fillStyle&&t.fillStyle.polygonPatternOffset,s=a?a[0]:0,h=a?a[1]:0;l(e)&&(e=1),e<1&&(n=t.globalAlpha,t.globalAlpha*=e),o&&(i=i||0,r=r||0,t.translate(i+s,r+h)),t.fill(),o&&t.translate(-i-s,-r-h),e<1&&(t.globalAlpha=n)}},getRgba:function(t,e){return l(e)&&(e=1),"#"!==t[0]?t:(7===t.length?(i=parseInt(t.substring(1,3),16),r=parseInt(t.substring(3,5),16),n=parseInt(t.substring(5,7),16)):(i=17*parseInt(t.substring(1,2),16),r=17*parseInt(t.substring(2,3),16),n=17*parseInt(t.substring(3,4),16)),"rgba("+i+","+r+","+n+","+e+")");var i,r,n},image:function(t,e,i,r,n,o){t.canvas._drawn=!0;try{c(n)&&c(o)?t.drawImage(e,i,r,n,o):t.drawImage(e,i,r)}catch(t){console}},text:function(t,e,i,r,n){ni._textOnMultiRow(t,n.rows,r,i,n.size,n.rawSize)},_textOnMultiRow:function(t,e,i,r,n,o){for(var a,s,h=_e(n,i.textHorizontalAlignment,i.textVerticalAlignment),l=o.height+i.textLineSpacing,c=r.add(0,h.y),u=i.textMaxHeight,p=0,d=0,f=e.length;d<f&&(a=e[d].text,s=_e(e[d].size,i.textHorizontalAlignment,i.textVerticalAlignment),ni._textOnLine(t,a,c.add(s.x,d*l),i.textHaloRadius,i.textHaloFill,i.textHaloOpacity),!(u>0&&(p+=l)+o.height>=u));d++);},_textOnLine:function(t,e,i,r,n,o){ii&&(o=1);var a,s,h=0!==o&&0!==r;t.textBaseline="top";var l=t.shadowBlur,c=t.shadowOffsetX,u=t.shadowOffsetY;if(h){var p=t.globalAlpha;t.globalAlpha*=o,t.miterLimit=2,t.lineJoin="round",t.lineCap="round",t.lineWidth=2*r,t.strokeStyle=n,t.strokeText(e,Math.round(i.x),Math.round(i.y)),t.miterLimit=10,t.globalAlpha=p,a=t.globalCompositeOperation,t.globalCompositeOperation="destination-out",s=t.fillStyle,t.fillStyle="#000"}l&&h&&(t.shadowBlur=t.shadowOffsetX=t.shadowOffsetY=0),ni.fillText(t,e,i),a&&(t.globalCompositeOperation=a,ni.fillText(t,e,i,s),l&&(t.shadowBlur=l,t.shadowOffsetX=c,t.shadowOffsetY=u))},fillText:function(t,e,i,r){t.canvas._drawn=!0,r&&(t.fillStyle=r),t.fillText(e,Math.round(i.x),Math.round(i.y))},_stroke:function(t,e,i,r){if(ii&&(e=1),t.canvas._drawn=!0,0!==e){var n,o=t.strokeStyle&&t.strokeStyle.linePatternOffset,a=o?o[0]:0,s=o?o[1]:0,h=ni._isPattern(t.strokeStyle)&&(!l(i)&&!l(r)||!l(a)&&!l(s));l(e)&&(e=1),e<1&&(n=t.globalAlpha,t.globalAlpha*=e),h&&(i=i||0,r=r||0,t.translate(i+a,r+s)),t.stroke(),h&&t.translate(-i-a,-r-s),e<1&&(t.globalAlpha=n)}},_path:function(t,e,i,r,n){if(N(e))for(var o,a,s=N(i),h=!0!==n&&ni._isPattern(t.strokeStyle),l=0,c=e.length;l<c;l++)if(o=e[l],!s||t.setLineDash)t.lineTo(o.x,o.y),h&&l>0&&(u(e[l-1],o),t.beginPath(),t.moveTo(o.x,o.y));else if(s){if(l===c-1)break;a=e[l+1],oi(t,o,a,i)}function u(e,i){var n=Z(e.x,e.y,i.x,i.y);t.save();var o=Math.cos(n);Math.abs(o)<1e-7?t.translate(e.x-t.lineWidth/2,e.y):t.translate(e.x,e.y-t.lineWidth/2/o),t.rotate(n),ni._stroke(t,r),t.restore()}},path:function(t,e,i,r,n){N(e)&&(t.beginPath(),t.moveTo(e[0].x,e[0].y),ni._path(t,e,n,i),ni._stroke(t,i))},_multiClip:function(t,e){if(e&&0!==e.length)for(var i=0,r=(e=e[0]).length;i<r;i++){var n=e[i],o=n.x,a=n.y;0===i?t.moveTo(o,a):t.lineTo(o,a),i===r-1&&(o=e[0].x,a=e[0].y,t.lineTo(o,a))}},polygon:function(t,e,i,r,n,o){if(t.isMultiClip)ni._multiClip(t,e);else if(N(e)){var a=ni._isPattern(t.strokeStyle),s=N(n)&&!t.setLineDash||a&&!o;N(e[0])||(e=[e]);var h,l,c,u=t;if(e.length>1&&!w&&(ri||(ri=ni.createCanvas(1,1)),t.canvas._drawn=!1,ri.width=t.canvas.width,ri.height=t.canvas.height,li(t=ri.getContext("2d"),u)),s){for(t.save(),l=0,c=e.length;l<c;l++)N(e[l])&&(ni._ring(t,e[l],null,0,!0),h=r,l>0&&(t.globalCompositeOperation="destination-out",h=1),ni.fillCanvas(t,h,e[l][0].x,e[l][0].y),l>0?t.globalCompositeOperation="source-over":c>1&&(t.fillStyle="#fff"),ni._stroke(t,0));t.restore()}for(l=0,c=e.length;l<c;l++)N(e[l])&&(o?(ni.paintSmoothLine(t,e[l],i,o,!0),t.closePath()):ni._ring(t,e[l],n,i),s||(h=r,l>0&&(t.globalCompositeOperation="destination-out",h=1),ni.fillCanvas(t,h,e[l][0].x,e[l][0].y),l>0?t.globalCompositeOperation="source-over":c>1&&(t.fillStyle="#fff")),ni._stroke(t,i));e.length>1&&!w&&(u.drawImage(ri,0,0),u.canvas._drawn=t.canvas._drawn,li(u,t))}},_ring:function(t,e,i,r,n){var o=ni._isPattern(t.strokeStyle);n||!o||e[0].equals(e[e.length-1])||(e=e.concat([e[0]])),t.beginPath(),t.moveTo(e[0].x,e[0].y),ni._path(t,e,i,r,n),o||t.closePath()},paintSmoothLine:function(t,e,i,r,n,o,a){if(e)if(e.length<=2||!r)ni.path(t,e,i);else{var s,h=e.length,l=n?h:h-1;t.beginPath(),t.moveTo(e[0].x,e[0].y),void 0!==a&&(l-=Math.max(l-o-1,0));for(var c=0;c<l;c++){var u=e[c].x,p=e[c].y,d=void 0,f=void 0,m=void 0,g=void 0,v=void 0,y=void 0;c-1<0?n?(d=e[l-1].x,f=e[l-1].y):(d=e[c+1].x,f=e[c+1].y):(d=e[c-1].x,f=e[c-1].y),c+1<h?(m=e[c+1].x,g=e[c+1].y):(m=e[c+1-h].x,g=e[c+1-h].y),c+2<h?(v=e[c+2].x,y=e[c+2].y):n?(v=e[c+2-h].x,y=e[c+2-h].y):(v=e[c].x,y=e[c].y);var E=_(d,f,u,p,m,g,v,y,r,c===l-1?a:1);if(c===l-1&&a>=0&&a<1){t.bezierCurveTo(E[0],E[1],E[2],E[3],E[4],E[5]),e.splice(l-1,h-(l-1)-1);var x=new se(E[4],E[5]);x.prevCtrlPoint=new se(E[2],E[3]),e.push(x),h=e.length}else t.bezierCurveTo(E[0],E[1],E[2],E[3],m,g);e[c].nextCtrlPoint=E.slice(0,2),e[c].prevCtrlPoint=s?s.slice(2):null,s=E}!n&&e[1].prevCtrlPoint&&(e[0].nextCtrlPoint=e[1].prevCtrlPoint,delete e[0].prevCtrlPoint),e[h-1].prevCtrlPoint||(e[h-1].prevCtrlPoint=e[h-2].nextCtrlPoint),ni._stroke(t,i)}function _(t,e,i,r,n,o,a,s,h,l){var c=(t+i)/2,u=(e+r)/2,p=(i+n)/2,d=(r+o)/2,f=(n+a)/2,m=(o+s)/2,g=Math.sqrt((i-t)*(i-t)+(r-e)*(r-e)),v=Math.sqrt((n-i)*(n-i)+(o-r)*(o-r)),y=g/(g+v),E=v/(v+Math.sqrt((a-n)*(a-n)+(s-o)*(s-o))),x=c+(p-c)*y,_=u+(d-u)*y,w=p+(f-p)*E,b=d+(m-d)*E,S=x+(p-x)*h+i-x,T=_+(d-_)*h+r-_,M=w+(p-w)*h+n-w,R=b+(d-b)*h+o-b,A=[S,T,M,R];return l<1?function(t,e,i,r,n,o,a,s,h,l){var c=1-t,u=1-e,p=i*u*u+2*n*e*u+a*e*e,d=n*u*u+2*a*e*u+h*e*e,f=r*u*u+2*o*e*u+s*e*e,m=o*u*u+2*s*e*u+l*e*e;return[(i*c*c+2*n*t*c+a*t*t)*u+(n*c*c+2*a*t*c+h*t*t)*e,(r*c*c+2*o*t*c+s*t*t)*u+(o*c*c+2*s*t*c+l*t*t)*e,p*c+d*t,f*c+m*t,p*u+d*e,f*u+m*e]}(0,l,i,r,S,T,M,R,n,o):A}},_arcBetween:function(t,e,i,r){var n=r,o=e.distanceTo(i),a=o/2/Math.sin(n/2),s=Math.asin((i.y-e.y)/o);e.x>i.x&&(s=Math.PI-s);var h=s-(90*Math.PI/180-n/2),l=Math.cos(h)*a,c=Math.sin(h)*a,u=e.x+l,p=e.y+c,d=Math.asin((i.y-p)/a);u>i.x&&(d=Math.PI-d);var f=d+n;return t.beginPath(),t.arc(u,p,a,d,f),[u,p]},_lineTo:function(t,e){t.lineTo(e.x,e.y)},bezierCurveAndFill:function(t,e,i,r){t.beginPath();var n=e[0];t.moveTo(n.x,n.y);var o=[t];o.push.apply(o,e.splice(1)),ni._bezierCurveTo.apply(ni,o),ni.fillCanvas(t,r),ni._stroke(t,i)},_bezierCurveTo:function(t,e,i,r){t.bezierCurveTo(e.x,e.y,i.x,i.y,r.x,r.y)},ellipse:function(t,e,i,r,n,o){var a,s,h,l,c,u,p;t.beginPath(),i===r?t.arc(e.x,e.y,i,0,2*Math.PI):t.ellipse?t.ellipse(e.x,e.y,i,r,0,0,Math.PI/180*360):(a=e.x,s=e.y,u=(h=i)*(c=.5522848),p=(l=r)*c,t.moveTo(a-h,s),t.bezierCurveTo(a-h,s-p,a-u,s-l,a,s-l),t.bezierCurveTo(a+u,s-l,a+h,s-p,a+h,s),t.bezierCurveTo(a+h,s+p,a+u,s+l,a,s+l),t.bezierCurveTo(a-u,s+l,a-h,s+p,a-h,s),t.closePath()),ni.fillCanvas(t,o,e.x-i,e.y-r),ni._stroke(t,n,e.x-i,e.y-r)},rectangle:function(t,e,i,r,n){var o=e.x,a=e.y;t.beginPath(),t.rect(o,a,i.width,i.height),ni.fillCanvas(t,n,o,a),ni._stroke(t,r,o,a)},sector:function(t,e,i,r,n,o){var a=Math.PI/180,s=r[0],h=r[1];function l(t,e,i,r,s,h){var l=a*-h,c=a*-s;t.beginPath(),t.moveTo(e,i),t.arc(e,i,r,l,c),t.lineTo(e,i),ni.fillCanvas(t,o,e-r,i-r),ni._stroke(t,n,e-r,i-r)}l(t,e.x,e.y,i,s,h)},_isPattern:function(t){return!(d(t)||"addColorStop"in t)},drawCross:function(t,e,i,r,n){t.canvas._drawn=!0,t.strokeStyle=n,t.lineWidth=r,t.beginPath(),t.moveTo(e-5,i),t.lineTo(e+5,i),t.moveTo(e,i-5),t.lineTo(e,i+5),t.stroke()},copy:function(t,e){var i=e||De("canvas");return i.width=t.width,i.height=t.height,i.getContext("2d").drawImage(t,0,0),i}};function oi(t,e,i,r){var n=e.x,o=e.y,a=i.x,s=i.y,h=r,l=function(t,e){return t<=e},c=function(t,e){return t>=e},u=function(t,e){return Math.min(t,e)},p=function(t,e){return Math.max(t,e)},d={thereYet:c,cap:u},f={thereYet:c,cap:u};o-s>0&&(f.thereYet=l,f.cap=p),n-a>0&&(d.thereYet=l,d.cap=p),t.moveTo(n,o);for(var m,g,v=n,y=o,E=0,x=!0;!d.thereYet(v,a)||!f.thereYet(y,s);)m=Math.atan2(s-o,a-n),g=h[E],v=d.cap(a,v+Math.cos(m)*g),y=f.cap(s,y+Math.sin(m)*g),x?t.lineTo(v,y):t.moveTo(v,y),E=(E+1)%h.length,x=!x}var ai="data:image/";function si(t){return t.length>ai.length&&t.substring(0,ai.length)===ai||F(t)}function hi(t){return t.substring(0,ai.length)===ai?t:U(t)}function li(t,e){t.filter=e.filter,t.fillStyle=e.fillStyle,t.globalAlpha=e.globalAlpha,t.lineCap=e.lineCap,t.lineDashOffset=e.lineDashOffset,t.lineJoin=e.lineJoin,t.lineWidth=e.lineWidth,t.shadowBlur=e.shadowBlur,t.shadowColor=e.shadowColor,t.shadowOffsetX=e.shadowOffsetX,t.shadowOffsetY=e.shadowOffsetY,t.strokeStyle=e.strokeStyle}var ci="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function ui(t,e){return t(e={exports:{}},e.exports),e.exports}var pi=ui(function(t){!function(e){function i(t){if(t){var e=this;t(function(t){e.resolve(t)},function(t){e.reject(t)})}}function r(t,e){if("function"==typeof t.y)try{var i=t.y.call(a,e);t.p.resolve(i)}catch(e){t.p.reject(e)}else t.p.resolve(e)}function n(t,e){if("function"==typeof t.n)try{var i=t.n.call(a,e);t.p.resolve(i)}catch(e){t.p.reject(e)}else t.p.reject(e)}var o,a,s="fulfilled",h="undefined",l=function(){function t(){for(;i.length-r;){try{i[r]()}catch(t){e.console&&e.console.error(t)}i[r++]=a,r==n&&(i.splice(0,n),r=0)}}var i=[],r=0,n=1024,o=function(){if(typeof MutationObserver!==h){var e=document.createElement("div");return new MutationObserver(t).observe(e,{attributes:!0}),function(){e.setAttribute("a",0)}}return typeof setImmediate!==h?function(){setImmediate(t)}:function(){setTimeout(t,0)}}();return function(t){i.push(t),i.length-r==1&&o()}}();i.prototype={resolve:function(t){if(this.state===o){if(t===this)return this.reject(new TypeError("Attempt to resolve promise with self"));var e=this;if(t&&("function"==typeof t||"object"==typeof t))try{var i=!0,n=t.then;if("function"==typeof n)return void n.call(t,function(t){i&&(i=!1,e.resolve(t))},function(t){i&&(i=!1,e.reject(t))})}catch(t){return void(i&&this.reject(t))}this.state=s,this.v=t,e.c&&l(function(){for(var i=0,n=e.c.length;n>i;i++)r(e.c[i],t)})}},reject:function(t){if(this.state===o){this.state="rejected",this.v=t;var r=this.c;r?l(function(){for(var e=0,i=r.length;i>e;e++)n(r[e],t)}):!i.suppressUncaughtRejectionError&&e.console&&e.console.log("You upset Zousan. Please catch rejections: ",t,t?t.stack:null)}},then:function(t,e){var a=new i,h={y:t,n:e,p:a};if(this.state===o)this.c?this.c.push(h):this.c=[h];else{var c=this.state,u=this.v;l(function(){c===s?r(h,u):n(h,u)})}return a},catch:function(t){return this.then(null,t)},finally:function(t){return this.then(t,t)},timeout:function(t,e){e=e||"Timeout";var r=this;return new i(function(i,n){setTimeout(function(){n(Error(e))},t),r.then(function(t){i(t)},function(t){n(t)})})}},i.resolve=function(t){var e=new i;return e.resolve(t),e},i.reject=function(t){var e=new i;return e.reject(t),e},i.all=function(t){function e(e,a){e&&"function"==typeof e.then||(e=i.resolve(e)),e.then(function(e){r[a]=e,++n==t.length&&o.resolve(r)},function(t){o.reject(t)})}for(var r=[],n=0,o=new i,a=0;a<t.length;a++)e(t[a],a);return t.length||o.resolve(r),o},t.exports&&(t.exports=i),e.define&&e.define.amd&&e.define([],function(){return i}),e.Zousan=i,i.soon=l}(ci)}),di="undefined"!=typeof Promise?Promise:pi,fi=function(t){return function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.on=function(t,e,i){if(!t)return this;if(!d(t))return this._switch("on",t,e);if(!e)return this;this._eventMap||(this._eventMap={});var r,n,o=t.toLowerCase().split(" ");i||(i=this);for(var a=0,s=o.length;a<s;a++){r=o[a],(n=this._eventMap[r])||(n=[],this._eventMap[r]=n);var h=n.length;if(h>0)for(var l=0;l<h;l++)if(e===n[l].handler&&n[l].context===i)return this;n.push({handler:e,context:i})}return this},i.addEventListener=function(){return this.on.apply(this,arguments)},i.once=function(t,e,i){if(!d(t)){var r={};for(var n in t)t.hasOwnProperty(n)&&(r[n]=this._wrapOnceHandler(n,t[n],i));return this._switch("on",r)}for(var o=t.split(" "),a=0,s=o.length;a<s;a++)this.on(o[a],this._wrapOnceHandler(o[a],e,i));return this},i.off=function(t,e,i){if(!this._eventMap||!t)return this;if(!d(t))return this._switch("off",t,e);if(!e)return this;var r,n,o,a=t.split(" ");i||(i=this);for(var s=0,h=a.length;s<h;s++){if(o="Z__"+(r=a[s].toLowerCase()),!(n=this._eventMap[r]))return this;for(var l=n.length-1;l>=0;l--){var c=n[l];e!==c.handler&&e!==c.handler[o]||c.context!==i||(delete c.handler[o],n.splice(l,1))}n.length||delete this._eventMap[r]}return this},i.removeEventListener=function(){return this.off.apply(this,arguments)},i.listens=function(t,e,i){if(!this._eventMap||!d(t))return 0;var r=this._eventMap[t.toLowerCase()];if(!r||!r.length)return 0;if(!e)return r.length;for(var n=0,o=r.length;n<o;n++)if(e===r[n].handler&&(l(i)||r[n].context===i))return 1;return 0},i.getListeningEvents=function(){return this._eventMap?Object.keys(this._eventMap):[]},i.copyEventListeners=function(t){var e,i=t._eventMap;if(!i)return this;for(var r in i)for(var n=0,o=(e=i[r]).length;n<o;n++)this.on(r,e[n].handler,e[n].context);return this},i.fire=function(){return this._eventParent?this._eventParent.fire.apply(this._eventParent,arguments):this._fire.apply(this,arguments)},i._wrapOnceHandler=function(t,e,i){var r=this,n="Z__"+t,o=!1,a=function s(){o||(delete a[n],o=!0,i?e.apply(i,arguments):e.apply(this,arguments),r.off(t,s,this))};return a[n]=e,a},i._switch=function(t,e,i){for(var r in e)e.hasOwnProperty(r)&&this[t](r,e[r],i);return this},i._clearListeners=function(t){this._eventMap&&d(t)&&(this._eventMap[t.toLowerCase()]&&(this._eventMap[t]=null))},i._clearAllListeners=function(){this._eventMap=null},i._setEventParent=function(t){return this._eventParent=t,this},i._fire=function(t,e){if(!this._eventMap)return this;var i=this._eventMap[t.toLowerCase()];if(!i)return this;e||(e={}),e.type=t,e.target=this;for(var r,n,o=i.slice(0),a=0,s=o.length;a<s;a++)o[a]&&(r=o[a].context,!0,n=h({},e),!1===(r?o[a].handler.call(r,n):o[a].handler(n))&&e.domEvent&&Ne(e.domEvent));return this},e}(t)},mi=fi(function(){function t(t){this.target=t}var e=t.prototype;return e.enable=function(){return this._enabled?this:(this._enabled=!0,this.addHooks(),this)},e.disable=function(){return this._enabled?(this._enabled=!1,this.removeHooks(),this):this},e.enabled=function(){return!!this._enabled},e.remove=function(){this.disable(),delete this.target,delete this.dom},t}()),gi=function(){function t(t){if(!this||!this.setOptions)throw new Error('Class instance is being created without "new" operator.');this.setOptions(t),this.callInitHooks()}var e=t.prototype;return e.callInitHooks=function(){var t=Object.getPrototypeOf(this);return this._visitInitHooks(t),this},e.setOptions=function(t){if(this.hasOwnProperty("options")||(this.options=this.options?Object.create(this.options):{}),!t)return this;for(var e in t)this.options[e]=t[e];return this},e.config=function(t){if(!t){var e={};for(var i in this.options)this.options.hasOwnProperty(i)&&(e[i]=this.options[i]);return e}if(2===arguments.length){var r={};r[t]=arguments[1],t=r}for(var n in t)this.options[n]=t[n],this[n]&&this[n]instanceof mi&&(t[n]?this[n].enable():this[n].disable());return this.onConfig(t),this},e.onConfig=function(){},e._visitInitHooks=function(t){if(!this._initHooksCalled){var e=Object.getPrototypeOf(t);e._visitInitHooks&&e._visitInitHooks.call(this,e),this._initHooksCalled=!0;var i=t._initHooks;if(i&&i!==e._initHooks)for(var r=0;r<i.length;r++)i[r].call(this)}},t.addInitHook=function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];var n="function"==typeof t?t:function(){this[t].apply(this,i)},o=this.prototype,a=Object.getPrototypeOf(o);return o._initHooks&&o._initHooks!==a._initHooks||(o._initHooks=[]),o._initHooks.push(n),this},t.include=function(){for(var t=0;t<arguments.length;t++)h(this.prototype,t<0||arguments.length<=t?void 0:arguments[t]);return this},t.mergeOptions=function(t){var e=this.prototype,i=Object.getPrototypeOf(e);return e.options&&e.options!==i.options||(e.options=e.options?Object.create(e.options):{}),h(e.options,t),this},t}(),vi={},yi=function(t){return function(t){function e(){return t.apply(this,arguments)||this}return ne(e,t),e.registerJSONType=function(t){return t?(vi[t]=this,this):this},e.getJSONClass=function(t){return t?vi[t]:null},e.prototype.getJSONType=function(){if(void 0===this._jsonType){var t=Object.getPrototypeOf(this).constructor;for(var e in vi)if(vi[e]===t){this._jsonType=e;break}}if(!this._jsonType)throw new Error("Found an unregistered geometry class!");return this._jsonType},e}(t)};function Ei(t){return function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.addHandler=function(t,e){if(!e)return this;if(this._handlers||(this._handlers=[]),this[t])return this[t].enable(),this;var i=this[t]=new e(this);return this._handlers.push(i),this.options[t]&&i.enable(),this},i.removeHandler=function(t){if(!t)return this;var e=this[t];if(e){var i=this._handlers.indexOf(e);i>=0&&this._handlers.splice(i,1),this[t].remove(),delete this[t]}return this},i._clearHandlers=function(){for(var t=0,e=this._handlers.length;t<e;t++)this._handlers[t].remove();this._handlers=[]},e}(t)}var xi={mousedown:"mousemove",touchstart:"touchmove",pointerdown:"touchmove",MSPointerDown:"touchmove"},_i={mousedown:"mouseup",touchstart:"touchend",pointerdown:"touchend",MSPointerDown:"touchend"},wi=function(t){function e(e,i){var r;return void 0===i&&(i={}),(r=t.call(this,null)||this).dom=e,r.options=i,r}ne(e,t);var i=e.prototype;return i.enable=function(){return this.dom?(this._onMouseDown=function(t){return this.onMouseDown(t)},Ke(this.dom,"touchstart mousedown",this._onMouseDown,this),this):this},i.disable=function(){return this.dom?(this._offEvents(),$e(this.dom,"touchstart mousedown",this._onMouseDown),delete this._onMouseDown,this):this},i.onMouseDown=function(t){if((this.options.rightclick||2!==t.button)&&!(t.touches&&t.touches.length>1||this.options.cancelOn&&!0===this.options.cancelOn(t))){var e=this.dom;e.setCapture?e.setCapture():window.captureEvents&&window.captureEvents(window.Event.MOUSEMOVE|window.Event.MOUSEUP),e.ondragstart=function(){return!1},delete this.moved;var i=t.touches?t.touches[0]:t;this.startPos=new se(i.clientX,i.clientY),Ke(document,xi[t.type],this.onMouseMove,this),Ke(document,_i[t.type],this.onMouseUp,this),this.options.ignoreMouseleave||Ke(this.dom,"mouseleave",this.onMouseUp,this),this.fire("mousedown",{domEvent:t,mousePos:new se(i.clientX,i.clientY)})}},i.onMouseMove=function(t){if(t.touches&&t.touches.length>1)this.moved&&(this.interupted=!0,this.onMouseUp(t));else{var e=t.touches?t.touches[0]:t,i=new se(e.clientX,e.clientY).sub(this.startPos);(i.x||i.y)&&(this.moved?this.fire("dragging",{domEvent:t,mousePos:new se(e.clientX,e.clientY)}):(this.fire("dragstart",{domEvent:t,mousePos:this.startPos.copy()}),this.moved=!0))}},i.onMouseUp=function(t){var e=t.changedTouches?t.changedTouches[0]:t;this._offEvents();var i={domEvent:t};c(e.clientX)&&(i.mousePos=new se(parseInt(e.clientX,0),parseInt(e.clientY,0))),this.moved&&(i.interupted=this.interupted,this.fire("dragend",i),delete this.interupted,delete this.moved),this.fire("mouseup",i)},i._offEvents=function(){var t=this.dom;if($e(t,"mouseleave",this.onMouseUp,this),"undefined"!=typeof document&&"undefined"!=typeof window){for(var e in xi)$e(document,xi[e],this.onMouseMove,this),$e(document,_i[e],this.onMouseUp,this);t.releaseCapture?t.releaseCapture():window.captureEvents&&window.captureEvents(window.Event.MOUSEMOVE|window.Event.MOUSEUP)}},e}(mi),bi=function(t){function e(){return t.apply(this,arguments)||this}return ne(e,t),e.toNumberArrays=function(t){return Array.isArray(t)?D(t,function(t){return[t.x,t.y]}):[t.x,t.y]},e.toCoordinates=function(t){if(c(t[0])&&c(t[1]))return new e(t);for(var i=[],r=0,n=t.length;r<n;r++){var o=t[r];Array.isArray(o)?c(o[0])?i.push(new e(o)):i.push(e.toCoordinates(o)):i.push(new e(o))}return i},e}(ae),Si=function(){function t(t,e){this.type=t,this.properties=e}return t.createProj4=function(e){return new t("proj4",{proj:e})},t.fromProjectionCode=function(e){return e&&t[e=e.toUpperCase().replace(":","")]||null},t}();Si.WGS84=Si.createProj4("+proj=longlat +datum=WGS84 +no_defs"),Si.EPSG4326=Si.WGS84,Si.EPSG3857=Si.createProj4("+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +wktext  +no_defs"),Si.IDENTITY=Si.createProj4("+proj=identity +no_defs"),Si.CGCS2000=Si.createProj4("+proj=longlat +datum=CGCS2000"),Si.EPSG4490=Si.CGCS2000,Si.BD09LL=Si.createProj4("+proj=longlat +datum=BD09"),Si.GCJ02=Si.createProj4("+proj=longlat +datum=GCJ02");var Ti,Mi=new se(0,0),Ri=new bi(0,0),Ai=new bi(0,0),Ci=new bi(0,0),Pi=new bi(0,0),Di=new bi(0,0),Li=new bi(0,0),Oi=new bi(0,0),Hi=new bi(0,0),Ii=[],Bi=[],zi=function(){function t(t,e,i,r){this._clazz=bi;var n=arguments.length,o=n>0?arguments[n-1]:null;o&&o.unproject&&(this.projection=arguments[n-1]),this._dirty=!0,this._initialize(t,e,i,r)}var e=t.prototype;return e._initialize=function(t,e,i,r){if(this.xmin=null,this.xmax=null,this.ymin=null,this.ymax=null,!l(t)){var n=this.projection;c(t)&&c(e)&&c(i)&&c(r)?n?this.set(t,e,i,r):this.set(Math.min(t,i),Math.min(e,r),Math.max(t,i),Math.max(e,r)):Array.isArray(t)?n?this.set(t[0],t[1],t[2],t[3]):this.set(Math.min(t[0],t[2]),Math.min(t[1],t[3]),Math.max(t[0],t[2]),Math.max(t[1],t[3])):c(t.x)&&c(e.x)&&c(t.y)&&c(e.y)?n?this.set(t.x,t.y,e.x,e.y):(t.x>e.x?(this.xmin=e.x,this.xmax=t.x):(this.xmin=t.x,this.xmax=e.x),t.y>e.y?(this.ymin=e.y,this.ymax=t.y):(this.ymin=t.y,this.ymax=e.y)):c(t.xmin)&&c(t.xmax)&&c(t.ymin)&&c(t.ymax)&&this.set(t.xmin,t.ymin,t.xmax,t.ymax)}},e._add=function(t){return this._dirty=!0,l(t.x)?l(t.xmin)?l(t[0])||(this.xmin+=t[0],this.ymin+=t[1],this.xmax+=t[0],this.ymax+=t[1]):(this.xmin+=t.xmin,this.ymin+=t.ymin,this.xmax+=t.xmax,this.ymax+=t.ymax):(this.xmin+=t.x,this.ymin+=t.y,this.xmax+=t.x,this.ymax+=t.y),this},e.add=function(){var t=new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection);return t._add.apply(t,arguments)},e._scale=function(t){return this._dirty=!0,this.xmin*=t,this.ymin*=t,this.xmax*=t,this.ymax*=t,this},e._sub=function(t){return this._dirty=!0,l(t.x)?l(t.xmin)?l(t[0])||(this.xmin-=t[0],this.ymin-=t[1],this.xmax-=t[0],this.ymax-=t[1]):(this.xmin-=t.xmin,this.ymin-=t.ymin,this.xmax-=t.xmax,this.ymax-=t.ymax):(this.xmin-=t.x,this.ymin-=t.y,this.xmax-=t.x,this.ymax-=t.y),this},e._substract=function(){return this._sub.apply(this,arguments)},e.sub=function(){var t=new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection);return t._sub.apply(t,arguments)},e.substract=function(){return this.sub.apply(this,arguments)},e.round=function(){return new this.constructor(Math.round(this.xmin),Math.round(this.ymin),Math.round(this.xmax),Math.round(this.ymax),this.projection)},e._round=function(){return this._dirty=!0,this.xmin=Math.round(this.xmin),this.ymin=Math.round(this.ymin),this.xmax=Math.round(this.xmax),this.ymax=Math.round(this.ymax),this},e.getMin=function(t){return t?(t.set(this.xmin,this.ymin),t):new this._clazz(this.xmin,this.ymin)},e.getMax=function(t){return t?(t.set(this.xmax,this.ymax),t):new this._clazz(this.xmax,this.ymax)},e.getCenter=function(t){var e=(this.xmin+this.xmax)/2,i=(this.ymin+this.ymax)/2;return t?(t.set(e,i),t):new this._clazz(e,i)},e.isValid=function(){return!(l(this.xmin)||l(this.ymin)||l(this.xmax)||l(this.ymax))},e.equals=function(t){return this.xmin===t.xmin&&this.xmax===t.xmax&&this.ymin===t.ymin&&this.ymax===t.ymax},e.intersects=function(t){this._project(this),this._project(t);var e=Math.max(this.pxmin,t.pxmin),i=Math.max(this.pymin,t.pymin),r=Math.min(this.pxmax,t.pxmax),n=Math.min(this.pymax,t.pymax),o=!(e>r||i>n);return o},e.within=function(t){return this._project(this),this._project(t),this.pxmin>=t.pxmin&&this.pxmax<=t.pxmax&&this.pymin>=t.pymin&&this.pymax<=t.pymax},e.contains=function(t){if(!t)return!1;this._project(this);var e=this.projection;if(e)if(void 0!==t.x){var i=Ri;Array.isArray(t)?(i.x=t[0],i.y=t[1]):(i.x=t.x,i.y=t.y),t=e.project(i,i)}else void 0!==t.xmin&&this._project(t);return(t.x||t.pxmin||0)>=this.pxmin&&(t.x||t.pxmax||0)<=this.pxmax&&(t.y||t.pymin||0)>=this.pymin&&(t.y||t.pymax||0)<=this.pymax},e.getWidth=function(){return Math.abs(this.xmax-this.xmin)},e.getHeight=function(){return Math.abs(this.ymax-this.ymin)},e.getSize=function(){return new he(this.getWidth(),this.getHeight())},e.set=function(t,e,i,r){return this.xmin=t,this.ymin=e,this.xmax=i,this.ymax=r,this},e.__combine=function(t){var e,i,r,n;void 0!==t.x&&(Ti.xmin=Ti.xmax=t.x,Ti.ymin=Ti.ymax=t.y,t=Ti),this._project(t),this._project(this),c(this.pxmin)?(e=Math.min(this.pxmin,t.pxmin),i=Math.min(this.pymin,t.pymin),r=Math.max(this.pxmax,t.pxmax),n=Math.max(this.pymax,t.pymax)):(e=t.pxmin,i=t.pymin,r=t.pxmax,n=t.pymax);var o=this.projection;if(o){Ai.set(e,i),Ci.set(r,n);var a=o.unproject(Ai,Ai),s=o.unproject(Ci,Ci);e=a.x,i=a.y,r=s.x,n=s.y}return Bi[0]=e,Bi[1]=i,Bi[2]=r,Bi[3]=n,Bi},e._combine=function(t){if(!t||t.isValid&&!t.isValid())return this;var e=this.__combine(t);return this.set(e[0],e[1],e[2],e[3]),this._dirty=!0,this},e.combine=function(t){if(!t||t.isValid&&!t.isValid())return this;var e=this.__combine(t);return new this.constructor(e[0],e[1],e[2],e[3],this.projection)},e.intersection=function(t){if(!this.intersects(t))return null;Pi.x=Math.max(this.pxmin,t.pxmin),Pi.y=Math.max(this.pymin,t.pymin),Di.x=Math.min(this.pxmax,t.pxmax),Di.y=Math.min(this.pymax,t.pymax);var e=Pi,i=Di,r=this.projection;return r&&(e=r.unproject(e,e),i=r.unproject(i,i)),new this.constructor(e,i,r)},e.expand=function(t){var e,i;return c(t)?e=i=t:(e=t.width||t.x||t[0]||0,i=t.height||t.y||t[1]||0),new this.constructor(this.xmin-e,this.ymin-i,this.xmax+e,this.ymax+i,this.projection)},e._expand=function(t){var e,i;return c(t)?e=i=t:(e=t.width||t.x||t[0]||0,i=t.height||t.y||t[1]||0),this.xmin-=e,this.ymin-=i,this.xmax+=e,this.ymax+=i,this._dirty=!0,this},e.toJSON=function(){return{xmin:this.xmin,ymin:this.ymin,xmax:this.xmax,ymax:this.ymax}},e.toArray=function(){var t=this.xmin,e=this.ymin,i=this.xmax,r=this.ymax;return[new this._clazz([t,r]),new this._clazz([i,r]),new this._clazz([i,e]),new this._clazz([t,e]),new this._clazz([t,r])]},e.toString=function(){return this.xmin+","+this.ymin+","+this.xmax+","+this.ymax},e.copy=function(){return new this.constructor(this.xmin,this.ymin,this.xmax,this.ymax,this.projection)},e.convertTo=function(t,e){if(!this.isValid())return null;var i,r=e||new this.constructor;return e&&(r.xmin=r.ymin=r.xmax=r.ymax=0),this._clazz===bi?i=Li:this._clazz===se&&(i=Mi),i.x=this.xmin,i.y=this.ymax,r._combine(t(i)),i.x=this.xmax,r._combine(t(i)),i.y=this.ymin,r._combine(t(i)),i.x=this.xmin,r._combine(t(i)),r},e._project=function(t){if(t&&t.isValid()){var e=this.projection;if(e){if(t._dirty){Oi.set(t.xmax,t.ymin),Hi.set(t.xmin,t.ymax),Ii[0]=Oi,Ii[1]=Hi;var i=e.projectCoords(Ii),r=i[0],n=i[1];t.pxmin=Math.min(r.x,n.x),t.pymin=Math.min(r.y,n.y),t.pxmax=Math.max(r.x,n.x),t.pymax=Math.max(r.y,n.y)}delete t._dirty}else t.pxmin=t.xmin,t.pxmax=t.xmax,t.pymin=t.ymin,t.pymax=t.ymax}},t}();Ti=new zi(0,0,0,0);var Ni,ki=function(t){function e(e,i,r,n){var o;return(o=t.call(this,e,i,r,n)||this)._clazz=se,o}return ne(e,t),e}(zi),ji=function(){function t(t){this.matrix=t}var e=t.prototype;return e.transform=function(t,e,i){var r=this.matrix[0]*(t.x-this.matrix[2])/e,n=this.matrix[1]*(t.y-this.matrix[3])/e;return i?(i.x=r,i.y=n,i):new se(r,n)},e.untransform=function(t,e,i){var r=t.x*e/this.matrix[0]+this.matrix[2],n=t.y*e/this.matrix[1]+this.matrix[3];return i?(i.x=r,i.y=n,i):new bi(r,n)},t}(),Vi={project:function(){},unproject:function(){},projectCoords:function(t){var e=this;if(!t)return[];if(!Array.isArray(t))return this.project(t);if(0===t.length)return[];if(!this.isSphere())return D(t,this.project,this);if(Array.isArray(t[0]))return t.map(function(t){return e.projectCoords(t)});for(var i,r,n,o,a,s,h=this.getCircum(),l=this.getSphereExtent(),c=l.sx,u=l.sy,p=t[0],d=[this.project(p)],f=1,m=t.length;f<m;f++)o=(n=t[f]).x-p.x,a=n.y-p.y,s=this.project(n),Math.abs(o)>180&&(void 0===i&&(i=n.x>p.x),i&&(s._add(-h.x*O(o)*c,0),n._add(-360*O(o),0))),Math.abs(a)>90&&(void 0===r&&(r=n.y<p.y),r&&(s._add(0,-h.y*O(a)*u),n._add(0,-180*O(a)))),p=n,d.push(s);return d},unprojectCoords:function(t){return t?Array.isArray(t)?D(t,this.unproject,this):this.unproject(t):[]},isSphere:function(){return!!this.sphere},isOutSphere:function(t){return!!this.isSphere()&&!this.getSphereExtent().contains(t)},wrapCoord:function(t){if(!this.isSphere())return t;var e=this.getSphereExtent(),i=new bi(t);return e.contains(i)||(i.x=B(t.x,e.xmin,e.xmax),i.y=B(t.y,e.ymin,e.ymax)),i},getCircum:function(){if(!this.circum&&this.isSphere()){var t=this.getSphereExtent();this.circum={x:t.getWidth(),y:t.getHeight()}}return this.circum},getSphereExtent:function(){if(!this.extent&&this.isSphere()){var t=this.project(new bi(180,90)),e=this.project(new bi(-180,-90));this.extent=new zi(e,t,this),this.extent.sx=t.x>e.x?1:-1,this.extent.sy=t.y>e.y?1:-1}return this.extent}},Fi={measureLength:function(t,e){if(!Array.isArray(t))return this.measureLenBetween(t,e);for(var i=0,r=0,n=t.length;r<n-1;r++)i+=this.measureLenBetween(t[r],t[r+1]);return i}},Ui=h({measure:"IDENTITY",measureLenBetween:function(t,e){if(!t||!e)return 0;try{return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}catch(t){return 0}},measureArea:function(t){if(!Array.isArray(t))return 0;for(var e=0,i=0,r=t.length;i<r;i++){var n=t[i],o=null;o=i===r-1?t[0]:t[i+1],e+=n.x*o.y-n.y*o.x}return Math.abs(e/2)},locate:function(t,e,i){return t=new bi(t.x,t.y),this._locate(t,e,i)},_locate:function(t,e,i){return t?(e||(e=0),i||(i=0),e||i?(t.x=t.x+e,t.y=t.y+i,t):t):null},rotate:function(t,e,i){return t=new bi(t.x,t.y),this._rotate(t,e,i)},_rotate:(Ni=new se(0,0),function(t,e,i){return Ni.x=t.x-e.x,Ni.y=t.y-e.y,Ni._rotate(i*Math.PI/180),t.x=e.x+Ni.x,t.y=e.y+Ni.y,t})},Fi),Gi=function(){function t(t){this.radius=t}var e=t.prototype;return e.measureLenBetween=function(t,e){if(!t||!e)return 0;var i=y(t.y),r=y(e.y),n=i-r,o=y(t.x)-y(e.x);return i=2*Math.asin(Math.sqrt(Math.pow(Math.sin(n/2),2)+Math.cos(i)*Math.cos(r)*Math.pow(Math.sin(o/2),2))),i*=this.radius,Math.round(1e5*i)/1e5},e.measureArea=function(t){var e,i=y(this.radius),r=0,n=t,o=n.length;if(o<3)return 0;for(e=0;e<o-1;e++){var a=n[e],s=n[e+1];r+=a.x*i*Math.cos(y(a.y))*s.y*i-s.x*i*Math.cos(y(s.y))*a.y*i}return o=n[e],n=n[0],r+=o.x*i*Math.cos(y(o.y))*n.y*i-n.x*i*Math.cos(y(n.y))*o.y*i,.5*Math.abs(r)},e.locate=function(t,e,i){return t=new bi(t.x,t.y),this._locate(t,e,i)},e._locate=function(t,e,i){if(!t)return null;if(e||(e=0),i||(i=0),!e&&!i)return t;var r,n,o=y(t.y);if(0!==i){var a=Math.abs(i);n=B(180*(o+=2*Math.sin(a/(2*this.radius))*(i>0?1:-1))/Math.PI,-90,90)}else n=t.y;if(0!==e){var s=Math.abs(e),h=y(t.x);r=B(180*(h+=2*Math.sqrt(Math.pow(Math.sin(s/(2*this.radius)),2)/Math.pow(Math.cos(o),2))*(e>0?1:-1))/Math.PI,-180,180)}else r=t.x;return t.x=r,t.y=n,t},e.rotate=function(t,e,i){return t=new bi(t),this._rotate(t,e,i)},e._rotate=function(t,e,i){var r=function(t,e,i){void 0===i&&(i={});var r;r=i.final?Wi(e,t):Wi(t,e);return r>180?-(360-r):r}(e,t)-i,n=this.measureLenBetween(e,t);return t.x=e.x,t.y=e.y,function(t,e,i,r){var n=e/r,o=t.x*Math.PI/180,a=y(t.y),s=y(i),h=n*Math.cos(s),l=a+h;Math.abs(l)>Math.PI/2&&(l=l>0?Math.PI-l:-Math.PI-l);var c=Math.log(Math.tan(l/2+Math.PI/4)/Math.tan(a/2+Math.PI/4)),u=Math.abs(c)>1e-11?h/c:Math.cos(a),p=n*Math.sin(s)/u,d=o+p;return t.x=(180*d/Math.PI+540)%360-180,t.y=180*l/Math.PI,t}(t,n,r,this.radius)},t}();function Wi(t,e){var i=y(t.y),r=y(e.y),n=y(e.x-t.x);n>Math.PI&&(n-=2*Math.PI),n<-Math.PI&&(n+=2*Math.PI);var o=Math.log(Math.tan(r/2+Math.PI/4)/Math.tan(i/2+Math.PI/4));return(E(Math.atan2(n,o))+360)%360}var Xi=h({measure:"EPSG:4326",sphere:new Gi(6378137),measureLenBetween:function(){return this.sphere.measureLenBetween.apply(this.sphere,arguments)},measureArea:function(){return this.sphere.measureArea.apply(this.sphere,arguments)},_locate:function(){return this.sphere._locate.apply(this.sphere,arguments)},locate:function(){return this.sphere.locate.apply(this.sphere,arguments)},_rotate:function(){return this.sphere._rotate.apply(this.sphere,arguments)},rotate:function(){return this.sphere.rotate.apply(this.sphere,arguments)}},Fi),Zi=h({measure:"BAIDU",sphere:new Gi(6370996.81),measureLenBetween:function(){return this.sphere.measureLenBetween.apply(this.sphere,arguments)},measureArea:function(){return this.sphere.measureArea.apply(this.sphere,arguments)},_locate:function(){return this.sphere._locate.apply(this.sphere,arguments)},locate:function(){return this.sphere.locate.apply(this.sphere,arguments)},_rotate:function(){return this.sphere._rotate.apply(this.sphere,arguments)},rotate:function(){return this.sphere.rotate.apply(this.sphere,arguments)}},Fi),Yi=Xi,qi={};function Ji(t){qi[t.measure]=t}Ji(Ui),Ji(Xi),Ji(Zi);var Qi={getInstance:function(t){if(!t)return Yi;for(var e in qi)if(g(qi,e)){var i=qi[e].measure;if(!i)continue;if(t.toLowerCase()===i.toLowerCase())return qi[e]}return null}},Ki=Object.freeze({Identity:Ui,DEFAULT:Yi,Measurer:Qi,WGS84Sphere:Xi,BaiduSphere:Zi}),$i=h({},Vi,{code:"EPSG:3857",rad:Math.PI/180,metersPerDegree:6378137*Math.PI/180,maxLatitude:85.0511287798,project:function(t,e){var i=this.rad,r=this.metersPerDegree,n=this.maxLatitude,o=t.x,a=Math.max(Math.min(n,t.y),-n),s=o*r,h=(0===a?0:Math.log(Math.tan((90+a)*i/2))/i)*r;return e?(e.x=s,e.y=h,e):new bi(s,h)},unproject:function(t,e){var i,r=this.rad,n=this.metersPerDegree,o=t.x/n,a=t.y;0===a?i=0:(i=a/n,i=(2*Math.atan(Math.exp(i*r))-Math.PI/2)/r),Math.abs(Math.abs(o)-180)<1e-7&&(o=180*O(o)),Math.abs(Math.abs(i)-this.maxLatitude)<1e-7&&(i=O(i)*this.maxLatitude);var s=B(o,-180,180),h=B(i,-this.maxLatitude,this.maxLatitude);return e?(e.x=s,e.y=h,e):new bi(s,h)}},Xi),tr=h({},Vi,{code:"EPSG:4326",project:function(t,e){return e?(e.x=t.x,e.y=t.y,e):new bi(t)},unproject:function(t,e){return e?(e.x=t.x,e.y=t.y,e):new bi(t)}},Xi),er=h({},tr,{code:"EPSG:4490"}),ir=h({},Vi,{code:"BAIDU",project:function(t,e){return this.convertLL2MC(t,e)},unproject:function(t,e){return this.convertMC2LL(t,e)}},Zi,{EARTHRADIUS:6370996.81,MCBAND:[12890594.86,8362377.87,5591021,3481989.83,1678043.12,0],LLBAND:[75,60,45,30,15,0],MC2LL:[[1.410526172116255e-8,898305509648872e-20,-1.9939833816331,200.9824383106796,-187.2403703815547,91.6087516669843,-23.38765649603339,2.57121317296198,-.03801003308653,17337981.2],[-7.435856389565537e-9,8983055097726239e-21,-.78625201886289,96.32687599759846,-1.85204757529826,-59.36935905485877,47.40033549296737,-16.50741931063887,2.28786674699375,10260144.86],[-3.030883460898826e-8,898305509983578e-20,.30071316287616,59.74293618442277,7.357984074871,-25.38371002664745,13.45380521110908,-3.29883767235584,.32710905363475,6856817.37],[-1.981981304930552e-8,8983055099779535e-21,.03278182852591,40.31678527705744,.65659298677277,-4.44255534477492,.85341911805263,.12923347998204,-.04625736007561,4482777.06],[3.09191371068437e-9,8983055096812155e-21,6995724062e-14,23.10934304144901,-.00023663490511,-.6321817810242,-.00663494467273,.03430082397953,-.00466043876332,2555164.4],[2.890871144776878e-9,8983055095805407e-21,-3.068298e-8,7.47137025468032,-353937994e-14,-.02145144861037,-1234426596e-14,.00010322952773,-323890364e-14,826088.5]],LL2MC:[[-.0015702102444,111320.7020616939,0x60e374c3105a3,-0x24bb4115e2e164,0x5cc55543bb0ae8,-0x7ce070193f3784,0x5e7ca61ddf8150,-0x261a578d8b24d0,0x665d60f3742ca,82.5],[.0008277824516172526,111320.7020463578,647795574.6671607,-4082003173.641316,10774905663.51142,-15171875531.51559,12053065338.62167,-5124939663.577472,913311935.9512032,67.5],[.00337398766765,111320.7020202162,4481351.045890365,-23393751.19931662,79682215.47186455,-115964993.2797253,97236711.15602145,-43661946.33752821,8477230.501135234,52.5],[.00220636496208,111320.7020209128,51751.86112841131,3796837.749470245,992013.7397791013,-1221952.21711287,1340652.697009075,-620943.6990984312,144416.9293806241,37.5],[-.0003441963504368392,111320.7020576856,278.2353980772752,2485758.690035394,6070.750963243378,54821.18345352118,9540.606633304236,-2710.55326746645,1405.483844121726,22.5],[-.0003218135878613132,111320.7020701615,.00369383431289,823725.6402795718,.46104986909093,2351.343141331292,1.58060784298199,8.77738589078284,.37238884252424,7.45]],convertMC2LL:function(t,e){for(var i,r=0,n=this.MCBAND.length;r<n;r++)if(Math.abs(t.y)>=this.MCBAND[r]){i=this.MC2LL[r];break}return this.convertor(t,i,e)},convertLL2MC:function(t,e){var i,r,n;t.x=this.getLoop(t.x,-180,180),t.y=this.getRange(t.y,-74,74);var o=new bi(t.x,t.y);for(r=0,n=this.LLBAND.length;r<n;r++)if(o.y>=this.LLBAND[r]){i=this.LL2MC[r];break}if(!i)for(r=this.LLBAND.length-1;r>=0;r--)if(o.y<=-this.LLBAND[r]){i=this.LL2MC[r];break}return this.convertor(t,i,e)},convertor:function(t,e,i){if(!t||!e)return null;var r=e[0]+e[1]*Math.abs(t.x),n=Math.abs(t.y)/e[9],o=e[2]+e[3]*n+e[4]*n*n+e[5]*n*n*n+e[6]*n*n*n*n+e[7]*n*n*n*n*n+e[8]*n*n*n*n*n*n;return r*=t.x<0?-1:1,o*=t.y<0?-1:1,i?(i.x=r,i.y=o,i):new bi(r,o)},toRadians:function(t){return Math.PI*t/180},toDegrees:function(t){return 180*t/Math.PI},getRange:function(t,e,i){return null!=e&&(t=Math.max(t,e)),null!=i&&(t=Math.min(t,i)),t},getLoop:function(t,e,i){if(t===1/0)return i;if(t===-1/0)return e;for(;t>i;)t-=i-e;for(;t<e;)t+=i-e;return t}}),rr=h({},Vi,{code:"IDENTITY",project:function(t,e){return e?(e.x=t.x,e.y=t.y,e):t.copy()},unproject:function(t,e){return e?(e.x=t.x,e.y=t.y,e):t.copy()}},Ui),nr=$i,or=Object.freeze({EPSG3857:$i,DEFAULT:nr,EPSG4326:tr,EPSG4490:er,BAIDU:ir,IDENTITY:rr,Common:Vi}),ar=function(t){return function(t){function e(){return t.apply(this,arguments)||this}return ne(e,t),e.registerRenderer=function(t,e){var i=this.prototype,r=Object.getPrototypeOf(i);return i._rendererClasses&&i._rendererClasses!==r._rendererClasses||(i._rendererClasses=i._rendererClasses?Object.create(i._rendererClasses):{}),i._rendererClasses[t.toLowerCase()]=e,this},e.getRendererClass=function(t){var e=this.prototype;return e._rendererClasses?e._rendererClasses[t.toLowerCase()]:null},e}(t)},sr=function(t){function e(e){var i;return(i=t.call(this)||this).layer=e,i._painted=!1,i._drawTime=0,i.setToRedraw(),i}ne(e,t);var i=e.prototype;return i.render=function(t){var e=this;if(this.prepareRender(),this.getMap()&&this.layer.isVisible())if(this.resources||(this.resources=new hr),this.checkResources){var i=this.checkResources();i.length>0?(this._loadingResource=!0,this.loadResources(i).then(function(){e._loadingResource=!1,e.layer&&(e.layer.fire("resourceload"),e.setToRedraw())})):this._tryToDraw(t)}else this._tryToDraw(t)},i.testIfNeedRedraw=function(){var t=this.getMap();return!this._loadingResource&&(!!this._toRedraw||!(t.isInteracting()&&!this.drawOnInteracting)&&!!this.needToRedraw())},i.needToRedraw=function(){var t=this.getMap();return!!t.isInteracting()&&!(!t.getPitch()&&t.isMoving()&&!t.isZooming()&&!t.isRotating()&&!this.layer.options.forceRenderOnMoving)},i.onSkipDrawOnInteracting=function(){},i.isLoadingResource=function(){return this._loadingResource},i.isRenderComplete=function(){return!!this._renderComplete},i.mustRenderOnInteracting=function(){return!this._painted||this.checkResources&&this.checkResources().length>0},i.setToRedraw=function(){return this._toRedraw=!0,this},i.setCanvasUpdated=function(){return this._canvasUpdated=!0,this},i.isCanvasUpdated=function(){return!!this._canvasUpdated},i.remove=function(){this.onRemove(),delete this._loadingResource,delete this.southWest,delete this.canvas,delete this.context,delete this.canvasExtent2D,delete this._extent2D,delete this.resources,delete this.layer},i.onRemove=function(){},i.onAdd=function(){},i.getMap=function(){return this.layer?this.layer.getMap():null},i.getCanvasImage=function(){var t=this.getMap();if(this._canvasUpdated=!1,this._renderZoom!==t.getZoom()||!this.canvas||!this._extent2D)return null;if(this.isBlank())return null;if(this.layer.isEmpty&&this.layer.isEmpty())return null;var e=t._pointToContainerPoint(this.southWest)._add(0,-t.height);return{image:this.canvas,layer:this.layer,point:e}},i.clear=function(){this.clearCanvas()},i.isBlank=function(){return!this._painted},i.show=function(){this.setToRedraw()},i.hide=function(){this.clear(),this.setToRedraw()},i.setZIndex=function(){this.setToRedraw()},i.hitDetect=function(t){if(!this.context||this.layer.isEmpty&&this.layer.isEmpty()||this.isBlank()||this._errorThrown)return!1;var e=this.getMap(),i=e.getDevicePixelRatio(),r=e.getSize();if(t.x<0||t.x>r.width*i||t.y<0||t.y>r.height*i)return!1;try{if(this.context.getImageData(i*t.x,i*t.y,1,1).data[3]>0)return!0}catch(t){return this._errorThrown||(console,this._errorThrown=!0),!1}return!1},i.loadResources=function(t){this.resources||(this.resources=new hr);var e=this.resources,i=[];if(N(t))for(var r={},n=t.length-1;n>=0;n--){var o=t[n];o&&o.length&&!r[o.join("-")]&&(r[o.join("-")]=1,e.isResourceLoaded(o,!0)||i.push(new di(this._promiseResource(o))))}return di.all(i)},i.prepareRender=function(){delete this._renderComplete;var t=this.getMap();this._renderZoom=t.getZoom(),this.canvasExtent2D=this._extent2D=t._get2DExtent(),this.southWest=t._containerPointToPoint(new se(0,t.height))},i.createCanvas=function(){if(!this.canvas){var t=this.getMap(),e=t.getSize(),i=t.getDevicePixelRatio(),r=i*e.width,n=i*e.height;if(this.layer._canvas){var o=this.layer._canvas;o.width=r,o.height=n,o.style&&(o.style.width=e.width+"px",o.style.height=e.height+"px"),this.canvas=this.layer._canvas}else this.canvas=ni.createCanvas(r,n,t.CanvasClass);this.onCanvasCreate()}},i.onCanvasCreate=function(){},i.createContext=function(){if(!(this.gl&&this.gl.canvas===this.canvas||this.context)&&(this.context=this.canvas.getContext("2d"),this.context)){this.layer.options.globalCompositeOperation&&(this.context.globalCompositeOperation=this.layer.options.globalCompositeOperation);var t=this.getMap().getDevicePixelRatio();1!==t&&this.context.scale(t,t)}},i.resetCanvasTransform=function(){if(this.context){var t=this.getMap().getDevicePixelRatio();this.context.setTransform(t,0,0,t,0,0)}},i.resizeCanvas=function(t){var e=this.canvas;if(e){var i=t||this.getMap().getSize(),r=this.getMap().getDevicePixelRatio();e.width===r*i.width&&e.height===r*i.height||(e.height=r*i.height,e.width=r*i.width,1!==r&&this.context&&this.context.scale(r,r),this.layer._canvas&&e.style&&(e.style.width=i.width+"px",e.style.height=i.height+"px"))}},i.clearCanvas=function(){this.context&&ni.clearRect(this.context,0,0,this.canvas.width,this.canvas.height)},i.prepareCanvas=function(){this.canvas?(this.resetCanvasTransform(),this.clearCanvas(),this.resizeCanvas()):(this.createCanvas(),this.createContext(),this.layer.onCanvasCreate(),this.layer.fire("canvascreate",{context:this.context,gl:this.gl})),delete this._maskExtent;var t=this.layer.getMask();if(!t)return this.layer.fire("renderstart",{context:this.context,gl:this.gl}),null;var e=this._maskExtent=t._getPainter().get2DExtent();return e.intersects(this._extent2D),this.layer.fire("renderstart",{context:this.context,gl:this.gl}),e},i.clipCanvas=function(t){var e=this.layer.getMask();if(!e)return!1;var i=this.southWest,r=this.getMap();this.southWest=r._containerPointToPoint(new se(0,r.height)),t.save();var n=r.getDevicePixelRatio();if(1!==n&&(t.save(),t.scale(n,n)),e.getGeometries){t.isMultiClip=!0;var o=e.getGeometries()||[];t.beginPath(),o.forEach(function(e){e._getPainter().paint(null,t)}),t.stroke(),delete t.isMultiClip}else{e._getPainter().paint(null,t)}return 1!==n&&t.restore(),t.clip(),this.southWest=i,!0},i.getViewExtent=function(){return{extent:this._extent2D,maskExtent:this._maskExtent,zoom:this._renderZoom,southWest:this.southWest}},i.completeRender=function(){this.getMap()&&(this._renderComplete=!0,this.layer.fire("renderend",{context:this.context,gl:this.gl}),this.setCanvasUpdated())},i.getEvents=function(){return{_zoomstart:this.onZoomStart,_zooming:this.onZooming,_zoomend:this.onZoomEnd,_resize:this.onResize,_movestart:this.onMoveStart,_moving:this.onMoving,_moveend:this.onMoveEnd,_dragrotatestart:this.onDragRotateStart,_dragrotating:this.onDragRotating,_dragrotateend:this.onDragRotateEnd,_spatialreferencechange:this.onSpatialReferenceChange}},i.onZoomStart=function(){},i.onZoomEnd=function(){this.setToRedraw()},i.onZooming=function(){},i.onMoveStart=function(){},i.onMoving=function(){},i.onMoveEnd=function(){this.setToRedraw()},i.onResize=function(){delete this._extent2D,this.resizeCanvas(),this.setToRedraw()},i.onDragRotateStart=function(){},i.onDragRotating=function(){},i.onDragRotateEnd=function(){this.setToRedraw()},i.onSpatialReferenceChange=function(){},i.getDrawTime=function(){return this._drawTime},i._tryToDraw=function(t){this._toRedraw=!1,!this.canvas&&this.layer.isEmpty&&this.layer.isEmpty()?this._renderComplete=!0:this._drawAndRecord(t)},i._drawAndRecord=function(t){if(this.getMap()){var e=this._painted;this._painted=!0;var i=s();this.draw(t),i=s()-i,this._drawTime=e?i:i/2,e&&this.layer&&this.layer.options.logDrawTime}},i._promiseResource=function(t){var e=this,i=this.resources,r=this.layer.options.crossOrigin;return function(n){if(i.isResourceLoaded(t,!0))n(t);else{var o=new Image;l(r)||(o.crossOrigin=r),b(t[0])&&!w&&(t[1]&&(t[1]*=2),t[2]&&(t[2]*=2)),o.onload=function(){e._cacheResource(t,o),n(t)},o.onabort=function(e){console,e&&console,n(t)},o.onerror=function(e){i.markErrorResource(t),n(t)},S(o,t)}}},i._cacheResource=function(t,e){if(this.layer&&this.resources){var i=t[1],r=t[2];if(this.layer.options.cacheSvgOnCanvas&&1===b(t[0])&&(re.edge||re.ie)){l(i)&&(i=e.width||this.layer.options.defaultIconSize[0]),l(r)&&(r=e.height||this.layer.options.defaultIconSize[1]);var n=ni.createCanvas(i,r);ni.image(n.getContext("2d"),e,0,0,i,r),e=n}this.resources.addResource(t,e)}},e}(gi),hr=function(){function t(){this.resources={},this._errors={}}var e=t.prototype;return e.addResource=function(t,e){this.resources[t[0]]={image:e,width:+t[1],height:+t[2]}},e.isResourceLoaded=function(t,e){if(!t)return!1;var i=this._getImgUrl(t);if(this._errors[i])return!0;var r=this.resources[i];return!!r&&!(e&&b(t[0])&&(+t[1]>r.width||+t[2]>r.height))},e.getImage=function(t){var e=this._getImgUrl(t);return!this.isResourceLoaded(t)||this._errors[e]?null:this.resources[e].image},e.markErrorResource=function(t){this._errors[this._getImgUrl(t)]=1},e.merge=function(t){if(!t)return this;for(var e in t.resources){var i=t.resources[e];this.addResource([e,i.width,i.height],i.image)}return this},e.forEach=function(t){if(!this.resources)return this;for(var e in this.resources)g(this.resources,e)&&t(e,this.resources[e]);return this},e._getImgUrl=function(t){return Array.isArray(t)?t[0]:t},t}(),lr=function(t){function e(e,i){var r,n;return i&&(n=i.canvas,delete i.canvas),(r=t.call(this,i)||this)._canvas=n,r.setId(e),i&&r.setZIndex(i.zIndex),r}ne(e,t);var i=e.prototype;return i.load=function(){if(!this.getMap())return this;if(this.onLoad()){this._initRenderer();var t=this.getZIndex();l(t)||(this._renderer.setZIndex(t),this.isCanvasRender()||this._renderer.render()),this.onLoadEnd()}return this},i.getId=function(){return this._id},i.setId=function(t){var e=this._id;return l(t)||(t+=""),this._id=t,this.fire("idchange",{old:e,new:t}),this},i.addTo=function(t){return t.addLayer(this),this},i.setZIndex=function(t){return this._zIndex=t,l(t)?delete this.options.zIndex:this.options.zIndex=t,this.map&&this.map._sortLayersByZIndex(),this._renderer&&this._renderer.setZIndex(t),this},i.getZIndex=function(){return this._zIndex||0},i.getMinZoom=function(){var t=this.getMap(),e=this.options.minZoom;return t?Math.max(t.getMinZoom(),e||0):e},i.getMaxZoom=function(){var t=this.getMap(),e=this.options.maxZoom;return t?Math.min(t.getMaxZoom(),l(e)?1/0:e):e},i.getOpacity=function(){return this.options.opacity},i.setOpacity=function(t){return this.config("opacity",t),this},i.isCanvasRender=function(){var t=this._getRenderer();return t&&t instanceof sr},i.getMap=function(){return this.map?this.map:null},i.getProjection=function(){var t=this.getMap();return t?t.getProjection():null},i.bringToFront=function(){var t=this._getLayerList();if(!t.length)return this;var e=t[t.length-1];if(1===t.length||e===this)return this;var i=e.getZIndex();return this.setZIndex(i+1),this},i.bringToBack=function(){var t=this._getLayerList();if(!t.length)return this;var e=t[0];if(1===t.length||e===this)return this;var i=e.getZIndex();return this.setZIndex(i-1),this},i.show=function(){var t=this;if(!this.options.visible){this.options.visible=!0;var e=this.getRenderer();e&&e.show();var i=this.getMap();e&&i?i.once("renderend",function(){t.fire("show")}):this.fire("show")}return this},i.hide=function(){var t=this;if(this.options.visible){this.options.visible=!1;var e=this.getRenderer();e&&e.hide();var i=this.getMap();e&&i?i.once("renderend",function(){t.fire("hide")}):this.fire("hide")}return this},i.isVisible=function(){if(c(this.options.opacity)&&this.options.opacity<=0)return!1;var t=this.getMap();if(t){var e=t.getZoom();if(!l(this.options.maxZoom)&&this.options.maxZoom<e||!l(this.options.minZoom)&&this.options.minZoom>e)return!1}return l(this.options.visible)&&(this.options.visible=!0),this.options.visible},i.remove=function(){return this.map&&this.map.removeLayer(this),this},i.getMask=function(){return this._mask},i.setMask=function(t){if(!("Point"===t.type&&t._isVectorMarker()||"Polygon"===t.type||"MultiPolygon"===t.type))throw new Error("Mask for a layer must be a marker with vector marker symbol or a Polygon(MultiPolygon).");if("Point"===t.type?t.updateSymbol({markerLineColor:"rgba(0, 0, 0, 0)",markerFillOpacity:0}):t.setSymbol({lineColor:"rgba(0, 0, 0, 0)",polygonOpacity:0}),t._bindLayer(this),this._mask=t,!this.getMap()||this.getMap().isZooming())return this;var e=this._getRenderer();return e&&e.setToRedraw&&this._getRenderer().setToRedraw(),this},i.removeMask=function(){if(delete this._mask,!this.getMap()||this.getMap().isZooming())return this;var t=this._getRenderer();return t&&t.setToRedraw&&this._getRenderer().setToRedraw(),this},i.onLoad=function(){return!0},i.onLoadEnd=function(){},i.isLoaded=function(){return!!this._loaded},i.getRenderer=function(){return this._getRenderer()},i.onConfig=function(t){if(c(t.opacity)||t.cssFilter){var e=this.getRenderer();e&&e.setToRedraw()}},i.onAdd=function(){},i.onRendererCreate=function(){},i.onCanvasCreate=function(){},i.onRemove=function(){},i._bindMap=function(t,e){t&&(this.map=t,l(e)||this.setZIndex(e),this._switchEvents("on",this),this.onAdd(),this.fire("add"))},i._initRenderer=function(){var t=this.options.renderer;if(this.constructor.getRendererClass){var e=this.constructor.getRendererClass(t);if(!e)throw new Error("Invalid renderer for Layer("+this.getId()+"):"+t);this._renderer=new e(this),this._renderer.layer=this,this._renderer.setZIndex(this.getZIndex()),this._switchEvents("on",this._renderer),this._renderer.onAdd&&this._renderer.onAdd(),this.onRendererCreate(),this.fire("renderercreate",{renderer:this._renderer})}},i._doRemove=function(){this._loaded=!1,this.onRemove(),this._switchEvents("off",this),this._renderer&&(this._switchEvents("off",this._renderer),this._renderer.remove(),delete this._renderer),delete this.map},i._switchEvents=function(t,e){e&&e.getEvents&&this.getMap()[t](e.getEvents(),e)},i._getRenderer=function(){return this._renderer},i._getLayerList=function(){return this.map?this.map._layers:[]},i._getMask2DExtent=function(){if(!this._mask||!this.getMap())return null;var t=this._mask._getPainter();return t?t.get2DExtent():null},e}(yi(fi(ar(gi))));lr.mergeOptions({attribution:null,minZoom:null,maxZoom:null,visible:!0,opacity:1,globalCompositeOperation:null,renderer:"canvas",debugOutline:"#0f0",cssFilter:null,forceRenderOnMoving:!1,forceRenderOnZooming:!1,forceRenderOnRotating:!1});var cr=lr.prototype.fire;lr.prototype.fire=function(t,e){return"layerload"===t&&(this._loaded=!0),this.map&&(e||(e={}),e.type=t,e.target=this,this.map._onLayerEvent(e)),cr.apply(this,arguments)};var ur={"EPSG:3857":{resolutions:function(){for(var t=[],e=12756274*Math.PI,i=0;i<21;i++)t[i]=e/(256*Math.pow(2,i));return t}(),fullExtent:{top:6378137*Math.PI,left:-6378137*Math.PI,bottom:-6378137*Math.PI,right:6378137*Math.PI}},"EPSG:4326":{fullExtent:{top:90,left:-180,bottom:-90,right:180},resolutions:function(){for(var t=[],e=0;e<20;e++)t[e]=180/(128*Math.pow(2,e));return t}()},BAIDU:{resolutions:function(){for(var t=Math.pow(2,18),e=[],i=0;i<20;i++)e[i]=t,t*=.5;return e}(),fullExtent:{top:33554432,left:-33554432,bottom:-33554432,right:33554432}},IDENTITY:{resolutions:function(){for(var t=Math.pow(2,8),e=[],i=0;i<18;i++)e[i]=t,t*=.5;return e}(),fullExtent:{top:2e5,left:-2e5,bottom:-2e5,right:2e5}}};ur["EPSG:4490"]=ur["EPSG:4326"];var pr,dr,fr,mr,gr,vr,yr=function(){function t(t){void 0===t&&(t={}),this.options=t,this._initSpatialRef()}t.getProjectionInstance=function(t){if(!t)return null;if(p(t))return t;for(var e in t=(t+"").toLowerCase(),or)if(g(or,e)){var i=or[e].code;if(i&&i.toLowerCase()===t)return or[e]}return null},t.equals=function(t,e){if(!t&&!e)return!0;if(!t||!e)return!1;if(t.projection!==e.projection)return!1;var i=t.fullExtent,r=e.fullExtent;if(i&&!r||!i&&r)return!1;if(i&&r&&(i.top!==r.top||i.bottom!==r.bottom||i.left!==r.left||i.right!==r.right))return!1;var n=t.resolutions,o=e.resolutions;if(n&&o){if(n.length!==o.length)return!1;for(var a=0;a<n.length;a++)if(n[a]!==o[a])return!1}return!0};var e=t.prototype;return e._initSpatialRef=function(){var e=this.options.projection;if(!(e=e?t.getProjectionInstance(e):nr))throw new Error("must provide a valid projection in map's spatial reference.");(e=h({},Vi,e)).measureLength||h(e,Qi.DEFAULT),this._projection=e;var i,r=this.options.resolutions;if(!r&&(e.code&&(i=ur[e.code])&&(r=i.resolutions,this.isEPSG="IDENTITY"!==e.code),!r))throw new Error("must provide valid resolutions in map's spatial reference.");this._resolutions=r;var n=this.options.fullExtent;if(!n&&(e.code&&(i=ur[e.code])&&(n=i.fullExtent),!n))throw new Error("must provide a valid fullExtent in map's spatial reference.");if(l(n.left)?(this._fullExtent=new zi(n),n.left=n.xmin,n.right=n.xmax,n.top=n.ymax,n.bottom=n.ymin):this._fullExtent=new zi(new bi(n.left,n.top),new bi(n.right,n.bottom)),l(n.top)||l(n.bottom)||l(n.left)||l(n.right))throw new Error("must provide valid top/bottom/left/right in fullExtent.");h(this._fullExtent,n),this._projection.fullExtent=n;var o=n.right>=n.left?1:-1,a=n.top>=n.bottom?-1:1;this._transformation=new ji([o,a,0,0])},e.getResolutions=function(){return this._resolutions||[]},e.getResolution=function(t){var e=0|t;e<0?e=0:e>this._resolutions.length-1&&(e=this._resolutions.length-1);var i=this._resolutions[e];return e!==t&&t>0&&e<this._resolutions.length-1?i+(this._resolutions[e+1]-i)*(t-e):i},e.getProjection=function(){return this._projection},e.getFullExtent=function(){return this._fullExtent},e.getTransformation=function(){return this._transformation},e.getMinZoom=function(){for(var t=0;t<this._resolutions.length;t++)if(!l(this._resolutions[t]))return t;return 0},e.getMaxZoom=function(){for(var t=this._resolutions.length-1;t>=0;t--)if(!l(this._resolutions[t]))return t;return this._resolutions.length-1},e.getZoomDirection=function(){return O(this._resolutions[this.getMinZoom()]-this._resolutions[this.getMaxZoom()])},e.toJSON=function(){return this.json||(this.json={resolutions:this._resolutions,fullExtent:{top:this._fullExtent.top,left:this._fullExtent.left,bottom:this._fullExtent.bottom,right:this._fullExtent.right},projection:this._projection.code}),this.json},t}(),Er={maxVisualPitch:60,maxPitch:80,centerCross:!1,zoomInCenter:!1,zoomOrigin:null,zoomAnimation:!w,zoomAnimationDuration:330,panAnimation:!w,panAnimationDuration:600,zoomable:!0,enableInfoWindow:!0,hitDetect:!re.mobile,hitDetectLimit:5,fpsOnInteracting:25,layerCanvasLimitOnInteracting:-1,maxZoom:null,minZoom:null,maxExtent:null,fixCenterOnResize:!1,checkSize:!0,checkSizeInterval:1e3,renderer:"canvas"},xr=function(t){function e(i,r){var n;if(!r)throw new Error("Invalid options when creating map.");if(!r.center)throw new Error("Invalid center when creating map.");var o=h({},r),a=o.zoom;delete o.zoom;var s=new bi(o.center);delete o.center;var l=o.baseLayer;delete o.baseLayer;var c=o.layers;return delete o.layers,(n=t.call(this,o)||this).VERSION=e.VERSION,Object.defineProperty(oe(oe(n)),"id",{value:M(),writable:!1}),n._loaded=!1,n._initContainer(i),n._panels={},n._baseLayer=null,n._layers=[],n._zoomLevel=a,n._center=s,n.setSpatialReference(o.spatialReference||o.view),n._mapViewPoint=new se(0,0),n._initRenderer(),n._updateMapSize(n._getContainerDomSize()),l&&n.setBaseLayer(l),c&&n.addLayer(c),n._Load(),n}ne(e,t),e.addOnLoadHook=function(t){var e=Array.prototype.slice.call(arguments,1),i="function"==typeof t?t:function(){this[t].apply(this,e)};return this.prototype._onLoadHooks=this.prototype._onLoadHooks||[],this.prototype._onLoadHooks.push(i),this};var i=e.prototype;return i.isLoaded=function(){return!!this._loaded},i.getContainer=function(){return this._containerDOM},i.getSpatialReference=function(){return this._spatialReference},i.setSpatialReference=function(t){var e=this.options.spatialReference;return this._loaded&&yr.equals(e,t)?this:(this._updateSpatialReference(t,e),this)},i._updateSpatialReference=function(t,e){if(t=h({},t),this._center=this.getCenter(),this.options.spatialReference=t,this._spatialReference=new yr(t),this.options.spatialReference&&f(this.options.spatialReference.projection)){var i=this._spatialReference.getProjection();this.options.spatialReference.projection=i.code}return this._resetMapStatus(),this._fireEvent("spatialreferencechange",{old:e,new:h({},this.options.spatialReference)}),this},i.onConfig=function(t){var e=t.spatialReference||t.view;return l(e)||this._updateSpatialReference(e,null),this},i.getProjection=function(){return this._spatialReference?this._spatialReference.getProjection():null},i.getFullExtent=function(){return this._spatialReference?this._spatialReference.getFullExtent():null},i.setCursor=function(t){return delete this._cursor,this._trySetCursor(t),this._cursor=t,this},i.resetCursor=function(){return this.setCursor(null)},i.getCenter=function(){return this._loaded&&this._prjCenter?this.getProjection().unproject(this._prjCenter):this._center},i.setCenter=function(t){if(!t)return this;t=new bi(t);var e=this.getProjection().project(t);return this._verifyExtent(e)?this._loaded?(this.onMoveStart(),this._setPrjCenter(e),this.onMoveEnd(this._parseEventFromCoord(this.getCenter())),this):(this._center=t,this):this},i.getSize=function(){return l(this.width)||l(this.height)?this._getContainerDomSize():new he(this.width,this.height)},i.getContainerExtent=function(){var t=this.height,e=this.getPitch(),i=this.options.maxVisualPitch;return i&&e>i&&(t=this._getVisualHeight(i)),new ki(0,this.height-t,this.width,this.height)},i._getVisualHeight=function(t){var e=this.getPitch(),i=this.height/2*Math.tan(t*Math.PI/180);return this.height/2+i*Math.tan((90-e)*Math.PI/180)},i.getExtent=function(){return this._pointToExtent(this._get2DExtent())},i.getProjExtent=function(){var t=this._get2DExtent();return new zi(this._pointToPrj(t.getMin()),this._pointToPrj(t.getMax()))},i.getPrjExtent=function(){return this.getProjExtent()},i.getMaxExtent=function(){return this.options.maxExtent?new zi(this.options.maxExtent,this.getProjection()):null},i.setMaxExtent=function(t){if(t){var e=new zi(t,this.getProjection());this.options.maxExtent=e,this._verifyExtent(this._getPrjCenter())||this._panTo(this._prjMaxExtent().getCenter());var i=this.getProjection();this._prjMaxExtent=e.convertTo(function(t){return i.project(t)})}else delete this.options.maxExtent,delete this._prjMaxExtent;return this},i.getZoom=function(){return this._zoomLevel},i.getZoomForScale=function(t,e,i){var r=this.getZoom();if(l(e)&&(e=r),1===t&&e===r)return r;var n=this._getResolution(e)/t,o=this.getZoomFromRes(n);if(i)return o;return this.getSpatialReference().getZoomDirection()<0?Math.ceil(o-1e-6):Math.floor(o+1e-6)},i.getZoomFromRes=function(t){var e=this._getResolutions(),i=this._getResolution(this.getMinZoom()),r=this._getResolution(this.getMaxZoom());if(i<=r){if(t<=i)return this.getMinZoom();if(t>=r)return this.getMaxZoom()}else{if(t>=i)return this.getMinZoom();if(t<=r)return this.getMaxZoom()}for(var n=e.length,o=0;o<n-1;o++)if(e[o]){var a=e[o+1]-e[o],s=t-e[o];if(O(a)===O(s)&&Math.abs(a)>=Math.abs(s))return o+s/a}return n-1},i.setZoom=function(t,e){return void 0===e&&(e={animation:!0}),isNaN(t)||l(t)?this:(t=+t,this._loaded&&this.options.zoomAnimation&&e.animation?this._zoomAnimation(t):this._zoom(t),this)},i.getMaxZoom=function(){return l(this.options.maxZoom)?this.getMaxNativeZoom():this.options.maxZoom},i.setMaxZoom=function(t){var e=this.getMaxNativeZoom();return t>e&&(t=e),null!==t&&t<this._zoomLevel&&(this.setZoom(t),t=+t),this.options.maxZoom=t,this},i.getMinZoom=function(){return l(this.options.minZoom)?this._spatialReference.getMinZoom():this.options.minZoom},i.setMinZoom=function(t){if(null!==t){t=+t;var e=this._spatialReference.getMinZoom();t<e&&(t=e),t>this._zoomLevel&&this.setZoom(t)}return this.options.minZoom=t,this},i.getMaxNativeZoom=function(){var t=this.getSpatialReference();return t?t.getMaxZoom():null},i.getGLZoom=function(){return this.getMaxNativeZoom()/2},i.getGLScale=function(t){return l(t)&&(t=this.getZoom()),this._getResolution(t)/this._getResolution(this.getGLZoom())},i.zoomIn=function(){return this.setZoom(this.getZoom()+1)},i.zoomOut=function(){return this.setZoom(this.getZoom()-1)},i.isZooming=function(){return!!this._zooming},i.isInteracting=function(){return this.isZooming()||this.isMoving()||this.isRotating()},i.setCenterAndZoom=function(t,e){return l(e)||this._zoomLevel===e?this.setCenter(t):(this.setCenter(t),this.setZoom(e,{animation:!1})),this},i.getFitZoom=function(t){var e=this;if(!(t&&t instanceof zi))return this._zoomLevel;if(t.xmin===t.xmax&&t.ymin===t.ymax)return this.getMaxZoom();var i=this.getSize(),r=t.convertTo(function(t){return e.coordToContainerPoint(t)}),n=r.getWidth(),o=r.getHeight(),a=i.width/n,s=i.height/o,h=this.getSpatialReference().getZoomDirection()<0?Math.max(a,s):Math.min(a,s);return this.getZoomForScale(h)},i.getView=function(){return{center:this.getCenter().toArray(),zoom:this.getZoom(),pitch:this.getPitch(),bearing:this.getBearing()}},i.setView=function(t){return t?(t.center&&this.setCenter(t.center),null===t.zoom||isNaN(+t.zoom)||this.setZoom(+t.zoom,{animation:!1}),null===t.pitch||isNaN(+t.pitch)||this.setPitch(+t.pitch),null===t.pitch||isNaN(+t.bearing)||this.setBearing(+t.bearing),this):this},i.getResolution=function(t){return this._getResolution(t)},i.getScale=function(t){var e=l(t)?this.getZoom():t,i=this._getResolution(this.getMaxNativeZoom());return this._getResolution(e)/i},i.fitExtent=function(t,e,i,r){if(void 0===i&&(i={}),!t)return this;t=new zi(t,this.getProjection());var n=this.getFitZoom(t)+(e||0),o=t.getCenter();return void 0===i.animation||i.animation?this._animateTo({center:o,zoom:n},{duration:i.duration||this.options.zoomAnimationDuration,easing:i.easing||"out"},r):this.setCenterAndZoom(o,n)},i.getBaseLayer=function(){return this._baseLayer},i.setBaseLayer=function(t){var e=!1;if(this._baseLayer&&(e=!0,this._fireEvent("baselayerchangestart"),this._baseLayer.remove()),!t)return delete this._baseLayer,this._fireEvent("baselayerchangeend"),this._fireEvent("setbaselayer"),this;return this._baseLayer=t,t._bindMap(this,-1),this._baseLayer.on("layerload",function(){this._fireEvent("baselayerload"),e&&(e=!1,this._fireEvent("baselayerchangeend"))},this),this._loaded&&this._baseLayer.load(),this._fireEvent("setbaselayer"),this},i.removeBaseLayer=function(){return this._baseLayer&&(this._baseLayer.remove(),delete this._baseLayer,this._fireEvent("baselayerremove")),this},i.getLayers=function(t){return this._getLayers(function(e){return!(e===this._baseLayer||e.getId().indexOf("_maptalks__internal_layer_")>=0)&&(!t||t(e))})},i.getLayer=function(t){if(!t)return null;var e=this._layerCache?this._layerCache[t]:null;if(e)return e;var i=this.getBaseLayer();return i&&i.getId()===t?i:null},i.addLayer=function(t){if(!t)return this;if(!Array.isArray(t))return t=Array.prototype.slice.call(arguments,0),this.addLayer(t);this._layerCache||(this._layerCache={});for(var e=this._layers,i=0,r=t.length;i<r;i++){var n=t[i],o=n.getId();if(l(o))throw new Error("Invalid id for the layer: "+o);if(n.getMap()!==this){if(this._layerCache[o])throw new Error("Duplicate layer id in the map: "+o);this._layerCache[o]=n,n._bindMap(this),e.push(n),this._loaded&&n.load()}}return this._sortLayersByZIndex(),this._fireEvent("addlayer",{layers:t}),this},i.removeLayer=function(t){if(!t)return this;if(!Array.isArray(t))return this.removeLayer([t]);for(var e=[],i=0,r=t.length;i<r;i++){var n=t[i];if(n instanceof lr||(n=this.getLayer(n)),n){var o=n.getMap();if(o&&o===this){e.push(n),this._removeLayer(n,this._layers),this._loaded&&n._doRemove();var a=n.getId();this._layerCache&&delete this._layerCache[a]}}}if(e.length>0){var s=this.getRenderer();s&&s.setLayerCanvasUpdated(),this.once("frameend",function(){e.forEach(function(t){t.fire("remove")})})}return this._fireEvent("removelayer",{layers:t}),this},i.sortLayers=function(t){if(!t||!Array.isArray(t))return this;for(var e=[],i=Number.MAX_VALUE,r=0,n=t.length;r<n;r++){var o=t[r];if(d(t[r])&&(o=this.getLayer(o)),!(o instanceof lr&&o.getMap()&&o.getMap()===this))throw new Error("It must be a layer added to this map to order.");o.getZIndex()<i&&(i=o.getZIndex()),e.push(o)}for(var a=0,s=e.length;a<s;a++)e[a].setZIndex(i+a);return this},i.toDataURL=function(t){t||(t={});var e=t.mimeType;e||(e="image/png");var i=t.save,r=this._getRenderer();if(r&&r.toDataURL){var n=t.fileName;n||(n="export");var o=r.toDataURL(e);if(i&&o){var a;if("undefined"!=typeof Blob&&"undefined"!=typeof atob){var s=X(o.replace(/^data:image\/(png|jpeg|jpg);base64,/,""),e);a=URL.createObjectURL(s)}else a=o;var h=document.createElement("a");h.download=n,h.href=a,document.body.appendChild(h),h.click(),document.body.removeChild(h)}return o}return null},i.coordToPoint=function(t,e,i){return this.coordinateToPoint(t,e,i)},i.pointToCoord=function(t,e,i){return this.pointToCoordinate(t,e,i)},i.coordToViewPoint=function(t,e){return this.coordinateToViewPoint(t,e)},i.viewPointToCoord=function(t,e){return this.viewPointToCoordinate(t,e)},i.coordToContainerPoint=function(t,e,i){return this.coordinateToContainerPoint(t,e,i)},i.containerPointToCoord=function(t,e){return this.containerPointToCoordinate(t,e)},i.containerPointToViewPoint=function(t,e){return e?e.set(t.x,t.y):e=t.copy(),e._sub(this.getViewPoint())},i.viewPointToContainerPoint=function(t,e){return e?e.set(t.x,t.y):e=t.copy(),e._add(this.getViewPoint())},i.checkSize=function(){var t=s()-this._initTime<1500&&0===this.width||0===this.height,e=this._getContainerDomSize(),i=this.height,r=this.width;if(e.width===r&&e.height===i)return this;var n=this.getCenter();if(this._updateMapSize(e),!this.options.fixCenterOnResize){var o=new se((r-e.width)/2,(i-e.height)/2);this._offsetCenterByPixel(o),this._mapViewCoord=this._getPrjCenter()}var a=0===e.width||0===e.height||0===r||0===i;return(t||a)&&(this._noEvent=!0,this.setCenter(n),delete this._noEvent),this._fireEvent("resize"),this},i.locate=function(t,e,i){return this.getProjection()._locate(new bi(t),e,i)},i.getMainPanel=function(){return this._getRenderer().getMainPanel()},i.getPanels=function(){return this._panels},i.remove=function(){if(this.isRemoved())return this;this._fireEvent("removestart"),this._removeDomEvents(),this._clearHandlers(),this.removeBaseLayer();for(var t=this.getLayers(),e=0;e<t.length;e++)t[e].remove();return this._getRenderer()&&this._getRenderer().remove(),this._containerDOM.innerHTML&&(this._containerDOM.innerHTML=""),delete this._panels,delete this._containerDOM,delete this.renderer,this._fireEvent("removeend"),this._clearAllListeners(),this},i.isRemoved=function(){return!this._containerDOM},i.isMoving=function(){return!!this._moving},i.onMoveStart=function(t){this._originCenter=this._getPrjCenter(),this._moving=!0,this._trySetCursor("move"),this._fireEvent("movestart",this._parseEvent(t?t.domEvent:null,"movestart"))},i.onMoving=function(t){this._fireEvent("moving",this._parseEvent(t?t.domEvent:null,"moving"))},i.onMoveEnd=function(t){if(this._moving=!1,this._trySetCursor("default"),this._fireEvent("moveend",t&&t.domEvent?this._parseEvent(t.domEvent,"moveend"):t),!this._verifyExtent(this._getPrjCenter())){var e=this._originCenter;this._verifyExtent(e)||(e=this.getMaxExtent().getCenter()),this._panTo(e)}},i.onDragRotateStart=function(t){this._dragRotating=!0,this._fireEvent("dragrotatestart",this._parseEvent(t?t.domEvent:null,"dragrotatestart"))},i.onDragRotating=function(t){this._fireEvent("dragrotating",this._parseEvent(t?t.domEvent:null,"dragrotating"))},i.onDragRotateEnd=function(t){this._dragRotating=!1,this._fireEvent("dragrotateend",this._parseEvent(t?t.domEvent:null,"dragrotateend"))},i.isDragRotating=function(){return!!this._dragRotating},i.getRenderer=function(){return this._getRenderer()},i.getDevicePixelRatio=function(){return this.options.devicePixelRatio||Math.ceil(re.devicePixelRatio)||1},i._initContainer=function(t){if(d(t)){if(this._containerDOM=document.getElementById(t),!this._containerDOM)throw new Error("Invalid container when creating map: '"+t+"'")}else this._containerDOM=t,w&&(this.CanvasClass=this._containerDOM.constructor);if(this._containerDOM.childNodes&&this._containerDOM.childNodes.length>0&&"maptalks-wrapper"===this._containerDOM.childNodes[0].className)throw new Error("Container is already loaded with another map instance, use map.remove() to clear it.")},i._trySetCursor=function(t){return this._cursor||this._priorityCursor||(t||(t="default"),this._setCursorToPanel(t)),this},i._setPriorityCursor=function(t){if(t)this._priorityCursor=t,this._setCursorToPanel(t);else{var e=!1;this._priorityCursor&&(e=!0),delete this._priorityCursor,e&&this.setCursor(this._cursor)}return this},i._setCursorToPanel=function(t){var e=this.getMainPanel();e&&e.style&&e.style.cursor!==t&&(e.style.cursor=t)},i._removeLayer=function(t,e){if(t&&e){var i=e.indexOf(t);i>-1&&e.splice(i,1)}},i._sortLayersByZIndex=function(){if(this._layers){for(var t=0,e=this._layers.length;t<e;t++)this._layers[t]._order=t;this._layers.sort(function(t,e){var i=t.getZIndex()-e.getZIndex();return 0===i?t._order-e._order:i})}},i._fireEvent=function(t,e){this._noEvent||(this.fire("_"+t,e),this.fire(t,e))},i._Load=function(){this._resetMapStatus(),this.options.pitch&&(this.setPitch(this.options.pitch),delete this.options.pitch),this.options.bearing&&(this.setBearing(this.options.bearing),delete this.options.bearing),this._loadAllLayers(),this._getRenderer().onLoad(),this._loaded=!0,this._callOnLoadHooks(),this._initTime=s()},i._initRenderer=function(){var t=this.options.renderer,i=e.getRendererClass(t);this._renderer=new i(this),this._renderer.load()},i._getRenderer=function(){return this._renderer},i._loadAllLayers=function(){this._baseLayer&&this._baseLayer.load(),this._eachLayer(function(t){t&&t.load()},this.getLayers())},i._getLayers=function(t){for(var e=this._baseLayer?[this._baseLayer].concat(this._layers):this._layers,i=[],r=0;r<e.length;r++)t&&!t.call(this,e[r])||i.push(e[r]);return i},i._eachLayer=function(t){if(!(arguments.length<2)){var e=Array.prototype.slice.call(arguments,1);e&&!Array.isArray(e)&&(e=[e]);for(var i=[],r=0,n=e.length;r<n;r++)i=i.concat(e[r]);for(var o=0,a=i.length;o<a;o++)t.call(t,i[o])}},i._onLayerEvent=function(t){t&&"idchange"===t.type&&(delete this._layerCache[t.old],this._layerCache[t.new]=t.target)},i._resetMapStatus=function(){var t=this.getMaxZoom(),e=this.getMinZoom(),i=this._spatialReference.getMaxZoom(),r=this._spatialReference.getMinZoom();(l(t)||-1===t||t>i)&&this.setMaxZoom(i),(l(e)||-1===e||e<r)&&this.setMinZoom(r),(t=this.getMaxZoom())<(e=this.getMinZoom())&&this.setMaxZoom(e),(l(this._zoomLevel)||this._zoomLevel>t)&&(this._zoomLevel=t),this._zoomLevel<e&&(this._zoomLevel=e),delete this._prjCenter;var n=this.getProjection();this._prjCenter=n.project(this._center),this._calcMatrices();var o=this._getRenderer();o&&o.resetContainer()},i._getContainerDomSize=function(){if(!this._containerDOM)return null;var t,e,i=this._containerDOM;if(l(i.width)||l(i.height)){if(l(i.clientWidth)||l(i.clientHeight))throw new Error("can not get size of container");t=parseInt(i.clientWidth,0),e=parseInt(i.clientHeight,0)}else{t=i.width,e=i.height;var r=this.getDevicePixelRatio();1!==r&&i.layer&&(t/=r,e/=r)}return new he(t,e)},i._updateMapSize=function(t){return this.width=t.width,this.height=t.height,this._getRenderer().updateMapSize(t),this._calcMatrices(),this},i._getPrjCenter=function(){return this._prjCenter},i._setPrjCenter=function(t){this._prjCenter=t,this.isInteracting()&&!this.isMoving()&&(this._mapViewCoord=t),this._calcMatrices()},i._setPrjCoordAtContainerPoint=function(t,e){if(e.x===this.width/2&&e.y===this.height/2)return this;var i=this._containerPointToPoint(e)._sub(this._prjToPoint(this._getPrjCenter())),r=this._pointToPrj(this._prjToPoint(t).sub(i));return this._setPrjCenter(r),this},i._verifyExtent=function(t){if(!t)return!1;var e=this._prjMaxExtent;return!e||e.contains(t)},i._offsetCenterByPixel=function(t){var e=new se(this.width/2-t.x,this.height/2-t.y),i=this._containerPointToPrj(e);return this._setPrjCenter(i),i},i.offsetPlatform=function(t){return t?(this._getRenderer().offsetPlatform(t),this._mapViewCoord=this._getPrjCenter(),this._mapViewPoint=this._mapViewPoint.add(t),this):this._mapViewPoint},i.getViewPoint=function(){var t=this._getViewPointFrameOffset(),e=this.offsetPlatform();return t&&(e=e.add(t)),e},i._resetMapViewPoint=function(){this._mapViewPoint=new se(0,0),this._mapViewCoord=this._getPrjCenter()},i._getResolution=function(t){return void 0!==t&&t!==this._zoomLevel||void 0===this._mapRes?t===this.getGLZoom()&&void 0!==this._mapGlRes?this._mapGlRes:(l(t)&&(t=this._zoomLevel),this._spatialReference.getResolution(t)):this._mapRes},i._getResolutions=function(){return this._spatialReference.getResolutions()},i._prjToPoint=function(t,e,i){return e=l(e)?this.getZoom():e,this._spatialReference.getTransformation().transform(t,this._getResolution(e),i)},i._pointToPrj=function(t,e,i){return e=l(e)?this.getZoom():e,this._spatialReference.getTransformation().untransform(t,this._getResolution(e),i)},i._pointToPoint=function(t,e,i){return i?(i.x=t.x,i.y=t.y):i=t.copy(),l(e)?i:i._multi(this._getResolution(e)/this._getResolution())},i._pointToPointAtZoom=function(t,e,i){return i?(i.x=t.x,i.y=t.y):i=t.copy(),l(e)?i:i._multi(this._getResolution()/this._getResolution(e))},i._containerPointToPrj=function(t,e){return this._pointToPrj(this._containerPointToPoint(t,void 0,e),void 0,e)},i._callOnLoadHooks=function(){var t=e.prototype;if(t._onLoadHooks)for(var i=0,r=t._onLoadHooks.length;i<r;i++)t._onLoadHooks[i].call(this)},e}(Ei(fi(ar(gi))));xr.include({coordinateToPoint:(vr=new bi(0,0),function(t,e,i){var r=this.getProjection().project(t,vr);return this._prjToPoint(r,e,i)}),pointToCoordinate:function(){var t=new bi(0,0);return function(e,i,r){var n=this._pointToPrj(e,i,t);return this.getProjection().unproject(n,r)}}(),coordinateToViewPoint:function(){var t=new bi(0,0);return function(e,i){return this._prjToViewPoint(this.getProjection().project(e,t),i)}}(),viewPointToCoordinate:function(){var t=new bi(0,0);return function(e,i){return this.getProjection().unproject(this._viewPointToPrj(e,t),i)}}(),coordinateToContainerPoint:function(){var t=new bi(0,0);return function(e,i,r){var n=this.getProjection().project(e,t);return this._prjToContainerPoint(n,i,r)}}(),containerPointToCoordinate:function(){var t=new bi(0,0);return function(e,i){var r=this._containerPointToPrj(e,t);return this.getProjection().unproject(r,i)}}(),containerToExtent:(mr=new se(0,0),gr=new se(0,0),function(t){var e=new ki(this._containerPointToPoint(t.getMin(mr),void 0,mr),this._containerPointToPoint(t.getMax(gr),void 0,gr));return this._pointToExtent(e)}),distanceToPixel:function(){var t=new se(0,0),e=new se(0,0);return function(i,r,n){var o=this.getProjection();if(!o)return null;var a=this.getScale()/this.getScale(n),s=this.getCenter(),h=o.locate(s,i,r),l=this.coordToContainerPoint(s,void 0,t),c=this.coordToContainerPoint(h,void 0,e);return c._sub(l)._multi(a)._abs(),new he(c.x,c.y)}}(),distanceToPoint:(fr=new se(0,0),function(t,e,i){var r=this.getProjection();if(!r)return null;var n=this.getCenter(),o=r.locate(n,t,e),a=this.coordToPoint(n,i,fr),s=this.coordToPoint(o,i);return s._sub(a)._abs(),s}),pixelToDistance:(pr=new bi(0,0),dr=new bi(0,0),function(t,e){var i=this.getProjection();if(!i)return null;var r=this.getFullExtent(),n=r.top>r.bottom?-1:1,o=pr.set(this.width/2+t,this.height/2+n*e),a=this.containerPointToCoord(o,dr);return i.measureLength(this.getCenter(),a)}),pointToDistance:function(){var t=new se(0,0),e=new bi(0,0);return function(i,r,n){var o=this.getProjection();if(!o)return null;var a=this._prjToPoint(this._getPrjCenter(),n,t);a._add(i,r);var s=this.pointToCoord(a,n,e);return o.measureLength(this.getCenter(),s)}}(),locateByPoint:function(){var t=new se(0,0);return function(e,i,r){var n=this.coordToContainerPoint(e,void 0,t);return this.containerPointToCoord(n._add(i,r))}}(),_get2DExtent:function(){var t=new se(0,0);return function(e,i){var r,n=this;return void 0!==e&&e!==this._zoomLevel||!this._mapExtent2D?e===this.getGLZoom()&&this._mapGlExtent2D&&(r=this._mapGlExtent2D):r=this._mapExtent2D,r?i?(i.set(r.xmin,r.ymin,r.xmax,r.ymax),i):r.copy():this.getContainerExtent().convertTo(function(i){return n._containerPointToPoint(i,e,t)},i)}}(),_pointToExtent:function(){var t=new bi(0,0),e=new bi(0,0);return function(i){var r=i.getMin(),n=i.getMax(),o=this.getFullExtent(),a=!o||o.left<=o.right?[r.x,n.x]:[n.x,r.x],s=a[0],h=a[1],l=!o||o.top>o.bottom?[n.y,r.y]:[r.y,n.y],c=l[0],u=l[1],p=r.set(s,c),d=n.set(h,u);return new zi(this.pointToCoord(p,void 0,t),this.pointToCoord(d,void 0,e),this.getProjection())}}(),_getViewPointFrameOffset:function(){var t=new se(0,0);return function(){if(this.isZooming())return null;var e=this._getPrjCenter();return this._mapViewCoord&&!this._mapViewCoord.equals(e)?this._prjToContainerPoint(this._mapViewCoord)._sub(this._prjToContainerPoint(e,void 0,t)):null}}(),_viewPointToPrj:function(){var t=new se(0,0);return function(e,i){return this._containerPointToPrj(this.viewPointToContainerPoint(e,t),i)}}(),_prjToContainerPoint:function(){var t=new se(0,0);return function(e,i,r){return this._pointToContainerPoint(this._prjToPoint(e,i,t),i,0,r)}}(),_prjToViewPoint:function(){var t=new se(0,0);return function(e,i){var r=this._prjToContainerPoint(e,void 0,t);return this.containerPointToViewPoint(r,i)}}(),_viewPointToPoint:function(){var t=new se(0,0);return function(e,i,r){return this._containerPointToPoint(this.viewPointToContainerPoint(e,t),i,r)}}(),_pointToViewPoint:function(){var t=new bi(0,0);return function(e,i,r){return this._prjToViewPoint(this._pointToPrj(e,i,t),r)}}()}),xr.mergeOptions(Er);var _r=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.addHooks=function(){this.target&&this.target.on("_dblclick",this._onDoubleClick,this)},i.removeHooks=function(){this.target&&this.target.off("_dblclick",this._onDoubleClick,this)},i._onDoubleClick=function(t){var e=this.target;if(e.options.doubleClickZoom){var i=e.getZoom(),r=t.domEvent.shiftKey?Math.ceil(i)-1:Math.floor(i)+1;e._zoomAnimation(r,t.containerPoint)}},e}(mi);xr.mergeOptions({doubleClickZoom:!0}),xr.addOnLoadHook("addHandler","doubleClickZoom",_r);var wr,br=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.addHooks=function(){var t=this.target;if(t){var e=t._panels.mapWrapper||t._containerDOM;this._dragHandler=new wi(e,{cancelOn:this._cancelOn.bind(this),rightclick:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this).on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this).enable()}},i.removeHooks=function(){this._dragHandler.off("mousedown",this._onMouseDown,this).off("dragstart",this._onDragStart,this).off("dragging",this._onDragging,this).off("dragend",this._onDragEnd,this),this._dragHandler.remove(),delete this._dragHandler},i._cancelOn=function(t){return!(!this.target.isZooming()&&!this._ignore(t))},i._ignore=function(t){return!!t&&(t.domEvent&&(t=t.domEvent),this.target._ignoreEvent(t))},i._onMouseDown=function(t){delete this.startDragTime,delete this._mode,2===t.domEvent.button||t.domEvent.ctrlKey?(this.target.options.dragRotate||this.target.options.dragPitch)&&(this._mode="rotatePitch"):this.target.options.dragPan&&(this._mode="move"),this.target._stopAnim(this.target._mapAnimPlayer),ze(t.domEvent)},i._onDragStart=function(t){this.startDragTime=s(),"move"===this._mode?this._moveStart(t):"rotatePitch"===this._mode&&this._rotateStart(t)},i._onDragging=function(t){this.target._isEventOutMap(t.domEvent)||("move"===this._mode?this._moving(t):"rotatePitch"===this._mode&&this._rotating(t))},i._onDragEnd=function(t){"move"===this._mode?this._moveEnd(t):"rotatePitch"===this._mode&&this._rotateEnd(t),delete this.startDragTime,delete this.startBearing},i._start=function(t){this.preX=t.mousePos.x,this.preY=t.mousePos.y,this.startX=this.preX,this.startY=this.preY},i._moveStart=function(t){this._start(t);var e=this.target;e.onMoveStart(t);var i=Fe(e._getActualEvent(t.domEvent),e.getContainer());this.startPrjCoord=e._containerPointToPrj(i)},i._moving=function(t){if(this.startDragTime){var e=this.target,i=Fe(e._getActualEvent(t.domEvent),e.getContainer());e._setPrjCoordAtContainerPoint(this.startPrjCoord,i),e.onMoving(t)}},i._moveEnd=function(t){if(this.startDragTime){var e=this.target,i=s()-this.startDragTime,r=t.mousePos.x,n=t.mousePos.y,o=r-this.startX,a=n-this.startY;this._clear(),e.options.panAnimation&&!t.interupted&&e._verifyExtent(e._getPrjCenter())&&i<280&&Math.abs(a)+Math.abs(o)>5?(i=5*i*(Math.abs(o)+Math.abs(a))/500,e.panBy(new se(o,a),{duration:i})):e.onMoveEnd(t)}},i._rotateStart=function(t){this._start(t),delete this._rotateMode,this.startBearing=this.target.getBearing(),this.target.onDragRotateStart(t),this._db=0},i._rotating=function(t){var e=this.target,i=t.mousePos.x,r=t.mousePos.y,n=e.getPitch(),o=e.getBearing(),a=Math.abs(i-this.preX),s=Math.abs(r-this.preY);if(this._rotateMode||(e.options.dragRotatePitch?this._rotateMode="rotate_pitch":this._rotateMode=a>s?"rotate":a<s?"pitch":"rotate"),!("pitch"===this._rotateMode&&0===n&&s<10)){if(this._rotateMode.indexOf("rotate")>=0&&e.options.dragRotate){var h=0;h=e.options.dragPitch||a>s?-.6*(this.preX-i):i>e.width/2?.6*(this.preY-r):-.6*(this.preY-r);var l=e.getBearing()+h;this._db=this._db||0,this._db+=h,e.setBearing(l)}this._rotateMode.indexOf("pitch")>=0&&e.options.dragPitch&&e.setPitch(e.getPitch()+.4*(this.preY-r)),this.preX=i,this.preY=r,e.getBearing()===o&&e.getPitch()===n||e.onDragRotating(t)}},i._rotateEnd=function(t){var e=this.target,i=e.getBearing();this._clear();var r=s()-this.startDragTime;if(e.onDragRotateEnd(t),Math.abs(i-this.startBearing)>20&&("rotate"===this._rotateMode||"rotate_pitch"===this._rotateMode)&&!t.interupted&&r<400){var n=e.getBearing();e._animateTo({bearing:n+this._db/2},{easing:"out",duration:800})}},i._clear=function(){delete this.startPrjCoord,delete this.preX,delete this.preY,delete this.startX,delete this.startY},e}(mi);function Sr(t,e,i,r){for(var n,o=[],a=0,s=0,h=t.length;s<h-1;s++)(n=Tr(t[s],t[s+1],e,s,i,r))&&(o[a]=o[a]||[],o[a].push({point:n[0],index:s}),n[1]===t[s+1]&&s!==h-2||(o[a].push({point:n[1],index:s+1}),a++));return o}function Tr(t,e,i,r,n,o){var a,s,h,l=r?wr:Ar(t,i),c=Ar(e,i);for(wr=c;;){if(!(l|c))return[t,e];if(l&c)return!1;if(o)return[t,e];h=Ar(s=Rr(t,e,a=l||c,i,n),i),a===l?(t=s,l=h):(e=s,c=h)}}function Mr(t,e,i){var r,n,o,a,s,h,l,c,u,p=[1,4,2,8];for(n=0,l=t.length;n<l;n++)t[n]._code=Ar(t[n],e);for(a=0;a<4;a++){for(c=p[a],r=[],n=0,o=(l=t.length)-1;n<l;o=n++)s=t[n],h=t[o],s._code&c?h._code&c||((u=Rr(h,s,c,e,i))._code=Ar(u,e),r.push(u)):(h._code&c&&((u=Rr(h,s,c,e,i))._code=Ar(u,e),r.push(u)),r.push(s));t=r}return t}function Rr(t,e,i,r,n){var o,a,s=e.x-t.x,h=e.y-t.y,l=r.getMin(),c=r.getMax();8&i?(o=t.x+s*(c.y-t.y)/h,a=c.y):4&i?(o=t.x+s*(l.y-t.y)/h,a=l.y):2&i?(o=c.x,a=t.y+h*(c.x-t.x)/s):1&i&&(o=l.x,a=t.y+h*(l.x-t.x)/s);var u=new se(o,a);return n&&u._round(),u}function Ar(t,e){var i=0;return t.x<e.getMin().x?i|=1:t.x>e.getMax().x&&(i|=2),t.y<e.getMin().y?i|=4:t.y>e.getMax().y&&(i|=8),i}function Cr(t,e,i,r){t=new se(t);var n,o,a,s=Math.abs(i.x-e.x),h=Math.abs(i.y-e.y),l=Math.sqrt(Math.abs(s*s-h*h));return s>=h?(n=new se(e.x-l,e.y),o=new se(e.x+l,e.y),a=2*s):(n=new se(e.x,e.y-l),o=new se(e.x,e.y+l),a=2*h),t.distanceTo(n)+t.distanceTo(o)<=a+2*r}xr.mergeOptions({draggable:!0,dragPan:!0,dragRotatePitch:!0,dragRotate:!0,dragPitch:!0}),xr.addOnLoadHook("addHandler","draggable",br);var Pr=function(){function t(){}var e=t.prototype;return e.getMap=function(){return this.geometry.getMap()},e.getPainter=function(){return this.painter},t.testColor=function(t){return!(!t||!d(t))&&a.indexOf(t)>=0},t}(),Dr=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i._prepareContext=function(t){c(this.symbol.opacity)?t.globalAlpha!==this.symbol.opacity&&(t.globalAlpha=this.symbol.opacity):1!==t.globalAlpha&&(t.globalAlpha=1)},i.prepareCanvas=function(t,e,i){ni.prepareCanvas(t,e,i,this.getPainter().isHitTesting())},i.remove=function(){},i.setZIndex=function(){},i.show=function(){},i.hide=function(){},i._defineStyle=function(t){return function(){var e=this,i=[],r={};return xt(t,function(){var t=e.getMap();return function(t,e,i){return t[0]=e,t[1]=i,t}(i,t.getZoom(),h({},e.geometry.getProperties(),function(t,e,i,r){return t["{bearing}"]=e,t["{pitch}"]=i,t["{zoom}"]=r,t}(r,t.getBearing(),t.getPitch(),t.getZoom())))})}.bind(this)()},e}(Pr);var Lr=new se(0,0),Or=new se(0,0),Hr=function(t){function e(e,i,r){var n;return(n=t.call(this)||this).symbol=e,n.geometry=i,n.painter=r,n}ne(e,t);var i=e.prototype;return i.get2DExtent=function(){for(var t=this.getMap(),e=t.getGLZoom(),i=new ki,r=this._getRenderPoints()[0],n=r.length-1;n>=0;n--)r[n]&&i._combine(t._pointToPoint(r[n],e));return i},i._rotateExtent=function(t,e){return t.convertTo(function(t){return t._rotate(e)})},i._getRenderPoints=function(){var t=this.getPainter().isSpriting()?"center":this.getPlacement();return this.getPainter().getRenderPoints(t)},i._getRenderContainerPoints=function(t){var e=this.getPainter(),i=this._getRenderPoints()[0];if(e.isSpriting())return i;var r=this.getDxDy(),n=this.painter._pointContainerPoints(i,r.x,r.y,t,!0,this.getPlacement());if(!n||!Array.isArray(n[0]))return n;for(var o=[],a=0,s=n.length;a<s;a++)for(var h=0,l=n[a].length;h<l;h++)o.push(n[a][h]);return o},i._getRotationAt=function(t){var e=this.getRotation();e||(e=0);var i=this._getRenderPoints()[1];if(!i||!i[t])return e;var r=this.getMap(),n=i[t][0],o=i[t][1];if(r.isTransforming()){var a=r.getGLZoom();n=r._pointToContainerPoint(i[t][0],a,0,Lr),o=r._pointToContainerPoint(i[t][1],a,0,Or)}return e+Z(n.x,n.y,o.x,o.y)},i._rotate=function(t,e,i){if(i){var r=this.getDxDy(),n=e.sub(r);return t.save(),t.translate(n.x,n.y),t.rotate(i),this.getDxDy()}return null},e}(Dr),Ir=function(t){function e(i,r,n){var o;(o=t.call(this,i,r,n)||this)._dynamic=yt(i),o.style=o._defineStyle(o.translate()),o.strokeAndFill=o._defineStyle(e.translateLineAndFill(o.style));var a=o.strokeAndFill.lineWidth;return o.padding=a%2==0?2:1.5,o}ne(e,t),e.test=function(t){return!!t&&!(!l(t.markerFile)||l(t.markerType)||"path"===t.markerType)};var i=e.prototype;return i.symbolize=function(t,e){var i=this.style;if(this.painter.isHitTesting()||0!==i.markerWidth&&0!==i.markerHeight&&(0!==i.polygonOpacity||0!==i.lineOpacity)){var r=this._getRenderContainerPoints();N(r)&&(this._prepareContext(t),this.getPainter().isSpriting()||this.geometry.getLayer().getMask()===this.geometry||this._dynamic||!1===this.geometry.getLayer().options.cacheVectorOnCanvas?this._drawMarkers(t,r,e):this._drawMarkersWithCache(t,r,e))}},i.getDxDy=function(){var t=this.style,e=t.markerDx,i=t.markerDy;return new se(e,i)},i._drawMarkers=function(t,e,i){var r=this.strokeAndFill;Ct(r.lineColor)||Ct(r.polygonFill)||this.prepareCanvas(t,r,i);for(var n=e.length-1;n>=0;n--){var o=e[n],a=this._rotate(t,o,this._getRotationAt(n));a&&(o=a),this._drawVectorMarker(t,o,i),a&&t.restore()}},i._drawMarkersWithCache=function(t,e,i){var r=this._stampSymbol(),n=i.getImage(r);n||(n=this._createMarkerImage(t,i),i.addResource([r,n.width,n.height],n));for(var o=this._getAnchor(n.width,n.height),a=e.length-1;a>=0;a--){var s=e[a],h=this._rotate(t,s,this._getRotationAt(a));h&&(s=h),ni.image(t,n,s.x+o.x,s.y+o.y),h&&t.restore()}},i._calMarkerSize=function(){if(!this._size){var t=this.strokeAndFill.lineWidth,e=2*(this.symbol.shadowBlur||0),i=Math.round(this.style.markerWidth+t+2*e+2*this.padding),r=Math.round(this.style.markerHeight+t+2*e+2*this.padding);this._size=[i,r]}return this._size},i._createMarkerImage=function(t,e){var i=t.canvas.constructor,r=this._calMarkerSize(),n=ni.createCanvas(r[0],r[1],i),o=this._getCacheImageAnchor(r[0],r[1]),a=n.getContext("2d");return Ct(this.strokeAndFill.lineColor)||Ct(this.strokeAndFill.polygonFill)||this.prepareCanvas(a,this.strokeAndFill,e),this._drawVectorMarker(a,o,e),n},i._stampSymbol=function(){return this._stamp||(this._stamp=[this.style.markerType,Ct(this.style.markerFill)?Pt(this.style.markerFill):this.style.markerFill,this.style.markerFillOpacity,this.style.markerFillPatternFile,Ct(this.style.markerLineColor)?Pt(this.style.markerLineColor):this.style.markerLineColor,this.style.markerLineWidth,this.style.markerLineOpacity,this.style.markerLineDasharray?this.style.markerLineDasharray.join(","):"",this.style.markerLinePatternFile,this.style.markerWidth,this.style.markerHeight,this.style.markerHorizontalAlignment,this.style.markerVerticalAlignment].join("_")),this._stamp},i._getAnchor=function(t,e){var i=2*(this.symbol.shadowBlur||0)+this.padding,r=_e(new he(t,e),this.style.markerHorizontalAlignment,this.style.markerVerticalAlignment);return r.x!==-t/2&&(r.x-=O(r.x+t/2)*i),r.y!==-e/2&&(r.y-=O(r.y+e/2)*i),r},i._getCacheImageAnchor=function(t,e){var i=2*(this.symbol.shadowBlur||0)+this.padding,r=this.style.markerType;return"bar"===r||"pie"===r||"pin"===r?new se(t/2,e-i):"rectangle"===r?new se(i,i):new se(t/2,e/2)},i._getGraidentExtent=function(t){var e=new ki,i=this.getDxDy(),r=this.getFixedExtent();if(Array.isArray(t))for(var n=t.length-1;n>=0;n--)e._combine(t[n]);else e._combine(t);return e.xmin+=r.xmin-i.x,e.ymin+=r.ymin-i.y,e.xmax+=r.xmax-i.x,e.ymax+=r.ymax-i.y,e},i._drawVectorMarker=function(t,i,r){var n,o=this.style,a=this.strokeAndFill,s=o.markerType.toLowerCase(),h=e._getVectorPoints(s,o.markerWidth,o.markerHeight),l=a.lineOpacity,c=a.polygonOpacity;(Ct(a.lineColor)||Ct(a.polygonFill))&&(Ct(a.lineColor)&&(n=this._getGraidentExtent(i),a.lineGradientExtent=n.expand(a.lineWidth)),Ct(a.polygonFill)&&(n||(n=this._getGraidentExtent(i)),a.polygonGradientExtent=n),this.prepareCanvas(t,a,r));var u=o.markerWidth,p=o.markerHeight,d=o.markerLineWidth/2;if("ellipse"===s)ni.ellipse(t,i,u/2,p/2,l,c);else if("cross"===s||"x"===s){for(var f=h.length-1;f>=0;f--)h[f]._add(i);ni.path(t,h.slice(0,2),l),ni.path(t,h.slice(2,4),l)}else if("diamond"===s||"bar"===s||"square"===s||"rectangle"===s||"triangle"===s){"bar"===s?i=i.add(0,-d):"rectangle"===s&&(i=i.add(d,d));for(var m=h.length-1;m>=0;m--)h[m]._add(i);ni.polygon(t,h,l,c)}else if("pin"===s){i=i.add(0,-d);for(var g=h.length-1;g>=0;g--)h[g]._add(i);var v=t.lineCap;t.lineCap="round",ni.bezierCurveAndFill(t,h,l,c),t.lineCap=v}else{if("pie"!==s)throw new Error("unsupported markerType: "+s);i=i.add(0,d);var y=180*Math.atan(u/2/p)/Math.PI,E=t.lineCap;t.lineCap="round",ni.sector(t,i,p,[90-y,90+y],l,c),t.lineCap=E}},i.getPlacement=function(){return this.symbol.markerPlacement},i.getRotation=function(){var t=this.style.markerRotation;return c(t)?-t*Math.PI/180:null},i.getFixedExtent=function(){var t=this.getDxDy(),e=2*this.padding,i=this._calMarkerSize().map(function(t){return t-e}),r=this._getAnchor(i[0],i[1]),n=new ki(t.add(0,0),t.add(i[0],i[1]));n._add(r);var o=this.getRotation();return o&&(n=this._rotateExtent(n,o)),n},i.translate=function(){var t,e,i=this.symbol,r={markerType:L(i.markerType,"ellipse"),markerFill:L(i.markerFill,"#00f"),markerFillOpacity:L(i.markerFillOpacity,1),markerFillPatternFile:L(i.markerFillPatternFile,null),markerLineColor:L(i.markerLineColor,"#000"),markerLineWidth:L(i.markerLineWidth,1),markerLineOpacity:L(i.markerLineOpacity,1),markerLineDasharray:L(i.markerLineDasharray,[]),markerLinePatternFile:L(i.markerLinePatternFile,null),markerDx:L(i.markerDx,0),markerDy:L(i.markerDy,0),markerWidth:L(i.markerWidth,10),markerHeight:L(i.markerHeight,10),markerRotation:L(i.markerRotation,0)},n=r.markerType;return"bar"===n||"pie"===n||"pin"===n?(t="middle",e="top"):"rectangle"===n?(t="right",e="bottom"):(t="middle",e="middle"),r.markerHorizontalAlignment=L(i.markerHorizontalAlignment,t),r.markerVerticalAlignment=L(i.markerVerticalAlignment,e),c(i.markerOpacity)&&(c(i.markerFillOpacity)&&(r.markerFillOpacity*=i.markerOpacity),c(i.markerLineOpacity)&&(r.markerLineOpacity*=i.markerOpacity)),r},e.translateLineAndFill=function(t){var e={lineColor:t.markerLineColor,linePatternFile:t.markerLinePatternFile,lineWidth:t.markerLineWidth,lineOpacity:t.markerLineOpacity,lineDasharray:t.markerLineDasharray,lineCap:"butt",lineJoin:"round",polygonFill:t.markerFill,polygonPatternFile:t.markerFillPatternFile,polygonOpacity:t.markerFillOpacity};return 0===e.lineWidth&&(e.lineOpacity=0),e},e._getVectorPoints=function(t,e,i){var r,n=i/2,o=e/2;if("triangle"===t)return[r=new se(0,0-n),new se(0-o,0+n),new se(0+o,0+n)];if("cross"===t)return[r=new se(0-o,0),new se(0+o,0),new se(0,0-n),new se(0,0+n)];if("diamond"===t)return[r=new se(0-o,0),new se(0,0-n),new se(0+o,0),new se(0,0+n)];if("square"===t)return[r=new se(0-o,0+n),new se(0+o,0+n),new se(0+o,0-n),new se(0-o,0-n)];if("rectangle"===t)return[r=new se(0,0),r.add(e,0),r.add(e,i),r.add(0,i)];if("x"===t)return[r=new se(0-o,0+n),new se(0+o,0-n),new se(0+o,0+n),new se(0-o,0-n)];if("bar"===t)return[r=new se(0-o,0-i),new se(0+o,0-i),new se(0+o,0),new se(0-o,0)];if("pin"===t){var a=i*Math.atan(o/n);return[r=new se(0,0),new se(0-a,0-i),new se(0+a,0-i),new se(0,0)]}return[]},e}(Hr),Br=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.getPlacement=function(){return"point"},i.getDxDy=function(){return new se(0,0)},i.symbolize=function(t){var e=this.geometry,i=e.getLayer();if(e.options.debug||!i||i.options.debug){var r=this.getMap();if(r&&!r.isZooming()){var n=i.options.debugOutline;t.strokeStyle=n,t.fillStyle=n;var o=this.getPainter().getContainerExtent().toArray();ni.polygon(t,[o],1,0);for(var a=this._getRenderContainerPoints(),s=this.geometry.getId(),h=Ir._getVectorPoints("cross",10,10),c=0;c<a.length;c++){var u=a[c];l(s)||ni.fillText(t,s,u.add(8,-4),n);for(var p=[],d=0;d<h.length;d++)p.push(h[d].add(u));ni.path(t,p.slice(0,2),1),ni.path(t,p.slice(2,4),1)}}}},e}(Hr),zr=function(t){function e(e,i,r){var n;return(n=t.call(this,e,i,r)||this).style=n._defineStyle(n.translate()),n}ne(e,t),e.test=function(t){return!!t&&!l(t.markerFile)};var i=e.prototype;return i.symbolize=function(t,e){var i=this.style;if(this.painter.isHitTesting()||0!==i.markerWidth&&0!==i.markerHeight&&0!==i.markerOpacity){var r=this._getRenderContainerPoints();if(N(r)){var n=this._getImage(e);if(n){this._prepareContext(t);var o,a=i.markerWidth,s=i.markerHeight;if(!c(a)||!c(s)){a=n.width,s=n.height,i.markerWidth=a,i.markerHeight=s;var h=[i.markerFile,i.markerWidth,i.markerHeight];e.isResourceLoaded(h)||e.addResource(h,n);var l=this.getPainter();l.isSpriting()||l.removeCache()}"path"!==this.symbol.markerType&&c(i.markerOpacity)&&i.markerOpacity<1&&(o=t.globalAlpha,t.globalAlpha*=i.markerOpacity);for(var u=_e(new he(a,s),i.markerHorizontalAlignment,i.markerVerticalAlignment),p=0,d=r.length;p<d;p++){var f=r[p],m=this._rotate(t,f,this._getRotationAt(p));m&&(f=m),ni.image(t,n,f.x+u.x,f.y+u.y,a,s),m&&t.restore()}void 0!==o&&(t.globalAlpha=o)}}}},i._getImage=function(t){return t?t.getImage([this.style.markerFile,this.style.markerWidth,this.style.markerHeight]):null},i.getPlacement=function(){return this.symbol.markerPlacement},i.getRotation=function(){var t=this.style.markerRotation;return c(t)?-t*Math.PI/180:null},i.getDxDy=function(){var t=this.style,e=t.markerDx,i=t.markerDy;return new se(e,i)},i.getFixedExtent=function(t){var e=this.style,i=e.markerFile,r=t?t.getImage(i):null,n=e.markerWidth||(r?r.width:0),o=e.markerHeight||(r?r.height:0),a=this.getDxDy(),s=_e(new he(n,o),e.markerHorizontalAlignment,e.markerVerticalAlignment),h=new ki(a.add(0,0),a.add(n,o));h._add(s);var l=this.getRotation();return l&&(h=this._rotateExtent(h,l)),h},i.translate=function(){var t=this.symbol;return{markerFile:t.markerFile,markerOpacity:L(t.markerOpacity,1),markerWidth:L(t.markerWidth,null),markerHeight:L(t.markerHeight,null),markerRotation:L(t.markerRotation,0),markerDx:L(t.markerDx,0),markerDy:L(t.markerDy,0),markerHorizontalAlignment:L(t.markerHorizontalAlignment,"middle"),markerVerticalAlignment:L(t.markerVerticalAlignment,"top")}},e}(Hr),Nr=new bi(0,0),kr=new bi(0,0),jr=function(t){function e(e,i,r){var n;return(n=t.call(this)||this).symbol=e,n.geometry=i,n.painter=r,"Point"===i.type?oe(n):(n.style=n._defineStyle(n.translate()),n)}ne(e,t),e.test=function(t,e){if(!t)return!1;if(e&&"Point"===e.type)return!1;for(var i in t){var r=i.slice(0,4);if("line"===r||"poly"===r)return!0}return!1};var i=e.prototype;return i.symbolize=function(t,e){var i=this.style;if(0!==i.polygonOpacity||0!==i.lineOpacity||this.painter.isHitTesting()){var r=this._getPaintParams();if(r){this._prepareContext(t);var n=Ct(i.lineColor),o="Polygon"===this.geometry.getJSONType()||"LineString"===this.geometry.type;!n||!i.lineColor.places&&o||(i.lineGradientExtent=this.getPainter().getContainerExtent()._expand(i.lineWidth)),Ct(i.polygonFill)&&(i.polygonGradientExtent=this.getPainter().getContainerExtent());var a=r[0];if("Polygon"===this.geometry.getJSONType()&&a.length>0&&Array.isArray(a[0][0])||"LineString"===this.geometry.type&&a.length>0&&Array.isArray(a[0]))for(var s=0;s<a.length;s++){this.prepareCanvas(t,i,e),n&&o&&!i.lineColor.places&&this._createGradient(t,a[s],i.lineColor);var h=[t,a[s]];r.length>1&&h.push.apply(h,r.slice(1)),h.push(i.lineOpacity,i.polygonOpacity,i.lineDasharray),this.geometry._paintOn.apply(this.geometry,h)}else{this.prepareCanvas(t,i,e),n&&o&&!i.lineColor.places&&this._createGradient(t,a,i.lineColor);var l=[t];l.push.apply(l,r),l.push(i.lineOpacity,i.polygonOpacity,i.lineDasharray),this.geometry._paintOn.apply(this.geometry,l)}t.setLineDash&&Array.isArray(i.lineDasharray)&&t.setLineDash([])}}},i.get2DExtent=function(){var t=this.getMap(),e=this.geometry._getPrjExtent();if(!e)return null;this._extMin&&this._extMax||(this._extMin=new bi(0,0),this._extMax=new bi(0,0)),this._extMin.x=e.xmin,this._extMin.y=e.ymin,this._extMax.x=e.xmax,this._extMax.y=e.ymax;var i=t._prjToPoint(this._extMin,void 0,Nr),r=t._prjToPoint(this._extMax,void 0,kr);return this._pxExtent?this._pxExtent.set(Math.min(i.x,r.x),Math.min(i.y,r.y),Math.max(i.x,r.x),Math.max(i.y,r.y)):this._pxExtent=new ki(i,r),this._pxExtent},i.getFixedExtent=function(){var t=this.style.lineWidth/2;return new ki(-t,-t,t,t)},i._getPaintParams=function(){return this.getPainter().getPaintParams(this.style.lineDx,this.style.lineDy)},i.translate=function(){var t=this.symbol,e={lineColor:L(t.lineColor,"#000"),lineWidth:L(t.lineWidth,2),lineOpacity:L(t.lineOpacity,1),lineDasharray:L(t.lineDasharray,[]),lineCap:L(t.lineCap,"butt"),lineJoin:L(t.lineJoin,"miter"),linePatternFile:L(t.linePatternFile,null),lineDx:L(t.lineDx,0),lineDy:L(t.lineDy,0),polygonFill:L(t.polygonFill,null),polygonOpacity:L(t.polygonOpacity,1),polygonPatternFile:L(t.polygonPatternFile,null),polygonPatternDx:L(t.polygonPatternDx,0),polygonPatternDy:L(t.polygonPatternDy,0),linePatternDx:L(t.linePatternDx,0),linePatternDy:L(t.linePatternDy,0)};return 0===e.lineWidth&&(e.lineOpacity=0),"LineString"!==this.geometry.type||e.polygonFill||(e.polygonFill=e.lineColor),e},i._createGradient=function(t,e,i){if(Array.isArray(e)&&e.length){var r=e.length,n=t.createLinearGradient(e[0].x,e[0].y,e[r-1].x,e[r-1].y);i.colorStops.forEach(function(t){n.addColorStop.apply(n,t)}),t.strokeStyle=n}},e}(Dr),Vr="___text_symbol_cache",Fr=function(t){function e(e,i,r){var n;if((n=t.call(this,e,i,r)||this)._dynamic=yt(e),n.style=n._defineStyle(n.translate()),0===n.style.textWrapWidth)return oe(n);n.strokeAndFill=n._defineStyle(n.translateLineAndFill(n.style));var o=xe(n.style.textName,n.geometry.getProperties());return n._dynamic||(n._cacheKey=function(t,e){var i=[t];for(var r in e)e.hasOwnProperty(r)&&r.length>4&&"text"===r.substring(0,4)&&i.push(r+"="+e[r]);return i.join("-")}(o,n.style)),n._descText(o),n}ne(e,t),e.test=function(t){return!!t&&!l(t.textName)};var i=e.prototype;return i.symbolize=function(t,e){if(this.painter.isHitTesting()||0!==this.style.textSize&&(this.style.textOpacity||this.style.textHaloRadius&&this.style.textHaloOpacity)&&0!==this.style.textWrapWidth){var i=this._getRenderContainerPoints();if(N(i)){var r=this.style,n=this.strokeAndFill,o=xe(this.style.textName,this.geometry.getProperties());this._descText(o),this._prepareContext(t),this.prepareCanvas(t,n,e),ni.prepareCanvasFont(t,r);for(var a=0,s=i.length;a<s;a++){var h=i[a],l=this._rotate(t,h,this._getRotationAt(a));l&&(h=l),ni.text(t,o,h,r,this.textDesc),l&&t.restore()}}}},i.getPlacement=function(){return this.symbol.textPlacement},i.getRotation=function(){var t=this.style.textRotation;return c(t)?-t*Math.PI/180:null},i.getDxDy=function(){var t=this.style;return new se(t.textDx,t.textDy)},i.getFixedExtent=function(){var t=this.getDxDy(),e=this.style,i=this.textDesc.size,r=_e(i,e.textHorizontalAlignment,e.textVerticalAlignment),n=r.x,o=r.y;if(e.textHaloRadius){var a=e.textHaloRadius;i=i.add(2*a,2*a)}var s=new ki(t.add(n,o),t.add(n+i.width,o+i.height)),h=this.getRotation();return h&&(s=this._rotateExtent(s,h)),s},i.translate=function(){var t=this.symbol,e={textName:t.textName,textFaceName:L(t.textFaceName,"monospace"),textWeight:L(t.textWeight,"normal"),textStyle:L(t.textStyle,"normal"),textSize:L(t.textSize,10),textFont:L(t.textFont,null),textFill:L(t.textFill,"#000"),textOpacity:L(t.textOpacity,1),textHaloFill:L(t.textHaloFill,"#ffffff"),textHaloRadius:L(t.textHaloRadius,0),textHaloOpacity:L(t.textHaloOpacity,1),textWrapWidth:L(t.textWrapWidth,null),textWrapCharacter:L(t.textWrapCharacter,"\n"),textLineSpacing:L(t.textLineSpacing,0),textDx:L(t.textDx,0),textDy:L(t.textDy,0),textHorizontalAlignment:L(t.textHorizontalAlignment,"middle"),textVerticalAlignment:L(t.textVerticalAlignment,"middle"),textAlign:L(t.textAlign,"center"),textRotation:L(t.textRotation,0),textMaxWidth:L(t.textMaxWidth,0),textMaxHeight:L(t.textMaxHeight,0)};return e.textMaxWidth>0&&(!e.textWrapWidth||e.textWrapWidth>e.textMaxWidth)&&(e.textWrapWidth||(e.textMaxHeight=1),e.textWrapWidth=e.textMaxWidth),e},i.translateLineAndFill=function(t){return{lineColor:t.textHaloRadius?t.textHaloFill:t.textFill,lineWidth:t.textHaloRadius,lineOpacity:t.textOpacity,lineDasharray:null,lineCap:"butt",lineJoin:"round",polygonFill:t.textFill,polygonOpacity:t.textOpacity}},i._descText=function(t){this._dynamic?this.textDesc=this._measureText(t):(this.textDesc=this._loadFromCache(),this.textDesc||(this.textDesc=this._measureText(t),this._storeToCache(this.textDesc)))},i._measureText=function(t){var e=this.style.textMaxHeight,i=Se(t,this.style);return e&&e<i.size.height&&(i.size.height=e),i},i._storeToCache=function(t){w||(this.geometry[Vr]||(this.geometry[Vr]={}),this.geometry[Vr][this._cacheKey]={desc:t,active:!0})},i._loadFromCache=function(){if(!this.geometry[Vr])return null;var t=this.geometry[Vr][this._cacheKey];return t?(t.active=!0,t.desc):null},e}(Hr);Fr.CACHE_KEY=Vr;var Ur,Gr=function(t){function e(e,i,r){var n;l(e.markerWidth)&&(e.markerWidth=80),l(e.markerHeight)&&(e.markerHeight=80),e=h(e,(n=t.call(this,e,i,r)||this).translate());var o=n.style=n._defineStyle(e);return re.gecko?n._url=[Tt(o,o.markerWidth,o.markerHeight),o.markerWidth,o.markerHeight]:n._url=[Tt(o),o.markerWidth,o.markerHeight],n}ne(e,t),e.test=function(t){return!!t&&!(!l(t.markerFile)||"path"!==t.markerType)};var i=e.prototype;return i._prepareContext=function(){},i._getImage=function(t){var e=this;if(t&&t.isResourceLoaded(this._url))return t.getImage(this._url);var i=this.painter,r=new Image;return r.onload=function(){var t=i.getLayer()&&i.getLayer().getRenderer();t&&t.setToRedraw()},r.onerror=function(i){t.markErrorResource(e._url)},r.src=this._url[0],t&&t.addResource(this._url,r),r},e}(zr),Wr={lineWidth:1,polygonFill:"#fff",polygonOpacity:.5},Xr=function(t){function e(e,i,r){var n;return(n=t.call(this,e,i,r)||this).style=i.getLayer().options.drawAltitude,n.style&&p(n.style)||(n.style={lineWidth:2}),n.style.lineWidth||(n.style.lineWidth=0),n.dxdy=n._defineStyle({dx:e.textDx||e.markerDx,dy:e.textDy||e.markerDy}),n}ne(e,t),e.test=function(t,e){if(!e.getLayer())return!1;var i=e.getJSONType();return"Marker"===i||"LineString"===i};var i=e.prototype;return i.symbolize=function(t){var e=this.geometry.getLayer();if(e.options.drawAltitude){var i=this.geometry.getProperties();if(i&&i[e.options.altitudeProperty]){var r=this._getStyle();if(this._prepareContext(t),"LineString"===this.geometry.type){var n=this._getPaintParams(r.lineDx,r.lineDy);if(!n)return;var o=this.getPainter().getPaintParams(r.lineDx,r.lineDy,!0)[0];this._drawLineAltitude(t,n[0],o)}else{var a=this._getRenderContainerPoints(),s=this._getRenderContainerPoints(!0);if(!a||0===a.length)return;this._drawMarkerAltitude(t,a[0],s[0])}}}},i.getDxDy=function(){var t=this.dxdy;return new se(t.dx||0,t.dy||0)},i.get2DExtent=function(){return"LineString"===this.geometry.type?jr.prototype.get2DExtent.apply(this):t.prototype.get2DExtent.call(this)},i.getPlacement=function(){return"point"},i._getPaintParams=function(t,e){return this.getPainter().getPaintParams(t||0,e||0)},i._drawMarkerAltitude=function(t,e,i){var r=this._getStyle();this.prepareCanvas(t,r),ni.path(t,[e,i],r.lineOpacity,null,r.lineDasharray)},i._drawLineAltitude=function(t,e,i){var r=this._getStyle();if(e.length>0&&Array.isArray(e[0]))for(var n=0;n<e.length;n++)this._drawLine(t,e[n],i[n]);else this._drawLine(t,e,i);t.setLineDash&&Array.isArray(r.lineDasharray)&&t.setLineDash([])},i._drawLine=function(t,e,i){var r=this._getStyle();this.prepareCanvas(t,r);for(var n=0,o=e.length-1;n<o;n++)ni.polygon(t,[e[n],e[n+1],i[n+1],i[n]],r.lineOpacity,r.polygonOpacity,r.lineDasharray)},i._getStyle=function(){var t=this.geometry.getLayer().options.drawAltitude;return p(t)||(t=Wr),t.lineWidth||(t.lineWidth=0,t.lineOpacity=0),t},e}(Hr),Zr=Object.freeze({Symbolizer:Pr,CanvasSymbolizer:Dr,DebugSymbolizer:Br,ImageMarkerSymbolizer:zr,PointSymbolizer:Hr,StrokeAndFillSymbolizer:jr,TextMarkerSymbolizer:Fr,VectorMarkerSymbolizer:Ir,VectorPathMarkerSymbolizer:Gr,DrawAltitudeSymbolizer:Xr}),Yr=[Xr,jr,zr,Gr,Ir,Fr],qr=new se(0,0),Jr=new se(0,0),Qr=new se(0,0),Kr=new ki,$r=new ki,tn=new ki,en=new ki,rn=new ki,nn=function(t){function e(e){var i;return(i=t.call(this)||this).geometry=e,i.symbolizers=i._createSymbolizers(),i._altAtGLZoom=i._getGeometryAltitude(),i}ne(e,t);var i=e.prototype;return i.getMap=function(){return this.geometry.getMap()},i.getLayer=function(){return this.geometry.getLayer()},i._createSymbolizers=function(){var t=this.getSymbol(),e=[],i=Yr,r=t;Array.isArray(t)||(r=[t]);for(var n=r.length-1;n>=0;n--)for(var o=r[n],a=i.length-1;a>=0;a--)if(i[a].test(o,this.geometry)){var s=new i[a](o,this.geometry,this);e.push(s),s instanceof Hr&&(this._hasPoint=!0)}if(!e.length&&console)this.geometry.getId();return this._debugSymbolizer=new Br(t,this.geometry,this),e},i.hasPoint=function(){return!!this._hasPoint},i.getRenderPoints=function(t){return this._renderPoints||(this._renderPoints={}),t||(t="center"),this._renderPoints[t]||(this._renderPoints[t]=this.geometry._getRenderPoints(t)),this._renderPoints[t]},i.getPaintParams=function(t,e,i){var r=this.getMap(),n=this.geometry,o=r.getResolution(),a=0!==r.getPitch(),s=0!==r.getBearing(),h=this._cachedParams,l=n._paintAsPath&&n._paintAsPath();if(l&&this._unsimpledParams&&o<=this._unsimpledParams._res)h=this._unsimpledParams;else if(!h||h._res!==r.getResolution()||this._pitched!==a&&n._redrawWhenPitch()||this._rotated!==s&&n._redrawWhenRotate()){if(!(h=n._getPaintParams()))return null;h._res=o,!n._simplified&&l&&(this._unsimpledParams||(this._unsimpledParams=h),o>this._unsimpledParams._res&&(this._unsimpledParams._res=o)),this._cachedParams=h}if(!h)return null;this._pitched=a,this._rotated=s;var u=r.getGLScale(),p=[],d=h[0],f=r.getContainerExtent(),m=this._pointContainerPoints(d,t,e,i,this._hitPoint&&!f.contains(this._hitPoint));if(!m)return null;p.push(m);for(var g=1,v=h.length;g<v;g++)c(h[g])||h[g]instanceof he?c(h[g])?p.push(h[g]/u):p.push(h[g].multi(1/u)):p.push(h[g]);return p},i._pointContainerPoints=function(t,e,i,r,n,o){if(this._aboveCamera())return null;var a,s=this.getMap(),h=s.getGLZoom(),l=this.containerOffset;function c(t,r){var n=s._pointToContainerPoint(t,h,r)._sub(l);return(e||i)&&n._add(e||0,i||0),n}var u=this.getAltitude();if(Array.isArray(t)){var p,d=this.geometry,f=(p=!n&&d.options.enableClip?this._clip(t,u):{points:t,altitude:u}).points;u=p.altitude,r&&(u=0);var m=u;a=[];for(var g=0,v=f.length;g<v;g++){var y=f[g];if(Array.isArray(y)){for(var E=[],x=0,_=y.length;x<_;x++){var w=y[x];Array.isArray(u)&&(m=u[g]?u[g][x]:0),E.push(c(w,m))}a.push(E)}else Array.isArray(u)&&(m="vertex-last"===o?u[u.length-1-g]:"line"===o?(u[g]+u[g+1])/2:u[g]),a.push(c(y,m))}}else t instanceof se&&(r&&(u=0),a=s._pointToContainerPoint(t,h,u)._sub(l),(e||i)&&a._add(e,i));return a},i._clip=function(t,e){var i=this.getMap(),r=this.geometry,n=this.getSymbol().lineWidth;c(n)||(n=4);var o=i._get2DExtent(void 0,en)._expand(n);if(i.getPitch()>0&&e){var a=i.cameraLookAt,s=i.cameraPosition;qr.set(s.x,s.y),o=o._combine(qr._add(O(a[0]-s[0]),O(a[1]-s[1])))}var h=t;if(this.get2DExtent(null,rn).within(o))return{points:h,altitude:e};var l=i._get2DExtent(i.getGLZoom(),en)._expand(n/i._glScale),u=r.options.smoothness;if(r.getShell&&this.geometry.getHoles&&!u)if(Array.isArray(t[0])){h=[];for(var p=0;p<t.length;p++){var d=Mr(t[p],l);d.length&&h.push(d)}}else h=Mr(t,l);else if("LineString"===r.getJSONType()){if(Array.isArray(t[0])){h=[];for(var f=0;f<t.length;f++)C(h,Sr(t[f],l,!1,!!u))}else h=Sr(t,l,!1,!!u);return this._interpolateSegAlt(h,t,e)}return{points:h,altitude:e}},i._interpolateSegAlt=function(t,e,i){if(!Array.isArray(i)){var r=function(t){return t.point};return{points:t.map(function(t){return Array.isArray(t)?t.map(r):t.point}),altitude:i}}var n=function t(e,i,r){if(!Array.isArray(r))return e;var n=[];for(var o=0,a=e.length;o<a;o++)if(Array.isArray(e[o]))n.push(t(e[o],i,r));else{var s=e[o];if(s.point.equals(i[s.index]))s.altitude=r[s.index],n.push(s);else{var h=void 0,l=void 0;0===s.index?(h=s.index,l=s.index+1):(h=s.index-1,l=s.index);var c=s.point.distanceTo(i[l]),u=c/(c+i[h].distanceTo(s.point)),p=I(r[h],r[l],1-u);s.altitude=p,n.push(s)}}return n}(t,e,i);return i=[],{points:n.map(function(t){if(Array.isArray(t)){var e=[],r=t.map(function(t){return e.push(t.altitude),t.point});return i.push(e),r}return i.push(t.altitude),t.point}),altitude:i}},i.getSymbol=function(){return this.geometry._getInternalSymbol()},i.paint=function(t,e,i){if(this.symbolizers){var r=this.getLayer()._getRenderer();if(r&&(r.context||e)&&(!t||t.intersects(this.get2DExtent(r.resources,Kr)))){var n=this.getMap(),o=this.getMinAltitude(),a=n.getFrustumAltitude();if(!(o&&a&&a<o)){this.containerOffset=i||n._pointToContainerPoint(r.southWest)._add(0,-n.height),this._beforePaint();for(var s=e||r.context,h=[s,r.resources],l=this.symbolizers.length-1;l>=0;l--)this._prepareShadow(s,this.symbolizers[l].symbol),this.symbolizers[l].symbolize.apply(this.symbolizers[l],h);this._afterPaint(),this._painted=!0,this._debugSymbolizer.symbolize.apply(this._debugSymbolizer,h)}}}},i.getSprite=function(t,e){if("Point"!==this.geometry.type)return null;if(this._spriting=!0,!this._sprite&&this.symbolizers.length>0){var i=new ki;this.symbolizers.forEach(function(e){var r=e.getFixedExtent(t);i._combine(r)});var r,n=i.getMin().multi(-1),o=e||(this.getMap()?this.getMap().CanvasClass:null),a=ni.createCanvas(i.getWidth(),i.getHeight(),o);this._renderPoints&&(r=this._renderPoints);for(var s=a.getContext("2d"),h=[s,t],l=this.symbolizers.length-1;l>=0;l--){var c=this.symbolizers[l].getDxDy();this._renderPoints={center:[[n.add(c)]]},this._prepareShadow(s,this.symbolizers[l].symbol),this.symbolizers[l].symbolize.apply(this.symbolizers[l],h)}r&&(this._renderPoints=r),this._sprite={canvas:a,offset:i.getCenter()}}return this._spriting=!1,this._sprite},i.isSpriting=function(){return!!this._spriting},i.hitTest=function(t,e){(!e||e<.5)&&(e=.5),Ur||(Ur=ni.createCanvas(1,1)),ni.setHitTesting(!0),Ur.width=Ur.height=2*e;var i=Ur.getContext("2d");this._hitPoint=t.sub(e,e);try{this.paint(null,i,this._hitPoint)}catch(t){throw t}finally{ni.setHitTesting(!1)}delete this._hitPoint;for(var r=i.getImageData(0,0,Ur.width,Ur.height).data,n=3,o=r.length;n<o;n+=4)if(r[n]>0)return!0;return!1},i.isHitTesting=function(){return!!this._hitPoint},i._prepareShadow=function(t,e){e.shadowBlur?(t.shadowBlur=this.isHitTesting()?0:e.shadowBlur,t.shadowColor=e.shadowColor||"#000",t.shadowOffsetX=e.shadowOffsetX||0,t.shadowOffsetY=e.shadowOffsetY||0):t.shadowBlur&&(t.shadowBlur=null,t.shadowColor=null,t.shadowOffsetX=null,t.shadowOffsetY=null)},i._eachSymbolizer=function(t,e){if(this.symbolizers){e||(e=this);for(var i=this.symbolizers.length-1;i>=0;i--)t.apply(e,[this.symbolizers[i]])}},i.get2DExtent=function(t,e){this._verifyProjection();var i=this.getMap();t=t||this.getLayer()._getRenderer().resources;var r=i.getZoom();if((!this._extent2D||this._extent2D._zoom!==r)&&(delete this._extent2D,delete this._fixedExtent,this.symbolizers)){for(var n=this._extent2D=new ki,o=this._fixedExtent=new ki,a=this.symbolizers.length-1;a>=0;a--){var s=this.symbolizers[a];n._combine(s.get2DExtent()),s.getFixedExtent&&o._combine(s.getFixedExtent(t))}n._zoom=r}return this._extent2D?e?(e.set(this._extent2D.xmin,this._extent2D.ymin,this._extent2D.xmax,this._extent2D.ymax),e._add(this._fixedExtent),e):this._extent2D.add(this._fixedExtent):null},i.getContainerExtent=function(t){if(this._aboveCamera())return null;this._verifyProjection();var e=this.getMap(),i=e.getZoom(),r=e._glScale;this._extent2D&&this._extent2D._zoom===i||this.get2DExtent(null,$r);var n=this.getMinAltitude(),o=this._extent2D.convertTo(function(t){return e._pointToContainerPoint(t,i,n/r,qr)},t),a=this.getMaxAltitude();if(a!==n){var s=this._extent2D.convertTo(function(t){return e._pointToContainerPoint(t,i,a/r,qr)},$r);o._combine(s)}var h=this.geometry.getLayer();if("LineString"===this.geometry.type&&a&&h.options.drawAltitude){var l=this._extent2D.convertTo(function(t){return e._pointToContainerPoint(t,i,0,qr)},$r);o._combine(l)}return o&&o._add(this._fixedExtent),this.geometry.options.smoothness&&o._expand(.15*o.getWidth()),o},i._aboveCamera=function(){var t=this.getMinAltitude(),e=this.getMap().getFrustumAltitude();return t&&e&&e<t},i.getFixedExtent=function(){var t=this.getMap().getZoom();return this._extent2D&&this._extent2D._zoom===t||this.get2DExtent(null,tn),this._fixedExtent},i.setZIndex=function(t){this._eachSymbolizer(function(e){e.setZIndex(t)})},i.show=function(){this._painted?(this.removeCache(),this._eachSymbolizer(function(t){t.show()})):this.getLayer().isCanvasRender()||this.paint()},i.hide=function(){this._eachSymbolizer(function(t){t.hide()})},i.repaint=function(){this._altAtGLZoom=this._getGeometryAltitude(),this.removeCache();var t=this.getLayer();if(t){var e=t.getRenderer();e&&e.setToRedraw()&&e.setToRedraw()}},i.refreshSymbol=function(){this.removeCache(),this._removeSymbolizers(),this.symbolizers=this._createSymbolizers()},i.remove=function(){this.removeCache(),this._removeSymbolizers()},i._removeSymbolizers=function(){this._eachSymbolizer(function(t){delete t.painter,t.remove()}),delete this.symbolizers},i.removeCache=function(){delete this._renderPoints,delete this._paintParams,delete this._sprite,delete this._extent2D,delete this._fixedExtent,delete this._cachedParams,delete this._unsimpledParams,this.geometry&&delete this.geometry[Fr.CACHE_KEY]},i.getAltitude=function(){return this._getAltitudeProperty()!==this._propAlt&&(this._altAtGLZoom=this._getGeometryAltitude()),this._altAtGLZoom?this._altAtGLZoom:0},i.getMinAltitude=function(){return this.minAltitude?this.minAltitude:0},i.getMaxAltitude=function(){return this.maxAltitude?this.maxAltitude:0},i._getGeometryAltitude=function(){var t=this;if(!this.getMap())return 0;var e=this._getAltitudeProperty();if(this._propAlt=e,!e)return this.minAltitude=this.maxAltitude=0,0;var i=this.geometry.getCenter();return i?Array.isArray(e)?(this.minAltitude=Number.MAX_VALUE,this.maxAltitude=Number.MIN_VALUE,e.map(function(e){var r=t._meterToPoint(i,e);return r<t.minAltitude&&(t.minAltitude=r),r>t.maxAltitude&&(t.maxAltitude=r),r})):(this.minAltitude=this.maxAltitude=this._meterToPoint(i,e),this.minAltitude):0},i._meterToPoint=function(t,e){var i=this.getMap(),r=i.getGLZoom(),n=i.locate(t,e,0),o=i.coordToPoint(t,r,Jr),a=i.coordToPoint(n,r,Qr);return Math.abs(a.x-o.x)*O(e)},i._getAltitudeProperty=function(){var t=this.geometry,e=t.getLayer().options,i=t.getProperties();return e.enableAltitude&&i?i[e.altitudeProperty]:0},i._verifyProjection=function(){var t=this.geometry._getProjection();this._projCode&&this._projCode!==t.code&&this.removeCache(),this._projCode=t.code},i._beforePaint=function(){var t=this.geometry[Fr.CACHE_KEY];if(t)for(var e in t)g(t,e)&&(t[e].active=!1)},i._afterPaint=function(){var t=this.geometry[Fr.CACHE_KEY];if(t)for(var e in t)g(t,e)&&(t[e].active||delete t[e])},e}(gi);var on=new ki,an=function(t){function e(e){var i;return(i=t.call(this)||this).geometry=e,i}ne(e,t);var i=e.prototype;return i._eachPainter=function(t){for(var e,i=this.geometry.getGeometries(),r=0,n=i.length;r<n&&(!(e=i[r]._getPainter())||!e||!1!==t.call(this,e));r++);},i.paint=function(t){this.geometry&&this._eachPainter(function(e){e.paint(t)})},i.get2DExtent=function(t,e){e&&e.set(null,null,null,null);var i=e||new ki;return this._eachPainter(function(e){i=i._combine(e.get2DExtent(t,on))}),i},i.getContainerExtent=function(){var t=new ki;return this._eachPainter(function(e){t=t.combine(e.getContainerExtent())}),t},i.remove=function(){var t=arguments;this._eachPainter(function(e){e.remove.apply(e,t)})},i.setZIndex=function(){var t=arguments;this._eachPainter(function(e){e.setZIndex.apply(e,t)})},i.show=function(){var t=arguments;this._eachPainter(function(e){e.show.apply(e,t)})},i.hide=function(){var t=arguments;this._eachPainter(function(e){e.hide.apply(e,t)})},i.repaint=function(){var t=arguments;this._eachPainter(function(e){e.repaint.apply(e,t)})},i.refreshSymbol=function(){var t=arguments;this._eachPainter(function(e){e.refreshSymbol.apply(e,t)})},i.hasPoint=function(){var t=!1;return this._eachPainter(function(e){return!e.hasPoint()||(t=!0,!1)}),t},i.getMinAltitude=function(){var t=!0,e=0;return this._eachPainter(function(i){var r=i.getMinAltitude();(t||r<e)&&(t=!1,e=r)}),e},i.getMaxAltitude=function(){var t=0;return this._eachPainter(function(e){var i=e.getMaxAltitude();i>t&&(t=i)}),t},e}(gi),sn=function(t){function i(e){var i,r=h({},e),n=r.symbol,o=r.properties,a=r.id;return delete r.symbol,delete r.id,delete r.properties,i=t.call(this,r)||this,n&&i.setSymbol(n),o&&i.setProperties(o),l(a)||i.setId(a),i}ne(i,t);var r=i.prototype;return r.getFirstCoordinate=function(){if("GeometryCollection"===this.type){var t=this.getGeometries();return t.length?t[0].getFirstCoordinate():null}var e=this.getCoordinates();if(!Array.isArray(e))return e;do{e=e[0]}while(Array.isArray(e)&&e.length>0);return e},r.getLastCoordinate=function(){if("GeometryCollection"===this.type){var t=this.getGeometries();return t.length?t[t.length-1].getLastCoordinate():null}var e=this.getCoordinates();if(!Array.isArray(e))return e;do{e=e[e.length-1]}while(Array.isArray(e)&&e.length>0);return e},r.addTo=function(t,e){return t.addGeometry(this,e),this},r.getLayer=function(){return this._layer?this._layer:null},r.getMap=function(){return this._layer?this._layer.getMap():null},r.getId=function(){return this._id},r.setId=function(t){var e=this.getId();return this._id=t,this._fireEvent("idchange",{old:e,new:t}),this},r.getProperties=function(){return this.properties?this.properties:this._getParent()?this._getParent().getProperties():null},r.setProperties=function(t){var e=this.properties;return this.properties=p(t)?h({},t):t,this._repaint(),this._fireEvent("propertieschange",{old:e,new:t}),this},r.getType=function(){return this.type},r.getSymbol=function(){var t=this._symbol;return t?Array.isArray(t)?Lt(t):h({},t):null},r.setSymbol=function(t){return this._symbol=this._prepareSymbol(t),this.onSymbolChanged(),this},r.updateSymbol=function(t){if(!t)return this;var e=this._getSymbol();return e=Lt(e||this._getInternalSymbol(),t),this.setSymbol(e)},r.getCenter=function(){return this._computeCenter(this._getMeasurer())},r.getExtent=function(){var t=this._getPrjExtent();if(t){var e=this._getProjection(),i=e.unproject(new bi(t.xmin,t.ymin)),r=e.unproject(new bi(t.xmax,t.ymax));return new zi(i,r,this._getProjection())}return this._computeExtent(this._getMeasurer())},r.getContainerExtent=function(t){var e=this._getPainter();return e?e.getContainerExtent(t):null},r.getSize=function(){var t=this.getContainerExtent();return t?t.getSize():null},r.containsPoint=function(t,e){if(!this.getMap())throw new Error('The geometry is required to be added on a map to perform "containsPoint".');return t instanceof bi&&(t=this.getMap().coordToContainerPoint(t)),this._containsPoint(t,e)},r._containsPoint=function(t,e){var i=this._getPainter();return!!i&&(l(e)&&this._hitTestTolerance&&(e=this._hitTestTolerance()),i.hitTest(t,e))},r.show=function(){if(this.options.visible=!0,this.getMap()){var t=this._getPainter();t&&t.show(),this._fireEvent("show")}return this},r.hide=function(){if(this.options.visible=!1,this.getMap()){this.onHide();var t=this._getPainter();t&&t.hide(),this._fireEvent("hide")}return this},r.isVisible=function(){if(!this.options.visible)return!1;var t=this._getInternalSymbol();if(!t)return!0;if(Array.isArray(t)){if(!t.length)return!0;for(var e=0,i=t.length;e<i;e++)if(l(t[e].opacity)||t[e].opacity>0)return!0;return!1}return l(t.opacity)||c(t.opacity)&&t.opacity>0},r.getZIndex=function(){return this.options.zIndex||0},r.setZIndex=function(t){var e=this.options.zIndex;return this.options.zIndex=t,this._fireEvent("zindexchange",{old:e,new:t}),this},r.setZIndexSilently=function(t){return this.options.zIndex=t,this},r.bringToFront=function(){var t=this.getLayer();if(!t||!t.getGeoMaxZIndex)return this;var e=t.getGeoMaxZIndex();return this.setZIndex(e+1),this},r.bringToBack=function(){var t=this.getLayer();if(!t||!t.getGeoMinZIndex)return this;var e=t.getGeoMinZIndex();return this.setZIndex(e-1),this},r.translate=function(t,e){if(l(t))return this;var i=new bi(t,e);if(0===i.x&&0===i.y)return this;var r=this.getCoordinates();if(r)if(Array.isArray(r)){var n=D(r,function(t){return t.add(i)});this.setCoordinates(n)}else this.setCoordinates(r.add(i));return this},r.flash=function(t,e,i,r){return Q.call(this,t,e,i,r)},r.copy=function(){var t=this.toJSON(),e=i.fromJSON(t);return e.options.visible=!0,e},r.remove=function(){return this.getLayer()?(this._fireEvent("removestart"),this._unbind(),this._fireEvent("removeend"),this._fireEvent("remove"),this):this},r.toGeoJSONGeometry=function(){return this._exportGeoJSONGeometry()},r.toGeoJSON=function(t){t||(t={});var e={type:"Feature",geometry:null};if(l(t.geometry)||t.geometry){var i=this._exportGeoJSONGeometry();e.geometry=i}var r,n=this.getId();return l(n)||(e.id=n),(l(t.properties)||t.properties)&&(r=this._exportProperties()),e.properties=r,e},r.toJSON=function(t){t||(t={});var e=this._toJSON(t);return h(e,this._exportGraphicOptions(t)),e},r.getLength=function(){return this._computeGeodesicLength(this._getMeasurer())},r.getArea=function(){return this._computeGeodesicArea(this._getMeasurer())},r.rotate=function(t,e){if("GeometryCollection"===this.type)return this.getGeometries().forEach(function(i){return i.rotate(t,e)}),this;e=e?new bi(e):this.getCenter();var i=this._getMeasurer(),r=this.getCoordinates();if(!Array.isArray(r)){if(e.x!==r.x||e.y!==r.y){var n=i._rotate(r,e,t);this.setCoordinates(n)}return this}return D(r,function(r){return i._rotate(r,e,t)}),this.setCoordinates(r),this},r._getConnectPoints=function(){return[this.getCenter()]},r._initOptions=function(t){var e=h({},t),i=e.symbol,r=e.properties,n=e.id;delete e.symbol,delete e.id,delete e.properties,this.setOptions(e),i&&this.setSymbol(i),r&&this.setProperties(r),l(n)||this.setId(n)},r._bindLayer=function(t){if(this.getLayer())throw new Error("Geometry cannot be added to two or more layers at the same time.");this._layer=t,this._clearCache(),this._clearProjection()},r._prepareSymbol=function(t){if(Array.isArray(t)){for(var e=[],i=0;i<t.length;i++)e.push(Rt(this._checkAndCopySymbol(t[i])));return e}return t?Rt(t=this._checkAndCopySymbol(t)):null},r._checkAndCopySymbol=function(t){var e={};for(var i in t)o[i]&&d(t[i])?e[i]=+t[i]:e[i]=t[i];return e},r._getSymbol=function(){return this._symbol},r._setExternSymbol=function(t){return this._externSymbol=this._prepareSymbol(t),this.onSymbolChanged(),this},r._getInternalSymbol=function(){return this._symbol?this._symbol:this._externSymbol?this._externSymbol:this.options.symbol?this.options.symbol:null},r._getPrjExtent=function(){var t=this._getProjection();return this._verifyProjection(),!this._extent&&t&&(this._extent=this._computePrjExtent(t)),this._extent},r._unbind=function(){var t=this.getLayer();t&&(this._animPlayer&&this._animPlayer.finish(),this._clearHandlers(),this._unbindMenu(),this._unbindInfoWindow(),this.isEditing()&&this.endEdit(),this._removePainter(),this.onRemove&&this.onRemove(),t.onRemoveGeometry&&t.onRemoveGeometry(this),delete this._layer,delete this._internalId,delete this._extent)},r._getInternalId=function(){return this._internalId},r._setInternalId=function(t){this._internalId=t},r._getMeasurer=function(){return this._getProjection()?this._getProjection():yr.getProjectionInstance(this.options.defaultProjection)},r._getProjection=function(){var t=this.getMap();return t?t.getProjection():null},r._verifyProjection=function(){var t=this._getProjection();!this._projCode||t&&this._projCode===t.code||this._clearProjection(),this._projCode=t?t.code:null},r._getExternalResources=function(){return Mt(this._getInternalSymbol())},r._getPainter=function(){return!this._painter&&this.getMap()&&(-1!==e.indexOf(this.type)?this._painter=new an(this):this._painter=new nn(this)),this._painter},r._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter},r._paint=function(t){this._painter&&this._painter.paint(t)},r._clearCache=function(){delete this._extent},r._clearProjection=function(){delete this._extent},r._repaint=function(){this._painter&&this._painter.repaint()},r.onHide=function(){this.closeMenu(),this.closeInfoWindow()},r.onShapeChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("shapechange")},r.onPositionChanged=function(){this._clearCache(),this._repaint(),this._fireEvent("positionchange")},r.onSymbolChanged=function(){this._painter&&this._painter.refreshSymbol(),this._fireEvent("symbolchange")},r.onConfig=function(t){var e;t.properties&&(e=t.properties,delete t.properties);var i=!1;for(var r in t)if(t.hasOwnProperty(r)){var n=r.slice(0,5);if("arrow"===n||"smoot"===n){i=!0;break}}e?(this.setProperties(e),this._repaint()):i&&this._repaint()},r._setParent=function(t){t&&(this._parent=t)},r._getParent=function(){return this._parent},r._fireEvent=function(t,e){this.getLayer()&&this.getLayer()._onGeometryEvent&&(e||(e={}),e.type=t,e.target=this,this.getLayer()._onGeometryEvent(e)),this.fire(t,e)},r._toJSON=function(t){return{feature:this.toGeoJSON(t)}},r._exportGraphicOptions=function(t){var e={};return(l(t.options)||t.options)&&(e.options=this.config()),(l(t.symbol)||t.symbol)&&(e.symbol=this.getSymbol()),(l(t.infoWindow)||t.infoWindow)&&this._infoWinOptions&&(e.infoWindow=this._infoWinOptions),e},r._exportGeoJSONGeometry=function(){var t=this.getCoordinates(),e=bi.toNumberArrays(t);return{type:this.getType(),coordinates:e}},r._exportProperties=function(){var t=null,e=this.getProperties();return l(e)||(t=p(e)?h({},e):e),t},i}(yi(fi(Ei(gi))));sn.mergeOptions({id:null,visible:!0,interactive:!0,editable:!0,cursor:null,defaultProjection:"EPSG:4326"});var hn="mousedown mouseup mousemove click dblclick contextmenu touchstart touchmove touchend",ln=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.addHooks=function(){var t=this.target,e=t._panels.allLayers||t._containerDOM;Ke(e,hn,this._identifyGeometryEvents,this)},i.removeHooks=function(){var t=this.target,e=t._panels.allLayers||t._containerDOM;$e(e,hn,this._identifyGeometryEvents,this)},i._identifyGeometryEvents=function(t,e){var i=this.target;if(!i.isInteracting()&&!i._ignoreEvent(t)){var r=i._getLayers(function(t){return!(!t.identify||!t.options.geometryEvents)});if(r.length){var n=null,o=e||t.type;if("mousedown"===o||"touchstart"===o&&1===t.touches.length)this._mouseDownTime=s();else if(("click"===o||"touchend"===o)&&this._mouseDownTime){var a=this._mouseDownTime;if(delete this._mouseDownTime,s()-a>300){if("click"===o)return}else"touchend"===o&&(n="click")}var h=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(h){var l=Fe(h,i._containerDOM),c=i.containerPointToCoordinate(l);"touchstart"===o&&ze(t);var u=null,p={includeInternals:!0,filter:function(e){if(!(e instanceof sn))return!1;var i=e._getEventTypeToFire(t);if("mousemove"===o){if(!u&&e.options.cursor&&(u=e.options.cursor),!e.listens("mousemove")&&!e.listens("mouseover")&&!e.listens("mouseenter"))return!1}else if(!e.listens(i)&&!e.listens(n))return!1;return!0},count:1,coordinate:c,onlyVisible:i.options.onlyVisibleGeometryEvents,layers:r},d=function(e){var r=!0;if("mousemove"===o){var a={};if(e.length>0)for(var s=e.length-1;s>=0;s--){var h=e[s];if(h instanceof sn){var l=h._getInternalId();a[l]=h,h._onEvent(t),this._prevOverGeos&&this._prevOverGeos.geomap[l]||h._onEvent(t,"mouseenter"),r=h._onEvent(t,"mouseover")}}i._setPriorityCursor(u);var c=this._prevOverGeos&&this._prevOverGeos.geos;if(this._prevOverGeos={geos:e,geomap:a},c&&c.length>0)for(var p=c.length-1;p>=0;p--){var d=c[p];if(d instanceof sn){var f=c[p]._getInternalId();a[f]||(r=d._onEvent(t,"mouseout"))}}}else{if(!e||!e.length)return;for(var m=e.length-1;m>=0;m--)if(e[m]instanceof sn){r=e[m]._onEvent(t),n&&e[m]._onEvent(t,n);break}}!1===r&&Ne(t)}.bind(this);"mousemove"===o||"touchmove"===o?this._queryIdentifyTimeout=i.getRenderer().callInNextFrame(function(){i.isInteracting()||i.identify(p,d)}):i.identify(p,d)}}}},e}(mi);xr.mergeOptions({geometryEvents:!0,onlyVisibleGeometryEvents:!0}),xr.addOnLoadHook("addHandler","geometryEvents",ln);var cn=.01,un=1/450,pn=function(t){function e(e){var i;return(i=t.call(this,e)||this)._thisScrollZoom=i._scrollZoom.bind(oe(oe(i))),i._wheelZoomRate=un,i._defaultZoomRate=cn,i._delta=0,i}ne(e,t);var i=e.prototype;return i.addHooks=function(){He(this.target._containerDOM,"mousewheel",this._onWheelScroll,this)},i.removeHooks=function(){Ie(this.target._containerDOM,"mousewheel",this._onWheelScroll)},i._onWheelScroll=function(t){ze(t),Ne(t);var e=this.target;if(e._ignoreEvent(t)||!e.options.zoomable)return!1;var i=e._containerDOM,r=e._checkZoomOrigin(Fe(t,i));return e.options.seamlessZoom?(this._zooming||(this._trackPadSuspect=0,this._ensureTrackpad=!1),this._seamless(t,r)):this._interval(t,r)},i._seamless=function(t,e){var i=t.deltaMode===window.WheelEvent.DOM_DELTA_LINE?60*t.deltaY:t.deltaY;if(i%4.000244140625!=0&&(this._ensureTrackpad||(Math.abs(i)<60?this._trackPadSuspect++:this._trackPadSuspect=0,this._trackPadSuspect>=2&&(this._ensureTrackpad=!0)),this._ensureTrackpad&&(i*=14)),t.shiftKey&&i&&(i/=4),this._lastWheelEvent=t,this._delta-=i,!this._zooming&&this._delta){var r=this.target;this._zoomOrigin=e,r.onZoomStart(null,e)}this._start()},i._start=function(){if(this._delta){this._zooming=!0;var t=this.target;this._active||(t.getRenderer().callInNextFrame(this._thisScrollZoom),this._active=!0)}},i._scrollZoom=function(){var t=this;if(this._active=!1,this._delta){var e=Math.abs(this._delta)>4.000244140625?this._wheelZoomRate:this._defaultZoomRate,i=2/(1+Math.exp(-Math.abs(this._delta*e)));this._delta<0&&0!==i&&(i=1/i);var r=this.target,n=r.getZoom(),o=r.getZoomForScale(i,n,!0);this._delta=0,r.onZooming(o,this._zoomOrigin),this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(function(){t._zooming=!1,delete t._timeout,r.onZoomEnd(r.getZoom(),t._zoomOrigin)},320)}},i._interval=function(t,e){var i=this,r=this.target;if(this._zooming)return this._requesting++,!1;this._requesting=0;var n=(t.wheelDelta?t.wheelDelta:t.detail)>0?1:-1;t.detail&&(n*=-1);var o=r.getZoom(),a=o+n;if((a=r._checkZoom(n>0?Math.ceil(a):Math.floor(a)))===o)return!1;this._zooming=!0,this._delta||(r.onZoomStart(null,e),this._origin=e,this._delta=n,this._startZoom=r.getZoom());return r._animateTo({zoom:a-1*this._delta/2,around:this._origin},{continueOnViewChanged:!0,easing:"linear",duration:90,wheelZoom:!0},function(e){"finished"===e.state.playState&&(i._requesting<1||Math.abs(a-i._startZoom)>2||a===r.getMaxZoom()||a===r.getMinZoom()?(r._animateTo({zoom:a,around:i._origin},{continueOnViewChanged:!0,duration:100},function(t){"finished"===t.state.playState&&setTimeout(function(){delete i._zooming,delete i._requesting},200)}),delete i._startZoom,delete i._origin,delete i._delta,i._requesting=0):l(i._requesting)||(delete i._zooming,i._onWheelScroll(t)))}),!1},e}(mi);xr.mergeOptions({scrollWheelZoom:!0,seamlessZoom:!1}),xr.addOnLoadHook("addHandler","scrollWheelZoom",pn);var dn=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.addHooks=function(){He(this.target.getContainer(),"touchstart",this._onTouchStart,this)},i.removeHooks=function(){Ie(this.target.getContainer(),"touchstart",this._onTouchStart)},i._onTouchStart=function(t){var e=this.target;if(t.touches&&2===t.touches.length&&!e.isInteracting()){var i=e.getContainer(),r=Fe(t.touches[0],i),n=Fe(t.touches[1],i);this.preY=r.y,this._startP1=r,this._startP2=n,this._startDist=r.distanceTo(n),this._startVector=r.sub(n),this._startZoom=e.getZoom(),this._startBearing=e.getBearing(),He(document,"touchmove",this._onTouchMove,this),He(document,"touchend",this._onTouchEnd,this),ze(t),e._fireEvent("touchactstart")}},i._onTouchMove=function(t){var e=this.target;if(t.touches&&2===t.touches.length){var i=e.getContainer(),r=Fe(t.touches[0],i),n=Fe(t.touches[1],i),o=r.sub(this._startP1),a=n.sub(this._startP2),s=r.sub(n),h=r.distanceTo(n)/this._startDist,l=180*s.angleWith(this._startVector)/Math.PI,c=.4*((this.preY||r.y)-r.y);this.preY=r.y;var u={domEvent:t,mousePos:[r,n]};if(this.mode||(e.options.touchRotate&&Math.abs(l)>8?this.mode=e.options.touchZoomRotate?"rotate_zoom":"rotate":e.options.touchPitch&&o.y*a.y>0&&Math.abs(o.y)>10&&Math.abs(a.y)>10?this.mode="pitch":e.options.zoomable&&e.options.touchZoom&&Math.abs(1-h)>.15&&(this.mode=e.options.touchZoomRotate&&e.options.touchRotate?"rotate_zoom":"zoom"),this._startTouching(u)),"zoom"===this.mode||"rotate_zoom"===this.mode){this._scale=h;var p=e._getResolution(this._startZoom)/h,d=e.getZoomFromRes(p);e.onZooming(d,this._Origin)}"rotate"===this.mode||"rotate_zoom"===this.mode?(e.setBearing(this._startBearing+l),e.onDragRotating(u)):"pitch"===this.mode&&(e.setPitch(e.getPitch()+c),e.onDragRotating(u)),e._fireEvent("touchactinging")}},i._startTouching=function(t){var e=this.target;if("zoom"===this.mode||"rotate_zoom"===this.mode){var i=e.getSize();this._Origin=new se(i.width/2,i.height/2),e.onZoomStart(null,this._Origin)}"rotate"!==this.mode&&"pitch"!==this.mode&&"rotate_zoom"!==this.mode||e.onDragRotateStart(t)},i._onTouchEnd=function(t){delete this.preY;var e=this.target;if($e(document,"touchmove",this._onTouchMove,this),$e(document,"touchend",this._onTouchEnd,this),"zoom"===this.mode||"rotate_zoom"===this.mode){var i=this._scale,r=e._getResolution(this._startZoom)/i,n=e.getZoomFromRes(r);e.onZoomEnd(n,this._Origin)}"pitch"!==this.mode&&"rotate"!==this.mode&&"rotate_zoom"!==this.mode||e.onDragRotateEnd({domEvent:t}),delete this.mode,e._fireEvent("touchactend")},e}(mi);xr.mergeOptions({touchGesture:!0,touchZoom:!0,touchPitch:!0,touchRotate:!0,touchZoomRotate:!1}),xr.addOnLoadHook("addHandler","touchGesture",dn);var fn={in:function(t){return Math.pow(t,2)},out:function(t){return 1-fn.in(1-t)},inAndOut:function(t){return 3*t*t-2*t*t*t},linear:function(t){return t},upAndDown:function(t){return t<.5?fn.inAndOut(2*t):1-fn.inAndOut(2*(t-.5))}},mn=function(t,e){this.state=t,this.styles=e},gn=function(t,e,i){this._animation=t,this.options=e,this._onFrame=i,this.playState="idle",this.ready=!0,this.finished=!1},vn={speed:{slow:2e3,normal:1e3,fast:500},_resolveStyles:function(t){if(!t)return null;function e(t){if(!Array.isArray(t))return vn._resolveStyles(t);for(var e=[],i=[],r=[],n=0;n<t.length;n++){var o=vn._resolveStyles(t[n]);o&&(e.push(o[0]),i.push(o[1]),r.push(o[2]))}return e.length?[e,i,r]:null}function i(t){var e,i=t;Array.isArray(t)||(i=c(t)?[0,t]:t instanceof se||t instanceof bi?[new(e=t.constructor)(0,0),t]:[t,t]);var r=i[0],n=i[1];return c(r)&&c(n)?r===n?null:[r,n-r,n]:Array.isArray(r)||r instanceof bi||r instanceof se?(Array.isArray(r)?(r=new bi(r),n=new bi(n)):(r=new(e=r.constructor)(r),n=new e(n)),r.equals(n)?null:[r,n.sub(r),n]):[r,0,n]}var r,n={},o={},a={};for(var s in t)if(t.hasOwnProperty(s)){var h=t[s];if(!h)continue;if(Array.isArray(h)&&(l(h[0])||l(h[1])))continue;var u=void 0;r=h,(u=!Array.isArray(r)&&r.constructor===Object||Array.isArray(r)&&r[0].constructor===Object?e(h):i(h))&&(o[s]=u[0],n[s]=u[1],a[s]=u[2])}return[o,n,a]},framing:function(t,e){e||(e={});var i,r,n,o=e.easing?fn[e.easing]:fn.linear;o||(o=fn.linear),(t=vn._resolveStyles(t))&&(r=t[0],i=t[1],n=t[2]);return function(t,e){var a,s;if(t<0)a={playState:"idle",delta:0},s=r;else if(t<e){var h=o(t/e);a={playState:"running",delta:h},s=function t(e,i,r){if(!i||!r)return null;var o={};for(var a in r)if(r.hasOwnProperty(a)){if(i[a]===n[a]){o[a]=i[a];continue}var s=i[a],h=r[a];if(c(h))o[a]=s+e*h;else if(Array.isArray(h)){for(var l=[],u=0;u<h.length;u++)l.push(t(e,s[u],h[u]));o[a]=l}else h.constructor===Object?o[a]=t(e,s,h):(s instanceof se||s instanceof bi)&&(o[a]=s.add(h.multi(e)))}return o}(h,r,i)}else a={playState:"finished",delta:1},s=n;return a.startStyles=r,a.destStyles=n,a.progress=t,a.remainingMs=e-t,new mn(a,s)}},_requestAnimFrame:function(t){this._frameQueue||(this._frameQueue=[]),this._frameQueue.push(t),this._a()},_a:function(){this._animationFrameId||(this._animationFrameId=x(vn._frameFn))},_run:function(){if(this._frameQueue.length){var t=this._frameQueue;this._frameQueue=[];for(var e=0,i=t.length;e<i;e++)t[e]();this._frameQueue.length?this._animationFrameId=x(vn._frameFn):delete this._animationFrameId}},animate:function(t,e,i){e||(e={});var r=vn.framing(t,e);return new gn(r,e,i)}};vn._frameFn=vn._run.bind(vn),h(gn.prototype,{_prepare:function(){var t=this.options,e=t.speed||t.duration;d(e)&&((e=vn.speed[e])||(e=+e)),e||(e=vn.speed.normal),this.duration=e,this._framer=t.framer||vn._requestAnimFrame.bind(vn)},play:function(){if("idle"!==this.playState&&"paused"!==this.playState)return this;"idle"===this.playState&&(this.currentTime=0,this._prepare());var t=s();if(!this.startTime){var e=this.options;this.startTime=e.startTime?e.startTime:t}return this._playStartTime=Math.max(t,this.startTime),"paused"===this.playState&&(this._playStartTime-=this.currentTime),this.playState="running",this._run(),this},pause:function(){return"paused"===this.playState?this:(this.playState="paused",this._run(),this)},cancel:function(){return"idle"===this.playState?this:(this.playState="idle",this.finished=!1,this._run(),this)},finish:function(){return"finished"===this.playState?this:(this.playState="finished",this.finished=!0,this._run(),this)},reverse:function(){},_run:function(){var t=this,e=this._onFrame,i=s(),r=i-this._playStartTime;if(this.options.repeat&&r>=this.duration&&(this._playStartTime=i,r=0),"running"===this.playState){var n=this._animation(r,this.duration);this.playState=n.state.playState,"idle"===this.playState?this.startTime>i&&setTimeout(this._run.bind(this),this.startTime-i):"running"===this.playState?this._framer(function(){"running"===t.playState&&(t.currentTime=r,e&&e(n),t._run())}):"finished"===this.playState&&(this.finished=!0,e&&e(n))}else if(e){"finished"===this.playState?r=this.duration:"idle"===this.playState&&(r=0);var o=this._animation(r,this.duration);o.state.playState=this.playState,e(o)}}});var yn=Object.freeze({Animation:vn,Easing:fn,Player:gn,Frame:mn}),En=ui(function(t){!function(){function e(t,e,i){var r=e.x,n=e.y,o=i.x-r,a=i.y-n;if(0!==o||0!==a){var s=((t.x-r)*o+(t.y-n)*a)/(o*o+a*a);s>1?(r=i.x,n=i.y):s>0&&(r+=o*s,n+=a*s)}return(o=t.x-r)*o+(a=t.y-n)*a}function i(t,i){var r=t.length-1,n=[t[0]];return function t(i,r,n,o,a){for(var s,h=o,l=r+1;l<n;l++){var c=e(i[l],i[r],i[n]);c>h&&(s=l,h=c)}h>o&&(s-r>1&&t(i,r,s,o,a),a.push(i[s]),n-s>1&&t(i,s,n,o,a))}(t,0,r,i,n),n.push(t[r]),n}function r(t,e,r){if(t.length<=2)return t;var n=void 0!==e?e*e:1;return t=i(t=r?t:function(t,e){for(var i,r,n,o,a,s=t[0],h=[s],l=1,c=t.length;l<c;l++)i=t[l],n=s,o=(r=i).x-n.x,a=r.y-n.y,o*o+a*a>e&&(h.push(i),s=i);return s!==i&&h.push(i),h}(t,n),n)}t.exports=r,t.exports.default=r}()}),xn=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.getOutline=function(){var t=this._getPainter();if(!t)return null;var e=this.getMap(),i=t.getContainerExtent().convertTo(function(t){return e.containerPointToCoord(t)});return new _n(i.toArray(),{symbol:{lineWidth:1,lineColor:"6b707b"}})},i.animateShow=function(t,e){var i=this;void 0===t&&(t={}),this._showPlayer&&this._showPlayer.finish(),f(t)&&(e=t={});var r=this.getCoordinates();if(0===r.length)return this;this._animIdx=0,this._animLenSoFar=0,this.show();var n=!!this.getShell?this.getShell().concat(this.getShell()[0]):this.getCoordinates(),o=this._getProjection();this._aniShowCenter=o.unproject(this._getPrjExtent().getCenter());var a=t.duration||1e3,s=this.getLength(),h=t.easing||"out";this.setCoordinates([]);var l=this._showPlayer=vn.animate({t:a},{duration:a,easing:h},function(t){if(i.getMap()){var o=i._drawAnimShowFrame(t.styles.t,a,s,n);"finished"===t.state.playState&&(delete i._showPlayer,delete i._aniShowCenter,delete i._animIdx,delete i._animLenSoFar,delete i._animTailRatio,i.setCoordinates(r)),e&&e(t,o)}else if("finished"!==l.playState&&(l.finish(),e)){var h=i.getCoordinates();e(t,h[h.length-1])}});return l.play(),l},i._drawAnimShowFrame=function(t,e,i,r){if(0===t)return r[0];var n,o,a=this.getMap(),s=t/e*i,h=0;for(n=this._animIdx,o=r.length;n<o-1&&(h=a.computeLength(r[n],r[n+1]),!(this._animLenSoFar+h>s));n++)this._animLenSoFar+=h;if(this._animIdx=n,this._animIdx>=o-1)return this.setCoordinates(r),r[r.length-1];var l=this._animIdx,c=r[l],u=r[l+1],p=(s-this._animLenSoFar)/h;this._animTailRatio=p;var d=c.x+(u.x-c.x)*p,f=c.y+(u.y-c.y)*p,m=new bi(d,f),g=!!this.getShell;if(!g&&this.options.smoothness>0){var v=r.slice(0,this._animIdx+3);this.setCoordinates(v)}else{var y=r.slice(0,this._animIdx+1);y.push(m),g?this.setCoordinates([this._aniShowCenter].concat(y)):this.setCoordinates(y)}return m},i._getCenterInExtent=function(t,e,i){var r=this.getExtent();if(!t.intersects(r))return null;var n=i(e,t);if(0===n.length)return null;var o=0,a=0,s=0;n.forEach(function(t){Array.isArray(t)?t.forEach(function(t){t.point&&(t=t.point),o+=t.x,a+=t.y,s++}):(t.point&&(t=t.point),o+=t.x,a+=t.y,s++)});var h=new bi(o,a)._multi(1/s);return h.count=s,h},i._getPath2DPoints=function(t,e,i){if(!N(t))return[];var r=this.getMap(),n=!e&&this._shouldSimplify(),o=this.options.simplifyTolerance*r._getResolution(),a=Array.isArray(t[0]);if(delete this._simplified,n&&!a){var s=t.length;t=En(t,o,!1),this._simplified=t.length<s}return l(i)&&(i=r.getZoom()),D(t,function(t){return r._prjToPoint(t,i)})},i._shouldSimplify=function(){var t=this.getLayer(),e=this.getProperties(),i=e&&t.options.enableAltitude&&!l(e[t.options.altitudeProperty]);return t&&t.options.enableSimplify&&!i&&this.options.enableSimplify&&!this._showPlayer},i._setPrjCoordinates=function(t){this._prjCoords=t,this.onShapeChanged()},i._getPrjCoordinates=function(){return this._getProjection()?(this._verifyProjection(),this._prjCoords||(this._prjCoords=this._projectCoords(this._coordinates)),this._prjCoords):null},i._updateCache=function(){this._clearCache(),this._getProjection()&&this._prjCoords&&(this._coordinates=this._unprojectCoords(this._getPrjCoordinates()))},i._clearProjection=function(){this._prjCoords=null,t.prototype._clearProjection.call(this)},i._projectCoords=function(t){var e=this._getProjection();return e?e.projectCoords(t):[]},i._unprojectCoords=function(t){var e=this._getProjection();return e?e.unprojectCoords(t):[]},i._computeCenter=function(){var t=this._coordinates;if(!N(t))return null;for(var e=0,i=0,r=0,n=t.length,o=0;o<n;o++)t[o]&&c(t[o].x)&&c(t[o].y)&&(e+=t[o].x,i+=t[o].y,r++);return new bi(e/r,i/r)},i._computeExtent=function(){var t=this._coordinates;if(!N(t))return null;var e=[t];return this.hasHoles&&this.hasHoles()&&e.push.apply(e,this.getHoles()),this._coords2Extent(e,this._getProjection())},i._computePrjExtent=function(){var t=[this._getPrjCoordinates()];return this.hasHoles&&this.hasHoles()&&t.push.apply(t,this._getPrjHoles()),this._coords2Extent(t)},i._get2DLength=function(){for(var t=this._getPath2DPoints(this._getPrjCoordinates(),!0),e=0,i=1,r=t.length;i<r;i++)e+=t[i].distanceTo(t[i-1]);return e},i._hitTestTolerance=function(){var t,e=this._getInternalSymbol();if(Array.isArray(e)){t=0;for(var i=0;i<e.length;i++)c(e[i].lineWidth)&&e[i].lineWidth>t&&(t=e[i].lineWidth)}else t=e.lineWidth;return c(t)?t/2:1.5},i._coords2Extent=function(t,e){for(var i=new zi(e),r=0,n=t.length;r<n;r++)for(var o=0,a=t[r].length;o<a;o++)i._combine(t[r][o]);return i},e}(sn);xn.mergeOptions({smoothness:0,enableClip:!0,enableSimplify:!0,simplifyTolerance:2,symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:1,opacity:1}});var _n=function(t){function e(e,i){var r;return(r=t.call(this,i)||this).type="Polygon",e&&r.setCoordinates(e),r}ne(e,t);var i=e.prototype;return i.setCoordinates=function(t){if(!t)return this._coordinates=null,this._holes=null,this._projectRings(),this;var e=bi.toCoordinates(t),i=e.length;if(Array.isArray(e[0])){if(this._coordinates=this._trimRing(e[0]),i>1){for(var r=[],n=1;n<i;n++)e[n]&&r.push(this._trimRing(e[n]));this._holes=r}}else this._coordinates=this._trimRing(e);return this._projectRings(),this},i.getCoordinates=function(){if(!this._coordinates)return[];for(var t=this.getHoles(),e=[this._copyAndCloseRing(this._coordinates)],i=0,r=t.length;i<r;i++)e.push(this._copyAndCloseRing(t[i]));return e},i.getCenterInExtent=function(t){return this._getCenterInExtent(t,this.getShell(),Mr)},i.getShell=function(){return this._coordinates||[]},i.getHoles=function(){return this._holes||[]},i.hasHoles=function(){return this.getHoles().length>0},i._projectRings=function(){this.getMap()?(this._prjCoords=this._projectCoords(this._coordinates),this._prjHoles=this._projectCoords(this._holes),this.onShapeChanged()):this.onShapeChanged()},i._cleanRing=function(t){for(var e=t.length-1;e>=0;e--)t[e]||t.splice(e,1)},i._checkRing=function(t){if(this._cleanRing(t),!t||!N(t))return!1;var e=t[t.length-1],i=!0;return t[0].x===e.x&&t[0].y===e.y||(i=!1),i},i._trimRing=function(t){var e=this._checkRing(t);return N(t)&&e&&t.splice(t.length-1,1),t},i._copyAndCloseRing=function(t){t=t.slice(0);var e=this._checkRing(t);return N(t)&&!e?(t.push(t[0].copy()),t):t},i._getPrjShell=function(){return"Polygon"===this.getJSONType()?this._getPrjCoordinates():this._getProjection()?(this._verifyProjection(),this._prjShell||(this._prjShell=this._projectCoords(this.getShell())),this._prjShell):null},i._getPrjHoles=function(){return this._getProjection()?(this._verifyProjection(),this._prjHoles||(this._prjHoles=this._projectCoords(this.getHoles())),this._prjHoles):null},i._computeGeodesicLength=function(t){var e=this.getCoordinates();if(!N(e))return 0;for(var i=0,r=0,n=e.length;r<n;r++)i+=t.measureLength(e[r]);return i},i._computeGeodesicArea=function(t){var e=this.getCoordinates();if(!N(e))return 0;for(var i=t.measureArea(e[0]),r=1,n=e.length;r<n;r++)i-=t.measureArea(e[r]);return i},i._updateCache=function(){t.prototype._updateCache.call(this),this._prjHoles&&(this._holes=this._unprojectCoords(this._getPrjHoles()))},i._clearCache=function(){return delete this._prjShell,t.prototype._clearCache.call(this)},i._clearProjection=function(){this._prjHoles&&(this._prjHoles=null),this._prjShell&&(this._prjShell=null),t.prototype._clearProjection.call(this)},e}(xn);function wn(t){return function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.getCoordinates=function(){return this._coordinates},i.setCoordinates=function(t){var e=t instanceof bi?t:new bi(t);if(e.equals(this._coordinates))return this;if(this._coordinates=e,!this.getMap())return this.onPositionChanged(),this;var i=this._getProjection();return this._setPrjCoordinates(i.project(this._coordinates)),this},i._getCenter2DPoint=function(t){var e=this.getMap();if(!e)return null;var i=l(t)?e.getZoom():e.getGLZoom(),r=this._getPrjCoordinates();return r?e._prjToPoint(r,i):null},i._getPrjCoordinates=function(){var t=this._getProjection();return t?(this._verifyProjection(),this._pcenter||this._coordinates&&(this._pcenter=t.project(this._coordinates)),this._pcenter):null},i._setPrjCoordinates=function(t){this._pcenter=t,this.onPositionChanged()},i._updateCache=function(){this._clearCache();var t=this._getProjection();this._pcenter&&t&&(this._coordinates=t.unproject(this._pcenter))},i._clearProjection=function(){this._pcenter=null,t.prototype._clearProjection.call(this)},i._computeCenter=function(){return this._coordinates?this._coordinates.copy():null},e}(t)}_n.registerJSONType("Polygon");var bn=function(t){function e(e,i){var r;return(r=t.call(this,i)||this).type="Point",e&&r.setCoordinates(e),r}ne(e,t);var i=e.prototype;return i.getOutline=function(){var t=this._getPainter();if(!t)return null;var i=this.getCoordinates(),r=t.getContainerExtent(),n=this.getMap().coordToContainerPoint(i);return new e(i,{symbol:{markerType:"square",markerWidth:r.getWidth(),markerHeight:r.getHeight(),markerLineWidth:1,markerLineColor:"6b707b",markerFill:"rgba(0, 0, 0, 0)",markerDx:r.xmin-(n.x-r.getWidth()/2),markerDy:r.ymin-(n.y-r.getHeight()/2)}})},i._isVectorMarker=function(){var t=this._getInternalSymbol();return!Array.isArray(t)&&Ir.test(t)},i._canEdit=function(){var t=this._getInternalSymbol();return!Array.isArray(t)&&(Ir.test(t)||Gr.test(t)||zr.test(t))},i._containsPoint=function(e,i){var r=this.getContainerExtent();return i&&(r=r.expand(i)),!!r.contains(e)&&(!this.options.hitTestForEvent||t.prototype._containsPoint.call(this,e,i))},i._computeExtent=function(){return Sn.call(this,"getCenter")},i._computePrjExtent=function(){return Sn.call(this,"_getPrjCoordinates")},i._computeGeodesicLength=function(){return 0},i._computeGeodesicArea=function(){return 0},i._getSprite=function(t,e){return this._getPainter()?this._getPainter().getSprite(t,e):new nn(this).getSprite(t,e)},e}(wn(sn));function Sn(t){var e=this[t]();return e?new zi(e,e,this._getProjection()):null}bn.mergeOptions({symbol:{markerType:"path",markerPath:[{path:"M8 23l0 0 0 0 0 0 0 0 0 0c-4,-5 -8,-10 -8,-14 0,-5 4,-9 8,-9l0 0 0 0c4,0 8,4 8,9 0,4 -4,9 -8,14z M3,9 a5,5 0,1,0,0,-0.9Z",fill:"#DE3333"}],markerPathWidth:16,markerPathHeight:23,markerWidth:24,markerHeight:34},hitTestForEvent:!1}),bn.registerJSONType("Marker");var Tn=function(t){function e(e,i){var r;return(r=t.call(this,i)||this).type="LineString",e&&r.setCoordinates(e),r}ne(e,t);var i=e.prototype;return i.setCoordinates=function(t){return t?(this._coordinates=bi.toCoordinates(t),this.getMap()?this._setPrjCoordinates(this._projectCoords(this._coordinates)):this.onShapeChanged(),this):(this._coordinates=null,this._setPrjCoordinates(null),this)},i.getCoordinates=function(){return this._coordinates||[]},i.getCenterInExtent=function(t){return this._getCenterInExtent(t,this.getCoordinates(),Sr)},i._computeGeodesicLength=function(t){return t.measureLength(this.getCoordinates())},i._computeGeodesicArea=function(){return 0},e}(xn);Tn.mergeOptions({arrowStyle:null,arrowPlacement:"vertex-last"}),Tn.registerJSONType("LineString");var Mn=function(t){function e(e,i){var r;return(r=t.call(this,i)||this).type="GeometryCollection",r.setGeometries(e),r}ne(e,t);var i=e.prototype;return i.setGeometries=function(t){for(var e=this._checkGeometries(t||[]),i=this._getSymbol(),r=this.config(),n=e.length-1;n>=0;n--)e[n]._initOptions(r),e[n]._setParent(this),e[n]._setEventParent(this),i&&e[n].setSymbol(i);return this._geometries=e,this.getLayer()&&(this._bindGeometriesToLayer(),this.onShapeChanged()),this},i.getGeometries=function(){return this._geometries||[]},i.forEach=function(t,e){for(var i=this.getGeometries(),r=0,n=i.length;r<n;r++)i[r]&&(e?t.call(e,i[r],r):t(i[r],r));return this},i.filter=function(t,i){if(!t)return new e;var r=[],n=f(t),o=n?t:tt(t);return this.forEach(function(t){var e=n?t:lt(t);(i?o.call(i,e):o(e))&&r.push(t)},this),new e(r)},i.translate=function(t){if(!t)return this;if(this.isEmpty())return this;var e=arguments;return this.forEach(function(t){t&&t.translate&&t.translate.apply(t,e)}),this},i.isEmpty=function(){return!N(this.getGeometries())},i.remove=function(){return this.forEach(function(t){t._unbind()}),sn.prototype.remove.apply(this,arguments)},i.show=function(){return this.options.visible=!0,this.forEach(function(t){t.show()}),this},i.hide=function(){return this.options.visible=!1,this.forEach(function(t){t.hide()}),this},i.onConfig=function(t){this.forEach(function(e){e.config(t)})},i.getSymbol=function(){var e=t.prototype.getSymbol.call(this);if(!e){var i=[],r=!1;this.forEach(function(t){t.getSymbol()&&!r&&(r=!0),i.push(t.getSymbol())}),r&&(e={children:i})}return e},i.setSymbol=function(t){if(t&&t.children)this._symbol=null,this.forEach(function(e,i){e.setSymbol(t.children[i])});else{var e=this._prepareSymbol(t);this._symbol=e,this.forEach(function(t){t.setSymbol(e)})}return this.onSymbolChanged(),this},i._setExternSymbol=function(t){return t=this._prepareSymbol(t),this._externSymbol=t,this.forEach(function(e){e._setExternSymbol(t)}),this.onSymbolChanged(),this},i._bindLayer=function(){t.prototype._bindLayer.apply(this,arguments),this._bindGeometriesToLayer()},i._bindGeometriesToLayer=function(){var t=this.getLayer();this.forEach(function(e){e._bindLayer(t)})},i._checkGeometries=function(t){if(t&&!Array.isArray(t)){if(t instanceof sn)return[t];throw new Error("The geometry added to collection is invalid.")}for(var e=0,i=t.length;e<i;e++)if(!this._checkGeo(t[e]))throw new Error("The geometry added to collection is invalid. Index: "+e);return t},i._checkGeo=function(t){return t instanceof sn},i._updateCache=function(){this._clearCache(),this.isEmpty()||this.forEach(function(t){t&&t._updateCache&&t._updateCache()})},i._removePainter=function(){this._painter&&this._painter.remove(),delete this._painter,this.forEach(function(t){t._removePainter()})},i._computeCenter=function(t){if(!t||this.isEmpty())return null;for(var e=0,i=0,r=0,n=this.getGeometries(),o=0,a=n.length;o<a;o++)if(n[o]){var s=n[o]._computeCenter(t);s&&(e+=s.x,i+=s.y,r++)}return 0===r?null:new bi(e/r,i/r)},i._containsPoint=function(t,e){if(this.isEmpty())return!1;for(var i=this.getGeometries(),r=0,n=i.length;r<n;r++)if(i[r]._containsPoint(t,e))return!0;return!1},i._computeExtent=function(t){return Rn.call(this,t,"_computeExtent")},i._computePrjExtent=function(t){return Rn.call(this,t,"_computePrjExtent")},i._computeGeodesicLength=function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),i=0,r=0,n=e.length;r<n;r++)e[r]&&(i+=e[r]._computeGeodesicLength(t));return i},i._computeGeodesicArea=function(t){if(!t||this.isEmpty())return 0;for(var e=this.getGeometries(),i=0,r=0,n=e.length;r<n;r++)e[r]&&(i+=e[r]._computeGeodesicArea(t));return i},i._exportGeoJSONGeometry=function(){var t=[];if(!this.isEmpty())for(var e=this.getGeometries(),i=0,r=e.length;i<r;i++)e[i]&&t.push(e[i]._exportGeoJSONGeometry());return{type:"GeometryCollection",geometries:t}},i._clearProjection=function(){if(!this.isEmpty())for(var t=this.getGeometries(),e=0,i=t.length;e<i;e++)t[e]&&t[e]._clearProjection()},i._getConnectPoints=function(){var t=this.getExtent();return[new bi(t.xmin,t.ymax),new bi(t.xmax,t.ymin),new bi(t.xmin,t.ymin),new bi(t.xmax,t.ymax)]},i._getExternalResources=function(){if(this.isEmpty())return[];for(var t,e,i=this.getGeometries(),r=[],n={},o=0,a=i.length;o<a;o++)if(i[o])for(var s=0,h=(t=Mt(i[o]._getInternalSymbol())).length;s<h;s++)n[e=t[s].join()]||(r.push(t[s]),n[e]=1);return r},i.startEdit=function(t){var e=this;if(this.isEmpty())return this;t||(t={}),t.symbol&&(this._originalSymbol=this.getSymbol(),this.setSymbol(t.symbol)),this._draggbleBeforeEdit=this.options.draggable,this.config("draggable",!1);for(var i=this.getGeometries(),r=0,n=i.length;r<n;r++)i[r].startEdit(t);return this._editing=!0,this.hide(),setTimeout(function(){e.fire("editstart")},1),this},i.endEdit=function(){if(this.isEmpty())return this;for(var t=this.getGeometries(),e=0,i=t.length;e<i;e++)t[e].endEdit();return this._originalSymbol&&(this.setSymbol(this._originalSymbol),delete this._originalSymbol),this._editing=!1,this.show(),this.config("draggable",this._draggbleBeforeEdit),this.fire("editend"),this},i.isEditing=function(){return!!this._editing},e}(sn);function Rn(t,e){if(this.isEmpty())return null;for(var i=this.getGeometries(),r=null,n=0,o=i.length;n<o;n++){var a=i[n];if(a){var s=a[e](t);s&&(r=s.combine(r))}}return r}Mn.registerJSONType("GeometryCollection");var An=function(t){function e(e,i,r,n){var o;return(o=t.call(this,null,n)||this).GeometryType=e,o.type=i,o._initData(r),o}ne(e,t);var i=e.prototype;return i.getCoordinates=function(){for(var t=[],e=this.getGeometries(),i=0,r=e.length;i<r;i++){var n=e[i];t.push(n.getShell&&"Polygon"!==n.getJSONType()?[n.getShell()]:n.getCoordinates())}return t},i.setCoordinates=function(t){for(var e=[],i=0,r=(t=t||[]).length;i<r;i++){var n=new this.GeometryType(t[i],this.config());e.push(n)}return this.setGeometries(e),this},i._initData=function(t){(t=t||[]).length&&(t[0]instanceof this.GeometryType?this.setGeometries(t):this.setCoordinates(t))},i._checkGeo=function(t){return t instanceof this.GeometryType},i._exportGeoJSONGeometry=function(){var t=this.getCoordinates(),e=bi.toNumberArrays(t);return{type:this.getType(),coordinates:e}},e}(Mn),Cn=function(t){function e(e,i){return t.call(this,bn,"MultiPoint",e,i)||this}return ne(e,t),e.prototype.findClosest=function(t){if(!t)return null;var e=null,i=1/0;return this.getCoordinates().forEach(function(r){var n,o,a,s,h=(n=r,a=(o=t).x-n.x,s=o.y-n.y,Math.sqrt(a*a+s*s));h<i&&(e=r,i=h)}),e},e}(An);Cn.registerJSONType("MultiPoint");var Pn=function(t){function e(){return t.apply(this,arguments)||this}return ne(e,t),e.prototype.getCenterInExtent=function(t){var e=0,i=0,r=0;return this.getGeometries().forEach(function(n){var o=n.getCenterInExtent(t);o&&(e+=o.x*o.count,i+=o.y*o.count,r+=o.count)}),0===r?null:new bi(e,i)._multi(1/r)},e}(An),Dn=function(t){function e(e,i){return t.call(this,Tn,"MultiLineString",e,i)||this}return ne(e,t),e}(Pn);Dn.registerJSONType("MultiLineString");var Ln=function(t){function e(e,i){return t.call(this,_n,"MultiPolygon",e,i)||this}return ne(e,t),e}(Pn);Ln.registerJSONType("MultiPolygon");var On={Marker:bn,LineString:Tn,Polygon:_n,MultiPoint:Cn,MultiLineString:Dn,MultiPolygon:Ln},Hn={toGeometry:function(t,e){if(d(t)&&(t=A(t)),Array.isArray(t)){for(var i=[],r=0,n=t.length;r<n;r++){var o=Hn._convert(t[r],e);Array.isArray(o)?C(i,o):i.push(o)}return i}return Hn._convert(t,e)},_convert:function(t,e){if(!t||l(t.type))return null;var i=t.type;if("Feature"===i){var r=t.geometry,n=Hn._convert(r,e);return n?(n.setId(t.id),n.setProperties(t.properties),n):null}if("FeatureCollection"===i){var o=t.features;return o?Hn.toGeometry(o,e):null}if(["Point","LineString","Polygon","MultiPoint","MultiLineString","MultiPolygon"].indexOf(i)>=0){var a=new On["Point"===i?"Marker":i](t.coordinates);return e&&e(a),a}if("GeometryCollection"===i){var s=t.geometries;if(!N(s)){var h=new Mn;return e&&e(h),h}for(var c=[],u=s.length,p=0;p<u;p++)c.push(Hn._convert(s[p]));var d=new Mn(c);return e&&e(d),d}return null}},In=function(t){function e(e,i,r){var n;return n=t.call(this,null,r)||this,e&&n.setCoordinates(e),n._radius=i,n}ne(e,t),e.fromJSON=function(t){var i=t.feature,r=new e(t.coordinates,t.radius,t.options);return r.setProperties(i.properties),r};var i=e.prototype;return i.getRadius=function(){return this._radius},i.setRadius=function(t){return this._radius=t,this.onShapeChanged(),this},i.getShell=function(){for(var t,e,i,r=this._getMeasurer(),n=this.getCoordinates(),o=this.options.numberOfShellPoints,a=this.getRadius(),s=[],h=0,l=o-1;h<l;h++){t=360*h/l*Math.PI/180,e=a*Math.cos(t),i=a*Math.sin(t);var c=r.locate(n,e,i);s.push(c)}return s.push(s[0]),s},i.getHoles=function(){return[]},i.animateShow=function(){return this.show()},i._containsPoint=function(e,i){var r=this.getMap();if(r.getPitch())return t.prototype._containsPoint.call(this,e,i);var n=r._pointToContainerPoint(this._getCenter2DPoint()),o=this.getSize(),a=l(i)?this._hitTestTolerance():i;return Cr(e,n,n.add(o.width/2,o.height/2),a)},i._computePrjExtent=function(t){var e=this._getMinMax(t);if(!e)return null;var i=this._getPrjCoordinates(),r=e.map(function(e){return t.project(e)}),n=Math.min(Math.abs(r[0].x-i.x),Math.abs(r[1].x-i.x)),o=Math.min(Math.abs(r[2].y-i.y),Math.abs(r[3].y-i.y));return new zi(i.sub(n,o),i.add(n,o))},i._computeExtent=function(t){var e=this._getMinMax(t);return e?new zi(e[0].x,e[2].y,e[1].x,e[3].y,this._getProjection()):null},i._getMinMax=function(t){if(!t||!this._coordinates||l(this._radius))return null;var e=this._radius;return[t.locate(this._coordinates,-e,0),t.locate(this._coordinates,e,0),t.locate(this._coordinates,0,e),t.locate(this._coordinates,0,-e)]},i._computeGeodesicLength=function(){return l(this._radius)?0:2*Math.PI*this._radius},i._computeGeodesicArea=function(){return l(this._radius)?0:Math.PI*Math.pow(this._radius,2)},i._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:bi.toNumberArrays([this.getShell()])}},i._toJSON=function(t){var e=this.getCenter(),i=h({},t);i.geometry=!1;var r=this.toGeoJSON(i);return r.geometry={type:"Polygon"},{feature:r,subType:"Circle",coordinates:[e.x,e.y],radius:this.getRadius()}},e}(wn(_n));In.mergeOptions({numberOfShellPoints:60}),In.registerJSONType("Circle");var Bn=function(t){function e(e,i,r,n){var o;return o=t.call(this,null,n)||this,e&&o.setCoordinates(e),o.width=i,o.height=r,o}ne(e,t),e.fromJSON=function(t){var i=t.feature,r=new e(t.coordinates,t.width,t.height,t.options);return r.setProperties(i.properties),r};var i=e.prototype;return i.getWidth=function(){return this.width},i.setWidth=function(t){return this.width=t,this.onShapeChanged(),this},i.getHeight=function(){return this.height},i.setHeight=function(t){return this.height=t,this.onShapeChanged(),this},i.getShell=function(){for(var t,e,i,r,n=this._getMeasurer(),o=this.getCoordinates(),a=this.options.numberOfShellPoints,s=this.getWidth(),h=this.getHeight(),l=[],c=Math.pow(s/2,2)*Math.pow(h/2,2),u=Math.pow(s/2,2),p=Math.pow(h/2,2),d=0;d<a;d++){e=(t=360*d/a)*Math.PI/180,i=Math.sqrt(c/(u*Math.pow(Math.tan(e),2)+p)),r=Math.sqrt(c/(p*Math.pow(1/Math.tan(e),2)+u)),t>90&&t<270&&(i*=-1),t>180&&t<360&&(r*=-1);var f=n.locate(o,i,r);l.push(f)}return l},i.getHoles=function(){return[]},i.animateShow=function(){return this.show()},i._containsPoint=function(e,i){var r=this.getMap();if(r.isTransforming())return t.prototype._containsPoint.call(this,e,i);var n=r.getProjection(),o=l(i)?this._hitTestTolerance():i,a=n.projectCoords([this._coordinates,r.locate(this._coordinates,this.getWidth()/2,this.getHeight()/2)]);return Cr(e,r._prjToContainerPoint(a[0]),r._prjToContainerPoint(a[1]),o)},i._computePrjExtent=function(){return In.prototype._computePrjExtent.apply(this,arguments)},i._computeExtent=function(){return In.prototype._computeExtent.apply(this,arguments)},i._getMinMax=function(t){if(!t||!this._coordinates||l(this.width)||l(this.height))return null;var e=this.getWidth(),i=this.getHeight();return[t.locate(this._coordinates,-e/2,0),t.locate(this._coordinates,e/2,0),t.locate(this._coordinates,0,-i/2),t.locate(this._coordinates,0,i/2)]},i._computeGeodesicLength=function(){if(l(this.width)||l(this.height))return 0;var t=this.width>this.height?this.width:this.height;return 2*Math.PI*t/2-4*Math.abs(this.width-this.height)},i._computeGeodesicArea=function(){return l(this.width)||l(this.height)?0:Math.PI*this.width*this.height/4},i._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:bi.toNumberArrays([this.getShell()])}},i._toJSON=function(t){var e=h({},t),i=this.getCenter();e.geometry=!1;var r=this.toGeoJSON(e);return r.geometry={type:"Polygon"},{feature:r,subType:"Ellipse",coordinates:[i.x,i.y],width:this.getWidth(),height:this.getHeight()}},e}(wn(_n));Bn.mergeOptions({numberOfShellPoints:80}),Bn.registerJSONType("Ellipse");var zn=function(t){function e(e,i,r,n){var o;return o=t.call(this,null,n)||this,e&&o.setCoordinates(e),o._width=i,o._height=r,o}ne(e,t),e.fromJSON=function(t){var i=t.feature,r=new e(t.coordinates,t.width,t.height,t.options);return r.setProperties(i.properties),r};var i=e.prototype;return i.getCoordinates=function(){return this._coordinates},i.setCoordinates=function(t){if(this._coordinates=t instanceof bi?t:new bi(t),!this._coordinates||!this.getMap())return this.onPositionChanged(),this;var e=this._getProjection();return this._setPrjCoordinates(e.project(this._coordinates)),this},i.getWidth=function(){return this._width},i.setWidth=function(t){return this._width=t,this.onShapeChanged(),this},i.getHeight=function(){return this._height},i.setHeight=function(t){return this._height=t,this.onShapeChanged(),this},i.getShell=function(){var t=this._getMeasurer(),e=this._coordinates,i=this.getMap(),r=1,n=-1;if(i){var o=i.getFullExtent();o.left>o.right&&(r=-1),o.bottom>o.top&&(n=1)}var a=[];return a.push(e),a.push(t.locate(e,r*this._width,0)),a.push(t.locate(e,r*this._width,n*this._height)),a.push(t.locate(e,0,n*this._height)),a.push(e),a},i.getHoles=function(){return[]},i.animateShow=function(){return this.show()},i._getPrjCoordinates=function(){var t=this._getProjection();return t?(this._verifyProjection(),this._pnw||this._coordinates&&(this._pnw=t.project(this._coordinates)),this._pnw):null},i._setPrjCoordinates=function(t){this._pnw=t,this.onPositionChanged()},i._getPrjShell=function(){var e=t.prototype._getPrjShell.call(this),i=this._getProjection();if(!i.isSphere())return e;for(var r=i.getSphereExtent(),n=r.sx,o=r.sy,a=this._getProjection().getCircum(),s=e[0],h=1,l=e.length;h<l;h++){var c=e[h],u=0,p=0;n*(s.x-c.x)>0&&(u=a.x*n),o*(s.y-c.y)<0&&(p=a.y*o),e[h]._add(u,p)}return e},i._updateCache=function(){this._clearCache();var t=this._getProjection();this._pnw&&t&&(this._coordinates=t.unproject(this._pnw))},i._clearProjection=function(){this._pnw=null,t.prototype._clearProjection.call(this)},i._computeCenter=function(t){return t.locate(this._coordinates,this._width/2,-this._height/2)},i._containsPoint=function(e,i){var r=this.getMap();if(r.isTransforming())return t.prototype._containsPoint.call(this,e,i);var n=l(i)?this._hitTestTolerance():i,o=r._getResolution()*n,a=this._getPrjExtent().expand(o),s=r._containerPointToPrj(e);return a.contains(s)},i._computePrjExtent=function(t){var e=this._getSouthEast(t);if(!e)return null;var i=t.projectCoords([new bi(this._coordinates.x,e.y),new bi(e.x,this._coordinates.y)]);return new zi(i[0],i[1])},i._computeExtent=function(t){var e=this._getSouthEast(t);return e?new zi(this._coordinates,e,this._getProjection()):null},i._getSouthEast=function(t){if(!t||!this._coordinates||l(this._width)||l(this._height))return null;var e=this.getWidth(),i=-this.getHeight();if(t.fullExtent){var r=t.fullExtent;e*=r.right>r.left?1:-1,i*=r.top>r.bottom?1:-1}return t.locate(this._coordinates,e,i)},i._computeGeodesicLength=function(){return l(this._width)||l(this._height)?0:2*(this._width+this._height)},i._computeGeodesicArea=function(){return l(this._width)||l(this._height)?0:this._width*this._height},i._exportGeoJSONGeometry=function(){return{type:"Polygon",coordinates:bi.toNumberArrays([this.getShell()])}},i._toJSON=function(t){var e=h({},t),i=this.getCoordinates();e.geometry=!1;var r=this.toGeoJSON(e);return r.geometry={type:"Polygon"},{feature:r,subType:"Rectangle",coordinates:[i.x,i.y],width:this.getWidth(),height:this.getHeight()}},e}(_n);zn.registerJSONType("Rectangle");var Nn=function(t){function e(e,i,r,n,o){var a;return(a=t.call(this,e,i,o)||this).startAngle=r,a.endAngle=n,a}ne(e,t),e.fromJSON=function(t){var i=t.feature,r=new e(t.coordinates,t.radius,t.startAngle,t.endAngle,t.options);return r.setProperties(i.properties),r};var i=e.prototype;return i.getStartAngle=function(){return this.startAngle},i.setStartAngle=function(t){return this.startAngle=t,this.onShapeChanged(),this},i.getEndAngle=function(){return this.endAngle},i.setEndAngle=function(t){return this.endAngle=t,this.onShapeChanged(),this},i.getShell=function(){for(var t,e,i,r=this._getMeasurer(),n=this.getCoordinates(),o=this.options.numberOfShellPoints-2,a=this.getRadius(),s=[n.copy()],h=this.getStartAngle(),l=this.getEndAngle()-h,c=0;c<o;c++){t=(l*c/(o-1)+h)*Math.PI/180,e=a*Math.cos(t),i=a*Math.sin(t);var u=r.locate(n,e,i);s.push(u)}return s.push(n.copy()),s},i._containsPoint=function(e,i){var r=this.getMap();if(r.isTransforming())return t.prototype._containsPoint.call(this,e,i);var n=r._pointToContainerPoint(this._getCenter2DPoint()),o=l(i)?this._hitTestTolerance():i,a=this.getSize(),s=n,h=e,c=h.x-s.x,u=s.y-h.y,p=Math.atan2(u,c),d=p<0?360*(p+2*Math.PI)/(2*Math.PI):360*p/(2*Math.PI),f=this.startAngle%360,m=this.endAngle%360,g=!1;return g=f>m?!(d>m&&d<f):d>=f&&d<=m,h.distanceTo(s)<=a.width/2+o&&g},i._computeGeodesicLength=function(){return l(this._radius)?0:2*Math.PI*this._radius*Math.abs(this.startAngle-this.endAngle)/360+2*this._radius},i._computeGeodesicArea=function(){return l(this._radius)?0:Math.PI*Math.pow(this._radius,2)*Math.abs(this.startAngle-this.endAngle)/360},i._toJSON=function(t){var e=h({},t),i=this.getCenter();e.geometry=!1;var r=this.toGeoJSON(e);return r.geometry={type:"Polygon"},{feature:r,subType:"Sector",coordinates:[i.x,i.y],radius:this.getRadius(),startAngle:this.getStartAngle(),endAngle:this.getEndAngle()}},e}(In);Nn.mergeOptions({numberOfShellPoints:60}),Nn.registerJSONType("Sector");var kn=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i._arc=function(t,e,i){for(var r=this.options.arcDegree*Math.PI/180,n=1,o=e.length;n<o;n++){var a=ni._arcBetween(t,e[n-1],e[n],r),s=[e[n-1].x+e[n].x-a[0],e[n-1].y+e[n].y-a[1]];e[n-1].nextCtrlPoint=s,e[n].prevCtrlPoint=s,ni._stroke(t,i)}},i._quadraticCurve=function(t,e){if(e.length<=2)ni._path(t,e);else{var i,r;for(i=2,r=e.length;i<r;i+=2)t.quadraticCurveTo(e[i-1].x,e[i-1].y,e[i].x,e[i].y);if((i-=1)<r)for(;i<r;i++)t.lineTo(e[i].x,e[i].y)}},i._bezierCurve=function(t,e){if(e.length<=3)ni._path(t,e);else{var i,r;for(i=1,r=e.length;i+2<r;i+=3)t.bezierCurveTo(e[i].x,e[i].y,e[i+1].x,e[i+1].y,e[i+2].x,e[i+2].y);if(i<r)for(;i<r;i++)t.lineTo(e[i].x,e[i].y)}},i._getCurveArrowPoints=function(t,e,i,r,n,o){var a,s=e.length;for(a=o;a<s;a+=o)t.push(this._getArrowShape(e[a-1],e[a],i,r,n));if((a-=o)<s-1)for(a+=1;a<s;a++)t.push(this._getArrowShape(e[a-1],e[a],i,r,n))},e}(Tn);kn.mergeOptions({enableSimplify:!1,enableClip:!1});var jn=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"ArcCurve"}},i._paintOn=function(t,e,i){t.beginPath(),this._arc(t,e,i),ni._stroke(t,i),this._paintArrow(t,e,i)},e.fromJSON=function(t){var i=t.feature,r=new e(i.geometry.coordinates,t.options);return r.setProperties(i.properties),r},e}(kn);jn.registerJSONType("ArcCurve"),jn.mergeOptions({arcDegree:90});var Vn=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t),e.fromJSON=function(t){var i=t.feature,r=new e(i.geometry.coordinates,t.options);return r.setProperties(i.properties),r};var i=e.prototype;return i._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"CubicBezierCurve"}},i._paintOn=function(t,e,i){t.beginPath(),t.moveTo(e[0].x,e[0].y),this._bezierCurve(t,e),ni._stroke(t,i),this._paintArrow(t,e,i)},i._getArrowPoints=function(t,e,i,r,n){return this._getCurveArrowPoints(t,e,i,r,n,3)},e}(kn);Vn.registerJSONType("CubicBezierCurve");var Fn=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t),e.fromJSON=function(t){var i=t.feature,r=new e(i.geometry.coordinates,t.options);return r.setProperties(i.properties),r};var i=e.prototype;return i._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"QuadBezierCurve"}},i._paintOn=function(t,e,i){t.beginPath(),t.moveTo(e[0].x,e[0].y),this._quadraticCurve(t,e,i),ni._stroke(t,i),this._paintArrow(t,e,i)},i._getArrowPoints=function(t,e,i,r,n){return this._getCurveArrowPoints(t,e,i,r,n,2)},e}(kn);Fn.registerJSONType("QuadBezierCurve");var Un={textFaceName:"monospace",textSize:12,textLineSpacing:8,textWrapCharacter:"\n",textHorizontalAlignment:"middle",textVerticalAlignment:"middle"},Gn={markerType:"square",markerLineColor:"#000",markerLineWidth:2,markerLineOpacity:1,markerFill:"#fff",markerOpacity:1},Wn=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.getContent=function(){return this._content},i.setContent=function(t){var e=this._content;return this._content=ue(t),this._refresh(),this._fireEvent("contentchange",{old:e,new:t}),this},i.onAdd=function(){this._refresh()},i.toJSON=function(){var e=t.prototype.toJSON.call(this);return delete e.symbol,e},i.setSymbol=function(e){if(this._refreshing||!e)return t.prototype.setSymbol.call(this,e);var i=this._parseSymbol(e);if(this.setTextStyle){var r=this.getTextStyle()||{};r.symbol=i[0],this.setTextStyle(r)}else this.setTextSymbol&&this.setTextSymbol(i[0]);if(this.setBoxStyle){var n=this.getBoxStyle()||{};n.symbol=i[1],this.setBoxStyle(n)}else this.setBoxSymbol&&this.setBoxSymbol(i[1]);return this},i._parseSymbol=function(t){var e={},i={};for(var r in t)g(t,r)&&(0===r.indexOf("text")?e[r]=t[r]:i[r]=t[r]);return[e,i]},i._getTextSize=function(t){return Se(this._content,t).size},i._getInternalSymbol=function(){return this._symbol},i._getDefaultTextSymbol=function(){return h({},Un)},i._getDefaultBoxSymbol=function(){return h({},Gn)},i._getDefaultPadding=function(){return[12,8]},e}(bn),Xn=function(t){function e(e,i,r,n,o){var a;return void 0===o&&(o={}),(a=t.call(this,i,o)||this)._content=ue(e),a._width=l(r)?100:r,a._height=l(n)?40:n,o.boxSymbol&&a.setBoxSymbol(o.boxSymbol),o.textStyle&&a.setTextStyle(o.textStyle),a._refresh(),a}ne(e,t);var i=e.prototype;return i.getWidth=function(){return this._width},i.setWidth=function(t){return this._width=t,this._refresh(),this},i.getHeight=function(){return this._height},i.setHeight=function(t){return this._height=t,this._refresh(),this},i.getBoxSymbol=function(){return h({},this.options.boxSymbol)},i.setBoxSymbol=function(t){return this.options.boxSymbol=t?h({},t):t,this.getSymbol()&&this._refresh(),this},i.getTextStyle=function(){return this.options.textStyle?h({},this.options.textStyle):null},i.setTextStyle=function(t){return this.options.textStyle=t?h({},t):t,this.getSymbol()&&this._refresh(),this},e.fromJSON=function(t){var i=t.feature,r=new e(t.content,i.geometry.coordinates,t.width,t.height,t.options);return r.setProperties(i.properties),r.setId(i.id),t.symbol&&r.setSymbol(t.symbol),r},i._toJSON=function(t){return{feature:this.toGeoJSON(t),width:this.getWidth(),height:this.getHeight(),subType:"TextBox",content:this._content}},i._refresh=function(){var t=this.getTextStyle()||{},e=t.padding||[12,8],i=this._width-2*e[0],r=this._height-2*e[1],n=h({},t.symbol||this._getDefaultTextSymbol(),this.options.boxSymbol||this._getDefaultBoxSymbol(),{textName:this._content,markerWidth:this._width,markerHeight:this._height,textHorizontalAlignment:"middle",textVerticalAlignment:"middle",textMaxWidth:i,textMaxHeight:r});t.wrap&&!n.textWrapWidth&&(n.textWrapWidth=i);var o=t.horizontalAlignment;n.textDx=n.markerDx||0;var a=n.markerWidth/2-e[0];"left"===o?(n.textHorizontalAlignment="right",n.textDx=n.textDx-a):"right"===o&&(n.textHorizontalAlignment="left",n.textDx=n.textDx+a);var s=t.verticalAlignment;n.textDy=n.markerDy||0;var l=n.markerHeight/2-e[1];"top"===s?(n.textVerticalAlignment="bottom",n.textDy-=l):"bottom"===s&&(n.textVerticalAlignment="top",n.textDy+=l),this._refreshing=!0,this.updateSymbol(n),delete this._refreshing},e}(Wn);Xn.mergeOptions({textStyle:{wrap:!0,padding:[12,8],verticalAlignment:"middle",horizontalAlignment:"middle"},boxSymbol:null}),Xn.registerJSONType("TextBox");var Zn=function(t){function e(e,i,r){var n;return void 0===r&&(r={}),n=t.call(this,i,r)||this,r.textSymbol&&n.setTextSymbol(r.textSymbol),r.boxStyle&&n.setBoxStyle(r.boxStyle),n._content=ue(e),n._refresh(),n}ne(e,t);var i=e.prototype;return i.getBoxStyle=function(){return this.options.boxStyle?h({},this.options.boxStyle):null},i.setBoxStyle=function(t){return this.options.boxStyle=t?h({},t):t,this._refresh(),this},i.getTextSymbol=function(){return h({},this._getDefaultTextSymbol(),this.options.textSymbol)},i.setTextSymbol=function(t){return this.options.textSymbol=t?h({},t):t,this._refresh(),this},e.fromJSON=function(t){var i=t.feature,r=new e(t.content,i.geometry.coordinates,t.options);return r.setProperties(i.properties),r.setId(i.id),t.symbol&&r.setSymbol(t.symbol),r},i._canEdit=function(){return!1},i._toJSON=function(t){return{feature:this.toGeoJSON(t),subType:"Label",content:this._content}},i._refresh=function(){var t=h({},this.getTextSymbol(),{textName:this._content}),e=this.getBoxStyle();if(e){h(t,e.symbol);var i=this._getBoxSize(t),r=i[1],n=e.padding||this._getDefaultPadding(),o=i[0];t.markerWidth=o.width,t.markerHeight=o.height;var a=t.textDx||0,s=t.textDy||0,l=_e(r,t.textHorizontalAlignment,t.textVerticalAlignment)._add(a,s),c=e.horizontalAlignment||"middle";t.markerDx=l.x,"left"===c?t.markerDx+=t.markerWidth/2-n[0]:"right"===c?t.markerDx-=t.markerWidth/2-r.width-n[0]:t.markerDx+=r.width/2;var u=e.verticalAlignment||"middle";t.markerDy=l.y,"top"===u?t.markerDy+=t.markerHeight/2-n[1]:"bottom"===u?t.markerDy-=t.markerHeight/2-r.height-n[1]:t.markerDy+=r.height/2}this._refreshing=!0,this.updateSymbol(t),delete this._refreshing},i._getBoxSize=function(t){t.markerType||(t.markerType="square");var e,i,r=this.getBoxStyle(),n=this._getTextSize(t),o=r.padding||this._getDefaultPadding();return e=n.width+2*o[0],i=n.height+2*o[1],r.minWidth&&(!e||e<r.minWidth)&&(e=r.minWidth),r.minHeight&&(!i||i<r.minHeight)&&(i=r.minHeight),[new he(e,i),n]},e}(Wn);Zn.mergeOptions({boxStyle:null,textSymbol:null}),Zn.registerJSONType("Label");var Yn=function(t){return function(t){function e(){return t.apply(this,arguments)||this}ne(e,t),e._hasConnectors=function(t){return!l(t.__connectors)&&t.__connectors.length>0},e._getConnectors=function(t){return t.__connectors};var i=e.prototype;return i.getConnectSource=function(){return this._connSource},i.setConnectSource=function(t){var e=this._connTarget;return this.onRemove(),this._connSource=t,this._connTarget=e,this.onAdd(),this},i.getConnectTarget=function(){return this._connTarget},i.setConnectTarget=function(t){var e=this._connSource;return this.onRemove(),this._connSource=e,this._connTarget=t,this._updateCoordinates(),this._registerEvents(),this},i._updateCoordinates=function(){var t=this.getMap();if(!t&&this._connSource&&(t=this._connSource.getMap()),!t&&this._connTarget&&(t=this._connTarget.getMap()),t&&this._connSource&&this._connTarget){for(var e,i,r=this._connSource._getConnectPoints(),n=this._connTarget._getConnectPoints(),o=0,a=this.getCoordinates(),s=0,h=r.length;s<h;s++)for(var l=r[s],c=0,u=n.length;c<u;c++){var p=n[c],d=t.computeLength(l,p);0===s&&0===c?(e=l,i=p,o=d):d<o&&(e=l,i=p)}N(a)&&a[0].equals(e)&&a[1].equals(i)||this.setCoordinates([e,i])}},i.onAdd=function(){this._registerEvents(),this._updateCoordinates()},i.onRemove=function(){if(this._connSource&&(this._connSource.__connectors&&P(this,this._connSource.__connectors),this._connSource.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connSource.off("dragstart mousedown mouseover",this._showConnect,this),this._connSource.off("dragend mouseup mouseout",this.hide,this),this._connSource.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connSource),this._connTarget&&(P(this,this._connTarget.__connectors),this._connTarget.off("dragging positionchange",this._updateCoordinates,this).off("remove",this.onRemove,this),this._connTarget.off("show",this._showConnect,this).off("hide",this.hide,this),delete this._connTarget),!(this._connSource instanceof sn&&this._connTarget instanceof sn)){var t=this.getMap();t&&t.off("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}},i._showConnect=function(){this._connSource&&this._connTarget&&this._connSource.isVisible()&&this._connTarget.isVisible()&&(this._updateCoordinates(),this.show())},i._registerEvents=function(){if(this._connSource&&this._connTarget){this._connSource.__connectors||(this._connSource.__connectors=[]),this._connTarget.__connectors||(this._connTarget.__connectors=[]),this._connSource.__connectors.push(this),this._connTarget.__connectors.push(this),this._connSource.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connTarget.on("dragging positionchange",this._updateCoordinates,this).on("remove",this.remove,this),this._connSource.on("show",this._showConnect,this).on("hide",this.hide,this),this._connTarget.on("show",this._showConnect,this).on("hide",this.hide,this);var t=this.options.showOn;if(this.hide(),"moving"===t?(this._connSource.on("dragstart",this._showConnect,this).on("dragend",this.hide,this),this._connTarget.on("dragstart",this._showConnect,this).on("dragend",this.hide,this)):"click"===t?(this._connSource.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this),this._connTarget.on("mousedown",this._showConnect,this).on("mouseup",this.hide,this)):"mouseover"===t?(this._connSource.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this),this._connTarget.on("mouseover",this._showConnect,this).on("mouseout",this.hide,this)):this._showConnect(),!(this._connSource instanceof sn&&this._connTarget instanceof sn)){var e=this.getMap();e&&e.on("movestart moving moveend zoomstart zooming zoomend rotate pitch fovchange spatialreferencechange",this._updateCoordinates,this)}}},e}(t)},qn={showOn:"always"},Jn=function(t){function e(e,i,r){var n;return n=t.call(this,null,r)||this,1===arguments.length&&(r=e,e=null,i=null),n._connSource=e,n._connTarget=i,n}return ne(e,t),e}(Yn(Tn));Jn.mergeOptions(qn),Jn.registerJSONType("ConnectorLine");var Qn=function(t){function e(e,i,r){var n;return n=t.call(this,null,r)||this,1===arguments.length&&(r=e,e=null,i=null),n._connSource=e,n._connTarget=i,n}return ne(e,t),e}(Yn(jn));Qn.mergeOptions(qn),Qn.registerJSONType("ArcConnectorLine");var Kn=new ki,$n=function(t){function e(e,r,n){var o;return r&&!(r instanceof sn)&&!Array.isArray(r)&&i.indexOf(r.type)<0&&(n=r,r=null),(o=t.call(this,e,n)||this)._maxZIndex=0,o._minZIndex=0,o._initCache(),r&&o.addGeometry(r),o}ne(e,t);var r=e.prototype;return r.getGeometryById=function(t){return l(t)||""===t?null:this._geoMap[t]?this._geoMap[t]:null},r.getGeometries=function(t,e){if(!t)return this._geoList.slice(0);for(var i,r=[],n=0,o=this._geoList.length;n<o;n++)i=this._geoList[n],(e?t.call(e,i):t(i))&&r.push(i);return r},r.getFirstGeometry=function(){return this._geoList.length?this._geoList[0]:null},r.getLastGeometry=function(){var t=this._geoList.length;return 0===t?null:this._geoList[t-1]},r.getCount=function(){return this._geoList.length},r.getExtent=function(){if(0===this.getCount())return null;var t=new zi(this.getProjection());return this.forEach(function(e){t._combine(e.getExtent())}),t},r.forEach=function(t,e){for(var i=this._geoList.slice(0),r=0,n=i.length;r<n;r++)e?t.call(e,i[r],r):t(i[r],r);return this},r.filter=function(t,e){var i=[],r=f(t),n=r?t:tt(t);return this.forEach(function(t){var o=r?t:lt(t);(e?n.call(e,o):n(o))&&i.push(t)},this),i},r.isEmpty=function(){return!this._geoList.length},r.addGeometry=function(t,e){if(!t)return this;if("FeatureCollection"===t.type)return this.addGeometry(Hn.toGeometry(t),e);if(!Array.isArray(t)){var i=arguments.length,r=arguments[i-1];return t=Array.prototype.slice.call(arguments,0,i-1),e=r,p(r)&&(t.push(r),e=!1),this.addGeometry(t,e)}if(0===t.length)return this;var n;this._initCache(),!0===e&&(n=new zi),this._toSort=this._maxZIndex>0;for(var o=[],a=0,s=t.length;a<s;a++){var h=t[a];if(!h)throw new Error("Invalid geometry to add to layer("+this.getId()+") at index:"+a);if(!(h instanceof sn)&&(h=sn.fromJSON(h),Array.isArray(h)))for(var c=0,u=h.length;c<u;c++)this._add(h[c],n,a),o.push(h[c]);Array.isArray(h)||(this._add(h,n,a),o.push(h))}var d=this.getMap();if(d&&(this._getRenderer().onGeometryAdd(o),!0===e&&!l(n.xmin))){var f=d.getFitZoom(n);d.setCenterAndZoom(n.getCenter(),f)}return this.fire("addgeo",{geometries:t}),this},r.getGeoMinZIndex=function(){return this._minZIndex},r.getGeoMaxZIndex=function(){return this._maxZIndex},r._add=function(t,e,i){this._toSort||(this._toSort=0!==t.getZIndex()),this._updateZIndex(t.getZIndex());var r=t.getId();if(!l(r)){if(!l(this._geoMap[r]))throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+r+", at index:"+i);this._geoMap[r]=t}var n=M();t._setInternalId(n),this._geoList.push(t),this.onAddGeometry&&this.onAddGeometry(t),t._bindLayer(this),t.onAdd&&t.onAdd(),e&&e._combine(t.getExtent()),t._fireEvent("add",{layer:this})},r.removeGeometry=function(t){if(!Array.isArray(t))return this.removeGeometry([t]);for(var e=t.length-1;e>=0;e--)t[e]instanceof sn||(t[e]=this.getGeometryById(t[e])),t[e]&&this===t[e].getLayer()&&t[e].remove();return this.fire("removegeo",{geometries:t}),this},r.clear=function(){this._clearing=!0,this.forEach(function(t){t.remove()}),this._geoMap={};var t=this._geoList;return this._geoList=[],this._getRenderer()&&this._getRenderer().onGeometryRemove(t),this._clearing=!1,this.fire("clear"),this},r.onRemoveGeometry=function(t){if(t&&!this._clearing&&(this===t.getLayer()&&!l(t._getInternalId()))){var e=t.getId();l(e)||delete this._geoMap[e];var i=this._findInList(t);i>=0&&this._geoList.splice(i,1),this._getRenderer()&&this._getRenderer().onGeometryRemove([t])}},r.hide=function(){for(var t=0,e=this._geoList.length;t<e;t++)this._geoList[t].onHide();return lr.prototype.hide.call(this)},r.identify=function(t,e){return void 0===e&&(e={}),this._hitGeos(this._geoList,t,e)},r._hitGeos=function(t,e,i){void 0===i&&(i={});for(var r=i.filter,n=i.tolerance,o=[],a=this.getMap(),s=a.coordToPoint(e),h=a._pointToContainerPoint(s,void 0,0,s),l=t.length-1;l>=0;l--){var c=t[l];if(c&&c.isVisible()&&c._getPainter()&&c.options.interactive){if(!(c instanceof Tn&&(c._getArrowStyle()||c instanceof kn))){var u=c.getContainerExtent(Kn);if(n&&(u=u._expand(n)),!u||!u.contains(h))continue}if(c._containsPoint(h,n)&&(!r||r(c))&&(o.push(c),i.count&&o.length>=i.count))break}}return o},r._initCache=function(){this._geoList||(this._geoList=[],this._geoMap={})},r._updateZIndex=function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];this._maxZIndex=Math.max(this._maxZIndex,Math.max.apply(Math,e)),this._minZIndex=Math.min(this._minZIndex,Math.min.apply(Math,e))},r._sortGeometries=function(){var t=this;this._toSort&&(this._maxZIndex=0,this._minZIndex=0,this._geoList.sort(function(e,i){return t._updateZIndex(e.getZIndex(),i.getZIndex()),t._compare(e,i)}),this._toSort=!1)},r._compare=function(t,e){return t.getZIndex()===e.getZIndex()?t._getInternalId()-e._getInternalId():t.getZIndex()-e.getZIndex()},r._findInList=function(t){var e=this._geoList.length;if(0===e)return-1;for(var i,r=0,n=e-1;r<=n;){if(i=Math.floor((r+n)/2),this._geoList[i]===t)return i;this._compare(this._geoList[i],t)>0?n=i-1:r=i+1}return-1},r._onGeometryEvent=function(t){if(t&&t.target){var e=t.type;"idchange"===e?this._onGeometryIdChange(t):"zindexchange"===e?this._onGeometryZIndexChange(t):"positionchange"===e?this._onGeometryPositionChange(t):"shapechange"===e?this._onGeometryShapeChange(t):"symbolchange"===e?this._onGeometrySymbolChange(t):"show"===e?this._onGeometryShow(t):"hide"===e?this._onGeometryHide(t):"propertieschange"===e&&this._onGeometryPropertiesChange(t)}},r._onGeometryIdChange=function(t){if(t.new!==t.old||!this._geoMap[t.old]||this._geoMap[t.old]!==t.target){if(!l(t.new)){if(this._geoMap[t.new])throw new Error("Duplicate geometry id in layer("+this.getId()+"):"+t.new);this._geoMap[t.new]=t.target}l(t.old)||t.new===t.old||delete this._geoMap[t.old]}},r._onGeometryZIndexChange=function(t){t.old!==t.new&&(this._updateZIndex(t.new),this._toSort=!0,this._getRenderer()&&this._getRenderer().onGeometryZIndexChange(t))},r._onGeometryPositionChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryPositionChange(t)},r._onGeometryShapeChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryShapeChange(t)},r._onGeometrySymbolChange=function(t){this._getRenderer()&&this._getRenderer().onGeometrySymbolChange(t)},r._onGeometryShow=function(t){this._getRenderer()&&this._getRenderer().onGeometryShow(t)},r._onGeometryHide=function(t){this._getRenderer()&&this._getRenderer().onGeometryHide(t)},r._onGeometryPropertiesChange=function(t){this._getRenderer()&&this._getRenderer().onGeometryPropertiesChange(t)},e}(lr);$n.mergeOptions({drawImmediate:!1});var to={debug:!1,enableSimplify:!0,geometryEvents:!0,defaultIconSize:[20,20],cacheVectorOnCanvas:!0,cacheSvgOnCanvas:re.gecko,enableAltitude:!1,altitudeProperty:"altitude",drawAltitude:!1},eo=function(t){function e(e,i,r){var n,o=(n=t.call(this,e,i,r)||this).options.style;return delete n.options.style,o&&n.setStyle(o),n}ne(e,t);var i=e.prototype;return i.getStyle=function(){return this._style?this._style:null},i.setStyle=function(t){return this._style=t,this._cookedStyles=ct(t),this.forEach(function(t){this._styleGeometry(t)},this),this.fire("setstyle",{style:t}),this},i.removeStyle=function(){return this._style?(delete this._style,delete this._cookedStyles,this.forEach(function(t){t._setExternSymbol(null)},this),this.fire("removestyle"),this):this},i.onAddGeometry=function(t){this.getStyle()&&this._styleGeometry(t)},i.onConfig=function(e){if(t.prototype.onConfig.call(this,e),e.enableAltitude||e.drawAltitude||e.altitudeProperty){var i=this.getRenderer();i&&i.setToRedraw&&i.setToRedraw()}},i._styleGeometry=function(t){if(!this._cookedStyles)return!1;for(var e=lt(t),i=0,r=this._cookedStyles.length;i<r;i++)if(!0===this._cookedStyles[i].filter(e))return t._setExternSymbol(this._cookedStyles[i].symbol),!0;return!1},i.identify=function(e,i){void 0===i&&(i={});var r=this.getRenderer();return i.onlyVisible&&r&&r.identify?r.identify(e,i):t.prototype.identify.call(this,e,i)},i.toJSON=function(t){t||(t={});var e={type:this.getJSONType(),id:this.getId(),options:this.config()};if((l(t.style)||t.style)&&this.getStyle()&&(e.style=this.getStyle()),l(t.geometries)||t.geometries){var i;if(t.clipExtent){var r=this.getMap(),n=r?r.getProjection():null;i=new zi(t.clipExtent,n)}for(var o=[],a=this.getGeometries(),s=0,h=a.length;s<h;s++){var c=a[s],u=c.getExtent();if(u&&(!i||i.intersects(u))){var p=c.toJSON(t.geometries);o.push(p)}}e.geometries=o}return e},e.fromJSON=function(t){if(!t||"VectorLayer"!==t.type)return null;for(var i=new e(t.id,t.options),r=t.geometries,n=[],o=0;o<r.length;o++){var a=sn.fromJSON(r[o]);a&&n.push(a)}return i.addGeometry(n),t.style&&i.setStyle(t.style),i},e}($n);eo.mergeOptions(to),eo.registerJSONType("VectorLayer");var io="_map_tool",ro=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.addTo=function(t){return t?(this._map=t,t[io]&&t[io].disable(),this.onAdd&&this.onAdd(),this.enable(),t[io]=this,this._fireEvent("add"),this):this},i.getMap=function(){return this._map},i.enable=function(){return!this._map||this._enabled?this:(this._enabled=!0,this._switchEvents("off"),this._registerEvents(),this.onEnable&&this.onEnable(),this._fireEvent("enable"),this)},i.disable=function(){return this._enabled&&this._map?(this._enabled=!1,this._switchEvents("off"),this.onDisable&&this.onDisable(),this._fireEvent("disable"),this):this},i.isEnabled=function(){return!!this._enabled},i.remove=function(){return this._map?(this.disable(),this._map&&(delete this._map[io],delete this._map),this._fireEvent("remove"),this):this},i._registerEvents=function(){this._switchEvents("on")},i._switchEvents=function(t){var e=this.getEvents();e&&this._map[t](e,this)},i._fireEvent=function(t,e){e||(e={}),this.fire(t,e)},e}(fi(gi)),no={},oo=function(t){function e(e){var i;return(i=t.call(this,e)||this)._checkMode(),i._events={click:i._firstClickHandler,mousemove:i._mouseMoveHandler,dblclick:i._doubleClickHandler,mousedown:i._mouseDownHandler,mouseup:i._mouseUpHandler},i}ne(e,t),e.registerMode=function(t,e){no[t.toLowerCase()]=e},e.getRegisterMode=function(t){return no[t.toLowerCase()]};var i=e.prototype;return i.getMode=function(){return this.options.mode?this.options.mode.toLowerCase():null},i.setMode=function(t){return this._geometry&&(this._geometry.remove(),delete this._geometry),this._clearStage(),this._switchEvents("off"),this.options.mode=t,this._checkMode(),this.isEnabled()&&(this._switchEvents("on"),this._restoreMapCfg(),this._saveMapCfg()),this},i.getSymbol=function(){var t=this.options.symbol;return Lt(t||this.options.symbol)},i.setSymbol=function(t){return t?(this.options.symbol=t,this._geometry&&this._geometry.setSymbol(t),this):this},i.getCurrentGeometry=function(){return this._geometry},i.onAdd=function(){this._checkMode()},i.onEnable=function(){if(this._saveMapCfg(),this._drawToolLayer=this._getDrawLayer(),this._clearStage(),this._loadResources(),this.options.autoPanAtEdge){var t=this.getMap();this._mapAutoPanAtEdge=t.options.autoPanAtEdge,this._mapAutoPanAtEdge||t.config({autoPanAtEdge:!0})}return this},i.onDisable=function(){var t=this.getMap();return this._restoreMapCfg(),this.endDraw(),this._map&&(t.removeLayer(this._getDrawLayer()),this.options.autoPanAtEdge&&(this._mapAutoPanAtEdge||t.config({autoPanAtEdge:!1}))),this},i.undo=function(){var t=this._getRegisterMode(),e=t.action;if(!this._shouldRecordHistory(e)||!this._historyPointer)return this;var i=this._clickCoords.slice(0,--this._historyPointer);return t.update(i,this._geometry),this},i.redo=function(){var t=this._getRegisterMode(),e=t.action;if(!this._shouldRecordHistory(e)||l(this._historyPointer)||this._historyPointer===this._clickCoords.length)return this;var i=this._clickCoords.slice(0,++this._historyPointer);return t.update(i,this._geometry),this},i._shouldRecordHistory=function(t){return Array.isArray(t)&&"click"===t[0]&&"mousemove"===t[1]&&"dblclick"===t[2]},i._checkMode=function(){this._getRegisterMode()},i._saveMapCfg=function(){var t=this.getMap();if(this._mapDoubleClickZoom=t.options.doubleClickZoom,t.config({doubleClickZoom:this.options.doubleClickZoom}),this._getRegisterMode().action.indexOf("mousedown")>-1){var e=this.getMap();this._mapDraggable=e.options.draggable,e.config({draggable:!1})}},i._restoreMapCfg=function(){var t=this.getMap();t.config({doubleClickZoom:this._mapDoubleClickZoom}),l(this._mapDraggable)||t.config("draggable",this._mapDraggable),delete this._mapDraggable,delete this._mapDoubleClickZoom},i._loadResources=function(){var t=Mt(this.getSymbol());t.length>0&&this._drawToolLayer._getRenderer().loadResources(t)},i._getProjection=function(){return this._map.getProjection()},i._getRegisterMode=function(){var t=this.getMode(),i=e.getRegisterMode(t);if(!i)throw new Error(t+" is not a valid mode of DrawTool.");return i},i.getEvents=function(){var t=this._getRegisterMode().action,e={};if(Array.isArray(t)){for(var i=0;i<t.length;i++)e[t[i]]=this._events[t[i]];return e}return null},i._mouseDownHandler=function(t){this._createGeometry(t)},i._mouseUpHandler=function(t){this.endDraw(t)},i._firstClickHandler=function(t){var e=this._getRegisterMode(),i=t.coordinate;this._geometry?(l(this._historyPointer)||(this._clickCoords=this._clickCoords.slice(0,this._historyPointer)),this._clickCoords.push(i),this._historyPointer=this._clickCoords.length,t.drawTool=this,e.clickLimit&&e.clickLimit===this._historyPointer?(e.update([i],this._geometry,t),this.endDraw(t)):e.update(this._clickCoords,this._geometry,t),this._fireEvent("drawvertex",t)):this._createGeometry(t)},i._createGeometry=function(t){var e=this.getMode(),i=this._getRegisterMode(),r=t.coordinate,n=this.getSymbol();this._geometry||(this._clickCoords=[r],t.drawTool=this,this._geometry=i.create(this._clickCoords,t),n&&"point"!==e?this._geometry.setSymbol(n):this.options.hasOwnProperty("symbol")&&this._geometry.setSymbol(this.options.symbol),this._addGeometryToStage(this._geometry),this._fireEvent("drawstart",t)),"point"===e&&this.endDraw(t)},i._mouseMoveHandler=function(t){var e=this.getMap(),i=t.coordinate;if(this._geometry&&e&&!e.isInteracting()){var r=this._getMouseContainerPoint(t);if(this._isValidContainerPoint(r)){t.drawTool=this;var n=this._getRegisterMode();if(this._shouldRecordHistory(n.action)){var o=this._clickCoords.slice(0,this._historyPointer);if(o&&o.length>0&&i.equals(o[o.length-1]))return;n.update(o.concat([i]),this._geometry,t)}else n.update([i],this._geometry,t);this._fireEvent("mousemove",t)}}},i._doubleClickHandler=function(t){if(this._geometry){var e=this._getMouseContainerPoint(t);if(this._isValidContainerPoint(e)){var i=this._getRegisterMode(),r=this._clickCoords;if(!(r.length<2)){for(var n=[r[0]],o=1,a=r.length;o<a;o++)r[o].x===r[o-1].x&&r[o].y===r[o-1].y||n.push(r[o]);n.length<2||this._geometry&&this._geometry instanceof _n&&n.length<3||(t.drawTool=this,i.update(n,this._geometry,t),this.endDraw(t))}}}},i._addGeometryToStage=function(t){this._getDrawLayer().addGeometry(t)},i.endDraw=function(t){if(!this._geometry||this._ending)return this;this._ending=!0;var e=this._geometry;return this._clearStage(),t=t||{},this._geometry=e,this._fireEvent("drawend",t),delete this._geometry,this.options.once&&this.disable(),delete this._ending,this},i._clearStage=function(){this._getDrawLayer().clear(),delete this._geometry,delete this._clickCoords},i._getMouseContainerPoint=function(t){return"mousedown"===this._getRegisterMode().action&&Ne(t.domEvent),t.containerPoint},i._isValidContainerPoint=function(t){var e=this._map.getSize(),i=e.width,r=e.height;return!(t.x<0||t.y<0)&&!(t.x>i||t.y>r)},i._getDrawLayer=function(){var t="_maptalks__internal_layer_drawtool",e=this._map.getLayer(t);return e||(e=new eo(t,{enableSimplify:!1}),this._map.addLayer(e)),e},i._fireEvent=function(t,e){e||(e={}),this._geometry&&(e.geometry=this._getRegisterMode().generate(this._geometry,{drawTool:this}).copy()),ro.prototype._fireEvent.call(this,t,e)},e}(ro);oo.mergeOptions({symbol:{lineColor:"#000",lineWidth:2,lineOpacity:1,polygonFill:"#fff",polygonOpacity:.3},doubleClickZoom:!1,mode:null,once:!1,autoPanAtEdge:!1,ignoreMouseleave:!0});var ao=function(t){function e(e){var i;return(i=t.call(this,e)||this).drawTool=new oo({mode:"boxZoom",ignoreMouseleave:!1}),i}ne(e,t);var i=e.prototype;return i.addHooks=function(){this.target.on("_mousedown",this._onMouseDown,this)},i.removeHooks=function(){this.target.off("_mousedown",this._onMouseDown,this),this.drawTool.isEnabled()&&this.drawTool.remove()},i._onMouseDown=function(t){this.target.options.boxZoom&&t.domEvent.shiftKey&&this.drawTool.setSymbol(this.target.options.boxZoomSymbol).on("drawend",this._boxZoom,this).addTo(this.target)},i._boxZoom=function(t){var e=this.target;this.drawTool.remove();var i=t.geometry,r=i.getCenter(),n=i.getSymbol(),o=n.markerWidth,a=n.markerHeight,s=new zi(r,e.locateByPoint(r,o,a),e.getProjection()),h=e.getFitZoom(s);e._animateTo({center:s.getCenter(),zoom:h})},e}(mi);xr.mergeOptions({boxZoom:!0,boxZoomSymbol:{markerType:"rectangle",markerLineWidth:3,markerLineColor:"#1bbc9b",markerLineDasharray:[10,5],markerFillOpacity:.1,markerFill:"#1bbc9b",markerWidth:1,markerHeight:1}}),xr.addOnLoadHook("addHandler","boxZoom",ao);var so=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.addHooks=function(){this.target&&this.target.on("_mousemove",this._onMouseMove,this)},i.removeHooks=function(){this.target&&this.target.off("_mousemove",this._onMouseMove,this)},i._onMouseMove=function(t){var e=this.target;if(e.options.autoPanAtEdge){var i=t.containerPoint,r=e.getContainerExtent();if(r){var n,o=i.x,a=i.y,s=r.xmax,h=r.ymax;o<30&&(n=[Math.abs(o-30),0]),a<30&&(n=[0,Math.abs(a-30)]),o+30>s&&(n=[-Math.abs(o+30-s),0]),a+30>h&&(n=[0,-Math.abs(a+30-h)]),n&&e.panBy(n,{duration:1})}}},e}(mi);xr.mergeOptions({autoPanAtEdge:!1}),xr.addOnLoadHook("addHandler","autoPanAtEdge",so),xr.include({animateTo:function(t,e,i){var r=this;void 0===e&&(e={}),f(e)&&(i=e,e={});var n=this.getProjection(),o=this.getView(),a={},s=!0;for(var h in t)if(g(t,h)&&("prjCenter"===h||!l(o[h])))if(s=!1,"center"===h){var c=new bi(o[h]).toFixed(7),u=new bi(t[h]).toFixed(7);c.equals(u)||(a.center=[c,u])}else if("prjCenter"===h){var p=new bi(this._getPrjCenter()),d=new bi(t[h]);p.equals(d)||(a.prjCenter=[p,d])}else o[h]!==t[h]&&"around"!==h&&(a[h]=[o[h],t[h]]);if(s)return null;this._animPlayer&&(this._isInternalAnimation?(this._animPlayer.pause(),this._prevAnimPlayer=this._animPlayer):(delete this._prevAnimPlayer,this._stopAnim(this._animPlayer)));var m=t.around||new se(this.width/2,this.height/2),v=this._getRenderer(),y=this._animPlayer=vn.animate(a,{easing:e.easing||"out",duration:e.duration||this.options.zoomAnimationDuration,framer:function(t){v.callInNextFrame(t)}},function(t){if(r.isRemoved())y.finish();else{if("running"===y.playState){if(t.styles.center){var o=t.styles.center;r._setPrjCenter(n.project(o)),r.onMoving(r._parseEventFromCoord(r.getCenter()))}else if(t.styles.prjCenter){var s=t.styles.prjCenter;r._setPrjCenter(s),r.onMoving(r._parseEventFromCoord(r.getCenter()))}l(t.styles.zoom)||r.onZooming(t.styles.zoom,m),l(t.styles.pitch)||r.setPitch(t.styles.pitch),l(t.styles.bearing)||r.setBearing(t.styles.bearing),r._fireEvent("animating")}else"finished"===y.playState&&(y._interupted||(a.center?r._setPrjCenter(n.project(a.center[1])):a.prjCenter&&r._setPrjCenter(a.prjCenter[1]),l(a.pitch)||r.setPitch(a.pitch[1]),l(a.bearing)||r.setBearing(a.bearing[1])),r._endAnim(y,a,m,e));i&&i(t)}});return this._startAnim(a,m),y},_animateTo:function(t,e,i){return void 0===e&&(e={}),this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._isInternalAnimation=!0,this._mapAnimPlayer=this.animateTo(t,e,i),delete this._isInternalAnimation,this._mapAnimPlayer},isAnimating:function(){return!!this._animPlayer},isRotating:function(){return this.isDragRotating()||!!this._animRotating},_endAnim:function(t,e,i,r){delete this._animRotating;var n,o=t._interupted?"animateinterrupted":"animateend";if(t===this._animPlayer&&delete this._animPlayer,t===this._mapAnimPlayer&&delete this._mapAnimPlayer,e.center)n=t._interupted?this.getCenter():e.center[1],this.onMoveEnd(this._parseEventFromCoord(n));else if(e.prjCenter){var a;a=t._interupted?this._getPrjCenter():e.prjCenter[1];var s=this._parseEventFromCoord(this.getProjection().unproject(a));s.point2d=this._prjToPoint(a),this.onMoveEnd(s)}l(e.zoom)||(t._interupted?this.onZoomEnd(this.getZoom(),i):r.wheelZoom?this.onZooming(e.zoom[1],i):this.onZoomEnd(e.zoom[1],i)),o&&this._fireEvent(o),l(e.pitch)||this.getPitch()||this.getRenderer().setToRedraw(),this._prevAnimPlayer&&(this._animPlayer=this._prevAnimPlayer,this._prevAnimPlayer.play())},_startAnim:function(t,e){this._animPlayer&&(t.center&&this.onMoveStart(),t.zoom&&!this.isZooming()&&this.onZoomStart(t.zoom[1],e),(t.pitch||t.bearing)&&(this._animRotating=!0),this._fireEvent("animatestart"),this._animPlayer.play())},_stopAnim:function(t){t&&("finished"!==t.playState&&(t._interupted=!0,t.cancel()),t===this._animPlayer&&this._prevAnimPlayer&&(this._animPlayer=this._prevAnimPlayer,this._prevAnimPlayer.play()),t===this._animPlayer&&delete this._animPlayer,t===this._mapAnimPlayer&&delete this._mapAnimPlayer)}});var ho="mousedown mouseup mouseover mouseout mouseenter mouseleave mousemove click dblclick contextmenu keypress touchstart touchmove touchend ";function lo(t,e,i){var r,n,o,a,s,h,l,c,u,p,d,f,m=i[0],g=i[1],v=i[2];return e===t?(t[12]=e[0]*m+e[4]*g+e[8]*v+e[12],t[13]=e[1]*m+e[5]*g+e[9]*v+e[13],t[14]=e[2]*m+e[6]*g+e[10]*v+e[14],t[15]=e[3]*m+e[7]*g+e[11]*v+e[15]):(r=e[0],n=e[1],o=e[2],a=e[3],s=e[4],h=e[5],l=e[6],c=e[7],u=e[8],p=e[9],d=e[10],f=e[11],t[0]=r,t[1]=n,t[2]=o,t[3]=a,t[4]=s,t[5]=h,t[6]=l,t[7]=c,t[8]=u,t[9]=p,t[10]=d,t[11]=f,t[12]=r*m+s*g+u*v+e[12],t[13]=n*m+h*g+p*v+e[13],t[14]=o*m+l*g+d*v+e[14],t[15]=a*m+c*g+f*v+e[15]),t}function co(t,e,i){var r=i[0],n=i[1],o=i[2];return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*n,t[5]=e[5]*n,t[6]=e[6]*n,t[7]=e[7]*n,t[8]=e[8]*o,t[9]=e[9]*o,t[10]=e[10]*o,t[11]=e[11]*o,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function uo(t,e,i){var r=e[0],n=e[1],o=e[2],a=e[3],s=e[4],h=e[5],l=e[6],c=e[7],u=e[8],p=e[9],d=e[10],f=e[11],m=e[12],g=e[13],v=e[14],y=e[15],E=i[0],x=i[1],_=i[2],w=i[3];return t[0]=E*r+x*s+_*u+w*m,t[1]=E*n+x*h+_*p+w*g,t[2]=E*o+x*l+_*d+w*v,t[3]=E*a+x*c+_*f+w*y,E=i[4],x=i[5],_=i[6],w=i[7],t[4]=E*r+x*s+_*u+w*m,t[5]=E*n+x*h+_*p+w*g,t[6]=E*o+x*l+_*d+w*v,t[7]=E*a+x*c+_*f+w*y,E=i[8],x=i[9],_=i[10],w=i[11],t[8]=E*r+x*s+_*u+w*m,t[9]=E*n+x*h+_*p+w*g,t[10]=E*o+x*l+_*d+w*v,t[11]=E*a+x*c+_*f+w*y,E=i[12],x=i[13],_=i[14],w=i[15],t[12]=E*r+x*s+_*u+w*m,t[13]=E*n+x*h+_*p+w*g,t[14]=E*o+x*l+_*d+w*v,t[15]=E*a+x*c+_*f+w*y,t}function po(t,e){var i=e[0],r=e[1],n=e[2],o=e[3],a=e[4],s=e[5],h=e[6],l=e[7],c=e[8],u=e[9],p=e[10],d=e[11],f=e[12],m=e[13],g=e[14],v=e[15],y=i*s-r*a,E=i*h-n*a,x=i*l-o*a,_=r*h-n*s,w=r*l-o*s,b=n*l-o*h,S=c*m-u*f,T=c*g-p*f,M=c*v-d*f,R=u*g-p*m,A=u*v-d*m,C=p*v-d*g,P=y*C-E*A+x*R+_*M-w*T+b*S;return P?(P=1/P,t[0]=(s*C-h*A+l*R)*P,t[1]=(n*A-r*C-o*R)*P,t[2]=(m*b-g*w+v*_)*P,t[3]=(p*w-u*b-d*_)*P,t[4]=(h*M-a*C-l*T)*P,t[5]=(i*C-n*M+o*T)*P,t[6]=(g*x-f*b-v*E)*P,t[7]=(c*b-p*x+d*E)*P,t[8]=(a*A-s*M+l*S)*P,t[9]=(r*M-i*A-o*S)*P,t[10]=(f*w-m*x+v*y)*P,t[11]=(u*x-c*w-d*y)*P,t[12]=(s*T-a*R-h*S)*P,t[13]=(i*R-r*T+n*S)*P,t[14]=(m*E-f*_-g*y)*P,t[15]=(c*_-u*E+p*y)*P,t):null}function fo(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function mo(t,e,i,r){return t[0]=e,t[1]=i,t[2]=r,t}function go(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],t}function vo(t){var e=t[0],i=t[1],r=t[2];return Math.sqrt(e*e+i*i+r*r)}function yo(t,e){var i=e[0],r=e[1],n=e[2],o=i*i+r*r+n*n;return o>0&&(o=1/Math.sqrt(o),t[0]=e[0]*o,t[1]=e[1]*o,t[2]=e[2]*o),t}function Eo(t,e,i){var r=e[0],n=e[1],o=e[2],a=i[0],s=i[1],h=i[2];return t[0]=n*h-o*s,t[1]=o*a-r*h,t[2]=r*s-n*a,t}function xo(t,e,i){var r=e[0],n=e[1],o=e[2],a=1/(i[3]*r+i[7]*n+i[11]*o+i[15]);return t[0]=(i[0]*r+i[4]*n+i[8]*o+i[12])*a,t[1]=(i[1]*r+i[5]*n+i[9]*o+i[13])*a,t[2]=(i[2]*r+i[6]*n+i[10]*o+i[14])*a,t}xr.include({_registerDomEvents:function(){He(this._panels.mapWrapper||this._containerDOM,ho,this._handleDOMEvent,this)},_removeDomEvents:function(){Ie(this._panels.mapWrapper||this._containerDOM,ho,this._handleDOMEvent)},_handleDOMEvent:function(t){var e=t.type;if("contextmenu"===e&&ze(t),!this._ignoreEvent(t)){var i=!1;if("mousedown"===e||"touchstart"===e&&1===t.touches.length)this._mouseDownTime=s();else if("click"===e||"touchend"===e||"contextmenu"===e){if(!this._mouseDownTime)return;var r=this._mouseDownTime;if(delete this._mouseDownTime,s()-r>300){if("click"===e||"contextmenu"===e)return}else"touchend"===e&&(i=!0)}this._fireDOMEvent(this,t,e),i&&(this._clickTime&&s()-this._clickTime<=300?(delete this._clickTime,this._fireDOMEvent(this,t,"dblclick")):(this._clickTime=s(),this._fireDOMEvent(this,t,"click")))}},_ignoreEvent:function(t){if(!t||!this._panels.control)return!1;if(this._isEventOutMap(t))return!0;var e,i=t.srcElement||t.target;if(i)for(;i&&i!==this._containerDOM;){if(i.className&&i.className.indexOf&&(i.className.indexOf("maptalks-control")>=0||i.className.indexOf("maptalks-ui")>=0&&!e.eventsPropagation))return!0;e=i,i=i.parentNode}return!1},_isEventOutMap:function(t){if(this.getPitch()>this.options.maxVisualPitch){var e=Fe(this._getActualEvent(t),this._containerDOM);if(!this.getContainerExtent().contains(e))return!0}return!1},_parseEvent:function(t,e){if(!t)return null;var i={domEvent:t};if("keypress"!==e){var r=this._getActualEvent(t);if(r){var n=Fe(r,this._containerDOM);i=h(i,{coordinate:this.containerPointToCoord(n),containerPoint:n,viewPoint:this.containerPointToViewPoint(n),point2d:this._containerPointToPoint(n)})}}return i},_parseEventFromCoord:function(t){var e=this.coordToContainerPoint(t);return{coordinate:t,containerPoint:e,viewPoint:this.containerPointToViewPoint(e),point2d:this.coordToPoint(t)}},_getActualEvent:function(t){return t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t},_fireDOMEvent:function(t,e,i){if(!this.isRemoved()){var r=this._parseEvent(e,i);this._fireEvent(i,r)}}}),xr.addOnLoadHook("_registerDomEvents"),xr.include({isFullScreen:function(){return!!(document.webkitIsFullScreen||document.mozFullScreen||document.msFullscreenElement||document.fullscreenElement)},requestFullScreen:function(t){return this._fireEvent("fullscreenstart"),this._requestFullScreen(t||this._containerDOM),this._fireEvent("fullscreenend"),this},cancelFullScreen:function(){return this._cancelFullScreen(),this._fireEvent("cancelfullscreen"),this},_requestFullScreen:function(t){if(t.requestFullScreen)t.requestFullScreen();else if(t.mozRequestFullScreen)t.mozRequestFullScreen();else if(t.webkitRequestFullScreen)t.webkitRequestFullScreen();else if(t.msRequestFullScreen)t.msRequestFullScreen();else{var e="fullscreen=1,status=no,resizable=yes,top=0,left=0,scrollbars=no,titlebar=no,menubar=no,location=no,toolbar=no,z-look=yes,width="+(screen.availWidth-8)+",height="+(screen.availHeight-45);null!==window.open(location.href,"_blank",e)&&(window.opener=null,window.close())}},_cancelFullScreen:function(){if(document.cancelFullScreen)document.cancelFullScreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else if(document.webkitCancelFullScreen)document.webkitCancelFullScreen();else{null!==window.open(location.href,"_blank","fullscreen=no,status=yes,resizable=yes,scrollbars=no,titlebar=no,menubar=yes,location=yes,toolbar=yes,z-look=yes")&&(window.opener=null,window.close())}}}),xr.include({panTo:function(t,e,i){if(void 0===e&&(e={}),!t)return this;if(f(e)&&(i=e,e={}),t=new bi(t),void 0===e.animation||e.animation){var r=this.getProjection().project(t);return this._panAnimation(r,e.duration,i)}return this.setCenter(t),this},_panTo:function(t,e){return void 0===e&&(e={}),void 0===e.animation||e.animation?this._panAnimation(t,e.duration):(this.onMoveStart(),this._setPrjCenter(t),this.onMoveEnd(this._parseEventFromCoord(this.getCenter())),this)},panBy:function(t,e,i){if(void 0===e&&(e={}),!t)return this;if(f(e)&&(i=e,e={}),t=new se(t),this.onMoveStart(),void 0===e.animation||e.animation){t=t.multi(-1);var r=this._containerPointToPrj(new se(this.width/2+t.x,this.height/2+t.y));this._panAnimation(r,e.duration,i)}else this._offsetCenterByPixel(t),this.onMoveEnd(this._parseEventFromCoord(this.getCenter()));return this},_panAnimation:function(t,e,i){return this._animateTo({prjCenter:t},{duration:e||this.options.panAnimationDuration},i)}}),sn.fromJSON=function(t){if(Array.isArray(t)){for(var e=[],i=0,r=t.length;i<r;i++){var n=sn.fromJSON(t[i]);Array.isArray(t)?e=e.concat(n):e.push(n)}return e}return t&&!t.feature?Hn.toGeometry(t):(t.subType?(o=sn.getJSONClass(t.subType).fromJSON(t),l(t.feature.id)||o.setId(t.feature.id)):(o=Hn.toGeometry(t.feature),t.options&&o.config(t.options)),t.symbol&&o.setSymbol(t.symbol),t.infoWindow&&o.setInfoWindow(t.infoWindow),o);var o},lr.fromJSON=function(t){if(!t)return null;var e=t.type,i=lr.getJSONClass(e);if(!i||!i.fromJSON)throw new Error("unsupported layer type:"+e);return i.fromJSON(t)},xr.include({JSON_VERSION:"1.0",toJSON:function(t){t||(t={});var e={jsonVersion:this.JSON_VERSION,version:this.VERSION,extent:this.getExtent().toJSON()};e.options=this.config(),e.options.center=this.getCenter(),e.options.zoom=this.getZoom();var i=this.getBaseLayer();(l(t.baseLayer)||t.baseLayer)&&i&&(e.baseLayer=i.toJSON(t.baseLayer));var r={};t.clipExtent&&(!0===t.clipExtent?r.clipExtent=this.getExtent():r.clipExtent=t.clipExtent);var n=[];if(l(t.layers)||t.layers&&!Array.isArray(t.layers)){for(var o=this.getLayers(),a=0,s=o.length;a<s;a++)if(o[a].toJSON){var c=h({},p(t.layers)?t.layers:{},r);n.push(o[a].toJSON(c))}e.layers=n}else if(N(t.layers)){for(var u=t.layers,d=0;d<u.length;d++){var f=u[d],m=this.getLayer(f.id);if(m.toJSON){var g=h({},f.options,r);n.push(m.toJSON(g))}}e.layers=n}else e.layers=[];return e}}),xr.fromJSON=function(t,e,i){if(!t||!e)return null;i||(i={});var r=new xr(t,e.options);if(l(i.baseLayer)||i.baseLayer){var n=lr.fromJSON(e.baseLayer);n&&r.setBaseLayer(n)}if(l(i.layers)||i.layers){for(var o=[],a=e.layers,s=0;s<a.length;s++){var h=lr.fromJSON(a[s]);o.push(h)}r.addLayer(o)}return r},xr.include({computeLength:function(t,e){if(!this.getProjection())return null;var i=new bi(t),r=new bi(e);return i.equals(r)?0:this.getProjection().measureLength(i,r)},computeGeometryLength:function(t){return t._computeGeodesicLength(this.getProjection())},computeGeometryArea:function(t){return t._computeGeodesicArea(this.getProjection())},identify:function(t,e){if(!t)return this;var i=t.layers;if(!N(i))return this;for(var r=[],n=0,o=i.length;n<o;n++)d(i[n])?r.push(this.getLayer(i[n])):r.push(i[n]);for(var a=new bi(t.coordinate),s=h({},t),l=[],c=r.length-1;c>=0&&!(t.count&&l.length>=t.count);c--){var u=r[c];if(u&&u.getMap()&&(t.includeInvisible||u.isVisible())&&(t.includeInternals||!(u.getId().indexOf("_maptalks__internal_layer_")>=0))){var p=u.identify(a,s);p&&(Array.isArray(p)?C(l,p):l.push(p))}}return e.call(this,l),this}}),xr.include({_zoom:function(t,e){this.options.zoomable&&!this.isZooming()&&(e=this._checkZoomOrigin(e),t=this._checkZoom(t),this.onZoomStart(t,e),this._frameZoom=this.getZoom(),this.onZoomEnd(t,e))},_zoomAnimation:function(t,e,i){this.options.zoomable&&!this.isZooming()&&(t=this._checkZoom(t),this.getZoom()!==t&&(e=this._checkZoomOrigin(e),this._startZoomAnim(t,e,i)))},_checkZoomOrigin:function(t){return t&&!this.options.zoomInCenter||(t=new se(this.width/2,this.height/2)),this.options.zoomOrigin&&(t=new se(this.options.zoomOrigin)),t},_startZoomAnim:function(t,e,i){l(i)&&(i=1);var r=this._getResolution(this._startZoomVal)/this._getResolution(t),n=this.options.zoomAnimationDuration*Math.abs(r-i)/Math.abs(r-1);this._frameZoom=this._startZoomVal,this._animateTo({zoom:t,around:e},{continueOnViewChanged:!0,duration:n})},onZoomStart:function(t,e){this.options.zoomable&&!this.isZooming()&&(this._mapAnimPlayer&&this._stopAnim(this._mapAnimPlayer),this._zooming=!0,this._startZoomVal=this.getZoom(),this._startZoomCoord=this._containerPointToPrj(e),this._fireEvent("zoomstart",{from:this._startZoomVal,to:t}))},onZooming:function(t,e,i){if(this.options.zoomable&&this._frameZoom!==t){l(i)&&(i=1),this._zoomTo(t,e);var r=this.getResolution(t),n=this.getResolution(this._startZoomVal)/r/i,o=this._prjToContainerPoint(this._startZoomCoord,this._startZoomVal),a=this.getViewPoint();if(!this.isRotating()&&!o.equals(e)&&1!==n){var s=this.getPitch(),h=o._sub(e)._multi(1/(1-n));s&&(h.y/=Math.cos(s*Math.PI/180)),e=e.add(h)}var c={view:[n,0,0,n,(e.x-a.x)*(1-n),(e.y-a.y)*(1-n)]},u=this.getDevicePixelRatio();1!==u&&(e=e.multi(u)),c.container=[n,0,0,n,e.x*(1-n),e.y*(1-n)],this._fireEvent("zooming",{from:this._startZoomVal,to:t,origin:e,matrix:c}),this._frameZoom=t}},onZoomEnd:function(t,e){if(this.options.zoomable){var i=this._startZoomVal;this._zoomTo(t,e),this._zooming=!1,this._getRenderer().onZoomEnd(),this._fireEvent("zoomend",{from:i,to:t}),this._verifyExtent(this._getPrjCenter())||this._panTo(this._prjMaxExtent.getCenter())}},_zoomTo:function(t,e){this._zoomLevel=t,this._calcMatrices(),e&&this._setPrjCoordAtContainerPoint(this._startZoomCoord,e)},_checkZoom:function(t){var e=this.getMaxZoom(),i=this.getMinZoom();return t<i&&(t=i),t>e&&(t=e),t}});var _o,wo,bo,So,To,Mo,Ro,Ao,Co,Po,Do,Lo=Math.PI/180,Oo=new bi(0,0);function Ho(){return fo(new Array(16))}xr.include({getFov:function(){return this._fov||(this._fov=.6435011087932844),this._fov/Lo},setFov:function(t){if(this.isZooming())return this;if(t=Math.max(.01,Math.min(60,t)),this._fov===t)return this;var e=this.getFov();return this._fov=t*Lo,this._calcMatrices(),this._renderLayers(),this._fireEvent("fovchange",{from:e,to:this.getFov()}),this},getBearing:function(){return this._angle?-this._angle/Lo:0},setBearing:function(t){if(re.ie9)throw new Error("map can't rotate in IE9.");var e=-B(t,-180,180)*Lo;if(this._angle===e)return this;var i=this.getBearing();return this._fireEvent("rotatestart",{from:i,to:e}),this._angle=e,this._calcMatrices(),this._renderLayers(),this._fireEvent("rotate",{from:i,to:e}),this._fireEvent("rotateend",{from:i,to:e}),this},getPitch:function(){return this._pitch?this._pitch/Math.PI*180:0},setPitch:function(t){if(re.ie9)throw new Error("map can't tilt in IE9.");var e=z(t,0,this.options.maxPitch)*Lo;if(this._pitch===e)return this;var i=this.getPitch();return this._fireEvent("pitchstart",{from:i,to:e}),this._pitch=e,this._calcMatrices(),this._renderLayers(),this._fireEvent("pitch",{from:i,to:e}),this._fireEvent("pitchend",{from:i,to:e}),this},isTransforming:function(){return!(!this._pitch&&!this._angle)},getFrustumAltitude:function(){return this._frustumAltitude},_calcFrustumAltitude:function(){var t=90-this.getPitch(),e=this.getFov()/2,i=this.cameraPosition?this.cameraPosition[2]:0;if(e<=t)return i;e=Math.PI*e/180;var r=new se(this.cameraPosition).distanceTo(new se(this.cameraLookAt)),n=i*Math.tan(2*e);return i+Math.tan(e)*(r+n)},_pointToContainerPoint:(Do=[0,0,0],function(t,e,i,r){if(void 0===i&&(i=0),t=this._pointToPoint(t,e,r),this.isTransforming()||i){i*=this._getResolution(e)/this._getResolution();var n=this._glScale;mo(Do,t.x*n,t.y*n,i*n);var o=this._projIfBehindCamera(Do,this.cameraPosition,this.cameraForward);xo(o,o,this.projViewMatrix);var a=this.width/2,s=this.height/2;return o[0]=o[0]*a+a,o[1]=-o[1]*s+s,r?(r.x=o[0],r.y=o[1],r):new se(o[0],o[1])}var h=this._prjToPoint(this._getPrjCenter(),void 0,Oo);return r?(r.x=t.x,r.y=t.y):r=t,r._sub(h)._add(this.width/2,this.height/2)}),_projIfBehindCamera:(Ao=new Array(3),Co=new Array(3),Po=new Array(3),function(t,e,i){go(Ao,t,e);var r,n,o=(n=Ao,(r=i)[0]*n[0]+r[1]*n[1]+r[2]*n[2]);return o<=0&&(function(t,e,i){t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}(Co,i,1.01*o),function(t,e,i){t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2]}(t,e,go(Po,Ao,Co))),t}),_containerPointToPoint:(To=[0,0,0],Mo=[0,0,0,1],Ro=[0,0,0,1],function(t,e,i){if(this.isTransforming()){var r=this.width/2||1,n=this.height/2||1;mo(To,(t.x-r)/r,(n-t.y)/n,0),mo(Mo,To[0],To[1],0),mo(Ro,To[0],To[1],1),Mo[3]=Ro[3]=1,xo(Mo,Mo,this.projViewMatrixInverse),xo(Ro,Ro,this.projViewMatrixInverse);var o=Mo[0],a=Ro[0],s=Mo[1],h=Ro[1],l=Mo[2],c=Ro[2],u=l===c?0:(0-l)/(c-l),p=I(o,a,u),d=I(s,h,u);return i?(i.x=p,i.y=d):i=new se(p,d),i._multi(1/this._glScale),void 0===e||this.getZoom()===e?i:this._pointToPointAtZoom(i,e,i)}var f=this._prjToPoint(this._getPrjCenter(),e,i),m=void 0!==e?this._getResolution()/this._getResolution(e):1,g=m*(t.x-this.width/2),v=m*(t.y-this.height/2);return f._add(g,v)}),_calcMatrices:(bo=re.ie9?null:Ho(),So=re.ie9?null:Ho(),function(){if(!re.ie9){delete this._mapRes,delete this._mapGlRes,delete this._mapExtent2D,delete this._mapGlExtent2D;var t=this.getSize(),e=t.width||1,i=t.height||1;this._glScale=this.getGLScale();var r,n,o,a,s,h,l,c=this.getFov()*Math.PI/180,u=this.getScale(this.getMinZoom())/this.getScale(this.getMaxNativeZoom())*i/2/this._getFovRatio()*1.4,p=this.projMatrix||Ho();r=p,n=c,o=e/i,a=.1,s=u,h=1/Math.tan(n/2),l=1/(a-s),r[0]=h/o,r[1]=0,r[2]=0,r[3]=0,r[4]=0,r[5]=h,r[6]=0,r[7]=0,r[8]=0,r[9]=0,r[10]=(s+a)*l,r[11]=-1,r[12]=0,r[13]=0,r[14]=2*s*a*l,r[15]=0,this.projMatrix=p;var d=this._getCameraWorldMatrix();this.viewMatrix=po(bo,d),this.projViewMatrix=uo(this.projViewMatrix||Ho(),p,this.viewMatrix),this.projViewMatrixInverse=uo(this.projViewMatrixInverse||Ho(),d,po(So,p)),this.domCssMatrix=this._calcDomMatrix(),this._frustumAltitude=this._calcFrustumAltitude(),this._mapRes=this._getResolution(),this._mapGlRes=this._getResolution(this.getGLZoom()),this._mapExtent2D=this._get2DExtent(),this._mapGlExtent2D=this._get2DExtent(this.getGLZoom())}}),_calcDomMatrix:function(){var t=re.ie9?null:Ho(),e=re.ie9?null:Ho(),i=[1,-1,1],r=[0,0,0];return function(){var n,o,a,s,h,l,c,u,p,d,f,m,g,v=this.width||1,y=this.height||1,E=.5/Math.tan(this._fov/2)*y;return co(t,this.projMatrix,i),lo(t,t,mo(r,0,0,-E)),this._pitch&&(n=t,o=t,a=this._pitch,s=Math.sin(a),h=Math.cos(a),l=o[4],c=o[5],u=o[6],p=o[7],d=o[8],f=o[9],m=o[10],g=o[11],o!==n&&(n[0]=o[0],n[1]=o[1],n[2]=o[2],n[3]=o[3],n[12]=o[12],n[13]=o[13],n[14]=o[14],n[15]=o[15]),n[4]=l*h+d*s,n[5]=c*h+f*s,n[6]=u*h+m*s,n[7]=p*h+g*s,n[8]=d*h-l*s,n[9]=f*h-c*s,n[10]=m*h-u*s,n[11]=g*h-p*s),this._angle&&function(t,e,i){var r=Math.sin(i),n=Math.cos(i),o=e[0],a=e[1],s=e[2],h=e[3],l=e[4],c=e[5],u=e[6],p=e[7];e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=o*n+l*r,t[1]=a*n+c*r,t[2]=s*n+u*r,t[3]=h*n+p*r,t[4]=l*n-o*r,t[5]=c*n-a*r,t[6]=u*n-s*r,t[7]=p*n-h*r}(t,t,this._angle),fo(e),co(e,e,mo(r,v/2,-y/2,1)),uo(this.domCssMatrix||Ho(),e,t)}}(),_getCameraWorldMatrix:(_o={},wo=[1,-1,1],function(){var t=this.getGLZoom(),e=this.getSize(),i=this.getGLScale(),r=this._prjToPoint(this._prjCenter,t);this.cameraLookAt=mo(this.cameraLookAt||[0,0,0],r.x,r.y,0);var n=this.getPitch()*Lo,o=-this.getBearing()*Lo,a=this._getFovRatio(),s=i*(e.height||1)/2/a,h=s*Math.cos(n),l=Math.sin(n)*s,c=r.x+l*Math.sin(o),u=r.y+l*Math.cos(o);this.cameraPosition=mo(this.cameraPosition||[0,0,0],c,u,h);var p=l||1,d=this.cameraUp=mo(this.cameraUp||[0,0,0],Math.sin(o)*p,Math.cos(o)*p,0),f=this.cameraWorldMatrix=this.cameraWorldMatrix||Ho();!function(t,e,i,r){var n=[0,0,0],o=[0,0,0],a=[0,0,0];go(a,e,i),0===vo(a)&&(a[2]=1),yo(a,a),Eo(n,r,a),0===vo(a)&&(1===Math.abs(r[2])?a[0]+=1e-4:a[2]+=1e-4,yo(a,a),Eo(n,r,a)),yo(n,n),Eo(o,a,n),t[0]=n[0],t[4]=o[0],t[8]=a[0],t[1]=n[1],t[5]=o[1],t[9]=a[1],t[2]=n[2],t[6]=o[2],t[10]=a[2]}(f,this.cameraPosition,this.cameraLookAt,d);var m,g,v,y=this.cameraForward||[0,0,0];return go(y,this.cameraLookAt,this.cameraPosition),this.cameraForward=yo(y,y),function(t,e){var i,r=e[0],n=e[4],o=e[8],a=e[1],s=e[5],h=e[9],l=e[2],c=e[6],u=e[10],p=r+s+u;p>0?(i=.5/Math.sqrt(p+1),t.w=.25/i,t.x=(c-h)*i,t.y=(o-l)*i,t.z=(a-n)*i):r>s&&r>u?(i=2*Math.sqrt(1+r-s-u),t.w=(c-h)/i,t.x=.25*i,t.y=(n+a)/i,t.z=(o+l)/i):s>u?(i=2*Math.sqrt(1+s-r-u),t.w=(o-l)/i,t.x=(n+a)/i,t.y=.25*i,t.z=(h+c)/i):(i=2*Math.sqrt(1+u-r-s),t.w=(a-n)/i,t.x=(o+l)/i,t.y=(h+c)/i,t.z=.25*i)}(_o,f),function(t,e){var i=t,r=e.x,n=e.y,o=e.z,a=e.w,s=r+r,h=n+n,l=o+o,c=r*s,u=r*h,p=r*l,d=n*h,f=n*l,m=o*l,g=a*s,v=a*h,y=a*l;i[0]=1-(d+m),i[4]=u-y,i[8]=p+v,i[1]=u+y,i[5]=1-(c+m),i[9]=f-g,i[2]=p-v,i[6]=f+g,i[10]=1-(c+d),i[3]=0,i[7]=0,i[11]=0,i[12]=0,i[13]=0,i[14]=0,i[15]=1}(f,_o),m=f,g=this.cameraPosition,(v=m)[12]=g[0],v[13]=g[1],v[14]=g[2],co(f,f,wo),f}),_getFovRatio:function(){var t=this.getFov();return Math.tan(t/2*Lo)},_renderLayers:function(){this.isInteracting()||this._getLayers().forEach(function(t){if(t){var e=t._getRenderer();e&&e.setToRedraw&&e.setToRedraw()}})}}),xr.include({_onViewChange:function(t){this._viewHistory||(this._viewHistory=[],this._viewHistoryPointer=0);for(var e=this._getCurrentView(),i=this._viewHistory.length-1;i>=0;i--)if(q(t,this._viewHistory[i]))return this._viewHistoryPointer=i,void this._fireViewChange(e,t);this._viewHistoryPointer<this._viewHistory.length-1&&this._viewHistory.splice(this._viewHistoryPointer+1),this._viewHistory.push(t);var r=this.options.viewHistoryCount;r>0&&this._viewHistory.length>r&&this._viewHistory.splice(0,this._viewHistory.length-r),this._viewHistoryPointer=this._viewHistory.length-1,this._fireViewChange(e,t)},zoomToPreviousView:function(t){if(void 0===t&&(t={}),!this.hasPreviousView())return null;var e=this._viewHistory[--this._viewHistoryPointer];return this._zoomToView(e,t),e},hasPreviousView:function(){return!(!this._viewHistory||0===this._viewHistoryPointer)},zoomToNextView:function(t){if(void 0===t&&(t={}),!this.hasNextView())return null;var e=this._viewHistory[++this._viewHistoryPointer];return this._zoomToView(e,t),e},hasNextView:function(){return!(!this._viewHistory||this._viewHistoryPointer===this._viewHistory.length-1)},_zoomToView:function(t,e){var i=this,r=this.getView();e.animation?this._animateTo(t,{duration:e.duration},function(e){"finished"===e.state.playState&&i._fireViewChange(r,t)}):(this.setView(t),this._fireViewChange(r,t))},getViewHistory:function(){return this._viewHistory},_fireViewChange:function(t,e){this._fireEvent("viewchange",{old:t,new:e})},_getCurrentView:function(){return this._viewHistory?this._viewHistory[this._viewHistoryPointer]:null}}),xr.mergeOptions({viewHistory:!0,viewHistoryCount:10});var Io=function(t){function e(e){var i;return(i=t.call(this,e)||this).on("enable",i._afterEnable,oe(oe(i))).on("disable",i._afterDisable,oe(oe(i))),i._measureLayers=[],i}ne(e,t);var i=e.prototype;return i.clear=function(){if(N(this._measureLayers))for(var t=0;t<this._measureLayers.length;t++)this._measureLayers[t].remove();return delete this._lastMeasure,delete this._lastVertex,this._measureLayers=[],this},i.getMeasureLayers=function(){return this._measureLayers},i.getLastMeasure=function(){return this._lastMeasure?this._lastMeasure:0},i._measure=function(t){var e,i,r=this.getMap();t instanceof sn?e=r.computeGeometryLength(t):Array.isArray(t)&&(e=r.getProjection().measureLength(t)),this._lastMeasure=e,i="zh-CN"===this.options.language?[" "," "," "," "]:[" m"," km"," feet"," mile"];var n="";return this.options.metric&&(n+=e<1e3?e.toFixed(0)+i[0]:(e/1e3).toFixed(2)+i[1]),this.options.imperial&&(e*=3.2808399,n.length>0&&(n+="\n"),n+=e<5280?e.toFixed(0)+i[2]:(e/5280).toFixed(2)+i[3]),n},i._registerMeasureEvents=function(){this.on("drawstart",this._msOnDrawStart,this).on("drawvertex",this._msOnDrawVertex,this).on("mousemove",this._msOnMouseMove,this).on("drawend",this._msOnDrawEnd,this)},i._afterEnable=function(){this._registerMeasureEvents()},i._afterDisable=function(){this.off("drawstart",this._msOnDrawStart,this).off("drawvertex",this._msOnDrawVertex,this).off("mousemove",this._msOnMouseMove,this).off("drawend",this._msOnDrawEnd,this)},i._msOnDrawStart=function(t){var e=this.getMap(),i=M(),r="distancetool_"+i,n="distancetool_markers_"+i;e.getLayer(r)?(this._measureLineLayer=e.getLayer(r),this._measureMarkerLayer=e.getLayer(n)):(this._measureLineLayer=new eo(r).addTo(e),this._measureMarkerLayer=new eo(n).addTo(e)),this._measureLayers.push(this._measureLineLayer),this._measureLayers.push(this._measureMarkerLayer),new bn(t.coordinate,{symbol:this.options.vertexSymbol}).addTo(this._measureMarkerLayer);var o="zh-CN"===this.options.language?"":"start",a=new Zn(o,t.coordinate,this.options.labelOptions);this._lastVertex=a,this._measureMarkerLayer.addGeometry(a)},i._msOnMouseMove=function(t){var e=this._measure(this._msGetCoordsToMeasure(t));if(!this._tailMarker){var i=Lt(this.options.vertexSymbol);i.markerWidth/=2,i.markerHeight/=2,this._tailMarker=new bn(t.coordinate,{symbol:i}).addTo(this._measureMarkerLayer),this._tailLabel=new Zn(e,t.coordinate,this.options.labelOptions).addTo(this._measureMarkerLayer)}this._tailMarker.setCoordinates(t.coordinate),this._tailLabel.setContent(e),this._tailLabel.setCoordinates(t.coordinate)},i._msGetCoordsToMeasure=function(t){return t.geometry.getCoordinates().concat([t.coordinate])},i._msOnDrawVertex=function(t){var e=t.geometry;new bn(t.coordinate,{symbol:this.options.vertexSymbol}).addTo(this._measureMarkerLayer);var i=this._measure(e),r=new Zn(i,t.coordinate,this.options.labelOptions);this._measureMarkerLayer.addGeometry(r),this._lastVertex=r},i._msOnDrawEnd=function(t){this._clearTailMarker();var e=this._lastVertex.getSize();e||(e=new he(10,10)),this._addClearMarker(this._lastVertex.getCoordinates(),e.width);var i=t.geometry.copy();i.addTo(this._measureLineLayer),this._lastMeasure=i.getLength()},i._addClearMarker=function(t,e){var i=this.options.clearButtonSymbol,r={markerDx:(i.markerDx||0)+e,textDx:(i.textDx||0)+e};Array.isArray(i)&&(r=i.map(function(t){return t?{markerDx:(t.markerDx||0)+e,textDx:(t.textDx||0)+e}:null})),i=Lt(i,r);var n=new bn(t,{symbol:i}),o=this._measureLineLayer,a=this._measureMarkerLayer;n.on("click",function(){return o.remove(),a.remove(),!1},this),n.addTo(this._measureMarkerLayer)},i._clearTailMarker=function(){this._tailMarker&&(this._tailMarker.remove(),delete this._tailMarker),this._tailLabel&&(this._tailLabel.remove(),delete this._tailLabel)},e}(oo);Io.mergeOptions({mode:"LineString",language:"zh-CN",metric:!0,imperial:!1,symbol:{lineColor:"#000",lineWidth:3,lineOpacity:1},vertexSymbol:{markerType:"ellipse",markerFill:"#fff",markerLineColor:"#000",markerLineWidth:3,markerWidth:11,markerHeight:11},labelOptions:{textSymbol:{textFaceName:"monospace",textLineSpacing:1,textHorizontalAlignment:"right",textDx:15},boxStyle:{padding:[6,2],symbol:{markerType:"square",markerFill:"#fff",markerFillOpacity:.9,markerLineColor:"#b4b3b3"}}},clearButtonSymbol:[{markerType:"square",markerFill:"#fff",markerLineColor:"#b4b3b3",markerLineWidth:2,markerWidth:15,markerHeight:15,markerDx:20},{markerType:"x",markerWidth:10,markerHeight:10,markerDx:20}]});var Bo=function(t){function e(e){var i;return(i=t.call(this,e)||this).on("enable",i._afterEnable,oe(oe(i))).on("disable",i._afterDisable,oe(oe(i))),i._measureLayers=[],i}ne(e,t);var i=e.prototype;return i._measure=function(t){var e,i,r=this.getMap();t instanceof sn?e=r.computeGeometryArea(t):Array.isArray(t)&&(e=r.getProjection().measureArea(t)),this._lastMeasure=e,i="zh-CN"===this.options.language?[" "," "," "," "]:[" sq.m"," sq.km"," sq.ft"," sq.mi"];var n="";if(this.options.metric&&(n+=e<1e6?e.toFixed(0)+i[0]:(e/1e6).toFixed(2)+i[1]),this.options.imperial){e*=3.2808399,n.length>0&&(n+="\n");n+=e<27878400?e.toFixed(0)+i[2]:(e/27878400).toFixed(2)+i[3]}return n},i._msGetCoordsToMeasure=function(t){return t.geometry.getShell().concat([t.coordinate])},i._msOnDrawVertex=function(t){var e=new bn(t.coordinate,{symbol:this.options.vertexSymbol}).addTo(this._measureMarkerLayer);this._measure(t.geometry),this._lastVertex=e},i._msOnDrawEnd=function(t){this._clearTailMarker();var e=this._measure(t.geometry),i=new Zn(e,t.coordinate,this.options.labelOptions).addTo(this._measureMarkerLayer).getSize();i||(i=new he(10,10)),this._addClearMarker(t.coordinate,i.width);var r=t.geometry.copy();r.addTo(this._measureLineLayer),this._lastMeasure=r.getArea()},e}(Io);function zo(t){for(var e=t.tileInfo,i=[e.cols,e.rows],r=[],n=e.lods,o=0,a=n.length;o<a;o++)r.push(n[o].resolution);var s=t.fullExtent,h=e.origin,l=[1,-1,h.x,h.y];return delete s.spatialReference,{spatialReference:{resolutions:r,fullExtent:s},tileSystem:l,tileSize:i}}Bo.mergeOptions({mode:"Polygon",symbol:{lineColor:"#000000",lineWidth:2,lineOpacity:1,lineDasharray:"",polygonFill:"#ffffff",polygonOpacity:.5}}),oo.registerMode("circle",{clickLimit:2,action:["click","mousemove","click"],create:function(t){return new In(t[0],0)},update:function(t,e){var i=e.getMap().computeLength(e.getCenter(),t[t.length-1]);e.setRadius(i)},generate:function(t){return t}}),oo.registerMode("freeHandCircle",{action:["mousedown","mousemove","mouseup"],create:function(t){return new In(t[0],0)},update:function(t,e){var i=e.getMap().computeLength(e.getCenter(),t[t.length-1]);e.setRadius(i)},generate:function(t){return t}}),oo.registerMode("ellipse",{clickLimit:2,action:["click","mousemove","click"],create:function(t){return new Bn(t[0],0,0)},update:function(t,e){var i=e.getMap(),r=e.getCenter(),n=i.computeLength(r,new bi({x:t[t.length-1].x,y:r.y})),o=i.computeLength(r,new bi({x:r.x,y:t[t.length-1].y}));e.setWidth(2*n),e.setHeight(2*o)},generate:function(t){return t}}),oo.registerMode("freeHandEllipse",{action:["mousedown","mousemove","mouseup"],create:function(t){return new Bn(t[0],0,0)},update:function(t,e){var i=e.getMap(),r=e.getCenter(),n=i.computeLength(r,new bi({x:t[t.length-1].x,y:r.y})),o=i.computeLength(r,new bi({x:r.x,y:t[t.length-1].y}));e.setWidth(2*n),e.setHeight(2*o)},generate:function(t){return t}}),oo.registerMode("rectangle",{clickLimit:2,action:["click","mousemove","click"],create:function(t){var e=new _n([]);return e._firstClick=t[0],e},update:function(t,e,i){var r=e.getMap(),n=i.containerPoint,o=r.coordToContainerPoint(e._firstClick),a=[[o.x,o.y],[n.x,o.y],[n.x,n.y],[o.x,n.y]];e.setCoordinates(a.map(function(t){return r.containerPointToCoord(new se(t))}))},generate:function(t){return t}}),oo.registerMode("freeHandRectangle",{action:["mousedown","mousemove","mouseup"],create:function(t){var e=new _n([]);return e._firstClick=t[0],e},update:function(t,e){var i=e._firstClick,r=[[i.x,i.y],[t[0].x,i.y],[t[0].x,t[0].y],[i.x,t[0].y]];e.setCoordinates(r)},generate:function(t){return t}}),oo.registerMode("point",{clickLimit:1,action:["click"],create:function(t){return new bn(t[0])},generate:function(t){return t}}),oo.registerMode("polygon",{action:["click","mousemove","dblclick"],create:function(t){return new Tn(t)},update:function(t,e){var i=e.getSymbol();e.setCoordinates(t);var r=e.getLayer();if(r){var n=r.getGeometryById("polygon");if(!n&&t.length>=3){if(n=new _n([t],{id:"polygon"}),i){var o=Lt(i,{lineOpacity:0});n.setSymbol(o)}n.addTo(r)}n&&n.setCoordinates(t)}},generate:function(t){return new _n(t.getCoordinates(),{symbol:t.getSymbol()})}}),oo.registerMode("freeHandPolygon",{action:["mousedown","mousemove","mouseup"],create:function(t){return new Tn(t)},update:function(t,e){var i=e.getCoordinates(),r=e.getSymbol();e.setCoordinates(i.concat(t));var n=e.getLayer();if(n){var o=n.getGeometryById("polygon");if(!o&&t.length>=3){if(o=new _n([t],{id:"polygon"}),r){var a=Lt(r,{lineOpacity:0});o.setSymbol(a)}o.addTo(n)}o&&o.setCoordinates(t)}},generate:function(t){return new _n(t.getCoordinates(),{symbol:t.getSymbol()})}}),oo.registerMode("linestring",{action:["click","mousemove","dblclick"],create:function(t){return new Tn(t)},update:function(t,e){e.setCoordinates(t)},generate:function(t){return t}}),oo.registerMode("freeHandLinestring",{action:["mousedown","mousemove","mouseup"],create:function(t){return new Tn(t)},update:function(t,e){var i=e.getCoordinates();e.setCoordinates(i.concat(t))},generate:function(t){return t}}),oo.registerMode("arccurve",{action:["click","mousemove","dblclick"],create:function(t){return new jn(t)},update:function(t,e){e.setCoordinates(t)},generate:function(t){return t}}),oo.registerMode("quadbeziercurve",{action:["click","mousemove","dblclick"],create:function(t){return new Fn(t)},update:function(t,e){e.setCoordinates(t)},generate:function(t){return t}}),oo.registerMode("cubicbeziercurve",{action:["click","mousemove","dblclick"],create:function(t){return new Vn(t)},update:function(t,e){e.setCoordinates(t)},generate:function(t){return t}}),oo.registerMode("boxZoom",{action:["mousedown","mousemove","mouseup"],create:function(t){var e=new bn(t[0]);return e._firstClick=t[0],e},update:function(t,e,i){var r=e.getMap(),n=r.coordToContainerPoint(e._firstClick),o=i.containerPoint,a=r.containerPointToCoordinate(new bi(Math.min(n.x,o.x),Math.min(n.y,o.y)));e.setCoordinates(a).updateSymbol({markerWidth:Math.abs(n.x-o.x),markerHeight:Math.abs(n.y-o.y)})},generate:function(t){return t}}),yr.loadArcgis=function(t,e,i){if(void 0===i&&(i={jsonp:!0}),d(t)&&"{"!==t.substring(0,1))ei.getJSON(t,function(t,i){if(t)e(t);else{var r=zo(i);e(null,r)}},i);else{d(t)&&(t=A(t));var r=zo(t);e(null,r)}return this};var No=function(t){function e(e){return t.call(this,e)||this}ne(e,t);var i=e.prototype;return i.addTo=function(t){return this._owner=t,this._switchEvents("on"),this.onAdd&&this.onAdd(),this.fire("add"),this},i.getMap=function(){return this._owner?this._owner.getBaseLayer?this._owner:this._owner.getMap():null},i.show=function(t){var e=this.getMap();if(!e)return this;this._mapEventsOn||this._switchMapEvents("on"),t=t||this._coordinate||this._owner.getCenter();var i=this.isVisible();this.fire("showstart");var r=this._getUIContainer();this._coordinate=t,this._removePrevDOM();var n=this.__uiDOM=this.buildOn(e);if(n.eventsPropagation=this.options.eventsPropagation,!n)return this.fire("showend"),this;this._measureSize(n),this._singleton()&&(e[this._uiDomKey()]=n),this._setPosition(),n.style[Ce]=null,r.appendChild(n);var o=this._getAnimation();if(i&&(o.ok=!1),o.ok&&(o.fade&&(n.style.opacity=0),o.scale)){if(this.getTransformOrigin){var a=this.getTransformOrigin();n.style[Ae]=a}n.style[Re]=this._toCSSTranslate(this._pos)+" scale(0)"}n.style.display="",this.options.eventsToStop&&Ke(n,this.options.eventsToStop,Ne),this.options.autoPan&&this._autoPan();var s=o.transition;return o.ok&&s&&(n.offsetHeight,s&&(n.style[Ce]=s),o.fade&&(n.style.opacity=1),o.scale&&(n.style[Re]=this._toCSSTranslate(this._pos)+" scale(1)")),this.fire("showend"),this},i.hide=function(){var t=this;if(!this.getDOM()||!this.getMap())return this;var e=this._getAnimation(),i=this.getDOM();return this.options.animationOnHide||(e.ok=!1),e.ok?(i.offsetHeight,i.style[Ce]=e.transition,setTimeout(function(){i.style.display="none",t.fire("hide")},this.options.animationDuration)):(i.style.display="none",this.fire("hide")),e.fade&&(i.style.opacity=0),e.scale&&(i.style[Re]=this._toCSSTranslate(this._pos)+" scale(0)"),this},i.isVisible=function(){var t=this.getDOM();return this.getMap()&&t&&t.parentNode&&"none"!==t.style.display},i.remove=function(){return delete this._mapEventsOn,this._owner?(this.hide(),this._switchEvents("off"),this.onRemove&&this.onRemove(),!this._singleton()&&this.__uiDOM&&this._removePrevDOM(),delete this._owner,this.fire("remove"),this):this},i.getSize=function(){return this._size?this._size.copy():null},i.getOwner=function(){return this._owner},i.getDOM=function(){return this.__uiDOM},i.getPosition=function(){if(!this.getMap())return null;var t=this._getViewPoint()._round();if(this.getOffset){var e=this.getOffset()._round();e&&t._add(e)}return t},i._getAnimation=function(){for(var t={fade:!1,scale:!1},e=this.options.animation?this.options.animation.split(","):[],i=0;i<e.length;i++){var r=le(e[i]);"fade"===r?t.fade=!0:"scale"===r&&(t.scale=!0)}var n=null;return t.fade&&(n="opacity "+this.options.animationDuration+"ms"),t.scale&&(n=n?n+",":"",n+=Re+" "+this.options.animationDuration+"ms"),t.transition=n,t.ok=null!==n,t},i._getViewPoint=function(){return this.getMap().coordToViewPoint(this._coordinate)._add(this.options.dx,this.options.dy)},i._autoPan=function(){var t=this.getMap(),e=this.getDOM();if(!t.isMoving()){var i=this._pos,r=t.getSize(),n=r.width,o=r.height,a=t.viewPointToContainerPoint(i),s=parseInt(e.clientWidth),h=parseInt(e.clientHeight),l=0,c=0;a.x<0?l=-(a.x-s/2):a.x+s-35>n&&(l=n-(a.x+3*s/2)),a.y-h<0?c=50-(a.y-h):a.y>o&&(c=o-a.y-h-30),0===c&&0===l||t.panBy(new se(l,c),{duration:this.options.autoPanDuration})}},i._measureSize=function(t){var e=this._getUIContainer();t.style.position="absolute",t.style.left="-99999px";var i=t.style.bottom?"bottom":"top";return t.style[i]="-99999px",t.style.display="",e.appendChild(t),this._size=new he(t.clientWidth,t.clientHeight),t.style.display="none",t.style.left="0px",t.style[i]="0px",this._size},i._removePrevDOM=function(){this.onDomRemove&&this.onDomRemove();var t=this.options.eventsToStop;if(this._singleton()){var e=this.getMap(),i=this._uiDomKey();e[i]&&(t&&$e(e[i],t,Ne),Oe(e[i]),delete e[i]),delete this.__uiDOM}else this.__uiDOM&&(t&&$e(this.__uiDOM,t,Ne),Oe(this.__uiDOM),delete this.__uiDOM)},i._uiDomKey=function(){return"__ui_"+this._getClassName()},i._singleton=function(){return this.options.single},i._getUIContainer=function(){return this.getMap()._panels.ui},i._getClassName=function(){return"UIComponent"},i._switchMapEvents=function(t){var e=this.getMap();if(e){this._mapEventsOn="on"===t;var i=this._getDefaultEvents();if(this.getEvents&&h(i,this.getEvents()),i)for(var r in i)i.hasOwnProperty(r)&&e[t](r,i[r],this)}},i._switchEvents=function(t){this._switchMapEvents(t);var e=this._getOwnerEvents();if(this._owner)for(var i in e)e.hasOwnProperty(i)&&this._owner[t](i,e[i],this)},i._getDefaultEvents=function(){return{"zooming rotate pitch":this.onEvent,zoomend:this.onZoomEnd,moving:this.onMoving}},i._getOwnerEvents=function(){var t={};return this._owner&&this._owner instanceof sn&&(t.positionchange=this.onGeometryPositionChange),this.getOwnerEvents&&h(t,this.getOwnerEvents()),t},i.onGeometryPositionChange=function(t){this._owner&&this.isVisible()&&this.show(t.target.getCenter())},i.onMoving=function(){this.isVisible()&&this.getMap().isTransforming()&&this._updatePosition()},i.onEvent=function(){this.isVisible()&&this._updatePosition()},i.onZoomEnd=function(){this.isVisible()&&this._setPosition()},i._updatePosition=function(){this.getMap()._getRenderer().callInNextFrame(this._setPosition.bind(this))},i._setPosition=function(){var t=this.getDOM();if(t){t.style[Ce]=null;var e=this.getPosition();this._pos=e,t.style[Re]=this._toCSSTranslate(e)+" scale(1)"}},i._toCSSTranslate=function(t){if(!t)return"";if(re.any3d){var e=this.getMap(),i=e?e.getBearing():0,r=e?e.getPitch():0,n="";return this.options.pitchWithMap&&r&&(n+=" rotateX("+Math.round(r)+"deg)"),this.options.rotateWithMap&&i&&(n+=" rotateZ("+Math.round(-i)+"deg)"),"translate3d("+t.x+"px,"+t.y+"px, 0px)"+n}return"translate("+t.x+"px,"+t.y+"px)"},e}(fi(gi));No.mergeOptions({eventsPropagation:!1,eventsToStop:null,dx:0,dy:0,autoPan:!1,autoPanDuration:600,single:!0,animation:"scale",animationOnHide:!0,animationDuration:500,pitchWithMap:!1,rotateWithMap:!1});var ko="mousedown mouseup mouseenter mouseover mouseout mousemove click dblclick contextmenu keypress touchstart touchmove touchend",jo=function(t){function e(e,i){var r;return(r=t.call(this,i)||this)._markerCoord=new bi(e),r}ne(e,t);var i=e.prototype;return i._getClassName=function(){return"UIMarker"},i.setCoordinates=function(t){return this._markerCoord=t,this.fire("positionchange"),this.isVisible()&&(this._coordinate=this._markerCoord,this._setPosition()),this},i.getCoordinates=function(){return this._markerCoord},i.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(),this},i.getContent=function(){return this.options.content},i.onAdd=function(){this.show()},i.show=function(){return t.prototype.show.call(this,this._markerCoord)},i.flash=function(t,e,i,r){return Q.call(this,t,e,i,r)},i.buildOn=function(){var t;return d(this.options.content)?(t=De("div")).innerHTML=this.options.content:t=this.options.content,this._registerDOMEvents(t),t},i.getOffset=function(){var t=this.getSize();return new se(-t.width/2,-t.height/2)},i.getTransformOrigin=function(){return"center center"},i.onDomRemove=function(){var t=this.getDOM();this._removeDOMEvents(t)},i.isDragging=function(){return!!this.draggable&&this.draggable.isDragging()},i._registerDOMEvents=function(t){Ke(t,ko,this._onDomEvents,this)},i._onDomEvents=function(t){var e=this.getMap()._parseEvent(t,t.type);this.fire(t.type,e)},i._removeDOMEvents=function(t){$e(t,ko,this._onDomEvents,this)},i._getConnectPoints=function(){var t=this.getMap(),e=t.coordToContainerPoint(this.getCoordinates()),i=this.getSize(),r=i.width,n=i.height;return[t.containerPointToCoordinate(e.add(-r/2,0)),t.containerPointToCoordinate(e.add(r/2,0)),t.containerPointToCoordinate(e.add(0,n/2)),t.containerPointToCoordinate(e.add(0,-n/2))]},e}(Ei(No));jo.mergeOptions({eventsPropagation:!0,draggable:!1,single:!1,content:null});var Vo=re.touch?"touchstart mousedown":"mousedown",Fo=function(t){function e(e){return t.call(this,e)||this}ne(e,t);var i=e.prototype;return i.addHooks=function(){this.target.on(Vo,this._startDrag,this)},i.removeHooks=function(){this.target.off(Vo,this._startDrag,this)},i._startDrag=function(t){var e=t.domEvent;e.touches&&e.touches.length>1||2===e.button||this.isDragging()||(this.target.on("click",this._endDrag,this),this._lastCoord=t.coordinate,this._lastPoint=t.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),this.target.fire("dragstart",t))},i._prepareDragHandler=function(){this._dragHandler=new wi(this.target.getDOM(),{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this._dragHandler.on("mousedown",this._onMouseDown,this),this._dragHandler.on("dragging",this._dragging,this),this._dragHandler.on("mouseup",this._endDrag,this),this._dragHandler.enable()},i._cancelOn=function(t){var e=(t.srcElement||t.target).tagName.toLowerCase();return"button"===e||"input"===e||"select"===e||"option"===e||"textarea"===e},i._onMouseDown=function(t){Ne(t.domEvent)},i._dragging=function(t){var e=this.target,i=e.getMap()._parseEvent(t.domEvent),r=i.domEvent;if(!(r.touches&&r.touches.length>1))if(this._isDragging){var n=i.coordinate,o=i.containerPoint;this._lastCoord||(this._lastCoord=n),this._lastPoint||(this._lastPoint=o);var a=n.sub(this._lastCoord),s=o.sub(this._lastPoint);this._lastCoord=n,this._lastPoint=o,this.target.setCoordinates(this.target.getCoordinates().add(a)),i.coordOffset=a,i.pointOffset=s,e.fire("dragging",i)}else this._isDragging=!0},i._endDrag=function(t){var e=this.target,i=e.getMap();if(this._dragHandler&&(e.off("click",this._endDrag,this),this._dragHandler.disable(),delete this._dragHandler),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1,i){var r=i._parseEvent(t.domEvent);e.fire("dragend",r)}},i.isDragging=function(){return!!this._isDragging},e}(mi);jo.addInitHook("addHandler","draggable",Fo);var Uo=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i._getClassName=function(){return"InfoWindow"},i.addTo=function(e){return e instanceof sn&&(e.getInfoWindow()&&e.getInfoWindow()!==this&&e.removeInfoWindow(),e._infoWindow=this),t.prototype.addTo.call(this,e)},i.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(this._coordinate),this},i.getContent=function(){return this.options.content},i.setTitle=function(t){var e=t;return this.options.title=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.show(this._coordinate),this},i.getTitle=function(){return this.options.title},i.buildOn=function(){if(this.options.custom){if(d(this.options.content)){var t=De("div");return t.innerHTML=this.options.content,t}return this.options.content}var e=De("div");e.className="maptalks-msgBox",e.style.width=this._getWindowWidth()+"px",e.style.bottom="0px";var i='<em class="maptalks-ico"></em>';this.options.title&&(i+="<h2>"+this.options.title+"</h2>"),i+='<a href="javascript:void(0);" class="maptalks-close"></a><div class="maptalks-msgContent"></div>',e.innerHTML=i;var r=e.querySelector(".maptalks-msgContent");return d(this.options.content)?r.innerHTML=this.options.content:r.appendChild(this.options.content),this._onCloseBtnClick=this.hide.bind(this),He(e.querySelector(".maptalks-close"),"click touchend",this._onCloseBtnClick),e},i.getTransformOrigin=function(){return this.getSize().width/2+"px bottom"},i.getOffset=function(){var t=this.getSize(),e=new se(-t.width/2,0);this.options.custom?e._sub(0,t.height):e._sub(4,12);var i=this.getOwner();if(i instanceof bn||i instanceof Cn){var r,n;if(i instanceof bn)r=i._getPainter(),n=i.getSize();else{var o=i.getGeometries();if(!o||!o.length)return e;r=o[0]._getPainter(),n=o[0].getSize()}if(r){var a=r.getFixedExtent();e._add(a.xmax-n.width/2,a.ymin)}}return e},i.show=function(e){return this.getMap()&&this.getMap().options.enableInfoWindow?t.prototype.show.call(this,e):this},i.getEvents=function(){if(!this.options.autoCloseOn)return null;var t={};return t[this.options.autoCloseOn]=this.hide,t},i.getOwnerEvents=function(){var t=this.getOwner();if(!this.options.autoOpenOn||!t)return null;var e={};return e[this.options.autoOpenOn]=this._onAutoOpen,e},i.onRemove=function(){this.onDomRemove()},i.onDomRemove=function(){this._onCloseBtnClick&&(Ie(this.getDOM().childNodes[2],"click touchend",this._onCloseBtnClick),delete this._onCloseBtnClick)},i._onAutoOpen=function(t){var e=this,i=this.getOwner();setTimeout(function(){i instanceof bn?e.show(i.getCoordinates()):i instanceof Cn?e.show(i.findClosest(t.coordinate)):e.show(t.coordinate)},1)},i._getWindowWidth=function(){var t=this.options.width;return t||(t=300),t},e}(No);Uo.mergeOptions({autoPan:!0,autoCloseOn:null,autoOpenOn:"click",width:300,minHeight:120,custom:!1,title:null,content:null});var Go=function(t){ne(i,t);var e=i.prototype;function i(e,i){var r;return void 0===i&&(i={}),(r=t.call(this,i)||this)._content=e,r}return e._getClassName=function(){return"ToolTip"},e.addTo=function(e){if(e instanceof sn||e instanceof jo)return e.on("mousemove",this.onMouseMove,this),e.on("mouseout",this.onMouseOut,this),t.prototype.addTo.call(this,e);throw new Error("Invalid geometry or UIMarker the tooltip is added to.")},e.setStyle=function(t){return this.options.cssName=t,this},e.getStyle=function(){return this.options.cssName},e.getContent=function(){return this._content},e.buildOn=function(){var t=De("div"),e=this.options||{};e.height&&(t.style.height=e.height+"px"),e.width&&(t.style.width=e.width+"px");var i=e.cssName;return!i&&e.height&&(t.style.lineHeight=e.height+"px"),t.innerHTML='<div class="'+i+'">'+this._content+"</div>",t},e.onMouseOut=function(){clearTimeout(this._timeout),this.isVisible()&&this._removePrevDOM()},e.onMouseMove=function(t){var e=this;clearTimeout(this._timeout);var i=this.getMap();if(i){var r=i.locateByPoint(t.coordinate,-5,25);0===this.options.showTimeout?this.show(r):this._timeout=setTimeout(function(){i&&e.show(r)},this.options.showTimeout)}},e.onRemove=function(){clearTimeout(this._timeout),this._owner&&(this._owner.off("mouseover",this.onMouseOver,this),this._owner.off("mouseout",this.onMouseOut,this))},i}(No);Go.mergeOptions({width:0,height:0,animation:"fade",cssName:"maptalks-tooltip",showTimeout:400});var Wo=function(t){function e(e){return t.call(this,e)||this}ne(e,t);var i=e.prototype;return i._getClassName=function(){return"Menu"},i.addTo=function(t){return t._menu&&t._menu!==this&&t.removeMenu(),t._menu=this,No.prototype.addTo.apply(this,arguments)},i.setItems=function(t){return this.options.items=t,this},i.getItems=function(){return this.options.items||[]},i.buildOn=function(){if(this.options.custom){if(d(this.options.items)){var t=De("div");return t.innerHTML=this.options.items,t}return this.options.items}var e=De("div");We(e,"maptalks-menu"),e.style.width=this._getMenuWidth()+"px";var i=this._createMenuItemDom();return e.appendChild(i),Ke(e,"contextmenu",ze),e},i.getOffset=function(){if(!this.getMap())return null;var t=this.getMap().getSize(),e=this.getMap().viewPointToContainerPoint(this._getViewPoint()),i=this.getSize(),r=0,n=0;return e.x+i.width>t.width&&(r=-i.width),e.y+i.height>t.height&&(n=-i.height),new se(r,n)},i.getTransformOrigin=function(){var t=this.getOffset()._multi(-1);return t.x+"px "+t.y+"px"},i.getEvents=function(){return{"_zoomstart _zoomend _movestart _dblclick _click":this._removePrevDOM}},i._createMenuItemDom=function(){var t=this,e=this.getMap(),i=De("ul");We(i,"maptalks-menu-items");var r,n,o=this.getItems();function a(i){return function(r){var n=e._parseEvent(r,"click");n.target=t,n.owner=t._owner,n.index=i,!1!==this._callback(n)&&t.hide()}}for(var s=0,h=o.length;s<h;s++){if("-"===(r=o[s])||"_"===r)We(n=De("li"),"maptalks-menu-splitter");else{n=De("li");var l=r.item;f(l)&&(l=l({owner:this._owner,index:s})),n.innerHTML=l,n._callback=r.click,Ke(n,"click",a(s))}i.appendChild(n)}var c=this.options.maxHeight||0;return c>0&&Ue(i,"max-height: "+c+"px; overflow-y: auto;"),i},i._getMenuWidth=function(){return this.options.width||160},e}(No);Wo.mergeOptions({animation:null,animationDelay:10,animationOnHide:!1,autoPan:!1,width:160,maxHeight:0,custom:!1,items:[]});var Xo={setMenu:function(t){return this._menuOptions=t,this._menu?this._menu.setOptions(t):this.on("contextmenu",this._defaultOpenMenu,this),this},openMenu:function(t){var e=this instanceof xr?this:this.getMap();return t||(t=this.getCenter()),this._menu?this._menu.show(t):this._menuOptions&&e&&(this._bindMenu(this._menuOptions),this._menu.show(t)),this},setMenuItems:function(t){return this._menuOptions||(this._menuOptions={}),Array.isArray(t)&&(this._menuOptions.custom=!1),this._menuOptions.items=t,this.setMenu(this._menuOptions),this},getMenuItems:function(){return this._menu?this._menu.getItems():this._menuOptions&&this._menuOptions.items||[]},closeMenu:function(){return this._menu&&this._menu.hide(),this},removeMenu:function(){return this.off("contextmenu",this._defaultOpenMenu,this),this._unbindMenu(),delete this._menuOptions,this},_bindMenu:function(t){return this._menu=new Wo(t),this._menu.addTo(this),this},_unbindMenu:function(){return this._menu&&(this.closeMenu(),this._menu.remove(),delete this._menu),this},_defaultOpenMenu:function(t){return this.listens("contextmenu")>1||(this.openMenu(t.coordinate),!1)}};xr.include(Xo),sn.include(Xo);var Zo=Object.freeze({UIComponent:No,UIMarker:jo,InfoWindow:Uo,ToolTip:Go,Menuable:Xo,Menu:Wo}),Yo=function(t){function e(e){return e&&e.position&&!d(e.position)&&(e.position=h({},e.position)),t.call(this,e)||this}ne(e,t);var i=e.prototype;return i.addTo=function(t){if(this.remove(),!t.options.control)return this;this._map=t;var e=t._panels.control;return this.__ctrlContainer=De("div"),Ue(this.__ctrlContainer,"position:absolute;overflow:visible;"),this.update(),e.appendChild(this.__ctrlContainer),this.onAdd&&this.onAdd(),this.fire("add",{dom:e}),this},i.update=function(){return this.__ctrlContainer.innerHTML="",this._controlDom=this.buildOn(this.getMap()),this._controlDom&&(this._updatePosition(),this.__ctrlContainer.appendChild(this._controlDom)),this},i.getMap=function(){return this._map},i.getPosition=function(){return h({},this._parse(this.options.position))},i.setPosition=function(t){return d(t)?this.options.position=t:this.options.position=h({},t),this._updatePosition(),this},i.getContainerPoint=function(){var t,e,i=this.getPosition(),r=this.getMap().getSize();return l(i.left)?l(i.right)||(t=r.width-parseInt(i.right)):t=parseInt(i.left),l(i.top)?l(i.bottom)||(e=r.height-parseInt(i.bottom)):e=parseInt(i.top),new se(t,e)},i.getContainer=function(){return this.__ctrlContainer},i.getDOM=function(){return this._controlDom},i.show=function(){return this.__ctrlContainer.style.display="",this},i.hide=function(){return this.__ctrlContainer.style.display="none",this},i.isVisible=function(){return this.__ctrlContainer&&""===this.__ctrlContainer.style.display},i.remove=function(){return this._map?(Oe(this.__ctrlContainer),this.onRemove&&this.onRemove(),delete this._map,delete this.__ctrlContainer,delete this._controlDom,this.fire("remove"),this):this},i._parse=function(t){var i=t;return d(t)&&(i=e.positions[i]),i},i._updatePosition=function(){var t=this.getPosition();for(var e in t||(t={top:20,left:20}),t)t.hasOwnProperty(e)&&(t[e]=parseInt(t[e]),this.__ctrlContainer.style[e]=t[e]+"px");this.fire("positionchange",{position:h({},t)})},e}(fi(gi));Yo.positions={"top-left":{top:20,left:20},"top-right":{top:20,right:20},"bottom-left":{bottom:20,left:20},"bottom-right":{bottom:20,right:20}},xr.mergeOptions({control:!0}),xr.include({addControl:function(t){return this._containerDOM.getContext?this:(t.addTo(this),this)},removeControl:function(t){return t&&t.getMap()===this?(t.remove(),this):this}});var qo="addlayer removelayer setbaselayer baselayerremove",Jo=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.buildOn=function(){return this._attributionContainer=De("div"),this._attributionContainer.className="maptalks-attribution",this._update(),this._attributionContainer},i.onAdd=function(){this.getMap().on(qo,this._update,this)},i.onRemove=function(){this.getMap().off(qo,this._update,this)},i._update=function(){var t=this.getMap();if(t){var e=t._getLayers(function(t){return t.options.attribution}).reverse().map(function(t){return t.options.attribution}),i=this.options.content+(e.length>0?" - "+e.join(", "):"");this._attributionContainer.innerHTML='<span style="padding:0px 4px">'+i+"</span>"}},e}(Yo);Jo.mergeOptions({position:{bottom:0,left:0},content:'<a href="http://maptalks.org" target="_blank">maptalks</a>'}),xr.mergeOptions({attribution:!0}),xr.addOnLoadHook(function(){var t=this.options.attribution||this.options.attributionControl;t&&(this.attributionControl=new Jo(t),this.addControl(this.attributionControl))});var Qo=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.buildOn=function(){var t=this.container=De("div",this.options.containerClass),e=this.panel=De("div","panel"),i=this.button=De("button");return t.appendChild(i),t.appendChild(e),t},i.onAdd=function(){Ke(this.button,"mouseover",this._show,this),Ke(this.panel,"mouseleave",this._hide,this),Ke(this.getMap(),"click",this._hide,this)},i.onRemove=function(){this.panel&&($e(this.button,"mouseover",this._show,this),$e(this.panel,"mouseleave",this._hide,this),$e(this.getMap(),"click",this._hide,this),Oe(this.panel),Oe(this.button),delete this.panel,delete this.button,delete this.container)},i._show=function(){Ge(this.container,"shown")||(We(this.container,"shown"),this._createPanel())},i._hide=function(t){this.panel.contains(t.toElement||t.relatedTarget)||Xe(this.container,this.options.containerClass)},i._createPanel=function(){this.panel.innerHTML="";var t=De("ul");this.panel.appendChild(t),this._renderLayers(this.getMap(),t)},i._renderLayers=function(t,e){var i=t.getBaseLayer(),r=t.getLayers(),n=r.length;if(i){var o=i.layers||[i],a=De("li","group"),s=De("ul"),h=De("label");h.innerHTML=this.options.baseTitle,a.appendChild(h);for(var l=0,c=o.length;l<c;l++){var u=o[l];this._isExcluded(u)&&(s.appendChild(this._renderLayer(o[l],!0)),a.appendChild(s),e.appendChild(a))}}if(n){var p=De("li","group"),d=De("ul"),f=De("label");f.innerHTML=this.options.overlayTitle,p.appendChild(f);for(var m=0;m<n;m++){var g=r[m];this._isExcluded(g)&&d.appendChild(this._renderLayer(g))}p.appendChild(d),e.appendChild(p)}},i._isExcluded=function(t){var e=t.getId(),i=this.options.excludeLayers;return!(i.length&&i.indexOf(e)>=0)},i._renderLayer=function(t,e){var i=this,r=De("li","layer"),n=De("label"),o=De("input"),a=this.getMap(),s=t.options.visible;t.options.visible=!0;var h=t.isVisible();return t.options.visible=s,r.className="layer",e?(o.type="radio",o.name="base"):o.type="checkbox",o.checked=s&&h,h||o.setAttribute("disabled","disabled"),o.onchange=function(e){if("radio"===e.target.type){var r=a.getBaseLayer(),n=r.layers;if(n)for(var o=0,s=n.length;o<s;o++){var h=n[o];h[h===t?"show":"hide"]()}else r.isVisible()||r.show();a._fireEvent("setbaselayer")}else t[e.target.checked?"show":"hide"]();i.fire("layerchange",{target:t})},r.appendChild(o),n.innerHTML=t.getId(),r.appendChild(n),r},e}(Yo);Qo.mergeOptions({position:"top-right",baseTitle:"Base Layers",overlayTitle:"Layers",excludeLayers:[],containerClass:"maptalks-layer-switcher"}),xr.mergeOptions({layerSwitcherControl:!1}),xr.addOnLoadHook(function(){this.options.layerSwitcherControl&&(this.layerSwitcherControl=new Qo(this.options.layerSwitcherControl),this.addControl(this.layerSwitcherControl))});var Ko=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.buildOn=function(){var t=this.options.size;this.options.maximize||(t=[0,0]);var e=De("div"),i=this.mapContainer=De("div");i.style.width=t[0]+"px",i.style.height=t[1]+"px",i.className=this.options.containerClass;var r=this.button=De("div");return r.className=this.options.buttonClass,e.appendChild(i),e.appendChild(r),e},i.onAdd=function(){this.options.maximize&&this._createOverview(),this.getMap().on("resize moving zooming rotate dragrotating viewchange",this._update,this).on("setbaselayer",this._updateBaseLayer,this).on("spatialreferencechange",this._updateSpatialReference,this),Ke(this.button,"click",this._onButtonClick,this),this._updateButtonText()},i.onRemove=function(){this.getMap().off("resize moving zooming rotate dragrotating viewchange",this._update,this).off("setbaselayer",this._updateBaseLayer,this).off("spatialreferencechange",this._updateSpatialReference,this),this._overview&&(this._overview.remove(),delete this._overview,delete this._perspective),$e(this.button,"click",this._onButtonClick,this)},i.maxmize=function(){var t=this.options.size,e=this.mapContainer;return e.style.width=t[0]+"px",e.style.height=t[1]+"px",this._createOverview(),this},i.minimize=function(){this._overview&&this._overview.remove(),delete this._overview,delete this._perspective;var t=this.mapContainer;return t.style.width="0px",t.style.height="0px",this},i.getOverviewMap=function(){return this._overview},i._onButtonClick=function(){this._overview?this.minimize():this.maxmize(),this._updateButtonText()},i._updateButtonText=function(){this._overview?this.button.innerHTML="-":this.button.innerHTML="+"},i._createOverview=function(){var t=this.getMap(),e=this.mapContainer,i=t.config();h(i,{center:t.getCenter(),zoom:this._getOverviewZoom(),zoomAnimationDuration:150,pitch:0,bearing:0,scrollWheelZoom:!1,checkSize:!1,doubleClickZoom:!1,touchZoom:!1,control:!1,draggable:!1,maxExtent:null}),this._overview=new xr(e,i),this._updateBaseLayer(),this._perspective=new _n(this._getPerspectiveCoords(),{draggable:!0,cursor:"move",symbol:this.options.symbol}).on("dragend",this._onDragEnd,this),new eo("perspective_layer",this._perspective).addTo(this._overview),this.fire("load")},i._getOverviewZoom=function(){var t=this.getMap(),e=t.getZoom(),i=t.getMinZoom(),r=this.options.level;if(r>0){for(var n=r;n>0;n--)if(e-n>=i)return e-n}else for(var o=r;o<0;o++)if(e-o>=i)return e-o;return e},i._onDragEnd=function(){var t=this._perspective.getCenter();this._overview.setCenter(t),this.getMap().panTo(t)},i._getPerspectiveCoords=function(){var t=this.getMap();return t.getContainerExtent().toArray().map(function(e){return t.containerPointToCoordinate(e)})},i._update=function(){if(this._overview){Ve(this._overview._containerDOM);var t=this._getPerspectiveCoords();this._perspective.setCoordinates(t),this._overview.setCenterAndZoom(this.getMap().getCenter(),this._getOverviewZoom())}},i._updateSpatialReference=function(){if(this._overview){var t=this.getMap().options.spatialReference;this._overview.setSpatialReference(t)}},i._updateBaseLayer=function(){if(this._overview){var t=this.getMap().getBaseLayer();if(t){var e=t.layers,i=0;if(e)for(var r=0,n=e.length;r<n;r++){if(e[r].isVisible()){i=r;break}}var o=t.toJSON(),a=null;e?(a=o.layers[i].options).visible=!0:a=o.options,this._overview.setMinZoom(a.minZoom||null).setMaxZoom(a.maxZoom||null),delete a.minZoom,delete a.maxZoom,delete o.options.canvas,o.options.visible=!0,o.options.renderer="canvas";var s=lr.fromJSON(o);for(var h in t)f(t[h])&&t.hasOwnProperty(h)&&t[h]!==t.constructor.prototype[h]&&(s[h]=t[h]);this._overview.setBaseLayer(s)}else this._overview.setBaseLayer(null)}},e}(Yo);Ko.mergeOptions({level:4,position:{right:1,bottom:1},size:[300,200],maximize:!0,symbol:{lineWidth:3,lineColor:"#1bbc9b",polygonFill:"#1bbc9b",polygonOpacity:.4},containerClass:"maptalks-overview",buttonClass:"maptalks-overview-button"}),xr.mergeOptions({overviewControl:!1}),xr.addOnLoadHook(function(){this.options.overviewControl&&(this.overviewControl=new Ko(this.options.overviewControl),this.addControl(this.overviewControl))});var $o=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.buildOn=function(){var t;if(this.options.custom)d(this.options.content)?(t=De("div")).innerHTML=this.options.content:t=this.options.content;else{if(t=De("div","maptalks-panel"),this.options.closeButton){var e=De("a","maptalks-close");e.href="javascript:;",e.onclick=function(){t.style.display="none"},t.appendChild(e)}var i=De("div","maptalks-panel-content");i.innerHTML=this.options.content,t.appendChild(i)}return this.draggable=new wi(t,{cancelOn:this._cancelOn.bind(this),ignoreMouseleave:!0}),this.draggable.on("dragstart",this._onDragStart,this).on("dragging",this._onDragging,this).on("dragend",this._onDragEnd,this),this.options.draggable&&this.draggable.enable(),t},i.update=function(){return this.draggable&&(this.draggable.disable(),delete this.draggable),Yo.prototype.update.call(this)},i.setContent=function(t){var e=this.options.content;return this.options.content=t,this.fire("contentchange",{old:e,new:t}),this.isVisible()&&this.update(),this},i.getContent=function(){return this.options.content},i._cancelOn=function(t){var e=(t.srcElement||t.target).tagName.toLowerCase();return"button"===e||"input"===e||"select"===e||"option"===e||"textarea"===e},i._onDragStart=function(t){this._startPos=t.mousePos,this._startPosition=h({},this.getPosition()),this.fire("dragstart",t)},i._onDragging=function(t){var e=t.mousePos.sub(this._startPos),i=this._startPosition,r=this.getPosition();l(r.top)||(r.top=parseInt(i.top)+e.y),l(r.bottom)||(r.bottom=parseInt(i.bottom)-e.y),l(r.left)||(r.left=parseInt(i.left)+e.x),l(r.right)||(r.right=parseInt(i.right)-e.x),this.setPosition(r),this.fire("dragging",t)},i._onDragEnd=function(t){delete this._startPos,delete this._startPosition,this.fire("dragend",t)},i._getConnectPoints=function(){var t=this.getMap(),e=this.getContainerPoint(),i=this.getDOM(),r=parseInt(i.clientWidth),n=parseInt(i.clientHeight);return[t.containerPointToCoordinate(e.add(r/2,0)),t.containerPointToCoordinate(e.add(r,n/2)),t.containerPointToCoordinate(e.add(r/2,n)),t.containerPointToCoordinate(e.add(0,n/2))]},e}(Yo);$o.mergeOptions({position:"top-right",draggable:!0,custom:!1,content:"",closeButton:!0});var ta=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.buildOn=function(t){return this._map=t,this._scaleContainer=De("div",this.options.containerClass),this._addScales(),t.on("zoomend",this._update,this),this._map._loaded&&this._update(),this._scaleContainer},i.onRemove=function(){this.getMap().off("zoomend",this._update,this)},i._addScales=function(){var t="border: 2px solid #000000;border-top: none;line-height: 1.1;padding: 0px;color: #000000;font-size: 11px;text-align:center;white-space: nowrap;overflow: hidden;-moz-box-sizing: content-box;box-sizing: content-box;background: #fff; background: rgba(255, 255, 255, 0);";this.options.metric&&(this._mScale=Le("div",this.options.containerClass?null:t,this._scaleContainer)),this.options.imperial&&(this._iScale=Le("div",this.options.containerClass?null:t,this._scaleContainer))},i._update=function(){var t=this._map.pixelToDistance(this.options.maxWidth,0);this._updateScales(t)},i._updateScales=function(t){this.options.metric&&t&&this._updateMetric(t),this.options.imperial&&t&&this._updateImperial(t)},i._updateMetric=function(t){var e=this._getRoundNum(t),i=e<1e3?e+" m":e/1e3+" km";this._updateScale(this._mScale,i,e/t)},i._updateImperial=function(t){var e,i,r,n=3.2808399*t;n>5280?(e=n/5280,i=this._getRoundNum(e),this._updateScale(this._iScale,i+" mile",i/e)):(r=this._getRoundNum(n),this._updateScale(this._iScale,r+" feet",r/n))},i._updateScale=function(t,e,i){t.style.width=Math.round(this.options.maxWidth*i)+"px",t.innerHTML=e},i._getRoundNum=function(t){var e=Math.pow(10,(Math.floor(t)+"").length-1),i=t/e;return e*(i=i>=10?10:i>=5?5:i>=3?3:i>=2?2:1)},e}(Yo);ta.mergeOptions({position:"bottom-left",maxWidth:100,metric:!0,imperial:!1,containerClass:null}),xr.mergeOptions({scaleControl:!1}),xr.addOnLoadHook(function(){this.options.scaleControl&&(this.scaleControl=new ta(this.options.scaleControl),this.addControl(this.scaleControl))});var ea=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.buildOn=function(t){this._map=t;var e=De("div"),i=De("ul","maptalks-toolbar-hx");e.appendChild(i),this.options.vertical?We(e,"maptalks-toolbar-vertical"):We(e,"maptalks-toolbar-horizonal");var r=this;function n(t,e,i,n){var o=r._getItems()[e];return function(r){return Ne(r),t({target:o,index:e,childIndex:i,dom:n})}}var o=this.options.items;if(N(o))for(var a=0,s=o.length;a<s;a++){var h=o[a],l=De("li");if(28!==this.options.height&&(l.style.lineHeight=this.options.height+"px"),l.style.height=this.options.height+"px",l.style.cursor="pointer",qe(h.item)){l.style.textAlign="center";var c=Je("div",h.item);l.innerHTML='<div style="margin-top:'+(this.options.height-c.height)/2+'px;">'+h.item+"</div>"}else l.innerHTML=h.item;if(h.click&&Ke(l,"click",n(h.click,a,null,l)),N(h.children)){var u=this._createDropMenu(a);l.appendChild(u),l._menu=u,Ke(l,"mouseover",function(){this._menu.style.display=""}),Ke(l,"mouseout",function(){this._menu.style.display="none"})}i.appendChild(l)}return e},i._createDropMenu=function(t){var e=this;function i(t,i,r){var n=e._getItems()[i].children[r];return function(e){return Ne(e),t({target:n,index:i,childIndex:r})}}var r=De("div","maptalks-dropMenu"),n=this._getItems(),o=n.length,a=De("ul"),s=n[t].children;t===o-1&&s&&(r.style.cssText="right: 0px;",a.style.cssText="right: 0px;position: absolute;",this.options.reverseMenu&&(a.style.bottom=0)),r.appendChild(De("em","maptalks-ico"));for(var h=0,l=0,c=s.length;l<c;l++){var u=ge(s[l].item,"12px");u.width>h&&(h=u.width)}for(var p=0,d=s.length;p<d;p++){var f=s[p],m=De("li");m.innerHTML='<a href="javascript:;">'+f.item+"</a>",m.style.cursor="pointer",m.style.width=h+24+"px",Ke(m.childNodes[0],"click",i(f.click,t,p)),a.appendChild(m)}if(this.options.vertical){var g=h<95?95:h;this.options.reverseMenu?r.style.right=-(g+20)+"px":r.style.left=-(g+20)+"px"}else this.options.reverseMenu?r.style.bottom="28px":r.style.top="28px";return r.appendChild(a),r.style.display="none",r},i._getItems=function(){return this.options.items||[]},e}(Yo);ea.mergeOptions({height:28,vertical:!1,position:"top-right",reverseMenu:!1,items:{}});var ia=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.buildOn=function(t){var e=this.options,i=De("div","maptalks-zoom");if(e.zoomLevel){var r=De("span","maptalks-zoom-zoomlevel");i.appendChild(r),this._levelDOM=r}var n=De("div","maptalks-zoom-slider"),o=De("a","maptalks-zoom-zoomin");if(o.href="javascript:;",o.innerHTML="+",n.appendChild(o),this._zoomInButton=o,e.slider){var a=De("div","maptalks-zoom-slider-box"),s=De("div","maptalks-zoom-slider-ruler"),h=De("span","maptalks-zoom-slider-reading"),l=De("span","maptalks-zoom-slider-dot");s.appendChild(h),a.appendChild(s),a.appendChild(l),n.appendChild(a),this._sliderBox=a,this._sliderRuler=s,this._sliderReading=h,this._sliderDot=l}var c=De("a","maptalks-zoom-zoomout");return c.href="javascript:;",c.innerHTML="-",n.appendChild(c),this._zoomOutButton=c,i.appendChild(n),t.on("_zoomend _zooming _zoomstart _spatialreferencechange",this._update,this),this._update(),this._registerDomEvents(),i},i.onRemove=function(){this.getMap().off("_zoomend _zooming _zoomstart _spatialreferencechange",this._update,this),this._zoomInButton&&$e(this._zoomInButton,"click",this._onZoomInClick,this),this._zoomOutButton&&$e(this._zoomOutButton,"click",this._onZoomOutClick,this),this._sliderRuler&&($e(this._sliderRuler,"click",this._onClickRuler,this),this.dotDragger.disable(),delete this.dotDragger)},i._update=function(){var t=this.getMap();if(this._sliderBox){var e=10*(t.getMaxZoom()-t.getMinZoom());this._sliderBox.style.height=e+16+"px",this._sliderRuler.style.height=e+8+"px",this._sliderRuler.style.cursor="pointer";var i=10*(t.getMaxZoom()-t.getZoom());this._sliderReading.style.height=10*(t.getZoom()-t.getMinZoom()+1)+"px",this._sliderDot.style.top=i+"px"}this._updateText()},i._updateText=function(){if(this._levelDOM){var t=this.getMap().getZoom();u(t)||(t=Math.floor(10*t)/10),this._levelDOM.innerHTML=t}},i._registerDomEvents=function(){this._zoomInButton&&Ke(this._zoomInButton,"click",this._onZoomInClick,this),this._zoomOutButton&&Ke(this._zoomOutButton,"click",this._onZoomOutClick,this),this._sliderRuler&&(Ke(this._sliderRuler,"click",this._onClickRuler,this),this.dotDragger=new wi(this._sliderDot,{ignoreMouseleave:!0}),this.dotDragger.on("dragstart",this._onDotDragstart,this).on("dragging dragend",this._onDotDrag,this).enable())},i._onZoomInClick=function(t){ze(t),this.getMap().zoomIn()},i._onZoomOutClick=function(t){ze(t),this.getMap().zoomOut()},i._onClickRuler=function(t){ze(t);var e=this.getMap(),i=Fe(t,this._sliderRuler).y,r=e.getMaxZoom(),n=Math.floor(r-i/10);e.setZoom(n)},i._onDotDragstart=function(t){ze(t.domEvent);var e=this.getMap(),i=e.getSize().toPoint()._multi(.5);e.onZoomStart(e.getZoom(),i)},i._onDotDrag=function(t){ze(t.domEvent);var e=this.getMap(),i=e.getSize().toPoint()._multi(.5),r=Fe(t.domEvent,this._sliderRuler),n=e.getMaxZoom(),o=e.getMinZoom(),a=r.y,s=n-a/10;n<s?(s=n,a=0):o>s&&(s=o,a=10*(n-o)),"dragging"===t.type?e.onZooming(s,i,1):"dragend"===t.type&&(this.options.seamless?e.onZoomEnd(s,i):e.onZoomEnd(Math.round(s),i)),this._sliderDot.style.top=a+"px",this._sliderReading.style.height=10*(e.getZoom()-o+1)+"px",this._updateText()},e}(Yo);ia.mergeOptions({position:"top-left",slider:!0,zoomLevel:!0,seamless:!1}),xr.mergeOptions({zoomControl:!1}),xr.addOnLoadHook(function(){this.options.zoomControl&&(this.zoomControl=new ia(this.options.zoomControl),this.addControl(this.zoomControl))});var ra=Object.freeze({Control:Yo,Attribution:Jo,LayerSwitcher:Qo,Overview:Ko,Panel:$o,Scale:ta,Toolbar:ea,Zoom:ia}),na=function(){function t(t,e,i,r){Array.isArray(t)?(this.scale={x:t[0],y:t[1]},this.origin={x:t[2],y:t[3]}):(this.scale={x:t,y:e},this.origin={x:i,y:r})}return t.getDefault=function(t){return"baidu"===t.code.toLowerCase()?"baidu":t.code.toLowerCase()==="EPSG:4326".toLowerCase()?"tms-global-geodetic":"identity"===t.code.toLowerCase()?[1,-1,0,0]:"web-mercator"},t}(),oa=6378137*Math.PI;h(na,{"web-mercator":new na([1,-1,-oa,oa]),"tms-global-mercator":new na([1,1,-oa,-oa]),"tms-global-geodetic":new na([1,1,-180,-90]),baidu:new na([1,1,0,0])});var aa=function(){function t(t,e,i){this.tileSize=i,this.fullExtent=e,this.prepareTileInfo(t,e),this._xScale=e.right>=e.left?1:-1,this._yScale=e.top>=e.bottom?1:-1}var e=t.prototype;return e.prepareTileInfo=function(t,e){if(d(t)?t=na[t.toLowerCase()]:Array.isArray(t)&&(t=new na(t)),!t)throw new Error("Invalid TileSystem");this.tileSystem=t;var i=e.right>e.left?1:-1,r=e.top>e.bottom?-1:1,n=t.origin.x,o=t.origin.y;this.transformation=new ji([i,r,n,o])},e._getTileNum=function(t,e){var i=this.tileSystem,r=this.tileSize,n=Math.floor(1e-7+t.x/(r.width*e)),o=-Math.floor(1e-7+t.y/(r.height*e));return{x:i.scale.x*n,y:i.scale.y*o}},e.getTileIndex=function(t,e){var i=this.tileSystem,r=this.transformation.transform(t,1),n=this._getTileNum(r,e);return i.scale.x<0&&(n.x-=1),i.scale.y>0&&(n.y-=1),this.getNeighorTileIndex(n.x,n.y,0,0,e)},e.getNeighorTileIndex=function(t,e,i,r,n,o){var a=this.tileSystem,s=t+a.scale.x*i,h=e-a.scale.y*r,l=!1,c=s,u=h,p=this._getTileFullIndex(n);return o&&(!0!==o&&"x"!==o||(p.xmax===p.xmin?s=p.xmin:s<p.xmin?(s=p.xmax-(p.xmin-s)%(p.xmax-p.xmin))===p.xmax&&(s=p.xmin):s>=p.xmax&&(s=p.xmin+(s-p.xmin)%(p.xmax-p.xmin))),!0!==o&&"y"!==o||(p.ymax===p.ymin?h=p.ymin:h>=p.ymax?h=p.ymin+(h-p.ymin)%(p.ymax-p.ymin):h<p.ymin&&(h=p.ymax-(p.ymin-h)%(p.ymax-p.ymin))===p.ymax&&(h=p.ymin))),(s<p.xmin||s>p.xmax||h>p.ymax||h<p.ymin)&&(l=!0),{x:s,y:h,idx:c,idy:u,out:l}},e._getTileFullIndex=function(t){var e=this.fullExtent,i=this.transformation,r=this._getTileNum(i.transform(new bi(e.left,e.top),1),t),n=this._getTileNum(i.transform(new bi(e.right,e.bottom),1),t),o=this.tileSystem;return o.scale.x<0&&(r.x-=1,n.x-=1),o.scale.y>0&&(r.y-=1,n.y-=1),new zi(r,n)},e.getTilePrjNW=function(t,e,i){var r=this.tileSystem,n=this.tileSize,o=r.origin.y+this._yScale*r.scale.y*(e+(1===r.scale.y?1:0))*i*n.height,a=r.origin.x+this._xScale*r.scale.x*(t+(1===r.scale.x?0:1))*i*n.width;return new bi(a,o)},e.getTilePrjSE=function(t,e,i){var r=this.tileSystem,n=this.tileSize,o=r.origin.y+this._yScale*r.scale.y*(e+(1===r.scale.y?0:1))*i*n.height,a=r.origin.x+this._xScale*r.scale.x*(t+(1===r.scale.x?1:0))*i*n.width;return new bi(a,o)},e.getTilePrjExtent=function(t,e,i){var r=this.getTilePrjNW(t,e,i),n=this.getTilePrjSE(t,e,i);return new zi(r,n)},t}(),sa={urlTemplate:null,subdomains:null,repeatWorld:!0,background:!0,backgroundZoomDiff:6,loadingLimitOnInteracting:3,tileRetryCount:0,placeholder:!1,crossOrigin:null,tileSize:[256,256],offset:[0,0],tileSystem:null,fadeAnimation:!w,debug:!1,spatialReference:null,maxCacheSize:256,renderer:re.webgl?"gl":"canvas",clipByPitch:!0,maxAvailableZoom:null,cascadeTiles:!0,minPitchToCascade:35,zoomOffset:0},ha=/\{ *([\w_]+) *\}/g,la=new se(0,0),ca=new se(0,0),ua=new se(0,0),pa=new se(0,0),da=new se(0,0),fa=new ki,ma=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t),e.fromJSON=function(t){return t&&"TileLayer"===t.type?new e(t.id,t.options):null};var i=e.prototype;return i.getTileSize=function(){var t=this.options.tileSize;return c(t)&&(t=[t,t]),new he(t)},i.getTiles=function(t,e){var i=this.getMap(),r=e&&e.getRenderer(),n=i.getContainerExtent(),o=[],a=0,s=this.getMinZoom(),h=this.options.minPitchToCascade,c=l(t)?this._getTileZoom(i.getZoom()):t;if(!l(t)||!this.options.cascadeTiles||i.getPitch()<=h||!l(s)&&c<=s){var u=this._getTiles(c,n,void 0,r);return u&&(a+=u.tiles.length,o.push(u)),{tileGrids:o,count:a}}var p=Math.floor(i._getVisualHeight(h)),d=new ki(0,i.height-p,i.width,i.height),f=this._getTiles(c,d,0,r);a+=f?f.tiles.length:0;var m=new ki(0,n.ymin,i.width,d.ymin),g=i.getSpatialReference().getZoomDirection(),v=this._getTiles(c-g,m,1,r);return a+=v?v.tiles.length:0,o.push(f,v),{tileGrids:o,count:a}},i.getTileUrl=function(t,e,i){var r=this.options.urlTemplate,n="";if(this.options.subdomains){var o=this.options.subdomains;if(N(o)){var a=(t+e)%o.length;a<0&&(a=0),n=o[a]}}if(f(r))return r(t,e,i,n);var s={x:t,y:e,z:i,s:n};return r.replace(ha,function(t,e){var i=s[e];if(void 0===i)throw new Error("No value provided for variable "+t);return"function"==typeof i&&(i=i(s)),i})},i.clear=function(){return this._renderer&&this._renderer.clear(),this.fire("clear"),this},i.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),options:this.config()}},i.getSpatialReference=function(){var t=this.getMap();return!t||this.options.spatialReference&&!yr.equals(this.options.spatialReference,t.options.spatialReference)?(this._sr=this._sr||new yr(this.options.spatialReference),void 0===this._srMinZoom&&(this._srMinZoom=this._sr.getMinZoom(),this._srMaxZoom=this._sr.getMaxZoom()),this._sr):t.getSpatialReference()},i.getMinZoom=function(){return this.getSpatialReference()!==this.getMap().getSpatialReference()?Math.max(t.prototype.getMinZoom.call(this),this._srMinZoom):t.prototype.getMinZoom.call(this)},i.getMaxZoom=function(){return this.getSpatialReference()!==this.getMap().getSpatialReference()?Math.min(t.prototype.getMaxZoom.call(this),this._srMaxZoom):t.prototype.getMaxZoom.call(this)},i._getTileZoom=function(t){u(t)||(t=Math.round(t));var e=this.options.maxAvailableZoom;return!l(e)&&t>e&&(t=e),t},i._getTiles=function(t,e,i,r){var n=this.getMap(),o=t+this.options.zoomOffset,a=this._getTileOffset(o),s=a[0]||a[1],h={zoom:t,extent:null,offset:a,tiles:[]};if(o<0)return h;var c=this.getMinZoom(),u=this.getMaxZoom();if(!(n&&this.isVisible()&&n.width&&n.height))return h;if(!l(c)&&t<c||!l(u)&&t>u)return h;var p=this._getTileConfig();if(!p)return h;var d=this.getSpatialReference(),f=n.getSpatialReference(),m=d.getResolution(o),g=e.convertTo(function(t){return n._containerPointToPoint(t,void 0,la)}),v=this._getInnerExtent(t,e,g)._add(a);g._add(a);var y=g.sub(a),E=this._getMask2DExtent();if(E){var x=E.intersection(g);if(!x)return h;e=x.convertTo(function(t){return n._pointToContainerPoint(t,void 0,0,la)})}var _,w=n._containerPointToPrj(e.getCenter(),ca);_=s?this._project(n._pointToPrj(n._prjToPoint(w,void 0,ua)._add(a),void 0,ua),ua):this._project(w,ua),pa.x=g.xmin,pa.y=g.ymin,da.x=g.xmax,da.y=g.ymax;for(var b=this._project(n._pointToPrj(pa,void 0,pa),pa),S=this._project(n._pointToPrj(da,void 0,da),da),T=p.getTileIndex(_,m),M=p.getTileIndex(b,m),R=p.getTileIndex(S,m),A=Math.ceil(Math.abs(T.y-M.y)),C=Math.ceil(Math.abs(T.x-M.x)),P=Math.ceil(Math.abs(T.y-R.y)),D=Math.ceil(Math.abs(T.x-R.x)),L=this.getTileSize(),O=this.getId(),H=this.getRenderer()||r,I=this._getTileConfig().tileSystem.scale,B={},z=[],N=new ki,k=-A;k<=P;k++)for(var j=-C,V=-1/0,F=!1;j>=V&&j<=D;){var U=p.getNeighorTileIndex(T.x,T.y,j,k,m,d===f&&this.options.repeatWorld);if(V===-1/0?j++:j--,!U.out){var G=!1,W=this._getTileId(U,o),X=void 0;B[W]||(X=H&&H.isTileCachedOrLoading(W),B[W]=1),X&&(X=X.info,G=!0);var Z=void 0;if(X){var Y=X.point0;Z=X.point.set(Y.x,Y.y)}else{var q=p.getTilePrjNW(U.x,U.y,m);Z=n._prjToPoint(this._unproject(q,da),t)}var J=void 0,Q=void 0;if(d===f)J=L.width,Q=L.height;else{var K=p.getTilePrjSE(U.x,U.y,m),$=n._prjToPoint(this._unproject(K,da),t,da);J=Math.ceil(Math.abs($.x-Z.x)),Q=Math.ceil(Math.abs($.y-Z.y))}var tt=I.x*(U.idx-U.x)*J,et=-I.y*(U.idy-U.y)*Q;if((tt||et)&&Z._add(tt,et),s&&Z._sub(a),!X){var it=new ki(Z.x,Z.y,Z.x+J,Z.y+Q);X={point0:Z.add(a)._sub(tt,et),point:Z,z:t,x:U.x,y:U.y,extent2d:it,mask:i}}var rt=X.extent2d;(F||v.intersects(rt)||!v.equals(y)&&this._isTileInExtent(X,e))&&(s&&(rt.set(Z.x,Z.y,Z.x+J,Z.y+Q),X.point=Z._add(a),rt._add(a)),G||(X.size=[J,Q],X.id=W,X.dupKey=W,X.layer=O,X.url=this.getTileUrl(U.x,U.y,o)),z.push(X),N._combine(rt),V===-1/0?(V=j,j=D):F||(F=!0))}}var nt=n._containerPointToPoint(e.getCenter(),t,la)._add(a);return z.sort(function(t,e){return t.point.distanceTo(nt)-e.point.distanceTo(nt)}),{offset:a,zoom:t,extent:N,tiles:z}},i._getInnerExtent=function(t,e,i){var r=this.getMap(),n=r.getResolution(t),o=r.getResolution()/n,a=i.getCenter()._multi(o),s=r.getBearing()*Math.PI/180,h=e.getHeight()/2*o,l=e.getWidth()/2*o,c=Math.abs(Math.cos(s)*h)||h,u=Math.abs(Math.sin(s)*h)||l;return new ki(a.x-u,a.y-c,a.x+u,a.y+c)},i._getTileOffset=function(t){var e=this.getMap(),i=e._getResolution()/e._getResolution(t),r=this.options.offset;return f(r)&&(r=r(this)),r[0]*=i,r[1]*=i,r},i._getTileId=function(t,e,i){return(i||this.getId())+"-"+t.idy+"-"+t.idx+"-"+e},i._project=function(t,e){var i=this.getMap(),r=this.getSpatialReference();if(r!==i.getSpatialReference()){var n=i.getProjection();return r.getProjection().project(n.unproject(t,e),e)}return t},i._unproject=function(t,e){var i=this.getMap(),r=this.getSpatialReference();if(r!==i.getSpatialReference()){var n=i.getProjection(),o=r.getProjection();return n.project(o.unproject(t,e),e)}return t},i._initTileConfig=function(){var t=this.getMap(),e=this.getTileSize(),i=this.getSpatialReference(),r=i.getProjection(),n=i.getFullExtent();if(this._defaultTileConfig=new aa(na.getDefault(r),n,e),this.options.tileSystem&&(this._tileConfig=new aa(this.options.tileSystem,n,e)),t&&!this._tileConfig&&t.getSpatialReference()===i&&t.getBaseLayer()&&t.getBaseLayer()!==this&&t.getBaseLayer()._getTileConfig){var o=t.getBaseLayer()._getTileConfig();this._tileConfig=new aa(o.tileSystem,o.fullExtent,e)}},i._getTileConfig=function(){return this._defaultTileConfig||this._initTileConfig(),this._tileConfig||this._defaultTileConfig},i._bindMap=function(e){var i=e.getBaseLayer();return i===this&&(i.options.hasOwnProperty("forceRenderOnMoving")||this.config({forceRenderOnMoving:!0})),t.prototype._bindMap.apply(this,arguments)},i._isTileInExtent=function(t,e){this._convertPointCallback||(this._convertPointCallback=function(t){return this.getMap()._pointToContainerPoint(t,this._coordTileZoom,0,la)}.bind(this));var i=t.z;this._coordTileZoom=i;var r=t.extent2d.convertTo(this._convertPointCallback,fa);return e.intersects(r)},i.getEvents=function(){return{spatialreferencechange:this._onSpatialReferenceChange}},i._onSpatialReferenceChange=function(){delete this._tileConfig,delete this._defaultTileConfig,delete this._sr;var t=this.getRenderer();t&&t.clear()},e}(lr);ma.registerJSONType("TileLayer"),ma.mergeOptions(sa);var ga=function(t){function e(e,i,r){var n;return(n=t.call(this,e,r)||this).layers=i||[],n._checkChildren(),n.layerMap={},n._groupChildren=[],n}ne(e,t),e.fromJSON=function(t){if(!t||"GroupTileLayer"!==t.type)return null;var i=t.layers.map(function(t){return lr.fromJSON(t)});return new e(t.id,i,t.options)};var i=e.prototype;return i.getLayers=function(){return this.layers},i.toJSON=function(){return{type:this.getJSONType(),id:this.getId(),layers:this.layers.map(function(t){return t.toJSON()}),options:this.config()}},i.getTiles=function(t){for(var e=this.layers,i=[],r=0,n=0,o=e.length;n<o;n++){var a=e[n];if(a.options.visible){var s=a.getTiles(t,this);s&&0!==s.count&&(r+=s.count,C(i,s.tileGrids))}}return{count:r,tileGrids:i}},i.onAdd=function(){var e=this,i=this.getMap();this.layers.forEach(function(t){e.layerMap[t.getId()]=t,t.getChildLayer&&e._groupChildren.push(t),t._bindMap(i),t.on("show hide",e._onLayerShowHide,e)}),t.prototype.onAdd.call(this)},i.onRemove=function(){var e=this;this.layers.forEach(function(t){t._doRemove(),t.off("show hide",e._onLayerShowHide,e)}),this.layerMap={},this._groupChildren=[],t.prototype.onRemove.call(this)},i.getChildLayer=function(t){var e=this.layerMap[t];if(e)return e;for(var i=0;i<this._groupChildren.length;i++){var r=this._groupChildren[i].getChildLayer(t);if(r)return r}return null},i._onLayerShowHide=function(){var t=this.getRenderer();t&&t.setToRedraw()},i.isVisible=function(){if(!t.prototype.isVisible.call(this))return!1;for(var e=this.layers,i=0,r=e.length;i<r;i++)if(e[i].isVisible())return!0;return!1},i._checkChildren=function(){var t=this,e={};this.layers.forEach(function(i){var r=i.getId();if(e[r])throw new Error("Duplicate child layer id ("+r+") in the GroupTileLayer ("+t.getId()+")");e[r]=1})},e}(ma);ga.registerJSONType("GroupTileLayer");var va={crs:null,uppercase:!1,detectRetina:!1},ya={service:"WMS",request:"GetMap",layers:"",styles:"",format:"image/jpeg",transparent:!1,version:"1.1.1"},Ea=function(t){function e(e,i){var r;r=t.call(this,e)||this;var n=h({},ya);for(var o in i)o in r.options||(n[o]=i[o]);r.setOptions(i),r.setZIndex(i.zIndex);var a=r.getTileSize();return n.width=a.width,n.height=a.height,r.wmsParams=n,r._wmsVersion=parseFloat(n.version),r}ne(e,t);var i=e.prototype;return i.onAdd=function(){var e=this.getMap().getDevicePixelRatio(),i=va.detectRetina?e:1;this.wmsParams.width*=i,this.wmsParams.height*=i;var r=this.options.crs||this.getMap().getProjection().code,n=this._wmsVersion>=1.3?"crs":"srs";this.wmsParams[n]=r,t.prototype.onAdd.call(this)},i.getTileUrl=function(e,i,r){var n=this.getSpatialReference().getResolution(r),o=this._getTileConfig().getTilePrjExtent(e,i,n),a=o.getMax(),s=o.getMin(),h=(this._wmsVersion>=1.3&&"EPSG:4326"===this.wmsParams.crs?[s.y,s.x,a.y,a.x]:[s.x,s.y,a.x,a.y]).join(","),l=t.prototype.getTileUrl.call(this,e,i,r);return l+function(t,e,i){var r=[];for(var n in t)r.push(encodeURIComponent(i?n.toUpperCase():n)+"="+encodeURIComponent(t[n]));return(e&&-1!==e.indexOf("?")?"&":"?")+r.join("&")}(this.wmsParams,l,this.options.uppercase)+(this.options.uppercase?"&BBOX=":"&bbox=")+h},i.toJSON=function(){return{type:"WMSTileLayer",id:this.getId(),options:this.config()}},e.fromJSON=function(t){return t&&"WMSTileLayer"===t.type?new e(t.id,t.options):null},e}(ma);Ea.registerJSONType("WMSTileLayer"),Ea.mergeOptions(va);var xa=function(t){function e(e,i){var r;return(r=t.call(this,e,i)||this).options.hasOwnProperty("forceRenderOnMoving")||(r.options.forceRenderOnMoving=!1),r}ne(e,t);var i=e.prototype;return i.drawTile=function(){},i.toJSON=function(){return{type:"CanvasTileLayer",id:this.getId(),options:this.config()}},e.fromJSON=function(t){return t&&"CanvasTileLayer"===t.type?new e(t.id,t.options):null},e}(ma);function _a(t,e,i){var r=t.createShader(e);if(t.shaderSource(r,i),t.compileShader(r),!t.getShaderParameter(r,t.COMPILE_STATUS)){var n=t.getShaderInfoLog(r);throw t.deleteShader(r),new Error("Failed to compile shader: "+n)}return r}xa.registerJSONType("CanvasTileLayer");var wa="\n        attribute vec3 a_position;\n\n        attribute vec2 a_texCoord;\n\n        uniform mat4 u_matrix;\n\n        varying vec2 v_texCoord;\n\n        void main() {\n            gl_Position = u_matrix * vec4(a_position, 1.0);\n\n            v_texCoord = a_texCoord;\n        }\n    ",ba="\n        precision mediump float;\n\n        uniform sampler2D u_image;\n\n        uniform float u_opacity;\n\n        varying vec2 v_texCoord;\n\n        void main() {\n\n            gl_FragColor = texture2D(u_image, v_texCoord) * u_opacity;\n\n        }\n    ",Sa=[0,0],Ta=[0,0,0],Ma=new Array(16),Ra=function(t){var e,i=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.drawGLImage=function(t,e,i,r,n,o){var a=this.gl;this.loadTexture(t),Ta[0]=e||0,Ta[1]=i||0;var s=fo(Ma);lo(s,s,Ta),uo(s,this.getMap().projViewMatrix,s),a.uniformMatrix4fv(this.program.u_matrix,!1,s),a.uniform1f(this.program.u_opacity,o);var h=t.glBuffer;!h||h.width===r&&h.height===n||(this.saveImageBuffer(h),delete t.glBuffer),t.glBuffer?a.bindBuffer(a.ARRAY_BUFFER,h):t.glBuffer=this.bufferTileData(0,0,r,n),Sa[0]="a_position",Sa[1]=3,this.enableVertexAttrib(Sa),a.drawArrays(a.TRIANGLE_STRIP,0,4)},i.bufferTileData=function(t,e,i,r,n){var o=t,a=t+i,s=e,h=e+r,l=this.loadImageBuffer(this.set12(o,s,0,o,h,0,a,s,0,a,h,0),n);return l.width=i,l.height=r,l},i.drawTinImage=function(t,e,i,r,n){var o=this.gl;this.loadTexture(t),o.uniformMatrix4fv(this.program.u_matrix,!1,this.getMap().projViewMatrix),o.uniform1f(this.program.u_opacity,n),o.bindBuffer(o.ARRAY_BUFFER,this.posBuffer),this.enableVertexAttrib(["a_position",3]),o.bufferData(o.ARRAY_BUFFER,new Float32Array(e),o.DYNAMIC_DRAW),o.bindBuffer(o.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2]),o.bufferData(o.ARRAY_BUFFER,new Float32Array(i),o.DYNAMIC_DRAW),o.bufferData(o.ELEMENT_ARRAY_BUFFER,new Uint16Array(r),o.DYNAMIC_DRAW),o.drawElements(o.TRIANGLES,r.length,o.UNSIGNED_SHORT,0)},i.createCanvas2=function(){this.canvas2=ni.createCanvas(this.canvas.width,this.canvas.height)},i.createGLContext=function(){this.canvas.gl&&this.canvas.gl.wrap?this.gl=this.canvas.gl.wrap():this.gl=function(t,e){for(var i={alpha:!0,stencil:!0,preserveDrawingBuffer:!0,antialias:!1},r=["webgl","experimental-webgl"],n=null,o=0;o<r.length;++o){try{n=t.getContext(r[o],e||i)}catch(t){}if(n)break}return n}(this.canvas2||this.canvas,this.layer.options.glOptions);var t=this.gl;t.clearColor(0,0,0,0),t.disable(t.DEPTH_TEST),t.enable(t.STENCIL_TEST),t.enable(t.BLEND),t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA),this.program=this.createProgram(wa,this.layer.options.fragmentShader||ba,["u_matrix","u_image","u_opacity"]),this.useProgram(this.program),this.texBuffer=this.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.texBuffer),this.enableVertexAttrib(["a_texCoord",2]),t.bufferData(t.ARRAY_BUFFER,new Float32Array([0,0,0,1,1,0,1,1]),t.STATIC_DRAW),this.enableSampler("u_image"),t.activeTexture(t.TEXTURE0),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),this.posBuffer=this.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.posBuffer),this.enableVertexAttrib(["a_position",3]),this.indicesBuffer=this.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indicesBuffer)},i.resizeGLCanvas=function(){this.gl&&this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.canvas2&&(this.canvas2.width===this.canvas.width&&this.canvas2.height===this.canvas.height||(this.canvas2.width=this.canvas.width,this.canvas2.height=this.canvas.height))},i.clearGLCanvas=function(){this.gl&&this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.STENCIL_BUFFER_BIT)},i.disposeImage=function(t){t&&(t.texture&&this.saveTexture(t.texture),t.glBuffer&&this.saveImageBuffer(t.glBuffer),delete t.texture,delete t.glBuffer)},i._createTexture=function(t){var e=this.gl,i=this.getTexture()||e.createTexture();return e.bindTexture(e.TEXTURE_2D,i),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,t),u(H(t.width))&&u(H(t.width))&&e.generateMipmap(e.TEXTURE_2D),i},i.getTexture=function(){this._textures||(this._textures=[]);var t=this._textures;return t&&t.length>0?t.pop():null},i.saveTexture=function(t){this._textures.push(t)},i.loadTexture=function(t){var e=this.gl,i=t.texture;return i||(i=this._createTexture(t),t.texture=i),e.bindTexture(e.TEXTURE_2D,i),i},i.getImageBuffer=function(){this._imageBuffers||(this._imageBuffers=[]);var t=this._imageBuffers;return t&&t.length>0?t.pop():null},i.saveImageBuffer=function(t){this._imageBuffers.push(t)},i.loadImageBuffer=function(t,e){var i=this.gl,r=e||this.createImageBuffer();return i.bindBuffer(i.ARRAY_BUFFER,r),i.bufferData(i.ARRAY_BUFFER,t,i.STATIC_DRAW),r},i.createImageBuffer=function(){return this.getImageBuffer()||this.createBuffer()},i.removeGLCanvas=function(){var t=this.gl;if(t){this._buffers&&(this._buffers.forEach(function(e){t.deleteBuffer(e)}),delete this._buffers),this._textures&&(this._textures.forEach(function(e){return t.deleteTexture(e)}),delete this._textures),delete this.posBuffer;var e=t.program;t.deleteShader(e.fragmentShader),t.deleteShader(e.vertexShader),t.deleteProgram(e),delete this.gl,delete this.canvas2}},i.createBuffer=function(){var t=this.gl.createBuffer();if(!t)throw new Error("Failed to create the buffer object");return this._buffers||(this._buffers=[]),this._buffers.push(t),t},i.enableVertexAttrib=function(t){!function(t,e,i){if(Array.isArray(i[0])){for(var r=Float32Array.BYTES_PER_ELEMENT,n=0,o=0;o<i.length;o++)n+=i[o][1]||0;for(var a=0,s=0;s<i.length;s++){var h=t.getAttribLocation(e,i[s][0]);if(h<0)throw new Error("Failed to get the storage location of "+i[s][0]);t.vertexAttribPointer(h,i[s][1],t[i[s][2]||"FLOAT"],!1,r*n,r*a),a+=i[s][1]||0,t.enableVertexAttribArray(h)}}else{var l=t.getAttribLocation(e,i[0]);t.vertexAttribPointer(l,i[1],t[i[2]||"FLOAT"],!1,0,0),t.enableVertexAttribArray(l)}}(this.gl,this.gl.program,t)},i.createProgram=function(t,e,i){var r=function(t,e,i){var r=_a(t,t.VERTEX_SHADER,e),n=_a(t,t.FRAGMENT_SHADER,i);if(!r||!n)return null;var o=t.createProgram();return o?(t.attachShader(o,r),t.attachShader(o,n),t.linkProgram(o),{program:o,vertexShader:r,fragmentShader:n}):null}(this.gl,t,e),n=r.program,o=r.vertexShader,a=r.fragmentShader;return n.vertexShader=o,n.fragmentShader=a,this._initUniforms(n,i),n},i.useProgram=function(t){var e=this.gl;return e.useProgram(t),e.program=t,this},i.enableSampler=function(t,e){var i=this.gl,r=this._getUniform(i.program,t);return e||(e=0),i.uniform1i(r,e),r},i._initUniforms=function(t,e){for(var i=0;i<e.length;i++){var r=e[i],n=e[i],o=r.indexOf("[");o>=0&&(r=r.substring(0,o),w||(n=n.substring(0,o))),t[r]=this._getUniform(t,n)}},i._getUniform=function(t,e){var i=this.gl.getUniformLocation(t,e);if(!i)throw new Error("Failed to get the storage location of "+e);return i},e}(t);return h(i.prototype,{set12:(e=re.ie9?null:new Float32Array(12),function(t,i,r,n,o,a,s,h,l,c,u,p){return e[0]=t,e[1]=i,e[2]=r,e[3]=n,e[4]=o,e[5]=a,e[6]=s,e[7]=h,e[8]=l,e[9]=c,e[10]=u,e[11]=p,e})}),i},Aa={renderer:re.webgl?"gl":"canvas",crossOrigin:null},Ca=function(t){function e(e,i,r){var n;return!i||Array.isArray(i)||i.url||(r=i,i=null),(n=t.call(this,e,r)||this)._images=i,n}ne(e,t);var i=e.prototype;return i.onAdd=function(){this._prepareImages(this._images)},i.setImages=function(t){return this._images=t,this._prepareImages(t),this},i.getImages=function(){return this._images},i._prepareImages=function(t){t=t||[],Array.isArray(t)||(t=[t]);var e=this.getMap();this._imageData=t.map(function(t){var i=new zi(t.extent);return h({},t,{extent:i,extent2d:i.convertTo(function(t){return e.coordToPoint(t,e.getGLZoom())})})}),this._images=t;var i=this.getRenderer();i&&i.refreshImages()},e}(lr);Ca.mergeOptions(Aa);var Pa=[],Da=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.isDrawable=function(){return!this.getMap().getPitch()||(console,!1)},i.checkResources=function(){var t=this;if(this._imageLoaded)return Pa;var e=this.layer._imageData.map(function(t){return[t.url,null,null]});if(this.resources){var i=[],r=new hr;e.forEach(function(e){if(t.resources.isResourceLoaded(e)){var n=t.resources.getImage(e);r.addResource(e,n)}else i.push(e)}),this.resources.forEach(function(e,i){r.isResourceLoaded(e)||t.retireImage(i.image)}),this.resources=r,e=i}return this._imageLoaded=!0,e},i.retireImage=function(){},i.refreshImages=function(){this._imageLoaded=!1,this.setToRedraw()},i.needToRedraw=function(){var e=this.getMap();return!(e.isZooming()&&!e.getPitch())&&t.prototype.needToRedraw.call(this)},i.draw=function(){this.isDrawable()&&(this.prepareCanvas(),this._painted=!1,this._drawImages(),this.completeRender())},i._drawImages=function(){var t=this.layer._imageData,e=this.getMap(),i=e._get2DExtent(e.getGLZoom());if(t&&t.length)for(var r=0;r<t.length;r++){var n=t[r].extent2d,o=this.resources&&this.resources.getImage(t[r].url);o&&i.intersects(n)&&(this._painted=!0,this._drawImage(o,n,t[r].opacity||1))}},i._drawImage=function(t,e,i){var r=0,n=this.context;i<1&&(r=n.globalAlpha,n.globalAlpha=i);var o=this.getMap(),a=e.getMin(),s=e.getMax(),h=o._pointToContainerPoint(a,o.getGLZoom()),l=h.x,c=h.y,u=o.getBearing();u&&(n.save(),n.translate(l,c),u&&n.rotate(-u*Math.PI/180),l=c=0);var p=o.getGLScale();n.drawImage(t,l,c,(s.x-a.x)/p,(s.y-a.y)/p),u&&n.restore(),r&&(n.globalAlpha=r)},i.drawOnInteracting=function(){this.draw()},e}(sr),La=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.isDrawable=function(){return!0},i._drawImage=function(t,e,i){this.drawGLImage(t,e.xmin,e.ymin,e.getWidth(),e.getHeight(),i)},i.createContext=function(){this.createGLContext()},i.resizeCanvas=function(e){this.canvas&&(t.prototype.resizeCanvas.call(this,e),this.resizeGLCanvas())},i.clearCanvas=function(){this.canvas&&(t.prototype.clearCanvas.call(this),this.clearGLCanvas())},i.retireImage=function(t){this.disposeImage(t)},i.onRemove=function(){this.removeGLCanvas(),t.prototype.onRemove.call(this)},e}(Ra(Da));Ca.registerRenderer("canvas",Da),Ca.registerRenderer("gl",La);var Oa=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.getPrepareParams=function(){return[]},i.getDrawParams=function(){return[]},i.onCanvasCreate=function(){this.canvas&&this.layer.options.doubleBuffer&&(this.buffer=ni.createCanvas(this.canvas.width,this.canvas.height,this.getMap().CanvasClass))},i.needToRedraw=function(){return!!this.layer.options.animation||!(this.getMap().isInteracting()&&!this.layer.drawOnInteracting)&&t.prototype.needToRedraw.call(this)},i.draw=function(){this.prepareCanvas(),this.prepareDrawContext(),this._drawLayer()},i.drawOnInteracting=function(){this._drawLayerOnInteracting()},i.getCanvasImage=function(){var e=t.prototype.getCanvasImage.call(this);if(e&&e.image&&this.layer.options.doubleBuffer){var i=e.image;this.buffer.width===i.width&&this.buffer.height===i.height||(this.buffer.width=i.width,this.buffer.height=i.height);var r=this.buffer.getContext("2d"),n=this.layer.doubleBuffer(r,this.context);(void 0===n||n)&&(ni.image(r,i,0,0),e.image=this.buffer)}return e},i.remove=function(){return delete this._drawContext,t.prototype.remove.call(this)},i.onZoomStart=function(e){this.layer.onZoomStart(e),t.prototype.onZoomStart.call(this,e)},i.onZooming=function(e){this.layer.onZooming(e),t.prototype.onZooming.call(this,e)},i.onZoomEnd=function(e){this.layer.onZoomEnd(e),t.prototype.onZoomEnd.call(this,e)},i.onMoveStart=function(e){this.layer.onMoveStart(e),t.prototype.onMoveStart.call(this,e)},i.onMoving=function(e){this.layer.onMoving(e),t.prototype.onMoving.call(this,e)},i.onMoveEnd=function(e){this.layer.onMoveEnd(e),t.prototype.onMoveEnd.call(this,e)},i.onResize=function(e){this.layer.onResize(e),t.prototype.onResize.call(this,e)},i.prepareDrawContext=function(){if(!this._predrawed){var t=Ha(this.getPrepareParams());this._drawContext=this.layer.prepareToDraw.apply(this.layer,[this.context].concat(t)),this._drawContext||(this._drawContext=[]),Array.isArray(this._drawContext)||(this._drawContext=[this._drawContext]),this._predrawed=!0}},i._prepareDrawParams=function(){if(!this.getMap())return null;var t=this.getViewExtent();if(t.maskExtent&&!t.extent.intersects(t.maskExtent))return this.completeRender(),null;var e=[this.context,t],i=Ha(this.getDrawParams());return e.push.apply(e,i),e.push.apply(e,this._drawContext),e},i._drawLayer=function(){var t=this._prepareDrawParams();t&&(this.layer.draw.apply(this.layer,t),this.completeRender())},i._drawLayerOnInteracting=function(){if(this.layer.drawOnInteracting){var t=this._prepareDrawParams();t&&(this.layer.drawOnInteracting.apply(this.layer,t),this.completeRender())}},e}(sr);function Ha(t){return t||(t=[]),Array.isArray(t)||(t=[t]),t}var Ia=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.isCanvasRender=function(){return!0},i.prepareToDraw=function(){},i.draw=function(){},i.redraw=function(){return this._getRenderer()&&this._getRenderer().setToRedraw(),this},i.play=function(){return this.config("animation",!0),this},i.pause=function(){return this.config("animation",!1),this},i.isPlaying=function(){return this.options.animation},i.clearCanvas=function(){return this._getRenderer()&&this._getRenderer().clearCanvas(),this},i.requestMapToRender=function(){return this._getRenderer()&&this._getRenderer().requestMapToRender(),this},i.completeRender=function(){return this._getRenderer()&&this._getRenderer().completeRender(),this},i.onCanvasCreate=function(){return this},i.onZoomStart=function(){},i.onZooming=function(){},i.onZoomEnd=function(){},i.onMoveStart=function(){},i.onMoving=function(){},i.onMoveEnd=function(){},i.onResize=function(){},i.doubleBuffer=function(t){return t.clearRect(0,0,t.canvas.width,t.canvas.height),this},e}(lr);Ia.mergeOptions({doubleBuffer:!1,animation:!1}),Ia.registerRenderer("canvas",Oa);var Ba=new se(0,0),za=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.getParticles=function(){},i.draw=function(t,e){var i=this.getParticles(s());if(i&&0!==i.length){var r=this.getMap(),n=e.extent;e.maskExtent&&(n=e.extent.intersection(e.maskExtent)),n=n.convertTo(function(t){return r._pointToContainerPoint(t,void 0,0,Ba)});for(var o=2*Math.PI,a=0,h=i.length;a<h;a++){var l=i[a].point;if(n.contains(l)){var c=i[a].color||this.options.lineColor||"#fff",u=i[a].r;t.fillStyle!==c&&(t.fillStyle=c),u<=2?t.fillRect(l.x-u/2,l.y-u/2,u,u):(t.beginPath(),t.arc(l.x,l.y,u/2,0,o),t.fill())}}this._fillCanvas(t)}else{this._getRenderer()&&(this._getRenderer()._shouldClear=!0)}},i._fillCanvas=function(t){var e=t.globalCompositeOperation;t.globalCompositeOperation="destination-out";var i=this.options.trail||30;t.fillStyle="rgba(0, 0, 0, "+1/i+")",t.fillRect(0,0,t.canvas.width,t.canvas.height),t.globalCompositeOperation=e},e}(Ia);za.mergeOptions({animation:!0}),za.registerRenderer("canvas",function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.draw=function(){this.canvas&&this.layer.options.animation&&!this._shouldClear||(this.prepareCanvas(),this._shouldClear=!1),this.prepareDrawContext(),this._drawLayer()},i.drawOnInteracting=function(){this.draw(),this._shouldClear=!1},i.onSkipDrawOnInteracting=function(){this._shouldClear=!0},e}(Oa));function Na(t,e){return{markerType:t,markerFill:"#fff",markerLineColor:"#000",markerLineWidth:2,markerWidth:10,markerHeight:10,opacity:e}}var ka={fixAspectRatio:!1,symbol:null,removeVertexOn:"contextmenu",centerHandleSymbol:Na("ellipse",1),vertexHandleSymbol:Na("square",1),newVertexHandleSymbol:Na("square",.4)},ja=function(t){function e(e,i){var r;return(r=t.call(this,i)||this)._geometry=e,r._geometry?r:oe(r)}ne(e,t);var i=e.prototype;return i.getMap=function(){return this._geometry.getMap()},i.prepare=function(){this.getMap()&&(this.options.symbol&&(this._originalSymbol=this._geometry.getSymbol(),this._geometry.setSymbol(this.options.symbol)),this._prepareEditStageLayer())},i._prepareEditStageLayer=function(){var t=this.getMap(),e=M(),i="_maptalks__internal_layer__edit_stage_"+e,r="_maptalks__internal_layer__edit_stage_"+e+"_shadow";this._editStageLayer=t.getLayer(i),this._shadowLayer=t.getLayer(r),this._editStageLayer||(this._editStageLayer=new eo(i),t.addLayer(this._editStageLayer)),this._shadowLayer||(this._shadowLayer=new eo(r),t.addLayer(this._shadowLayer))},i.start=function(){var t=this;if(this._geometry&&this._geometry.getMap()&&!this._geometry.editing){var e=this.getMap();this.editing=!0;var i=this._geometry;this._geometryDraggble=i.options.draggable,i.config("draggable",!1),this.prepare();var r=i.copy();r.setSymbol(i._getInternalSymbol()),r.copyEventListeners(i),i._getParent()&&r.copyEventListeners(i._getParent()),r.setId(null).config({draggable:!1}),this._shadow=r,this._switchGeometryEvents("on"),i.hide(),(i instanceof bn||i instanceof In||i instanceof zn||i instanceof Bn)&&this._createOrRefreshOutline(),this._shadowLayer.bringToFront().addGeometry(r),this._editStageLayer.bringToFront(),this._addListener([e,"zoomstart",function(){t._editStageLayer.hide()}]),this._addListener([e,"zoomend",function(){t._editStageLayer.show()}]),i instanceof bn?(r.config("draggable",!0),r.on("dragend",this._onMarkerDragEnd,this)):this._createCenterHandle(),i instanceof bn?this.createMarkerEditor():i instanceof In?this.createCircleEditor():i instanceof zn?this.createEllipseOrRectEditor():i instanceof Bn?this.createEllipseOrRectEditor():i instanceof Nn||(i instanceof _n||i instanceof Tn)&&this.createPolygonEditor()}},i.stop=function(){delete this._history,delete this._historyPointer,delete this._editOutline,this._switchGeometryEvents("off"),this.getMap()&&(delete this._shadow,this._geometry.config("draggable",this._geometryDraggble),delete this._geometryDraggble,this._geometry.show(),this._editStageLayer.remove(),this._shadowLayer.remove(),this._clearAllListeners(),this._refreshHooks=[],this.options.symbol&&(this._geometry.setSymbol(this._originalSymbol),delete this._originalSymbol),this.editing=!1)},i.isEditing=function(){return!l(this.editing)&&this.editing},i._getGeometryEvents=function(){return{symbolchange:this._onGeoSymbolChange,"positionchange shapechange":this._exeAndReset}},i._switchGeometryEvents=function(t){if(this._geometry){var e=this._getGeometryEvents();for(var i in e)this._geometry[t](i,e[i],this)}},i._onGeoSymbolChange=function(t){this._shadow&&this._shadow.setSymbol(t.target._getInternalSymbol())},i._onMarkerDragEnd=function(){this._update("setCoordinates",this._shadow.getCoordinates().toArray()),this._refresh()},i._createOrRefreshOutline=function(){var t=this._geometry,e=this._editOutline;return e?(e.remove(),this._editOutline=e=t.getOutline(),this._editStageLayer.addGeometry(e)):(e=t.getOutline(),this._editStageLayer.addGeometry(e),this._editOutline=e,this._addRefreshHook(this._createOrRefreshOutline)),e},i._createCenterHandle=function(){var t,e=this,i=this._shadow.getCenter(),r=this.options.centerHandleSymbol,n=this.createHandle(i,{symbol:r,cursor:"move",onDown:function(){var i=Dt((t=e._shadow.copy())._getInternalSymbol(),.5);t.setSymbol(i).addTo(e._editStageLayer)},onMove:function(e,i){var r=i.coordOffset;t.translate(r)},onUp:function(){e._update("setCoordinates",bi.toNumberArrays(t.getCoordinates())),t.remove(),e._refresh()}});this._addRefreshHook(function(){var t=e._shadow.getCenter();n.setCoordinates(t)})},i._createHandleInstance=function(t,e){var i=e.symbol;return new bn(t,{draggable:!0,dragShadow:!1,dragOnAxis:e.axis,cursor:e.cursor,symbol:i})},i.createHandle=function(t,e){e||(e={});var i=this.getMap(),r=this._createHandleInstance(t,e),n=this;function o(t){return e.onDown&&(this._geometry.fire("handledragstart"),e.onDown.call(n,t.viewPoint,t)),!1}function a(t){n._hideContext();var o=i._prjToViewPoint(r._getPrjCoordinates());return e.onMove&&(this._geometry.fire("handledragging"),e.onMove.call(n,o,t)),!1}function s(t){return e.onUp&&(this._geometry.fire("handledragend"),e.onUp.call(n,t)),!1}return r.on("dragstart",o,this),r.on("dragging",a,this),r.on("dragend",s,this),r.on("removestart",function t(){r.config("draggable",!1),r.off("dragstart",o,n),r.off("dragging",a,n),r.off("dragend",s,n),r.off("removestart",t,n),delete r["maptalks--editor-refresh-fn"]},this),e.onRefresh&&(r["maptalks--editor-refresh-fn"]=e.onRefresh),this._editStageLayer.addGeometry(r),r},i._createResizeHandles=function(t,e,i){var r=this,n=["nw-resize","n-resize","ne-resize","w-resize","e-resize","sw-resize","s-resize","se-resize"],o=[null,"y",null,"x","x",null,"y",null],a=this._geometry;t||(t=[]);var s=this,h=[],l={},c=this.getMap(),u=this.options.vertexHandleSymbol,p=function(){for(var p,d=a._getPainter().get2DExtent(),f=[(p=d).getMin(),new se((p.xmax+p.xmin)/2,p.ymin),new se(p.xmax,p.ymin),new se(p.xmin,(p.ymax+p.ymin)/2),new se(p.xmax,(p.ymax+p.ymin)/2),new se(p.xmin,p.ymax),new se((p.xmax+p.xmin)/2,p.ymax),p.getMax()],m=function(p){if(Array.isArray(t)&&t.some(function(t){return t===p}))return"continue";var d,m=f[p],g=c.pointToCoordinate(m);if(h.length<f.length-t.length){var v=r.createHandle(g,{symbol:u,cursor:n[p],axis:o[p],onMove:(d=p,function(t){s._updating=!0,e(t,d),a.fire("resizing")}),onUp:function(){s._updating=!1,i(),r._refresh()}});v.setId(p),l[p]=h.length,h.push(v)}else h[l[p]].setCoordinates(g)},g=0;g<f.length;g++)m(g)};return p(),this._addRefreshHook(p),h},i.createMarkerEditor=function(){var t=this,e=this._geometry,i=this._shadow,r=this.getMap();if(i._canEdit()){this._history||this._recordHistory(p());var n=i._getInternalSymbol(),o=new se(0,0);c(n.markerDx)&&(o.x=n.markerDx),c(n.markerDy)&&(o.y=n.markerDy);var a=null;Ir.test(n)?"pin"!==n.markerType&&"pie"!==n.markerType&&"bar"!==n.markerType||(a=[5,6,7]):(zr.test(n)||Gr.test(n))&&(a=[5,6,7]);var s,h=[2,1,2,0,0,2,1,2];if(this.options.fixAspectRatio){var l=i.getSize();s=l.width/l.height}var u=this._createResizeHandles(null,function(n,l){if(a&&a.indexOf(l)>=0){var c=r.viewPointToCoordinate(n.sub(o)),p=i.getCoordinates();c.x=p.x,i.setCoordinates(c),t._updateCoordFromShadow(!0);var d=u[u.length-1-l];n=r.coordToViewPoint(d.getCoordinates())}var f=r._pointToViewPoint(i._getCenter2DPoint()).add(o),m=i._getInternalSymbol(),g=n.sub(f);a&&n.y>f.y&&(g.y=0);var v=a?1:2,y=2*Math.abs(g.x),E=Math.abs(g.y)*v;s&&(E=(y=Math.max(y,E*s))/s);var x=h[l];i instanceof Xn?((s||0===x||2===x)&&(i.setWidth(y),e.setWidth(y)),(s||1===x||2===x)&&(i.setHeight(E),e.setHeight(E))):((s||0===x||2===x)&&(m.markerWidth=y),(s||1===x||2===x)&&(m.markerHeight=E),i.setSymbol(m),e.setSymbol(m))},function(){t._update(p())});this._addListener([r,"zoomend",function(){this._refresh()}])}else console;function p(){var t=[["setCoordinates",i.getCoordinates().toArray()]];return i instanceof Xn?(t.push(["setWidth",i.getWidth()]),t.push(["setHeight",i.getHeight()])):t.push(["setSymbol",i.getSymbol()]),t}},i.createCircleEditor=function(){var t=this,e=this._geometry,i=this._shadow,r=this.getMap();this._history||this._recordHistory([["setCoordinates",i.getCoordinates().toArray()],["setRadius",i.getRadius()]]),this._createResizeHandles(null,function(t){var n,o=r._pointToViewPoint(i._getCenter2DPoint()),a=t.sub(o),s=Math.abs(a.x),h=Math.abs(a.y);n=s>h?r.pixelToDistance(s,0):r.pixelToDistance(0,h),i.setRadius(n),e.setRadius(n)},function(){t._update("setRadius",i.getRadius())})},i.createEllipseOrRectEditor=function(){var t=this,e=[2,1,2,0,0,2,1,2],i=this._geometry,r=this._shadow;this._history||this._recordHistory(h());var n,o=this.getMap(),a=this._geometry instanceof zn;this.options.fixAspectRatio&&(n=i.getWidth()/i.getHeight());var s=this._createResizeHandles(null,function(h,l){var c,u,p,d=a?1:2,f=h,m=e[l];if(a){var g=s[7-l],v=o.coordToViewPoint(g.getCoordinates()),y=(c=f.sub(v)).abs();u=o.pixelToDistance(y.x,0),p=o.pixelToDistance(0,y.y);var E=i.getSize();0===m?(n&&(y.y=y.x/n,E.height=Math.abs(y.y),p=u/n),f.y=v.y-E.height/2):1===m?(n&&(y.x=y.y*n,E.width=Math.abs(y.x),u=p*n),f.x=v.x-E.width/2):n&&(u>p*n?(p=u/n,f.y=v.y+y.x*O(c.y)/n):(u=p*n,f.x=v.x+y.y*O(c.x)*n));var x=o.viewPointToCoordinate(new se(Math.min(f.x,v.x),Math.min(f.y,v.y)));r.setCoordinates(x),t._updateCoordFromShadow(!0)}else{c=o.coordToViewPoint(i.getCenter()).sub(f)._abs(),u=o.pixelToDistance(c.x,0),p=o.pixelToDistance(0,c.y),n&&(p=(u=Math.max(u,p*n))/n)}(n||0===m||2===m)&&(r.setWidth(u*d),i.setWidth(u*d)),(n||1===m||2===m)&&(r.setHeight(p*d),i.setHeight(p*d))},function(){t._update(h())});function h(){return[["setCoordinates",r.getCoordinates().toArray()],["setWidth",r.getWidth()],["setHeight",r.getHeight()]]}},i.createPolygonEditor=function(){var t=this.getMap(),e=this._shadow,i=this,r=t.getProjection();this._history||this._recordHistory("setCoordinates",bi.toNumberArrays(e.getCoordinates()));var n=e instanceof _n?3:2,o="maptalks--editor-refresh-fn",a="maptalks--editor-vertex-index",s=[],h=[];function l(){if(e instanceof _n){var t=e.getCoordinates()[0];return t.slice(0,t.length-1)}return e.getCoordinates()}function c(){return e._getPrjCoordinates()}function u(){for(var t=s.length-1;t>=0;t--)s[t][a]=t;for(var e=h.length-1;e>=0;e--)h[e][a]=e;i._updateCoordFromShadow()}function p(t){var r,o=t.target[a],l=c();l.length<=n||(l.splice(o,1),e._setPrjCoordinates(l),e._updateCache(),s.splice(o,1)[0].remove(),o<h.length&&h.splice(o,1)[0].remove(),r=0===o?h.length-1:o-1,h.splice(r,1)[0].remove(),h.splice(r,0,m.call(i,r)),u(),i._refresh())}function d(r,n){var a,s=c(),l=t._viewPointToPrj(r),u=s[n];u.x=l.x,u.y=l.y,e._updateCache(),e.onShapeChanged(),i._updateCoordFromShadow(!0),a=0===n?h.length-1:n-1,h[n]&&h[n][o](),h[a]&&h[a][o]()}function f(t){var e=l()[t],r=i.createHandle(e,{symbol:i.options.vertexHandleSymbol,cursor:"pointer",axis:null,onMove:function(t){d(t,r[a])},onRefresh:function(){e=l()[r[a]],r.setCoordinates(e)},onUp:function(){i._refresh(),i._updateCoordFromShadow()},onDown:function(t,e){!e||!e.domEvent||e.domEvent.button}});return r[a]=t,r.on(i.options.removeVertexOn,p),r}function m(t){var n,o=l();n=t+1>=o.length?o[0]:o[t+1];var p=o[t].add(n).multi(.5),g=i.createHandle(p,{symbol:i.options.newVertexHandleSymbol,cursor:"pointer",axis:null,onDown:function(t,n){if(!n||!n.domEvent||2!==n.domEvent.button){var o=c(),s=g[a],l=r.project(g.getCoordinates());o.splice(s+1,0,l),e._setPrjCoordinates(o),e._updateCache();var u=g.getSymbol();delete u.opacity,g.setSymbol(u),h.splice(s,0,m.call(i,s),m.call(i,s+1))}},onMove:function(t){d(t,g[a]+1)},onUp:function(t){if(!t||!t.domEvent||2!==t.domEvent.button){var e=g[a];P(g,h),g.remove(),s.splice(e+1,0,f.call(i,e+1)),u(),i._updateCoordFromShadow(),i._refresh()}},onRefresh:function(){o=l();var t,e=g[a];t=e===o.length-1?0:e+1;var i=o[e].add(o[t]).multi(.5);g.setCoordinates(i)}});return g[a]=t,g}for(var g=l(),v=0,y=g.length;v<y;v++)s.push(f.call(this,v)),v<y-1&&h.push(m.call(this,v));e instanceof _n&&h.push(m.call(this,g.length-1)),this._addRefreshHook(function(){for(var t=h.length-1;t>=0;t--)h[t][o]();for(var e=s.length-1;e>=0;e--)s[e][o]()})},i._refresh=function(){if(this._refreshHooks)for(var t=this._refreshHooks.length-1;t>=0;t--)this._refreshHooks[t].call(this)},i._hideContext=function(){this._geometry&&(this._geometry.closeMenu(),this._geometry.closeInfoWindow())},i._addListener=function(t){this._eventListeners||(this._eventListeners=[]),this._eventListeners.push(t),t[0].on(t[1],t[2],this)},i._clearAllListeners=function(){if(this._eventListeners&&this._eventListeners.length>0){for(var t=this._eventListeners.length-1;t>=0;t--){var e=this._eventListeners[t];e[0].off(e[1],e[2],this)}this._eventListeners=[]}},i._addRefreshHook=function(t){t&&(this._refreshHooks||(this._refreshHooks=[]),this._refreshHooks.push(t))},i._update=function(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];this._exeHistory([t,i]),this._recordHistory.apply(this,[t].concat(i))},i._updateCoordFromShadow=function(t){if(this._shadow){var e=this._shadow.getCoordinates(),i=this._geometry,r=this._updating;this._updating=!0,i.setCoordinates(e),t||this._recordHistory("setCoordinates",bi.toNumberArrays(i.getCoordinates())),this._updating=r}},i._recordHistory=function(t){this._history||(this._history=[],this._historyPointer=0),this._historyPointer<this._history.length-1&&this._history.splice(this._historyPointer+1);for(var e=arguments.length,i=new Array(e>1?e-1:0),r=1;r<e;r++)i[r-1]=arguments[r];this._history.push([t,i]),this._historyPointer=this._history.length-1,this._geometry.fire("editrecord")},i.undo=function(){if(!this._history||0===this._historyPointer)return this;var t=this._history[--this._historyPointer];return this._exeAndReset(t),this},i.redo=function(){if(!this._history||this._historyPointer===this._history.length-1)return null;var t=this._history[++this._historyPointer];return this._exeAndReset(t),this},i._exeAndReset=function(t){if(!this._updating){this._exeHistory(t);var e=this._history,i=this._historyPointer;this.stop(),this._history=e,this._historyPointer=i,this.start()}},i._exeHistory=function(t){var e=this;if(Array.isArray(t)){var i=this._updating;this._updating=!0;var r=this._geometry;Array.isArray(t[0])?t[0].forEach(function(t){var i=t[0],n=t.slice(1);e._shadow[i].apply(e._shadow,n),r[i].apply(r,n)}):(this._shadow[t[0]].apply(this._shadow,t[1]),r[t[0]].apply(r,t[1])),this._updating=i}},e}(fi(gi));ja.mergeOptions(ka);var Va={startEditText:function(){return this.getMap()?(this.hide(),this.endEditText(),this._prepareEditor(),this._fireEvent("edittextstart"),this):this},endEditText:function(){if(this._textEditor){var t=this._textEditor.innerHTML;t=t.replace(/<p>/gi,"").replace(/<\/p>/gi,"<br/>"),this._textEditor.innerHTML=t;var e=this._textEditor.innerText.replace(/[\r\n]+$/gi,"");this.setContent(e),$e(this._textEditor,"mousedown dblclick",Ne),this.getMap().off("mousedown",this.endEditText,this),this._editUIMarker.remove(),delete this._editUIMarker,this._textEditor.onkeyup=null,delete this._textEditor,this.show(),this._fireEvent("edittextend")}return this},isEditingText:function(){return!!this._textEditor},getTextEditor:function(){return this._editUIMarker},_prepareEditor:function(){var t=this.getMap(),e=this._createEditor();this._textEditor=e,t.on("mousedown",this.endEditText,this);var i=this._getEditorOffset();this._editUIMarker=new jo(this.getCoordinates(),{animation:null,content:e,dx:i.dx,dy:i.dy}).addTo(t),this._setCursorToLast(this._textEditor)},_getEditorOffset:function(){var t=this._getInternalSymbol()||{},e=0,i=0,r=t.textHorizontalAlignment;return"middle"===r||l(r)?(e=(t.textDx||0)-2,i=(t.textDy||0)-2):(e=(t.markerDx||0)-2,i=(t.markerDy||0)-2),{dx:e,dy:i}},_createEditor:function(){var t=this.getContent(),e=this.getSize(),i=this._getInternalSymbol()||{},r=e.width,n=i.textFill||"#000000",o=i.textSize||12,a=e.height,s=i.markerLineColor||"#000",h=i.markerFill||"#3398CC",l=i.textLineSpacing||0,c=De("div");return c.contentEditable=!0,c.style.cssText="background:"+h+"; border:1px solid "+s+";\n            color:"+n+";font-size:"+o+"px;width:"+(r-2)+"px;height:"+(a-2)+"px;margin: auto;\n            line-height:"+(o+l)+"px;outline: 0; padding:0; margin:0;word-wrap: break-word;\n            overflow: hidden;-webkit-user-modify: read-write-plaintext-only;",c.innerText=t,Ke(c,"mousedown dblclick",Ne),c.onkeyup=function(t){var e=c.style.height||0;13===t.keyCode&&(c.style.height=parseInt(e)+o/2+"px")},c},_setCursorToLast:function(t){var e;window.getSelection?(t.focus(),(e=window.getSelection()).selectAllChildren(t),e.collapseToEnd()):document.selection&&((e=document.selection.createRange()).moveToElementText(t),e.collapse(!1),e.select())}};Wn.include(Va),sn.include({animate:function(t,e,i){var r=this;this._animPlayer&&this._animPlayer.finish(),f(e)&&(i=e),e||(e={});var n,o=this.getMap(),a=this._getProjection(),s=this.getSymbol()||{},h=this._prepareAnimationStyles(t),l=e.focus;if(delete this._animationStarted,o){var c=o._getRenderer();e.framer=function(t){c.callInNextFrame(t)}}var u=vn.animate(h,e,function(t){if(o&&o.isRemoved())u.finish();else{o&&!r._animationStarted&&l&&o.onMoveStart();var e=t.styles;for(var h in e)if("symbol"!==h&&"translate"!==h&&e.hasOwnProperty(h)){var c="set"+h[0].toUpperCase()+h.slice(1);r[c](e[h])}var p=e.translate;if(p){var d=p;n&&(d=p.sub(n)),n=p,r.translate(d)}var f=e.symbol;if(f&&r.setSymbol(Lt(s,f)),o&&l){var m=a.project(r.getCenter());o._setPrjCenter(m);var g=o._parseEventFromCoord(a.unproject(m));"running"!==u.playState?o.onMoveEnd(g):o.onMoving(g)}r._fireAnimateEvent(u.playState),i&&i(t)}});return this._animPlayer=u,this._animPlayer.play()},_prepareAnimationStyles:function(t){var e=this._getInternalSymbol(),i={};for(var r in t)if(t.hasOwnProperty(r)){var n=t[r];if("translate"!==r&&"symbol"!==r){var o=this["get"+r[0].toUpperCase()+r.substring(1)]();i[r]=[o,n]}else if("symbol"===r){var a=void 0;if(Array.isArray(t.symbol)){if(!Array.isArray(e))throw new Error("geometry'symbol isn't a composite symbol, while the symbol in styles is.");a=[];for(var s=t.symbol,h=0;h<s.length;h++)if(s[h]){var l={};for(var c in s[h])s[h].hasOwnProperty(c)&&(l[c]=[e[h][c],s[h][c]]);a.push(l)}else a.push(null)}else{if(Array.isArray(e))throw new Error("geometry'symbol is a composite symbol, while the symbol in styles isn't.");for(var u in a={},n)n.hasOwnProperty(u)&&(a[u]=[e[u],n[u]])}i.symbol=a}else"translate"===r&&(i.translate=new bi(n))}return i},_fireAnimateEvent:function(t){"finished"===t?(delete this._animationStarted,this._fireEvent("animateend")):"running"===t&&(this._animationStarted?this._fireEvent("animating"):(this._fireEvent("animatestart"),this._animationStarted=!0))}});var Fa=re.touch?"touchstart mousedown":"mousedown",Ua=function(t){function e(e){return t.call(this,e)||this}ne(e,t);var i=e.prototype;return i.addHooks=function(){this.target.on(Fa,this._startDrag,this)},i.removeHooks=function(){this._endDrag(),this.target.off(Fa,this._startDrag,this),delete this.container},i._prepareDragHandler=function(){this._dragHandler=new wi(this.container),this._dragHandler.on("dragging",this._dragging,this).on("mouseup",this._endDrag,this).enable()},i._prepareShadow=function(){var t=this.target;this._prepareDragStageLayer(),this._shadow&&this._shadow.remove();var e=this._shadow=t.copy();if(this._shadow.setSymbol(t._getInternalSymbol()),t.options.dragShadow){var i=Dt(e._getInternalSymbol(),.5);e.setSymbol(i)}e.setId(null),this._prepareShadowConnectors()},i._prepareShadowConnectors=function(){var t=this.target,e=this._shadow,i=this._dragStageLayer._getRenderer().resources,r=[];if(Jn._hasConnectors(t))for(var n=Jn._getConnectors(t),o=0,a=n.length;o<a;o++){var s=n[o],h=s.config(),l=s._getInternalSymbol();h.symbol=Dt(l,.5);var c=void 0;c=s.getConnectSource()===t?new s.constructor(e,s.getConnectTarget(),h):new s.constructor(s.getConnectSource(),e,h),r.push(c),s.getLayer()&&s.getLayer()._getRenderer()&&i.merge(s.getLayer()._getRenderer().resources)}this._shadowConnectors=r,r.push(e),this._dragStageLayer.bringToFront().addGeometry(r)},i._onTargetUpdated=function(){this._shadow&&this._shadow.setSymbol(this.target._getSymbol())},i._prepareDragStageLayer=function(){var t=this.target.getMap(),e=this.target.getLayer();this._dragStageLayer=t.getLayer("_maptalks__internal_layer__drag_stage"),this._dragStageLayer||(this._dragStageLayer=new eo("_maptalks__internal_layer__drag_stage",{enableAltitude:e.options.enableAltitude,altitudeProperty:e.options.altitudeProperty}),t.addLayer(this._dragStageLayer));var i=new hr;i.merge(e._getRenderer().resources),this._dragStageLayer._getRenderer().resources=i},i._startDrag=function(t){var e=this.target.getMap();if(e&&(!this.target._getParent()&&!this.isDragging())){var i=t.domEvent;i.touches&&i.touches.length>1||2===i.button||(this.container=e._panels.mapWrapper||e._containerDOM,this.target.on("click",this._endDrag,this),this._lastCoord=this._correctCoord(t.coordinate),this._lastPoint=t.containerPoint,this._prepareDragHandler(),this._dragHandler.onMouseDown(t.domEvent),Ke(this.container,"mouseleave",this._endDrag,this),this._startParam=t,this._moved=!1)}},i._dragging=function(t){var e=this.target,i=e.getMap()._parseEvent(t.domEvent),r=i.domEvent;if(!(r.touches&&r.touches.length>1)){if(!this._moved)return this._moved=!0,e.on("symbolchange",this._onTargetUpdated,this),this._isDragging=!0,this._prepareShadow(),e.options.dragShadow||e.hide(),this._shadow._fireEvent("dragstart",i),this.target._fireEvent("dragstart",this._startParam||i),void delete this._startParam;if(this._shadow){var n=this._shadow.options.dragOnAxis,o=this._correctCoord(i.coordinate),a=i.containerPoint;this._lastPoint=this._lastPoint||a,this._lastCoord=this._lastCoord||o;var s=a.sub(this._lastPoint),h=o.sub(this._lastCoord);"x"===n?s.y=h.y=0:"y"===n&&(s.x=h.x=0),this._lastPoint=a,this._lastCoord=o,this._shadow.translate(h),e.options.dragShadow||e.translate(h),i.coordOffset=h,i.pointOffset=s,this._shadow._fireEvent("dragging",i),e._fireEvent("dragging",i)}}},i._endDrag=function(t){if(this._dragHandler&&(this._dragHandler.disable(),delete this._dragHandler),this.container&&$e(this.container,"mouseleave",this._endDrag,this),this.target){var e=this.target;e.off("click",this._endDrag,this),e.off("symbolchange",this._onTargetUpdated,this),delete this._lastCoord,delete this._lastPoint,this._isDragging=!1;var i=e.getMap();if(this.enabled()&&i){var r=i._parseEvent(t?t.domEvent:null);this._updateTargetAndRemoveShadow(r),this._moved&&e._fireEvent("dragend",r)}}},i.isDragging=function(){return!!this._isDragging},i._updateTargetAndRemoveShadow=function(t){var e=this.target,i=e.getMap();e.options.dragShadow||e.show();var r=this._shadow;r&&(e.options.dragShadow&&e.setCoordinates(r.getCoordinates()),r._fireEvent("dragend",t),r.remove(),delete this._shadow),this._shadowConnectors&&(i.getLayer("_maptalks__internal_layer__drag_stage").removeGeometry(this._shadowConnectors),delete this._shadowConnectors),this._dragStageLayer&&this._dragStageLayer.remove()},i._correctCoord=function(t){var e=this.target.getMap();if(!e.getPitch())return t;var i=this.target._getPainter();if(!i.getMinAltitude())return t;var r=(i.getMinAltitude()+i.getMaxAltitude())/2;return e.locateByPoint(t,0,-r)},e}(mi);sn.mergeOptions({draggable:!1,dragShadow:!0,dragOnAxis:null}),sn.addInitHook("addHandler","draggable",Ua),sn.include({isDragging:function(){return this._getParent()?this._getParent().isDragging():!!this.draggable&&this.draggable.isDragging()}}),sn.include({startEdit:function(t){return this.getMap()&&this.options.editable?(this.endEdit(),this._editor=new ja(this,t),this._editor.start(),this.fire("editstart"),this):this},endEdit:function(){return this._editor&&(this._editor.stop(),delete this._editor,this.fire("editend")),this},redoEdit:function(){return this.isEditing()?(this._editor.redo(),this.fire("redoedit"),this):this},undoEdit:function(){return this.isEditing()?(this._editor.undo(),this.fire("undoedit"),this):this},isEditing:function(){return!!this._editor&&this._editor.isEditing()}}),sn.include({_onEvent:function(t,e){if(this.getMap()){var i=e||this._getEventTypeToFire(t);"contextmenu"===i&&this.listens("contextmenu")&&(Ne(t),ze(t));var r=this._getEventParams(t);this._fireEvent(i,r)}},_getEventTypeToFire:function(t){return t.type},_getEventParams:function(t){var e=this.getMap(),i={domEvent:t},r=t.touches&&t.touches.length>0?t.touches[0]:t.changedTouches&&t.changedTouches.length>0?t.changedTouches[0]:t;if(r){var n=Fe(r,e._containerDOM);i.coordinate=e.containerPointToCoordinate(n),i.containerPoint=n,i.viewPoint=e.containerPointToViewPoint(n),i.pont2d=e._containerPointToPoint(n)}return i}}),sn.include({setInfoWindow:function(t){return this.removeInfoWindow(),t instanceof Uo?(this._infoWindow=t,this._infoWinOptions=h({},this._infoWindow.options),this._infoWindow.addTo(this),this):(this._infoWinOptions=h({},t),this._infoWindow?this._infoWindow.setOptions(t):this.getMap()&&this._bindInfoWindow(this._infoWinOptions),this)},getInfoWindow:function(){return this._infoWindow?this._infoWindow:null},openInfoWindow:function(t){return this.getMap()?(t||(t=this.getCenter()),this._infoWindow?this._infoWindow.show(t):this._infoWinOptions&&this.getMap()&&(this._bindInfoWindow(this._infoWinOptions),this._infoWindow.show(t)),this):this},closeInfoWindow:function(){return this._infoWindow&&this._infoWindow.hide(),this},removeInfoWindow:function(){return this._unbindInfoWindow(),delete this._infoWinOptions,delete this._infoWindow,this},_bindInfoWindow:function(t){return this._infoWindow=new Uo(t),this._infoWindow.addTo(this),this},_unbindInfoWindow:function(){return this._infoWindow&&(this.closeInfoWindow(),this._infoWindow.remove(),delete this._infoWindow),this}});var Ga=function(){function t(t,e){this.max=t,this.onRemove=e,this.reset()}var e=t.prototype;return e.reset=function(){for(var t in this.data)this.onRemove(this.data[t]);return this.data={},this.order=[],this},e.clear=function(){this.reset(),delete this.onRemove},e.add=function(t,e){if(this.has(t))this.order.splice(this.order.indexOf(t),1),this.data[t]=e,this.order.push(t);else if(this.data[t]=e,this.order.push(t),this.order.length>this.max){var i=this.getAndRemove(this.order[0]);i&&this.onRemove(i)}return this},e.has=function(t){return t in this.data},e.keys=function(){return this.order},e.getAndRemove=function(t){if(!this.has(t))return null;var e=this.data[t];return delete this.data[t],this.order.splice(this.order.indexOf(t),1),e},e.get=function(t){return this.has(t)?this.data[t]:null},e.remove=function(t){if(!this.has(t))return this;var e=this.data[t];return delete this.data[t],this.onRemove(e),this.order.splice(this.order.indexOf(t),1),this},e.setMaxSize=function(t){for(this.max=t;this.order.length>this.max;){var e=this.getAndRemove(this.order[0]);e&&this.onRemove(e)}return this},t}(),Wa=new se(0,0),Xa=new se(0,0),Za=new se(0,0),Ya=function(t){function e(e){var i;return(i=t.call(this,e)||this).tilesInView={},i.tilesLoading={},i._parentTiles=[],i._childTiles=[],i.tileCache=new Ga(e.options.maxCacheSize,i.deleteTile.bind(oe(oe(i)))),i}ne(e,t);var i=e.prototype;return i.getCurrentTileZoom=function(){return this._tileZoom},i.draw=function(){var t=this.getMap();if(this.isDrawable()){var e=this.prepareCanvas();if(!e||e.intersects(this.canvasExtent2D)){var i=this.layer.getTiles().tileGrids;if(i&&i.length){var r=0,n=!1,o={},a=[],s=[],h={},l=[],c={},u=[],p={},d={},f=this._markTiles(),m=this._getLoadLimit(),g=i.length;this._tileZoom=i[0].zoom,this._tileOffset=i[0].offset;for(var v=0;v<g;v++)for(var y=i[v],E=y.tiles,x=this._generatePlaceHolder(y.zoom),_=0,w=E.length;_<w;_++){var b=E[_],S=b.id,T=this._getCachedTile(S),M=!1;if(this._isLoadingTile(S))M=n=!0,this.tilesLoading[S].current=!0;else if(T)this.getTileOpacity(T.image)<1&&(M=n=!0),a.push(T);else{M=n=!0,m&&r+f[0]>m||t.isInteracting()&&!t.isMoving()&&!t.isRotating()||(r++,d[S+"@"+b.point.toArray().join()]=b)}if(M&&!o[S]){o[S]=1,x&&!p[S]&&(b.cache=!1,u.push({image:x,info:b}),p[S]=1);var R=this._findParentTile(b);if(R){var A=R.info.id;void 0===h[A]&&(h[A]=s.length,s.push(R))}else if(!s.length){var C=this._findChildTiles(b);C.length&&C.forEach(function(t){c[t.info.id]||(l.push(t),c[t.info.id]=1)})}}}s.length&&(l.length=0,this._childTiles.length=0),this._drawTiles(a,s,l,u),r?this.loadTileQueue(d):n||(t.isAnimating()||!this._parentTiles.length&&!this._childTiles.length||(this._parentTiles=[],this._childTiles=[],this.setToRedraw()),this.completeRender()),this._retireTiles()}else this.completeRender()}else this.completeRender()}},i.isTileCachedOrLoading=function(t){return this.tilesLoading[t]||this.tilesInView[t]||this.tileCache.get(t)},i._drawTiles=function(t,e,i,r){var n=this;e.length&&(e.sort(function(t,e){return Math.abs(e.info.z-n._tileZoom)-Math.abs(t.info.z-n._tileZoom)}),this._parentTiles=e),i.length&&(this._childTiles=i);var o={tiles:t,parentTiles:this._parentTiles,childTiles:this._childTiles};this.onDrawTileStart(o),this._parentTiles.forEach(function(t){return n._drawTileAndCache(t)}),this._childTiles.forEach(function(t){return n._drawTileOffset(t.info,t.image)}),r.forEach(function(t){return n._drawTileOffset(t.info,t.image)});var a=this.layer,s=this.getMap();if(!a.options.cascadeTiles||s.getPitch()<=a.options.minPitchToCascade)t.forEach(function(t){return n._drawTileAndCache(t)});else{this.writeZoomStencil();for(var h=!1,l=0,c=t.length;l<c;l++)t[l].info.z!==this._tileZoom?h?this.resumeZoomStencilTest():(this.startZoomStencilTest(),h=!0):h&&this.pauseZoomStencilTest(),this._drawTileAndCache(t[l]);this.endZoomStencilTest()}this.onDrawTileEnd(o)},i.writeZoomStencil=function(){},i.startZoomStencilTest=function(){},i.endZoomStencilTest=function(){},i.pauseZoomStencilTest=function(){},i.resumeZoomStencilTest=function(){},i.onDrawTileStart=function(){},i.onDrawTileEnd=function(){},i._drawTileOffset=function(t,e){var i=this._tileOffset;if(i[0]||i[1]){var r=this.getMap(),n=r._getResolution(this._tileZoom)/r._getResolution(t.z);i[0]*=n,i[1]*=n,t.point._sub(i),t.extent2d._sub(i),this.drawTile(t,e),t.point._add(i),t.extent2d._add(i),i[0]/=n,i[1]/=n}else this.drawTile(t,e)},i._drawTileAndCache=function(t){t.current=!0,this.tilesInView[t.info.id]=t,this._drawTileOffset(t.info,t.image),this.tileCache.add(t.info.id,t)},i.drawOnInteracting=function(){this.draw()},i.needToRedraw=function(){var e=this.getMap();return e.getPitch()?t.prototype.needToRedraw.call(this):!(!e.isRotating()&&!e.isZooming())||(e.isMoving()?!!this.layer.options.forceRenderOnMoving:t.prototype.needToRedraw.call(this))},i.hitDetect=function(){return!1},i._getLoadLimit=function(){return this.getMap().isInteracting()?this.layer.options.loadingLimitOnInteracting:0},i.isDrawable=function(){return!this.getMap().getPitch()||(console,this.clear(),!1)},i.clear=function(){this._retireTiles(!0),this.tileCache.reset(),this.tilesInView={},this.tilesLoading={},this._parentTiles=[],this._childTiles=[],t.prototype.clear.call(this)},i._isLoadingTile=function(t){return!!this.tilesLoading[t]},i.clipCanvas=function(e){return this.layer.getMask()?t.prototype.clipCanvas.call(this,e):this._clipByPitch(e)},i._clipByPitch=function(t){var e=this.getMap();if(e.getPitch()<=e.options.maxVisualPitch)return!1;if(!this.layer.options.clipByPitch)return!1;var i=e.getContainerExtent(),r=e.getDevicePixelRatio();return t.save(),t.strokeStyle="rgba(0, 0, 0, 0)",t.beginPath(),t.rect(0,Math.ceil(i.ymin)*r,Math.ceil(i.getWidth())*r,Math.ceil(i.getHeight())*r),t.stroke(),t.clip(),!0},i.loadTileQueue=function(t){for(var e in t)if(t.hasOwnProperty(e)){var i=t[e],r=this.loadTile(i);void 0===r.loadTime&&(this.tilesLoading[i.id]={image:r,current:!0,info:i})}},i.loadTile=function(t){var e=this.layer.getTileSize(),i=new Image;return i.width=e.width,i.height=e.height,i.onload=this.onTileLoad.bind(this,i,t),i.onerror=this.onTileError.bind(this,i,t),this.loadTileImage(i,t.url),i},i.loadTileImage=function(t,e){var i=this.layer.options.crossOrigin;return l(i)||(t.crossOrigin=i),S(t,[e])},i.abortTileLoading=function(t){t&&(t.onload=qa,t.onerror=qa,t.src=Y)},i.onTileLoad=function(t,e){if(this.layer){var i=e.id;this.tilesInView&&(t.loadTime=s(),delete this.tilesLoading[i],this._addTileToCache(e,t),this.setToRedraw(),this.layer.fire("tileload",{tile:e,tileImage:t}))}},i.onTileError=function(t,e){if(this.layer){if(t.onerrorTick=t.onerrorTick||0,this.layer.options.tileRetryCount>t.onerrorTick)return t.onerrorTick++,void(t.src=e.url);t instanceof Image&&this.abortTileLoading(t,e),t.loadTime=0,delete this.tilesLoading[e.id],this._addTileToCache(e,t),this.setToRedraw(),this.layer.fire("tileerror",{tile:e})}},i.drawTile=function(t,e){if(e&&this.getMap()){var i=t.point,r=t.z,n=t.id,o=this.getMap(),a=t.size,s=o.getZoom(),h=this.context,l=o._pointToContainerPoint(i,r,0,Wa),c=o.getBearing(),u=c||s!==r,p=this.getTileOpacity(e),d=h.globalAlpha;p<1&&(h.globalAlpha=p,this.setToRedraw()),u||l._round();var f=l.x,m=l.y,g=a[0],v=a[1];if(u){if(g+=.1,v+=.1,h.save(),h.translate(f,m),c&&h.rotate(-c*Math.PI/180),s!==r){var y=o._getResolution(r)/o._getResolution();h.scale(y,y)}f=m=0}if(ni.image(h,e,f,m,g,v),this.layer.options.debug){var E=this.layer.options.debugOutline,x=n.split("-"),_=x.length;h.save(),h.strokeStyle=E,h.fillStyle=E,h.strokeWidth=10,h.font="15px monospace";var w=new se(f,m);ni.rectangle(h,w,{width:g,height:v},1,0),ni.fillText(h,"x:"+x[_-3]+", y:"+x[_-2]+", z:"+x[_-1],w._add(10,20),E),ni.drawCross(h,f+g/2,m+v/2,2,E),h.restore()}u&&h.restore(),h.globalAlpha!==d&&(h.globalAlpha=d),this.setCanvasUpdated()}},i._findChildTiles=function(t){var e=this._getLayerOfTile(t.layer);if(!e.options.background)return[];for(var i=this.getMap(),r=[],n=t.extent2d.getMin(),o=t.extent2d.getMax(),a=e._project(i._pointToPrj(n,t.z,Xa),Xa),s=e._project(i._pointToPrj(o,t.z,Za),Za),h=1;h<2;h++)this._findChildTilesAt(r,a,s,e,t.z+h);return r},i._findChildTilesAt=function(t,e,i,r,n){var o=r.options.zoomOffset,a=r.getId(),s=r.getSpatialReference().getResolution(n+o);if(s)for(var h,l,c=r._getTileConfig().getTileIndex(e,s),u=r._getTileConfig().getTileIndex(i,s),p=Math.min(c.idx,u.idx),d=Math.max(c.idx,u.idx),f=Math.min(c.idy,u.idy),m=Math.max(c.idy,u.idy),g=p;g<d;g++)for(var v=f;v<m;v++)h=r._getTileId({idx:g,idy:v},n+o,a),this.tileCache.has(h)&&(l=this.tileCache.getAndRemove(h),t.push(l),this.tileCache.add(h,l))},i._findParentTile=function(t){var e=this.getMap(),i=this._getLayerOfTile(t.layer);if(!i.options.background)return null;for(var r=i.getSpatialReference(),n=r.getZoomDirection(),o=i.options.zoomOffset,a=i.options.backgroundZoomDiff,s=t.extent2d.getCenter(),h=i._project(e._pointToPrj(s,t.z)),l=1;l<=a;l++){var c=t.z-n*l,u=r.getResolution(c+o);if(u){var p=i._getTileConfig().getTileIndex(h,u),d=i._getTileId(p,c+o,t.layer);if(this.tileCache.has(d)){var f=this.tileCache.getAndRemove(d);return this.tileCache.add(d,f),f}}}return null},i._getLayerOfTile=function(t){return this.layer.getChildLayer?this.layer.getChildLayer(t):this.layer},i._getCachedTile=function(t){var e=this.tilesInView,i=this.tileCache.getAndRemove(t);if(i){e[t]=i;var r=this.tilesLoading;if(r&&r[t]){r[t].current=!1;var n=r[t],o=n.image,a=n.info;this.abortTileLoading(o,a),delete r[t]}}else i=e[t];return i},i._addTileToCache=function(t,e){this.tilesInView[t.id]={image:e,current:!0,info:t}},i.getTileOpacity=function(t){return this.layer.options.fadeAnimation&&t.loadTime?Math.min(1,(s()-t.loadTime)/(1e3/60*10)):1},i.onRemove=function(){this.clear(),delete this.tileCache,delete this._tilePlaceHolder,t.prototype.onRemove.call(this)},i._markTiles=function(){var t=0,e=0;if(this.tilesLoading)for(var i in this.tilesLoading)this.tilesLoading[i].current=!1,t++;if(this.tilesInView)for(var r in this.tilesInView)this.tilesInView[r].current=!1,e++;return[t,e]},i._retireTiles=function(t){for(var e in this.tilesLoading){var i=this.tilesLoading[e];!t&&i.current||(i.image&&this.abortTileLoading(i.image,i.info),this.deleteTile(i),delete this.tilesLoading[e])}for(var r in this.tilesInView){var n=this.tilesInView[r];n.current||(delete this.tilesInView[r],this.tileCache.has(r)||this.deleteTile(n))}},i.deleteTile=function(t){t&&t.image&&(t.image.onload=null,t.image.onerror=null)},i._generatePlaceHolder=function(t){var e=this.getMap(),i=this.layer.options.placeholder;if(!i||e.getPitch())return null;var r=this.layer.getTileSize(),n=e._getResolution(t)/e._getResolution(),o=this._tilePlaceHolder=this._tilePlaceHolder||ni.createCanvas(1,1);return o.width=r.width*n,o.height=r.height*n,f(i)?i(o):function(t){var e=t.getContext("2d"),i=t.width,r=t.height,n=i/16,o=r/16;e.beginPath();for(var a=0;a<16;a++)e.moveTo(0,a*o),e.lineTo(i,a*o),e.moveTo(a*n,0),e.lineTo(a*n,r);e.strokeStyle="rgba(180, 180, 180, 0.1)",e.lineWidth=1,e.stroke(),e.beginPath();for(var s=[[0,0],[i,0],[0,r],[i,r],[0,0],[0,r],[i,0],[i,r],[0,r/2],[i,r/2],[i/2,0],[i/2,r]],h=1;h<s.length;h+=2)e.moveTo(s[h-1][0],s[h-1][1]),e.lineTo(s[h][0],s[h][1]);e.lineWidth=4,e.stroke()}(o),o},e}(sr);function qa(){return!1}ma.registerRenderer("canvas",Ya);var Ja=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.isDrawable=function(){return!0},i.needToRedraw=function(){var e=this.getMap();return!(!this._gl()||e.getPitch()||!e.isZooming()||e.isMoving()||e.isRotating())||t.prototype.needToRedraw.call(this)},i.drawTile=function(e,i){var r=this.getMap();if(e&&r&&i){var n=e._glScale=e._glScale||r.getGLScale(e.z),o=e.size[0]*n,a=e.size[1]*n;if(!1!==e.cache&&this._bindGLBuffer(i,o,a),this._gl()){var s=e.point,h=s.x*n,l=s.y*n,c=this.getTileOpacity(i);this.drawGLImage(i,h,l,o,a,c),c<1?this.setToRedraw():this.setCanvasUpdated()}else t.prototype.drawTile.call(this,e,i)}},i.writeZoomStencil=function(){var t=this.gl;t.stencilFunc(t.ALWAYS,1,255),t.stencilOp(t.KEEP,t.KEEP,t.REPLACE)},i.startZoomStencilTest=function(){var t=this.gl;t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.stencilFunc(t.EQUAL,0,255)},i.endZoomStencilTest=function(){this.pauseZoomStencilTest()},i.pauseZoomStencilTest=function(){var t=this.gl;t.stencilFunc(t.ALWAYS,1,255)},i.resumeZoomStencilTest=function(){var t=this.gl;t.stencilFunc(t.EQUAL,0,255)},i._bindGLBuffer=function(t,e,i){t.glBuffer||(t.glBuffer=this.bufferTileData(0,0,e,i))},i.loadTileImage=function(t,e){var i=this.layer.options.crossOrigin;t.crossOrigin=null!==i?i:"",t.src=e},i.onCanvasCreate=function(){this.canvas.gl&&this.canvas.gl.wrap||this.createCanvas2()},i.createContext=function(){t.prototype.createContext.call(this),this.createGLContext()},i.resizeCanvas=function(e){this.canvas&&(t.prototype.resizeCanvas.call(this,e),this.resizeGLCanvas())},i.clearCanvas=function(){this.canvas&&(t.prototype.clearCanvas.call(this),this.clearGLCanvas())},i.getCanvasImage=function(){if(!this._gl()||!this.canvas2)return t.prototype.getCanvasImage.call(this);var e=t.prototype.getCanvasImage.call(this);return e&&(e.image=this.canvas2),e},i._gl=function(){if(this.canvas.gl&&this.canvas.gl.wrap)return!0;var t=this.getMap();return t&&(t.getPitch()||t.getBearing())||this.layer&&!!this.layer.options.fragmentShader},i.deleteTile=function(e){t.prototype.deleteTile.call(this,e),e&&e.image&&this.disposeImage(e.image)},i.onRemove=function(){t.prototype.onRemove.call(this),this.removeGLCanvas()},e}(Ra(Ya));function Qa(t){var e=this.layer.getTileSize(),i=this.canvas.constructor,r=this.getMap(),n=r.getDevicePixelRatio(),o=ni.createCanvas(e.width*n,e.height*n,i);o.layer=this.layer;var a=this,s=new zi(r.pointToCoordinate(t.point),r.pointToCoordinate(t.point.add(e.toPoint())),r.getProjection());return this.layer.drawTile(o,{url:t.url,point:t.point,center:r.pointToCoordinate(t.point.add(e.width/2,e.height/2)),extent:s,z:t.z,x:t.x,y:t.y},function(e){e?a.onTileError(o,t):a.onTileLoad(o,t)}),o}ma.registerRenderer("gl",Ja);var Ka=function(t){function e(){return t.apply(this,arguments)||this}return ne(e,t),e.prototype.loadTile=function(){return Qa.apply(this,arguments)},e}(Ya),$a=function(t){function e(){return t.apply(this,arguments)||this}return ne(e,t),e.prototype.loadTile=function(){return Qa.apply(this,arguments)},e}(Ja);xa.registerRenderer("canvas",Ka),xa.registerRenderer("gl",$a);var ts=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.checkResources=function(){var t=this._geosToCheck;if(this._resourceChecked||t||(t=this.layer._geoList),!N(t))return[];for(var e=[],i={},r=t.length-1;r>=0;r--){var n=t[r]._getExternalResources();if(n.length)if(this.resources)for(var o=0;o<n.length;o++){var a=n[o][0];this.resources.isResourceLoaded(n[o])||i[a]||(e.push(n[o]),i[a]=1)}else e.push.apply(e,n)}return this._resourceChecked=!0,delete this._geosToCheck,e},i.render=function(){return this.layer._sortGeometries(),t.prototype.render.apply(this,arguments)},i._addGeoToCheckRes=function(t){t&&(Array.isArray(t)||(t=[t]),this._geosToCheck||(this._geosToCheck=[]),C(this._geosToCheck,t))},i.onGeometryAdd=function(t){this._addGeoToCheckRes(t),es(this)},i.onGeometryRemove=function(){es(this)},i.onGeometrySymbolChange=function(t){this._addGeoToCheckRes(t.target),es(this)},i.onGeometryShapeChange=function(){es(this)},i.onGeometryPositionChange=function(){es(this)},i.onGeometryZIndexChange=function(){es(this)},i.onGeometryShow=function(){es(this)},i.onGeometryHide=function(){es(this)},i.onGeometryPropertiesChange=function(){es(this)},e}(sr);function es(t){t.layer.options.drawImmediate&&t.render(),t.setToRedraw()}var is=new ki,rs=function(t){function e(){return t.apply(this,arguments)||this}ne(e,t);var i=e.prototype;return i.checkResources=function(){var e=this,i=t.prototype.checkResources.apply(this,arguments),r=this.layer.getStyle();return r&&(Array.isArray(r)||(r=[r]),r.forEach(function(t){for(var r=Mt(t.symbol,!0),n=0,o=r.length;n<o;n++)e.resources.isResourceLoaded(r[n])||i.push(r[n])})),i},i.needToRedraw=function(){var e=this.getMap();return!(!e.isInteracting()||!this.layer.options.enableAltitude)||!(e.isZooming()&&!e.isRotating()&&!e.getPitch()&&!this._hasPoint&&this.layer.constructor===eo)&&t.prototype.needToRedraw.call(this)},i.draw=function(){if(this.getMap()){if(!this.layer.isVisible()||this.layer.isEmpty())return this.clearCanvas(),void this.completeRender();this.prepareCanvas(),this.drawGeos(),this.completeRender()}},i.isBlank=function(){return!!this.context&&!this.context.canvas._drawn},i.drawOnInteracting=function(){if(this._geosToDraw){this._updateDisplayExtent();var t=this.getMap(),e=this.layer.getCount();if(t.isZooming()&&t.options.seamlessZoom&&this._geosToDraw.length<e){var i=this.getMap().getResolution();void 0!==this._drawnRes&&i>1.5*this._drawnRes&&(this.prepareToDraw(),this.forEachGeo(this.checkGeo,this),this._drawnRes=i)}for(var r=0,n=this._geosToDraw.length;r<n;r++){var o=this._geosToDraw[r];o.isVisible()&&o._paint(this._displayExtent)}}},i.show=function(){this.layer.forEach(function(t){t._repaint()}),t.prototype.show.apply(this,arguments)},i.forEachGeo=function(t,e){this.layer.forEach(t,e)},i.drawGeos=function(){this._drawnRes=this.getMap().getResolution(),this._updateDisplayExtent(),this.prepareToDraw(),this.forEachGeo(this.checkGeo,this);for(var t=0,e=this._geosToDraw.length;t<e;t++)this._geosToDraw[t]._paint()},i.prepareToDraw=function(){this._hasPoint=!1,this._geosToDraw=[]},i.checkGeo=function(t){if(t&&t.isVisible()&&t.getMap()&&t.getLayer()&&t.getLayer().isCanvasRender()){var e=t._getPainter(),i=e.get2DExtent(this.resources,is);i&&i.intersects(this._displayExtent)&&(e.hasPoint()&&(this._hasPoint=!0),this._geosToDraw.push(t))}},i.onZoomEnd=function(){delete this.canvasExtent2D,t.prototype.onZoomEnd.apply(this,arguments)},i.onRemove=function(){this.forEachGeo(function(t){t.onHide()}),delete this._geosToDraw},i.onGeometryPropertiesChange=function(e){e&&this.layer._styleGeometry(e.target),t.prototype.onGeometryPropertiesChange.call(this,e)},i._updateDisplayExtent=function(){var t=this.canvasExtent2D;if(this._maskExtent){if(!this._maskExtent.intersects(t))return void this.completeRender();t=t.intersection(this._maskExtent)}this._displayExtent=t},i.identify=function(t,e){void 0===e&&(e={});var i=this._geosToDraw;return i?this.layer._hitGeos(i,t,e):[]},e}(ts);eo.registerRenderer("canvas",rs);var ns=function(t){function e(e){var i;return(i=t.call(this)||this).map=e,i._handlerQueue={},i}ne(e,t);var i=e.prototype;return i.callInNextFrame=function(t){this._handlerQueue.push(t)},i.executeFrameCallbacks=function(){var t=this._handlerQueue;this._handlerQueue=[];for(var e=0,i=t.length;e<i;e++)t[e]()},i.offsetPlatform=function(t,e){if(!this.map._panels.front)return this;if(!e&&0===t.x&&0===t.y)return this;var i=this.map._panels,r=this._frontCount=i.back.layerDOM.childElementCount,n=this._backCount=i.front.layerDOM.childElementCount,o=this._uiCount=i.front.uiDOM.childElementCount;if(r||n||o){var a=this.map.offsetPlatform();a=t?a.add(t)._round():a.round(),n&&je(i.back,a),(r||o)&&je(i.front,a)}return this},i.domChanged=function(){var t=this.map._panels;if(!t.front)return!1;var e=t.back.layerDOM.childElementCount;if(void 0===this._frontCount||this._frontCount!==e)return!0;var i=t.front.layerDOM.childElementCount;if(void 0===this._backCount||this._backCount!==i)return!0;var r=t.front.uiDOM.childElementCount;return void 0===this._uiCount||this._uiCount!==r},i.resetContainer=function(){if(this.map&&(this.map._resetMapViewPoint(),this.map._panels.front)){var t=new se(0,0);je(this.map._panels.back,t),je(this.map._panels.front,t)}},i.onZoomEnd=function(){this.resetContainer()},i.onLoad=function(){this._frameLoop()},e}(gi),os=function(t){function e(e){var i;return(i=t.call(this,e)||this)._containerIsCanvas=!!e._containerDOM.getContext,i._registerEvents(),i._loopTime=0,i}ne(e,t);var i=e.prototype;return i.load=function(){this.initContainer()},i.renderFrame=function(t){if(!this.map)return!1;var e=this.map;e._fireEvent("framestart"),this.updateMapDOM();var i=this._getAllLayerToRender();return this.drawLayers(i,t),this.drawLayerCanvas(i),e._fireEvent("frameend"),this._recordView(),this._mapview=this._getMapView(),delete this._spatialRefChanged,this._fireLayerLoadEvents(),this.executeFrameCallbacks(),this._canvasUpdated=!1,!0},i.updateMapDOM=function(){var t=this.map;if(!t.isZooming()){var e=t._getViewPointFrameOffset();e?t.offsetPlatform(e):this.domChanged()&&this.offsetPlatform(null,!0)}},i.drawLayers=function(t,e){for(var i=this.map,r=i.isInteracting(),n=[],o=[],a=i.options.fpsOnInteracting||0,s=0===a?0:1e3/a,h=this.map.options.layerCanvasLimitOnInteracting,l=t.length,c=i.getBaseLayer(),u=0,p=0;p<l;p++){var d=t[p];if(d.isVisible()){var f=d.isCanvasRender();f&&n.push(d.getId());var m=d._getRenderer();if(m){var g=this._checkLayerRedraw(d);f&&m.isCanvasUpdated()&&(g||o.push(d.getId()),this.setLayerCanvasUpdated());var v=m.__zoomTransformMatrix;if(delete m.__zoomTransformMatrix,g){if(r&&f){if(h>0&&l-1-p>h&&d!==c){d._getRenderer().clearCanvas();continue}u+=this._drawCanvasLayerOnInteracting(d,u,s,e)}else r&&m.drawOnInteracting?(m.prepareRender&&m.prepareRender(),m.drawOnInteracting(this._eventParam,e)):(m.render(e),f&&v&&m.isLoadingResource()&&(m.__zoomTransformMatrix=v));f&&(o.push(d.getId()),this.setLayerCanvasUpdated())}else f&&r&&(i.isZooming()&&!i.getPitch()?(m.prepareRender(),m.__zoomTransformMatrix=this._zoomMatrix):(i.getPitch()||i.isRotating())&&m.clearCanvas())}}}var y=this._canvasIds||[],E=this._updatedIds||[];if(this._canvasIds=n,this._updatedIds=o,!this.isLayerCanvasUpdated()){y.join("---")===n.join("---")&&E.join("---")===o.join("---")||this.setLayerCanvasUpdated()}},i._checkLayerRedraw=function(t){if(this.isSpatialReferenceChanged())return!0;var e=this.map,i=t._getRenderer();return t.isCanvasRender()?i.testIfNeedRedraw():!(!i.needToRedraw||!i.needToRedraw())||(e.isInteracting()||this.isViewChanged())},i._drawCanvasLayerOnInteracting=function(t,e,i,r){var n=this.map,o=t._getRenderer(),a=o.getDrawTime(),s=0===i||i>0&&e+a<=i;if(o.mustRenderOnInteracting&&o.mustRenderOnInteracting())o.render(r);else{if(o.drawOnInteracting&&(t===n.getBaseLayer()||s||n.isZooming()&&t.options.forceRenderOnZooming||n.isMoving()&&t.options.forceRenderOnMoving||n.isRotating()&&t.options.forceRenderOnRotating))return o.prepareRender(),o.prepareCanvas(),o.drawOnInteracting(this._eventParam,r),a;!n.isZooming()||n.getPitch()||n.isRotating()?(n.getPitch()||n.isRotating())&&o.clearCanvas():(o.prepareRender(),o.__zoomTransformMatrix=this._zoomMatrix)}return o.drawOnInteracting&&!s&&o.onSkipDrawOnInteracting(this._eventParam,r),0},i._fireLayerLoadEvents=function(){if(this._updatedIds&&this._updatedIds.length>0){var t=this.map;this._updatedIds.reverse().forEach(function(e){var i=t.getLayer(e);if(i){var r=i._getRenderer();r&&r.isRenderComplete()&&i.fire("layerload")}})}},i.isLayerCanvasUpdated=function(){return this._canvasUpdated},i.setLayerCanvasUpdated=function(){this._canvasUpdated=!0},i.drawLayerCanvas=function(t){var e=this.map;if(e&&(this.isLayerCanvasUpdated()||this.isViewChanged())){this.canvas||this.createCanvas(),e._fireEvent("renderstart",{context:this.context}),this._updateCanvasSize()||this.clearCanvas();for(var i,r=e.isInteracting(),n=e.options.layerCanvasLimitOnInteracting,o=t.length,a=[],s=0;s<o;s++){if(t[s].isVisible()&&t[s].isCanvasRender())if(t[s]._getRenderer()){var h=this._getLayerImage(t[s]);h&&h.image&&(t[s]===e.getBaseLayer()?i=[t[s],h]:a.push([t[s],h]))}}i&&(this._drawLayerCanvasImage(i[0],i[1]),this._drawFog()),o=a.length;for(var l=r&&n>=0&&o>n?o-n:0;l<o;l++)this._drawLayerCanvasImage(a[l][0],a[l][1]);this._drawCenterCross(),e._fireEvent("renderend",{context:this.context})}},i.setToRedraw=function(){for(var t=this._getAllLayerToRender(),e=0,i=t.length;e<i;e++){var r=t[e].getRenderer();r&&r.canvas&&r.setToRedraw&&r.setToRedraw()}},i.updateMapSize=function(t){if(t&&!this._containerIsCanvas){var e=t.width+"px",i=t.height+"px",r=this.map._panels;r.mapWrapper.style.width=e,r.mapWrapper.style.height=i,this._updateCanvasSize()}},i.getMainPanel=function(){return this.map?this._containerIsCanvas?this.map._containerDOM:this.map._panels?this.map._panels.mapWrapper:null:null},i.toDataURL=function(t){return this.canvas?this.canvas.toDataURL(t):null},i.remove=function(){re.webgl&&"undefined"!=typeof document&&Ie(document,"visibilitychange",this._onVisibilitychange),this._resizeInterval&&clearInterval(this._resizeInterval),delete this.context,delete this.canvas,delete this.map,delete this._spatialRefChanged,this._cancelFrameLoop()},i.hitDetect=function(t){var e=this.map;if(e&&e.options.hitDetect&&!e.isInteracting()){for(var i=e._getLayers(),r="default",n=e.options.hitDetectLimit||0,o=0,a=i.length-1;a>=0;a--){var s=i[a];if(!s.isEmpty||!s.isEmpty()){var h=s._getRenderer();if(h&&h.hitDetect&&(!h.isBlank||!h.isBlank())){if("default"!==s.options.cursor&&h.hitDetect(t)){r=s.options.cursor||"pointer";break}if(n>0&&++o>n)break}}}e._trySetCursor(r)}},i._getLayerImage=function(t){var e=t._getRenderer();return e.getCanvasImage?e.getCanvasImage():null},i.initContainer=function(){var t=this.map._panels;function e(e,i,r,n){var o=De("div",i);return r&&(o.style.cssText=r),t[e]=o,n||ke(o),o}var i=this.map._containerDOM;if(!this._containerIsCanvas){i.innerHTML="";var r="position:absolute;top:0px;left:0px;",n=e("mapWrapper","maptalks-wrapper","position:absolute;overflow:hidden;",!0),o=e("allLayers","maptalks-all-layers",r+"padding:0px;margin:0px;z-index:0;overflow:visible;",!0),a=e("backStatic","maptalks-back-static",r+"z-index:0;",!0),s=e("back","maptalks-back",r+"z-index:1;"),h=e("backLayer","maptalks-back-layer",r),l=e("canvasContainer","maptalks-canvas-layer",r+"border:none;z-index:2;"),c=e("frontStatic","maptalks-front-static",r+"z-index:3;",!0),u=e("front","maptalks-front",r+"z-index:4;",!0),p=e("frontLayer","maptalks-front-layer",r+"z-index:0;"),d=e("ui","maptalks-ui",r+"border:none;z-index:1;",!0),f=e("control","maptalks-control","z-index:1",!0);i.appendChild(n),o.appendChild(a),s.appendChild(h),s.layerDOM=h,o.appendChild(s),o.appendChild(l),u.appendChild(p),u.layerDOM=p,u.uiDOM=d,o.appendChild(c),o.appendChild(u),u.appendChild(d),n.appendChild(o),n.appendChild(f),this.createCanvas(),this.resetContainer();var m=this.map._getContainerDomSize();this.updateMapSize(m)}},i.isViewChanged=function(){var t=this._mapview,e=this._getMapView();return!t||!q(t,e)},i._recordView=function(){var t=this.map;!t._onViewChange||t.isInteracting()||t.isAnimating()||q(t.getView(),t._getCurrentView())||t._onViewChange(t.getView())},i.isSpatialReferenceChanged=function(){return this._spatialRefChanged},i._getMapView=function(){var t=this.map,e=t._getPrjCenter();return{x:e.x,y:e.y,zoom:t.getZoom(),pitch:t.getPitch(),bearing:t.getBearing(),width:t.width,height:t.height}},i._frameLoop=function(t){var e=this;this.map?(this.renderFrame(t),this._animationFrame=x(function(t){e._frameLoop(t)})):this._cancelFrameLoop()},i._cancelFrameLoop=function(){this._animationFrame&&_(this._animationFrame)},i._drawLayerCanvasImage=function(t,e){var i=this.context,r=e.point.round(),n=this.map.getDevicePixelRatio();1!==n&&r._multi(n);var o=e.image,a=o.width,s=o.height;if(!(r.x+a<=0||r.y+s<=0)){var h=t.options.opacity;if(c(h)||(h=1),!(h<=0)){var l=e.opacity;if(c(l)||(l=1),!(l<=0)){var u=i.globalAlpha;h<1&&(i.globalAlpha*=h),l<1&&(i.globalAlpha*=l),t.options.cssFilter&&(i.filter=t.options.cssFilter);var p=t.getRenderer(),d=p.__zoomTransformMatrix,f=p.clipCanvas(this.context);d&&(i.save(),i.setTransform.apply(i,d)),i.drawImage(o,0,0,a,s,r.x,r.y,a,s),d&&i.restore(),f&&i.restore(),"none"!==i.filter&&(i.filter="none"),i.globalAlpha=u}}}},i._drawCenterCross=function(){var t=this.map.options.centerCross;if(t){var e=this.context,i=new se(this.canvas.width/2,this.canvas.height/2);f(t)?t(e,i):ni.drawCross(this.context,i.x,i.y,2,"#f00")}},i._drawFog=function(){var t=this.map;if(!(t.getPitch()<=t.options.maxVisualPitch)&&t.options.fog){var e=t.getDevicePixelRatio(),i=this.context,r=t.getContainerExtent(),n=(t.height-t._getVisualHeight(75))*e;n<0&&(n=0);var o=r.ymin*e,a=Math.ceil(o-n),s=t.options.fogColor.join(),h=i.createLinearGradient(0,n,0,o+30),l=1-30/(a+30);h.addColorStop(0,"rgba("+s+", 0)"),h.addColorStop(.3,"rgba("+s+", 0.3)"),h.addColorStop(l,"rgba("+s+", 1)"),h.addColorStop(1,"rgba("+s+", 0)"),i.beginPath(),i.fillStyle=h,i.fillRect(0,n,Math.ceil(r.getWidth())*e,Math.ceil(a+30))}},i._getAllLayerToRender=function(){return this.map._getLayers()},i.clearCanvas=function(){this.canvas&&ni.clearRect(this.context,0,0,this.canvas.width,this.canvas.height)},i._updateCanvasSize=function(){if(!this.canvas||this._containerIsCanvas)return!1;var t=this.map,e=t.getSize(),i=this.canvas,r=t.getDevicePixelRatio();return(e.width*r!==i.width||e.height*r!==i.height)&&(i.height=r*e.height,i.width=r*e.width,i.style&&(i.style.width=e.width+"px",i.style.height=e.height+"px"),!0)},i.createCanvas=function(){this._containerIsCanvas?this.canvas=this.map._containerDOM:(this.canvas=De("canvas"),this._updateCanvasSize(),this.map._panels.canvasContainer.appendChild(this.canvas)),this.context=this.canvas.getContext("2d")},i._checkSize=function(){this.map&&!this.map.isInteracting()&&(Ve(this.map._containerDOM),this.map.checkSize())},i._setCheckSizeInterval=function(t){var e=this;clearInterval(this._resizeInterval),this._checkSizeInterval=t,this._resizeInterval=setInterval(function(){!e.map||e.map.isRemoved()?clearInterval(e._resizeInterval):e._checkSize()},this._checkSizeInterval)},i._registerEvents=function(){var t=this,e=this.map;e.options.checkSize&&!w&&"undefined"!=typeof window&&this._setCheckSizeInterval(e.options.checkSizeInterval),re.mobile||e.on("_mousemove",this._onMapMouseMove,this),e.on("_dragrotatestart _dragrotating _dragrotateend _movestart _moving _moveend _zoomstart",function(e){t._eventParam=e}),e.on("_zooming",function(i){e.getPitch()||(t._zoomMatrix=i.matrix.container),t._eventParam=i}),e.on("_zoomend",function(e){t._eventParam=e,delete t._zoomMatrix}),e.on("_spatialreferencechange",function(){t._spatialRefChanged=!0}),re.webgl&&"undefined"!=typeof document&&He(document,"visibilitychange",this._onVisibilitychange,this)},i._onMapMouseMove=function(t){var e=this,i=this.map;!i.isInteracting()&&i.options.hitDetect&&(this._hitDetectFrame&&_(this._hitDetectFrame),this._hitDetectFrame=x(function(){e.hitDetect(t.containerPoint)}))},i._getCanvasLayers=function(){return this.map._getLayers(function(t){return t.isCanvasRender()})},i._onVisibilitychange=function(){"visible"===document.visibilityState&&this.setToRedraw()},e}(ns);xr.registerRenderer("canvas",os),xr.mergeOptions({fog:!0,fogColor:[233,233,233]});var as=Object.freeze({ResourceCache:hr,CanvasRenderer:sr,ImageGLRenderable:Ra,MapRenderer:ns,MapCanvasRenderer:os,Renderable:ar,ImageLayerCanvasRenderer:Da,ImageLayerGLRenderer:La,TileLayerCanvasRenderer:Ya,TileLayerGLRenderer:Ja,CanvasTileLayerCanvasRenderer:Ka,CanvasTileLayerGLRenderer:$a,OverlayLayerCanvasRenderer:ts,VectorLayerCanvasRenderer:rs,CanvasLayerRenderer:Oa}),ss={_getRenderPoints:function(){return[[this._getCenter2DPoint(this.getMap().getGLZoom())],null]}};bn.include(ss),Bn.include(ss),In.include(ss),Nn.include(ss),zn.include({_getRenderPoints:function(t){var e=this.getMap();if("vertex"===t){for(var i=this._trimRing(this.getShell()),r=[],n=0,o=i.length;n<o;n++)r.push(e.coordToPoint(i[n],e.getGLZoom()));return[r,null]}return[[e.coordToPoint(this.getCenter(),e.getGLZoom())],null]}});var hs={_getRenderPoints:function(t){var e,i=this.getMap(),r=i.getGLZoom(),n=null;if("point"===t)(e=this._getPath2DPoints(this._getPrjCoordinates(),!1,r))&&e.length>0&&Array.isArray(e[0])&&(e=e[0].concat(e[1]));else if("vertex"===t)if(n=[],(e=this._getPath2DPoints(this._getPrjCoordinates(),!1,r))&&e.length>0&&Array.isArray(e[0])){for(var o=0,a=e.length;o<a;o++)for(var s=0,h=e[o].length;s<h;s++)0===s?n.push([e[o][s],e[o][s+1]]):n.push([e[o][s-1],e[o][s]]);e=e[0].concat(e[1])}else for(var l=0,c=e.length;l<c;l++)0===l?n.push([e[l],e[l+1]]):n.push([e[l-1],e[l]]);else if("line"===t){e=[],n=[];var u=this._getPath2DPoints(this._getPrjCoordinates(),!1,r);if(u.length>0&&Array.isArray(u[0]))for(var p,d=1,f=u.length;d<f;d++){p=u[d],this instanceof _n&&p.length>0&&!p[0].equals(p[p.length-1])&&p.push(p[0]);for(var m=1,g=p.length;m<g;m++)e.push(p[m].add(p[m-1])._multi(.5)),n.push([p[m-1],p[m]])}else{this instanceof _n&&u.length>0&&!u[0].equals(u[u.length-1])&&u.push(u[0]);for(var v=1,y=u.length;v<y;v++)e.push(u[v].add(u[v-1])._multi(.5)),n.push([u[v-1],u[v]])}}else if("vertex-first"===t){var E=this._getPrjCoordinates();e=E.length?[i._prjToPoint(E[0],r)]:[],n=E.length?[[i._prjToPoint(E[0],r),i._prjToPoint(E[1],r)]]:[]}else if("vertex-last"===t){var x=this._getPrjCoordinates(),_=x.length;e=_?[i._prjToPoint(x[_-1],r)]:[];var w=_-1,b=_>1?_-2:_-1;n=_?[[i._prjToPoint(x[b],r),i._prjToPoint(x[w],r)]]:[]}else{var S=this._getProjection().project(this.getCenter());e=[i._prjToPoint(S,r)]}return[e,n]}};Tn.include(hs),_n.include(hs),sn.include({_redrawWhenPitch:function(){return!1},_redrawWhenRotate:function(){return!1}});var ls={_redrawWhenPitch:function(){return!0},_redrawWhenRotate:function(){return this instanceof Bn||this instanceof Nn},_paintAsPath:function(){var t=this.getMap();return this._getPainter().getAltitude()>0||t.getPitch()||this instanceof Bn&&t.getBearing()},_getPaintParams:function(){var t=this.getMap();if(this._paintAsPath())return _n.prototype._getPaintParams.call(this,!0);var e=this._getPrjCoordinates(),i=t._prjToPoint(e,t.getGLZoom()),r=this._getRenderSize();return[i,r.width,r.height]},_paintOn:function(){return this._paintAsPath()?ni.polygon.apply(ni,arguments):ni.ellipse.apply(ni,arguments)},_getRenderSize:function(){var t=this.getMap(),e=t.getGLZoom(),i=this._getPrjExtent(),r=t._prjToPoint(i.getMin(),e),n=t._prjToPoint(i.getMax(),e);return new he(Math.abs(n.x-r.x)/2,Math.abs(n.y-r.y)/2)}};Bn.include(ls),In.include(ls),zn.include({_getPaintParams:function(){var t=this.getMap().getGLZoom(),e=this._getPrjShell();return[this._getPath2DPoints(e,!1,t)]},_paintOn:ni.polygon}),Nn.include(ls,{_redrawWhenPitch:function(){return!0},_getPaintParams:function(){if(this._paintAsPath())return _n.prototype._getPaintParams.call(this,!0);var t=this.getMap();return[t._prjToPoint(this._getPrjCoordinates(),t.getGLZoom()),this._getRenderSize().width,[this.getStartAngle(),this.getEndAngle()]]},_paintOn:function(){if(this._paintAsPath())return ni.polygon.apply(ni,arguments);var t=this.getMap().getBearing(),e=arguments;return t&&(e[3]=e[3].slice(0),e[3][0]+=t,e[3][1]+=t),ni.sector.apply(ni,e)}}),xn.include({_paintAsPath:function(){return!0}}),Tn.include({arrowStyles:{classic:[3,4]},_getArrowShape:function(t,e,i,r,n){n||(n=0);var o,a=i*r[0],s=i*r[1]+n,h=a/2+n;(o=e.nextCtrlPoint||e.prevCtrlPoint?e.prevCtrlPoint?e.sub(new se(e.prevCtrlPoint)):e.sub(new se(e.nextCtrlPoint)):e.sub(t))._unit();var l=e.sub(o.multi(s));o._perp();var c=l.add(o.multi(h));return o._multi(-1),[c,e,l.add(o.multi(h)),c]},_getPaintParams:function(){var t=this._getPrjCoordinates();return[this._getPath2DPoints(t,!1,this.getMap().getGLZoom())]},_paintOn:function(t,e,i,r,n){this.options.smoothness?ni.paintSmoothLine(t,e,i,this.options.smoothness,!1,this._animIdx,this._animTailRatio):ni.path(t,e,i,null,n),this._paintArrow(t,e,i)},_getArrowPlacement:function(){return this.options.arrowPlacement},_getArrowStyle:function(){var t=this.options.arrowStyle;return t?Array.isArray(t)?t:this.arrowStyles[t]:null},_getArrows:function(t,e,i){var r=this._getArrowStyle();if(!r||t.length<2)return[];for(var n=t.length>0&&Array.isArray(t[0])?t:[t],o=this._getArrowPlacement(),a=[],s=this.getMap(),h=s.coordToContainerPoint(this.getFirstCoordinate()),l=s.coordToContainerPoint(this.getLastCoordinate()),c=n.length-1;c>=0;c--)("vertex-first"===o||"vertex-firstlast"===o&&n[c][0].closeTo(h,.01))&&a.push(this._getArrowShape(n[c][1],n[c][0],e,r,i)),"vertex-last"===o||"vertex-firstlast"===o&&n[c][n[c].length-1].closeTo(l,.01)?a.push(this._getArrowShape(n[c][n[c].length-2],n[c][n[c].length-1],e,r,i)):"point"===o&&this._getArrowPoints(a,n[c],e,r,i);return a},_getArrowPoints:function(t,e,i,r,n){for(var o=0,a=e.length-1;o<a;o++)t.push(this._getArrowShape(e[o],e[o+1],i,r,n))},_paintArrow:function(t,e,i){var r=this._getInternalSymbol().lineWidth;(!c(r)||r<3)&&(r=3);var n=this._getArrows(e,r);if(n.length){t.setLineDash&&t.setLineDash([]);for(var o=n.length-1;o>=0;o--)t.fillStyle=t.strokeStyle,ni.polygon(t,n[o],i,i)}}}),_n.include({_getPaintParams:function(t){var e=this.getMap().getGLZoom(),i=this._getPrjShell(),r=this._getPath2DPoints(i,t,e),n=r.length>0&&Array.isArray(r[0]);n&&(r=[[r[0]],[r[1]]]);var o=this._getPrjHoles(),a=[];if(o&&o.length>0){for(var s=this._simplified,h=0;h<o.length;h++){var l=this._getPath2DPoints(o[h],t,e);Array.isArray(l)&&n?Array.isArray(l[0])?(r[0].push(l[0]),r[1].push(l[1])):r[0].push(l):a.push(l)}s&&(this._simplified=s)}return n||C(r=[r],a),[r]},_paintOn:function(t,e,i,r,n){ni.polygon(t,e,i,r,n,this.options.smoothness)}}),xr.VERSION="0.45.1",t.Util=Ot,t.DomUtil=ti,t.StringUtil=Te,t.MapboxUtil=bt,t.Map=xr,t.ui=Zo,t.control=ra,t.renderer=as,t.symbolizer=Zr,t.animation=yn,t.Browser=re,t.Ajax=ei,t.Canvas=ni,t.Promise=di,t.Class=gi,t.Eventable=fi,t.JSONAble=yi,t.Handlerable=Ei,t.Handler=mi,t.DragHandler=wi,t.MapTool=ro,t.DrawTool=oo,t.AreaTool=Bo,t.DistanceTool=Io,t.SpatialReference=yr,t.INTERNAL_LAYER_PREFIX="_maptalks__internal_layer_",t.GEOMETRY_COLLECTION_TYPES=e,t.GEOJSON_TYPES=i,t.RESOURCE_PROPERTIES=r,t.RESOURCE_SIZE_PROPERTIES=n,t.NUMERICAL_PROPERTIES=o,t.COLOR_PROPERTIES=a,t.projection=or,t.measurer=Ki,t.Coordinate=bi,t.CRS=Si,t.Extent=zi,t.Point=se,t.PointExtent=ki,t.Size=he,t.Transformation=ji,t.Layer=lr,t.TileLayer=ma,t.GroupTileLayer=ga,t.WMSTileLayer=Ea,t.CanvasTileLayer=xa,t.ImageLayer=Ca,t.OverlayLayer=$n,t.VectorLayer=eo,t.CanvasLayer=Ia,t.ParticleLayer=za,t.TileSystem=na,t.TileConfig=aa,t.ArcCurve=jn,t.Circle=In,t.ConnectorLine=Jn,t.ArcConnectorLine=Qn,t.CubicBezierCurve=Vn,t.Curve=kn,t.Ellipse=Bn,t.GeoJSON=Hn,t.Geometry=sn,t.GeometryCollection=Mn,t.Label=Zn,t.LineString=Tn,t.Marker=bn,t.MultiLineString=Dn,t.MultiPoint=Cn,t.MultiPolygon=Ln,t.Polygon=_n,t.QuadBezierCurve=Fn,t.Rectangle=zn,t.Sector=Nn,t.TextBox=Xn,t.TextMarker=Wn,Object.defineProperty(t,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log}));var SoonGis=function(){this.Tile=function(){this.vectorIndex=new THREE.Vector3},this.Tile.prototype.outerTest=function(){},this.earthLayer=new THREE.Object3D,this.baseTileSize=1024,this.tileSize=20*this.baseTileSize,this.levelMax=17,this.earthPlaneSize=(1<<this.levelMax)*this.tileSize,this.basePosition=new THREE.Vector3(.5*this.earthPlaneSize,.5*this.earthPlaneSize,0),this.totalRange=100,this.levelTileVecs=[],this.levelTilePositionsTarr=[],this.tileArry=[],this.currentTileVecArry=[],this.centerPosition=null,this.centerLongLat={longitude:116.2803447089,latitude:40.0440678176},this.tileResolutions=[],this.levelSize=[],this.levelTileSize=[],this.tileMap=new Map,this.tileVec=new THREE.Vector3(1,0,1),this.initialResolution=2*Math.PI*6378137/this.earthPlaneSize,this.currentLevel=16;for(let t=0;t<=this.levelMax;++t)this.levelSize[t]=Math.pow(2,t),this.levelTileSize[t]=this.levelSize[t]*this.tileSize,this.tileResolutions[t]=this.initialResolution*this.levelTileSize[t];this.levelTileSize.reverse(),this.tileResolutions.reverse(),this.centerTileVec=this.getTileIndexByLongLat({longitude:this.centerLongLat.longitude,latitude:this.centerLongLat.latitude,level:this.currentLevel})};SoonGis.prototype.constructor=SoonGis,SoonGis.prototype.getParentTileVec=function(t){let e=new THREE.Vector3;return e.x=1==(1&t.x)?(t.x-1)/2:t.x/2,e.y=1==(1&t.y)?(t.y-1)/2:t.y/2,e.z=t.z-1,e},SoonGis.prototype.longToPixel=function(t){return this.earthPlaneSize/2*(t/180+1)},SoonGis.prototype.shaderChunk={VS_terrain:["varying vec2 vUv;","uniform sampler2D   tDemMap;","uniform float heightScale;","void main()\t{","vUv = uv;","float demPix = texture2D(tDemMap, vUv).r + texture2D(tDemMap, vUv).g + texture2D(tDemMap, vUv).b;","gl_Position = projectionMatrix * modelViewMatrix * vec4(position.x, position.y + demPix * heightScale, position.z, 1.0);","}"].join("\n"),FS_terrain:["uniform sampler2D   tColorMap;","uniform sampler2D   tDemMap;","varying vec2  vUv;","void main()\t{","\tvec4 color = texture2D( tColorMap, vUv );","float demPix = texture2D( tDemMap, vUv ).r + texture2D( tDemMap, vUv ).g + texture2D( tDemMap, vUv ).b;","if((demPix>1.0)&&(demPix<1.001))","color = vec4(1.0);","if((demPix>1.5)&&(demPix<1.501))","color = vec4(1.0);","if((demPix>2.0)&&(demPix<2.001))","color = vec4(1.0);","if((demPix>2.5)&&(demPix<2.501))","color = vec4(1.0);","if((demPix>2.9)&&(demPix<2.901))","color = vec4(1.0);","gl_FragColor = vec4( color.xyz, 1.0 );","}"].join("\n")},SoonGis.prototype.createTerrain=function(t,e){let i=new THREE.TextureLoader,r=i.load(t),n=i.load(e),o=new THREE.ShaderMaterial({uniforms:{tDemMap:{value:r},tColorMap:{value:n},heightScale:{value:1800}},vertexShader:this.shaderChunk.VS_terrain,fragmentShader:this.shaderChunk.FS_terrain}),a=new THREE.PlaneBufferGeometry(9500,7500,600,600);return a.rotateX(-Math.PI/2),new THREE.Mesh(a,o)},SoonGis.prototype.createGeoBuilding=function(t={geojsonSrc:"have no geojson source file"}){var e,i=SoonSpace.editor.scene.getChildByName("buildingGeo");return new Promise(function(e,i){var r=maptalks.Ajax.getJSON(t.geojsonSrc,()=>{});let n=setInterval(()=>{4===r.readyState&&(e(maptalks.GeoJSON.toGeometry(r.response,()=>{})),window.clearInterval(n))},200)}).then(t=>{(i=SoonSpace.editor.scene.getChildByName("buildingGeo"))||((i=new THREE.Object3D).name="buildingGeo",SoonSpace.editor.scene.add(i)),i.position.set(48051.08355932665,60,-12104.377041877276);for(let s=0;s<t.length;++s){var r=t[s].properties.Floor||1,n=(e=r)<2?2524455:e>=2&&e<=5?1202051:2495231,o=new THREE.MeshPhongMaterial({color:n,opacity:.9});o.transparent=!0;var a=soonGis.extrudeToMesh(t[s],o,1e3*r);if(Array.isArray(a))for(let t=0;t<a.length;++t)i.add(a[t]);i.add(a)}}),i},SoonGis.prototype.CoordinateSys={x_PI:52.35987755982988,PI:3.141592653589793,a:6378245,ee:.006693421622965943,bd09togcj02:function(t,e){var i=52.35987755982988,r=t-.0065,n=e-.006,o=Math.sqrt(r*r+n*n)-2e-5*Math.sin(n*i),a=Math.atan2(n,r)-3e-6*Math.cos(r*i);return[o*Math.cos(a),o*Math.sin(a)]},gcj02tobd09:function(t,e){var i=Math.sqrt(t*t+e*e)+2e-5*Math.sin(e*this.x_PI),r=Math.atan2(e,t)+3e-6*Math.cos(t*this.x_PI);return[i*Math.cos(r)+.0065,i*Math.sin(r)+.006]},wgs84togcj02:function(t,e){if(this.out_of_china(t,e))return[t,e];var i=this.transformlat(t-105,e-35),r=this.transformlng(t-105,e-35),n=e/180*this.PI,o=Math.sin(n);o=1-this.ee*o*o;var a=Math.sqrt(o);return i=180*i/(this.a*(1-this.ee)/(o*a)*this.PI),[t+(r=180*r/(this.a/a*Math.cos(n)*this.PI)),e+i]},gcj02towgs84:function(t,e){if(this.out_of_china(t,e))return[t,e];var i=this.transformlat(t-105,e-35),r=this.transformlng(t-105,e-35),n=e/180*this.PI,o=Math.sin(n);o=1-this.ee*o*o;var a=Math.sqrt(o);return i=180*i/(this.a*(1-this.ee)/(o*a)*this.PI),r=180*r/(this.a/a*Math.cos(n)*this.PI),mglat=e+i,mglng=t+r,[2*t-mglng,2*e-mglat]},transformlat:function(t,e){var i=this.PI,r=2*t-100+3*e+.2*e*e+.1*t*e+.2*Math.sqrt(Math.abs(t));return r+=2*(20*Math.sin(6*t*i)+20*Math.sin(2*t*i))/3,r+=2*(20*Math.sin(e*i)+40*Math.sin(e/3*i))/3,r+=2*(160*Math.sin(e/12*i)+320*Math.sin(e*i/30))/3},transformlng:function(t,e){var i=this.PI,r=300+t+2*e+.1*t*t+.1*t*e+.1*Math.sqrt(Math.abs(t));return r+=2*(20*Math.sin(6*t*i)+20*Math.sin(2*t*i))/3,r+=2*(20*Math.sin(t*i)+40*Math.sin(t/3*i))/3,r+=2*(150*Math.sin(t/12*i)+300*Math.sin(t/30*i))/3},out_of_china:function(t,e){return t<72.004||t>137.8347||e<.8293||e>55.8271||!1}},SoonGis.prototype.toShape=function(t){var e=this;if(!t)return null;if(t instanceof maptalks.MultiPolygon)return t.getGeometries().map(function(t){return e.toShape(t)});var i=t.getCenter(),r=e.getTilePixByLongLat({longitude:i.x,latitude:i.y}),n=t.getShell().map(function(t){return e.getTilePixByLongLat({longitude:t.x,latitude:t.y}).sub(r)});window.outer=n;var o=new THREE.Shape(n),a=t.getHoles();return a&&a.length>0&&(o.holes=a.map(function(t){var i=t.map(function(t){return e.getTilePixByLongLat({longitude:t.x,latitude:t.y}).sub(r)});return new THREE.Shape(i)})),o},SoonGis.prototype.extrudeToMesh=function(t,e,i){var r=this;if(!t)return null;if(t instanceof maptalks.MultiPolygon)return t.getGeometries().map(function(t){return r.extrudeToMesh(t,e,i)});var n=t.getCoordinates();n.forEach(function(t){for(var e=t.length-1;e>=1;e--)t[e].equals(t[e-1])}),t.setCoordinates(n);var o=r.toShape(t),a=t.getCenter(),s=r.getSoonCoorByLongLat({longitude:a.x,latitude:a.y}),h=s.clone();h.y=-2e3;var l=s.clone();l.y=l.y+i;var c=new THREE.CatmullRomCurve3([h,l]);c.curveType="catmullrom",c.closed=!1;var u={depth:i,steps:10,bevelEnabled:!1,bevelSegments:10},p=new THREE.ExtrudeBufferGeometry(o,u),d=new THREE.Mesh(p,e);return d.rotateX(Math.PI/2),d.position.set(s.x,s.y+i,s.z),d},SoonGis.prototype.latToPixel=function(t){let e=Math.PI;return this.earthPlaneSize/2*((e-Math.log(Math.tan(e*t/180)+1/Math.cos(e*t/180)))/e)},SoonGis.prototype.getTilePosition=function(t){return new THREE.Vector3(this.levelTileSize[t.z]*(t.x+.5),30,this.levelTileSize[t.z]*(t.y+.5))},SoonGis.prototype.getSoonCoorByLongLat=function(t){let e=t.longitude,i=t.latitude,r=this.longToPixel(e),n=this.latToPixel(i),o=r-this.centerPosition.x,a=n-this.centerPosition.z;return new THREE.Vector3(o,0,a)},SoonGis.prototype.getSonTileVec=function(t){let e=[],i=new THREE.Vector3,r=new THREE.Vector3,n=new THREE.Vector3,o=new THREE.Vector3;return i.x=2*t.x,i.y=2*t.y,i.z=t.z+1,r.x=i.x+1,r.y=i.y,r.z=i.z,n.x=i.x,n.y=i.y+1,n.z=i.z,o.x=i.x+1,o.y=i.y+1,o.z=i.z,e.push(i),e.push(r),e.push(n),e.push(o),e},SoonGis.prototype.distinctArr=function(t){let e,i,r=[],n=t.length;for(e=0;e<n;e++){for(i=e+1;i<n;i++)t[e].x+""+t[e].y==t[i].x+""+t[i].y&&(i=++e);r.push(t[e])}return r},SoonGis.prototype.zoomMapToParent=function(){if(0===this.currentLevel)return;this.currentLevel--,this.currentTileVecArry=this.distinctArr(this.currentTileVecArry);let t=this.currentTileVecArry.length;for(let e=0;e<t;++e){let t=this.currentTileVecArry.shift();this.createTileMesh(t).visible=!1;let e=this.getParentTileVec(t);this.currentTileVecArry.push(e),this.createTileMesh(e).visible=!0}},SoonGis.prototype.zoomMapToSon=function(){if(17===this.currentLevel)return;this.currentLevel++,this.currentTileVecArry=this.distinctArr(this.currentTileVecArry);let t=this.currentTileVecArry.length;for(let e=0;e<t;++e){let t=this.currentTileVecArry.shift();this.createTileMesh(t).visible=!1;let e=this.getSonTileVec(t);this.currentTileVecArry.push(e[0]),this.currentTileVecArry.push(e[1]),this.currentTileVecArry.push(e[2]),this.currentTileVecArry.push(e[3]);for(let t=0;t<e.length;++t){this.createTileMesh(e[t]).visible=!0}}},SoonGis.prototype.pinMapCenter=function(t){this.centerPosition=this.getSoonCoorByLongLat(t),this.earthLayer.position.copy(this.centerPosition)},SoonGis.prototype.createTileMesh=function(t,e){let i,r,n,o,a,s,h="http://wprd04.is.autonavi.com/appmaptile?x="+t.x+"&y="+t.y+"&z="+t.z+"&lang=zh_cn&size=4&scl=2&style=6 ";if(e?(r=e+"/"+t.x+"-"+t.y+"-"+t.z+".png",i=n=h):i=h,void 0!==this.tileMap.get(i))return this.tileMap.get(i);let l=this.getTilePosition(t);this.centerPosition||(this.centerPosition=l.clone());let c=new THREE.TextureLoader;try{s=c.load(i,void 0,void 0,()=>{u()})}catch(t){}var u=()=>{i=r,s=c.load(i,void 0,void 0,()=>{p()}),a.map=s},p=()=>{s=null,o.material.transparent=!0,o.material.opcity=0};a=new THREE.MeshBasicMaterial({map:s});var d=new THREE.BoxBufferGeometry(this.levelTileSize[t.z],0,this.levelTileSize[t.z]);return(o=new THREE.Mesh(d,a)).position.copy(l),this.earthLayer.position.set(-1*this.centerPosition.x,this.centerPosition.y,-1*this.centerPosition.z),this.earthLayer.add(o),this.tileMap.set(i,o),setTimeout(()=>{var t=new THREE.AxesHelper(39500);SoonSpace.editor.scene.add(t),SoonSpace.editor.addObject(this.earthLayer)},200),this.earthLayer},SoonGis.prototype.renderMap=function(){for(let t=0;t<this.currentTileVecArry.length;++t)mesh=this.createTileMesh(this.currentTileVecArry[t],option.tileLocalDir);SoonSpace.editor.addObject(this.earthLayer)},SoonGis.prototype.getTileIndexByLongLat=function(t){let e=t.longitude,i=t.latitude,r=t.level,n=this.longToPixel(e)/this.levelTileSize[r]|0,o=this.latToPixel(i)/this.levelTileSize[r]|0;return new THREE.Vector3(n,o,r)},SoonGis.prototype.getTilePixByLongLat=function(t){let e=t.longitude,i=t.latitude,r=(Math.PI,this.longToPixel(e)),n=this.latToPixel(i);return new THREE.Vector3(r,n,this.currentLevel)},SoonGis.prototype.init=function(t={centerLongLat:{longitude:120.20571932821963,latitude:30.24946330461267},radius:0,mapLevel:16,tileLocalDir:""}){SoonSpace.editor.camera.far=3e9;var e=new THREE.AxesHelper(5e3);SoonSpace.editor.scene.add(e),this.currentLevel=t.mapLevel,this.centerLongLat=t.centerLongLat,this.centerTileVec=this.getTileIndexByLongLat({longitude:this.centerLongLat.longitude,latitude:this.centerLongLat.latitude,level:this.currentLevel});var i=t.tileLocalDir;for(let t=0;t<5;++t)for(let e=0;e<5;++e)this.currentTileVecArry.push(new THREE.Vector3(this.centerTileVec.x+e,this.centerTileVec.y+t,this.centerTileVec.z)),this.currentTileVecArry.push(new THREE.Vector3(this.centerTileVec.x-e,this.centerTileVec.y+t,this.centerTileVec.z)),this.currentTileVecArry.push(new THREE.Vector3(this.centerTileVec.x+e,this.centerTileVec.y-t,this.centerTileVec.z)),this.currentTileVecArry.push(new THREE.Vector3(this.centerTileVec.x-e,this.centerTileVec.y-t,this.centerTileVec.z));for(let t=0;t<this.currentTileVecArry.length;++t)mesh=this.createTileMesh(this.currentTileVecArry[t],i);SoonSpace.editor.addObject(this.earthLayer)},SoonSpace.prototype.spliteStructure=function(t,e){let i=[],r=0,n=0;tntLocal=Math.abs(e);for(let t=.001;t<tntLocal;t+=100)r+=Math.sin(Math.PI*t/tntLocal),i.push(r);let o=setInterval(()=>{let a=i[n++]*tntLocal/r;a=e<0?-a:a;for(let e=0;e<t.length;++e){let i=t[e];i.position.copy((new THREE.Vector3).copy(i.userData.oldPs).add((new THREE.Vector3).copy(i.worldDir).multiplyScalar(a)))}n>=i.length&&window.clearInterval(o)},50);return{intervalId:o}},SoonSpace.prototype.spliteInit=function(t){let e=t.children,i=[],r=[],n=new THREE.Box3,o=new THREE.Box3;for(let t=0;t<e.length;++t)if("Group"===e[t].type||"Object3D"===e[t].type){n.expandByObject(e[t]);let o=e[t];if(o.children[0]&&"Mesh"===o.children[0].type){r.push(o);for(let t=0;t<o.children.length;++t)i.push(o.children[t]);continue}for(let t=0;t<o.children.length;++t){let e=o.children[t];r.push(e);for(let t=0;t<e.children.length;++t)i.push(e.children[t])}}var a=(new THREE.Vector3).addVectors(n.max,n.min).multiplyScalar(.5);for(let t=0;t<i.length;++t){let e=i[t];o.setFromObject(e);var s=(new THREE.Vector3).addVectors(o.max,o.min).multiplyScalar(.5);isNaN(s.x)||(e.worldDir=(new THREE.Vector3).subVectors(s,a).normalize(),e.userData.oldPs=e.getWorldPosition(new THREE.Vector3))}for(let t=0;t<r.length;++t){let e=r[t];o.setFromObject(e);s=(new THREE.Vector3).addVectors(o.max,o.min).multiplyScalar(.5);isNaN(s.x)||(e.worldDir=(new THREE.Vector3).subVectors(s,a).normalize(),e.userData.oldPs=e.getWorldPosition(new THREE.Vector3))}return{bombFrag:i,bombLayer:r}},function(t,e){"use strict";t(function(){function t(t,e,i,n){return r(t).then(e,i,n)}function i(t,e){this.then=t,this.inspect=e}function r(t){return n(function(e){e(t)})}function n(t){function e(t){l&&(a=o(t),h(l,a),l=M)}function r(t){e(s(t))}var a,l=[];try{t(e,r,function(t){l&&h(l,function t(e){var r=new i(function(i,n,o){try{return"function"==typeof o?t(o(e)):r}catch(e){return t(e)}});return r}(t))})}catch(t){r(t)}return new i(function(t,e,i){return n(function(r,n,o){l?l.push(function(a){a.then(t,e,i).then(r,n,o)}):f(function(){a.then(t,e,i).then(r,n,o)})})},function(){return a?a.inspect():{state:"pending"}})}function o(t){return t instanceof i?t:t===Object(t)&&"then"in t?n(function(e,i,r){f(function(){try{var n=t.then;"function"==typeof n?E(n,t,e,i,r):e(a(t))}catch(t){i(t)}})}):a(t)}function a(t){var e=new i(function(i){try{return"function"==typeof i?o(i(t)):e}catch(t){return s(t)}},function(){return p(t)});return e}function s(t){var e=new i(function(i,r){try{return"function"==typeof r?o(r(t)):e}catch(t){return s(t)}},function(){return d(t)});return e}function h(t,e){f(function(){for(var i,r=0;i=t[r++];)i(e)})}function l(e,i,r,o,a){return t(e,function(e){return n(function(r,n,o){function a(t){d(t)}function s(t){p(t)}var h,l,c,u,p,d,f,m;if(f=e.length>>>0,h=Math.max(0,Math.min(i,f)),c=[],l=f-h+1,u=[],h)for(d=function(t){u.push(t),--l||(p=d=g,n(u))},p=function(t){c.push(t),--h||(p=d=g,r(c))},m=0;f>m;++m)m in e&&t(e[m],s,a,o);else r(c)}).then(r,o,a)})}function c(t,e,i,r){return u(t,g).then(e,i,r)}function u(e,i,r){return t(e,function(e){return n(function(n,o,a){var s,h,l,c,u;if(l=h=e.length>>>0,s=[],l)for(c=function(e,h){t(e,i,r).then(function(t){s[h]=t,--l||n(s)},o,a)},u=0;h>u;u++)u in e?c(e[u],u):--l;else n(s)})})}function p(t){return{state:"fulfilled",value:t}}function d(t){return{state:"rejected",reason:t}}function f(t){1===_.push(t)&&x(m)}function m(){for(var t,e=0;t=_[e++];)t();_=[]}function g(t){return t}var v,y,E,x,_,w,b,S,T,M;return t.defer=function(){var t,e,i;return(t={promise:M,resolve:M,reject:M,notify:M,resolver:{resolve:M,reject:M,notify:M}}).promise=e=n(function(n,o,a){t.resolve=t.resolver.resolve=function(t){return i?r(t):(i=!0,n(t),e)},t.reject=t.resolver.reject=function(t){return i?r(s(t)):(i=!0,o(t),e)},t.notify=t.resolver.notify=function(t){return a(t),t}}),t},t.resolve=r,t.reject=function(e){return t(e,s)},t.join=function(){return u(arguments,g)},t.all=c,t.map=function(t,e){return u(t,e)},t.reduce=function(e,i){var r=E(y,arguments,1);return t(e,function(e){var n;return n=e.length,r[0]=function(e,r,o){return t(e,function(e){return t(r,function(t){return i(e,t,o,n)})})},v.apply(e,r)})},t.settle=function(t){return u(t,p,d)},t.any=function(t,e,i,r){return l(t,1,function(t){return e?e(t[0]):t[0]},i,r)},t.some=l,t.isPromise=function(t){return t&&"function"==typeof t.then},t.promise=n,i.prototype={otherwise:function(t){return this.then(M,t)},ensure:function(t){function e(){return r(t())}return this.then(e,e).yield2(this)},yield2:function(t){return this.then(function(){return t})},spread:function(t){return this.then(function(e){return c(e,function(e){return t.apply(M,e)})})},always:function(t,e){return this.then(t,t,e)}},_=[],w=e.setTimeout,x="function"==typeof setImmediate?setImmediate.bind(e):"object"==typeof process&&process.nextTick?process.nextTick:"object"==typeof vertx?vertx.runOnLoop:function(t){w(t,0)},S=(b=Function.prototype).call,E=b.bind?S.bind(S):function(t,e){return t.apply(e,y.call(arguments,2))},y=(T=[]).slice,v=T.reduce||function(t){var e,i,r,n,o;if(o=0,n=(e=Object(this)).length>>>0,(i=arguments).length<=1)for(;;){if(o in e){r=e[o++];break}if(++o>=n)throw new TypeError}else r=i[1];for(;n>o;++o)o in e&&(r=t(r,e[o],o,e));return r},t})}("function"==typeof define&&define.amd?define:function(t){window.when=t()},this);